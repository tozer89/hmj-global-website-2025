<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jobs | HMJ-Global</title>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.netlifyIdentity) {
        netlifyIdentity.on('login', () => {
          const dest = sessionStorage.getItem('afterLogin') || '/timesheets.html';
          sessionStorage.removeItem('afterLogin');
          window.location.href = dest;
        });
        netlifyIdentity.on('logout', () => {
          window.location.href = '/';
        });
      }
    });
  </script>
  <link rel="preload" href="images/hero.jpg" as="image" fetchpriority="high">
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root{
      --ink:#1A1A2E; --accent:#2f4ea2; --muted:#6b7280; --bg:#1a243b; --chip:#eef3ff;
      --chipBorder:rgba(47,78,162,.35); --cardBorder:rgba(26,26,46,.14);
      --ok:#1f7e39; --warn:#7a5b00; --stop:#8b1f28; --steel:#e8ecff;
    }
    /* ===== Header / Nav (unified across site) ===== */
    .hmj-header{position:sticky;top:0;z-index:1000;background:var(--bg);color:#fff;border-bottom:1px solid rgba(255,255,255,.06)}
    .hmj-nav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
    .hmj-logo img{height:40px;display:block}
    .hmj-menu{list-style:none;display:flex;gap:8px;margin-left:auto;padding:0}
    .hmj-menu a{display:inline-block;padding:10px 12px;border-radius:10px;font-weight:700;color:#eaf0ff;text-decoration:none;transition:background .2s,color .2s}
    .hmj-menu a:hover{background:rgba(255,255,255,.10);color:#fff}
    .hmj-menu a[aria-current="page"]{background:rgba(58,102,179,.20);color:#dfe8ff;border:1px solid rgba(58,102,179,.45)}
    .hmj-burger{display:none;margin-left:auto;border:0;background:transparent;width:42px;height:42px;border-radius:10px;cursor:pointer}
    .hmj-burger span{display:block;height:2px;background:#eaf0ff;margin:7px 8px;border-radius:2px;transition:transform .2s,opacity .2s}
    .hmj-scrim{position:fixed;inset:0;background:rgba(0,0,0,.35)}
    @media (max-width:900px){
      .hmj-burger{display:inline-block}
      .hmj-menu{
        position:fixed;right:12px;left:12px;top:64px;background:var(--bg);
        border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.35);
        display:grid;gap:6px;padding:0;max-height:0;overflow:hidden;transition:max-height .28s ease, padding .2s ease
      }
      .hmj-menu.open{max-height:70vh;padding:10px}
      .hmj-menu a{padding:14px 12px;width:100%}
      .hmj-scrim[hidden]{display:none}
    }
    .hmj-burger[aria-expanded="true"] span:nth-child(1){transform:translateY(9px) rotate(45deg)}
    .hmj-burger[aria-expanded="true"] span:nth-child(2){opacity:0}
    .hmj-burger[aria-expanded="true"] span:nth-child(3){transform:translateY(-9px) rotate(-45deg)}

    /* ===== Page header ===== */
    .page-header{min-height:40vh;display:grid;place-items:center;padding:120px 20px 80px;text-align:center;color:#fff;position:relative;background:url('images/hero.jpg') center/cover no-repeat;}
    .page-header::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(26,26,46,.78),rgba(26,26,46,.55))}
    .page-header::after{
      content:""; position:absolute; inset:0; pointer-events:none; opacity:.18;
      background:repeating-linear-gradient(90deg, rgba(255,255,255,.12) 0 1px, transparent 1px 8px),
                 repeating-linear-gradient(0deg, rgba(255,255,255,.07) 0 1px, transparent 1px 10px);
      transform:translateX(0); animation:scanMove 18s linear infinite;
    }
    @keyframes scanMove { to { transform:translateX(16px); } }
    .page-header>*{position:relative;z-index:1}
    .page-header h1{font-size:clamp(30px,4vw,46px);margin:0 0 .3rem;line-height:1.15}
    .page-header p{opacity:.9;margin:0}
    .power-underline{width:min(88vw,740px); height:14px; margin:12px auto 0; opacity:.9}
    .power-underline path{stroke:#5f86ff; stroke-width:2; fill:none; stroke-linecap:round; stroke-dasharray:6 8; animation:flow 2.8s linear infinite;}
    @keyframes flow { to { stroke-dashoffset:-280; } }

    /* ===== FILTER BAR ===== */
    .filters{position:sticky; top:0; z-index:8; background:#fff; border-bottom:1px solid rgba(26,26,46,.08); box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .filters-inner{max-width:1200px; margin:0 auto; padding:12px 20px}
    .filter-compact{display:none; gap:8px; align-items:center}
    #clearFilters{background:#7a1f28;border:1px solid #7a1f28;color:#fff}
    #clearFilters:hover{background:#641620}
    .filter-advanced{margin-top:8px}
    .filter-row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px}
    .filter-label{font-weight:700; color:var(--ink); margin-right:6px}
    .chip{display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:999px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--ink); font-weight:700; cursor:pointer; transition:transform .12s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease; user-select:none;}
    .chip:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(58,102,179,.18)}
    .chip.active{background:#dfe9ff; border-color:#6f95e0}
    .chip-group{display:flex; flex-wrap:wrap; gap:8px}
    .chip .dot{width:9px;height:9px;border-radius:999px;box-shadow:0 0 0 2px rgba(0,0,0,.04) inset}
    .dot.live{background:rgba(40,167,69,.9)} .dot.interviewing{background:rgba(255,193,7,.95)} .dot.closed{background:rgba(220,53,69,.9)}
    .select{padding:12px 14px;border-radius:12px;border:1px solid rgba(26,26,46,.18);background:#fff;font-weight:600}
    .search{flex:1;display:flex;align-items:center;gap:8px;min-width:220px}
    .search input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(26,26,46,.18); outline:none; font-weight:600}
    .btn{padding:12px 18px; border-radius:12px; border:1px solid rgba(58,102,179,.28); background:#f3f6ff; font-weight:800; color:var(--ink); cursor:pointer; transition:transform .12s ease, box-shadow .2s ease, background .2s ease;}
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(58,102,179,.18); background:#e8f0ff}
    .btn-primary{background:linear-gradient(180deg,rgba(58,102,179,.14),rgba(58,102,179,.06)),#fff; color:#3A66B3;}
    .badge{display:inline-block;min-width:20px;padding:2px 6px;margin-left:6px;border-radius:999px;background:#dfe9ff;border:1px solid #bcd0ff;font-size:.8rem}
    .meta-bar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;padding:0 20px 12px;max-width:1200px;margin:0 auto;color:var(--muted);font-weight:700}
    .meta-status{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .data-source-indicator{display:none;font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;padding:4px 8px;border-radius:999px;border:1px solid rgba(26,26,46,.18);background:rgba(26,26,46,.06);color:var(--muted)}
    .data-source-indicator[data-mode="live"]{background:rgba(31,126,57,.12);border-color:rgba(31,126,57,.32);color:#1f7e39}
    .data-source-indicator[data-mode="json"]{background:rgba(255,193,7,.18);border-color:rgba(255,193,7,.4);color:#7a5b00}
    .data-source-indicator[data-mode="empty"]{background:rgba(220,53,69,.18);border-color:rgba(220,53,69,.4);color:#8b1f28}
    @media (max-width:680px){
      .filters-inner{padding:10px 12px} .filter-compact{display:flex}
      .filter-advanced{max-height:0; overflow:hidden; opacity:0; transition:max-height .25s ease, opacity .2s ease;}
      .filters.open .filter-advanced{max-height:580px; opacity:1}
      .chip{padding:8px 10px} .select,.search input{padding:9px 10px;border-radius:10px}
      .meta-bar{padding:6px 12px 10px}
    }

    /* ===== Section Headings ===== */
    .section-title{max-width:1200px;margin:30px auto 10px;padding:0 20px;}
    .section-title h2{
      margin:0; font-size:14px; letter-spacing:.12em; text-transform:uppercase; font-weight:800;
      color:var(--section-pill-text);
      background:linear-gradient(180deg,var(--section-pill-top),var(--section-pill-bottom));
      display:inline-block; padding:10px 14px; border-radius:12px;
      border:1px solid var(--section-pill-border);
      box-shadow:0 10px 28px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06);
      transition:box-shadow .2s ease, transform .12s ease;
    }
    .section-title h2:hover{transform:translateY(-1px); box-shadow:0 0 0 2px rgba(95,134,255,.16), 0 12px 32px rgba(0,0,0,.26), inset 0 1px 0 rgba(255,255,255,.06);}

    /* ===== JOB CARDS ===== */
    .jobs-board{max-width:1200px;margin:12px auto 50px;padding:0 20px; display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:22px;}
    .job{background:linear-gradient(180deg,rgba(58,102,179,.06),transparent 55%),#fff; border:1px solid var(--cardBorder); border-radius:18px; padding:18px 18px 20px; box-shadow:0 8px 22px rgba(0,0,0,.08); transition:transform .15s ease,box-shadow .2s ease,border-color .2s ease, outline .12s ease; outline:0 solid transparent;}
    .job:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(0,0,0,.14);border-color:rgba(58,102,179,.35)}
    .job:focus-within{outline:3px solid rgba(58,102,179,.25)}
    .job h3{margin:.1rem 0 .3rem;color:var(--ink)}
    .status{display:inline-block;padding:7px 12px;font-size:.82rem;border-radius:999px;font-weight:800;margin-bottom:.6rem;border:1px solid rgba(0,0,0,.08)}
    .status.live{background:rgba(40,167,69,.14);color:var(--ok);border-color:rgba(40,167,69,.35)}
    .status.interviewing{background:rgba(255,193,7,.18);color:var(--warn);border-color:rgba(255,255,7,.42)}
    .status.closed{background:rgba(220,53,69,.14);color:var(--stop);border-color:rgba(220,53,69,.38)}
    .tag{display:inline-block;padding:6px 10px;font-size:.75rem;border-radius:999px;margin-left:6px;background:rgba(58,102,179,.12);color:#3A66B3;font-weight:800}
    .job .actions{margin-top:.6rem;display:flex;gap:8px;flex-wrap:wrap}
    .btn-tertiary{background:#f3f6ff;color:var(--ink);border:1px solid rgba(58,102,179,.25);padding:10px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:background .2s ease,transform .1s ease,box-shadow .2s ease}
    .btn-tertiary:hover{background:#e9f0ff;transform:translateY(-1px);box-shadow:0 6px 14px rgba(58,102,179,.15)}
    .btn-ghost{background:#fff;color:var(--accent);border:1px dashed rgba(58,102,179,.35)}
    .pin-btn{background:#fff;border:1px solid rgba(58,102,179,.25);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .pin-btn[aria-pressed="true"]{background:#fff6d9;border-color:#ffd36b}
    .share-btn{background:#fff;border:1px solid rgba(58,102,179,.25);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .job-details{margin-top:12px;overflow:hidden;max-height:0;opacity:0;transition:max-height .35s ease,opacity .25s ease,transform .25s ease;transform:translateY(-4px);background:#fff;border:1px solid rgba(26,26,46,.12);border-radius:14px;padding:0 16px;box-shadow:0 8px 18px rgba(0,0,0,.06) inset}
    .job-details.open{padding:16px;max-height:1200px;opacity:1;transform:translateY(0)}
    .job-details h4{margin:.2rem 0 .4rem}
    .job-details ul{margin:.25rem 0 .6rem 1.1rem}
    .job-details .apply-row{display:flex;justify-content:flex-end;margin-top:.6rem}
    .no-results{grid-column:1/-1;text-align:center;padding:30px;border:1px dashed rgba(26,26,46,.18);border-radius:16px;color:var(--muted);font-weight:700}
    .jobs-alert{max-width:1200px;margin:16px auto 0;padding:14px 18px;border-radius:14px;border:1px solid rgba(58,102,179,.32);background:rgba(58,102,179,.08);color:var(--ink);font-weight:700;display:block}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1322;color:#eaf0ff;border:1px solid rgba(95,134,255,.5);padding:10px 14px;border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:9999}
    .toast.show{opacity:1}

    /* ===== CTA bottom ===== */
    .jobs-cta{margin:26px auto 60px; max-width:1100px; padding:24px 20px;
      background:radial-gradient(600px 200px at 10% -30%, rgba(58,102,179,.18), transparent 60%), radial-gradient(600px 200px at 90% 130%, rgba(58,102,179,.18), transparent 60%), #0f1322;
      color:#eaf0ff; border:1px solid rgba(255,255,255,.12); border-radius:16px; box-shadow:0 18px 40px rgba(0,0,0,.35);}
    .jobs-cta h3{margin:0 0 8px}
    .jobs-cta p{margin:0 0 12px;color:#cfd7ff}
    .jobs-cta .cta-actions{display:flex;gap:10px;flex-wrap:wrap}
    .jobs-cta a{display:inline-block;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.22);text-decoration:none;color:#fff;font-weight:800}
    .jobs-cta a.btn-light{background:#1d2747}
    .jobs-cta a.btn-outline:hover{background:rgba(255,255,255,.08)}

    /* ===== Scroll to top ===== */
    .scroll-top{position:fixed; right:18px; bottom:18px; width:44px; height:44px; border-radius:12px; background:#0f1322; color:#eaf0ff; border:1px solid rgba(95,134,255,.5); display:grid; place-items:center; cursor:pointer; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease, box-shadow .2s ease, border-color .2s ease; z-index:999; box-shadow:0 0 0 rgba(95,134,255,0)}
    .scroll-top.show{opacity:1; pointer-events:auto}
    .scroll-top:hover{transform:translateY(-2px); border-color:#5f86ff; box-shadow:0 0 12px rgba(95,134,255,.6), 0 0 28px rgba(95,134,255,.35)}

    /* ===== Footer ===== */
    footer{text-align:center; padding:28px 16px; background:#0f1322; color:#cfd7ff; border-top:1px solid rgba(255,255,255,.06) }

    /* ===== Reveal on scroll ===== */
    .reveal{opacity:0; transform:translateY(12px); transition:opacity .5s ease, transform .5s ease}
    .reveal.revealed{opacity:1; transform:none}
  </style>
</head>
<body>
  <!-- ===== Header / Navbar ===== -->
  <header class="hmj-header">
    <nav class="hmj-nav" aria-label="Main">
      <a class="hmj-logo" href="index.html">
        <img src="images/logo.png" alt="HMJ-Global Logo" loading="eager" decoding="async" />
      </a>
      <button class="hmj-burger" aria-label="Open menu" aria-expanded="false" aria-controls="hmj-menu">
        <span></span><span></span><span></span>
      </button>
      <ul id="hmj-menu" class="hmj-menu">
        <li><a href="index.html" data-page="index">Home</a></li>
        <li><a href="about.html" data-page="about">About</a></li>
        <li><a href="clients.html" data-page="clients">Clients</a></li>
        <li><a href="candidates.html" data-page="candidates">Candidates</a></li>
        <li><a href="jobs.html" data-page="jobs">Jobs</a></li>
        <li><a href="https://www.hmj-finance.com" target="_blank" rel="noopener">Accounting</a></li>
        <li><a href="/timesheets.html" id="nav-timesheets" aria-disabled="true">Timesheets</a></li>
        <li><a href="/admin/" id="nav-admin" class="requires-admin" style="display:none" aria-disabled="true">Admin Dashboard</a></li>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const admin = document.getElementById('nav-admin');
      const timesheets = document.getElementById('nav-timesheets');
      const identity = window.netlifyIdentity;

      const rolesOf = (user) => Array.isArray(user?.app_metadata?.roles)
        ? user.app_metadata.roles
        : Array.isArray(user?.roles)
          ? user.roles
          : [];

      function requireLogin(event, destination) {
        if (event) event.preventDefault();
        if (!identity) {
          if (destination) window.location.href = destination;
          return;
        }
        if (destination) sessionStorage.setItem('afterLogin', destination);
        identity.open('login');
      }

      function setTimesheets(user) {
        if (!timesheets) return;
        if (user) {
          timesheets.href = '/timesheets.html';
          timesheets.removeAttribute('aria-disabled');
          timesheets.title = 'Open timesheets';
        } else {
          timesheets.href = '#';
          timesheets.setAttribute('aria-disabled', 'true');
          timesheets.title = 'Sign in to access timesheets';
        }
      }

      function setAdmin(user) {
        if (!admin) return;
        const roles = rolesOf(user);
        const isAdmin = roles.includes('admin');
        if (isAdmin) {
          admin.style.display = 'inline-block';
          admin.href = '/admin/';
          admin.removeAttribute('aria-disabled');
          admin.classList.remove('requires-admin');
          admin.textContent = 'Admin Dashboard';
          admin.title = 'Open the admin dashboard';
        } else {
          admin.style.display = 'none';
          admin.href = '/admin/';
          admin.setAttribute('aria-disabled', 'true');
          admin.classList.add('requires-admin');
          admin.textContent = 'Admin Dashboard';
          admin.title = 'Admin access only';
        }
      }

      function renderFor(user) {
        setTimesheets(user);
        setAdmin(user);
      }

      timesheets?.addEventListener('click', (event) => {
        const user = identity?.currentUser?.();
        if (user) return;
        requireLogin(event, '/timesheets.html');
      });
      admin?.addEventListener('click', (event) => {
        const user = identity?.currentUser?.();
        if (user) return;
        requireLogin(event, '/admin/');
      });

      identity?.on('init', (user) => renderFor(user));
      identity?.on('login', (user) => renderFor(user));
      identity?.on('logout', () => renderFor(null));

      try {
        renderFor(identity?.currentUser?.() || null);
      } catch {
        renderFor(null);
      }
    });
</script>

      </ul>
      <div class="hmj-scrim" hidden></div>
    </nav>
  </header>

  <!-- ===== Page header ===== -->
  <section class="page-header">
    <h1>Current Vacancies</h1>
    <svg class="power-underline" viewBox="0 0 800 14" role="img" aria-label="animated power line">
      <path d="M2 7 C 100 7, 140 7, 180 7
               C 220 7, 240 2, 260 7
               C 280 12, 300 7, 340 7
               C 380 7, 420 7, 460 7
               C 500 7, 520 2, 540 7
               C 560 12, 580 7, 620 7
               C 660 7, 720 7, 798 7" />
    </svg>
    <p>Explore our latest roles across data centre & infrastructure projects in the UK & Europe.</p>
  </section>

  <!-- ===== Smart Filter Bar ===== -->
  <div class="filters" role="region" aria-label="Job filters" id="filters">
    <div class="filters-inner">
      <div class="filter-compact">
        <div class="search"><input id="searchBoxMobile" type="search" placeholder="Search job title, keywords…" aria-label="Search jobs (mobile)" /></div>
        <button id="toggleFilters" class="btn" type="button">Filters <span id="activeCount" class="badge">0</span></button>
        <button id="clearFilters" class="btn" type="button" title="Clear filters">Clear</button>
      </div>

      <div class="filter-advanced">
        <div class="filter-row" aria-label="Status filters">
          <span class="filter-label">Status:</span>
          <button class="chip active" data-chip="status" data-value="all" aria-pressed="true"><span class="dot" style="background:#8088a0" aria-hidden="true"></span> All</button>
          <button class="chip" data-chip="status" data-value="live"><span class="dot live" aria-hidden="true"></span> Live</button>
          <button class="chip" data-chip="status" data-value="interviewing"><span class="dot interviewing" aria-hidden="true"></span> Interviewing</button>
          <button class="chip" data-chip="status" data-value="closed"><span class="dot closed" aria-hidden="true"></span> Closed</button>
          <div class="search" style="margin-left:auto; min-width:260px">
            <input id="searchBox" type="search" placeholder="Search job title, keywords…" aria-label="Search jobs" />
          </div>
        </div>

        <div class="filter-row" aria-label="Location & Type">
          <span class="filter-label">Location:</span>
          <select class="select" id="locationFilter" aria-label="Location filter">
            <option value="all">All Locations</option>
            <option value="dublin">Dublin, Ireland</option>
            <option value="london">London, UK</option>
            <option value="amsterdam">Amsterdam, Netherlands</option>
            <option value="frankfurt">Frankfurt, Germany</option>
            <option value="macclesfield">Macclesfield, UK</option>
            <option value="eemshaven">Eemshaven, Netherlands</option>
            <option value="groningen">Groningen, Netherlands</option>
            <option value="helsinki">Helsinki, Finland</option>
            <option value="espoo">Espoo, Finland</option>
            <option value="uk">UK (Various)</option>
            <option value="europe">Europe (Travel)</option>
          </select>

          <span class="filter-label" style="margin-left:12px">Employment:</span>
          <button class="chip active" data-chip="type" data-value="all">All</button>
          <button class="chip" data-chip="type" data-value="permanent">Permanent</button>
          <button class="chip" data-chip="type" data-value="contract">Contract</button>

          <span class="filter-label" style="margin-left:12px">Discipline:</span>
          <div id="discChipWrap" class="chip-group" role="group" aria-label="Discipline filters"></div>
        </div>
      </div>
    </div>

    <div class="meta-bar">
      <div class="meta-status">
        <div id="resultCount">Showing all jobs</div>
        <span id="dataSourceIndicator" class="data-source-indicator" role="status" aria-live="polite"></span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="shortlistBtn" type="button" title="Show saved roles">Shortlist (0)</button>
        <span>Tip: use search for keywords (e.g. “Planner”, “BMS”, “Ireland”).</span>
      </div>
    </div>
  </div>

  <!-- ===== Dynamic jobs board ===== -->
  <div id="jobsDynamic"></div>
  <div id="jobsFallbackNotice" class="jobs-alert" hidden></div>

  <!-- Embedded fallback dataset (used when API and static JSON are unavailable) -->
  <script type="application/json" id="jobsFallbackData">
    {
      "jobs": [
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Quantity%20Surveyor%20%E2%80%94%20Data%20Centre%20%E2%80%94%20London%2C%20UK",
          "locationText": "London, UK Data Centre",
          "locationCode": "london",
          "section": "commercial",
          "keywords": "quantity surveyor,data centre,commercial,NEC,JCT,cost control,procurement,valuations",
          "responsibilities": [
            "Own commercial and contractual management of packages",
            "Cost planning, budget control and forecasting",
            "Procurement, subcontract management and payments",
            "Prepare valuations, variations and commercial reports",
            "Lead change control and risk/opportunity management",
            "Ensure NEC/JCT compliance and audit-ready records",
            "Liaise with PM, engineering and client teams"
          ],
          "published": true,
          "requirements": [
            "Quantity Surveying degree or equivalent",
            "Data centre or complex build experience",
            "Strong NEC/JCT exposure",
            "Advanced Excel/reporting; forecasting accuracy",
            "Stakeholder management and negotiation skills"
          ],
          "discipline": "Data Centre",
          "status": "live",
          "title": "Quantity Surveyor — Data Centre",
          "overview": "QS role owning commercial delivery on a London data centre with full cost, contracts and change control responsibility.",
          "type": "permanent",
          "id": "qs-london-dc"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=MEP%20Senior%20Quantity%20Surveyor%20%E2%80%94%20Data%20Centre%20%E2%80%94%20Eemshaven%2C%20Netherlands",
          "locationText": "Eemshaven, Netherlands Data Centre",
          "locationCode": "eemshaven",
          "section": "commercial",
          "keywords": "MEP SQS,data centre,commercial,procurement,reporting,forecasting,contracts,risk",
          "responsibilities": [
            "Lead MEP commercial strategy and execution",
            "Manage procurement, payments and negotiations",
            "Maintain cost reports, cash flow and forecasts",
            "Administer contract changes, claims and EOT inputs",
            "Identify and manage risks/opportunities",
            "Build strong client and supply-chain relationships"
          ],
          "published": true,
          "requirements": [
            "Degree in QS/Construction Economics",
            "Senior MEP commercial experience on large projects",
            "Excellent cost reporting and contract knowledge",
            "Negotiation, communication and leadership skills"
          ],
          "discipline": "Data Centre",
          "status": "live",
          "title": "MEP Senior Quantity Surveyor — Data Centre",
          "overview": "Senior MEP QS for a flagship Netherlands data centre, driving value, risk and reporting across all MEP packages.",
          "type": "permanent",
          "id": "mep-sqs-eem"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=CSA%20Senior%20Quantity%20Surveyor%20%E2%80%94%20Data%20Centre%20%E2%80%94%20Eemshaven%2C%20Netherlands",
          "locationText": "Eemshaven, Netherlands Data Centre",
          "locationCode": "eemshaven",
          "section": "commercial",
          "keywords": "CSA SQS,civil,structural,architectural,data centre,commercial,valuations,procurement",
          "responsibilities": [
            "Own CSA commercial function on major project",
            "Procure, value and administer CSA subcontracts",
            "Deliver accurate forecasts and financial reports",
            "Drive value engineering and cost savings",
            "Support delivery teams with contractual compliance"
          ],
          "published": true,
          "requirements": [
            "QS degree or equivalent",
            "Significant CSA experience (data centre/infrastructure)",
            "Contracts and cost management expertise",
            "Strong analytical and stakeholder skills"
          ],
          "discipline": "Data Centre",
          "status": "interviewing",
          "title": "CSA Senior Quantity Surveyor — Data Centre",
          "overview": "Lead CSA commercial activities on a landmark data centre, ensuring robust cost, contract and supplier management.",
          "type": "permanent",
          "id": "csa-sqs-eem"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Senior%20Quantity%20Surveyor%20%E2%80%94%20Data%20Centre%20%E2%80%94%20Dublin%2C%20Ireland",
          "locationText": "Dublin, Ireland Data Centre",
          "locationCode": "dublin",
          "section": "commercial",
          "keywords": "senior qs,data centre,NEC,JCT,change control,procurement,claims,forecasting",
          "responsibilities": [
            "Lead commercial delivery across multiple work packages",
            "Own change control, variations and claims strategy",
            "Cash flow, CVRs, monthly reporting and forecasting",
            "Supply chain procurement and performance management",
            "Commercial risk management and governance"
          ],
          "published": true,
          "requirements": [
            "Senior QS experience on technical builds",
            "NEC/JCT expertise and strong negotiation skills",
            "Proven forecasting and reporting accuracy",
            "Client-facing communication and leadership"
          ],
          "discipline": "Data Centre",
          "status": "interviewing",
          "title": "Senior Quantity Surveyor — Data Centre",
          "overview": "Senior QS to steer commercial outcomes on a major Dublin data centre from procurement through final account.",
          "type": "permanent",
          "id": "sqs-dublin"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Project%20Planner%20%E2%80%94%20Data%20Centre%20%E2%80%94%20Dublin%2C%20Ireland",
          "locationText": "Dublin, Ireland Data Centre",
          "locationCode": "dublin",
          "section": "dc",
          "keywords": "project planner,data centre,Primavera P6,Asta,programme,4D,reporting,controls",
          "responsibilities": [
            "Develop and maintain integrated master schedules",
            "Produce lookahead plans, progress curves and reports",
            "Interface with commercial, engineering and delivery teams",
            "Support risk workshops and scenario analysis",
            "Champion planning governance and change control"
          ],
          "published": true,
          "requirements": [
            "Planning experience on data centre or mission critical builds",
            "Primavera P6 proficiency (Asta welcomed)",
            "Construction methodology and sequencing knowledge",
            "Strong reporting and stakeholder communication"
          ],
          "discipline": "Planning",
          "status": "live",
          "title": "Project Planner — Data Centre",
          "overview": "Planner role covering schedule ownership for a hyperscale Dublin data centre with international stakeholder exposure.",
          "type": "contract",
          "id": "planner-dublin"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Electrical%20Project%20Manager%20%E2%80%94%20Substations%20%E2%80%94%20Frankfurt%2C%20Germany",
          "locationText": "Frankfurt, Germany Substation",
          "locationCode": "frankfurt",
          "section": "substations",
          "keywords": "electrical project manager,substation,HV,grid connection,project delivery,HVAC",
          "responsibilities": [
            "Deliver HV substation packages end-to-end",
            "Manage contractors, budgets and schedule",
            "Coordinate client, grid operator and stakeholders",
            "Ensure safety, quality and technical compliance",
            "Report progress, risks and commercial positions"
          ],
          "published": true,
          "requirements": [
            "Electrical engineering degree or similar",
            "5+ years leading HV substation projects",
            "German grid / TSO interface experience",
            "Fluent English (German advantageous)",
            "EU work rights"
          ],
          "discipline": "Energy",
          "status": "live",
          "title": "Electrical Project Manager — Substations",
          "overview": "Deliver HV substation upgrades supporting data centre growth across Frankfurt for a leading European contractor.",
          "type": "permanent",
          "id": "epm-frankfurt"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Mechanical%20Commissioning%20Manager%20%E2%80%94%20Life%20Sciences%20%E2%80%94%20Helsinki%2C%20Finland",
          "locationText": "Helsinki, Finland Life Sciences",
          "locationCode": "helsinki",
          "section": "pharma",
          "keywords": "mechanical commissioning,life sciences,HVAC,clean room,validation,BMS",
          "responsibilities": [
            "Lead mechanical commissioning on pharma facility",
            "Coordinate HVAC, piping and clean room systems",
            "Manage documentation, FAT/SAT and validation",
            "Interface with QA/QC and client teams",
            "Ensure compliance with GMP and safety"
          ],
          "published": true,
          "requirements": [
            "Mechanical engineering background",
            "Commissioning experience in GMP environments",
            "Knowledge of clean room standards",
            "Excellent coordination and reporting skills"
          ],
          "discipline": "Life Sciences",
          "status": "interviewing",
          "title": "Mechanical Commissioning Manager — Life Sciences",
          "overview": "Commission mechanical systems on a Finnish life sciences facility, steering validation and client handover.",
          "type": "contract",
          "id": "mcm-helsinki"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Document%20Controller%20%E2%80%94%20Data%20Centre%20%E2%80%94%20Amsterdam%2C%20Netherlands",
          "locationText": "Amsterdam, Netherlands Data Centre",
          "locationCode": "amsterdam",
          "section": "dc",
          "keywords": "document control,data centre,EDMS,QA,ISO9001,as-built",
          "responsibilities": [
            "Maintain EDMS and document workflows",
            "Coordinate drawing and submittal reviews",
            "Support quality audits and close-out",
            "Ensure accurate as-built handover packages"
          ],
          "published": true,
          "requirements": [
            "Experience in construction document control",
            "EDMS (Aconex/Asite/Procore) proficiency",
            "Attention to detail and communication skills",
            "Data centre or critical infrastructure exposure"
          ],
          "discipline": "Project Controls",
          "status": "live",
          "title": "Document Controller — Data Centre",
          "overview": "Document control lead for a hyperscale Amsterdam build, ensuring traceable workflows and clean close-out.",
          "type": "contract",
          "id": "docctrl-amsterdam"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=CSA%20Project%20Manager%20%E2%80%94%20Data%20Centre%20%E2%80%94%20London%2C%20UK",
          "locationText": "London, UK Data Centre",
          "locationCode": "london",
          "section": "dc",
          "keywords": "CSA project manager,data centre,fit out,delivery,leadership",
          "responsibilities": [
            "Lead CSA delivery on high-spec data centre fitout",
            "Manage subcontractors, logistics and programme",
            "Chair progress meetings and interface with client",
            "Ensure safety, quality and commercial alignment"
          ],
          "published": true,
          "requirements": [
            "CSA project management background",
            "Data centre or complex fit-out experience",
            "Strong leadership and coordination skills",
            "Excellent reporting and stakeholder engagement"
          ],
          "discipline": "Project Delivery",
          "status": "live",
          "title": "CSA Project Manager — Data Centre",
          "overview": "CSA PM overseeing major London data centre build, owning safety, programme and quality for mission critical areas.",
          "type": "permanent",
          "id": "csa-pm-london"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Cost%20Engineer%20%E2%80%94%20Power%20Infrastructure%20%E2%80%94%20Macclesfield%2C%20UK",
          "locationText": "Macclesfield, UK Power Infrastructure",
          "locationCode": "macclesfield",
          "section": "substations",
          "keywords": "cost engineer,power infrastructure,estimating,cost control,reporting",
          "responsibilities": [
            "Develop cost plans and estimates for energy projects",
            "Track budgets, forecasts and earned value",
            "Support procurement and contract admin",
            "Provide monthly reports and risk analysis"
          ],
          "published": true,
          "requirements": [
            "Cost engineering or QS background",
            "Power or utilities project experience",
            "Strong Excel and cost management tools",
            "Analytical mindset and communication skills"
          ],
          "discipline": "Commercial",
          "status": "live",
          "title": "Cost Engineer — Power Infrastructure",
          "overview": "Cost engineer to support UK-wide power upgrades from estimating through delivery, ensuring financial governance.",
          "type": "permanent",
          "id": "cost-eng-macc"
        },
        {
          "applyUrl": "https://hmj-global.com/contact.html?role=Controls%20Engineer%20%E2%80%94%20Data%20Centre%20%E2%80%94%20Groningen%2C%20Netherlands",
          "locationText": "Groningen, Netherlands Data Centre",
          "locationCode": "groningen",
          "section": "dc",
          "keywords": "controls engineer,BMS,SCADA,data centre,commissioning",
          "responsibilities": [
            "Commission BMS/controls systems for hyperscale build",
            "Interface with mechanical/electrical teams",
            "Optimise sequences and fault diagnostics",
            "Produce handover documentation and training"
          ],
          "published": true,
          "requirements": [
            "Controls engineering experience",
            "BMS/SCADA systems knowledge",
            "Data centre or industrial commissioning",
            "Problem solving and client communication"
          ],
          "discipline": "Engineering",
          "status": "live",
          "title": "Controls Engineer — Data Centre",
          "overview": "Controls engineer supporting integrated commissioning on Dutch hyperscale programme with international team.",
          "type": "contract",
          "id": "controls-groningen"
        }
      ]
    }
  </script>

  <!-- ===== No results ===== -->
  <section class="jobs-board">
    <div id="noResults" class="no-results" style="display:none">No roles match your filters. Try clearing filters or adjusting your search.</div>
  </section>

  <!-- ===== CTA block ===== -->
  <section class="jobs-cta reveal">
    <div class="wrap">
      <h3>Didn’t see a role that fits?</h3>
      <p>We hire for new data centre, pharma and power projects weekly. Register your profile and we’ll notify you first.</p>
      <div class="cta-actions">
        <a class="btn-light" href="candidates.html#candForm">Send CV / Register</a>
        <a class="btn-outline" href="contact.html">Contact Us</a>
      </div>
    </div>
  </section>

  <!-- ===== Scroll to Top ===== -->
  <button class="scroll-top" id="scrollTopBtn" aria-label="Scroll to top" title="Back to top">↑</button>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Link copied!</div>

  <!-- ===== Footer ===== -->
  <footer>
    <p>&copy; 2025 HMJ-Global Ltd. All rights reserved.</p>
    <br><br><br>
    <p>HMJ-Global is a trading name of HMJ-Global Ltd, registered in England & Wales, company number 16029938.</p>
    <p>Registered office: 905 Lightbox Blue, Media City, UK.</p>
  </footer>

  <!-- ===== Scripts ===== -->
  <script>
  (async function(){
    /* ------ Load jobs from Netlify function (falls back to JSON) ------ */
    const SHORTLIST_KEY = 'hmj_pinned_jobs_v1';

    const jobsState = {
      all: [],
      sections: [],
      locations: [],
      disciplines: [],
      tags: [],
      source: 'api',
      schema: false,
    };
    const jobsContainer = document.getElementById('jobsDynamic');
    const dataSourceIndicator = document.getElementById('dataSourceIndicator');
    let jobsEls = [];
    let chips = [];
    let seededJobsApplied = false;

    function refreshJobsElements(){
      jobsEls = Array.from(jobsContainer?.querySelectorAll('.job') || []);
    }

    function refreshChips(){
      chips = Array.from(document.querySelectorAll('.chip'));
    }

    function bindChipEvents(){
      chips.forEach((chip) => {
        if (chip.dataset.bound === '1') return;
        chip.dataset.bound = '1';
        chip.addEventListener('click', () => {
          const group = chip.dataset.chip;
          if (!group) return;
          chips
            .filter((c) => c.dataset.chip === group)
            .forEach((c) => {
              c.classList.remove('active');
              c.setAttribute('aria-pressed', 'false');
            });
          chip.classList.add('active');
          chip.setAttribute('aria-pressed', 'true');
          state[group] = chip.dataset.value;
          applyFilters();
        });
      });
    }

    function bindJobCardEvents(){
      refreshJobsElements();
      jobsEls.forEach((job) => {
        const pinBtn = job.querySelector('.pin-btn');
        if (pinBtn && pinBtn.dataset.bound !== '1') {
          pinBtn.dataset.bound = '1';
          pinBtn.addEventListener('click', () => {
            const pins = getPins();
            const id = job.id || job.dataset.id || job.querySelector('h3')?.textContent?.trim();
            if (!id) return;
            if (pins.has(id)) pins.delete(id); else pins.add(id);
            setPins(pins);
            refreshPinsUI();
            applyFilters();
          });
        }

        const shareBtn = job.querySelector('[data-share]');
        if (shareBtn && shareBtn.dataset.bound !== '1') {
          shareBtn.dataset.bound = '1';
          shareBtn.addEventListener('click', () => handleShare(job));
        }

        job.querySelectorAll('a[href^="contact.html"]').forEach((link) => {
          if (link.dataset.bound === '1') return;
          link.dataset.bound = '1';
          link.addEventListener('click', () => {
            toast.textContent = 'Application started!';
            toast.classList.add('show');
            clearTimeout(toast._t);
            toast._t = setTimeout(() => toast.classList.remove('show'), 1800);
          });
        });
      });
      refreshPinsUI();
      applyFilters();
    }

    function slugify(value = '') {
      return String(value || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 80);
    }

    function toTitle(text = '') {
      return String(text || '')
        .replace(/[_-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        .replace(/\b([a-z])/g, (m) => m.toUpperCase());
    }

    function normaliseJob(job = {}) {
      const out = { ...job };
      out.status = (out.status || 'live').toLowerCase();
      out.type = (out.type || 'permanent').toLowerCase();
      out.locationCode = (out.location_code || out.locationCode || '').toLowerCase() || 'various';
      out.locationText = out.locationText || out.location_text || 'UK / Europe';
      out.discipline = out.discipline || out.sectionLabel || out.section || 'General';
      out.disciplineValue = out.discipline.trim().toLowerCase();
      out.sectionLabel = out.sectionLabel || out.section || 'General';
      out.sectionKey = slugify(out.sectionKey || out.section || out.sectionLabel) || 'general';
      if (!Array.isArray(out.tags)) {
        const raw = Array.isArray(out.keywords) ? out.keywords : String(out.keywords || '').split(',');
        out.tags = raw.map((t) => t.trim()).filter(Boolean);
      }
      out.tags = Array.isArray(out.tags) ? out.tags.map((t) => t.trim()).filter(Boolean) : [];
      out.applyUrl = (out.applyUrl || out.apply_url || '').toString().trim();
      out.keywords = out.keywords || out.tags.join(', ');
      return out;
    }

    function resolveApplyUrl(job = {}) {
      const fallbackRole = encodeURIComponent(job.title || 'HMJ Application');
      const fallback = `contact.html?role=${fallbackRole}`;
      const raw = (job.applyUrl || '').trim();
      if (!raw) return fallback;

      try {
        const url = new URL(raw, window.location.origin);
        const sameOrigin = url.origin === window.location.origin;
        const hmjDomain = /(?:^|\.)hmj-global\.com$/i.test(url.hostname);
        const path = url.pathname.replace(/^\/+/, '');

        if ((sameOrigin || hmjDomain) && path === 'contact.html') {
          if (job.title && !url.searchParams.has('role')) {
            url.searchParams.set('role', job.title);
          }
          const search = url.searchParams.toString();
          const hash = url.hash || '';
          return `${path}${search ? `?${search}` : ''}${hash}`;
        }

        return url.href;
      } catch (err) {
        console.warn('Invalid apply URL, falling back', err);
        return fallback;
      }
    }

    async function loadJobsFromApi(){
      try{
        const res = await fetch('/.netlify/functions/jobs-list', { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        return data;
      }catch(e){
        console.warn('jobs-list API failed', e);
        return null;
      }
    }
    async function loadJobsJSON(){
      try{
        const res = await fetch('/data/jobs.json', {cache:'no-store'});
        if(!res.ok) return null;
        const data = await res.json();
        return Array.isArray(data.jobs) ? data.jobs : null;
      }catch(e){
        console.warn('jobs JSON fallback failed', e);
        return null;
      }
    }
    function loadEmbeddedJobs(){
      try{
        const el = document.getElementById('jobsFallbackData');
        if(!el) return null;
        const raw = el.textContent || '';
        if(!raw.trim()) return null;
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed?.jobs)) return parsed.jobs;
        if(Array.isArray(parsed)) return parsed;
      }catch(e){
        console.warn('jobs embedded fallback parse failed', e);
      }
      return null;
    }
    async function resolveJobs(){
      const embedded = loadEmbeddedJobs();

      const apiData = await loadJobsFromApi();
      const apiRows = Array.isArray(apiData?.jobs)
        ? apiData.jobs
        : Array.isArray(apiData?.rows)
          ? apiData.rows
          : null;
      const apiSource = apiData?.source || (Array.isArray(apiRows) ? 'api' : 'api-empty');
      const apiSchema = !!apiData?.schema;
      const apiWarning = apiData?.warning;

      if(Array.isArray(apiRows) && apiRows.length){
        return { rows: apiRows, source: apiSource, schema: apiSchema, warning: apiWarning };
      }

      const fromJson = await loadJobsJSON();
      if(Array.isArray(fromJson) && fromJson.length){
        return {
          rows: fromJson,
          source: Array.isArray(apiRows) ? 'static-from-json' : 'static-json',
          schema: apiSchema,
          warning: apiWarning,
        };
      }

      if(Array.isArray(embedded) && embedded.length){
        const source = Array.isArray(apiRows) ? 'embedded-after-api' : 'embedded';
        return { rows: embedded, source, schema: apiSchema, warning: apiWarning };
      }

      return {
        rows: Array.isArray(apiRows) ? apiRows : [],
        source: apiSource || 'empty',
        schema: apiSchema,
        warning: apiWarning,
      };
    }

    function updateDataSourceIndicator(){
      if (!dataSourceIndicator) return;
      const source = (jobsState.source || '').toString();
      let label = '';
      let mode = '';
      if (source === 'supabase' || source === 'api') {
        label = '(admin/jobs data)';
        mode = 'live';
      } else if (!source || source === 'empty' || source === 'api-empty') {
        label = '(no data)';
        mode = 'empty';
      } else if (/static|json|embedded/i.test(source)) {
        label = '(JSON)';
        mode = 'json';
      } else {
        label = `(${source})`;
        mode = 'json';
      }
      dataSourceIndicator.textContent = label;
      dataSourceIndicator.dataset.mode = mode;
      dataSourceIndicator.style.display = label ? '' : 'none';
    }

    function deriveSections(jobs){
      const map = new Map();
      jobs.forEach((job) => {
        const key = job.sectionKey || slugify(job.sectionLabel || job.section || 'general') || 'general';
        const label = job.sectionLabel || job.section || toTitle(key) || 'General';
        if (!map.has(key)) map.set(key, label);
      });
      return Array.from(map, ([key, label]) => ({ key, label })).sort((a, b) => a.label.localeCompare(b.label));
    }

    function buildDerivedCollections(jobs){
      const locations = new Map();
      const disciplines = new Map();
      const tags = new Map();

      jobs.forEach((job) => {
        const locValue = job.locationCode || 'various';
        const locLabel = job.locationText || toTitle(locValue);
        if (!locations.has(locValue)) locations.set(locValue, locLabel);
        const discValue = job.disciplineValue || slugify(job.discipline);
        const discLabel = job.discipline || toTitle(discValue);
        if (!disciplines.has(discValue)) disciplines.set(discValue, discLabel);
        job.tags.forEach((tag) => {
          const value = tag.toLowerCase();
          if (!tags.has(value)) tags.set(value, tag);
        });
      });

      jobsState.sections = deriveSections(jobs);
      jobsState.locations = Array.from(locations, ([value, label]) => ({ value, label })).sort((a, b) => a.label.localeCompare(b.label));
      jobsState.disciplines = Array.from(disciplines, ([value, label]) => ({ value, label })).sort((a, b) => a.label.localeCompare(b.label));
      jobsState.tags = Array.from(tags, ([value, label]) => ({ value, label })).sort((a, b) => a.label.localeCompare(b.label));
    }

    function renderJobCard(job){
      const statusClass = job.status === 'closed' ? 'closed' : job.status === 'interviewing' ? 'interviewing' : 'live';
      const applyUrl = resolveApplyUrl(job);
      const tagsList = Array.isArray(job.tags) ? job.tags : [];
      const tags = tagsList.length ? tagsList.map((tag) => `<span class="tag">${tag}</span>`).join('') : '';
      const respList = (job.responsibilities || []).map((item) => `<li>${item}</li>`).join('');
      const reqList = (job.requirements || []).map((item) => `<li>${item}</li>`).join('');
      return `
      <div id="${job.id}" class="job reveal"
           data-id="${job.id}"
           data-status="${job.status}"
           data-location="${job.locationCode}"
           data-type="${job.type}"
           data-disc="${job.disciplineValue}"
           data-section="${job.sectionKey}"
           data-tags="${tagsList.map((t) => t.toLowerCase()).join(',')}"
           data-keywords="${(job.keywords || '').toLowerCase()}">
        <h3>${job.title}</h3>
        <span class="status ${statusClass}">${job.status === 'closed' ? 'Closed' : job.status === 'interviewing' ? 'Interviewing' : 'Taking Candidates'}</span>
        <p><strong>Location:</strong> ${job.locationText} ${tags}</p>
        <p><strong>Employment:</strong> ${toTitle(job.type)}</p>
        <div class="actions">
          <button class="btn-tertiary" onclick="toggleDetails(this)">Details</button>
          <button class="pin-btn" type="button" aria-pressed="false">☆ Save</button>
          <button class="share-btn" type="button" data-share>Share</button>
          <a class="btn-tertiary btn-ghost" href="${applyUrl}">${job.status === 'closed' ? 'Register' : 'Apply'}</a>
        </div>
        <div class="job-details">
          ${job.overview ? `<h4>Overview</h4><p>${job.overview}</p>` : ''}
          ${respList ? `<h4>Key Responsibilities</h4><ul>${respList}</ul>` : ''}
          ${reqList ? `<h4>Requirements</h4><ul>${reqList}</ul>` : ''}
          <div class="apply-row"><a class="btn btn-primary" href="${applyUrl}">${job.status === 'closed' ? 'Register Interest' : 'Apply'}</a></div>
        </div>
      </div>`;
    }

    function paintJobs(jobs){
      if (!jobsContainer) return;
      jobsContainer.innerHTML = '';
      const sections = (Array.isArray(jobsState.sections) && jobsState.sections.length)
        ? jobsState.sections
        : deriveSections(jobs);

      if (!sections.length || !jobs.length) {
        jobsContainer.innerHTML = '<div class="no-results">No jobs are available right now. Please check back soon.</div>';
        refreshJobsElements();
        return;
      }

      sections.forEach((section) => {
        const items = jobs.filter((job) => job.sectionKey === section.key);
        if (!items.length) return;
        const title = document.createElement('div');
        title.className = 'section-title reveal';
        title.innerHTML = `<h2>${section.label.toUpperCase()}</h2>`;
        const board = document.createElement('section');
        board.className = 'jobs-board';
        items.sort((a, b) => ((a.sortOrder ?? 0) - (b.sortOrder ?? 0)) || a.title.localeCompare(b.title));
        board.innerHTML = items.map(renderJobCard).join('');
        jobsContainer.appendChild(title);
        jobsContainer.appendChild(board);
      });

      refreshJobsElements();
    }

    function populateLocationOptions(){
      const select = document.getElementById('locationFilter');
      if (!select) return;
      const current = select.value;
      select.innerHTML = '<option value="all">All Locations</option>' + jobsState.locations.map(({ value, label }) => `<option value="${value}">${label}</option>`).join('');
      if (jobsState.locations.some(({ value }) => value === current)) {
        select.value = current;
      } else {
        select.value = 'all';
      }
    }

    function populateChipGroup(containerId, group, items){
      const wrap = document.getElementById(containerId);
      if (!wrap) return;
      wrap.innerHTML = '';
      const button = document.createElement('button');
      button.className = 'chip active';
      button.dataset.chip = group;
      button.dataset.value = 'all';
      button.type = 'button';
      button.setAttribute('aria-pressed', 'true');
      button.textContent = 'All';
      wrap.appendChild(button);
      items.forEach(({ value, label }) => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.dataset.chip = group;
        btn.dataset.value = value;
        btn.type = 'button';
        btn.textContent = label;
        wrap.appendChild(btn);
      });
    }

    function updateFilterSources(){
      populateLocationOptions();
      populateChipGroup('discChipWrap', 'disc', jobsState.disciplines);
    }

    function showSeededJobs(rows, source = 'embedded') {
      if (!Array.isArray(rows) || !rows.length) return;
      jobsState.source = source;
      jobsState.schema = false;
      updateDataSourceIndicator();
      jobsState.all = rows.map(normaliseJob);
      buildDerivedCollections(jobsState.all);
      paintJobs(jobsState.all);
      updateFilterSources();
      refreshChips();
      bindChipEvents();
      bindJobCardEvents();
      seededJobsApplied = true;
      const notice = document.getElementById('jobsFallbackNotice');
      if (notice) {
        notice.hidden = false;
        notice.textContent = `Showing ${jobsState.all.length} preview roles while the live jobs service loads (${source}).`;
      }
    }

    async function renderJobs(){
      const notice = document.getElementById('jobsFallbackNotice');
      if (notice) notice.hidden = true;
      const hadJobs = Array.isArray(jobsState.all) && jobsState.all.length > 0;
      const previousSource = jobsState.source;
      try {
        const { rows, source, schema, warning } = await resolveJobs();
        const published = Array.isArray(rows) ? rows.filter(job => job && job.published !== false) : [];

        if (!published.length) {
          if (hadJobs) {
            if (notice) {
              notice.hidden = false;
              const schemaLabel = schema ? ' · schema fallback' : '';
              notice.textContent = `Showing ${jobsState.all.length} preview roles while the live jobs feed is unavailable (${source}).${schemaLabel}`;
            }
            console.warn(`jobs feed returned 0 rows from ${source}; keeping existing ${previousSource || 'fallback'} dataset`);
            return;
          }

          jobsState.source = source || 'empty';
          jobsState.schema = !!schema;
          updateDataSourceIndicator();
          jobsState.all = [];
          buildDerivedCollections(jobsState.all);
          paintJobs(jobsState.all);
          updateFilterSources();
          refreshChips();
          bindChipEvents();
          bindJobCardEvents();
          if (notice) {
            notice.hidden = false;
            notice.textContent = schema
              ? 'Job data is temporarily unavailable because of a schema mismatch. Please contact support or update the jobs table.'
              : 'Job data is temporarily unavailable. Please try again shortly.';
          }
          return;
        }

        jobsState.source = source;
        jobsState.schema = !!schema;
        updateDataSourceIndicator();
        jobsState.all = published.map(normaliseJob);
        buildDerivedCollections(jobsState.all);
        paintJobs(jobsState.all);
        updateFilterSources();
        refreshChips();
        bindChipEvents();
        bindJobCardEvents();
        const isLiveSource = source === 'api' || source === 'supabase';
        if(!isLiveSource || schema) {
          console.warn(`jobs rendered using ${source} fallback (${jobsState.all.length} records${schema ? ', schema mismatch' : ''})`);
          if (notice) {
            notice.hidden = false;
            notice.textContent = jobsState.all.length
              ? `Showing ${jobsState.all.length} preview roles because the live jobs database was unavailable (${source}).${schema ? ' Schema mismatch detected.' : ''}`
              : schema
                ? 'Job data is temporarily unavailable because of a schema mismatch. Please check the jobs table.'
                : 'Job data is temporarily unavailable. Please try again shortly.';
          }
        } else if (warning && notice) {
          notice.hidden = false;
          notice.textContent = warning;
        }
      } catch (err) {
        console.error('jobs render failed', err);
        if (notice) {
          notice.hidden = false;
          notice.textContent = 'Job data failed to load. Please refresh or contact support.';
        }
      }
    }
    async function bootstrapJobs(){
      let seeded = false;
      const embeddedSeed = loadEmbeddedJobs();
      if (Array.isArray(embeddedSeed) && embeddedSeed.length) {
        console.info('jobs: rendering embedded fallback dataset (%d rows)', embeddedSeed.length);
        showSeededJobs(embeddedSeed, 'embedded');
        seeded = true;
      }

      if (!seeded) {
        try {
          const jsonSeed = await loadJobsJSON();
          if (Array.isArray(jsonSeed) && jsonSeed.length) {
            console.info('jobs: rendering static JSON fallback dataset (%d rows)', jsonSeed.length);
            showSeededJobs(jsonSeed, 'static-json');
            seeded = true;
          }
        } catch (err) {
          console.warn('jobs: static JSON preload failed', err);
        }
      }

      if (!seeded) {
        console.warn('jobs: no immediate fallback dataset available — waiting for API response');
      }

      try {
        await renderJobs();
      } catch (err) {
        console.error('jobs initial load failed', err);
        if (!seededJobsApplied) {
          const fallbackNotice = document.getElementById('jobsFallbackNotice');
          if (fallbackNotice) {
            fallbackNotice.hidden = false;
            fallbackNotice.textContent = 'Job data is temporarily unavailable. Please try again shortly.';
          }
        }
      }
    }

    bootstrapJobs();
    /* ---------- Nav ---------- */
    const burger=document.querySelector('.hmj-burger');
    const menu=document.getElementById('hmj-menu');
    const scrim=document.querySelector('.hmj-scrim');
    const currentSegment=(location.pathname.replace(/\/+$/, '').split('/').pop()||'jobs.html').toLowerCase();
    const currentNormalized=currentSegment.replace(/^\//,'');
    menu.querySelectorAll('a[href]').forEach(a=>{
      const href=(a.getAttribute('href')||'').trim();
      if(!href || href.includes('://')) return;
      const target=(href.split('#')[0]||'').replace(/^\//,'').toLowerCase()||'index.html';
      if(target===currentNormalized) a.setAttribute('aria-current','page');
    });
    function openMenu(open){ burger.setAttribute('aria-expanded',String(open)); menu.classList.toggle('open',open); scrim.hidden=!open; document.documentElement.style.overflow=open?'hidden':''; }
    burger.addEventListener('click',()=>openMenu(burger.getAttribute('aria-expanded')!=='true'));
    scrim.addEventListener('click',()=>openMenu(false));
    menu.addEventListener('click',(e)=>{ const link=e.target.closest('a[href]'); if(!link) return; requestAnimationFrame(()=>openMenu(false)); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') openMenu(false); });

    /* ---------- Reveal-on-scroll ---------- */
    const toReveal=document.querySelectorAll('.reveal, .job');
    if('IntersectionObserver' in window){
      const io=new IntersectionObserver((entries)=>{ entries.forEach(ent=>{ if(ent.isIntersecting){ ent.target.classList.add('revealed'); io.unobserve(ent.target);} }); },{threshold:0.12});
      toReveal.forEach(el=>io.observe(el));
    } else { toReveal.forEach(el=>el.classList.add('revealed')); }

    /* ---------- Scroll to top ---------- */
    const topBtn=document.getElementById('scrollTopBtn');
    const showTop=()=>{ if(window.scrollY>420){ topBtn.classList.add('show'); } else { topBtn.classList.remove('show'); } };
    showTop(); window.addEventListener('scroll',showTop,{passive:true});
    topBtn.addEventListener('click',()=>{ const reduce=window.matchMedia('(prefers-reduced-motion: reduce)').matches; window.scrollTo({top:0,behavior:reduce?'auto':'smooth'}); });

    /* ---------- Filters, Search & Shortlist ---------- */
    const state={status:'all',location:'all',type:'all',disc:'all',search:'',shortlistOnly:false};
    const resultCount=document.getElementById('resultCount');
    const noResultsEl=document.getElementById('noResults');
    const locationSel=document.getElementById('locationFilter');
    const searchBox=document.getElementById('searchBox');
    const searchBoxMobile=document.getElementById('searchBoxMobile');
    const clearBtn=document.getElementById('clearFilters');
    const filtersEl=document.getElementById('filters');
    const toggleFiltersBtn=document.getElementById('toggleFilters');
    const activeCountEl=document.getElementById('activeCount');
    const shortlistBtn=document.getElementById('shortlistBtn');

    if(window.matchMedia('(max-width:680px)').matches){ filtersEl.classList.remove('open'); } else { filtersEl.classList.add('open'); }
    toggleFiltersBtn?.addEventListener('click',()=>filtersEl.classList.toggle('open'));
    refreshChips();
    bindChipEvents();

    function syncSearch(value){
      if(searchBox && document.activeElement!==searchBox){ searchBox.value=value; }
      if(searchBoxMobile && document.activeElement!==searchBoxMobile){ searchBoxMobile.value=value; }
      state.search=value.trim().toLowerCase(); applyFilters();
    }
    searchBox?.addEventListener('input',e=>syncSearch(e.target.value));
    searchBoxMobile?.addEventListener('input',e=>syncSearch(e.target.value));

    const PIN_KEY=SHORTLIST_KEY;
    const getPins=()=>new Set(JSON.parse(localStorage.getItem(PIN_KEY)||'[]'));
    const setPins=(set)=>localStorage.setItem(PIN_KEY,JSON.stringify([...set]));
    function refreshPinsUI(){
      const pins=getPins();
      jobsEls.forEach(job=>{
        const id=job.id||job.dataset.id||job.querySelector('h3')?.textContent?.trim();
        const btn=job.querySelector('.pin-btn'); if(!btn) return;
        const isPinned=pins.has(id);
        btn.setAttribute('aria-pressed',String(isPinned));
        btn.textContent=isPinned?'★ Saved':'☆ Save';
      });
      shortlistBtn.textContent=`Shortlist (${pins.size})`;
    }
    shortlistBtn.addEventListener('click',()=>{
      state.shortlistOnly=!state.shortlistOnly;
      shortlistBtn.classList.toggle('btn-primary',state.shortlistOnly);
      shortlistBtn.title=state.shortlistOnly?'Showing only saved roles':'Show saved roles';
      applyFilters();
    });
    refreshPinsUI();

    locationSel.addEventListener('change',()=>{ state.location=locationSel.value; applyFilters(); });
    clearBtn.addEventListener('click',()=>{
      refreshChips();
      state.status='all'; state.location='all'; state.type='all'; state.disc='all'; state.search=''; state.shortlistOnly=false;
      locationSel.value='all'; searchBox&&(searchBox.value=''); searchBoxMobile&&(searchBoxMobile.value=''); shortlistBtn.classList.remove('btn-primary');
      ['status','type','disc'].forEach(group=>{
        const list=chips.filter(c=>c.dataset.chip===group);
        list.forEach(c=>{ c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
        const allBtn=list.find(c=>c.dataset.value==='all'); if(allBtn){ allBtn.classList.add('active'); allBtn.setAttribute('aria-pressed','true'); }
      });
      applyFilters();
    });

    function getAttr(el,name){ return (el.getAttribute(name)||'').toLowerCase(); }
    function matchSearch(job){ if(!state.search) return true; const hay=(job.dataset.keywords||job.textContent||'').toLowerCase(); return hay.includes(state.search); }
    function matchPins(job){ if(!state.shortlistOnly) return true; const pins=getPins(); const id=job.id||job.dataset.id||job.querySelector('h3')?.textContent?.trim(); return pins.has(id); }
    function activeFiltersCount(){ let n=0; if(state.status!=='all') n++; if(state.location!=='all') n++; if(state.type!=='all') n++; if(state.disc!=='all') n++; if(state.search) n++; if(state.shortlistOnly) n++; return n; }

    function applyFilters(){
      let shown=0; const total=jobsEls.length;
      jobsEls.forEach(job=>{
        const keep=(state.status==='all'||getAttr(job,'data-status')===state.status) &&
                   (state.location==='all'||getAttr(job,'data-location')===state.location) &&
                   (state.type==='all'||getAttr(job,'data-type')===state.type) &&
                   (state.disc==='all'||getAttr(job,'data-disc')===state.disc) &&
                   matchSearch(job) && matchPins(job);
        job.style.display=keep?'block':'none'; if(keep) shown++;
      });
      noResultsEl.style.display=shown?'none':'block';
      const baseMsg = shown===total?'Showing all jobs':`Showing ${shown} of ${total} jobs`;
      const isLiveSource = jobsState.source === 'api' || jobsState.source === 'supabase';
      resultCount.textContent = jobsState.source && !isLiveSource
        ? `${baseMsg} — preview data (${jobsState.source})`
        : baseMsg;
      if(activeCountEl) activeCountEl.textContent=activeFiltersCount();
    }
    applyFilters();

    /* ---------- Share buttons ---------- */
    const toast=document.getElementById('toast');
    function showToast(msg='Link copied!'){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),1800); }
    function handleShare(job){
      const title=job.querySelector('h3')?.textContent?.trim()||'HMJ-Global role';
      const loc=job.querySelector('p strong')?.nextSibling?.textContent?.trim()||'';
      const url=`${location.origin}${location.pathname}${location.search}#${job.id||job.dataset.id||''}`;
      const text=`${title} at HMJ-Global\n${loc ? 'Location: '+loc+'\n' : ''}Apply or learn more: ${url}`;
      if(navigator.share){ navigator.share({title,text,url}).catch(()=>{}); }
      else{
        const full=`${title}\n${text}\n— HMJ-Global • https://www.hmj-global.com`;
        if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(full).then(()=>showToast(),()=>showToast('Copy failed')); }
        else{ const ta=document.createElement('textarea'); ta.value=full; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showToast(); }catch(e){ showToast('Copy failed'); } document.body.removeChild(ta); }
      }
    }
    /* ---------- Expandable Details ---------- */
    window.toggleDetails=function(btn){
      const details=btn.parentElement.nextElementSibling;
      details.classList.toggle('open');
      btn.textContent=details.classList.contains('open')?'Hide Details':'Details';
    };
  })();
  </script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  const portalLink = document.querySelector('a[href="/admin/"]');
  if (portalLink) {
    portalLink.style.display = 'none';
    function toggle() { portalLink.style.display = netlifyIdentity.currentUser() ? '' : 'none'; }
    netlifyIdentity.on('init', toggle);
    netlifyIdentity.on('login', toggle);
    netlifyIdentity.on('logout', toggle);
    netlifyIdentity.init();
  }
</script>


<!-- add before </body> on jobs.html -->
<script>
(function(){
  // Copy anchor on hash change (gives feedback)
  function feedback(msg){
    const b = document.createElement('div');
    b.textContent = msg;
    Object.assign(b.style, {position:'fixed',right:'16px',bottom:'16px',background:'#0b1020',color:'#cbd5e1',padding:'8px 10px',border:'1px solid #223',borderRadius:'10px',zIndex:9999});
    document.body.appendChild(b); setTimeout(()=>b.remove(), 1600);
  }
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href^="#"]'); if(!a) return;
    const url = location.pathname + a.getAttribute('href');
    navigator.clipboard?.writeText(url); feedback('Anchor copied');
  });

  // Persist last used search/filter in localStorage (if your page has them)
  const q = document.querySelector('input[type="search"], input[name="q"]');
  if(q){
    q.value = localStorage.getItem('hmj-jobs-q')||'';
    q.addEventListener('input', ()=> localStorage.setItem('hmj-jobs-q', q.value));
  }
})();
</script>


</body>
</html>
