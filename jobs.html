<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HMJ Global — CMS Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://identity.netlify.com" crossorigin>

  <!-- We will init CMS manually after we purge its cached route -->
  <script>window.CMS_MANUAL_INIT = true;</script>

  <!-- ================== INLINE CMS CONFIG (single JSON file) ================== -->
  <script>
    window.CMS_CONFIG = {
      backend: { name: "git-gateway", branch: "main" },
      publish_mode: "editorial_workflow",
      media_folder: "images/uploads",
      public_folder: "/images/uploads",
      collections: [
        {
          label: "Jobs Data",
          name: "jobsData",
          files: [
            {
              label: "Jobs Data",
              name: "jobs",
              file: "data/jobs.json",
              format: "json",
              editor: { preview: false },
              description: "Single JSON file powering /jobs.html.",
              fields: [
                {
                  label: "Jobs",
                  name: "jobs",
                  widget: "list",
                  collapsed: true,
                  summary: "{{fields.title}} — {{fields.locationText}} ({{fields.status}} | {{fields.section}} | {{fields.type}})",
                  fields: [
                    { label: "ID (URL anchor)", name: "id", widget: "string",
                      pattern: ["^[a-z0-9-]+$", "Lowercase letters, numbers and hyphens only."] },
                    { label: "Published", name: "published", widget: "boolean", default: true },
                    { label: "Title", name: "title", widget: "string" },
                    { label: "Status", name: "status", widget: "select",
                      options: [
                        { label: "Live — Taking Candidates", value: "live" },
                        { label: "Interviewing — Shortlist in Review", value: "interviewing" },
                        { label: "Closed — Not Accepting New Applicants", value: "closed" }
                      ],
                      default: "live" },
                    { label: "Section", name: "section", widget: "select",
                      options: [
                        { label: "Data Centre — Commercial", value: "commercial" },
                        { label: "Data Centre — Engineering & Management", value: "dc" },
                        { label: "Substations, Power & Energy", value: "substations" },
                        { label: "Life Sciences & Pharma", value: "pharma" },
                        { label: "ICT & Commissioning", value: "ict" }
                      ],
                      default: "dc" },
                    { label: "Discipline", name: "discipline", widget: "select",
                      options: ["Data Centre", "Life Sciences", "Pharma", "Substation"],
                      default: "Data Centre" },
                    { label: "Employment Type", name: "type", widget: "select",
                      options: [{label:"Permanent",value:"permanent"},{label:"Contract",value:"contract"}],
                      default: "permanent" },
                    { label: "Location Code", name: "locationCode", widget: "select",
                      options: [
                        { label: "Amsterdam, Netherlands", value: "amsterdam" },
                        { label: "Dublin, Ireland", value: "dublin" },
                        { label: "Eemshaven, Netherlands", value: "eemshaven" },
                        { label: "Espoo, Finland", value: "espoo" },
                        { label: "Frankfurt, Germany", value: "frankfurt" },
                        { label: "Groningen, Netherlands", value: "groningen" },
                        { label: "Helsinki, Finland", value: "helsinki" },
                        { label: "London, UK", value: "london" },
                        { label: "Macclesfield, UK", value: "macclesfield" },
                        { label: "UK (Various)", value: "uk" },
                        { label: "Europe (Travel)", value: "europe" }
                      ],
                      default: "uk" },
                    { label: "Location Text", name: "locationText", widget: "string", required: false },
                    { label: "Keywords", name: "keywords", widget: "text", required: false },
                    { label: "Overview", name: "overview", widget: "text", required: false },
                    { label: "Responsibilities", name: "responsibilities", widget: "list", required: false,
                      field: { label: "Item", name: "item", widget: "string" } },
                    { label: "Requirements", name: "requirements", widget: "list", required: false,
                      field: { label: "Item", name: "item", widget: "string" } },
                    { label: "Apply URL (optional)", name: "applyUrl", widget: "string", required: false }
                  ]
                }
              ]
            }
          ]
        }
      ]
    };
  </script>

  <!-- Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script>

  <style>
    :root{--ink:#0f1322;--panel:#0f162c;--accent:#3A66B3;--b:rgba(255,255,255,.14);--b2:rgba(255,255,255,.09)}
    *{box-sizing:border-box}
    body{margin:0;background:#0b0f1c;color:#eaf0ff;font-family:Calibri,"Segoe UI",Roboto,Arial,Helvetica,sans-serif}
    .top{position:sticky;top:0;z-index:50;background:linear-gradient(90deg,rgba(58,102,179,.12),rgba(58,102,179,.05));border-bottom:1px solid var(--b2);backdrop-filter:blur(6px)}
    .top .in{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;border:1px solid var(--b);background:#0f162c;color:#fff;text-decoration:none;font-weight:700}
    .btn.blue{background:var(--accent);border-color:rgba(58,102,179,.85)}
    #nc-root{max-width:1200px;margin:14px auto 110px;padding:0 12px}
    /* dock bottom-right */
    .dock{position:fixed;right:14px;bottom:14px;z-index:60;background:var(--panel);border:1px solid var(--b);border-radius:16px;padding:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .dock input,.dock select{background:#0f1831;border:1px solid var(--b);color:#fff;border-radius:10px;padding:10px 12px}
    .dock .btn{background:#0f1831}
    /* CMS chrome polish */
    .nc-appHeader{background:#0f1322!important;border-bottom:1px solid var(--b2)!important}
    .nc-toolbar{background:#0f1322!important;border-top:1px solid var(--b2)!important}
    .nc-primary{background:var(--accent)!important;color:#fff!important;border:1px solid rgba(58,102,179,.9)!important}
  </style>
</head>
<body>
  <!-- top nav -->
  <div class="top">
    <div class="in">
      <div class="brand"><span class="dot"></span> HMJ Global — CMS Portal</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn blue" href="/">⟵ Return to Homepage</a>
        <a class="btn" href="/jobs.html" target="_blank" rel="noopener">View Jobs Page</a>
        <button id="btnOpenEditor" class="btn" type="button">Open Jobs in Editor</button>
        <button id="btnSignOut" class="btn" type="button">Sign out</button>
        <a class="btn" href="https://app.netlify.com" target="_blank" rel="noopener">Netlify</a>
        <a class="btn" href="https://github.com" target="_blank" rel="noopener">GitHub</a>
      </div>
    </div>
  </div>

  <!-- CMS mount -->
  <div id="nc-root" role="region" aria-label="Netlify CMS"></div>

  <!-- quick dock bottom-right -->
  <div class="dock" aria-label="Quick actions">
    <input id="q" type="search" placeholder="Search jobs (title, location, status)…" />
    <select id="tpl"><option value="">Templates:</option><option>BMS Engineer</option><option>CSA QS</option><option>Planner</option></select>
    <a class="btn" href="/jobs.html" target="_blank" rel="noopener">Preview</a>
    <button class="btn" id="topBtn" type="button">↑ Top</button>
    <button class="btn" id="dupBtn" type="button">Duplicate current</button>
    <input id="anchor" type="text" placeholder="anchor-id (e.g., mep-qs-dublin)" />
    <button class="btn" id="openAnchor" type="button">Open anchor</button>
    <button class="btn" id="copyBtn" type="button">Copy</button>
  </div>

  <!-- ============================ BOOTSTRAP ============================ -->
  <script>
    (function(){
      const SAFE_HOME = "#/";
      const ENTRY_HASH = "#/collections/jobsData/entries/jobs";

      /* 1) PURGE any saved CMS state so it can’t restore a deep route */
      function purgeCmsCache() {
        try {
          const keys = Object.keys(localStorage);
          for (const k of keys) {
            if (/^netlify-cms/i.test(k) || /^cms\./i.test(k) || /^editorialWorkflow/i.test(k)) {
              localStorage.removeItem(k);
            }
          }
          // hold at #/
          if (location.hash !== SAFE_HOME) location.replace(SAFE_HOME);
        } catch(_) {}
      }

      /* 2) tiny helper to load CMS script after purge */
      function loadScript(src){
        return new Promise((res, rej)=>{
          const s = document.createElement("script");
          s.src = src; s.onload = res; s.onerror = rej;
          document.head.appendChild(s);
        });
      }

      /* 3) identity ready (not strictly required, but nice) */
      function identityReady(){
        return new Promise(resolve=>{
          if (!window.netlifyIdentity) return resolve();
          if (window.netlifyIdentity.currentUser()) return resolve();
          window.netlifyIdentity.on && window.netlifyIdentity.on("init", resolve);
          // trigger init
          window.netlifyIdentity.init && window.netlifyIdentity.init();
          // safety timeout
          setTimeout(resolve, 1200);
        });
      }

      /* 4) when CMS state has collections */
      function storeReady(){
        try{
          const st = window.CMS && window.CMS.getState && window.CMS.getState();
          const colls = st && st.get && st.get("collections");
          return !!(colls && colls.size && colls.get("jobsData"));
        }catch(_){ return false; }
      }
      function waitForStore(timeout=10000){
        return new Promise((res, rej)=>{
          const t0 = Date.now();
          (function tick(){
            if (storeReady()) return res();
            if (Date.now()-t0 > timeout) return rej(new Error("CMS is still starting—try again in a second."));
            // while waiting, keep the hash at #/ so it can’t deep route
            if (/^#\/collections\//.test(location.hash)) location.replace(SAFE_HOME);
            setTimeout(tick, 100);
          })();
        });
      }

      /* 5) boot sequence */
      (async function boot(){
        purgeCmsCache();                     // stop restore of old route
        await identityReady();               // (optional) wait briefly for identity
        await loadScript("https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js");
        window.CMS && window.CMS.init({ config: window.CMS_CONFIG });

        // only after hydration, allow navigation
        try { await waitForStore(); }
        catch(e){ alert(e.message); }

        // Wire UI controls
        document.getElementById("btnOpenEditor")?.addEventListener("click", async ()=>{
          if (!storeReady()) { alert("CMS is still starting—try again in a second."); return; }
          location.hash = ENTRY_HASH;
        });
      })();

      /* Extras */
      document.getElementById("btnSignOut")?.addEventListener("click", ()=>{
        try{ window.netlifyIdentity && window.netlifyIdentity.logout(); }catch{}
        try{ localStorage.clear(); sessionStorage.clear(); }catch{}
        location.reload();
      });
      document.getElementById("topBtn").onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });
      document.getElementById("openAnchor").onclick = () => {
        const id = (document.getElementById("anchor").value || "").trim();
        if (id) window.open("/jobs.html#" + encodeURIComponent(id), "_blank", "noopener");
      };
      document.getElementById("copyBtn").onclick = async () => {
        const id = (document.getElementById("anchor").value || "").trim();
        if (id) try{ await navigator.clipboard.writeText(id); }catch{}
      };
      document.getElementById("dupBtn").onclick = () => {
        alert("Use “Add item” inside Jobs to create a new role.\n(JSON mode doesn’t auto-duplicate the block.)");
      };

      // If someone manually navigates during boot, keep them at #/
      window.addEventListener("hashchange", ()=>{
        if (!storeReady() && /^#\/collections\//.test(location.hash)) location.replace(SAFE_HOME);
      });
    })();
  </script>
</body>
</html>
