<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets | HMJ-Global</title>
<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{
    --ink:#0c1118; --muted:#6b7b91; --bg:#081122;
    --panel:#0c1830; --panel-light:#ffffff; --border:#1e2f4a;
    --blue:#3878ff; --green:#15b871; --red:#ff6a6a; --amber:#ffd166;
  }
  body{margin:0;background:var(--bg);color:#e6edf6;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
  .white{background:var(--panel-light); color:var(--ink); border:1px solid #e2e8f0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .spacer{flex:1}
  .btn{background:#132544;border:1px solid #2e4773;color:#fff;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3a5aa1}
  .btn.primary{background:var(--blue);border-color:transparent}
  .btn.success{background:var(--green);border-color:transparent}
  .btn.warn{background:#3a2c10;border-color:#5b460f}
  .btn.ghost{background:transparent;border-color:#2e4773}
  select,input{background:#0d1730;color:#e6edf6;border:1px solid #2e4773;border-radius:10px;padding:9px}
  input.white, select.white { background:#fff; color:#0c1118; border:1px solid #cbd5e1 }
  table.grid{width:100%;border-collapse:collapse}
  table.grid th,table.grid td{border-bottom:1px solid var(--border);padding:10px;text-align:left}
  .muted{color:#9fb3c8}
  .tabs{display:flex; gap:8px; align-items:center}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #2e4773;cursor:pointer}
  .tab.active{background:#1b2d56}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1f3f;border:1px solid #2e4773;color:#c7d2fe;font-variant-numeric:tabular-nums}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 9px;border-radius:10px;background:#0f1f3f;border:1px solid #2e4773}
  .section{margin-top:8px;margin-bottom:4px;font-weight:700}
  .tableWrap .week{margin-top:6px;margin-bottom:2px;color:#cbd5e1}
  .hover-row:hover{background:rgba(255,255,255,0.03)}
  .right{ text-align:right }
  .sticky{position:sticky; top:0; z-index:20; backdrop-filter:saturate(120%) blur(6px)}
  /* Modal */
  .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; align-items:center; justify-content:center;}
  .modal > .box{background:#0c1830; border:1px solid #1e2f4a; color:#e6edf6; width:min(800px,94vw); border-radius:14px; padding:16px;}
  .audit{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:#0b1325; border:1px solid #1e2f4a; padding:8px; border-radius:10px; max-height:320px; overflow:auto}
</style>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="card sticky">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1 style="margin:0 0 6px">Timesheets</h1>
        <div class="muted">Review, create, edit, approve, reject. All changes are audited.</div>
      </div>
      <div class="row">
        <a class="btn ghost" href="/admin/">⟵ Back to CMS</a>
        <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="tabs" id="statusTabs">
        <span class="tab active" data-status="">All <span class="badge" id="countAll">0</span></span>
        <span class="tab" data-status="submitted">Submitted <span class="badge" id="countSubmitted">0</span></span>
        <span class="tab" data-status="approved">Approved <span class="badge" id="countApproved">0</span></span>
        <span class="tab" data-status="rejected">Rejected <span class="badge" id="countRejected">0</span></span>
        <span class="tab" data-status="draft">Draft <span class="badge" id="countDraft">0</span></span>
      </div>
      <span class="spacer"></span>
      <select id="fltClient"></select>
      <input id="fltWeek" type="date"/>
      <input id="fltQ" class="white" placeholder="Search contractor / project / client" style="min-width:240px"/>
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn success" id="btnBulkApprove">Bulk approve</button>
      <button class="btn" id="btnExport">Export CSV</button>
      <button class="btn primary" id="btnCreate">+ Create on behalf</button>
    </div>
  </div>

  <!-- Gate -->
  <div id="gate" class="card" style="display:none">
    <p><strong>Admin only.</strong> Log in with an admin account.</p>
    <button class="btn primary" onclick="netlifyIdentity?.open('login')">Log in</button>
  </div>

  <!-- App -->
  <div id="app" style="display:none">
    <!-- table -->
    <div class="card white">
      <div id="tableWrap" class="tableWrap">Loading…</div>
    </div>

    <!-- audit -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="section">Recent admin activity</div>
        <button class="btn" id="btnReloadAudit">Reload</button>
      </div>
      <div id="auditBox" class="audit">Loading…</div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div id="tsModal" class="modal"><div class="box">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
    <h3 style="margin:0">Timesheet details</h3>
    <button class="btn" onclick="closeModal('tsModal')">Close</button>
  </div>
  <div id="tsModalBody" class="muted">Loading…</div>
  <div class="row" style="margin-top:10px">
    <button class="btn" id="btnEditSave">Save Edits</button>
    <button class="btn success" id="btnApproveOne">Approve</button>
    <button class="btn warn" id="btnRejectOne">Reject…</button>
  </div>
</div></div>

<!-- Create Modal -->
<div id="createModal" class="modal"><div class="box">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
    <h3 style="margin:0">Create timesheet on behalf</h3>
    <button class="btn" onclick="closeModal('createModal')">Close</button>
  </div>
  <div class="row" style="gap:12px">
    <select id="assignSelect" class="white" style="min-width:320px"></select>
    <input id="createWeek" type="date" class="white"/>
    <button class="btn primary" id="btnCreateDo">Create</button>
  </div>
  <div class="muted" style="margin-top:8px">Only active assignments are listed.</div>
</div></div>

<script>
  const $ = (s)=>document.querySelector(s);
  const api = async (path, method='GET', body=null)=>{
    const u = netlifyIdentity.currentUser(); if(!u) throw new Error('No session');
    const t = await u.jwt();
    const r = await fetch(`/.netlify/functions${path}`,{
      method, headers:{'Content-Type':'application/json','Authorization':`Bearer ${t}`},
      body: body?JSON.stringify(body):null
    });
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  };

  function closeModal(id){ document.getElementById(id).style.display='none'; }
  function openModal(id){ document.getElementById(id).style.display='flex'; }

  let currentStatus = '';
  let currentDetailId = null;

  async function loadClients(){
    const list = await api('/admin-timesheets-clients');
    $('#fltClient').innerHTML = `<option value="">All clients</option>` + list.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  }

  function groupByWeek(rows){
    const m = new Map();
    rows.forEach(r=>{
      const w = r.week_ending;
      if(!m.has(w)) m.set(w, []);
      m.get(w).push(r);
    });
    return m;
  }

  function renderTable(blocks){
    const wrap = $('#tableWrap');
    if (!blocks || !blocks.size) { wrap.innerHTML = `<div class="muted">No timesheets found.</div>`; return; }
    let html = '';
    [...blocks.keys()].sort((a,b)=>a<b?1:-1).forEach(week=>{
      html += `<div class="week"><b>Week ending ${week}</b></div>`;
      html += `<table class="grid white" style="margin-bottom:12px">
        <thead><tr>
          <th><input type="checkbox" class="chkAll" data-week="${week}"></th>
          <th>Contractor</th><th>Client</th><th>Project</th>
          <th class="right">Hours</th><th>Status</th><th>Actions</th>
        </tr></thead><tbody>`;
      blocks.get(week).forEach(r=>{
        html += `<tr class="hover-row">
          <td><input type="checkbox" class="rowchk" data-id="${r.id}"></td>
          <td>${r.contractor_name}</td>
          <td>${r.client_name}</td>
          <td>${r.project_name}</td>
          <td class="right">${r.total_hours}</td>
          <td>${r.status}</td>
          <td>
            <button class="btn" data-act="open" data-id="${r.id}">View</button>
            <button class="btn success" data-act="approve" data-id="${r.id}">Approve</button>
            <button class="btn warn" data-act="reject" data-id="${r.id}">Reject</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
    });
    wrap.innerHTML = html;

    wrap.onclick = async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      if (act==='open'){ currentDetailId=id; openDetail(id); return; }
      if (act==='approve'){ await api('/admin-timesheets-approve','POST',{id}); await refresh(); return; }
      if (act==='reject'){ const reason = prompt('Reason (optional):',''); await api('/admin-timesheet-reject','POST',{id, reason}); await refresh(); return; }
    };
  }

  async function refresh(){
    const body = {
      status: currentStatus,
      client_id: $('#fltClient').value || null,
      week: $('#fltWeek').value || null,
      q: $('#fltQ').value || ''
    };
    const res = await api('/admin-timesheets-list','POST',body);
    const rows = res.rows || [];

    // counts for tabs
    $('#countAll').textContent = res.count ?? rows.length;
    $('#countSubmitted').textContent = rows.filter(r=>r.status==='submitted').length;
    $('#countApproved').textContent = rows.filter(r=>r.status==='approved').length;
    $('#countRejected').textContent = rows.filter(r=>r.status==='rejected').length;
    $('#countDraft').textContent = rows.filter(r=>r.status==='draft').length;

    renderTable(groupByWeek(rows));
  }

  async function openDetail(id){
    $('#tsModalBody').textContent = 'Loading…'; openModal('tsModal');
    const d = await api('/admin-timesheets-detail','POST',{id});
    const order = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const rows = order.map(k=>{
      const x = d.entries[k]||{std:0,ot:0,note:''};
      return `<tr>
        <td>${k}</td>
        <td><input type="number" step="0.25" class="white" data-day="${k}" data-kind="std" value="${x.std}"/></td>
        <td><input type="number" step="0.25" class="white" data-day="${k}" data-kind="ot"  value="${x.ot}"/></td>
        <td><input type="text" class="white" data-day="${k}" data-kind="note" value="${x.note||''}"/></td>
      </tr>`;
    }).join('');
    $('#tsModalBody').innerHTML = `
      <div style="margin-bottom:10px"><strong>${d.contractor_name}</strong> — ${d.client_name} — ${d.project_name}<br>
      Week ending ${d.week_ending} • Status: ${d.status}</div>
      <table class="grid white">
        <thead><tr><th>Day</th><th>Std</th><th>OT</th><th>Notes</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  async function loadAudit(){
    const list = await api('/admin-audit-list','POST',{limit:100});
    $('#auditBox').innerHTML = list.map(a=>`${new Date(a.at).toLocaleString()}  ::  ${a.actor_email}  ::  ${a.action}  ::  ${a.target_type}#${a.target_id}`).join('\n');
  }

  async function boot(){
    const user = netlifyIdentity?.currentUser();
    const roles = user?.app_metadata?.roles || user?.roles || [];
    if (!user || !roles.includes('admin')){ $('#gate').style.display='block'; return; }
    $('#app').style.display='block';

    await loadClients();
    await refresh();
    await loadAudit();

    // events
    $('#btnRefresh').onclick = refresh;
    $('#btnReloadAudit').onclick = loadAudit;
    document.querySelectorAll('#statusTabs .tab').forEach(t=>{
      t.onclick = ()=>{ document.querySelectorAll('#statusTabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); currentStatus=t.dataset.status||''; refresh(); };
    });
    $('#fltClient').onchange = refresh; $('#fltWeek').onchange = refresh;
    $('#fltQ').oninput = () => { clearTimeout(window._deb); window._deb = setTimeout(refresh, 300); };

    $('#btnBulkApprove').onclick = async ()=>{
      const ids = [...document.querySelectorAll('.rowchk:checked')].map(x=>x.dataset.id);
      if (!ids.length) return alert('Select rows first');
      await api('/admin-timesheets-bulk-approve','POST',{ids});
      await refresh(); await loadAudit();
    };

    $('#btnExport').onclick = async ()=>{
      const q = { status: currentStatus, client_id: $('#fltClient').value || null, week: $('#fltWeek').value || null, q: $('#fltQ').value || '' };
      const res = await api('/admin-timesheets-export','POST',q);
      const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(res.csv);
      a.download = `timesheets-${Date.now()}.csv`; a.click();
    };

    // Create on behalf: load active assignments
    $('#btnCreate').onclick = async ()=>{
      openModal('createModal');
      // light query: active assignments with names (build a small view later if you want)
      const { rows } = await api('/admin-timesheets-list','POST',{ status:'', limit:1 }); // poke token
      // minimal fetch of active assignments for dropdown
      const { data, error } = await supaAssignments(); // helper below using function endpoint
      if (error) { alert(error); return; }
      $('#assignSelect').innerHTML = data.map(a=>`<option value="${a.id}">${a.contractor_name} — ${a.client_name} — ${a.project_name}</option>`).join('');
    };
    $('#btnCreateDo').onclick = async ()=>{
      const assignment_id = $('#assignSelect').value;
      const week_ending = $('#createWeek').value;
      if (!assignment_id || !week_ending) return alert('Select assignment and week');
      await api('/admin-timesheets-create','POST',{ assignment_id, week_ending });
      closeModal('createModal'); await refresh(); await loadAudit();
    };

    // Detail modal buttons
    $('#btnApproveOne').onclick = async ()=>{ if(!currentDetailId) return; await api('/admin-timesheets-approve','POST',{id: currentDetailId}); closeModal('tsModal'); await refresh(); await loadAudit(); };
    $('#btnRejectOne').onclick  = async ()=>{ if(!currentDetailId) return; const reason = prompt('Reason (optional)',''); await api('/admin-timesheet-reject','POST',{id: currentDetailId, reason}); closeModal('tsModal'); await refresh(); await loadAudit(); };
    $('#btnEditSave').onclick   = async ()=>{
      if(!currentDetailId) return;
      const map = {}; document.querySelectorAll('#tsModalBody [data-day]').forEach(i=>{
        const d = i.dataset.day, k = i.dataset.kind, v = k==='note' ? i.value : Number(i.value||0);
        map[d] = map[d] || { std:0, ot:0, note:'' }; map[d][k] = v;
      });
      await api('/admin-timesheets-edit','POST',{ id: currentDetailId, entries: map, keep_status: true });
      closeModal('tsModal'); await refresh(); await loadAudit();
    };
  }

  // helper to fetch active assignments for create-modal
  async function supaAssignments(){
    // lightweight query using the service-backed endpoint we already have (no new function needed here)
    // we'll piggyback supabase via a small public RPC if you add later; for now, do a tiny join via CSV export then parse
    // Simpler: return a minimal static set from admin list’s projects present this week (works to get you going)
    const res = await api('/admin-timesheets-list','POST',{ limit: 1000 });
    const uniq = {};
    res.rows.forEach(r=>{
      const key = `${r.contractor_name}|${r.client_name}|${r.project_name}|${r.assignment_id}`;
      if (!uniq[key]) uniq[key] = { id: r.assignment_id, contractor_name:r.contractor_name, client_name:r.client_name, project_name:r.project_name };
    });
    return { data: Object.values(uniq) };
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    netlifyIdentity?.on('init', boot);
    netlifyIdentity?.on('login', ()=>location.reload());
    netlifyIdentity?.on('logout', ()=>location.href='/admin/');
    setTimeout(()=>{ netlifyIdentity?.currentUser()? boot() : $('#gate').style.display='block'; }, 500);
  });
</script>
</body>
</html>
