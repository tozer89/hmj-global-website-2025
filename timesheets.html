<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Timesheets | HMJ-Global</title>

  <!-- Identity loader ensures the widget only loads when available -->
  <script defer src="js/identity-loader.js"></script>

  <style>
    :root{
      --bg:#121725; --panel:#1b2236; --surface:#f3f6fb;
      --card:#ffffff; --ink:#0e1526; --muted:#5b6b82;
      --accent:#3A66B3; --accent-2:#7aa0e6;
      --good:#22a06b; --warn:#e6a100; --bad:#d14b4b;
      --cardBorder:rgba(26,26,46,.12);
      --chip:#eef3ff; --chipBorder:rgba(58,102,179,.28);
      --radius:14px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#0f1422 45%) fixed;
      color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    .hmj-header{position:sticky;top:0;z-index:1000;background:#0f1322;color:#fff;border-bottom:1px solid rgba(255,255,255,.06)}
    .hmj-nav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
    .hmj-logo img{height:40px;display:block}
    .hmj-menu{list-style:none;display:flex;gap:8px;margin-left:auto;padding:0}
    .hmj-menu a{display:inline-block;padding:10px 12px;border-radius:10px;font-weight:700;color:#eaf0ff;text-decoration:none;transition:background .2s,color .2s}
    .hmj-menu a:hover{background:rgba(255,255,255,.10);color:#fff}
    .hmj-menu a[aria-current="page"]{background:rgba(58,102,179,.20);color:#dfe8ff;border:1px solid rgba(58,102,179,.45)}
    .hmj-burger{display:none;margin-left:auto;border:0;background:transparent;width:42px;height:42px;border-radius:10px;cursor:pointer}
    .hmj-burger span{display:block;height:2px;background:#eaf0ff;margin:7px 8px;border-radius:2px;transition:transform .2s,opacity .2s}
    .hmj-scrim{position:fixed;inset:0;background:rgba(0,0,0,.35)}
    @media (max-width:900px){
      .hmj-burger{display:inline-block}
      .hmj-menu{position:fixed;right:12px;left:12px;top:64px;background:#0f1322;border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.35);display:grid;gap:6px;padding:0;max-height:0;overflow:hidden;transition:max-height .28s ease,padding .2s ease}
      .hmj-menu.open{max-height:70vh;padding:10px}
      .hmj-menu a{padding:14px 12px;width:100%}
      .hmj-scrim[hidden]{display:none}
    }
    .hmj-burger[aria-expanded="true"] span:nth-child(1){transform:translateY(9px) rotate(45deg)}
    .hmj-burger[aria-expanded="true"] span:nth-child(2){opacity:0}
    .hmj-burger[aria-expanded="true"] span:nth-child(3){transform:translateY(-9px) rotate(-45deg)}

    .topbar{ padding:18px 16px; background:transparent; }
    .toprow{ max-width:1080px; margin:0 auto; display:flex; gap:12px; align-items:center; }
    .brand{ color:#d9e2ff; font-weight:700; letter-spacing:.2px }
    .spacer{ flex:1 }

    .wrap{ max-width:1080px; margin:0 auto 84px; padding:0 16px; }
    .grid{ display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--cardBorder);
      box-shadow:0 8px 26px rgba(4,10,20,.08);
      border-radius:var(--radius);
      padding:16px;
    }
    .panel-dark{
      background:var(--panel);
      color:#d3dbf4;
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      padding:10px;
    }
    .panel-dark .inner{ background:var(--card); color:var(--ink); border-radius:12px; padding:12px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:10px; border:1px solid var(--cardBorder);
      background:#fff; color:var(--ink); cursor:pointer; text-decoration:none; font-weight:600
    }
    .btn:hover{ filter:brightness(.98) }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
    .btn.ghost{ background:var(--surface) }
    .btn.good{ background:var(--good); color:#fff; border:0 }
    .btn.warn{ background:var(--warn); color:#1a1600; border:0 }
    .btn.bad{ background:var(--bad); color:#fff; border:0 }
    .btn.sm{ padding:7px 10px; font-weight:600 }

    .muted{ color:var(--muted) }
    .kpis{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ background:var(--chip); border:1px solid var(--chipBorder); color:#223259; padding:6px 10px; border-radius:999px; font-weight:700 }
    .section-gap{ margin-top:12px }

    .bubble{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:18px;
      box-shadow:0 10px 34px rgba(4,10,20,.10);
      padding:14px;
    }

    table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    th{ text-align:left; font-size:12px; color:var(--muted); font-weight:700; padding:0 10px 6px }
    td{ background:#fff; border:1px solid var(--cardBorder); padding:8px 10px; vertical-align:middle; }
    td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px; }
    td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px; }
    @media (max-width:600px){
      th:nth-child(2), th:nth-child(3){ width:92px }
      td{ padding:6px 8px }
      .chip{ padding:5px 8px }
    }

    input[type="number"], textarea{
      width:100%; border:1px solid var(--cardBorder); border-radius:8px; padding:8px 10px; font:inherit; color:var(--ink);
      background:#fff;
    }
    textarea{ resize:vertical; min-height:40px }
    input:focus, textarea:focus{ outline:2px solid rgba(58,102,179,.25); border-color:var(--accent) }

    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center }
    .help{ font-size:12px; color:var(--muted) }
    .hidden{ display:none !important }

    /* Lock inputs when not draft */
    #sheet.locked input, #sheet.locked textarea{
      pointer-events:none; filter:grayscale(1); opacity:.6;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:14px; max-width:90vw;
      background:#0c1224; color:#fff; border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; z-index:9999; box-shadow:0 12px 28px rgba(0,0,0,.35);
      font-weight:600
    }

    /* Payslip modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(8,12,22,.55); display:none; align-items:center; justify-content:center; z-index:10000; }
    .modal-backdrop.show{ display:flex; }
    .modal{ width:min(780px, 92vw); background:#fff; color:var(--ink); border-radius:14px; border:1px solid var(--cardBorder); box-shadow:0 24px 60px rgba(0,0,0,.35); overflow:hidden; }
    .modal .hd{ padding:12px 16px; border-bottom:1px solid var(--cardBorder); display:flex; justify-content:space-between; align-items:center; }
    .modal .bd{ padding:14px 16px; max-height:70vh; overflow:auto; }
    .modal .ft{ padding:12px 16px; border-top:1px solid var(--cardBorder); display:flex; justify-content:flex-end; gap:8px; }

    /* Mobile sticky action bar */
    @media (max-width: 980px){
      .fab-bar{
        position:fixed; left:0; right:0; bottom:0; background:rgba(8,12,22,.9);
        border-top:1px solid rgba(255,255,255,.08); padding:10px 12px; display:flex; gap:8px;
        justify-content:flex-end; z-index:9998;
      }
      .wrap{ margin-bottom:120px; }
    }
  </style>
</head>
<body>
  <header class="hmj-header">
    <nav class="hmj-nav" aria-label="Main">
      <a class="hmj-logo" href="index.html">
        <img src="images/logo.png" alt="HMJ-Global Logo" />
      </a>

      <button class="hmj-burger" aria-label="Open menu" aria-expanded="false" aria-controls="hmj-menu">
        <span></span><span></span><span></span>
      </button>

      <ul id="hmj-menu" class="hmj-menu">
        <li><a href="index.html" data-page="index">Home</a></li>
        <li><a href="about.html" data-page="about">About</a></li>
        <li><a href="clients.html" data-page="clients">Clients</a></li>
        <li><a href="candidates.html" data-page="candidates">Candidates</a></li>
        <li><a href="jobs.html" data-page="jobs">Jobs</a></li>
        <li><a href="https://www.hmj-finance.com" target="_blank" rel="noopener">Accounting</a></li>
        <li><a href="/timesheets.html" id="nav-timesheets" aria-disabled="true">Timesheets</a></li>
        <li><a href="/admin/" id="nav-admin" class="requires-admin" style="display:none" aria-disabled="true">Admin Dashboard</a></li>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const admin = document.getElementById('nav-admin');
      const timesheets = document.getElementById('nav-timesheets');
      let identity = null;
      let identityBound = false;

      const rolesOf = (user) => Array.isArray(user?.app_metadata?.roles)
        ? user.app_metadata.roles
        : Array.isArray(user?.roles)
          ? user.roles
          : [];

      function requireLogin(event, destination) {
        if (event) event.preventDefault();
        if (!identity) {
          if (destination) window.location.href = destination;
          return;
        }
        if (destination) sessionStorage.setItem('afterLogin', destination);
        identity.open('login');
      }

      function setTimesheets(user) {
        if (!timesheets) return;
        if (user) {
          timesheets.href = '/timesheets.html';
          timesheets.removeAttribute('aria-disabled');
          timesheets.title = 'Open timesheets';
        } else {
          timesheets.href = '#';
          timesheets.setAttribute('aria-disabled', 'true');
          timesheets.title = 'Sign in to access timesheets';
        }
      }

      function setAdmin(user) {
        if (!admin) return;
        const roles = rolesOf(user);
        const isAdmin = roles.includes('admin');
        if (isAdmin) {
          admin.style.display = 'inline-block';
          admin.href = '/admin/';
          admin.removeAttribute('aria-disabled');
          admin.classList.remove('requires-admin');
          admin.textContent = 'Admin Dashboard';
          admin.title = 'Open the admin dashboard';
        } else {
          admin.style.display = 'none';
          admin.href = '/admin/';
          admin.setAttribute('aria-disabled', 'true');
          admin.classList.add('requires-admin');
          admin.textContent = 'Admin Dashboard';
          admin.title = 'Admin access only';
        }
      }

      function renderFor(user) {
        setTimesheets(user);
        setAdmin(user);
      }

      renderFor(null);

      timesheets?.addEventListener('click', (event) => {
        const user = identity?.currentUser?.();
        if (user) return;
        requireLogin(event, '/timesheets.html');
      });
      admin?.addEventListener('click', (event) => {
        const user = identity?.currentUser?.();
        if (user) return;
        requireLogin(event, '/admin/');
      });

      function bindIdentity(id) {
        if (!id || identityBound) return;
        identity = id;
        identityBound = true;
        try {
          renderFor(identity.currentUser?.() || null);
        } catch {
          renderFor(null);
        }
        identity.on('init', (user) => renderFor(user || null));
        identity.on('login', (user) => renderFor(user || null));
        identity.on('logout', () => renderFor(null));
      }

      if (window.netlifyIdentity) bindIdentity(window.netlifyIdentity);
      else document.addEventListener('netlifyIdentityLoad', () => bindIdentity(window.netlifyIdentity));

      document.addEventListener('hmjIdentityUnavailable', () => renderFor(null), { once: true });
    });
  </script>

      </ul>
      <div class="hmj-scrim" hidden></div>
    </nav>
  </header>

  <script>
    (function(){
      const burger = document.querySelector('.hmj-burger');
      const menu = document.getElementById('hmj-menu');
      const scrim = document.querySelector('.hmj-scrim');
      if(!burger || !menu || !scrim) return;

      const currentSegment = (location.pathname.replace(/\/+$/, '').split('/').pop() || 'timesheets.html').toLowerCase();
      const currentNormalized = currentSegment.replace(/^\//, '');
      menu.querySelectorAll('a[href]').forEach(a => {
        const href = (a.getAttribute('href') || '').trim();
        if (!href || href.includes('://')) return;
        const target = (href.split('#')[0] || '').replace(/^\//, '').toLowerCase() || 'index.html';
        if (target === currentNormalized) a.setAttribute('aria-current', 'page');
      });

      function openMenu(open){
        burger.setAttribute('aria-expanded', String(open));
        menu.classList.toggle('open', open);
        scrim.hidden = !open;
        document.documentElement.style.overflow = open ? 'hidden' : '';
      }

      burger.addEventListener('click', () => openMenu(burger.getAttribute('aria-expanded') !== 'true'));
      scrim.addEventListener('click', () => openMenu(false));
      menu.addEventListener('click', (e) => {
        const link = e.target.closest('a[href]');
        if (!link) return;
        requestAnimationFrame(() => openMenu(false));
      });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') openMenu(false); });
    })();
  </script>

  <div class="topbar">
    <div class="toprow">
      <div class="brand">HMJ Global — Timesheets</div>
      <span class="spacer"></span>
      <a class="btn ghost sm" href="/">← Return to Homepage</a>
      <button id="btnSignOut" class="btn sm">Sign out</button>
    </div>
  </div>

  <div class="wrap">

    <!-- Login gate -->
    <div id="gate" class="card hidden">
      <p>Please log in to access your timesheets.</p>
      <button class="btn primary" onclick="window.netlifyIdentity && window.netlifyIdentity.open('login')">Log in</button>
    </div>

    <!-- App -->
    <div id="app" class="grid hidden">
      <div>
        <!-- Summary -->
        <div class="card" id="summary">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <h2 style="margin:0">My Timesheet</h2>
              <div class="muted" id="deadlineBlurb">
                Submit your hours by <b id="deadlineEmphasis">Tuesday 12:00 (UK)</b> for Friday payment.
                <span id="deadlineTag" class="chip" style="margin-left:6px">Deadline: Tue 12:00</span>
              </div>
              <div id="assnLine" class="muted section-gap hidden"></div>
            </div>
            <div class="kpis">
              <span class="chip" id="kStd">Std 0h</span>
              <span class="chip" id="kOT">OT 0h</span>
              <span class="chip" id="kTotal">Total 0h</span>
              <span class="chip" id="kGross">Est. gross £0.00</span>
            </div>
          </div>
        </div>

        <!-- Timesheet -->
        <div class="bubble section-gap" id="sheet">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
            <h3 style="margin:4px 0" id="weekTitle">This Week</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn ghost sm" onclick="quickFill('8x5')">Mon–Fri 8h</button>
              <button class="btn ghost sm" onclick="clearAll()">Clear all</button>
              <button class="btn ghost sm" onclick="setAll('std')">Set all…</button>
              <button class="btn ghost sm" onclick="resetWeek()">Reset week</button>
            </div>
          </div>

          <table aria-label="Timesheet">
            <thead><tr><th>Day</th><th>Std (h)</th><th>OT (h)</th><th>Note</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>

          <div class="row-actions section-gap">
            <span class="help" id="statusHelp"></span>
            <span style="flex:1"></span>
            <button class="btn warn" onclick="raiseIssue()">Raise issue</button>
            <button class="btn" onclick="saveDraft()">Save draft</button>
            <button class="btn good" onclick="submitTimesheet()">Submit</button>
            <button class="btn warn hidden" id="btnReqEdit" onclick="requestEdit()">Request edit</button>
            <button class="btn bad hidden" id="btnReqDelete" onclick="requestDelete()">Request delete</button>
          </div>
        </div>

        <!-- History -->
        <div class="card section-gap" id="history">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Previous Weeks</h3>
            <button class="btn ghost sm" onclick="toggleHistory()" id="btnHistToggle">Collapse</button>
          </div>
          <div id="histBody" class="muted section-gap">—</div>
        </div>
      </div>

      <!-- Profile -->
      <div class="panel-dark">
        <div class="muted">Profile</div>
        <div class="inner section-gap" id="profileBox">Loading profile…</div>
      </div>
    </div>
  </div>

  <!-- Mobile sticky actions -->
  <div class="fab-bar hidden" id="fabBar">
    <button class="btn" onclick="saveDraft()">Save</button>
    <button class="btn good" onclick="submitTimesheet()">Submit</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <!-- Payslip modal -->
  <div id="modalSlip" class="modal-backdrop" onclick="if(event.target===this) closeSlip()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="slipTitle">
      <div class="hd">
        <div id="slipTitle" style="font-weight:700">Timesheet</div>
        <button class="btn sm" onclick="closeSlip()">Close</button>
      </div>
      <div class="bd" id="slipBody">Loading…</div>
      <div class="ft"><span class="muted" id="slipFootnote"></span></div>
    </div>
  </div>

  <script>
    // ---------- small DOM helpers ----------
    const $ = s => document.querySelector(s);
    function el(tag, attrs={}, ...kids){
      const n=document.createElement(tag);
      for(const[k,v] of Object.entries(attrs)){
        if(k==='class') n.className=v;
        else if(k==='html') n.innerHTML=v;
        else n.setAttribute(k,v);
      }
      kids.forEach(k=>n.append(k));
      return n;
    }
    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const money = n => (Number(n||0)).toLocaleString('en-GB',{style:'currency',currency:'GBP'});
    function toast(msg, ms=3500){ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); clearTimeout(t._h); t._h=setTimeout(()=>t.classList.add('hidden'),ms); }

    // ---------- state ----------
    let STATE = {
      contractor:null,
      assignment:null,
      week_ending:null,
      status:'draft',
      rates:{ std:0, ot:0 },
      entries: Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}])),
      dirty:false
    };

    const DEADLINE_DEFAULT = {
      note: 'Tuesday 12:00 (UK time)',
      tz: 'Europe/London',
    };

    async function hydrateDeadline(){
      const chip = document.getElementById('deadlineTag');
      const emphasis = document.getElementById('deadlineEmphasis');
      const blurb = document.getElementById('deadlineBlurb');
      try{
        const res = await fetch('/.netlify/functions/public-settings', { cache: 'no-store' });
        const data = res.ok ? await res.json() : null;
        const settings = data?.settings || {};
        const note = (settings.deadlineNote || DEADLINE_DEFAULT.note).trim();
        const tz = (settings.deadlineTimezone || DEADLINE_DEFAULT.tz).trim();
        const label = tz && !note.toLowerCase().includes(tz.toLowerCase()) ? `${note} (${tz})` : note;
        if (chip) chip.textContent = `Deadline: ${label}`;
        if (emphasis) emphasis.textContent = label;
        if (blurb) {
          const prefix = 'Submit your hours by ';
          const suffix = ' for Friday payment.';
          blurb.innerHTML = `${prefix}<b id="deadlineEmphasis">${label}</b>${suffix}`;
        }
      }catch(err){
        console.warn('timesheet deadline settings unavailable', err);
        if (chip) chip.textContent = `Deadline: ${DEADLINE_DEFAULT.note}`;
        if (emphasis) emphasis.textContent = DEADLINE_DEFAULT.note;
      }
    }

    hydrateDeadline();

    // ---------- Netlify Identity load guard ----------
    function whenIdentityReady(cb){
      if (window.netlifyIdentity){ cb(window.netlifyIdentity); return; }
      let tries = 0;
      const t = setInterval(()=>{
        if (window.netlifyIdentity){ clearInterval(t); cb(window.netlifyIdentity); }
        else if (++tries > 200){ clearInterval(t); console.error('Netlify Identity failed to load'); }
      }, 25);
    }

    // ---------- robust API fetch ----------
    async function api(path, method='GET', body=null){
      const id = window.netlifyIdentity?.currentUser();
      if(!id) throw new Error('identity_required');
      const token = await id.jwt();
      const res = await fetch(`/.netlify/functions${path}`,{
        method,
        headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
        body: body?JSON.stringify(body):null
      });
      const raw = await res.text();
      if(!res.ok){
        let msg = raw; try{ const j=JSON.parse(raw); msg=j.error||j.message||raw; }catch{}
        throw new Error(msg || `HTTP ${res.status}`);
      }
      try{ return JSON.parse(raw); } catch{ throw new Error('bad_json_response'); }
    }

    // ---------- renderers ----------
    function renderRows(){
      const tb = $('#tbody'); tb.innerHTML='';

      DAYS.forEach(d=>{
        const r = STATE.entries[d] || {std:0,ot:0,note:''};
        const tr = el('tr',{},
          el('td',{}, d),
          el('td',{}, el('input',{type:'number', step:'0.25', min:'0', max:'24', value:r.std, 'data-day':d, 'data-kind':'std', 'aria-label':`${d} standard hours`})),
          el('td',{}, el('input',{type:'number', step:'0.25', min:'0', max:'24', value:r.ot,  'data-day':d, 'data-kind':'ot',  'aria-label':`${d} overtime hours`})),
          el('td',{}, el('textarea',{'data-day':d, 'data-kind':'note', 'placeholder':'Optional note…', 'aria-label':`${d} note`}, r.note))
        );
        tb.append(tr);
      });

      const locked = (STATE.status !== 'draft');
      tb.querySelectorAll('input,textarea').forEach(i=> i.disabled = locked);
      $('#sheet').classList.toggle('locked', locked);
      $('#btnReqEdit').classList.toggle('hidden', !locked);
      $('#btnReqDelete').classList.toggle('hidden', !locked);
      $('#fabBar').classList.toggle('hidden', locked); // mobile actions hidden if locked
    }

    function totals(){
      const s = Object.values(STATE.entries).reduce((a,r)=>({ std:a.std+Number(r.std||0), ot:a.ot+Number(r.ot||0) }),{std:0,ot:0});
      const gross = (s.std*STATE.rates.std)+(s.ot*STATE.rates.ot);
      $('#kStd').textContent=`Std ${s.std}h`; $('#kOT').textContent=`OT ${s.ot}h`;
      $('#kTotal').textContent=`Total ${s.std+s.ot}h`; $('#kGross').textContent=`Est. gross ${money(gross)}`;
    }

    function renderProfile(){
      const b = $('#profileBox');
      if(!STATE.contractor){ b.textContent='Profile unavailable'; return; }
      const c = STATE.contractor, a = STATE.assignment || {};
      b.innerHTML = `
        <div><b>${c.name||''}</b><div class="muted">${c.email||''}</div></div>
        <hr style="border:none;border-top:1px solid var(--cardBorder);margin:10px 0">
        <div><b>Client</b><br>${a.client_name||'—'}</div>
        <div style="margin-top:6px"><b>Project</b><br>${a.project_name||'—'}</div>
        <div style="margin-top:6px"><b>Site</b><br>${a.site_name||'—'}</div>
        <div class="muted" style="margin-top:8px">Rate: £${Number(a.rate_std||0)} /h (OT £${Number(a.rate_ot||0)})</div>
      `;
      const al = $('#assnLine');
      if (a.client_name || a.project_name || a.site_name){
        al.classList.remove('hidden');
        al.textContent = `Assignment: ${[a.client_name,a.project_name,a.site_name].filter(Boolean).join(' • ')}`;
      }
    }

    // ---------- loaders ----------
    async function loadWeek(){
      const res = await api('/timesheets-get-this-week');
      STATE.contractor = res.contractor || null;
      STATE.assignment = res.assignment || null;
      STATE.week_ending = res.week_ending;
      STATE.status = res.status || 'draft';
      STATE.rates = { std:Number(res?.assignment?.rate_std||0), ot:Number(res?.assignment?.rate_ot||0) };
      STATE.entries = res.entries || STATE.entries;

      $('#weekTitle').textContent = `This Week — ending ${STATE.week_ending}`;
      $('#statusHelp').textContent = `Status: ${STATE.status}`;
      renderRows(); totals(); renderProfile();

      // restore any autosaved draft for this week (only when draft)
      if(STATE.status==='draft'){
        const saved = localStorage.getItem(`ts:${STATE.week_ending}`);
        if(saved){
          try{
            const parsed = JSON.parse(saved);
            if(parsed && parsed.entries){ STATE.entries = parsed.entries; renderRows(); totals(); toast('Restored autosaved draft'); }
          }catch{}
        }
      }
    }

    async function loadHistory(){
      try{
        const res = await api('/timesheets-history');
        const body = $('#histBody');
        if(!res || !res.items || !res.items.length){ body.textContent='—'; return; }

        body.innerHTML = res.items.map(i=>{
        const btn = `<button class="btn sm" onclick="openSlipFromList('${i.week_ending}')">View</button>`;
        return `
            <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--cardBorder);border-radius:10px;margin:6px 0;background:#fff">
            <div>
                <b>Week ending:</b> ${i.week_ending}
                <span class="chip" style="margin-left:8px">${i.status}</span>
                <span class="muted" style="margin-left:8px">Std ${i.std||0}h • OT ${i.ot||0}h</span>
            </div>
            ${btn}
            </div>
        `;
        }).join('');

      }catch(e){ console.warn('history load',e); }
    }

    // ---------- input bindings / UX ----------
    function bindInputs(){
      $('#tbody').addEventListener('input', ev=>{
        const t = ev.target; if(!t.dataset.day) return;
        const day = t.dataset.day, kind = t.dataset.kind;
        const cur = STATE.entries[day] || {std:0,ot:0,note:''};

        if(kind==='note'){
          cur.note = t.value;
        } else {
          let v = t.value===''?0:Number(t.value);
          if (!Number.isFinite(v)) v = 0;
          v = Math.max(0, Math.min(24, Math.round(v*4)/4)); // clamp + snap to .25
          t.value = v;
          cur[kind] = v;
        }
        STATE.entries[day] = cur;
        STATE.dirty = true;
        totals();
        // autosave light
        try{ localStorage.setItem(`ts:${STATE.week_ending}`, JSON.stringify({ entries: STATE.entries })); }catch{}
      });

      // Keyboard trick: Tab copies previous row's values into the focused input's row
      $('#tbody').addEventListener('keydown', ev=>{
        if(ev.key === 'Tab' && !ev.shiftKey){
          const t = ev.target; if(!t.dataset.day) return;
          const idx = DAYS.indexOf(t.dataset.day);
          if(idx>0){
            const prev = STATE.entries[DAYS[idx-1]];
            const cur = STATE.entries[DAYS[idx]];
            cur.std = Number(prev.std||0); cur.ot = Number(prev.ot||0); cur.note = prev.note || '';
            renderRows(); totals();
          }
        }
      });

      // warn if nav away with unsaved draft edits
      window.addEventListener('beforeunload', (e)=>{
        if(STATE.status==='draft' && STATE.dirty){
          e.preventDefault(); e.returnValue = '';
        }
      }, {capture:true});
    }

    // quick fills
    function quickFill(kind){
      if(kind==='8x5'){
        ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ STATE.entries[d].std=8; STATE.entries[d].ot=0; });
        ['Sun','Sat'].forEach(d=>{ STATE.entries[d].std=0; STATE.entries[d].ot=0; STATE.entries[d].note=''; });
        STATE.dirty = true; renderRows(); totals();
      }
    }
    function clearAll(){ DAYS.forEach(d=> STATE.entries[d]={std:0,ot:0,note:''}); STATE.dirty = true; renderRows(); totals(); }
    function resetWeek(){ clearAll(); toast('Week reset'); }
    function setAll(which){
      const v = prompt(`Set ALL ${which==='std'?'standard':'overtime'} hours to:`, '8'); if(v===null) return;
      let n = Number(v); if(!Number.isFinite(n)) n=0; n=Math.max(0, Math.min(24, Math.round(n*4)/4));
      DAYS.forEach(d=> STATE.entries[d][which]=n); STATE.dirty = true; renderRows(); totals();
    }

    // actions
    async function saveDraft(){
      try{
        await api('/timesheets-save','POST',{ week_ending: STATE.week_ending, status:'draft', entries: STATE.entries });
        STATE.dirty = false;
        toast('Draft saved');
      }catch(e){ toast(`Save failed: ${e.message}`); }
    }
    async function submitTimesheet(){
      const sum = Object.values(STATE.entries).reduce((s,r)=>s+Number(r.std||0)+Number(r.ot||0),0);
      if (sum===0 && !confirm('You are about to submit 0 total hours. Continue?')) return;
      try{
        await api('/timesheets-submit','POST',{ week_ending: STATE.week_ending });
        try{ localStorage.removeItem(`ts:${STATE.week_ending}`);}catch{}
        toast('Submitted for approval');
        await loadWeek(); await loadHistory();
      }catch(e){ toast(`Submit failed: ${e.message}`); }
    }

    // email helpers
    function openMail(subject, body){
      const mail = `mailto:billing@hmj-global.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mail;
    }
    function raiseIssue(){
      const note = prompt('Describe the issue (data looks wrong, missing assignment, etc.)','');
      if (note===null) return;
      const id = STATE.week_ending || '';
      openMail(`Timesheet ISSUE — ${id}`, `Contractor: ${STATE?.contractor?.email}\nWeek ending: ${id}\nStatus: ${STATE.status}\nNote: ${note||'-'}`);
    }
    function requestEdit(){
      const reason = prompt('Brief reason for edit request:','');
      if (reason===null) return;
      const id = STATE.week_ending || '';
      openMail(`Timesheet EDIT request — ${id}`, `Contractor: ${STATE?.contractor?.email}\nWeek ending: ${id}\nStatus: ${STATE.status}\nReason: ${reason||'-'}`);
    }
    function requestDelete(){
      const reason = prompt('Confirm why this timesheet should be deleted:','');
      if(reason===null) return;
      const id = STATE.week_ending || '';
      openMail(`Timesheet DELETE request — ${id}`, `Contractor: ${STATE?.contractor?.email}\nWeek ending: ${id}\nStatus: ${STATE.status}\nReason: ${reason||'-'}`);
    }

    function toggleHistory(){ const b=$('#histBody'), btn=$('#btnHistToggle'); const hide=!b.classList.contains('hidden'); b.classList.toggle('hidden',hide); btn.textContent = hide?'Expand':'Collapse'; }

    async function openSlipFromList(week) {
        // Open modal immediately with a light skeleton
        $('#slipTitle').textContent = `Timesheet — week ending ${week}`;
        $('#slipBody').innerHTML = `<div class="muted">Loading details…</div>`;
        $('#slipFootnote').textContent = '';
        $('#modalSlip').classList.add('show');

        try{
            const id = window.netlifyIdentity?.currentUser();
            if(!id) throw new Error('identity_required');
            const token = await id.jwt();

            const res = await fetch(`/.netlify/functions/timesheets-history?week_ending=${encodeURIComponent(week)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
            });
            const raw = await res.text();
            if(!res.ok) throw new Error(raw);
            const data = JSON.parse(raw);

            if(!data?.detail) throw new Error('detail_unavailable');

            const d = data.detail;
            const a = d.assignment || {};
            const rows = (d.entries || []).map(r=>`
            <tr>
                <td>${r.day}</td>
                <td style="text-align:right">${Number(r.hours_std||0)}</td>
                <td style="text-align:right">${Number(r.hours_ot||0)}</td>
                <td>${(r.note||'').replace(/</g,'&lt;')}</td>
            </tr>
            `).join('');

            $('#slipBody').innerHTML = `
            <div class="muted" style="margin-bottom:10px">
                ${a.client_name||'Client —'} • ${a.project_name||'Project —'} • ${a.site_name||'Site —'}
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div class="card" style="padding:10px">
                <div><b>Standard hours</b></div>
                <div style="font-size:20px">${d.totals?.std||0} h</div>
                <div class="muted">Rate: ${(d.rates?.std!=null)?(Number(d.rates.std)).toLocaleString('en-GB',{style:'currency',currency:'GBP'}):'£0.00'}/h</div>
                </div>
                <div class="card" style="padding:10px">
                <div><b>Overtime hours</b></div>
                <div style="font-size:20px">${d.totals?.ot||0} h</div>
                <div class="muted">Rate: ${(d.rates?.ot!=null)?(Number(d.rates.ot)).toLocaleString('en-GB',{style:'currency',currency:'GBP'}):'£0.00'}/h</div>
                </div>
            </div>

            <div class="card" style="padding:12px;margin-top:10px">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
                <div><b>Status</b> <span class="chip" style="margin-left:6px">${d.status||'-'}</span></div>
                <div><b>Estimated gross</b> <span class="chip" style="margin-left:6px">${(Number(d.totals?.gross||0)).toLocaleString('en-GB',{style:'currency',currency:'GBP'})}</span></div>
                </div>
            </div>

            <h4 style="margin:14px 0 6px">Per-day breakdown</h4>
            <table style="width:100%; border-collapse:separate; border-spacing:0 6px">
                <thead>
                <tr>
                    <th style="text-align:left">Day</th>
                    <th style="text-align:right">Std (h)</th>
                    <th style="text-align:right">OT (h)</th>
                    <th style="text-align:left">Note</th>
                </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            `;

            $('#slipFootnote').textContent = `Generated for ${window.netlifyIdentity?.currentUser()?.email || ''}`;
        }catch(err){
            console.error('slip detail error:', err);
            $('#slipBody').innerHTML = `<div class="muted">Could not load this timesheet’s details.</div>`;
        }
        }

        function closeSlip(){ $('#modalSlip').classList.remove('show'); }

    // ---------- boot wiring ----------
    let BOOTED = false;
    function showGate(){ $('#gate').classList.remove('hidden'); $('#app').classList.add('hidden'); }
    function showApp(){  $('#gate').classList.add('hidden');  $('#app').classList.remove('hidden'); }

    async function boot(){
      try{
        await window.netlifyIdentity?.currentUser()?.jwt();
        await loadWeek();
        await loadHistory();
        bindInputs();
      }catch(e){
        const m = e.message || String(e);
        if (m === 'identity_required'){
          showGate();
        } else {
          toast(`Could not load timesheet: ${m}`);
        }
        console.error(e);
      }
    }
    function bootOnce(){ if(BOOTED) return; BOOTED=true; boot().catch(e=>{ BOOTED=false; console.error(e); toast(`Could not load timesheet: ${e.message||e}`); }); }

    whenIdentityReady((ni)=>{
      $('#btnSignOut').onclick = () => ni.logout();
      ni.on('init', (user) => { if (user){ showApp(); bootOnce(); } else { showGate(); } });
      ni.on('login', () => { showApp(); bootOnce(); });
      ni.on('logout', () => { BOOTED=false; showGate(); });
      ni.init();
    });
  </script>
</body>
</html>
