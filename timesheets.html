<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets | HMJ-Global</title>
<link rel="stylesheet" href="/css/style.css"/>
<style>
:root{
  --ink:#0c1118; --ink-muted:#4b5a70; --bg:#0b1420; --panel:#0f1c2b;
  --panel-2:#101b30; --border:#203042; --purple:#8b7dff; --green:#25c08a; --red:#ff7a7a; --amber:#ffd166;
  --white:#fff;
}
html,body{margin:0;background:linear-gradient(180deg,#0b1420,#0d1830);color:#e6edf6;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:#9fb7ff;text-decoration:none}
.wrap{max-width:1100px;margin:30px auto;padding:0 16px;display:grid;grid-template-columns:1fr 340px;gap:16px}
@media (max-width:1000px){ .wrap{grid-template-columns:1fr} }
.topbar{position:sticky;top:0;z-index:50;background:rgba(11,20,32,.85);border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(6px)}
.toprow{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
.brand{font-weight:800}
.spacer{flex:1}
.btn{background:#1a2740;border:1px solid #2b3c55;color:#fff;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent}
.btn.primary{background:var(--purple);border-color:transparent}
.btn.success{background:var(--green);border-color:transparent}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
.muted{color:#9fb3c8}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.hr{height:1px;background:var(--border);margin:10px 0}

/* white cards */
.day-card{display:flex;align-items:center;gap:12px;background:#fff;color:var(--ink);
  border:1px solid #d7dbe3;border-radius:14px;padding:12px;margin-bottom:10px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
.day-badge{min-width:64px;text-align:center;background:#eef2f8;border:1px solid #d7dbe3;border-radius:10px;padding:10px 6px;font-weight:800;line-height:1;color:#162033}
.day-badge .dn{display:block;font-size:.76rem;letter-spacing:.6px}
.day-fields{flex:1;display:grid;grid-template-columns:160px 160px 1fr 90px;gap:10px}
.day-fields input[type="number"], .day-fields input[type="text"]{
  width:100%;background:#fff;color:#0b1420;border:2px solid #c9cfda;border-radius:10px;padding:12px 10px;font-size:1rem}
.day-tools{display:flex;gap:6px;align-items:center}
.pill{font-size:.9rem;padding:8px 10px;border-radius:10px;background:#eef2f8;border:1px solid #d7dbe3;color:#162033;cursor:pointer}
.pill.icon{width:36px;height:36px;display:inline-grid;place-items:center}

/* totals */
#totals{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
#totals .box{background:#0d1930;border:1px solid #22324a;border-radius:12px;padding:10px 12px}
#totals b{color:#fff}

/* prev weeks */
#history .rowi{padding:10px;border-bottom:1px solid var(--border)}
#history .rowi:last-child{border-bottom:none}
#history.collapsed .rowi:nth-child(n+4){display:none}

/* toasts */
#toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:9999}
.toast{background:#0f172a;border:1px solid #233044;color:#e6edf6;border-radius:12px;padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.toast.err{border-color:#5b2b2b}

/* mobile */
@media (max-width:720px){
  .day-fields{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
  .day-fields input[name$="_note"]{grid-column:1/-1}
  .btn{padding:12px 14px}
}
</style>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<div class="topbar">
  <div class="toprow">
    <div class="brand">HMJ Global — Timesheets</div>
    <span class="spacer"></span>
    <span id="deadlineTag" class="pill" style="background:#2b2242;color:#dbcfff;border-color:#3c2f66">Deadline: Tue 17:00</span>
    <a href="/" class="btn ghost">⟵ Return to Homepage</a>
    <button id="btnSignOut" class="btn">Sign out</button>
  </div>
</div>

<div class="wrap">
  <div>
    <div class="card">
      <h1 style="margin:0 0 6px">My Timesheet</h1>
      <div class="muted">Submit your hours by <b>Tuesday 17:00</b> for Friday payment. <span id="deadlineClock"></span></div>
    </div>

    <div id="gate" class="card" style="display:none">
      <p>Please log in to access your timesheets.</p>
      <button class="btn primary" onclick="netlifyIdentity?.open('login')">Log in</button>
    </div>

    <div id="app" style="display:none">
      <div id="summary" class="card">Loading…</div>

      <div class="card" id="weekCard">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2 style="margin:0 0 8px">This Week</h2>
            <div id="weekMeta" class="muted" style="margin-bottom:8px"></div>
          </div>
          <div id="totals">
            <div class="box"><span class="muted">Std</span> <b id="tStd">0</b>h</div>
            <div class="box"><span class="muted">OT</span> <b id="tOt">0</b>h</div>
            <div class="box"><span class="muted">Total</span> <b id="tAll">0</b>h</div>
            <div class="box"><span class="muted">Est. gross</span> £<b id="tGross">0.00</b></div>
          </div>
        </div>

        <div class="row" style="margin:12px 0 8px">
          <span class="muted">Quick fill:</span>
          <button class="pill" id="qMonFri8" type="button">Mon–Fri 8h</button>
          <button class="pill" id="qClear" type="button">Clear all</button>
          <button class="pill" id="qSetAll" type="button">Set all…</button>
          <span class="muted">Jump with <b>Tab</b> • Copy previous with <b>⌘/Ctrl + D</b></span>
        </div>

        <form id="tsForm" class="day-list" autocomplete="off">
          <div id="days"></div>
          <div class="row" style="margin-top:12px">
            <button type="button" class="btn" id="btnDraft">Save draft</button>
            <button type="submit" class="btn success" id="btnSubmit">Submit</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Previous Weeks</h3>
          <button class="pill" id="btnToggleHist" type="button">Collapse</button>
        </div>
        <div id="history" class="muted collapsed">—</div>
      </div>
    </div>
  </div>

  <div id="profilePane" class="card"><div class="muted">Loading profile…</div></div>
</div>

<div id="toast" aria-live="polite" aria-atomic="true"></div>

<script>
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const sel = s => document.querySelector(s);
const byName = (f,n)=>f.elements.namedItem(n);
const toast=(msg,type='ok',t=2600)=>{const b=document.createElement('div');b.className=`toast ${type}`;b.textContent=msg;sel('#toast').appendChild(b);setTimeout(()=>b.remove(),t);};
const fmt=(n,d=2)=> (Number(n||0)).toFixed(d);
function nextTuesday1700(){const now=new Date();const t=new Date(now);const diff=(2-t.getDay()+7)%7; t.setDate(t.getDate()+diff); t.setHours(17,0,0,0); if(t<now)t.setDate(t.getDate()+7); return t;}
function startDeadlineClock(){function tick(){const to=nextTuesday1700()-new Date(); if(to<=0){ sel('#deadlineClock').textContent=' • Deadline passed'; return;} const h=Math.floor(to/36e5), m=Math.floor((to%36e5)/6e4); sel('#deadlineClock').textContent=` • ${h}h ${m}m remaining`; } tick(); setInterval(tick,30e3);}

async function api(path, method='GET', body=null){
  const u=netlifyIdentity.currentUser(); if(!u) throw new Error('No session');
  const token=await u.jwt();
  const res=await fetch(`/.netlify/functions${path}`,{
    method, headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
    body: body?JSON.stringify(body):null
  });
  const text=await res.text();
  if(!res.ok) throw new Error(text||(`HTTP ${res.status}`));
  try{return JSON.parse(text);}catch{return text;}
}

// Rendering
function renderDays(existing, rates, editable){
  const wrap=sel('#days'); wrap.innerHTML='';
  const label={Sun:'SUN',Mon:'MON',Tue:'TUE',Wed:'WED',Thu:'THU',Fri:'FRI',Sat:'SAT'};
  DAYS.forEach((d,i)=>{
    const e=existing?.[d]||{};
    const dis = editable ? '' : 'disabled';
    const card=document.createElement('div'); card.className='day-card';
    card.innerHTML=`
      <div class="day-badge"><span class="dn">${label[d]}</span></div>
      <div class="day-fields">
        <input ${dis} aria-label="${d} standard hours" inputmode="decimal" type="number" min="0" step="0.25" name="${d}_std" placeholder="Std hrs" value="${e.std ?? ''}">
        <input ${dis} aria-label="${d} overtime hours" inputmode="decimal" type="number" min="0" step="0.25" name="${d}_ot"  placeholder="OT hrs"  value="${e.ot ?? ''}">
        <input ${dis} aria-label="${d} notes" type="text" name="${d}_note" placeholder="Notes (optional)" value="${e.note ?? ''}">
        <div class="day-tools">
          <button ${dis?'disabled':''} class="pill icon" type="button" title="Copy previous day" data-copy="${i-1}">⟲</button>
          <button ${dis?'disabled':''} class="pill icon" type="button" title="Clear row" data-clear>✕</button>
        </div>
      </div>`;
    wrap.appendChild(card);
  });

  if(!editable) return;

  wrap.addEventListener('click',(e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const card=btn.closest('.day-card'); if(!card) return;
    const idx=[...wrap.children].indexOf(card);
    const f=sel('#tsForm');
    if(btn.dataset.copy){
      const srcIdx=Number(btn.dataset.copy);
      if(srcIdx>=0){
        const src=DAYS[srcIdx], dst=DAYS[idx];
        byName(f,`${dst}_std`).value=byName(f,`${src}_std`).value;
        byName(f,`${dst}_ot`).value =byName(f,`${src}_ot`).value;
        byName(f,`${dst}_note`).value=byName(f,`${src}_note`).value;
        calcTotals(rates);
      }
    }
    if(btn.hasAttribute('data-clear')){
      const day=DAYS[idx];
      byName(f,`${day}_std`).value='';
      byName(f,`${day}_ot`).value='';
      byName(f,`${day}_note`).value='';
      calcTotals(rates);
    }
  });
}

function collect(status){
  const f=sel('#tsForm'); const entries={};
  DAYS.forEach(d=>{entries[d]={std:parseFloat(byName(f,`${d}_std`).value||0), ot:parseFloat(byName(f,`${d}_ot`).value||0), note:byName(f,`${d}_note`).value||''};});
  return { status, entries };
}

function calcTotals(rates){
  const f=sel('#tsForm'); let std=0,ot=0; DAYS.forEach(d=>{ std+=Number(byName(f,`${d}_std`).value||0); ot+=Number(byName(f,`${d}_ot`).value||0); });
  const all=std+ot; const gross=(std*(rates?.rate_std||0))+(ot*(rates?.rate_ot||0));
  sel('#tStd').textContent=fmt(std,2); sel('#tOt').textContent=fmt(ot,2); sel('#tAll').textContent=fmt(all,2); sel('#tGross').textContent=fmt(gross,2);
  sel('#weekCard').style.boxShadow = all>84 ? '0 0 0 2px rgba(255,0,0,.25) inset' : 'none';
}

// autosave
const CACHE_KEY='hmj_ts_draft';
const loadDraft=()=>{try{return JSON.parse(localStorage.getItem(CACHE_KEY)||'')||null;}catch{return null;}};
const saveDraftLocal=(p)=>{try{localStorage.setItem(CACHE_KEY,JSON.stringify(p));}catch{}};
const clearDraftLocal=()=>{try{localStorage.removeItem(CACHE_KEY);}catch{}};

// Boot
async function boot(){
  const user=netlifyIdentity?.currentUser();
  if(!user){ sel('#gate').style.display='block'; return; }
  sel('#btnSignOut').onclick=()=>netlifyIdentity?.logout();
  sel('#app').style.display='block'; startDeadlineClock();

  // Profile
  try{
    const prof = await api('/contractor-profile');
    const c=prof.contractor, a=prof.assignment;
    sel('#profilePane').innerHTML = a ? `
      <div><strong>${c.name}</strong><br><span class="muted">${c.email}</span></div>
      <div class="hr"></div>
      <div>Client<br><b>${a.client_name}</b></div><div class="hr"></div>
      <div>Project<br><b>${a.project_name}</b></div><div class="hr"></div>
      <div>Site<br><b>${a.site_name||'—'}</b></div><div class="hr"></div>
      <div>Rate<br><b>£${a.rate_std}/h ${a.rate_ot?`(OT £${a.rate_ot}/h)`:''}</b></div>
    ` : `<div><strong>${c.name}</strong><br><span class="muted">${c.email}</span></div>
         <div class="hr"></div><div class="muted">No active assignment — contact HMJ.</div>`;
  }catch(e){ sel('#profilePane').innerHTML='<div class="muted">Profile unavailable</div>'; }

  // Week data
  let data;
  try{
    data=await api('/timesheets-get-this-week');
  }catch(e){
    toast('Failed to load timesheet: '+e.message,'err',6000);
    sel('#summary').textContent='Could not load timesheet.';
    return;
  }

  // Summary
  if (!data.assignment || !data.contractor){
    sel('#summary').innerHTML = `<b>${data.contractor?.name || 'Your profile'}</b><br><span class="muted">No active assignment found. You can view previous weeks below.</span>`;
    sel('#weekMeta').textContent = '—';
    renderDays({}, null, false);
    sel('#btnDraft').disabled = true; sel('#btnSubmit').disabled = true;
    return;
  }

  sel('#summary').innerHTML =
   `<strong>${data.contractor.name}</strong> — ${data.assignment.project_name} @ ${data.assignment.client_name}
    <br><span class="muted">Rate: £${data.assignment.rate_std}/h ${data.assignment.rate_ot?`(OT £${data.assignment.rate_ot}/h)`:''}</span>`;

  sel('#weekMeta').textContent = `Week ending ${data.week_ending} • Status: ${data.status}`;

  // Merge draft if same week
  const draft=loadDraft(); const sameWeek=draft && draft.week_ending===data.week_ending;
  const mergedEntries = sameWeek ? Object.assign({}, data.entries, draft.entries||{}) : data.entries;

  const editable = data.status === 'draft';
  renderDays(mergedEntries, data.assignment, editable);
  calcTotals(data.assignment);

  // live calc + autosave (only in draft)
  if (editable){
    sel('#tsForm').addEventListener('input', ()=>{
      calcTotals(data.assignment);
      saveDraftLocal({ week_ending:data.week_ending, entries:collect('draft').entries });
      window.onbeforeunload = ()=>'You have unsaved changes.';
    });

    // quick fill
    sel('#qMonFri8').onclick=()=>{
      const f=sel('#tsForm');
      ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ byName(f,`${d}_std`).value='8'; byName(f,`${d}_ot`).value='0'; });
      calcTotals(data.assignment);
    };
    sel('#qClear').onclick=()=>{
      const f=sel('#tsForm'); DAYS.forEach(d=>{ byName(f,`${d}_std`).value=''; byName(f,`${d}_ot`).value=''; byName(f,`${d}_note`).value=''; });
      calcTotals(data.assignment);
    };
    sel('#qSetAll').onclick=()=>{
      const h = prompt('Set standard hours for all days (e.g. 8, 7.5, 0):','8');
      if (h==null) return; const f=sel('#tsForm'); DAYS.forEach(d=>{ byName(f,`${d}_std`).value=h; }); calcTotals(data.assignment);
    };

    // copy previous day shortcut
    document.addEventListener('keydown',(e)=>{
      if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='d'){
        e.preventDefault();
        const active=document.activeElement; const name=active?.name||''; const m=name.match(/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)_(std|ot|note)$/);
        if(!m) return; const day=m[1], idx=DAYS.indexOf(day); if(idx<=0) return; const prev=DAYS[idx-1], f=sel('#tsForm');
        byName(f,`${day}_std`).value=byName(f,`${prev}_std`).value;
        byName(f,`${day}_ot`).value =byName(f,`${prev}_ot`).value;
        byName(f,`${day}_note`).value=byName(f,`${prev}_note`).value;
        calcTotals(data.assignment);
      }
    });

    // buttons
    sel('#btnDraft').onclick=async ()=>{
      try{ const payload=collect('draft'); await api('/timesheets-save','POST',payload); clearDraftLocal(); window.onbeforeunload=null; toast('Draft saved'); }
      catch(e){ toast('Save failed: '+e.message,'err',5000); }
    };
    sel('#tsForm').onsubmit=async (e)=>{
      e.preventDefault();
      try{ const payload=collect('submitted'); await api('/timesheets-submit','POST',payload); clearDraftLocal(); window.onbeforeunload=null; toast('Submitted — thank you!', 'ok', 3000); setTimeout(()=>location.reload(), 700);}
      catch(e){ toast('Submit failed: '+e.message,'err',6000); }
    };
  }else{
    // lock UI
    sel('#btnDraft').disabled=true; sel('#btnSubmit').disabled=true;
    sel('#qMonFri8').disabled=true; sel('#qClear').disabled=true; sel('#qSetAll').disabled=true;
  }

  // History
  try{
    const hist = await api('/timesheets-history');
    if (!hist.length){ sel('#history').textContent='No previous weeks.'; }
    else{
      const box = sel('#history'); box.classList.add('collapsed');
      box.innerHTML = hist.map(h=>`<div class="rowi">${h.week_ending} — ${h.project_name} — ${h.total_hours}h — ${h.status}</div>`).join('');
      sel('#btnToggleHist').onclick=()=>{
        box.classList.toggle('collapsed');
        sel('#btnToggleHist').textContent = box.classList.contains('collapsed') ? 'Expand' : 'Collapse';
      };
    }
  }catch{ sel('#history').textContent='History unavailable.'; }
}

document.addEventListener('DOMContentLoaded', ()=>{
  netlifyIdentity?.on('init', ()=>{ netlifyIdentity.currentUser() ? boot() : sel('#gate').style.display='block'; });
  netlifyIdentity?.on('login', ()=>location.reload());
  netlifyIdentity?.on('logout', ()=>location.href='/');
  setTimeout(()=>{ if(netlifyIdentity?.currentUser()) boot(); else sel('#gate').style.display='block'; }, 600);
});

<style>
:root{
  --bg:#121725;            /* dark shell */
  --panel:#1b2236;         /* darker frame */
  --surface:#f3f6fb;       /* light neutral */
  --card:#ffffff;          /* white content cards */
  --ink:#0e1526;           /* primary text */
  --muted:#5b6b82;
  --accent:#3A66B3;
  --cardBorder:rgba(26,26,46,.12);
  --chip:#eef3ff; --chipBorder:rgba(58,102,179,.28);
}
body{ background:linear-gradient(180deg,var(--bg),#0f1422 40%) fixed; }

.hmj-card,.panel,.timesheet-card{
  background:var(--card); color:var(--ink);
  border:1px solid var(--cardBorder);
  box-shadow:0 6px 24px rgba(4,10,20,.08);
}
.section-title,.panel h2,.panel h3{ color:var(--ink); }
.text-muted{ color:var(--muted); }

.profile-panel{ background:var(--panel); padding:10px; border-radius:16px; }
.profile-panel .inner{ background:var(--card); border-radius:12px; padding:12px; }

.notice{ background:var(--surface); color:var(--ink); border:1px solid var(--cardBorder); }

input,select,textarea{
  background:#fff; color:var(--ink);
  border:1px solid var(--cardBorder);
}
input:focus,select:focus,textarea:focus{
  outline:2px solid rgba(58,102,179,.25); border-color:var(--accent);
}

.btn-primary{ background:var(--accent); color:#fff; }
.btn-ghost{ background:var(--surface); color:var(--ink); border:1px solid var(--cardBorder); }
</style>

</script>
</body>
</html>
