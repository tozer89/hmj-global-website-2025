<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Timesheets | HMJ-Global</title>

  <!-- Load Identity BEFORE our script (no defer) so window.netlifyIdentity exists -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- ===== 50/50 themed styles (white work area on dark chrome) ===== -->
  <style>
    :root{
      --bg:#121725; --panel:#1b2236; --surface:#f3f6fb;
      --card:#ffffff; --ink:#0e1526; --muted:#5b6b82;
      --accent:#3A66B3; --accent-2:#7aa0e6;
      --good:#22a06b; --warn:#e6a100; --bad:#d14b4b;
      --cardBorder:rgba(26,26,46,.12);
      --chip:#eef3ff; --chipBorder:rgba(58,102,179,.28);
      --radius:14px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#0f1422 45%) fixed;
      color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    .topbar{ padding:18px 16px; background:transparent; }
    .toprow{ max-width:1080px; margin:0 auto; display:flex; gap:12px; align-items:center; }
    .brand{ color:#d9e2ff; font-weight:700; letter-spacing:.2px }
    .spacer{ flex:1 }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:10px; border:1px solid var(--cardBorder);
      background:#fff; color:var(--ink); cursor:pointer; text-decoration:none; font-weight:600
    }
    .btn:hover{ filter:brightness(.98) }
    .btn.primary{ background:var(--accent); color:#fff; border-color:rgba(0,0,0,.0) }
    .btn.ghost{ background:var(--surface) }
    .btn.good{ background:var(--good); color:#fff; border:0 }
    .btn.warn{ background:var(--warn); color:#1a1600; border:0 }
    .btn.bad{ background:var(--bad); color:#fff; border:0 }
    .btn.sm{ padding:7px 10px; font-weight:600 }

    .wrap{ max-width:1080px; margin:0 auto 64px; padding:0 16px; }
    .grid{ display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--cardBorder);
      box-shadow:0 8px 26px rgba(4,10,20,.08);
      border-radius:var(--radius);
      padding:16px;
    }
    .panel-dark{
      background:var(--panel);
      color:#d3dbf4;
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      padding:10px;
    }
    .panel-dark .inner{ background:var(--card); color:var(--ink); border-radius:12px; padding:12px; }

    .muted{ color:var(--muted) }
    .kpis{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ background:var(--chip); border:1px solid var(--chipBorder); color:#223259; padding:6px 10px; border-radius:999px; font-weight:700 }

    .bubble{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:18px;
      box-shadow:0 10px 34px rgba(4,10,20,.10);
      padding:14px;
    }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    th{ text-align:left; font-size:12px; color:var(--muted); font-weight:700; padding:0 10px 6px }
    td{ background:#fff; border:1px solid var(--cardBorder); padding:8px 10px; vertical-align:middle; }
    td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px; }
    td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px; }
    input[type="number"], textarea{
      width:100%; border:1px solid var(--cardBorder); border-radius:8px; padding:8px 10px; font:inherit; color:var(--ink);
      background:#fff;
    }
    textarea{ resize:vertical; min-height:40px }
    input:focus, textarea:focus{ outline:2px solid rgba(58,102,179,.25); border-color:var(--accent) }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .help{ font-size:12px; color:var(--muted) }
    .hidden{ display:none !important }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:14px; max-width:90vw;
      background:#0c1224; color:#fff; border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px; z-index:9999; box-shadow:0 12px 28px rgba(0,0,0,.35);
      font-weight:600
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="toprow">
      <div class="brand">HMJ Global — Timesheets</div>
      <span class="spacer"></span>
      <a class="btn ghost sm" href="/">← Return to Homepage</a>
      <button id="btnSignOut" class="btn sm">Sign out</button>
    </div>
  </div>

  <div class="wrap">

    <div id="gate" class="card hidden">
      <p>Please log in to access your timesheets.</p>
      <button class="btn primary" onclick="window.netlifyIdentity && window.netlifyIdentity.open('login')">Log in</button>
    </div>

    <div id="app" class="grid hidden">
      <div>
        <div class="card" id="summary">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <h2 style="margin:0">My Timesheet</h2>
              <div class="muted">Submit your hours by <b>Tuesday 17:00</b> for Friday payment. <span id="deadlineTag" class="chip" style="margin-left:6px">Deadline: Tue 17:00</span></div>
            </div>
            <div class="kpis">
              <span class="chip" id="kStd">Std 0h</span>
              <span class="chip" id="kOT">OT 0h</span>
              <span class="chip" id="kTotal">Total 0h</span>
              <span class="chip" id="kGross">Est. gross £0.00</span>
            </div>
          </div>
        </div>

        <div class="bubble" id="sheet">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="margin:4px 0" id="weekTitle">This Week</h3>
            <div style="display:flex;gap:8px">
              <button class="btn ghost sm" onclick="quickFill('8x5')">Mon–Fri 8h</button>
              <button class="btn ghost sm" onclick="clearAll()">Clear all</button>
              <button class="btn ghost sm" onclick="setAll('std')">Set all…</button>
            </div>
          </div>

          <table>
            <thead><tr><th>Day</th><th style="width:120px">Std (h)</th><th style="width:120px">OT (h)</th><th>Note</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>

          <div class="row-actions" style="margin-top:8px">
            <span class="help" id="statusHelp"></span>
            <span style="flex:1"></span>
            <button class="btn" onclick="saveDraft()">Save draft</button>
            <button class="btn good" onclick="submitTimesheet()">Submit</button>
            <button class="btn warn hidden" id="btnReqEdit" onclick="requestEdit()">Request edit</button>
            <button class="btn bad hidden" id="btnReqDelete" onclick="requestDelete()">Request delete</button>
          </div>
        </div>

        <div class="card" id="history" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Previous Weeks</h3>
            <button class="btn ghost sm" onclick="toggleHistory()" id="btnHistToggle">Collapse</button>
          </div>
          <div id="histBody" class="muted" style="margin-top:8px">—</div>
        </div>
      </div>

      <div class="panel-dark">
        <div class="muted">Profile</div>
        <div class="inner" id="profileBox">
          Loading profile…
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    // ---------- Identity readiness helper ----------
    function whenIdentityReady(cb){
      if (window.netlifyIdentity){ cb(window.netlifyIdentity); return; }
      let tries = 0;
      const t = setInterval(()=>{
        if (window.netlifyIdentity){ clearInterval(t); cb(window.netlifyIdentity); }
        else if (++tries > 200){ clearInterval(t); console.error('Netlify Identity failed to load'); }
      }, 25);
    }

    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let STATE = {
      contractor:null,
      assignment:null,
      week_ending:null,
      status:'draft',
      rates:{ std:0, ot:0 },
      entries: Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}]))
    };

    const $ = s => document.querySelector(s);
    const el = (tag, attrs={}, ...kids)=>{ const n=document.createElement(tag); for(const[k,v]of Object.entries(attrs)){ if(k==='class')n.className=v; else if(k==='html')n.innerHTML=v; else n.setAttribute(k,v);} kids.forEach(k=>n.append(k)); return n; };
    const money = n => (Number(n||0)).toLocaleString('en-GB',{style:'currency',currency:'GBP'});
    function toast(msg, ms=3500){ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); clearTimeout(t._h); t._h=setTimeout(()=>t.classList.add('hidden'),ms); }

    // Hardened API (only parse JSON when safe)
    async function api(path, method='GET', body=null){
      const id = window.netlifyIdentity?.currentUser();
      if(!id) throw new Error('identity_required');
      const token = await id.jwt();

      const res = await fetch(`/.netlify/functions${path}`,{
        method,
        headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` },
        body: body?JSON.stringify(body):null
      });

      const raw = await res.text();
      if(!res.ok){
        let msg = raw; try{ const j=JSON.parse(raw); msg=j.error||j.message||raw; }catch{}
        throw new Error(msg || `HTTP ${res.status}`);
      }
      try{ return JSON.parse(raw); } catch{ throw new Error('bad_json_response'); }
    }

    // ---------- Renderers ----------
    function renderRows(){
      const tb = $('#tbody'); tb.innerHTML='';
      DAYS.forEach(d=>{
        const r = STATE.entries[d] || {std:0,ot:0,note:''};
        const tr = el('tr',{},
          el('td',{}, d),
          el('td',{}, el('input',{type:'number', step:'0.25', min:'0', value:r.std, 'data-day':d, 'data-kind':'std'})),
          el('td',{}, el('input',{type:'number', step:'0.25', min:'0', value:r.ot,  'data-day':d, 'data-kind':'ot'})),
          el('td',{}, el('textarea',{'data-day':d, 'data-kind':'note'}, r.note))
        );
        tb.append(tr);
      });
      const locked = (STATE.status !== 'draft');
      tb.querySelectorAll('input,textarea').forEach(i=> i.disabled = locked);
      $('#btnReqEdit').classList.toggle('hidden', !locked);
      $('#btnReqDelete').classList.toggle('hidden', !locked);
    }

    function totals(){
      const s = Object.values(STATE.entries).reduce((a,r)=>({ std:a.std+Number(r.std||0), ot:a.ot+Number(r.ot||0) }),{std:0,ot:0});
      const gross = (s.std*STATE.rates.std)+(s.ot*STATE.rates.ot);
      $('#kStd').textContent=`Std ${s.std}h`; $('#kOT').textContent=`OT ${s.ot}h`;
      $('#kTotal').textContent=`Total ${s.std+s.ot}h`; $('#kGross').textContent=`Est. gross ${money(gross)}`;
    }

    function renderProfile(){
      const b = $('#profileBox');
      if(!STATE.contractor){ b.textContent='Profile unavailable'; return; }
      const c = STATE.contractor, a = STATE.assignment || {};
      b.innerHTML = `
        <div><b>${c.name||''}</b><div class="muted">${c.email||''}</div></div>
        <hr style="border:none;border-top:1px solid var(--cardBorder);margin:10px 0">
        <div><b>Client</b><br>${a.client_name||'—'}</div>
        <div style="margin-top:6px"><b>Project</b><br>${a.project_name||'—'}</div>
        <div style="margin-top:6px"><b>Site</b><br>${a.site_name||'—'}</div>
        <div class="muted" style="margin-top:8px">Rate: £${Number(a.rate_std||0)} /h (OT £${Number(a.rate_ot||0)})</div>
      `;
    }

    // ---------- Loaders ----------
    async function boot(){
      try{
        await window.netlifyIdentity?.currentUser()?.jwt(); // ensure session ready
        await loadWeek();
        await loadHistory();
        bindInputs();
      }catch(e){
        const m = e.message || String(e);
        if (m === 'identity_required'){
          $('#gate').classList.remove('hidden'); $('#app').classList.add('hidden');
        } else {
          toast(`Could not load timesheet: ${m}`);
        }
        console.error(e);
      }
    }

    async function loadWeek(){
      const res = await api('/timesheets-get-this-week');
      STATE.contractor = res.contractor || null;
      STATE.assignment = res.assignment || null;
      STATE.week_ending = res.week_ending;
      STATE.status = res.status || 'draft';
      STATE.rates = { std:Number(res?.assignment?.rate_std||0), ot:Number(res?.assignment?.rate_ot||0) };
      STATE.entries = res.entries || STATE.entries;

      $('#weekTitle').textContent = `This Week — ending ${STATE.week_ending}`;
      $('#statusHelp').textContent = `Status: ${STATE.status}`;
      renderRows(); totals(); renderProfile();
    }

    async function loadHistory(){
      try{
        const res = await api('/timesheets-history');
        const body = $('#histBody');
        if(!res || !res.items || !res.items.length){ body.textContent='—'; return; }
        body.innerHTML = res.items.map(i=>`
          <div style="padding:8px 10px;border:1px solid var(--cardBorder);border-radius:10px;margin:6px 0;background:#fff">
            <b>Week ending:</b> ${i.week_ending}
            <span class="chip" style="margin-left:8px">${i.status}</span>
            <span class="muted" style="margin-left:8px">Std ${i.std||0}h • OT ${i.ot||0}h</span>
          </div>
        `).join('');
      }catch(e){ console.warn('history load',e); }
    }

    function bindInputs(){
      $('#tbody').addEventListener('input', ev=>{
        const t = ev.target; if(!t.dataset.day) return;
        const day = t.dataset.day, kind = t.dataset.kind;
        const cur = STATE.entries[day] || {std:0,ot:0,note:''};
        if(kind==='note'){ cur.note = t.value; }
        else { cur[kind] = t.value===''?0:Math.max(0, Number(t.value)); }
        STATE.entries[day] = cur; totals();
      });
    }

    function quickFill(kind){
      if(kind==='8x5'){
        ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ STATE.entries[d].std=8; STATE.entries[d].ot=0; });
        ['Sun','Sat'].forEach(d=>{ STATE.entries[d].std=0; STATE.entries[d].ot=0; STATE.entries[d].note=''; });
        renderRows(); totals();
      }
    }
    function clearAll(){ DAYS.forEach(d=> STATE.entries[d]={std:0,ot:0,note:''}); renderRows(); totals(); }
    function setAll(which){
      const v = prompt(`Set ALL ${which==='std'?'standard':'overtime'} hours to:`, '8'); if(v===null) return;
      const n = Math.max(0, Number(v)||0); DAYS.forEach(d=> STATE.entries[d][which]=n); renderRows(); totals();
    }

    async function saveDraft(){
      try{
        await api('/timesheets-save','POST',{ week_ending: STATE.week_ending, status:'draft', entries: STATE.entries });
        toast('Draft saved');
      }catch(e){ toast(`Save failed: ${e.message}`); }
    }
    async function submitTimesheet(){
      try{
        await api('/timesheets-submit','POST',{ week_ending: STATE.week_ending });
        toast('Submitted for approval'); await loadWeek(); await loadHistory();
      }catch(e){ toast(`Submit failed: ${e.message}`); }
    }

    function openMail(subject, body){
      const mail = `mailto:billing@hmj-global.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mail;
    }
    function requestEdit(){
      const reason = prompt('Brief reason for edit request:','');
      const id = STATE.week_ending || '';
      openMail(`Timesheet EDIT request — ${id}`, `Contractor: ${STATE?.contractor?.email}\nWeek ending: ${id}\nStatus: ${STATE.status}\nReason: ${reason||'-'}`);
    }
    function requestDelete(){
      const reason = prompt('Confirm why this timesheet should be deleted:','');
      if(reason===null) return;
      const id = STATE.week_ending || '';
      openMail(`Timesheet DELETE request — ${id}`, `Contractor: ${STATE?.contractor?.email}\nWeek ending: ${id}\nStatus: ${STATE.status}\nReason: ${reason||'-'}`);
    }
    function toggleHistory(){ const b=$('#histBody'), btn=$('#btnHistToggle'); const hide=!b.classList.contains('hidden'); b.classList.toggle('hidden',hide); btn.textContent = hide?'Expand':'Collapse'; }

    // Wire Identity once it’s actually available
    whenIdentityReady((ni)=>{
      $('#btnSignOut').onclick = () => ni.logout();
      ni.on('init', user => {
        if (user){ $('#gate').classList.add('hidden'); $('#app').classList.remove('hidden'); boot(); }
        else     { $('#gate').classList.remove('hidden'); $('#app').classList.add('hidden'); }
      });
      ni.on('login',  () => location.reload());
      ni.on('logout', () => location.reload());
      ni.init(); // start widget
    });
  </script>
</body>
</html>
