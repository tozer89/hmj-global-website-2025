<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timesheets | HMJ-Global</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    :root{
      --ink:#e6edf6; --muted:#9fb3c8; --bg:#0b1420; --panel:#0f1c2b; --border:#203042;
      --blue:#4c7fff; --green:#25c08a; --red:#ff7a7a; --amber:#ffd166;
      --white:#ffffff; --black:#0c1118;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--blue);text-decoration:none}
    .wrap{max-width:1100px;margin:34px auto;padding:0 16px;display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width:1000px){ .wrap{grid-template-columns:1fr} }

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(11,20,32,.9);
      border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(6px)}
    .toprow{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800}
    .spacer{flex:1}
    .btn{background:#1a2740;border:1px solid #2b3c55;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#3b5172}
    .btn.ghost{background:transparent;border-color:#2b3c55}
    .btn.primary{background:var(--blue);border-color:transparent}
    .btn.success{background:var(--green);border-color:transparent}
    .btn.warn{background:#3a2c10;border-color:#5b460f}

    /* Cards & layout */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:rgba(255,255,255,.04)}
    .tag.warn{color:var(--amber);border-color:#5b460f;background:#2a220f}
    .tag.ok{color:#4fe3a2}

    /* Profile (right column) */
    #profilePane{position:sticky;top:16px}
    #profilePane .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;margin:4px 0}
    #profilePane .kv div:first-child{color:var(--muted)}

    /* White entry cards */
    .day-card{display:flex;align-items:center;gap:12px;background:var(--white);color:var(--black);
      border:1px solid #d7dbe3;border-radius:12px;padding:10px 12px;margin-bottom:10px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
    .day-badge{min-width:56px;text-align:center;background:#eef2f8;border:1px solid #d7dbe3;border-radius:10px;padding:8px 6px;font-weight:800;line-height:1;color:#162033}
    .day-badge .dn{display:block;font-size:.72rem;letter-spacing:.6px}
    .day-fields{flex:1;display:grid;grid-template-columns:130px 130px 1fr 90px;gap:8px}
    .day-fields input[type="number"], .day-fields input[type="text"]{
      width:100%;background:#fff;color:#0b1420;border:1px solid #c9cfda;border-radius:8px;padding:8px}
    .day-tools{display:flex;gap:6px;align-items:center}
    .pill{font-size:.8rem;padding:6px 8px;border-radius:8px;background:#eef2f8;border:1px solid #d7dbe3;color:#162033;cursor:pointer}
    .pill:hover{filter:brightness(0.98)}
    .pill.icon{width:32px;height:32px;display:inline-grid;place-items:center}

    /* Totals bar */
    #totals{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    #totals .box{background:#0d1930;border:1px solid #22324a;border-radius:12px;padding:8px 12px}
    #totals b{color:#fff}

    /* Inputs outside white cards */
    input[type="number"],input[type="text"]{width:100%}
    table.grid{width:100%;border-collapse:collapse}
    table.grid th,table.grid td{border-bottom:1px solid var(--border);padding:10px;text-align:left}

    /* Toasts */
    #toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:9999}
    .toast{background:#0f172a;border:1px solid #233044;color:#e6edf6;border-radius:10px;padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .toast.ok{border-color:#245d46}
    .toast.err{border-color:#5b2b2b}

    /* Small helpers */
    .countdown{font-variant-numeric:tabular-nums}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#0b1420;border:1px solid var(--border);padding:1px 6px;border-radius:6px}

    /* Accessibility focus */
    :where(input,button,.pill,.btn):focus{outline:2px solid #7aa2ff; outline-offset:2px}

    @media (max-width:700px){
      .day-fields{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
      .day-fields input[name$="_note"]{grid-column:1/-1}
      .wrap{padding-bottom:80px}
    }
  </style>

  <!-- Netlify Identity -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <div class="toprow">
      <div class="brand">HMJ Global — Timesheets</div>
      <span class="spacer"></span>
      <span id="deadlineTag" class="tag warn">Calculating deadline…</span>
      <a href="/" class="btn ghost" title="Back to homepage">⟵ Return to Homepage</a>
      <button id="btnSignOut" class="btn">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <!-- MAIN COLUMN -->
    <div>
      <div class="card">
        <h1 style="margin:0 0 6px">My Timesheet</h1>
        <div class="muted">Submit your hours by <b>Tuesday 17:00</b> for Friday payment.
          <span id="deadlineClock" class="countdown" aria-live="polite"></span>
        </div>
      </div>

      <!-- Gate (not logged in) -->
      <div id="gate" class="card" style="display:none">
        <p>Please log in to access your timesheets.</p>
        <button class="btn primary" onclick="netlifyIdentity?.open('login')">Log in</button>
        <div class="muted" style="margin-top:8px">After login you will be redirected here automatically.</div>
      </div>

      <!-- App -->
      <div id="app" style="display:none">
        <div id="summary" class="card">Loading…</div>

        <div class="card" id="weekCard">
          <div class="row" style="justify-content:space-between;align-items:flex-end">
            <div>
              <h2 style="margin:0 0 8px">This Week</h2>
              <div id="weekMeta" class="muted" style="margin-bottom:8px"></div>
            </div>
            <div id="totals">
              <div class="box"><span class="muted">Std</span> <b id="tStd">0</b>h</div>
              <div class="box"><span class="muted">OT</span> <b id="tOt">0</b>h</div>
              <div class="box"><span class="muted">Total</span> <b id="tAll">0</b>h</div>
              <div class="box"><span class="muted">Est. gross</span> £<b id="tGross">0.00</b></div>
            </div>
          </div>

          <!-- Quick fill tools -->
          <div class="row" style="margin:10px 0 8px">
            <span class="muted">Quick fill:</span>
            <button class="pill" id="qMonFri8" type="button">Mon–Fri 8h</button>
            <button class="pill" id="qClear"   type="button">Clear all</button>
            <button class="pill" id="qSetAll"  type="button">Set all…</button>
            <span class="muted" title="Keyboard help">Jump with <span class="kbd">Tab</span> • Copy previous day with <span class="kbd">⌘/Ctrl + D</span></span>
          </div>

          <form id="tsForm" class="day-list" autocomplete="off">
            <div id="days"></div>
            <div class="row" style="margin-top:12px">
              <button type="button" class="btn" id="btnDraft">Save draft</button>
              <button type="submit" class="btn success">Submit</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px">Previous Weeks</h3>
          <div id="history" class="muted">—</div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Profile -->
    <div id="profilePane" class="card">
      <div class="muted">Loading profile…</div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ---------- helpers ----------
    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const sel = s => document.querySelector(s);
    const byName = (f, n) => f.elements.namedItem(n);

    function toast(msg, type='ok', t=2400){
      const box = document.createElement('div'); box.className = `toast ${type}`;
      box.textContent = msg; sel('#toast').appendChild(box);
      setTimeout(()=>box.remove(), t);
    }

    function fmt(n, d=2){ return (Number(n||0)).toFixed(d); }

    function nextTuesday1700(){
      const now = new Date();
      // Find this or next Tuesday 17:00
      const t = new Date(now);
      const diff = (2 - t.getDay() + 7) % 7; // 2=Tue
      t.setDate(t.getDate() + diff);
      t.setHours(17,0,0,0);
      if (t < now) t.setDate(t.getDate() + 7);
      return t;
    }

    function startDeadlineClock(){
      function tick(){
        const to = nextTuesday1700() - new Date();
        if (to <= 0){ sel('#deadlineClock').textContent = ' • Deadline passed'; return; }
        const hrs = Math.floor(to/36e5), mins = Math.floor((to%36e5)/6e4);
        sel('#deadlineClock').textContent = ` • ${hrs}h ${mins}m remaining`;
      }
      tick(); setInterval(tick, 30e3);
      sel('#deadlineTag').textContent = 'Deadline: Tue 17:00';
    }

    // ---------- API ----------
    async function api(path, method='GET', body=null){
      const u = netlifyIdentity.currentUser(); if(!u) throw new Error('No session');
      const token = await u.jwt();
      const res = await fetch(`/.netlify/functions${path}`, {
        method,
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
        body: body ? JSON.stringify(body) : null
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt||('HTTP '+res.status));
      }
      return res.json();
    }

    // ---------- Rendering ----------
    function renderDays(existing, rates){
      const wrap = document.getElementById('days'); wrap.innerHTML = '';
      const label = {Sun:'SUN',Mon:'MON',Tue:'TUE',Wed:'WED',Thu:'THU',Fri:'FRI',Sat:'SAT'};
      DAYS.forEach((d, i)=>{
        const e = existing?.[d] || {};
        const card = document.createElement('div'); card.className = 'day-card';
        card.innerHTML = `
          <div class="day-badge"><span class="dn">${label[d]}</span></div>
          <div class="day-fields">
            <input aria-label="${d} standard hours" inputmode="decimal" type="number" min="0" step="0.25" name="${d}_std" placeholder="Std hrs" value="${e.std ?? ''}">
            <input aria-label="${d} overtime hours" inputmode="decimal" type="number" min="0" step="0.25" name="${d}_ot"  placeholder="OT hrs"  value="${e.ot ?? ''}">
            <input aria-label="${d} notes" type="text" name="${d}_note" placeholder="Notes (optional)" value="${e.note ?? ''}">
            <div class="day-tools">
              <button class="pill icon" type="button" title="Copy previous day" data-copy="${i-1}">⟲</button>
              <button class="pill icon" type="button" title="Clear row" data-clear>✕</button>
            </div>
          </div>`;
        wrap.appendChild(card);
      });

      // Row tools behavior
      wrap.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const card = btn.closest('.day-card'); if(!card) return;
        const idx = [...wrap.children].indexOf(card);
        const f = document.getElementById('tsForm');

        if (btn.dataset.copy){
          const srcIdx = Number(btn.dataset.copy);
          if (srcIdx >= 0){
            const srcDay = DAYS[srcIdx], dstDay = DAYS[idx];
            byName(f, `${dstDay}_std`).value = byName(f, `${srcDay}_std`).value;
            byName(f, `${dstDay}_ot`).value  = byName(f, `${srcDay}_ot`).value;
            byName(f, `${dstDay}_note`).value= byName(f, `${srcDay}_note`).value;
            calcTotals(rates);
          }
        }
        if (btn.hasAttribute('data-clear')){
          const day = DAYS[idx];
          byName(f, `${day}_std`).value = '';
          byName(f, `${day}_ot`).value  = '';
          byName(f, `${day}_note`).value= '';
          calcTotals(rates);
        }
      });
    }

    function collect(status){
      const f = document.getElementById('tsForm'); const entries = {};
      DAYS.forEach(d=>{
        entries[d] = {
          std: parseFloat(byName(f,`${d}_std`).value || 0),
          ot:  parseFloat(byName(f,`${d}_ot`).value  || 0),
          note: byName(f,`${d}_note`).value || ''
        };
      });
      return { status, entries };
    }

    function calcTotals(rates){
      const f = document.getElementById('tsForm'); let std=0, ot=0;
      DAYS.forEach(d=>{ std += Number(byName(f,`${d}_std`).value||0); ot += Number(byName(f,`${d}_ot`).value||0); });
      const all = std+ot; const gross = (std*(rates?.rate_std||0)) + (ot*(rates?.rate_ot||0));
      sel('#tStd').textContent = fmt(std,2); sel('#tOt').textContent = fmt(ot,2);
      sel('#tAll').textContent = fmt(all,2); sel('#tGross').textContent = fmt(gross,2);

      // Soft warning for very high totals
      const card = sel('#weekCard');
      if (all > 84){ card.style.boxShadow = '0 0 0 2px rgba(255,0,0,.25) inset'; }
      else { card.style.boxShadow = 'none'; }
    }

    // ---------- Autosave ----------
    const CACHE_KEY = 'hmj_ts_draft';
    function loadDraft(){
      try{ const j = JSON.parse(localStorage.getItem(CACHE_KEY)||''); return j||null; }catch{return null;}
    }
    function saveDraftLocal(payload){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(payload)); }catch{} }
    function clearDraftLocal(){ try{ localStorage.removeItem(CACHE_KEY); }catch{} }

    // ---------- Boot ----------
    async function boot(){
      const user = netlifyIdentity?.currentUser();
      if(!user){ sel('#gate').style.display='block'; return; }

      // Sign out button
      sel('#btnSignOut').onclick = ()=>{ netlifyIdentity?.logout(); };

      sel('#app').style.display='block';
      startDeadlineClock();

      // Profile pane (contractor + assignment)
      try{
        const prof = await api('/contractor-profile');
        const c = prof.contractor, a = prof.assignment;
        sel('#profilePane').innerHTML = a ? `
          <div><strong>${c.name}</strong><br><span class="muted">${c.email}</span></div>
          <div class="hr"></div>
          <div class="kv"><div>Client</div><div>${a.client_name}</div></div>
          <div class="kv"><div>Project</div><div>${a.project_name}</div></div>
          <div class="kv"><div>Site</div><div>${a.site_name || '—'}</div></div>
          <div class="kv"><div>Rate</div><div>£${a.rate_std}/h ${a.rate_ot?`(OT £${a.rate_ot}/h)`:''}</div></div>
          <div class="hr"></div>
          <div class="muted">Need help? Email <a href="mailto:payroll@hmj-global.com">payroll@hmj-global.com</a></div>
        ` : `<div><strong>${c.name}</strong><br><span class="muted">${c.email}</span></div>
             <div class="hr"></div><div class="muted">No active assignment.</div>`;
      }catch(e){
        sel('#profilePane').innerHTML = `<div class="muted">Profile unavailable</div>`;
      }

      // Load/ensure this week's timesheet
      let data;
      try{
        data = await api('/timesheets-get-this-week');
      }catch(e){
        toast('Failed to load timesheet: '+e.message,'err',5000);
        sel('#summary').textContent = 'Could not load timesheet.';
        return;
      }

      sel('#summary').innerHTML =
        `<strong>${data.contractor.name}</strong> — ${data.assignment.project_name} @ ${data.assignment.client_name}
         <br><span class="muted">Rate: £${data.assignment.rate_std}/h ${data.assignment.rate_ot?`(OT £${data.assignment.rate_ot}/h)`:''}</span>`;

      sel('#weekMeta').textContent = `Week ending ${data.week_ending} • Status: ${data.status}`;

      // Merge server data with any local draft (same week only)
      const draft = loadDraft();
      const sameWeek = draft && draft.week_ending === data.week_ending;
      const mergedEntries = sameWeek ? Object.assign({}, data.entries, draft.entries || {}) : data.entries;

      renderDays(mergedEntries, data.assignment);
      calcTotals(data.assignment);

      // Live recalc + autosave
      sel('#tsForm').addEventListener('input', ()=>{
        calcTotals(data.assignment);
        saveDraftLocal({ week_ending: data.week_ending, entries: collect('draft').entries });
        window.onbeforeunload = ()=>'You have unsaved changes.';
      });

      // Quick fill tools
      sel('#qMonFri8').onclick = ()=>{
        const f = sel('#tsForm');
        ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ byName(f,`${d}_std`).value = '8'; byName(f,`${d}_ot`).value='0'; });
        calcTotals(data.assignment);
      };
      sel('#qClear').onclick = ()=>{
        const f = sel('#tsForm');
        DAYS.forEach(d=>{ byName(f,`${d}_std`).value=''; byName(f,`${d}_ot`).value=''; byName(f,`${d}_note`).value=''; });
        calcTotals(data.assignment);
      };
      sel('#qSetAll').onclick = ()=>{
        const h = prompt('Set standard hours for all days (e.g. 8, 7.5, 0):','8');
        if (h==null) return;
        const f = sel('#tsForm'); DAYS.forEach(d=>{ byName(f,`${d}_std`).value = h; });
        calcTotals(data.assignment);
      };

      // Copy previous day shortcut
      document.addEventListener('keydown',(e)=>{
        if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='d'){
          e.preventDefault();
          const active = document.activeElement;
          const name = active?.name||'';
          const match = name.match(/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)_(std|ot|note)$/);
          if(!match) return;
          const day = match[1], idx = DAYS.indexOf(day);
          if(idx<=0) return;
          const prev = DAYS[idx-1], f = sel('#tsForm');
          byName(f,`${day}_std`).value = byName(f,`${prev}_std`).value;
          byName(f,`${day}_ot`).value  = byName(f,`${prev}_ot`).value;
          byName(f,`${day}_note`).value= byName(f,`${prev}_note`).value;
          calcTotals(data.assignment);
        }
      });

      // Save & Submit
      sel('#btnDraft').onclick = async ()=>{
        try{
          const payload = collect('draft');
          await api('/timesheets-save','POST',payload);
          clearDraftLocal(); window.onbeforeunload=null;
          toast('Draft saved');
        }catch(e){ toast('Save failed: '+e.message,'err',5000); }
      };

      sel('#tsForm').onsubmit = async (e)=>{
        e.preventDefault();
        try{
          const payload = collect('submitted');
          await api('/timesheets-submit','POST',payload);
          clearDraftLocal(); window.onbeforeunload=null;
          toast('Submitted — thank you!', 'ok', 3000);
          setTimeout(()=>location.reload(), 600);
        }catch(e){ toast('Submit failed: '+e.message,'err',6000); }
      };

      // History
      try{
        const hist = await api('/timesheets-history');
        sel('#history').innerHTML = hist.length
          ? hist.map(h=>`${h.week_ending} — ${h.project_name} — ${h.total_hours}h — ${h.status}`).join('<br>')
          : 'No previous weeks.';
      }catch{ sel('#history').textContent = 'History unavailable.'; }
    }

    // ---------- Gate & init ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      netlifyIdentity?.on('init', ()=>{ netlifyIdentity.currentUser() ? boot() : sel('#gate').style.display='block'; });
      netlifyIdentity?.on('login', ()=>location.reload());
      netlifyIdentity?.on('logout', ()=>location.href='/');
      // Fallback if init is slow
      setTimeout(()=>{ if(netlifyIdentity?.currentUser()) boot(); else sel('#gate').style.display='block'; }, 600);
    });
  </script>
</body>
</html>
