<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Candidate Profile — Admin | HMJ Global</title>

  <!-- Pin Identity to live site -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>

  <!-- Identity widget FIRST -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared admin bootstrap -->
  <script defer src="/admin-v2/admin/common.js?v=15"></script>

  <style>
    /* small polish to match your admin look */
    :root { --bg:#f6f8fb; --ink:#0e2038; --muted:#6b7280; --line:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; color:#111827; background:var(--bg); }
    .top .row { display:flex; gap:10px; align-items:center; padding:14px 16px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5; }
    .brand a{ text-decoration:none; color:var(--ink); font-weight:800; }
    .logo{ display:inline-grid; place-items:center; width:26px; height:26px; border-radius:6px; background:#0e2038; color:#fff; font-weight:900; margin-right:6px; }
    .pill{ display:inline-grid; align-items:center; padding:3px 8px; font-size:12px; font-weight:700; border-radius:999px; border:1px solid var(--line); background:#eef2ff; color:#374151; }
    .b-ok{ background:#e8f6ef; color:#065f46; } .b-warn{ background:#fff7ed; color:#92400e; } .b-bad{ background:#fef2f2; color:#991b1b; }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--line); background:#0e2038; color:#fff; font-weight:700; cursor:pointer; }
    .btn.ghost{ background:#fff; color:#0e2038; }
    .btn.light{ background:#e5e7eb; color:#111827; }
    .btn.danger{ background:#991b1b; }
    .wrap{ max-width:1100px; margin:18px auto; padding:0 14px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px; }
    .bar{ display:flex; gap:10px; align-items:center; }
    .sp{ flex:1 }
    input[type=text], input[type=date], input[type=email], input[type=tel], select, textarea {
      border:1px solid var(--line); border-radius:10px; padding:9px 10px; width:100%; font-size:14px; background:#fff;
    }
    label{ font-weight:700; font-size:13px; color:#374151; }
    .grid{ display:grid; gap:12px; }
    .g2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .g3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .tabs{ display:flex; gap:8px; overflow:auto; padding:6px; background:#fff; border:1px solid var(--line); border-radius:12px; }
    .tab{ padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#f9fafb; font-weight:700; cursor:pointer; white-space:nowrap; }
    .tab.active{ background:#0e2038; color:#fff; }
    .section{ display:none; margin-top:12px; }
    .section.active{ display:block; }
    table.docs{ width:100%; border-collapse:collapse; }
    table.docs th, table.docs td{ border-top:1px solid var(--line); padding:10px; text-align:left; font-size:14px; }
    .muted{ color:var(--muted); }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="top">
    <div class="row">
      <div class="brand">
        <a href="../"><span class="logo">H</span> HMJ Global</a>
        <span class="pill">Admin</span>
        <span class="pill">Candidate</span>
      </div>
      <div id="diagChips" class="chips"></div>
      <div class="sp"></div>
      <a class="btn ghost" href="./candidates.html">⟵ Back to list</a>
      <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
    </div>
  </div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <!-- toolbar -->
    <div class="card bar">
      <div style="font-weight:800" id="title">Candidate</div>
      <div class="sp"></div>
      <button class="btn ghost" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnSave">Save</button>
      <button class="btn danger" id="btnDelete">Delete</button>
    </div>

    <!-- tabs -->
    <div class="card" style="margin-top:10px">
      <div class="tabs" id="tabs"></div>

      <!-- sections -->
      <div id="sections">
        <!-- Overview -->
        <div class="section" data-tab="Overview">
          <div class="grid g2">
            <div class="card">
              <h3>Personal / Contact (summary)</h3>
              <div class="grid g2">
                <div><label>First name</label><input id="first_name" type="text"></div>
                <div><label>Last name</label><input id="last_name" type="text"></div>
                <div><label>Email</label><input id="email" type="email"></div>
                <div><label>Phone</label><input id="phone" type="tel"></div>
              </div>
            </div>
            <div class="card">
              <h3>Status</h3>
              <div class="grid g2">
                <div><label>Status</label>
                  <select id="status">
                    <option value="">(unset)</option>
                    <option>active</option>
                    <option>inactive</option>
                    <option>archived</option>
                    <option>in progress</option>
                    <option>complete</option>
                  </select>
                </div>
                <div><label>Role</label><input id="role" type="text" placeholder="e.g. Electrician"></div>
                <div><label>Start date</label><input id="start_date" type="date"></div>
                <div><label>End date</label><input id="end_date" type="date"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Personal/Contact -->
        <div class="section" data-tab="Personal/Contact">
          <div class="grid g3">
            <div><label>First name</label><input id="pc_first_name" type="text"></div>
            <div><label>Last name</label><input id="pc_last_name" type="text"></div>
            <div><label>Job title</label><input id="job_title" type="text"></div>
            <div><label>Email</label><input id="pc_email" type="email"></div>
            <div><label>Phone</label><input id="pc_phone" type="tel"></div>
            <div><label>Internal ref</label><input id="internal_ref" type="text"></div>
          </div>
          <div class="grid g3" style="margin-top:12px">
            <div><label>Address line 1</label><input id="address1" type="text"></div>
            <div><label>Address line 2</label><input id="address2" type="text"></div>
            <div><label>Town / City</label><input id="town" type="text"></div>
            <div><label>County</label><input id="county" type="text"></div>
            <div><label>Postcode</label><input id="postcode" type="text"></div>
            <div><label>Country</label><input id="country" type="text" value="United Kingdom"></div>
          </div>
          <div style="margin-top:12px"><label>Notes</label><textarea id="notes" rows="4"></textarea></div>
        </div>

        <!-- Bank -->
        <div class="section" data-tab="Bank">
          <div class="grid g3">
            <div><label>Bank name</label><input id="bank_name" type="text"></div>
            <div><label>Sort code</label><input id="bank_sort_code" type="text" placeholder="00-00-00"></div>
            <div><label>Account number</label><input id="bank_account" type="text"></div>
            <div><label>IBAN</label><input id="bank_iban" type="text"></div>
            <div><label>SWIFT</label><input id="bank_swift" type="text"></div>
          </div>
        </div>

        <!-- Tax/Payroll -->
        <div class="section" data-tab="Tax/Payroll">
          <div class="grid g3">
            <div><label>Pay type</label><input id="pay_type" type="text" placeholder="Umbrella / PAYE / Ltd / ..."></div>
            <div><label>Payroll ref</label><input id="payroll_ref" type="text"></div>
            <div><label>Tax ID</label><input id="tax_id" type="text"></div>
            <div><label>Timesheet status</label><input id="timesheet_status" type="text"></div>
            <div><label>Client name</label><input id="client_name" type="text"></div>
            <div><label>Terms accepted?</label>
              <select id="terms_ok"><option value="false">No</option><option value="true">Yes</option></select>
            </div>
          </div>
        </div>

        <!-- Documents -->
        <div class="section" data-tab="Documents">
          <div class="grid g2">
            <div class="card">
              <h3>Upload document</h3>
              <input type="file" id="docFile" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/>
              <div class="grid g2" style="margin-top:10px">
                <input id="docLabel" type="text" placeholder="Label (e.g., CV, Passport, CSCS)"/>
                <button class="btn" id="btnUpload">Upload</button>
              </div>
              <p class="muted" style="margin-top:6px">Accepted: PDF/DOC/PNG/JPG. Max size depends on your Function limit.</p>
            </div>
            <div class="card">
              <h3>Files</h3>
              <table class="docs" id="docTable">
                <thead><tr><th>When</th><th>Label</th><th>File</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- RTW -->
        <div class="section" data-tab="Right to Work">
          <div class="grid g3">
            <div><label>RTW document URL</label><input id="rtw_url" type="text" placeholder="https://…"/></div>
            <div><label>Contract URL</label><input id="contract_url" type="text" placeholder="https://…"/></div>
          </div>
        </div>

        <!-- Emergency -->
        <div class="section" data-tab="Emergency">
          <div class="grid g3">
            <div><label>Contact name</label><input id="emergency_name" type="text"></div>
            <div><label>Contact phone</label><input id="emergency_phone" type="tel"></div>
          </div>
        </div>

        <!-- Assignments -->
        <div class="section" data-tab="Assignments">
          <div class="card">
            <p class="muted">Future enhancement: embed assignment list for this candidate.</p>
          </div>
        </div>

        <!-- Notes -->
        <div class="section" data-tab="Notes">
          <textarea id="notes_long" rows="10" placeholder="Internal notes…" style="width:100%"></textarea>
        </div>

        <!-- Emails -->
        <div class="section" data-tab="Emails">
          <div class="card"><p class="muted">Log/preview important emails here (optional).</p></div>
        </div>

        <!-- Payslips -->
        <div class="section" data-tab="Payslips">
          <div class="card"><p class="muted">Hook to payroll/payslip store (optional).</p></div>
        </div>

        <!-- Logs -->
        <div class="section" data-tab="Logs">
          <div class="card" id="auditLog"><p class="muted">Audit log will appear here.</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function startProfile(){
    if (!window.Admin || !window.Admin.bootAdmin || !window.netlifyIdentity) {
      return setTimeout(startProfile, 30);
    }

    const TABS = [
      'Overview',
      'Personal/Contact',
      'Bank',
      'Tax/Payroll',
      'Documents',
      'Right to Work',
      'Emergency',
      'Assignments',
      'Notes',
      'Emails',
      'Payslips',
      'Logs'
    ];

    Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
      const chips = document.getElementById('diagChips');
      const chip = (t, tone='ok')=>{
        const s=document.createElement('span'); s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad'); s.textContent=t;
        chips?.appendChild(s);
      };
      chip('profile:init');

      // ----- routing / state -----
      const params = new URLSearchParams(location.search);
      const id = Number(params.get('id') || '') || null;
      chip('mode: ' + (id ? ('edit#'+id) : 'new'));

      let model = {};        // candidate record
      let docs  = [];        // {id, label, url, created_at}

      // ----- tabs -----
      const tabsHost = document.getElementById('tabs');
      const sections = Array.from(document.querySelectorAll('.section'));
      function mountTabs(){
        tabsHost.innerHTML = '';
        TABS.forEach((t,i)=>{
          const b=document.createElement('button');
          b.className='tab'+(i===0?' active':'');
          b.textContent=t;
          b.onclick = ()=> activate(t);
          tabsHost.appendChild(b);
        });
        activate(TABS[0]);
      }
      function activate(name){
        tabsHost.querySelectorAll('.tab').forEach(btn=>btn.classList.toggle('active', btn.textContent===name));
        sections.forEach(sec=>sec.classList.toggle('active', sec.getAttribute('data-tab')===name));
      }

      // ----- utils -----
      const val = {
        get(id){ const el=sel('#'+id); if (!el) return null; return (el.type==='checkbox') ? !!el.checked : el.value; },
        set(id,v){ const el=sel('#'+id); if (!el) return; if(el.type==='checkbox') el.checked=!!v; else el.value = (v ?? ''); }
      };

      function fillFromModel(){
        // Overview
        val.set('first_name', model.first_name);
        val.set('last_name', model.last_name);
        val.set('email', model.email);
        val.set('phone', model.phone);
        val.set('status', model.status);
        val.set('role', model.role);
        val.set('start_date', model.start_date);
        val.set('end_date', model.end_date);

        // Personal
        val.set('pc_first_name', model.first_name);
        val.set('pc_last_name', model.last_name);
        val.set('job_title', model.job_title);
        val.set('pc_email', model.email);
        val.set('pc_phone', model.phone);
        val.set('internal_ref', model.internal_ref);
        val.set('address1', model.address1);
        val.set('address2', model.address2);
        val.set('town', model.town);
        val.set('county', model.county);
        val.set('postcode', model.postcode);
        val.set('country', model.country || 'United Kingdom');
        val.set('notes', model.notes);

        // Bank
        val.set('bank_name', model.bank_name);
        val.set('bank_sort_code', model.bank_sort_code || model.bank_sort);
        val.set('bank_account', model.bank_account);
        val.set('bank_iban', model.bank_iban);
        val.set('bank_swift', model.bank_swift);

        // Tax/Payroll
        val.set('pay_type', model.pay_type);
        val.set('payroll_ref', model.payroll_ref);
        val.set('tax_id', model.tax_id);
        val.set('timesheet_status', model.timesheet_status);
        val.set('client_name', model.client_name);
        val.set('terms_ok', String(!!model.terms_ok));

        // RTW / Emergency / Links
        val.set('rtw_url', model.rtw_url);
        val.set('contract_url', model.contract_url);
        val.set('emergency_name', model.emergency_name);
        val.set('emergency_phone', model.emergency_phone);

        // long notes
        val.set('notes_long', model.notes || '');

        const title = sel('#title');
        title.textContent = (model.first_name || model.last_name) ? `${model.first_name||''} ${model.last_name||''} — Candidate ${model.ref||model.internal_ref||model.id||''}`.trim() : (id ? `Candidate #${id}` : 'New candidate');
      }

      function collectToModel(){
        const m = { ...model }; // keep any fields we don't edit here
        // Overview + Personal
        m.first_name = val.get('pc_first_name') || val.get('first_name');
        m.last_name  = val.get('pc_last_name')  || val.get('last_name');
        m.email      = val.get('pc_email')      || val.get('email');
        m.phone      = val.get('pc_phone')      || val.get('phone');
        m.job_title  = val.get('job_title');
        m.status     = val.get('status') || 'inactive';
        m.role       = val.get('role');
        m.start_date = val.get('start_date');
        m.end_date   = val.get('end_date');

        m.internal_ref = val.get('internal_ref');
        m.address1 = val.get('address1'); m.address2 = val.get('address2');
        m.town = val.get('town'); m.county = val.get('county'); m.postcode = val.get('postcode'); m.country = val.get('country');

        // Bank
        m.bank_name = val.get('bank_name');
        m.bank_sort_code = val.get('bank_sort_code');
        m.bank_account = val.get('bank_account');
        m.bank_iban = val.get('bank_iban');
        m.bank_swift = val.get('bank_swift');

        // Tax/Payroll
        m.pay_type = val.get('pay_type');
        m.payroll_ref = val.get('payroll_ref');
        m.tax_id = val.get('tax_id');
        m.timesheet_status = val.get('timesheet_status');
        m.client_name = val.get('client_name');
        m.terms_ok = val.get('terms_ok') === 'true';

        // RTW
        m.rtw_url = val.get('rtw_url');
        m.contract_url = val.get('contract_url');

        // Emergency
        m.emergency_name = val.get('emergency_name');
        m.emergency_phone = val.get('emergency_phone');

        // Notes
        m.notes = val.get('notes_long') || val.get('notes') || m.notes;

        return m;
      }

      // ----- documents -----
      async function listDocs(){
        if (!model?.id) { sel('#docTable tbody').innerHTML = '<tr><td colspan="4" class="muted">Save candidate first.</td></tr>'; return; }
        try{
          const res = await api('admin-candidate-docs-list','POST',{ id: model.id });
          docs = Array.isArray(res) ? res : (res.rows || []);
        }catch(e){ docs = []; }
        const tbody = sel('#docTable tbody'); tbody.innerHTML='';
        if (!docs.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="muted">No documents uploaded.</td></tr>'; return;
        }
        docs.forEach(d=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${(d.created_at||'').slice(0,19).replace('T',' ')}</td>
                          <td>${d.label || '—'}</td>
                          <td><a href="${d.url}" target="_blank" rel="noopener">${(d.filename||'open')}</a></td>
                          <td><button class="btn light" data-del="${d.id}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('[data-del]').forEach(b=>{
          b.onclick = async ()=>{
            const docId = Number(b.getAttribute('data-del'));
            if (!confirm('Delete this document?')) return;
            try{
              await api('admin-candidate-docs-delete','POST',{ id: model.id, doc_id: docId });
              toast('Document deleted','ok',1500); listDocs();
            }catch(e){ /* toast shown by api */ }
          };
        });
      }

      async function uploadDoc(){
        const f = sel('#docFile')?.files?.[0];
        if (!f) return toast('Pick a file first','warn',1800);
        if (!model?.id) return toast('Save the candidate first','warn',2200);
        const label = (sel('#docLabel')?.value || '').trim();

        // Use Identity token + raw fetch + FormData so we can send the file binary
        const { token } = await identity();
        const fd = new FormData();
        fd.append('id', String(model.id));
        fd.append('label', label);
        fd.append('file', f, f.name);

        try{
          const res = await fetch('/.netlify/functions/admin-candidate-docs-upload', {
            method:'POST', headers: token ? { 'Authorization': 'Bearer ' + token } : {}, body: fd, credentials:'include'
          });
          if (!res.ok) throw new Error('Upload failed: HTTP ' + res.status);
          toast('Uploaded','ok',1400); sel('#docFile').value=''; sel('#docLabel').value=''; listDocs();
        }catch(e){ toast(e.message || e, 'error', 4200); }
      }

      // ----- data ops -----
      async function load(){
        try{
          if (id) {
            const res = await api('admin-candidates-get','POST',{ id });
            model = Array.isArray(res) ? res[0] : (res || {});
            if (!model?.id) model.id = id;
          } else {
            model = { status:'inactive', country:'United Kingdom' };
          }
          fillFromModel();
          listDocs();
          // Optional: load audit
          try{
            const log = await api('admin-audit-list','POST',{ target_type:'candidate', target_id: String(model.id||'') , limit: 25 });
            const host = sel('#auditLog');
            if (host && Array.isArray(log) && log.length) {
              host.innerHTML = '<ul style="margin:0;padding-left:18px">'+
                log.map(a=>`<li><span class="muted">${(a.at||'').replace('T',' ').slice(0,19)}</span> — ${a.action} by ${a.actor_email||'n/a'}</li>`).join('')+
              '</ul>';
            }
          }catch{}
        }catch(e){
          console.error('[candidate] load error', e);
          toast('Load failed: ' + (e.message || e), 'error', 4200);
        }
      }
      async function save(){
        try{
          const payload = collectToModel();
          const res = await api('admin-candidates-save','POST', payload);
          model = res || payload;
          if (!id && model.id) {
            // if newly created, redirect to own URL
            location.replace(`./candidate-profile.html?id=${model.id}`);
            return;
          }
          toast('Saved','ok',1400);
          fillFromModel(); listDocs();
        }catch(e){
          console.error('[candidate] save error', e);
          toast('Save failed: ' + (e.message || e), 'error', 4200);
        }
      }
      async function del(){
        if (!model?.id) return toast('Nothing to delete','warn',1800);
        if (!confirm('Delete this candidate?')) return;
        try{
          await api('admin-candidate-delete','POST',{ ids:[model.id] });
          toast('Deleted','ok',1400); location.href = './candidates.html';
        }catch(e){
          console.error('[candidate] delete error', e);
          toast('Delete failed: ' + (e.message || e), 'error', 4200);
        }
      }

      // ----- wire UI -----
      mountTabs();
      sel('#btnRefresh') && (sel('#btnRefresh').onclick = load);
      sel('#btnSave')    && (sel('#btnSave').onclick    = save);
      sel('#btnDelete')  && (sel('#btnDelete').onclick  = del);
      sel('#btnUpload')  && (sel('#btnUpload').onclick  = uploadDoc);

      // keep Overview in sync when user types on Personal tab
      ['pc_first_name','pc_last_name','pc_email','pc_phone'].forEach(id=>{
        const el = sel('#'+id); if (!el) return;
        el.addEventListener('input', ()=>{
          if (id==='pc_first_name') sel('#first_name').value = el.value;
          if (id==='pc_last_name')  sel('#last_name').value  = el.value;
          if (id==='pc_email')      sel('#email').value      = el.value;
          if (id==='pc_phone')      sel('#phone').value      = el.value;
        });
      });

      await load();
    });
  })();
  </script>
</body>
</html>
