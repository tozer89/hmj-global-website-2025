<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Candidates — Admin | HMJ Global</title>

  <!-- Netlify Identity first (defer keeps order; safe in <head>) -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    // Force-init widget once DOM is ready (harmless if already ready)
    document.addEventListener('DOMContentLoaded', function () {
      try { window.netlifyIdentity && window.netlifyIdentity.init(); } catch(e){}
    });
  </script>

  <style>
    :root{
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#1f3b7a; --blue-2:#29478f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --danger:#dc2626; --ok:#16a34a; --warn:#f59e0b;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Header */
    .top{position:sticky;top:0;z-index:30;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;display:flex;gap:10px;align-items:center}
    .brand a{color:#fff;text-decoration:none;display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;color:var(--blue);display:grid;place-items:center;font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.danger{background:#7a1f28;border-color:#a42e3b}

    /* Page */
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bar .sp{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--stroke);border-radius:10px;padding:10px}
    input:focus,select:focus,textarea:focus{outline:3px solid var(--ring);outline-offset:2px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--stroke);text-align:left}
    th{font-size:14px;color:#334155}
    .pill{display:inline-grid;align-items:center;padding:3px 8px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}

    /* Drawer */
    .drawer{position:fixed;inset:0;display:none;background:rgba(2,6,23,.44);z-index:40}
    .drawer .panel{position:absolute;right:0;top:0;bottom:0;width:820px;max-width:100%;background:#fff;border-left:1px solid var(--stroke);padding:16px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .twocol{grid-template-columns:1fr} }
    .section{margin:12px 0 6px;font-weight:800}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Candidates</span>
    </div>
    <div class="sp"></div>
    <div class="chips" id="chips"></div>
    <a class="btn ghost" href="./">⟵ Admin</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <!-- Toolbar -->
    <div class="card bar">
      <input id="q" placeholder="Search name, ref, email…" style="min-width:260px">
      <select id="status">
        <option value="">Status: any</option>
        <option>active</option><option>inactive</option><option>archived</option>
      </select>
      <select id="has_docs">
        <option value="">Docs: any</option>
        <option value="true">Complete</option>
        <option value="false">Missing</option>
      </select>

      <button class="btn" id="btnRefresh">Refresh</button>
      <div class="sp"></div>

      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost" id="btnExport">Export CSV</button>
      <button class="btn ghost" id="btnImport">Import CSV</button>

      <button class="btn" id="btnNew">+ New candidate</button>
      <button class="btn danger" id="btnDelete" disabled>Delete</button>
    </div>

    <!-- List -->
    <div class="card" id="listWrap">Loading…</div>

    <!-- Audit mini -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="section" style="margin:0">Recent activity</div>
        <button class="btn ghost" id="btnAudit">Refresh</button>
      </div>
      <div id="audit" class="muted">—</div>
    </div>
  </div>

  <!-- Drawer editor -->
  <div class="drawer" id="drawer" aria-modal="true" role="dialog">
    <div class="panel">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <h2 id="edTitle" style="margin:0">Candidate</h2>
        <div class="right" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn ghost" id="btnSave">Save</button>
          <button class="btn danger" id="btnDelOne">Delete</button>
          <button class="btn ghost" id="btnClose">Close</button>
        </div>
      </div>

      <!-- Core details -->
      <div class="section">Core</div>
      <div class="grid">
        <label>Reference <input id="ref" placeholder="Auto/Manual"></label>
        <label>Status
          <select id="status_edit"><option>active</option><option>inactive</option><option>archived</option></select>
        </label>
        <label>Full Name <input id="full_name" placeholder="Jane Doe"></label>
        <label>Job Role <input id="job_role" placeholder="e.g., Data Centre Engineer"></label>
        <label>Email <input id="email" type="email"></label>
        <label>Phone <input id="phone" type="tel"></label>
        <label>Address <input id="address"></label>
        <label>NI / Tax ID <input id="tax_id"></label>
        <label>Start Date <input id="start_date" type="date"></label>
        <label>End Date <input id="end_date" type="date"></label>
        <label>Client Assignment <input id="client_name" placeholder="Linked client"></label>
        <label>Assignment Ref <input id="assignment_ref" placeholder="Linked assignment"></label>
      </div>

      <!-- Payroll -->
      <div class="section">Payroll</div>
      <div class="grid">
        <label>Bank Name <input id="bank_name"></label>
        <label>Account Number <input id="bank_account"></label>
        <label>Sort / Routing <input id="bank_sort"></label>
        <label>IBAN <input id="bank_iban"></label>
      </div>

      <!-- Compliance -->
      <div class="section">Compliance & Docs</div>
      <div class="grid">
        <label>RTW Verified
          <select id="rtw_ok"><option value="false">No</option><option value="true">Yes</option></select>
        </label>
        <label>T&Cs Accepted
          <select id="terms_ok"><option value="false">No</option><option value="true">Yes</option></select>
        </label>
        <label>Emergency Contact <input id="emergency_contact" placeholder="Name & phone"></label>
      </div>

      <!-- Document upload -->
      <div class="section">Documents</div>
      <div class="twocol">
        <div class="card" style="background:#fff">
          <div style="font-weight:700;margin-bottom:6px">Right-to-Work</div>
          <div id="doc_rtw_info" class="muted">No file.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="file" id="doc_rtw" accept="application/pdf,image/*">
            <button class="btn ghost" data-upload="rtw">Upload</button>
          </div>
        </div>
        <div class="card" style="background:#fff">
          <div style="font-weight:700;margin-bottom:6px">Contract</div>
          <div id="doc_contract_info" class="muted">No file.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="file" id="doc_contract" accept="application/pdf,image/*">
            <button class="btn ghost" data-upload="contract">Upload</button>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="section">Notes</div>
      <textarea id="notes" rows="4" placeholder="Internal notes…"></textarea>
    </div>
  </div>

  <!-- Toast host (common.js will reuse if present) -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Shared admin bootstrap (ABSOLUTE PATH + version bump) -->
  <script defer src="/admin/common.js?v=10"></script>

  <script>
  // Page logic (runs only after admin gate passes)
  Admin.bootAdmin(async ({ api, sel, toast }) => {
    // Tiny chip/toast so we know it actually ran
    console.log('Candidates bootAdmin running');
    const chip = (t,tone='info') => {
      const span=document.createElement('span'); span.className='pill'; span.textContent=t;
      if(tone==='ok') span.classList.add('b-ok');
      if(tone==='warn') span.classList.add('b-warn');
      if(tone==='bad') span.classList.add('b-bad');
      sel('#chips').appendChild(span); return span;
    };
    chip('ready','ok');

    // State
    let page=1, pageSize=20, total=0, rows=[], selected=new Set(), current=null;

    function enableDelete(){ sel('#btnDelete').disabled = selected.size===0; }
    function openDrawer(){ sel('#drawer').style.display='block'; }
    function closeDrawer(){ sel('#drawer').style.display='none'; current=null; }

    function renderList(){
      if(!rows.length){ sel('#listWrap').textContent='No candidates found.'; return; }
      const head = `<thead><tr>
        <th style="width:28px"><input id="ckAll" type="checkbox"></th>
        <th>Ref</th><th>Name</th><th>Email</th><th>Phone</th>
        <th>Status</th><th>Client</th><th>Docs</th><th></th>
      </tr></thead>`;
      const body = rows.map(r=>{
        const docs = (r.rtw_ok ? 'RTW✓ ' : '') + (r.terms_ok ? 'T&Cs✓' : '');
        const pillClass = r.status==='active'?'b-ok':(r.status==='archived'?'b-bad':'b-warn');
        return `<tr>
          <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
          <td>${r.ref || r.id}</td>
          <td>${r.full_name||'—'}</td>
          <td>${r.email||'—'}</td>
          <td>${r.phone||'—'}</td>
          <td><span class="pill ${pillClass}">${r.status||'inactive'}</span></td>
          <td>${r.client_name||'—'}</td>
          <td>${docs || '—'}</td>
          <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
        </tr>`;
      }).join('');
      const pager = `<div style="display:flex;justify-content:space-between;align-items:center;padding-top:8px">
        <div class="muted">Showing ${(page-1)*pageSize+1}-${Math.min(page*pageSize,total)} of ${total}</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="pPrev" ${page<=1?'disabled':''}>Prev</button>
          <button class="btn ghost" id="pNext" ${(page*pageSize)>=total?'disabled':''}>Next</button>
        </div></div>`;
      sel('#listWrap').innerHTML = `<table>${head}<tbody>${body}</tbody></table>${pager}`;

      sel('#ckAll').onclick = (e)=>{ if(e.target.checked){ rows.forEach(r=>selected.add(r.id)); } else { rows.forEach(r=>selected.delete(r.id)); } enableDelete(); renderList(); };
      sel('#listWrap').querySelectorAll('input[type=checkbox][data-id]').forEach(c=> c.onchange=()=>{ const id=Number(c.getAttribute('data-id')); if(c.checked) selected.add(id); else selected.delete(id); enableDelete(); });
      sel('#listWrap').querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openCandidate(Number(b.getAttribute('data-open'))));
      sel('#pPrev').onclick=()=>{ page--; load(); };
      sel('#pNext').onclick=()=>{ page++; load(); };
    }

    async function load(){
      sel('#listWrap').textContent='Loading…';
      try{
        const res = await api('admin-candidate-list','POST',{
          q: sel('#q').value||'',
          status: sel('#status').value||'',
          has_docs: sel('#has_docs').value||'',
          page, pageSize
        });
        rows = res.rows || res || [];
        total = res.total ?? rows.length;
        renderList();
      }catch(e){
        sel('#listWrap').textContent='Error: '+e.message;
      }
    }

    async function loadAudit(){
      try{
        const list = await api('admin-audit-list','POST',{ entity:'candidate', limit: 10 });
        sel('#audit').innerHTML = list.length ? `<ul style="margin:6px 0;padding-left:18px">
          ${list.map(a=>`<li><span class="muted">${a.created_at?.replace('T',' ').slice(0,16)||''}</span> — ${a.action} #${a.entity_id||''} by ${a.actor_email||'—'}</li>`).join('')}
        </ul>` : '—';
      }catch(e){ sel('#audit').textContent='Audit unavailable: '+e.message; }
    }

    // Open editor
    async function openCandidate(id){
      try{
        const r = await api('admin-candidate-open','POST',{ id });
        current = r;
        sel('#edTitle').textContent = `Candidate #${r.id}`;
        const set = (k,v)=>{ const el=sel('#'+k); if(el) el.value = (v ?? ''); };
        set('ref', r.ref);
        set('status_edit', r.status||'active');
        set('full_name', r.full_name);
        set('job_role', r.job_role);
        set('email', r.email);
        set('phone', r.phone);
        set('address', r.address);
        set('tax_id', r.tax_id);
        set('start_date', (r.start_date||'').slice(0,10));
        set('end_date', (r.end_date||'').slice(0,10));
        set('client_name', r.client_name);
        set('assignment_ref', r.assignment_ref);
        set('bank_name', r.bank_name);
        set('bank_account', r.bank_account);
        set('bank_sort', r.bank_sort);
        set('bank_iban', r.bank_iban);
        sel('#rtw_ok').value = String(!!r.rtw_ok);
        sel('#terms_ok').value = String(!!r.terms_ok);
        set('emergency_contact', r.emergency_contact);
        set('notes', r.notes);

        sel('#doc_rtw_info').innerHTML = r.doc_rtw_url ? `<a href="${r.doc_rtw_url}" target="_blank">View RTW</a>` : 'No file.';
        sel('#doc_contract_info').innerHTML = r.doc_contract_url ? `<a href="${r.doc_contract_url}" target="_blank">View Contract</a>` : 'No file.';

        openDrawer();
      }catch(e){
        toast('Open failed: '+e.message,'err',5000);
      }
    }

    // New
    function newCandidate(){
      current = { id:null, status:'active' };
      ['ref','full_name','job_role','email','phone','address','tax_id','start_date','end_date',
       'client_name','assignment_ref','bank_name','bank_account','bank_sort','bank_iban',
       'emergency_contact','notes'].forEach(k=>{ const el=sel('#'+k); if(el) el.value=''; });
      sel('#status_edit').value='active';
      sel('#rtw_ok').value='false';
      sel('#terms_ok').value='false';
      sel('#doc_rtw_info').textContent='No file.';
      sel('#doc_contract_info').textContent='No file.';
      openDrawer();
    }

    // Save
    async function save(){
      const get = id => sel('#'+id)?.value || null;
      const payload = {
        id: current?.id || null,
        ref: get('ref'),
        status: get('status_edit'),
        full_name: get('full_name'),
        job_role: get('job_role'),
        email: get('email'),
        phone: get('phone'),
        address: get('address'),
        tax_id: get('tax_id'),
        start_date: get('start_date') || null,
        end_date: get('end_date') || null,
        client_name: get('client_name'),
        assignment_ref: get('assignment_ref'),
        bank_name: get('bank_name'),
        bank_account: get('bank_account'),
        bank_sort: get('bank_sort'),
        bank_iban: get('bank_iban'),
        rtw_ok: sel('#rtw_ok')?.value === 'true',
        terms_ok: sel('#terms_ok')?.value === 'true',
        emergency_contact: get('emergency_contact'),
        notes: get('notes')
      };
      try{
        await api('admin-candidate-save','POST', payload);
        toast('Saved','ok',2000); closeDrawer(); load();
      }catch(e){ toast('Save failed: '+e.message,'err',5000); }
    }

    // Delete (bulk)
    async function delSelected(){
      if(!selected.size) return;
      if(!confirm(`Delete ${selected.size} candidate(s)?`)) return;
      try{ await api('admin-candidate-delete','POST',{ ids: Array.from(selected) });
        selected.clear(); enableDelete(); toast('Deleted','ok',2000); load();
      }catch(e){ toast('Delete failed: '+e.message,'err',5000); }
    }
    async function delOne(){ if(!current?.id) return; selected=new Set([current.id]); await delSelected(); closeDrawer(); }

    // Upload docs
    async function upload(kind){
      const input = sel(kind === 'rtw' ? '#doc_rtw' : '#doc_contract');
      const f = input.files?.[0]; if(!f){ toast('Choose a file first','warn',2500); return; }
      try{
        const sign = await api('admin-uploads-presign','POST',{ entity:'candidate', entity_id: current?.id, kind, filename:f.name, type:f.type });
        await fetch(sign.url,{ method:'PUT', headers:sign.headers||{}, body:f });
        const attachFn = kind === 'rtw' ? 'admin-candidate-attach-rtw' : 'admin-candidate-attach-contract';
        await api(attachFn,'POST',{ id: current?.id, url: sign.public_url });
        if(kind==='rtw') sel('#doc_rtw_info').innerHTML = `<a href="${sign.public_url}" target="_blank">View RTW</a>`;
        else sel('#doc_contract_info').innerHTML = `<a href="${sign.public_url}" target="_blank">View Contract</a>`;
        toast('Uploaded','ok',1800);
      }catch(e){ toast('Upload failed: '+e.message,'err',5000); }
    }

    // Export / Import
    async function exportCSV(){
      try{
        const blob = await api('admin-candidate-export','POST',{ q: sel('#q').value||'', status: sel('#status').value||'' });
        const url = URL.createObjectURL(new Blob([blob],{type:'text/csv'}));
        const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ toast('Export failed: '+e.message,'err',5000); }
    }
    function importCSV(){ sel('#csv').click(); }
    sel('#csv').addEventListener('change', async ()=>{
      const f = sel('#csv').files[0]; if(!f) return;
      const text = await f.text();
      try{
        const res = await api('admin-candidate-import','POST',{ csv:text });
        toast(`Imported ${res?.inserted ?? 0}`, 'ok', 2500); load();
      }catch(e){ toast('Import failed: '+e.message,'err',5000); }
    });

    // Wire UI
    sel('#btnRefresh').onclick=load;
    sel('#btnNew').onclick=newCandidate;
    sel('#btnSave').onclick=save;
    sel('#btnDelete').onclick=delSelected;
    sel('#btnDelOne').onclick=delOne;
    sel('#btnClose').onclick=()=>{ closeDrawer(); };
    sel('[data-upload="rtw"]').onclick=()=>upload('rtw');
    sel('[data-upload="contract"]').onclick=()=>upload('contract');
    sel('#btnAudit').onclick=loadAudit;
    sel('#btnExport').onclick=exportCSV;
    sel('#btnImport').onclick=importCSV;

    ['#q','#status','#has_docs'].forEach(s=> sel(s).addEventListener('change', ()=>{ page=1; load(); }));

    // Shortcuts
    document.addEventListener('keydown',(e)=>{
      if(e.key==='n' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); newCandidate(); }
      if(e.key==='s' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); if(sel('#drawer').style.display==='block') save(); }
      if(e.key==='e' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); exportCSV(); }
      if(e.key==='Escape' && sel('#drawer').style.display==='block'){ e.preventDefault(); closeDrawer(); }
    });

    // Initial loads
    await load();
    await loadAudit();
  });
  </script>
</body>
</html>
