<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Candidates — Admin | HMJ Global</title>

  <!-- Pin Identity to live site (one way is enough; pick ONE of these) -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>
  <!-- or: <meta name="netlify-identity-url" content="https://hmjg.netlify.app/.netlify/identity"> -->

  <!-- Identity widget FIRST -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared admin bootstrap (single copy; bump when changed) -->
  <script defer src="/admin-v2/admin/common.js?v=15"></script>

  <style>
    :root{
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#1f3b7a; --blue-2:#29478f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --success:#16a34a; --danger:#dc2626; --warn:#f59e0b;
      --chip:#eef2ff;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:30;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .brand a{display:inline-flex;gap:8px;align-items:center;color:#fff;text-decoration:none}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;display:grid;place-items:center;color:var(--blue);font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px;font-weight:700}
    .btn.danger{background:#7a1f28;border-color:#7a1f28}
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=text], input[type=date], input[type=email], select, textarea{
      border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;min-width:180px;font:inherit
    }
    input[type=search]{ min-width:260px; }
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--stroke);border-radius:14px;overflow:hidden}
    thead th{background:#fbfdff;border-bottom:1px solid var(--stroke);text-align:left;padding:10px 12px;font-weight:800}
    tbody td{border-top:1px solid var(--stroke);padding:10px 12px;vertical-align:middle}
    .muted{color:var(--muted)}
    .pill{display:inline-grid;align-items:center;padding:4px 10px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    /* Drawer */
    .drawer{position:fixed;inset:0 0 0 auto;max-width:760px;width:95vw;background:#fff;box-shadow:-4px 0 24px rgba(2,6,23,.24);transform:translateX(100%);transition:transform .24s ease;z-index:40;display:grid;grid-template-rows:auto 1fr auto}
    .drawer.open{transform:translateX(0)}
    .d-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--stroke);background:var(--card)}
    .d-body{padding:16px;overflow:auto}
    .d-foot{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--stroke);background:#fff}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
    .field{display:grid;gap:6px}
    .field label{font-weight:700;font-size:13px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 8px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:#fff;cursor:pointer;font-weight:700}
    .tab.active{background:var(--chip)}
    .hr{height:1px;background:var(--stroke);margin:8px 0 4px}
    .right{display:flex;gap:8px;align-items:center}
    .link{color:var(--blue);text-decoration:underline;cursor:pointer}
    :focus{outline:3px solid var(--ring);outline-offset:2px;border-radius:8px}
  </style>
</head>

<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Candidates</span>
    </div>
    <div class="sp"></div>
    <div id="diagChips" class="chips"></div>
    <a class="btn ghost" href="./">⟵ Admin</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <div class="card bar">
      <input id="q" type="search" placeholder="Search name, email, ref…" />
      <select id="status">
        <option value="">Status: any</option>
        <option>In progress</option>
        <option>Complete</option>
        <option>Archived</option>
      </select>
      <button class="btn small" id="btnRefresh">Refresh</button>
      <div class="sp"></div>
      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost small" id="btnExport">Export CSV</button>
      <button class="btn ghost small" id="btnImport">Import CSV</button>
      <button class="btn small" id="btnNew">+ New candidate</button>
      <button class="btn danger small" id="btnDelete" disabled>Delete</button>
    </div>

    <div class="card" id="listWrap">Loading…</div>
  </div>

  <!-- Drawer editor -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <strong id="dTitle">New candidate</strong>
      <span class="sp"></span>
      <button class="btn ghost small" id="btnClose">✕ Close</button>
    </div>
    <div class="d-body">
      <div class="tabs" id="tabs"></div>
      <form id="frm" class="grid" autocomplete="off"></form>
    </div>
    <div class="d-foot">
      <div class="muted">Ref: <span id="dRef">—</span></div>
      <div class="right">
        <button class="btn ghost" id="btnSaveDraft" type="button">Save</button>
        <button class="btn" id="btnSaveClose" type="button">Save & Close</button>
      </div>
    </div>
  </aside>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Single page boot (no duplicates) -->
  <script>
    (function startCandidates(){
      if (!window.Admin || typeof window.Admin.bootAdmin !== 'function' || !window.netlifyIdentity) {
        return setTimeout(startCandidates, 30);
      }

      Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
        // --- diag chips ---
        const chips = document.getElementById('diagChips');
        const chip = (t, tone='ok') => {
          if (!chips) return;
          const s=document.createElement('span');
          s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
          s.textContent=t; chips.appendChild(s);
        };
        chip('candidates:init','ok');

        const who = await identity('admin');
        if (!who || !who.ok) {
          chip('role: blocked','bad');
          const g = document.getElementById('gate'), app = document.getElementById('app');
          if (app) app.style.display = 'none';
          if (g) { g.style.display = ''; const why=g.querySelector('.why'); if (why) why.textContent='Restricted. Sign in with an admin account.'; }
          return;
        }
        chip('role: admin','ok');
        chip('token: ok','ok');
        chip('trace: '+getTrace().slice(0,10),'ok');

        // ----- state -----
        let rows = [];
        let selected = new Set();
        let editingId = null; // number | null
        let currentTab = 'Basics';

        // ----- helpers -----
        const $ = sel;
        const enableDelete = () => { const b=$('#btnDelete'); if (b) b.disabled = selected.size===0; };
        const drawer = $('#drawer');
        const openDrawer = () => drawer && drawer.classList.add('open');
        const closeDrawer = () => { if (!drawer) return; drawer.classList.remove('open'); setTimeout(()=>resetForm(),150); };
        $('#btnClose') && ($('#btnClose').onclick = closeDrawer);

        function pillForStatus(s){
          const tone = s==='Complete' ? 'b-ok' : s==='In progress' ? 'b-warn' : 'b-bad';
          return `<span class="pill ${tone}">${s||'In progress'}</span>`;
        }

        function render(){
          const wrap = $('#listWrap');
          if (!wrap) return;
          if (!rows.length) { wrap.textContent = 'No candidates found.'; return; }

          const thead = `<thead><tr>
            <th style="width:28px"><input id="ckAll" type="checkbox"></th>
            <th>Ref</th><th>Name</th><th>Email</th><th>Phone</th>
            <th>Status</th><th></th>
          </tr></thead>`;

          const tbody = rows.map(r => `
            <tr>
              <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
              <td>${r.ref || r.id}</td>
              <td>${(r.first_name||'—') + ' ' + (r.last_name||'')}</td>
              <td>${r.email || '—'}</td>
              <td>${r.phone || '—'}</td>
              <td>${pillForStatus(r.status||'In progress')}</td>
              <td><button class="btn ghost small" data-open="${r.id}">Open</button></td>
            </tr>`).join('');

          wrap.innerHTML = `<table>${thead}<tbody>${tbody}</tbody></table>`;

          const ckAll = document.getElementById('ckAll');
          if (ckAll) ckAll.onclick = (e)=>{
            if (e.target.checked) rows.forEach(r=>selected.add(r.id));
            else rows.forEach(r=>selected.delete(r.id));
            enableDelete(); render();
          };

          wrap.querySelectorAll('input[type=checkbox][data-id]').forEach(c=>{
            c.onchange = ()=>{
              const id = Number(c.getAttribute('data-id'));
              if (c.checked) selected.add(id); else selected.delete(id);
              enableDelete();
            };
          });

          wrap.querySelectorAll('[data-open]').forEach(b=>{
            b.onclick = ()=> openOne(Number(b.getAttribute('data-open')));
          });
        }

        // ----- data ops -----
        async function load(){
          const wrap = $('#listWrap'); if (wrap) wrap.textContent = 'Loading…';
          try{
            const res = await api('admin-candidates-list','POST',{
              q: ($('#q')?.value || '').trim(),
              status: $('#status')?.value || ''
            });
            rows = Array.isArray(res) ? res : (res.rows || []);
            render();
          }catch(e){
            console.error('[candidates] list error', e);
            if (wrap) wrap.textContent = 'Error: ' + (e.message || e);
          }
        }

        async function openOne(id){
          try{
            const r = await api('admin-candidate-get','POST',{ id });
            editingId = id;
            openEditor(r);
            toast('Opened ' + (r.full_name || (`ID ${id}`)), 'info', 1800);
          }catch(e){
            console.error('[candidates] open error', e);
            toast('Open failed: ' + (e.message || e), 'error', 4200);
          }
        }

        async function delSelected(){
          if (!selected.size) return;
          if (!confirm(`Delete ${selected.size} candidate(s)?`)) return;
          try{
            await api('admin-candidates-delete','POST',{ ids: Array.from(selected) });
            toast('Deleted','ok',1800);
            selected.clear(); enableDelete(); load();
          }catch(e){
            console.error('[candidates] delete error', e);
            toast('Delete failed: ' + (e.message || e), 'error', 4200);
          }
        }

        async function exportCSV(){
          try{
            const csv = await api('admin-candidates-export','POST',{
              q: ($('#q')?.value || '').trim(),
              status: $('#status')?.value || ''
            });
            const blob = new Blob([csv], { type:'text/csv' });
            const url = URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
            URL.revokeObjectURL(url);
            toast('Exported','ok',1400);
          }catch(e){
            console.error('[candidates] export error', e);
            toast('Export failed: ' + (e.message || e), 'error', 4200);
          }
        }
        function importCSVClick(){ $('#csv')?.click(); }
        async function importCSVDo(file){
          try{
            const text = await file.text();
            const res  = await api('admin-candidates-import','POST',{ csv:text });
            toast(`Imported ${res?.inserted ?? 0}`,'ok',2000);
            load();
          }catch(e){
            console.error('[candidates] import error', e);
            toast('Import failed: ' + (e.message || e), 'error', 4200);
          }
        }

        // ----- editor (drawer) -----
        const schemaTabs = [
          { name:'Basics', fields:[
            ['first_name','First name'],['last_name','Last name'],
            ['job_title','Job title'],['status','Status','select','In progress,Complete,Archived'],
            ['pay_type','Pay type','select','PAYE,PSC,Umbrella'],
            ['payroll_ref','Payroll ref'],['internal_ref','Internal ref']
          ]},
          { name:'Contact', fields:[
            ['email','Email','email'],['phone','Phone'],
            ['address1','Address 1'],['address2','Address 2'],['town','Town'],['county','County'],
            ['postcode','Postcode'],['country','Country']
          ]},
          { name:'Bank', fields:[
            ['bank_name','Bank name'],['bank_sort','Sort code'],['bank_sort_code','Sort code (alt)'],
            ['bank_account','Account number'],['bank_iban','IBAN'],['bank_swift','SWIFT/BIC']
          ]},
          { name:'Emergency', fields:[
            ['emergency_name','Emergency contact'],['emergency_phone','Emergency phone']
          ]},
          { name:'Compliance', fields:[
            ['rtw_url','Right to work URL'],['contract_url','Contract URL'],
            ['terms_ok','Terms accepted','checkbox']
          ]},
          { name:'Employment', fields:[
            ['client_name','Client'],['role','Role'],
            ['start_date','Start date','date'],['end_date','End date','date'],
            ['timesheet_status','Timesheet status','select','In progress,Complete,Missing']
          ]},
          { name:'Other', fields:[
            ['ref','Ref'],['tax_id','Tax ID'],['notes','Notes','textarea']
          ]}
        ];

        function fieldHtml([key,label,type='text',extra]){
          const id = 'f_'+key;
          if(type==='checkbox'){
            return `<div class="field"><label for="${id}">${label}</label>
                    <input id="${id}" name="${key}" type="checkbox"></div>`;
          }
          if(type==='textarea'){
            return `<div class="field" style="grid-column:1/-1"><label for="${id}">${label}</label>
                    <textarea id="${id}" name="${key}" rows="3"></textarea></div>`;
          }
          if(type==='select'){
            const opts = (extra||'').split(',').map(s=>s.trim()).filter(Boolean)
              .map(s=>`<option>${s}</option>`).join('');
            return `<div class="field"><label for="${id}">${label}</label>
                    <select id="${id}" name="${key}"><option value=""></option>${opts}</select></div>`;
          }
          return `<div class="field"><label for="${id}">${label}</label>
                  <input id="${id}" name="${key}" type="${type}"></div>`;
        }

        function buildEditorShell(){
          // tabs
          const tabsHost = $('#tabs');
          tabsHost.innerHTML = '';
          schemaTabs.forEach(t=>{
            const b=document.createElement('button');
            b.type='button'; b.className='tab'+(t.name===currentTab?' active':''); b.textContent=t.name;
            b.onclick=()=>{ currentTab=t.name; buildEditorForm(); Array.from(tabsHost.children).forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
            tabsHost.appendChild(b);
          });
          buildEditorForm();
        }

        function buildEditorForm(values={}){
          const tab = schemaTabs.find(t=>t.name===currentTab) || schemaTabs[0];
          const frm = $('#frm'); frm.innerHTML = tab.fields.map(fieldHtml).join('');
          // fill
          tab.fields.forEach(([key,,type])=>{
            const el = frm.querySelector(`[name="${key}"]`);
            if(!el) return;
            if(type==='checkbox'){ el.checked = !!values[key]; }
            else { if(values[key] != null) el.value = values[key]; }
          });
        }

        function readForm(){
          const out = {};
          schemaTabs.forEach(t=>{
            t.fields.forEach(([key,,type])=>{
              const el = document.querySelector(`#frm [name="${key}"]`);
              if(!el) return;
              if(type==='checkbox') out[key] = !!el.checked;
              else out[key] = el.value || null;
            });
          });
          // derive full_name for toasts
          out.full_name = [out.first_name, out.last_name].filter(Boolean).join(' ');
          return out;
        }

        function resetForm(){
          editingId = null; currentTab='Basics';
          $('#dTitle').textContent = 'New candidate';
          $('#dRef').textContent = '—';
          buildEditorShell();
        }

        function openEditor(values={}){
          buildEditorShell();
          // populate all tabs (so switching preserves values)
          schemaTabs.forEach(t=>{
            t.fields.forEach(([key,,type])=>{
              const el = document.querySelector(`#frm [name="${key}"]`);
              if(!el) return;
              if(type==='checkbox') el.checked = !!values[key];
              else if(values[key] != null) el.value = values[key];
            });
          });
          $('#dTitle').textContent = values?.full_name || 'Edit candidate';
          $('#dRef').textContent = values?.ref || values?.id || '—';
          openDrawer();
        }

        async function save(closeAfter=false){
          try{
            const body = readForm();
            if (editingId) body.id = editingId;
            const res = await api('admin-candidates-save','POST', body);
            toast('Saved ' + (res?.full_name || body.full_name || 'candidate'), 'ok', 1800);
            if (closeAfter) closeDrawer();
            await load();
            // If new, switch to editing the saved one
            if (!editingId && res?.id) { editingId = res.id; }
          }catch(e){
            console.error('[candidates] save error', e);
            toast('Save failed: ' + (e.message || e), 'error', 4200);
          }
        }

        // ----- wire UI -----
        $('#btnRefresh') && ($('#btnRefresh').onclick = load);
        $('#btnDelete')  && ($('#btnDelete').onclick  = delSelected);
        $('#btnNew')     && ($('#btnNew').onclick     = ()=>{ resetForm(); openDrawer(); });
        $('#btnExport')  && ($('#btnExport').onclick  = exportCSV);
        $('#btnImport')  && ($('#btnImport').onclick  = importCSVClick);
        $('#csv') && $('#csv').addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if (f) importCSVDo(f);
        });
        $('#q')      && $('#q').addEventListener('input',  () => load());
        $('#status') && $('#status').addEventListener('change', () => load());
        $('#btnSaveDraft') && ($('#btnSaveDraft').onclick = ()=>save(false));
        $('#btnSaveClose') && ($('#btnSaveClose').onclick = ()=>save(true));

        // Shortcuts
        document.addEventListener('keydown',(e)=>{
          if ((e.ctrlKey||e.metaKey) && e.key==='r'){ e.preventDefault(); load(); }
          if ((e.ctrlKey||e.metaKey) && e.key==='e'){ e.preventDefault(); exportCSV(); }
          if ((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); save(false); }
          if (e.key === 'Escape' && drawer?.classList.contains('open')) { e.preventDefault(); closeDrawer(); }
        });

        // ----- go -----
        await load();
        enableDelete();
      });
    })();
  </script>
</body>
</html>
