<!doctype html>
<html lang="en">


<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Candidates — Admin | HMJ Global</title>

  <!-- 1) Netlify Identity widget FIRST (defer keeps parse fast; order is preserved) -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- 1b) Proactive init as soon as the DOM is ready -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try { window.netlifyIdentity && window.netlifyIdentity.init(); } catch (e) {}
    });
  </script>
  <script defer src="/admin-v2/admin/common.js?v=10"></script>

  <style>
    :root{
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#1f3b7a; --blue-2:#29478f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --danger:#dc2626; --ok:#16a34a; --warn:#f59e0b;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    /* Header */
    .top{position:sticky;top:0;z-index:30;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;display:flex;gap:10px;align-items:center}
    .brand a{color:#fff;text-decoration:none;display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;color:var(--blue);display:grid;place-items:center;font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.danger{background:#7a1f28;border-color:#a42e3b}
    /* Page */
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bar .sp{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--stroke);border-radius:10px;padding:10px}
    input:focus,select:focus,textarea:focus{outline:3px solid var(--ring);outline-offset:2px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--stroke);text-align:left}
    th{font-size:14px;color:#334155}
    .pill{display:inline-grid;align-items:center;padding:3px 8px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    /* Drawer */
    .drawer{position:fixed;inset:0;display:none;background:rgba(2,6,23,.44);z-index:40}
    .drawer .panel{position:absolute;right:0;top:0;bottom:0;width:820px;max-width:100%;background:#fff;border-left:1px solid var(--stroke);padding:16px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .twocol{grid-template-columns:1fr} }
    .section{margin:12px 0 6px;font-weight:800}
  </style>
</head>





<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Candidates</span>
    </div>
    <div class="sp"></div>
    <div id="diagChips" class="chips"></div>
    <a class="btn ghost" href="./">⟵ Admin</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <div class="card bar">
      <input id="q" placeholder="Search name, email, ref…" style="min-width:260px">
      <select id="status">
        <option value="">Status: any</option>
        <option>active</option><option>inactive</option><option>archived</option>
      </select>
      <button class="btn" id="btnRefresh">Refresh</button>
      <div class="sp"></div>
      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost" id="btnExport">Export CSV</button>
      <button class="btn ghost" id="btnImport">Import CSV</button>
      <button class="btn" id="btnNew">+ New candidate</button>
      <button class="btn danger" id="btnDelete" disabled>Delete</button>
    </div>

    <div class="card" id="listWrap">Loading…</div>
  </div>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- 3) Page script LAST. Boot only when Admin exists. -->
  
  

  <script>
/* candidates page boot — robust + noisy
   Requirements on the page:
   - #gate (with .why inside) and #app containers
   - #listWrap, #q, #status, #btnRefresh, #btnDelete, #btnNew, #btnExport, #btnImport, #csv
   - optional #diagChips (for chips line)
*/
(function bootCandidates() {
  // --- tiny helpers ---------------------------------------------------------
  const $ = (s, r=document) => r.querySelector(s);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function showGate(msg) {
    const g = $('#gate'), app = $('#app');
    if (app) app.style.display = 'none';
    if (g) g.style.display = '';
    const why = g && g.querySelector('.why');
    if (why) why.textContent = msg || 'Sign in required.';
  }
  function hardFail(msg) {
    console.error('[candidates] ' + msg);
    showGate(msg);
    alert('Admin bootstrap failed:\n' + msg + '\n\nCheck that /admin-v2/admin/common.js loads and there are no 404s.');
  }

  // --- wait for deps: Identity + common.js (Admin.bootAdmin) ----------------
  async function waitDeps(maxMs = 6000) {
    const start = Date.now();
    while (Date.now() - start < maxMs) {
      const hasId = !!window.netlifyIdentity;
      const hasAdmin = !!(window.Admin && window.Admin.bootAdmin);
      if (hasId && hasAdmin) return true;
      await sleep(40);
    }
    return false;
  }

  // --- start ----------------------------------------------------------------
  (async () => {
    // Proactively init Identity (safe if already initialised)
    try { window.netlifyIdentity && window.netlifyIdentity.init && window.netlifyIdentity.init(); } catch {}

    const ok = await waitDeps(6500);
    if (!ok) return hardFail('Required scripts not ready (Identity or common.js).');

    // Safety ping in console so we know the state
    console.log('[candidates] deps ready →',
      { hasIdentity: !!window.netlifyIdentity, hasAdmin: !!(window.Admin && window.Admin.bootAdmin) });

    // Boot the page through the shared guard in common.js
    Admin.bootAdmin(async ({ api, sel = $, toast, identity, getTrace }) => {
      // --------- diag chips (optional pretty badges) ----------
      const chips = $('#diagChips');
      const chip = (t, tone='ok') => {
        if (!chips) return;
        const s = document.createElement('span');
        s.className = 'pill ' + (tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
        s.textContent = t; chips.appendChild(s);
      };
      chip('candidates:init', 'ok');

      // Identity snapshot (makes debugging role issues obvious)
      const who = await identity('admin');
      console.log('[candidates] identity snapshot →', who);
      if (!who || !who.ok) {
        chip('role: blocked', 'bad');
        return showGate('Restricted. Sign in with an admin account.');
      }
      chip('role: admin', 'ok');
      chip('trace: ' + getTrace().slice(0,10), 'ok');

      // --------- state ----------
      let rows = [];
      let selected = new Set();

      // --------- ui helpers ----------
      function enableDelete() {
        const b = $('#btnDelete');
        if (b) b.disabled = selected.size === 0;
      }

      function render() {
        const wrap = $('#listWrap');
        if (!wrap) return;

        if (!rows.length) {
          wrap.textContent = 'No candidates found.';
          return;
        }

        const thead = `<thead><tr>
          <th style="width:28px"><input id="ckAll" type="checkbox"></th>
          <th>Ref</th><th>Name</th><th>Email</th><th>Phone</th>
          <th>Status</th><th></th>
        </tr></thead>`;

        const tbody = rows.map(r => `
          <tr>
            <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
            <td>${r.ref || r.id}</td>
            <td>${r.full_name || '—'}</td>
            <td>${r.email || '—'}</td>
            <td>${r.phone || '—'}</td>
            <td><span class="pill ${r.status==='active'?'b-ok':r.status==='inactive'?'b-warn':'b-bad'}">${r.status||'inactive'}</span></td>
            <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
          </tr>`).join('');

        wrap.innerHTML = `<table>${thead}<tbody>${tbody}</tbody></table>`;

        // selection wiring
        const ckAll = $('#ckAll');
        if (ckAll) ckAll.onclick = (e) => {
          if (e.target.checked) rows.forEach(r => selected.add(r.id));
          else rows.forEach(r => selected.delete(r.id));
          enableDelete(); render();
        };
        wrap.querySelectorAll('input[type=checkbox][data-id]').forEach(c => {
          c.onchange = () => {
            const id = Number(c.getAttribute('data-id'));
            if (c.checked) selected.add(id); else selected.delete(id);
            enableDelete();
          };
        });
        wrap.querySelectorAll('[data-open]').forEach(b => {
          b.onclick = () => openOne(Number(b.getAttribute('data-open')));
        });
      }

      // --------- data ops ----------
      async function load() {
        const wrap = $('#listWrap'); if (wrap) wrap.textContent = 'Loading…';
        try {
          const res = await api('admin-candidates-list', 'POST', {
            q: ($('#q')?.value || '').trim(),
            status: $('#status')?.value || ''
          });
          rows = Array.isArray(res) ? res : (res.rows || []);
          console.log('[candidates] list ←', rows.length, 'rows');
          render();
        } catch (e) {
          console.error('[candidates] list error', e);
          if (wrap) wrap.textContent = 'Error: ' + (e.message || e);
        }
      }

      async function openOne(id) {
        try {
          const r = await api('admin-candidate-open', 'POST', { id });
          console.log('[candidates] open ←', r);
          toast('Opened ' + (r.full_name || ('ID ' + id)), 'info', 1800);
          // TODO: drawer/editor
        } catch (e) {
          console.error('[candidates] open error', e);
          toast('Open failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function delSelected() {
        if (!selected.size) return;
        if (!confirm(`Delete ${selected.size} candidate(s)?`)) return;
        try {
          await api('admin-candidate-delete', 'POST', { ids: Array.from(selected) });
          toast('Deleted', 'ok', 1800);
          selected.clear(); enableDelete(); load();
        } catch (e) {
          console.error('[candidates] delete error', e);
          toast('Delete failed: ' + (e.message || e), 'error', 4200);
        }
      }

      // --------- export / import ----------
      async function exportCSV() {
        try {
          const csv = await api('admin-candidates-export','POST', {
            q: ($('#q')?.value || '').trim(),
            status: $('#status')?.value || ''
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'candidates.csv'; a.click();
          URL.revokeObjectURL(url);
          toast('Exported', 'ok', 1400);
        } catch (e) {
          console.error('[candidates] export error', e);
          toast('Export failed: ' + (e.message || e), 'error', 4200);
        }
      }
      function importCSVClick() { $('#csv')?.click(); }
      async function importCSVDo(file) {
        try {
          const text = await file.text();
          const res = await api('admin-candidates-import','POST',{ csv: text });
          toast(`Imported ${res?.inserted ?? 0}`, 'ok', 2000);
          load();
        } catch (e) {
          console.error('[candidates] import error', e);
          toast('Import failed: ' + (e.message || e), 'error', 4200);
        }
      }

      // --------- wire UI ----------
      $('#btnRefresh') && ($('#btnRefresh').onclick = load);
      $('#btnDelete')  && ($('#btnDelete').onclick = delSelected);
      $('#btnNew')     && ($('#btnNew').onclick = () => location.href = './candidate-profile.html');
      $('#btnExport')  && ($('#btnExport').onclick = exportCSV);
      $('#btnImport')  && ($('#btnImport').onclick = importCSVClick);
      $('#csv') && $('#csv').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) importCSVDo(f);
      });
      $('#q') && $('#q').addEventListener('input', () => load());
      $('#status') && $('#status').addEventListener('change', () => load());

      // Shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') { e.preventDefault(); load(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); exportCSV(); }
      });

      // --------- go! ----------
      await load();
      enableDelete();
      console.log('[candidates] boot complete ✓');
    });
  })().catch(err => hardFail(err?.message || String(err)));
})();
</script>

<script>
(function bootWhenReady(){
  // If deps aren’t ready yet (deferred scripts), retry shortly.
  if (!window.Admin || !window.Admin.bootAdmin || !window.netlifyIdentity) {
    return setTimeout(bootWhenReady, 30);
  }

  // Call the framework boot once.
  Admin.bootAdmin(async ({ sel, toast }) => {
    // Optional visual “it worked” proof the first time
    try {
      const chips = document.getElementById('diagChips');
      if (chips) { const s=document.createElement('span'); s.className='pill b-ok'; s.textContent='boot ok'; chips.appendChild(s); }
      toast('Candidates booted ✅', 'info', 1600);
    } catch {}

    // TODO: your page logic will run here (list, open, delete, etc.)
    // If you already have a longer page script, it can stay exactly as-is,
    // just wrap it inside this Admin.bootAdmin block.
  });
})();
</script>




<script>
(function () {
  // loud helper if something blocks the page
  function hardFail(msg){
    console.error('[candidates] ' + msg);
    const g = document.getElementById('gate');
    if (g) { g.style.display=''; const why=g.querySelector('.why'); if (why) why.textContent = msg; }
    alert('Admin bootstrap failed:\n' + msg + '\n\nCheck Network tab for /admin-v2/admin/common.js?v=10.');
  }

  function start() {
    // wait until DOM nodes exist
    if (!document.getElementById('gate') || !document.getElementById('app')) {
      return setTimeout(start, 20);
    }
    // wait until common.js has created Admin
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function') {
      return setTimeout(start, 20);
    }

    try {
      Admin.bootAdmin(async ({ api, sel, toast, identity }) => {
        // quick health chips (optional)
        const host = document.getElementById('diagChips');
        const chip = (t, tone='ok') => {
          if (!host) return;
          const s=document.createElement('span');
          s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
          s.textContent=t; host.appendChild(s);
        };
        chip('candidates: boot', 'ok');

        // ---------- your page wiring ----------
        let rows=[], selected=new Set();
        const enableDelete = ()=> sel('#btnDelete').disabled = selected.size===0;

        function render(){
          if(!rows.length){ sel('#listWrap').textContent='No candidates found.'; return; }
          const head=`<thead><tr>
            <th style="width:28px"><input id="ckAll" type="checkbox"></th>
            <th>Ref</th><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th></th>
          </tr></thead>`;
          const body=rows.map(r=>`
            <tr>
              <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
              <td>${r.ref||r.id}</td>
              <td>${r.full_name||'—'}</td>
              <td>${r.email||'—'}</td>
              <td>${r.phone||'—'}</td>
              <td><span class="pill ${r.status==='active'?'b-ok':r.status==='inactive'?'b-warn':'b-bad'}">${r.status||'inactive'}</span></td>
              <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
            </tr>`).join('');
          sel('#listWrap').innerHTML=`<table>${head}<tbody>${body}</tbody></table>`;
          sel('#ckAll').onclick=(e)=>{ if(e.target.checked){ rows.forEach(r=>selected.add(r.id)); } else { rows.forEach(r=>selected.delete(r.id)); } enableDelete(); render(); };
          sel('#listWrap').querySelectorAll('input[type=checkbox][data-id]').forEach(c=> c.onchange=()=>{ const id=Number(c.getAttribute('data-id')); if(c.checked) selected.add(id); else selected.delete(id); enableDelete(); });
          sel('#listWrap').querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openOne(Number(b.getAttribute('data-open'))));
        }

        async function load(){
          sel('#listWrap').textContent='Loading…';
          try{
            const res = await api('admin-candidates-list','POST',{ q: sel('#q').value||'', status: sel('#status').value||'' });
            rows = res.rows || res || [];
            render();
          }catch(e){ sel('#listWrap').textContent='Error: '+e.message; }
        }

        async function openOne(id){
          try{
            const r = await api('admin-candidate-open','POST',{ id });
            toast('Opened '+(r.full_name||('ID '+id)),'info',2000);
          }catch(e){ toast('Open failed: '+e.message,'error',4000); }
        }

        async function delSelected(){
          if(!selected.size) return;
          if(!confirm(`Delete ${selected.size} candidate(s)?`)) return;
          try{
            await api('admin-candidate-delete','POST',{ ids:[...selected] });
            selected.clear(); enableDelete(); toast('Deleted','ok',1800); load();
          }catch(e){ toast('Delete failed: '+e.message,'error',4000); }
        }

        // UI events
        sel('#btnRefresh').onclick=load;
        sel('#btnDelete').onclick=delSelected;
        sel('#btnNew').onclick=()=> location.href='./candidate-profile.html';
        sel('#btnExport').onclick=async()=>{ try{
          const csv = await api('admin-candidates-export','POST',{ q: sel('#q').value||'', status: sel('#status').value||'' });
          const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
          const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click(); URL.revokeObjectURL(url);
        }catch(e){ toast('Export failed: '+e.message,'error',4000); }};
        sel('#btnImport').onclick=()=> sel('#csv').click();
        sel('#csv').addEventListener('change', async ()=>{
          const f=sel('#csv').files[0]; if(!f) return;
          try{
            const text=await f.text();
            const res=await api('admin-candidates-import','POST',{ csv:text });
            toast(`Imported ${res?.inserted ?? 0}`,'ok',2200); load();
          }catch(e){ toast('Import failed: '+e.message,'error',4000); }
        });
        ['#q','#status'].forEach(s=> sel(s).addEventListener('input', load));

        await load();
      });
    } catch (e) {
      hardFail(e && e.message ? e.message : String(e));
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();
</script>



</body>
</html>
