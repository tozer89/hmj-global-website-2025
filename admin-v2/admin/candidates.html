<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Candidates — Admin | HMJ Global</title>

  <!-- Pin Identity to live site (one way is enough; pick ONE of these) -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>
  <!-- or: <meta name="netlify-identity-url" content="https://hmjg.netlify.app/.netlify/identity"> -->

  <!-- Identity widget FIRST -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared admin bootstrap (single copy; bump when changed) -->
  <script defer src="/admin-v2/admin/common.js?v=14"></script>

  <!-- styles ... -->
</head>

<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Candidates</span>
    </div>
    <div class="sp"></div>
    <div id="diagChips" class="chips"></div>
    <a class="btn ghost" href="./">⟵ Admin</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <div class="card bar">
      <input id="q" placeholder="Search name, email, ref…" style="min-width:260px">
      <select id="status">
        <option value="">Status: any</option>
        <option>active</option><option>inactive</option><option>archived</option>
      </select>
      <button class="btn" id="btnRefresh">Refresh</button>
      <div class="sp"></div>
      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost" id="btnExport">Export CSV</button>
      <button class="btn ghost" id="btnImport">Import CSV</button>
      <button class="btn" id="btnNew">+ New candidate</button>
      <button class="btn danger" id="btnDelete" disabled>Delete</button>
    </div>

    <div class="card" id="listWrap">Loading…</div>
  </div>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Single page boot (no duplicates) -->
  <script>
    (function startCandidates(){
      // Wait until common.js has attached Admin + the identity widget exists
      if (!window.Admin || typeof window.Admin.bootAdmin !== 'function' || !window.netlifyIdentity) {
        return setTimeout(startCandidates, 30);
      }

      // One and only boot path
      Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
        // --- diag chips ---
        const chips = document.getElementById('diagChips');
        const chip = (t, tone='ok') => {
          if (!chips) return;
          const s=document.createElement('span');
          s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
          s.textContent=t; chips.appendChild(s);
        };
        chip('candidates:init','ok');

        // Identity snapshot (helps debug gating)
        const who = await identity('admin');
        if (!who || !who.ok) {
          chip('role: blocked','bad');
          const g = document.getElementById('gate'), app = document.getElementById('app');
          if (app) app.style.display = 'none';
          if (g) { g.style.display = ''; const why=g.querySelector('.why'); if (why) why.textContent='Restricted. Sign in with an admin account.'; }
          return;
        }
        chip('role: admin','ok');
        chip('trace: '+getTrace().slice(0,10),'ok');

        // ----- state -----
        let rows = [];
        let selected = new Set();

        // ----- helpers -----
        const enableDelete = () => { const b=sel('#btnDelete'); if (b) b.disabled = selected.size===0; };

        function render(){
          const wrap = sel('#listWrap');
          if (!wrap) return;

          if (!rows.length) { wrap.textContent = 'No candidates found.'; return; }

          const thead = `<thead><tr>
            <th style="width:28px"><input id="ckAll" type="checkbox"></th>
            <th>Ref</th><th>Name</th><th>Email</th><th>Phone</th>
            <th>Status</th><th></th>
          </tr></thead>`;

          const tbody = rows.map(r => `
            <tr>
              <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
              <td>${r.ref || r.id}</td>
              <td>${r.full_name || '—'}</td>
              <td>${r.email || '—'}</td>
              <td>${r.phone || '—'}</td>
              <td><span class="pill ${r.status==='active'?'b-ok':r.status==='inactive'?'b-warn':'b-bad'}">${r.status||'inactive'}</span></td>
              <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
            </tr>`).join('');

          wrap.innerHTML = `<table>${thead}<tbody>${tbody}</tbody></table>`;

          const ckAll = document.getElementById('ckAll');
          if (ckAll) ckAll.onclick = (e)=>{
            if (e.target.checked) rows.forEach(r=>selected.add(r.id));
            else rows.forEach(r=>selected.delete(r.id));
            enableDelete(); render();
          };

          wrap.querySelectorAll('input[type=checkbox][data-id]').forEach(c=>{
            c.onchange = ()=>{
              const id = Number(c.getAttribute('data-id'));
              if (c.checked) selected.add(id); else selected.delete(id);
              enableDelete();
            };
          });

          wrap.querySelectorAll('[data-open]').forEach(b=>{
            b.onclick = ()=> openOne(Number(b.getAttribute('data-open')));
          });
        }

        // ----- data ops -----
        async function load(){
          const wrap = sel('#listWrap'); if (wrap) wrap.textContent = 'Loading…';
          try{
            const res = await api('admin-candidates-list','POST',{
              q: (sel('#q')?.value || '').trim(),
              status: sel('#status')?.value || ''
            });
            rows = Array.isArray(res) ? res : (res.rows || []);
            render();
          }catch(e){
            console.error('[candidates] list error', e);
            if (wrap) wrap.textContent = 'Error: ' + (e.message || e);
          }
        }

        async function openOne(id){
          try{
            const r = await api('admin-candidate-open','POST',{ id });
            toast('Opened ' + (r.full_name || ('ID ' + id)), 'info', 1800);
            // drawer/editor could be added here
          }catch(e){
            console.error('[candidates] open error', e);
            toast('Open failed: ' + (e.message || e), 'error', 4200);
          }
        }

        async function delSelected(){
          if (!selected.size) return;
          if (!confirm(`Delete ${selected.size} candidate(s)?`)) return;
          try{
            await api('admin-candidate-delete','POST',{ ids: Array.from(selected) });
            toast('Deleted','ok',1800);
            selected.clear(); enableDelete(); load();
          }catch(e){
            console.error('[candidates] delete error', e);
            toast('Delete failed: ' + (e.message || e), 'error', 4200);
          }
        }

        // ----- export/import -----
        async function exportCSV(){
          try{
            const csv = await api('admin-candidates-export','POST',{
              q: (sel('#q')?.value || '').trim(),
              status: sel('#status')?.value || ''
            });
            const blob = new Blob([csv], { type:'text/csv' });
            const url = URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
            URL.revokeObjectURL(url);
            toast('Exported','ok',1400);
          }catch(e){
            console.error('[candidates] export error', e);
            toast('Export failed: ' + (e.message || e), 'error', 4200);
          }
        }
        function importCSVClick(){ sel('#csv')?.click(); }
        async function importCSVDo(file){
          try{
            const text = await file.text();
            const res  = await api('admin-candidates-import','POST',{ csv:text });
            toast(`Imported ${res?.inserted ?? 0}`,'ok',2000);
            load();
          }catch(e){
            console.error('[candidates] import error', e);
            toast('Import failed: ' + (e.message || e), 'error', 4200);
          }
        }

        // ----- wire UI -----
        sel('#btnRefresh') && (sel('#btnRefresh').onclick = load);
        sel('#btnDelete')  && (sel('#btnDelete').onclick  = delSelected);
        sel('#btnNew')     && (sel('#btnNew').onclick     = () => location.href = './candidate-profile.html');
        sel('#btnExport')  && (sel('#btnExport').onclick  = exportCSV);
        sel('#btnImport')  && (sel('#btnImport').onclick  = importCSVClick);
        sel('#csv') && sel('#csv').addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if (f) importCSVDo(f);
        });
        sel('#q')      && sel('#q').addEventListener('input',  () => load());
        sel('#status') && sel('#status').addEventListener('change', () => load());

        // Shortcuts
        document.addEventListener('keydown',(e)=>{
          if ((e.ctrlKey||e.metaKey) && e.key==='r'){ e.preventDefault(); load(); }
          if ((e.ctrlKey||e.metaKey) && e.key==='e'){ e.preventDefault(); exportCSV(); }
        });

        // ----- go -----
        await load();
        enableDelete();
      });
    })();
  </script>
</body>
</html>
