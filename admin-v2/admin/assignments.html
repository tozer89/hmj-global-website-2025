<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Assignments ‚Äî Admin | HMJ Global</title>

  <!-- Make Identity point to the site (same pattern as candidates.html) -->
  <meta name="netlify-identity-url" content="https://hmjg.netlify.app/.netlify/identity"/>

  <!-- Load Identity and the shared Admin bootstrap -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script defer src="/admin-v2/admin/common.js?v=15"></script>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --blue:#1f4c8f;
      --blue-ink:#113465;
      --ok:#16a34a; --warn:#eab308; --bad:#dc2626;
      --shadow:0 1px 2px rgba(2,8,23,.06), 0 8px 24px rgba(2,8,23,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#fff;color:var(--ink);
      font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Inter,Roboto,"Helvetica Neue","Noto Sans",Arial;}
    a{color:var(--blue-ink);text-decoration:none}
    a:hover{text-decoration:underline}
    button:focus-visible, select:focus-visible, input:focus-visible, a:focus-visible{
      outline:3px solid #bfd6ff; outline-offset:2px; border-radius:10px;
    }

    .appbar{position:sticky;top:0;z-index:30;background:#eff4ff;
      border-bottom:1px solid var(--line);box-shadow:0 1px 0 rgba(2,8,23,.04)}
    .appbar .row{display:flex;align-items:center;gap:12px;padding:10px 18px}
    .brand{display:flex;align-items:center;gap:8px;font-weight:800;color:#0b1d3c}
    .brand .logo{width:28px;height:28px;border-radius:7px;background:var(--blue);
      display:inline-grid;place-items:center;color:#fff}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#eaf2ff;color:#0b1d3c;border:1px solid #dbeafe;
      padding:6px 10px;border-radius:999px;font-weight:700}
    .chip.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .chip.warn{background:#fffbeb;border-color:#fde68a;color:#7c5800}
    .chip.bad{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}

    .actions{margin-left:auto;display:flex;gap:10px}
    .btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:hover{box-shadow:var(--shadow)}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.light{background:#f8fafc}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}

    .container{max-width:1200px;margin:0 auto;padding:18px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:18px 0}
    .search{flex:1;min-width:220px;position:relative}
    .search input{width:100%;padding:10px 12px 10px 36px;border:1px solid var(--line);
      border-radius:12px;background:#fff}
    .search .ico{position:absolute;left:10px;top:9px;color:var(--muted)}
    .select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .h{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:800;color:#0b1d3c;background:#f8fafc;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .card .b{padding:12px 14px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;border-bottom:1px solid var(--line)}
    th{font-size:12px;letter-spacing:.04em;text-transform:uppercase;color:var(--muted);background:#f1f5f9}
    tr:hover td{background:#fafafa}

    .status{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}
    .status.live{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .status.complete{background:#f1f5f9;color:#334155;border:1px solid #cbd5e1}
    .status.draft{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}

    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px}
    .kv .k{color:var(--muted)}
    .empty{color:var(--muted)}
    .row-actions{display:flex;gap:8px}
    .table-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}

    dialog#drawer{border:none;max-width:760px;width:96%;border-radius:16px;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(15,23,42,.35)}
    .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;display:none}
  </style>
</head>

<body>
  <!-- Header -->
  <header class="appbar">
    <div class="row">
      <div class="brand">
        <span class="logo">H</span> HMJ Global ‚Äî Admin
      </div>
      <a class="btn light" href="./index.html">‚Üê Dashboard</a>
      <nav id="diagChips" class="chips"></nav>
      <div class="actions">
        <button id="btnRefresh" class="btn">‚Üª Refresh</button>
        <button id="btnNew" class="btn primary">Ôºã New assignment</button>
        <button id="btnDelete" class="btn danger">üóë Delete</button>
        <button id="btnSignOut" class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <div class="toolbar">
      <div class="search">
        <span class="ico">üîç</span>
        <input id="q" placeholder="Search (title, ref, client, candidate)‚Ä¶"/>
      </div>
      <select id="status" class="select" title="Filter status">
        <option value="">All statuses</option>
        <option value="draft">Draft</option>
        <option value="complete">Complete</option>
        <option value="live">Live</option>
        <option value="archived">Archived</option>
      </select>
      <button id="btnRefresh2" class="btn">‚Üª Refresh</button>
    </div>

    <div class="grid">
      <section class="card">
        <div class="h">All assignments <span id="total" class="empty"></span></div>
        <div class="b" style="padding:0">
          <table>
            <thead>
              <tr>
                <th style="width:36px;"></th>
                <th>TITLE</th>
                <th>CLIENT</th>
                <th>CANDIDATE</th>
                <th>DATES</th>
                <th>STATUS</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="7" class="empty" style="padding:26px;text-align:center">Loading‚Ä¶</td></tr>
            </tbody>
          </table>

          <div class="table-footer">
            <div>
              <button id="prev" class="btn">‚Üê Prev</button>
              <button id="next" class="btn">Next ‚Üí</button>
              <span id="pageLabel" class="empty" style="margin-left:8px"></span>
            </div>
            <div>
              <select id="pageSize" class="select">
                <option selected>20</option>
                <option>50</option>
                <option>100</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="h">Quick view ‚Äî Assignment</div>
        <div class="b"><div id="quick" class="empty">Select an assignment to preview details here.</div></div>
        <div class="h">Latest timesheet</div>
        <div class="b"><div id="latestTS" class="empty">Not live ‚Äî no timesheets yet.</div></div>
      </aside>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Drawer -->
  <dialog id="drawer">
    <form method="dialog" id="formNew" style="padding:16px 18px;max-height:80vh;overflow:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">New assignment</h3>
        <button class="btn light" value="cancel">Close</button>
      </div>

      <div style="display:grid;gap:12px">
        <label>Job title *<br/><input id="title" required class="select" style="width:100%"/></label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <label>PO number<br/><input id="po" class="select" style="width:100%"/></label>
          <label>Shift<br/>
            <select id="shift" class="select" style="width:100%">
              <option value="Day">Day</option>
              <option value="Night">Night</option>
            </select>
          </label>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <label>Start date<br/><input id="start" type="date" class="select" style="width:100%"/></label>
          <label>End date<br/><input id="end" type="date" class="select" style="width:100%"/></label>
        </div>
        <div class="kv" style="margin-top:6px">
          <div class="k">Client</div><div><input id="client" class="select" placeholder="Client name / ref"/></div>
          <div class="k">Client site</div><div><input id="site" class="select" placeholder="(optional)"/></div>
          <div class="k">Candidate</div><div><input id="candidate" class="select" placeholder="Assign later is OK"/></div>
          <div class="k">Expected days / hours</div><div><input id="hours" class="select" placeholder="e.g. Mon‚ÄìFri, 40h"/></div>
          <div class="k">Internal notes</div><div><textarea id="notes" class="select" rows="3" placeholder="Internal notes‚Ä¶"></textarea></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button class="btn" value="cancel">Cancel</button>
        <button class="btn primary" id="saveNew" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Page script: wait for Admin, then use a local fetch wrapper (no common.js api header bug) -->
  <script>
    (function bootWhenReady(){
      if (!window.Admin || !window.Admin.bootAdmin) return setTimeout(bootWhenReady, 25);

      Admin.bootAdmin(async (ctx) => {
        const { sel, toast, Debug } = ctx;
        const D = Debug || { chip(){}, ok:console.log, warn:console.warn, err:console.error };

        // ---- Local function caller (bypasses buggy api() header handling) ----
        async function getToken(){
          try{
            const id = window.netlifyIdentity;
            const u = id && id.currentUser ? id.currentUser() : null;
            return u ? await u.jwt() : null;
          }catch(_){ return null; }
        }
        async function fn(name, payload){
          const t = await getToken();
          if (!t){ throw new Error('No identity token'); }
          const res = await fetch(`/.netlify/functions/${name}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${t}`
            },
            body: JSON.stringify(payload||{})
          });
          if (!res.ok){
            const text = await res.text().catch(()=>res.statusText);
            throw new Error(`${res.status} ${res.statusText}: ${text}`);
          }
          return res.json();
        }

        // Diag chips like the candidates page
        const chips = sel('#diagChips');
        const addChip = (t, kind='ok')=>{
          const d = document.createElement('span');
          d.className = 'chip ' + kind; d.textContent = t;
          chips.appendChild(d);
        };
        addChip('init: ok','ok');

        // DOM refs
        const $rows = sel('#rows');
        const $total = sel('#total');
        const $pageLabel = sel('#pageLabel');
        const $q = sel('#q');
        const $status = sel('#status');
        const $pageSize = sel('#pageSize');

        let page = 1;
        let total = 0;
        let pageSize = Number($pageSize.value || 20);
        const selected = new Set();
        let current = null;

        // helpers
        const fDate = x => x ? new Date(x).toLocaleDateString() : '‚Äî';
        const fRange = (a,b) => (!a && !b) ? '‚Äî' : `${fDate(a)} ‚Üí ${fDate(b)}`;
        const pill = s => `<span class="status ${s}">${s}</span>`;
        const setLoading = (m='Loading‚Ä¶') => $rows.innerHTML = `<tr><td colspan="7" class="empty" style="padding:26px;text-align:center">${m}</td></tr>`;

        function renderRows(items){
          if (!items?.length){ setLoading('No assignments found.'); return; }
          $rows.innerHTML = items.map(x=>{
            const live = (x.status||'').toLowerCase()==='live';
            return `
              <tr data-id="${x.id}">
                <td><input type="checkbox" class="rowChk" data-id="${x.id}"/></td>
                <td><a href="#" class="rowLink" data-id="${x.id}">${x.title||'‚Äî'}</a></td>
                <td>${x.client_name||'‚Äî'}</td>
                <td>${x.candidate_name||'‚Äî'}</td>
                <td>${fRange(x.start_date, x.end_date)}</td>
                <td>${pill((x.status||'draft').toLowerCase())}</td>
                <td class="row-actions">
                  <button class="btn light act-open" data-id="${x.id}">Open</button>
                  ${live ? `<a class="btn light" href="./timesheets.html?assignment=${encodeURIComponent(x.id)}">Timesheets</a>` : ''}
                </td>
              </tr>`;
          }).join('');
        }

        async function load(){
          try{
            setLoading();
            const q = $q.value.trim();
            const status = $status.value.trim();
            const res = await fn('admin-assignments-list', { page, pageSize, q, status });
            total = res?.total ?? 0;
            renderRows(res?.items||[]);
            $total.textContent = `(${total} total)`;
            $pageLabel.textContent = `Page ${page}`;
            addChip('token: ok','ok'); // visible proof token worked
            D.ok('assignments:list',{page,pageSize,q,status,total});
          }catch(err){
            D.err('[assignments] list error', err);
            setLoading('Failed to load. Check console for details.');
            toast('Error: failed to load assignments','bad', 5000);
          }
        }

        async function openQuickView(id){
          try{
            current = id;
            const detail = await fn('admin-assignments-detail', { id });
            const live = (detail?.status||'').toLowerCase()==='live';

            sel('#quick').innerHTML = `
              <div class="kv">
                <div class="k">Status</div><div>${pill((detail?.status||'draft').toLowerCase())}</div>
                <div class="k">Client</div><div>${detail?.client_name||'‚Äî'}</div>
                <div class="k">Candidate</div><div>${detail?.candidate_name||'‚Äî'}</div>
                <div class="k">PO number</div><div>${detail?.po_number||'‚Äî'}</div>
                <div class="k">Dates</div><div>${fRange(detail?.start_date, detail?.end_date)}</div>
                <div class="k">Shift</div><div>${detail?.shift||'Day'}</div>
                <div class="k">Expected hrs</div><div>${detail?.estimated_hours||'‚Äî'}</div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <a class="btn light" href="./assignment.html?id=${encodeURIComponent(id)}">Open full assignment</a>
                ${live ? `<a class="btn light" href="./timesheets.html?assignment=${encodeURIComponent(id)}">Open in Timesheets</a>` : ''}
              </div>`;

            if (live){
              try{
                const tsr = await fn('admin-timesheets-list', { assignmentId:id, limit:1 });
                const item = tsr?.items?.[0];
                if (item){
                  sel('#latestTS').innerHTML = `
                    <div class="kv">
                      <div class="k">Week</div><div>${item.week_commencing || '‚Äî'}</div>
                      <div class="k">Hours</div><div>${item.total_hours ?? '‚Äî'}</div>
                      <div class="k">Status</div><div>${pill((item.status||'draft').toLowerCase())}</div>
                    </div>
                    <div style="margin-top:8px">
                      <a class="btn light" href="./timesheets.html?assignment=${encodeURIComponent(id)}">Open in Timesheets</a>
                    </div>`;
                } else {
                  sel('#latestTS').innerHTML = `<div class="empty">No timesheets yet.</div>`;
                }
              }catch(tsErr){
                D.warn('timesheets load failed', tsErr);
                sel('#latestTS').innerHTML = `<div class="empty">Could not load latest timesheet.</div>`;
              }
            } else {
              sel('#latestTS').innerHTML = `<div class="empty">Not live ‚Äî no timesheets yet.</div>`;
            }

            toast('Opened assignment','ok');
          }catch(err){
            D.err('openQuickView error', err);
            toast('Failed to open assignment','bad', 4500);
          }
        }

        // Events
        sel('#btnRefresh').addEventListener('click', ()=>{ page=1; load(); });
        sel('#btnRefresh2').addEventListener('click', ()=>{ page=1; load(); });
        $q.addEventListener('keydown', e => { if(e.key==='Enter'){ page=1; load(); }});
        $status.addEventListener('change', ()=>{ page=1; load(); });
        $pageSize.addEventListener('change', ()=>{ pageSize = Number($pageSize.value||20); page=1; load(); });
        sel('#prev').addEventListener('click', ()=>{ if(page>1){ page--; load(); }});
        sel('#next').addEventListener('click', ()=>{ page++; load(); });

        document.addEventListener('click', (e)=>{
          const open = e.target.closest('.act-open, .rowLink');
          if (open){
            e.preventDefault();
            const id = open.dataset.id || open.closest('tr')?.dataset?.id;
            if (id) openQuickView(id);
          }
          const chk = e.target.classList?.contains('rowChk') ? e.target : null;
          if (chk){
            if (chk.checked) selected.add(chk.dataset.id);
            else selected.delete(chk.dataset.id);
          }
        });

        // Drawer
        const drawer = sel('#drawer');
        sel('#btnNew').addEventListener('click', ()=>drawer.showModal());
        sel('#formNew').addEventListener('submit', async (e)=>{
          e.preventDefault();
          try{
            const payload = {
              title: sel('#title').value.trim(),
              po_number: sel('#po').value.trim(),
              shift: sel('#shift').value,
              start_date: sel('#start').value || null,
              end_date: sel('#end').value || null,
              client: sel('#client').value.trim(),
              client_site: sel('#site').value.trim(),
              candidate: sel('#candidate').value.trim(),
              estimated_hours: sel('#hours').value.trim(),
              notes: sel('#notes').value.trim()
            };
            if (!payload.title){ toast('Job title is required','warn'); return; }
            await fn('admin-assignments-create', payload);
            drawer.close();
            toast('Assignment created','ok');
            page=1; load();
          }catch(err){
            D.err('create error', err);
            toast('Failed to create assignment','bad', 5000);
          }
        });

        // Delete
        sel('#btnDelete').addEventListener('click', async ()=>{
          if (!selected.size){ toast('Select at least one row','warn'); return; }
          if (!confirm(`Delete ${selected.size} assignment(s)?`)) return;
          try{
            await fn('admin-assignments-delete', { ids:[...selected] });
            selected.clear();
            toast('Deleted','ok'); load();
          }catch(err){
            D.err('delete error', err);
            toast('Delete failed','bad', 5000);
          }
        });

        // First load
        await load();
      });
    })();
  </script>
</body>
</html>
