<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Assignments ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- App icon & fonts -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Theme: light base with HMJ blue accents -->
  <style>
    :root{
      --bg: #ffffff;
      --panel: #ffffff;
      --muted: #6b7280;      /* gray-500 */
      --text: #0f172a;       /* slate-900 */
      --line: #e5e7eb;       /* gray-200 */
      --chip: #f3f4f6;       /* gray-100 */
      --accent: #295aa6;     /* HMJ blue (slightly lighter) */
      --accent-600:#1f4a8a;  /* darker hover */
      --accent-100:#e8f0ff;
      --success:#16a34a;
      --warn:#eab308;
      --danger:#dc2626;
      --shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.08);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 16px 80px; }
    header.top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 0 6px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand .logo{
      width:28px; height:28px; display:grid; place-items:center;
      border-radius:7px; background:var(--accent); color:#fff; font-weight:700;
      box-shadow:var(--shadow);
    }
    .brand .title{ font-weight:600; font-size:15px; color:var(--muted); }
    .toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    /* Controls row */
    .controls{
      display:grid; grid-template-columns: 1fr max-content max-content max-content max-content;
      gap:10px; align-items:center; margin-top:12px;
    }
    @media (max-width: 860px){
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
    }
    .search{
      display:flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--line);
      border-radius:10px; padding:10px 12px;
    }
    .search input{
      width:100%; border:0; outline:0; font-size:14px; background:transparent; color:var(--text);
    }
    select, .btn{
      height:38px; border-radius:10px; border:1px solid var(--line); background:#fff; color:var(--text);
      padding:0 12px; font-size:14px;
    }
    .btn{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
    .btn.primary{
      background:var(--accent); color:#fff; border-color:transparent;
    }
    .btn.primary:hover{ background:var(--accent-600); }
    .btn.ghost{ background:#fff; }
    .btn.danger{ background:#fff; color:var(--danger); border-color:#fecaca; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Card & table */
    .card{
      margin-top:14px; background:var(--panel); border:1px solid var(--line);
      border-radius: var(--radius); box-shadow:var(--shadow);
    }
    .card .head{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
    }
    .card .head .subtitle{ font-size:13px; color:var(--muted); }
    .table-wrap{ width:100%; overflow:auto; }
    table{ width:100%; border-collapse: collapse; font-size:14px; }
    thead th{
      text-align:left; font-weight:600; color:#111827; background:var(--accent-100);
      border-bottom:1px solid var(--line); padding:10px 12px; white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line); padding:12px; vertical-align:top;
    }
    tbody tr:hover{ background:#fafafa; }
    .muted{ color:var(--muted); }
    .status{
      display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:600;
      padding:4px 8px; border-radius:999px; background:var(--chip); color:#111827; border:1px solid var(--line);
    }
    .status.complete{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .status.progress{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
    .status.archived{ background:#f3f4f6; color:#374151; }

    .actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .chip{ background:var(--chip); border:1px solid var(--line); padding:3px 8px; border-radius:999px; font-size:12px; color:#111827; }

    .footer{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px;
    }
    .pager{ display:flex; gap:8px; align-items:center; }
    .pill{ border-radius:999px; padding:2px 8px; font-size:12px; background:var(--chip); border:1px solid var(--line); }

    /* Drawer (create/edit) */
    .drawer{
      position:fixed; inset:0; display:none;
      background: rgba(15,23,42,.42); z-index:40;
    }
    .drawer.open{ display:block; }
    .drawer .panel{
      position:absolute; right:0; top:0; height:100%; width:min(640px, 100%);
      background:#fff; border-left:1px solid var(--line); box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }
    .drawer .panel header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:14px 16px; border-bottom:1px solid var(--line);
    }
    .drawer .panel main{ padding:16px; overflow:auto; }
    .drawer .panel footer{
      margin-top:auto; padding:12px 16px; border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    .col-12{ grid-column: span 12 / span 12; }
    .col-6{ grid-column: span 6 / span 6; }
    .col-4{ grid-column: span 4 / span 4; }
    .field label{ display:block; font-size:12px; color:#374151; margin-bottom:6px; }
    .field input, .field select, .field textarea{
      width:100%; height:38px; border-radius:10px; border:1px solid var(--line); padding:8px 10px; font-size:14px;
    }
    .field textarea{ height:92px; resize:vertical; }

    @media (max-width:900px){
      .col-6, .col-4{ grid-column:span 12 / span 12; }
    }

    /* Toast */
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:50; display:flex; flex-direction:column; gap:8px; }
    .toast{ background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); font-size:13px; }
    .toast.warn{ background:#92400e; } .toast.bad{ background:#7f1d1d; } .toast.ok{ background:#065f46; }

    /* Small utilities */
    .sr{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; }
    .hide{ display:none!important; }
  </style>

  <!-- Shared admin helpers (Identity gate + api wrapper + debug UI) -->
  <script defer src="/admin/common.js?v=20"></script>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo">H</div>
        <div class="title">HMJ Global ‚Äî Admin</div>
      </div>
      <div class="toolbar">
        <!-- debug chips are drawn by common.js if enabled -->
      </div>
    </header>

    <h2 style="margin:8px 0 0;font-size:22px;">Assignments</h2>

    <!-- Controls -->
    <div class="controls" id="controls">
      <label class="search">
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21 20.3 16.7 16A7.2 7.2 0 1 0 15.97 16l4.33 4.33a.85.85 0 0 0 1.2-1.2zM4.4 10.8a6.4 6.4 0 1 1 12.8 0a6.4 6.4 0 0 1-12.8 0"/></svg>
        <input id="q" type="search" placeholder="Search (title, ref, client, candidate)..." />
      </label>

      <select id="status">
        <option value="">All statuses</option>
        <option value="In progress">In progress</option>
        <option value="Complete">Complete</option>
        <option value="Archived">Archived</option>
      </select>

      <button class="btn ghost" id="refresh">‚Üª Refresh</button>
      <button class="btn primary" id="new"><span>Ôºã</span> New assignment</button>
      <button class="btn danger" id="delete" disabled>üóë Delete</button>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="head">
        <div class="subtitle">All assignments</div>
        <div class="pill" id="total">0 total</div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead>
          <tr>
            <th style="width:36px;"><input type="checkbox" id="checkAll" aria-label="Select all"/></th>
            <th>TITLE</th>
            <th>CLIENT</th>
            <th>CANDIDATE</th>
            <th>DATES</th>
            <th>STATUS</th>
            <th style="width:160px;">ACTIONS</th>
          </tr>
          </thead>
          <tbody id="tbody">
          <tr><td colspan="7" class="muted" style="text-align:center;padding:24px;">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer">
        <div class="pager">
          <button class="btn" id="prev">‚Üê Prev</button>
          <button class="btn" id="next">Next ‚Üí</button>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <span class="muted" style="font-size:12px;">Page</span>
          <div class="pill" id="pageText">1</div>
          <select id="pageSize">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer: create/edit -->
  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <header>
        <div>
          <div id="drawerTitle" style="font-weight:600;">New assignment</div>
          <div class="muted" id="drawerSub" style="font-size:12px;"></div>
        </div>
        <button class="btn" id="closeDrawer">‚úï</button>
      </header>

      <main>
        <form id="form" class="grid" autocomplete="off">
          <input type="hidden" id="id" />

          <div class="col-12 field">
            <label for="title">Job title *</label>
            <input id="title" required />
          </div>

          <div class="col-6 field">
            <label for="po">PO number</label>
            <input id="po" />
          </div>

          <div class="col-6 field">
            <label for="shift">Shift</label>
            <select id="shift">
              <option>Day</option>
              <option>Night</option>
            </select>
          </div>

          <div class="col-6 field">
            <label for="start">Start date</label>
            <input id="start" type="date" />
          </div>

          <div class="col-6 field">
            <label for="end">End date</label>
            <input id="end" type="date" />
          </div>

          <div class="col-6 field">
            <label for="client">Client</label>
            <select id="client"></select>
          </div>

          <div class="col-6 field">
            <label for="site">Client site</label>
            <select id="site"></select>
          </div>

          <div class="col-6 field">
            <label for="candidate">Candidate</label>
            <select id="candidate"></select>
          </div>

          <div class="col-6 field">
            <label for="hours">Expected days / hours</label>
            <input id="hours" placeholder="e.g. Mon‚ÄìFri, 8‚Äì5" />
          </div>

          <div class="col-12 field">
            <label for="notes">Internal notes</label>
            <textarea id="notes" placeholder="Internal notes‚Ä¶"></textarea>
          </div>
        </form>
      </main>

      <footer>
        <button class="btn" id="cancel">Cancel</button>
        <button class="btn primary" id="save">Save</button>
      </footer>
    </div>
  </div>

  <!-- Toast outlet -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Page logic -->
  <script>
    // Wait for common.js to register the Admin namespace
    window.addEventListener('DOMContentLoaded', () => {
      const start = () => Admin.bootAdmin(async ({ api, sel, toast }) => {
        // ---------------- UI helpers
        const $ = (q, el=document) => el.querySelector(q);
        const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
        const formatDates = (a, b) => {
          const fmt = s => s ? new Date(s).toLocaleDateString() : '‚Äî';
          return `${fmt(a)} ‚Üí ${fmt(b)}`;
        };

        // ---------------- State
        let page=1, pageSize=20, total=0, rows=[], selected=new Set(), current=null, cacheDropdowns=null;
        const state = () => ({ page, pageSize, search: $('#q').value.trim(), status: $('#status').value });

        // ---------------- Elements
        const tbody = $('#tbody'), totalEl = $('#total'), pageText = $('#pageText');
        const btnPrev = $('#prev'), btnNext = $('#next'), btnNew = $('#new'), btnDel = $('#delete');
        const selAll = $('#checkAll'), drawer = $('#drawer');

        // ---------------- Chips + wiring
        const enableDelete = () => btnDel.disabled = (selected.size===0);
        const openDrawer = () => { drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
        const closeDrawer= () => { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); current=null; };

        // ---------------- Dropdown cache (client / site / candidate)
        async function dropdowns() {
          if (cacheDropdowns) return cacheDropdowns;
          const res = await api('/admin-assignments-dropdowns');
          cacheDropdowns = res || { clients:[], clientSites:[], candidates:[] };
          return cacheDropdowns;
        }
        function fillSelect(sel, items, {value='id', label='name', placeholder='Please select‚Ä¶'}={}) {
          sel.innerHTML = '';
          const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent = placeholder; sel.appendChild(opt0);
          for (const it of items) {
            const o = document.createElement('option');
            o.value = it[value]; o.textContent = it[label]; sel.appendChild(o);
          }
        }

        // ---------------- Render table
        function drawRows() {
          tbody.innerHTML = '';
          if (!rows.length) {
            const tr = document.createElement('tr');
            const td = document.createElement('td'); td.colSpan=7; td.className='muted'; td.style.textAlign='center'; td.style.padding='24px'; td.textContent='No assignments found.';
            tr.appendChild(td); tbody.appendChild(tr); return;
          }
          for (const r of rows) {
            const tr = document.createElement('tr');
            const isSel = selected.has(r.id);

            // checkbox
            const td0 = document.createElement('td');
            const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=isSel;
            cb.addEventListener('change', () => { if (cb.checked) selected.add(r.id); else selected.delete(r.id); enableDelete(); });
            td0.appendChild(cb); tr.appendChild(td0);

            // title
            const td1 = document.createElement('td');
            td1.innerHTML = `<div style="font-weight:600">${r.title || '‚Äî'}</div><div class="muted" style="font-size:12px">Ref: ${r.ref || '‚Äî'}</div>`;
            tr.appendChild(td1);

            // client
            const td2 = document.createElement('td');
            td2.textContent = r.client_name || '‚Äî'; tr.appendChild(td2);

            // candidate
            const td3 = document.createElement('td');
            td3.textContent = r.candidate_name || '‚Äî'; tr.appendChild(td3);

            // dates
            const td4 = document.createElement('td');
            td4.textContent = formatDates(r.start_date, r.end_date); tr.appendChild(td4);

            // status
            const td5 = document.createElement('td');
            const st = document.createElement('span'); st.className='status';
            const s = (r.status||'').toLowerCase();
            if (s.includes('complete')) st.classList.add('complete');
            else if (s.includes('progress')) st.classList.add('progress');
            else if (s.includes('arch')) st.classList.add('archived');
            st.textContent = r.status || '‚Äî';
            td5.appendChild(st); tr.appendChild(td5);

            // actions
            const td6 = document.createElement('td'); td6.className='actions';
            const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Edit';
            btnEdit.addEventListener('click', () => edit(r.id));
            const btnView = document.createElement('button'); btnView.className='btn ghost'; btnView.textContent='View';
            btnView.addEventListener('click', () => view(r.id));
            td6.append(btnEdit, btnView); tr.appendChild(td6);

            tbody.appendChild(tr);
          }
        }

        // ---------------- API calls
        async function list() {
          const { search, status } = state();
          const body = { page, pageSize, search, status };
          try {
            const res = await api('/admin-assignments-list', { method:'POST', body });
            rows = res.items || [];
            total = res.total || rows.length;
            totalEl.textContent = `${total} total`;
            pageText.textContent = `${page}`;
            drawRows();
          } catch (e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:24px;">Failed to load.</td></tr>`;
            toast('Could not load assignments', 'bad');
          }
        }

        async function view(id) {
          try {
            const r = await api(`/admin-assignments-get?id=${encodeURIComponent(id)}`);
            // Simple quick view: toast ‚Äì you can swap this to a side-panel
            toast(`Assignment: ${r.title || '‚Äî'} ‚Ä¢ ${r.client_name || '‚Äî'}`, 'info');
          } catch (e){ console.error(e); toast('Could not open assignment', 'bad'); }
        }

        async function edit(id) {
          try {
            const [r, dd] = await Promise.all([
              api(`/admin-assignments-get?id=${encodeURIComponent(id)}`),
              dropdowns()
            ]);
            current = r.id;
            $('#drawerTitle').textContent = 'Edit assignment';
            $('#drawerSub').textContent = `Ref ${r.ref || '‚Äî'}`;
            // fill dropdowns & values
            fillSelect($('#client'), dd.clients, { value:'id', label:'name' });
            fillSelect($('#site'), dd.clientSites, { value:'id', label:'name' });
            fillSelect($('#candidate'), dd.candidates, { value:'id', label:'name' });

            $('#id').value = r.id || '';
            $('#title').value = r.title || '';
            $('#po').value = r.po_number || '';
            $('#shift').value = r.shift || 'Day';
            $('#start').value = r.start_date ? r.start_date.substring(0,10) : '';
            $('#end').value = r.end_date ? r.end_date.substring(0,10) : '';
            $('#client').value = r.client_id || '';
            $('#site').value = r.client_site_id || '';
            $('#candidate').value = r.candidate_id || '';
            $('#hours').value = r.estimated_hours || '';
            $('#notes').value = r.notes || '';

            openDrawer();
          } catch (e){ console.error(e); toast('Could not open editor', 'bad'); }
        }

        async function createNew() {
          try {
            const dd = await dropdowns();
            current = null;
            $('#form').reset();
            $('#drawerTitle').textContent = 'New assignment';
            $('#drawerSub').textContent = '';
            fillSelect($('#client'), dd.clients, { value:'id', label:'name' });
            fillSelect($('#site'), dd.clientSites, { value:'id', label:'name' });
            fillSelect($('#candidate'), dd.candidates, { value:'id', label:'name' });
            $('#shift').value = 'Day';
            openDrawer();
          } catch(e){ console.error(e); toast('Could not start new assignment', 'bad'); }
        }

        async function save() {
          // Validate
          if (!$('#title').value.trim()) { toast('Job title is required', 'warn'); $('#title').focus(); return; }
          const payload = {
            id: $('#id').value || null,
            title: $('#title').value.trim(),
            po_number: $('#po').value.trim() || null,
            shift: $('#shift').value || 'Day',
            start_date: $('#start').value || null,
            end_date: $('#end').value || null,
            client_id: $('#client').value || null,
            client_site_id: $('#site').value || null,
            candidate_id: $('#candidate').value || null,
            estimated_hours: $('#hours').value || null,
            notes: $('#notes').value || null
          };
          try {
            await api('/admin-assignments-save', { method:'POST', body: payload });
            closeDrawer(); toast('Saved', 'ok'); await list();
          } catch (e){ console.error(e); toast('Save failed', 'bad'); }
        }

        async function removeSelected() {
          if (!selected.size) return;
          if (!confirm(`Delete ${selected.size} assignment(s)? This cannot be undone.`)) return;
          try {
            await api('/admin-assignments-delete', { method:'POST', body:{ ids: Array.from(selected) } });
            selected.clear(); enableDelete(); toast('Deleted', 'ok'); await list();
          } catch(e){ console.error(e); toast('Delete failed', 'bad'); }
        }

        // ---------------- Events
        $('#q').addEventListener('input', debounce(() => { page=1; list(); }, 300));
        $('#status').addEventListener('change', () => { page=1; list(); });
        $('#pageSize').addEventListener('change', e => { pageSize = parseInt(e.target.value,10)||20; page=1; list(); });
        btnPrev.addEventListener('click', () => { if (page>1){ page--; list(); } });
        btnNext.addEventListener('click', () => { const max = Math.max(1, Math.ceil(total/pageSize)); if (page<max){ page++; list(); } });
        $('#refresh').addEventListener('click', () => list());
        btnNew.addEventListener('click', () => createNew());
        btnDel.addEventListener('click', () => removeSelected());
        $('#closeDrawer').addEventListener('click', closeDrawer);
        $('#cancel').addEventListener('click', closeDrawer);
        $('#save').addEventListener('click', () => save());
        selAll.addEventListener('change', () => {
          if (selAll.checked) rows.forEach(r => selected.add(r.id));
          else selected.clear();
          enableDelete(); drawRows();
        });

        // click outside panel closes drawer
        drawer.addEventListener('click', (e) => { if (e.target === drawer) closeDrawer(); });

        // simple debounce
        function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

        // Kickoff
        await list();
        toast('ready', 'ok');
      });

      if (window.Admin && typeof Admin.bootAdmin === 'function') {
        start();
      } else {
        // Safety: if common.js loads a tick later
        const t = setInterval(() => {
          if (window.Admin && typeof Admin.bootAdmin === 'function') {
            clearInterval(t); start();
          }
        }, 50);
        setTimeout(()=>clearInterval(t), 5000);
      }
    });
  </script>
</body>
</html>
