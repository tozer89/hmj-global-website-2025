<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Assignments — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Pin the Identity instance (Survival Guide §7.2/7.3) -->
  <script>
    window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';
    window.ADMIN_BUILD = 'preview';          /* helpful in the top-right chips */
  </script>

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer"/>

  <!-- Identity widget (needed for login modal & token refresh hooks) -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared admin bootstrap (!!! correct path) -->
  <script defer src="/admin-v2/admin/common.js?v=11"></script>

  <style>
    :root{
      --hmj-blue:#1f4c8e;         /* lighter, cleaner HMJ blue */
      --hmj-blue-600:#1a4079;
      --hmj-blue-50:#f3f6fb;
      --ink:#1b1f24;
      --muted:#6b7280;
      --line:#e6e8ef;
      --ok:#10b981;               /* green */
      --warn:#f59e0b;             /* amber */
      --bad:#ef4444;              /* red */
      --chip:#eef2ff;
      --bg:#ffffff;               /* more white per your request */
      --card:#ffffff;
      --shadow:0 6px 20px rgba(31,76,142,.08);
      --radius:14px;
    }
    * { box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    /* Top bar */
    .top{
      position:sticky; top:0; z-index:50;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .top-inner{
      max-width:1200px; margin:0 auto;
      padding:14px 16px; display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700; color:var(--hmj-blue);
    }
    .brand .logo{
      width:28px; height:28px; border-radius:8px; background:var(--hmj-blue); display:grid; place-items:center; color:#fff; font-weight:700;
      box-shadow: var(--shadow);
    }
    .top-actions{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-size:12px; background:var(--chip); color:var(--hmj-blue);
      border:1px solid #e0e7ff;
    }
    .signout{
      border:1px solid var(--line); background:#fff; color:var(--ink); padding:7px 12px; border-radius:10px; cursor:pointer;
    }
    .signout:hover{ border-color:#d4d7df }

    /* Page container */
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px }
    .h1{ font-size:22px; font-weight:700; margin:0 0 12px }
    .toolbar{
      display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; margin:12px 0 18px;
    }
    .search{
      display:flex; align-items:center; gap:8px; border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff;
    }
    .search input{ border:0; outline:0; width:100%; font-size:14px }
    .select, .btn{
      border:1px solid var(--line); border-radius:12px; background:#fff; height:40px; padding:0 12px; font-size:14px;
    }
    .btn.primary{
      background:var(--hmj-blue); color:#fff; border-color:transparent; box-shadow:var(--shadow);
    }
    .btn.danger{ background:#fff; color:var(--bad); border:1px solid #fecaca }
    .btn:disabled{ opacity:.5; pointer-events:none }

    /* Card / table */
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .card-head{
      padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between;
    }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#374151; }
    .pill.ok{ background:#ecfdf5; color:#065f46 }
    .pill.warn{ background:#fffbeb; color:#92400e }
    .pill.bad{ background:#fef2f2; color:#991b1b }

    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.03em;
      padding:12px 14px; color:var(--muted); border-bottom:1px solid var(--line);
    }
    tbody td{ padding:14px; border-bottom:1px solid var(--line); vertical-align:top; font-size:14px }
    tbody tr:hover{ background:var(--hmj-blue-50) }
    .row-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }

    /* Pager */
    .pager{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px }
    .muted{ color:var(--muted) }

    /* Drawer */
    .drawer-backdrop{
      position:fixed; inset:0; background:rgba(17,24,39,.4); display:none; z-index:70;
    }
    .drawer{
      position:fixed; right:0; top:0; bottom:0; width:min(560px, 100%); background:#fff; box-shadow:-10px 0 30px rgba(0,0,0,.15);
      transform:translateX(100%); transition:transform .25s ease; z-index:80; display:flex; flex-direction:column;
    }
    .drawer.open + .drawer-backdrop{ display:block }
    .drawer.open{ transform:none }
    .drawer-head{ padding:16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between }
    .drawer-body{ padding:16px; overflow:auto }
    .grid{ display:grid; gap:12px }
    .grid.cols-2{ grid-template-columns: 1fr 1fr }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    .field input, .field select, .field textarea{
      width:100%; border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff;
    }
    .drawer-foot{ padding:12px 16px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end }

    /* Toast */
    #toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); z-index:90; }
    .toast{
      background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); font-size:14px; margin-top:8px;
    }

    /* Mobile */
    @media (max-width: 720px){
      .toolbar{ grid-template-columns:1fr; }
      .grid.cols-2{ grid-template-columns: 1fr }
      thead{ display:none }
      tbody tr{ display:grid; grid-template-columns: 1fr; gap:8px }
      tbody td{ border:0; padding:10px 14px }
      tbody td[data-th]::before{
        content: attr(data-th); display:block; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.03em; margin-bottom:4px;
      }
    }
  </style>
</head>
<body>

  <header class="top">
    <div class="top-inner">
      <div class="brand">
        <div class="logo">H</div>
        <div>HMJ Global — Admin</div>
      </div>
      <div class="top-actions">
        <span class="chip"><i class="fa-solid fa-user-shield"></i><span id="chipRole">role: —</span></span>
        <span class="chip"><i class="fa-regular fa-circle-check"></i><span id="chipToken">token: …</span></span>
        <span class="chip"><i class="fa-solid fa-code-branch"></i><span id="chipBuild">build: preview</span></span>
        <button id="btnSignOut" class="signout">Sign out</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 class="h1">Assignments</h1>

    <div class="toolbar">
      <label class="search" aria-label="Search assignments">
        <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
        <input id="q" placeholder="Search (title, ref, client, candidate)..." />
      </label>

      <select id="status" class="select" title="Filter by status">
        <option value="">All statuses</option>
        <option>in_progress</option>
        <option>complete</option>
        <option>archived</option>
      </select>

      <div style="display:flex; gap:8px; justify-self:end">
        <button id="btnRefresh" class="btn" title="Refresh"><i class="fa-solid fa-rotate"></i>&nbsp;Refresh</button>
        <button id="btnNew" class="btn primary"><i class="fa-solid fa-plus"></i>&nbsp;New assignment</button>
        <button id="btnDelete" class="btn danger" disabled><i class="fa-regular fa-trash-can"></i>&nbsp;Delete</button>
        <button id="btnExport" class="btn" title="Export CSV"><i class="fa-solid fa-file-csv"></i></button>
      </div>
    </div>

    <section class="card">
      <div class="card-head">
        <div><strong>All assignments</strong></div>
        <div class="pill" id="totalPill">0 total</div>
      </div>

      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:36px"><input id="checkAll" type="checkbox" /></th>
              <th>Title</th>
              <th>Client</th>
              <th>Candidate</th>
              <th>Dates</th>
              <th>Status</th>
              <th style="width:220px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="muted" style="padding:24px; text-align:center">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <div style="display:flex; gap:8px">
          <button id="prev" class="btn">&larr; Prev</button>
          <button id="next" class="btn">Next &rarr;</button>
        </div>
        <div class="muted">
          Page <span id="page">1</span>
          &nbsp;&nbsp;
          <select id="pageSize" class="select" style="height:32px">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true" aria-label="Assignment editor">
    <div class="drawer-head">
      <strong id="drawerTitle">New assignment</strong>
      <button id="drawerClose" class="btn">Close</button>
    </div>
    <div class="drawer-body">
      <form id="form" class="grid cols-2">
        <input type="hidden" id="id" />

        <div class="field">
          <label for="title">Job title *</label>
          <input id="title" required />
        </div>

        <div class="field">
          <label for="po">PO number</label>
          <input id="po" maxlength="50" />
        </div>

        <div class="field">
          <label for="start">Start date</label>
          <input id="start" type="date" />
        </div>

        <div class="field">
          <label for="end">End date</label>
          <input id="end" type="date" />
        </div>

        <div class="field">
          <label for="client_id">Client</label>
          <select id="client_id"></select>
        </div>

        <div class="field">
          <label for="client_site_id">Client site</label>
          <select id="client_site_id"></select>
        </div>

        <div class="field">
          <label for="candidate_id">Candidate</label>
          <select id="candidate_id"></select>
        </div>

        <div class="field">
          <label for="shift">Shift</label>
          <select id="shift">
            <option value="Day">Day</option>
            <option value="Night">Night</option>
          </select>
        </div>

        <div class="field">
          <label for="expected_hours">Expected days / hours</label>
          <input id="expected_hours" placeholder="e.g. Mon–Fri, 08:00–17:00" />
        </div>

        <div class="field" style="grid-column:1/-1">
          <label for="notes">Internal notes</label>
          <textarea id="notes" rows="4" placeholder="Internal notes…"></textarea>
        </div>
      </form>
    </div>
    <div class="drawer-foot">
      <button id="btnSave" class="btn primary"><i class="fa-solid fa-floppy-disk"></i>&nbsp;Save</button>
      <button id="btnCancel" class="btn">Cancel</button>
    </div>
  </aside>
  <div id="drawerBackdrop" class="drawer-backdrop"></div>

  <!-- Toast area -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  // ---------- tiny helpers ----------
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const toast = (t, tone='info', ms=2200) => {
    const host = $('#toast');
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = t;
    host.appendChild(el);
    setTimeout(()=>el.remove(), ms);
  };
  const pill = (t, tone='') => {
    const span = document.createElement('span');
    span.className = 'pill' + (tone ? ' '+tone : '');
    span.textContent = t;
    return span;
  };
  const fmtDate = (iso) => (iso ? new Date(iso).toLocaleDateString() : '—');

  // ---------- page script ----------
  // This entire page runs inside the common bootstrap so we have:
  //  - Identity, role chips, token countdown
  //  - api(path, method, body) helper with Authorization header
  //  - gate() logic
  document.addEventListener('DOMContentLoaded', () => {
    // Wait until common.js is definitely there
    const waitForAdmin = async () => {
      let tries=0;
      while(!window.Admin && tries<80){ tries++; await sleep(50); }
      if(!window.Admin){ console.error('common.js missing'); toast('Boot error: common.js not found', 'bad', 3500); return; }

      Admin.bootAdmin(async ({ api, sel, toast:adminToast }) => {
        // chips
        $('#chipBuild').textContent = `build: ${window.ADMIN_BUILD || '—'}`;
        const who = await Admin.getIdentity(); // safe helper from common.js
        $('#chipRole').textContent = who?.role ? `role: ${who.role}` : 'role: —';
        $('#chipToken').textContent = who?.token_left ? `token: ${who.token_left}s left` : 'token: ok';

        // signout
        $('#btnSignOut').onclick = () => {
          if (window.netlifyIdentity && typeof netlifyIdentity.logout === 'function'){
            netlifyIdentity.logout();
          } else {
            location.href = '/admin-v2/admin/';
          }
        };

        // state
        let page=1, pageSize=20, total=0, rows=[];
        let selected = new Set();

        const enableDelete = () => { $('#btnDelete').disabled = (selected.size===0); };
        $('#btnDelete').disabled = true;

        // events
        $('#q').addEventListener('input', () => debounceLoad());
        $('#status').addEventListener('change', () => load());
        $('#btnRefresh').addEventListener('click', () => load());
        $('#btnNew').addEventListener('click', () => openDrawer());
        $('#btnExport').addEventListener('click', async () => {
          const res = await api('admin-assignments-export','POST',{ q: $('#q').value.trim(), status: $('#status').value });
          if (res?.ok && res.body){
            const blob = new Blob([res.body], { type:'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'),{ href:url, download:'assignments.csv' });
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
          } else {
            toast('Export failed','bad',3000);
          }
        });

        $('#prev').onclick = () => { if(page>1){ page--; load(); } };
        $('#next').onclick = () => { if(rows.length===pageSize){ page++; load(); } };
        $('#pageSize').onchange = () => { pageSize = Number($('#pageSize').value); page = 1; load(); };

        $('#checkAll').onchange = (e) => {
          if (!rows || !rows.length) return;
          selected.clear();
          if (e.target.checked) rows.forEach(r => selected.add(r.id));
          $$('#rows input[type=checkbox]').forEach(cb => cb.checked = e.target.checked);
          enableDelete();
        };

        $('#btnDelete').onclick = async () => {
          if (!selected.size) return;
          if (!confirm(`Delete ${selected.size} assignment(s)?`)) return;
          const ids = Array.from(selected);
          const res = await api('admin-assignments-delete','POST',{ ids });
          if (res?.ok){ toast('Deleted'); selected.clear(); $('#checkAll').checked=false; load(); }
          else toast('Delete failed','bad',3000);
        };

        // drawer controls
        const openDrawer = async (id=null) => {
          $('#drawer').classList.add('open'); $('#drawer').setAttribute('aria-hidden','false'); $('#drawerBackdrop').style.display='block';
          $('#drawerTitle').textContent = id ? 'Edit assignment' : 'New assignment';
          $('#form').reset(); $('#id').value = id || '';

          // load select lists (clients, sites, candidates)
          await preloadLookups();

          if (id){
            const res = await api('admin-assignment-get','POST',{ id });
            if(res?.ok && res.body){
              const a = res.body;
              $('#id').value = a.id || '';
              $('#title').value = a.title || '';
              $('#po').value = a.po || '';
              $('#start').value = a.start_date ? a.start_date.substring(0,10) : '';
              $('#end').value = a.end_date ? a.end_date.substring(0,10) : '';
              $('#client_id').value = a.client_id || '';
              await reloadClientSites(); // keep site list in sync
              $('#client_site_id').value = a.client_site_id || '';
              $('#candidate_id').value = a.candidate_id || '';
              $('#shift').value = a.shift || 'Day';
              $('#expected_hours').value = a.expected_hours || '';
              $('#notes').value = a.notes || '';
            }
          }
        };
        const closeDrawer = () => {
          $('#drawer').classList.remove('open'); $('#drawer').setAttribute('aria-hidden','true'); $('#drawerBackdrop').style.display='none';
        };
        $('#drawerBackdrop').onclick = closeDrawer;
        $('#drawerClose').onclick = closeDrawer;
        $('#btnCancel').onclick = closeDrawer;

        $('#client_id').addEventListener('change', reloadClientSites);

        async function preloadLookups(){
          // You likely already have these functions in your codebase.
          // If not, wire to your existing list endpoints or include in assignment-list response.
          const [clients, candidates] = await Promise.all([
            api('admin-clients-list','POST',{ all:true }),
            api('admin-candidates-lists','POST',{ all:true })
          ]);

          // populate clients
          const clientSel = $('#client_id');
          clientSel.innerHTML = '<option value="">Please select…</option>';
          (clients?.body||[]).forEach(c => {
            const o = document.createElement('option'); o.value=c.id; o.textContent=c.name; clientSel.appendChild(o);
          });

          // populate candidates
          const candSel = $('#candidate_id');
          candSel.innerHTML = '<option value="">Please select…</option>';
          (candidates?.body||[]).forEach(c => {
            const o = document.createElement('option'); o.value=c.id; o.textContent=`${c.first_name ?? ''} ${c.last_name ?? ''}`.trim(); candSel.appendChild(o);
          });
        }

        async function reloadClientSites(){
          const cid = $('#client_id').value;
          const siteSel = $('#client_site_id');
          siteSel.innerHTML = '<option value="">Please select…</option>';
          if(!cid) return;
          const res = await api('admin-client-sites-list','POST',{ client_id: cid });
          (res?.body||[]).forEach(s=>{
            const o = document.createElement('option'); o.value=s.id; o.textContent=s.name; siteSel.appendChild(o);
          });
        }

        $('#btnSave').onclick = async () => {
          const payload = {
            id: $('#id').value || null,
            title: $('#title').value.trim(),
            po: $('#po').value.trim(),
            start_date: $('#start').value || null,
            end_date: $('#end').value || null,
            client_id: $('#client_id').value || null,
            client_site_id: $('#client_site_id').value || null,
            candidate_id: $('#candidate_id').value || null,
            shift: $('#shift').value || 'Day',
            expected_hours: $('#expected_hours').value.trim(),
            notes: $('#notes').value.trim(),
          };
          if(!payload.title){ toast('Title is required','bad',2500); $('#title').focus(); return; }

          const res = await api('admin-assignments-save','POST', payload);
          if (res?.ok){ toast('Saved'); closeDrawer(); load(); }
          else toast('Save failed','bad',3000);
        };

        let debounceTimer;
        const debounceLoad = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(load, 280); };

        async function load(){
          $('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="padding:24px; text-align:center">Loading…</td></tr>`;
          $('#checkAll').checked = false; selected.clear(); enableDelete();

          const res = await api('admin-assignments-list','POST',{
            q: $('#q').value.trim(),
            status: $('#status').value,
            page, pageSize
          });

          if(!res?.ok){ $('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="padding:24px; text-align:center">Failed to load</td></tr>`; return; }

          rows = res.body?.rows || [];
          total = Number(res.body?.total || 0);
          $('#page').textContent = String(page);
          $('#totalPill').textContent = `${total} total`;

          if(!rows.length){
            $('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="padding:24px; text-align:center">No results</td></tr>`;
            return;
          }

          const frag = document.createDocumentFragment();
          rows.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td data-th="">
                <input type="checkbox" data-id="${r.id}">
              </td>
              <td data-th="Title">
                <div style="font-weight:600">${r.title ?? '—'}</div>
                <div class="muted" style="font-size:12px">${r.po ? 'PO '+r.po : '—'}</div>
              </td>
              <td data-th="Client">${r.client_name ?? '—'}</td>
              <td data-th="Candidate">${r.candidate_name ?? '—'}</td>
              <td data-th="Dates">${fmtDate(r.start_date)} – ${fmtDate(r.end_date)}</td>
              <td data-th="Status">
                ${(() => {
                  const s = (r.status || '').toLowerCase();
                  const span = pill(s || '—', s==='complete' ? 'ok' : s==='in_progress' ? 'warn' : '');
                  return span.outerHTML;
                })()}
              </td>
              <td data-th="Actions">
                <div class="row-actions">
                  <button class="btn" data-open="${r.id}"><i class="fa-regular fa-pen-to-square"></i>&nbsp;Open</button>
                  <button class="btn" data-copy="${r.id}"><i class="fa-regular fa-clone"></i>&nbsp;Duplicate</button>
                </div>
              </td>
            `;
            frag.appendChild(tr);
          });
          $('#rows').innerHTML = '';
          $('#rows').appendChild(frag);

          // wire row checkboxes and actions
          $$('#rows input[type=checkbox]').forEach(cb=>{
            cb.onchange = (e) => {
              const id = e.target.getAttribute('data-id');
              if(e.target.checked) selected.add(id); else selected.delete(id);
              enableDelete();
            };
          });
          $$('#rows [data-open]').forEach(btn=>{
            btn.onclick = () => openDrawer(btn.getAttribute('data-open'));
          });
          $$('#rows [data-copy]').forEach(btn=>{
            btn.onclick = async () => {
              const id = btn.getAttribute('data-copy');
              const res = await api('admin-assignment-get','POST',{ id });
              if(res?.ok && res.body){
                const a = res.body;
                a.id = null; a.title = a.title ? `${a.title} (copy)` : 'New assignment';
                const save = await api('admin-assignments-save','POST', a);
                if(save?.ok){ toast('Duplicated'); load(); }
                else toast('Duplicate failed','bad',3000);
              }
            };
          });
        }

        // initial load
        await load();
      });
    };

    waitForAdmin();
  });
  </script>
</body>
</html>
