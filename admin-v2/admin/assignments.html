<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Assignments — Admin | HMJ Global</title>

  <!-- Identity (pin to live URL so Deploy Previews still auth correctly) -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared Admin bootstrap + helpers -->
  <script defer src="/admin-v2/admin/common.js?v=15"></script>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --bg:#ffffff;
      --blue:#1f3b7a; --blue-2:#29478f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:50;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1400px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .brand a{display:inline-flex;gap:8px;align-items:center;color:#fff;text-decoration:none}
    .logo{width:28px;height:28px;border-radius:6px;background:#fff;display:grid;place-items:center;color:var(--blue);font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;user-select:none}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px}
    .btn.danger{background:#7a1f28;border-color:#7a1f28}
    .btn.icon{display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
    .wrap{max-width:1400px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .bar{position:sticky;top:64px;z-index:45;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=text],input[type=search],input[type=date],select,textarea{
      border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;min-width:160px;font:inherit
    }
    input[type=search]{min-width:280px}
    table{border-collapse:separate;border-spacing:0;width:100%;background:#fff;border:1px solid var(--stroke);border-radius:14px;overflow:hidden}
    thead th{position:sticky;top:0;background:#fbfdff;border-bottom:1px solid var(--stroke);text-align:left;padding:10px 12px;font-weight:800}
    tbody td{border-top:1px solid var(--stroke);padding:10px 12px;vertical-align:middle}
    tbody tr:hover{background:#f8fafc}
    .muted{color:var(--muted)}
    .pill{display:inline-grid;align-items:center;padding:4px 10px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:9999px;border:1px solid var(--stroke);cursor:pointer;background:#fff;font-weight:700}
    .chip.active{background:var(--chip)}
    .metrics{display:flex;gap:12px;flex-wrap:wrap}
    .metric{background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-weight:800}
    .menu{position:relative}
    .menu>.sheet{display:none;position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--stroke);border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,.18);min-width:220px;padding:8px}
    .menu.open>.sheet{display:block}
    .sheet label{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .sheet label:hover{background:#f8fafc}
    .grid-main{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
    @media (max-width:1100px){.grid-main{grid-template-columns:1fr}}
    .qv{position:sticky;top:116px;background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:14px;min-height:120px}
    .qv h4{margin:0 0 8px}
    .qv .rows{display:grid;grid-template-columns:1fr;gap:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px}
    .kv b{color:#334155}
    .drawer{position:fixed;inset:0 0 0 auto;max-width:760px;width:95vw;background:#fff;box-shadow:-4px 0 24px rgba(2,6,23,.24);transform:translateX(100%);transition:transform .24s ease;z-index:60;display:grid;grid-template-rows:auto 1fr auto}
    .drawer.open{transform:translateX(0)}
    .d-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--stroke);background:var(--card)}
    .d-body{padding:16px;overflow:auto}
    .d-foot{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--stroke);background:#fff}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 12px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:#fff;cursor:pointer;font-weight:700}
    .tab.active{background:var(--chip)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .field{display:grid;gap:6px}
    .field label{font-weight:700;font-size:13px}
    .hr{height:1px;background:var(--stroke);margin:8px 0 4px}
    .right{display:flex;gap:8px;align-items:center}
    .link{color:var(--blue);text-decoration:underline;cursor:pointer}
    :focus{outline:3px solid var(--ring);outline-offset:2px;border-radius:8px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    /* small cards on phones */
    @media (max-width:640px){
      .table-card{border:1px solid var(--stroke);border-radius:14px;overflow:hidden}
      .rowcard{display:grid;grid-template-columns:1fr;gap:8px;padding:12px;border-top:1px solid var(--stroke)}
      .rowcard:first-child{border-top:none}
      .rowcard b{font-weight:800}
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Assignments</span>
    </div>
    <div class="sp"></div>
    <a class="btn ghost small" href="/index.html">← Website</a>
    <div id="diagChips" class="chips"></div>
    <a class="btn ghost" href="./">⟵ Dashboard</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <p class="muted" style="margin:0 0 10px">
      <strong>Assignments overview.</strong> This page lists all current and past assignments with client, candidate,
      and contract dates. Use the search bar to filter by job title, client, or candidate name. Status tags such as
      <em>Live</em> or <em>Complete</em> update automatically from the Timesheets system.
      <br><small>Tip: press <b>Enter</b> in the search box to run a quick filter. Click a row to open the <em>Quick view</em>.</small>
    </p>

    <!-- toolbar -->
    <div class="card bar">
      <input id="q" type="search" placeholder="Search (title, ref, client, candidate)… — press Enter"/>
      <select id="statusSel" aria-label="Status filter">
        <option value="">All statuses</option>
        <option>live</option>
        <option>draft</option>
        <option>pending</option>
        <option>complete</option>
        <option>closed</option>
      </select>
      <button class="btn small ghost" id="btnRefresh">⟲ Refresh</button>

      <div class="sp"></div>

      <div class="menu" id="colMenu">
        <button class="btn ghost small icon" id="btnCols">Columns ▾</button>
        <div class="sheet" id="colSheet"></div>
      </div>

      <button class="btn small" id="btnNew">+ New</button>
      <button class="btn danger small" id="btnDelete" disabled>Delete</button>
    </div>

    <!-- quick metrics -->
    <div class="metrics" id="metrics"></div>

    <!-- grid -->
    <div class="grid-main">
      <div>
        <div class="card" id="listWrap">Loading assignments…</div>
        <div class="pager" id="pager" style="display:none">
          <div class="muted" id="pgInfo"></div>
          <div class="sp"></div>
          <select id="pgSize">
            <option>20</option><option>50</option><option>100</option>
          </select>
          <button class="btn small ghost" id="pgPrev">◀</button>
          <button class="btn small ghost" id="pgNext">▶</button>
        </div>
        <p class="muted" style="margin:8px 0 0">
          <small>Use ←/→ or the buttons to page. Defaults to newest first.</small>
        </p>
      </div>

      <aside class="qv" id="qv" aria-live="polite">
        <h4 class="muted">Quick view — Assignment</h4>
        <div class="rows" id="qvRows">
          <div class="empty">Select an assignment to preview details here.</div>
        </div>
        <div class="hr"></div>
        <div class="right">
          <a id="qvOpenCandidate" class="btn small" href="#" style="display:none">Open candidate</a>
          <button id="qvEdit" class="btn ghost small" style="display:none">Edit</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Drawer editor -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <strong id="dTitle">New assignment</strong>
      <span class="sp"></span>
      <button class="btn ghost small" id="btnClose">✕ Close</button>
    </div>
    <div class="d-body">
      <div class="tabs" id="tabs"></div>
      <form id="frm" class="grid" autocomplete="off"></form>
    </div>
    <div class="d-foot">
      <div class="muted">Ref: <span id="dRef">—</span></div>
      <div class="right">
        <button class="btn ghost" id="btnSaveDraft" type="button">Save</button>
        <button class="btn" id="btnSaveClose" type="button">Save & Close</button>
      </div>
    </div>
  </aside>

  <!-- Toast host (from common.js) -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function startAssignments(){
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function' || !window.netlifyIdentity) {
      return setTimeout(startAssignments, 30);
    }

    Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
      const $ = sel;

      // ---- diag chips ----
      const chips = $('#diagChips');
      const chip = (t, tone='ok')=>{
        if (!chips) return;
        const s=document.createElement('span');
        s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
        s.textContent=t; chips.appendChild(s);
      };
      chip('init: ok');

      const who = await identity('admin');
      if (!who || !who.ok) {
        chip('identity: blocked','bad');
        const g = $('#gate'), app = $('#app');
        if (app) app.style.display='none';
        if (g) { g.style.display=''; const why=g.querySelector('.why'); if (why) why.textContent='Restricted. Sign in with an admin account.'; }
        return;
      }
      chip('identity: ok'); chip('role: admin','ok'); chip('token: ok','ok'); chip('trace: '+getTrace().slice(0,10),'ok');

      // ---- state ----
      let rows = [];           // current page
      let total = 0;
      let selected = new Set();
      let sort = { key:'created_at', dir:'desc' };
      let page = 1, pageSize = 20;
      let activeStatus = '';
      let editing = null;      // current assignment object loaded to drawer
      let currentTab = 'Basics';

      // ---- columns ----
      const columns = [
        { key:'as_ref',       label:'REF',     show:true,  width:'100px' },
        { key:'job_title',    label:'TITLE',   show:true },
        { key:'client_name',  label:'CLIENT',  show:true },
        { key:'candidate_name',label:'CANDIDATE',show:true },
        { key:'dates',        label:'DATES',   show:true, width:'220px' },
        { key:'status',       label:'STATUS',  show:true, width:'120px' },
      ];

      function pillStatus(s){
        const v=(s||'').toLowerCase();
        const tone = v==='live' ? 'b-ok' : v==='complete' ? 'b-ok' : v==='pending' || v==='draft' ? 'b-warn' : 'b-bad';
        return `<span class="pill ${tone}">${s||'—'}</span>`;
      }
      function fmtDate(d){ try{ return new Date(d).toISOString().slice(0,10); }catch{ return d||'—'; } }

      // ---- column menu ----
      function buildColMenu(){
        const host = $('#colSheet'); host.innerHTML='';
        columns.forEach((c,i)=>{
          const id='col_'+c.key;
          const row=document.createElement('label');
          row.innerHTML = `<input type="checkbox" id="${id}" ${c.show?'checked':''}/> ${c.label}`;
          row.querySelector('input').onchange = (e)=>{ columns[i].show=e.target.checked; render(); };
          host.appendChild(row);
        });
        const menu=$('#colMenu');
        $('#btnCols').onclick=()=>menu.classList.toggle('open');
        document.addEventListener('click',(e)=>{ if(!menu.contains(e.target)) menu.classList.remove('open'); });
      }

      // ---- list rendering ----
      function headerHtml(){
        const h=[];
        h.push(`<th style="width:28px"><input id="ckAll" type="checkbox" ${rows.length && selected.size>=rows.length?'checked':''}></th>`);
        columns.forEach(c=>{
          if(!c.show) return;
          const arrow = sort.key===c.key ? (sort.dir==='asc'?'▲':'▼') : '';
          h.push(`<th style="${c.width?`width:${c.width}`:''};cursor:pointer" data-sort="${c.key}">${c.label} ${arrow}</th>`);
        });
        h.push(`<th style="width:140px"></th>`);
        return `<thead><tr>${h.join('')}</tr></thead>`;
      }

      function computeMetrics(){
        const by = k => rows.filter(r => (r.status||'').toLowerCase()===k).length;
        $('#metrics').innerHTML = `
          <div class="metric">Page items: ${rows.length}</div>
          <div class="metric">Total (all): ${total}</div>
          <div class="metric">Live: ${by('live')}</div>
          <div class="metric">Draft/Pending: ${by('draft') + by('pending')}</div>
          <div class="metric">Complete: ${by('complete')}</div>
        `;
      }

      function render(){
        const wrap = $('#listWrap');
        computeMetrics();

        if (!rows.length) {
          wrap.innerHTML = `<div class="empty">No assignments found. Try clearing filters or pressing Refresh.</div>`;
          renderPager();
          return;
        }

        // sort client-side for the page (API already returns newest first)
        rows.sort((a,b)=>{
          const va = a[sort.key] ?? '';
          const vb = b[sort.key] ?? '';
          if (va==vb) return 0;
          return (va>vb?1:-1) * (sort.dir==='asc'?1:-1);
        });

        const body = rows.map(r=>{
          const cells=[];
          const id = r.id;

          const dates = (r.start_date?fmtDate(r.start_date):'—') + ' — ' + (r.end_date?fmtDate(r.end_date):'open');
          const clientLink = r.client_name
            ? `<a class="link" href="/admin-v2/admin/clients.html?q=${encodeURIComponent(r.client_name)}" target="_blank" rel="noopener">${r.client_name}</a>`
            : '—';

          let candCell = r.candidate_name || '—';
          if (r.candidate_id) {
            candCell = `<a class="link" href="/admin-v2/admin/candidate-profile.html?id=${encodeURIComponent(r.candidate_id)}" target="_blank" rel="noopener">${r.candidate_name||'Candidate'}</a>`;
          } else if (r.candidate_name) {
            candCell = `<a class="link" href="/admin-v2/admin/candidates.html?q=${encodeURIComponent(r.candidate_name)}" target="_blank" rel="noopener">${r.candidate_name}</a>`;
          }

          cells.push(`<td><input type="checkbox" data-id="${id}" ${selected.has(id)?'checked':''}></td>`);
          columns.forEach(c=>{
            if(!c.show) return;
            let v='—';
            if (c.key==='as_ref') v=r.as_ref||r.po_ref||('AS-'+id);
            else if (c.key==='job_title') v=r.job_title||'—';
            else if (c.key==='client_name') v=clientLink;
            else if (c.key==='candidate_name') v=candCell;
            else if (c.key==='dates') v=dates;
            else if (c.key==='status') v=pillStatus(r.status||'');
            else v=r[c.key] ?? '—';
            cells.push(`<td>${v}</td>`);
          });
          cells.push(`<td>
            <button class="btn ghost small" data-open="${id}">Open</button>
            <button class="btn ghost small" data-quick="${id}">Quick view</button>
          </td>`);
          return `<tr data-row="${id}">${cells.join('')}</tr>`;
        }).join('');

        wrap.innerHTML = `<table>${headerHtml()}<tbody>${body}</tbody></table>`;

        // header wires
        wrap.querySelectorAll('th[data-sort]').forEach(th=>{
          th.onclick = ()=>{
            const k=th.getAttribute('data-sort');
            if (sort.key===k) sort.dir=(sort.dir==='asc'?'desc':'asc'); else { sort.key=k; sort.dir='asc'; }
            render();
          };
        });
        const ckAll = $('#ckAll');
        if (ckAll) ckAll.onclick = (e)=>{
          const ids = rows.map(r=>r.id);
          if (e.target.checked) ids.forEach(id=>selected.add(id)); else ids.forEach(id=>selected.delete(id));
          enableDelete(); render();
        };

        // row wires
        wrap.querySelectorAll('input[type=checkbox][data-id]').forEach(c=>{
          c.onchange=()=>{
            const id=Number(c.getAttribute('data-id'));
            if (c.checked) selected.add(id); else selected.delete(id);
            enableDelete();
          };
        });
        wrap.querySelectorAll('[data-open]').forEach(b=>{
          b.onclick=()=>openOne(Number(b.getAttribute('data-open')));
        });
        wrap.querySelectorAll('[data-quick]').forEach(b=>{
          b.onclick=(e)=>{ e.stopPropagation(); quick(Number(b.getAttribute('data-quick'))); };
        });

        renderPager();
      }

      function renderPager(){
        const host = $('#pager');
        if (!total){ host.style.display='none'; return; }
        host.style.display='';
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        $('#pgInfo').textContent = `Page ${page} of ${totalPages} — ${total} total`;
        $('#pgPrev').disabled = page<=1;
        $('#pgNext').disabled = page>=totalPages;
      }

      function enableDelete(){ $('#btnDelete').disabled = selected.size===0; }

      // ---- Data I/O ----
      async function load(){
        const wrap = $('#listWrap'); wrap.textContent='Loading assignments…';
        try{
          const res = await api('admin-assignments-list','POST',{
            q: ($('#q')?.value||'').trim(),
            status: activeStatus || '',
            page, pageSize
          });
          rows = Array.isArray(res) ? res : (res.rows || []);
          total = res?.total ?? rows.length;
          selected.clear(); enableDelete();
          render();
        }catch(e){
          console.error('[assignments] list error', e);
          toast(e.message || 'Failed to load', 'error', 5000);
          wrap.textContent = 'Failed to load. Check console for details.';
        }
      }

      async function openOne(id){
        try{
          const r = await api('admin-assignments-detail','POST',{ id });
          editing = r;
          openEditor(r);
          toast('Opened ' + (r.job_title || ('Assignment #'+id)), 'info', 1800);
        }catch(e){
          toast('Open failed: ' + (e.message||e), 'error', 4200);
        }
      }

      async function quick(id){
        try{
          const r = await api('admin-assignments-detail','POST',{ id });
          renderQuick(r);
        }catch(e){
          renderQuick(null);
        }
      }

      async function doDelete(){
        if (!selected.size) return;
        if (!confirm(`Delete ${selected.size} assignment(s)?`)) return;
        try{
          await api('admin-assignments-delete','POST',{ ids:[...selected] });
          toast('Deleted', 'ok', 1500);
          selected.clear(); enableDelete();
          load();
        }catch(e){
          toast('Delete failed: ' + (e.message||e), 'error', 4000);
        }
      }

      function renderQuick(r){
        const host = $('#qvRows');
        if (!r){ host.innerHTML = `<div class="empty">Select an assignment to preview details here.</div>`; $('#qvOpenCandidate').style.display='none'; $('#qvEdit').style.display='none'; return; }
        const dates = (r.start_date?fmtDate(r.start_date):'—') + ' — ' + (r.end_date?fmtDate(r.end_date):'open');
        host.innerHTML = `
          <div class="kv"><b>Title</b><div>${r.job_title||'—'}</div></div>
          <div class="kv"><b>Status</b><div>${pillStatus(r.status||'')}</div></div>
          <div class="kv"><b>Client</b><div>${r.client_name||'—'} ${r.client_site?('· '+r.client_site):''}</div></div>
          <div class="kv"><b>Candidate</b><div>${r.candidate_name||'—'}</div></div>
          <div class="kv"><b>Dates</b><div>${dates}</div></div>
          <div class="kv"><b>Pay</b><div>${r.currency||'GBP'} ${r.rate_pay||r.rate_std||'—'}</div></div>
          <div class="kv"><b>PO</b><div>${r.po_number||r.po_ref||'—'}</div></div>
          <div class="kv"><b>Consultant</b><div>${r.consultant_name||'—'}</div></div>
        `;
        const link = r.candidate_id
          ? `/admin-v2/admin/candidate-profile.html?id=${encodeURIComponent(r.candidate_id)}`
          : r.candidate_name ? `/admin-v2/admin/candidates.html?q=${encodeURIComponent(r.candidate_name)}` : null;
        const a = $('#qvOpenCandidate');
        if (link){ a.href=link; a.style.display=''; } else a.style.display='none';
        $('#qvEdit').style.display=''; $('#qvEdit').onclick=()=>{ openEditor(r); };
      }

      // ---- editor layout ----
      const schema = [
        { name:'Basics', fields:[
          ['job_title','Job title'],
          ['status','Status','select','live,draft,pending,complete,closed'],
          ['as_ref','Assignment ref'], ['po_number','PO number'],
          ['candidate_name','Candidate'], ['client_name','Client'], ['client_site','Client site'],
          ['consultant_name','Consultant']
        ]},
        { name:'Dates & Rates', fields:[
          ['start_date','Start date','date'], ['end_date','End date','date'],
          ['days_per_week','Days/wk','number'], ['hours_per_day','Hours/day','number'],
          ['currency','Currency'], ['rate_pay','Pay rate','number'], ['rate_charge','Charge rate','number'],
          ['shift_type','Shift','select','Day,Night,Weekend']
        ]},
        { name:'Options', fields:[
          ['pay_freq','Pay frequency','select','Weekly,Monthly'],
          ['ts_type','Timesheet type','select','e-Timesheet,Paper,Portal'],
          ['auto_ts','Auto-create timesheets','checkbox'],
          ['approver','Approver email']
        ]},
        { name:'Notes', fields:[
          ['notes','Notes','textarea']
        ]}
      ];

      const drawer = $('#drawer');
      const openDrawer = ()=>drawer.classList.add('open');
      const closeDrawer = ()=>{ drawer.classList.remove('open'); setTimeout(()=>resetForm(),150); };
      $('#btnClose').onclick = closeDrawer;

      function fieldHtml([key,label,type='text',extra]){
        const id='f_'+key;
        if(type==='checkbox'){
          return `<div class="field"><label for="${id}">${label}</label>
                  <input id="${id}" name="${key}" type="checkbox"></div>`;
        }
        if(type==='textarea'){
          return `<div class="field" style="grid-column:1/-1"><label for="${id}">${label}</label>
                  <textarea id="${id}" name="${key}" rows="3"></textarea></div>`;
        }
        if(type==='select'){
          const opts=(extra||'').split(',').map(s=>s.trim()).filter(Boolean).map(s=>`<option>${s}</option>`).join('');
          return `<div class="field"><label for="${id}">${label}</label>
                  <select id="${id}" name="${key}"><option value=""></option>${opts}</select></div>`;
        }
        return `<div class="field"><label for="${id}">${label}</label>
                <input id="${id}" name="${key}" type="${type}"></div>`;
      }

      function buildEditorShell(){
        const tabsHost=$('#tabs'); tabsHost.innerHTML='';
        schema.forEach(t=>{
          const b=document.createElement('button');
          b.type='button'; b.className='tab'+(t.name===currentTab?' active':''); b.textContent=t.name;
          b.onclick=()=>{ currentTab=t.name; buildEditorForm(editing||{}); Array.from(tabsHost.children).forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
          tabsHost.appendChild(b);
        });
        buildEditorForm(editing||{});
      }
      function buildEditorForm(values={}){
        const tab=schema.find(t=>t.name===currentTab)||schema[0];
        const frm=$('#frm'); frm.innerHTML=tab.fields.map(fieldHtml).join('');
        tab.fields.forEach(([key,,type])=>{
          const el=frm.querySelector(`[name="${key}"]`); if(!el) return;
          if(type==='checkbox') el.checked = !!values[key];
          else if(values[key]!=null) el.value = values[key];
        });
      }
      function readForm(){
        const out={};
        schema.forEach(t=>{
          t.fields.forEach(([key,,type])=>{
            const el=document.querySelector(`#frm [name="${key}"]`); if(!el) return;
            if(type==='checkbox') out[key]=!!el.checked;
            else out[key]=el.value||null;
          });
        });
        return out;
      }
      function resetForm(){
        editing=null; currentTab='Basics';
        $('#dTitle').textContent = 'New assignment';
        $('#dRef').textContent = '—';
        buildEditorShell();
      }
      function openEditor(values={}){
        editing = values||null;
        buildEditorShell();
        $('#dTitle').textContent = values?.job_title || (values?.id?'Edit assignment':'New assignment');
        $('#dRef').textContent = values?.as_ref || values?.po_ref || values?.id || '—';
        openDrawer();
      }

      async function save(closeAfter){
        try{
          const payload=readForm();
          if (editing?.id) payload.id = editing.id;
          const fn = editing?.id ? 'admin-assignment-save' : 'admin-assignments-create';
          const res = await api(fn,'POST',payload);
          toast('Saved', 'ok', 1500);
          if (closeAfter) closeDrawer();
          page = 1; // bounce to newest
          await load();
          if (!editing?.id && res?.id) { editing = { id:res.id, ...payload }; }
        }catch(e){
          toast('Save failed: ' + (e.message||e), 'error', 4200);
        }
      }

      // ---- wires ----
      $('#btnRefresh').onclick = load;
      $('#btnNew').onclick     = ()=>{ resetForm(); openDrawer(); };
      $('#btnDelete').onclick  = doDelete;
      $('#q').addEventListener('keydown', e=>{ if (e.key==='Enter') { e.preventDefault(); page=1; load(); } });
      $('#statusSel').onchange = e=>{ activeStatus=e.target.value; page=1; load(); };
      $('#pgPrev').onclick     = ()=>{ if(page>1){ page--; load(); } };
      $('#pgNext').onclick     = ()=>{ page++; load(); };
      $('#pgSize').onchange    = e=>{ pageSize=Number(e.target.value)||20; page=1; load(); };
      $('#btnSaveDraft').onclick=()=>save(false);
      $('#btnSaveClose').onclick=()=>save(true);

      document.addEventListener('keydown',(e)=>{
        if ((e.ctrlKey||e.metaKey) && e.key==='r'){ e.preventDefault(); load(); }
        if ((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); save(false); }
        if (e.key==='Escape' && drawer?.classList.contains('open')){ e.preventDefault(); closeDrawer(); }
      });

      buildColMenu();

      // ---- go ----
      await load();
      enableDelete();
    });
  })();
  </script>
</body>
</html>
