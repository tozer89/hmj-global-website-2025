<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assignments — Admin | HMJ Global</title>

<!-- Identity first -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Force init as soon as DOM is ready -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    try { window.netlifyIdentity && window.netlifyIdentity.init(); } catch(e){}
  });
</script>

<!-- Then your shared common -->
<script src="./common.js?v=4"></script>


<style>
  :root{
    --ink:#101828; --bg:#ffffff; --muted:#667085;
    --blue:#1f3b7a; --blue-2:#29478f;
    --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
    --danger:#dc2626; --ok:#16a34a; --warn:#f59e0b;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  /* Header */
  .top{position:sticky;top:0;z-index:30;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
  .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;display:flex;gap:10px;align-items:center}
  .brand a{color:#fff;text-decoration:none;display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
  .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;color:var(--blue);display:grid;place-items:center;font-weight:900}
  .sp{flex:1}
  .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--blue-2)}
  .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
  .btn.light{background:#fff;color:var(--blue);border-color:#fff}
  .btn.danger{background:#7a1f28;border-color:#a42e3b}
  /* Page */
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px;display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
  .muted{color:var(--muted)}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .bar .sp{flex:1}
  input,select,textarea{background:#fff;border:1px solid var(--stroke);border-radius:10px;padding:10px}
  input:focus,select:focus,textarea:focus{outline:3px solid var(--ring);outline-offset:2px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--stroke);text-align:left}
  th{font-size:14px;color:#334155}
  .pill{display:inline-grid;align-items:center;padding:3px 8px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
  .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
  .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  /* Drawer */
  .drawer{position:fixed;inset:0;display:none;background:rgba(2,6,23,.44);z-index:40}
  .drawer .panel{position:absolute;right:0;top:0;bottom:0;width:820px;max-width:100%;background:#fff;border-left:1px solid var(--stroke);padding:16px;overflow:auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .twocol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){ .twocol{grid-template-columns:1fr} }
  .section{margin:12px 0 6px;font-weight:800}
</style>
</head>
<body>

<!-- Header -->
<div class="top"><div class="row">
  <div class="brand">
    <a href="../"><span class="logo">H</span> HMJ Global</a>
    <span class="pill">Admin</span>
    <span class="pill">Assignments</span>
  </div>
  <div class="sp"></div>
  <div class="chips" id="chips"></div>
  <a class="btn ghost" href="./">⟵ Admin</a>
  <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
</div></div>

<!-- Gate -->
<div class="wrap" id="gate" style="display:none">
  <div class="card">
    <strong>Admin only.</strong>
    <p class="muted why">Checking your session…</p>
    <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
  </div>
</div>

<!-- Toolbar -->
<div class="wrap" id="app" style="display:none">
  <div class="card bar">
    <input id="q" placeholder="Search job title, client, candidate…" style="min-width:260px">
    <select id="status">
      <option value="">Status: any</option>
      <option>live</option><option>pending</option><option>completed</option><option>cancelled</option><option>archived</option>
    </select>
    <select id="consultant">
      <option value="">Consultant: any</option>
    </select>
    <select id="client">
      <option value="">Client: any</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div class="sp"></div>
    <input type="file" id="csv" accept=".csv" style="display:none">
    <button class="btn ghost" id="btnExport">Export CSV</button>
    <button class="btn ghost" id="btnImport">Import CSV</button>
    <button class="btn" id="btnNew">+ New assignment</button>
    <button class="btn danger" id="btnDelete" disabled>Delete</button>
  </div>

  <!-- List -->
  <div class="card" id="listWrap">Loading…</div>

  <!-- Analytics quick glance -->
  <div class="card" id="analytics">
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <span class="pill" id="anLive">Live: —</span>
      <span class="pill" id="anPending">Pending: —</span>
      <span class="pill" id="anCompleted">Completed (30d): —</span>
      <span class="pill" id="anGP">Est. GP (30d): —</span>
    </div>
  </div>

  <!-- Audit mini -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="section" style="margin:0">Recent activity</div>
      <button class="btn ghost" id="btnAudit">Refresh</button>
    </div>
    <div id="audit" class="muted">—</div>
  </div>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer" aria-modal="true" role="dialog">
  <div class="panel">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
      <h2 id="edTitle" style="margin:0">Assignment</h2>
      <div class="right" style="display:flex;gap:8px">
        <button class="btn ghost" id="btnSave">Save</button>
        <button class="btn ghost" id="btnExtend">Extend</button>
        <button class="btn" id="btnRenew">Renew</button>
        <button class="btn danger" id="btnDelOne">Delete</button>
        <button class="btn ghost" id="btnClose">Close</button>
      </div>
    </div>

    <!-- Core details -->
    <div class="section">Core</div>
    <div class="grid">
      <label>Assignment ID <input id="as_ref" placeholder="Auto or manual"></label>
      <label>Status
        <select id="as_status"><option>live</option><option>pending</option><option>completed</option><option>cancelled</option><option>archived</option></select>
      </label>
      <label>Job Title <input id="job_title"></label>
      <label>Consultant <input id="consultant_name" list="consultants"></label>
      <label>Candidate <input id="candidate_name" list="candidates" placeholder="link to candidate"></label>
      <label>Client <input id="client_name" list="clients" placeholder="link to client"></label>
      <label>Client Site <input id="client_site"></label>
      <label>PO / Reference <input id="po_ref"></label>

      <label>Start Date <input id="start_date" type="date"></label>
      <label>End Date   <input id="end_date" type="date"></label>
      <label>Duration (auto) <input id="duration_days" disabled></label>
      <label>AWR Weeks (auto) <input id="awr_weeks" disabled></label>
    </div>

    <!-- Pay & Timesheets -->
    <div class="section">Pay & Timesheets</div>
    <div class="grid">
      <label>Pay Frequency
        <select id="pay_freq"><option>Weekly</option><option>Monthly</option></select>
      </label>
      <label>Currency
        <select id="currency"><option>GBP</option><option>EUR</option><option>USD</option></select>
      </label>
      <label>Expected Days/Week <input id="days_per_week" type="number" min="0" max="7" step="0.5"></label>
      <label>Expected Hours/Day <input id="hours_per_day" type="number" min="0" max="24" step="0.25"></label>
      <label>Timesheet Type
        <select id="ts_type"><option>e-Timesheet</option><option>Paper</option></select>
      </label>
      <label>Shift Type
        <select id="shift_type"><option>Day</option><option>Night</option><option>Custom</option></select>
      </label>
      <label>Rate (Pay) <input id="rate_pay" type="number" step="0.01" placeholder="per hour"></label>
      <label>Rate (Charge) <input id="rate_charge" type="number" step="0.01" placeholder="per hour"></label>
      <label>Auto Timesheets <select id="auto_ts"><option value="false">No</option><option value="true">Yes</option></select></label>
      <label>Approval Workflow <input id="approver" placeholder="Manager email / role"></label>
    </div>

    <!-- Calculated -->
    <div class="section">Estimates</div>
    <div class="twocol">
      <div class="card" style="background:#fff">
        <div style="font-weight:700;margin-bottom:6px">Gross Profit Estimator</div>
        <div id="gpOut" class="muted">Enter rates + hours to see a preview.</div>
      </div>
      <div class="card" style="background:#fff">
        <div style="font-weight:700;margin-bottom:6px">Timesheet History</div>
        <div><button class="btn ghost" id="btnTsHistory">Open timesheets for this assignment</button></div>
      </div>
    </div>

    <!-- Compliance -->
    <div class="section">Compliance & Docs</div>
    <div class="grid">
      <label>H&S Risk Disclosure <input id="hs_risk"></label>
      <label>Right-to-Work Check <select id="rtw_ok"><option value="false">No</option><option value="true">Yes</option></select></label>
      <label>Qualifications Required <input id="quals"></label>
      <label>Special Conditions <input id="special"></label>
      <label>Duties <input id="duties"></label>
      <label>Equipment Provided <input id="equipment"></label>
      <label>Terms Dispatch <select id="terms_sent"><option value="false">Not sent</option><option value="true">Sent</option></select></label>
      <label>Digital Signature <select id="sig_ok"><option value="false">Pending</option><option value="true">Signed</option></select></label>
    </div>

    <!-- Contract Upload -->
    <div class="section">Contract Document</div>
    <div class="twocol">
      <div class="card" style="background:#fff">
        <div id="ctrInfo" class="muted">No file.</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input type="file" id="ctrFile" accept="application/pdf,image/*">
          <button class="btn ghost" id="btnUploadCTR">Upload</button>
        </div>
      </div>

      <!-- Lifecycle -->
      <div class="card" style="background:#fff">
        <div style="font-weight:700;margin-bottom:6px">Lifecycle & Termination</div>
        <div class="grid">
          <label>Notice (Agency/Temp) <input id="notice_temp" placeholder="e.g., 1 week"></label>
          <label>Notice (Client) <input id="notice_client" placeholder="e.g., 1 week"></label>
          <label>Termination Reason <input id="term_reason" placeholder="—"></label>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button class="btn ghost" id="btnChecklist">Completion Checklist</button>
          <button class="btn ghost" id="btnArchive">Archive</button>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="section">Notes</div>
    <textarea id="notes" rows="4" placeholder="Internal notes…"></textarea>
  </div>
</div>

<!-- Toast fallback host -->
<div id="toast" aria-live="polite" aria-atomic="true"></div>

<script>
Admin.bootAdmin(async ({ api, sel, toast }) => {
  // Chips
  const chip = (t,tone='info') => {
    const span=document.createElement('span'); span.className='pill'; span.textContent=t;
    if(tone==='ok') span.classList.add('b-ok');
    if(tone==='warn') span.classList.add('b-warn');
    if(tone==='bad') span.classList.add('b-bad');
    sel('#chips').appendChild(span); return span;
  };
  chip('ready','ok');

  // State
  let page=1, pageSize=20, total=0, rows=[], selected=new Set(), current=null;

  // Helpers
  function openDrawer(){ sel('#drawer').style.display='block'; }
  function closeDrawer(){ sel('#drawer').style.display='none'; current=null; }
  function enableDelete(){ sel('#btnDelete').disabled = selected.size===0; }

  function renderList(){
    if(!rows.length){ sel('#listWrap').textContent='No assignments found.'; return; }
    const head = `<thead><tr>
      <th style="width:28px"><input id="ckAll" type="checkbox"></th>
      <th>ID</th><th>Job Title</th><th>Candidate</th><th>Client</th>
      <th>Status</th><th>Dates</th><th>Rate</th><th>GP est.</th><th></th>
    </tr></thead>`;
    const body = rows.map(r=>{
      const dates = (r.start_date||'').slice(0,10) + (r.end_date? ` → ${(r.end_date||'').slice(0,10)}` : '');
      const rate = (r.rate_pay?`£${Number(r.rate_pay).toFixed(2)}`:'—') + ' / ' + (r.rate_charge?`£${Number(r.rate_charge).toFixed(2)}`:'—');
      const gp = (typeof r.gp_est==='number') ? `£${r.gp_est.toFixed(2)}` : '—';
      const pillClass = r.status==='live'?'b-ok':(r.status==='completed'?'':'b-warn');
      return `<tr>
        <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
        <td>${r.as_ref || r.id}</td>
        <td>${r.job_title||'—'}</td>
        <td>${r.candidate_name||'—'}</td>
        <td>${r.client_name||'—'}</td>
        <td><span class="pill ${pillClass}">${r.status||'pending'}</span></td>
        <td>${dates}</td>
        <td>${rate}</td>
        <td>${gp}</td>
        <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
      </tr>`;
    }).join('');
    const pager = `<div style="display:flex;justify-content:space-between;align-items:center;padding-top:8px">
      <div class="muted">Showing ${(page-1)*pageSize+1}-${Math.min(page*pageSize,total)} of ${total}</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="pPrev" ${page<=1?'disabled':''}>Prev</button>
        <button class="btn ghost" id="pNext" ${(page*pageSize)>=total?'disabled':''}>Next</button>
      </div></div>`;
    sel('#listWrap').innerHTML = `<table>${head}<tbody>${body}</tbody></table>${pager}`;

    sel('#ckAll').onclick = (e)=>{ if(e.target.checked){ rows.forEach(r=>selected.add(r.id)); } else { rows.forEach(r=>selected.delete(r.id)); } enableDelete(); renderList(); };
    sel('#listWrap').querySelectorAll('input[type=checkbox][data-id]').forEach(c=> c.onchange=()=>{ const id=Number(c.getAttribute('data-id')); if(c.checked) selected.add(id); else selected.delete(id); enableDelete(); });
    sel('#listWrap').querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openAssignment(Number(b.getAttribute('data-open'))));
    sel('#pPrev').onclick=()=>{ page--; load(); };
    sel('#pNext').onclick=()=>{ page++; load(); };
  }

  async function load(){
    sel('#listWrap').textContent='Loading…';
    try{
      const res = await api('admin-assignments-list','POST',{
        q: sel('#q').value||'', status: sel('#status').value||'',
        consultant: sel('#consultant').value||'', client: sel('#client').value||'',
        page, pageSize
      });
      rows = res.rows || res || [];
      total = res.total ?? rows.length;
      // optional analytics snippet from API
      if(res.analytics){
        sel('#anLive').textContent = 'Live: ' + (res.analytics.live ?? '—');
        sel('#anPending').textContent = 'Pending: ' + (res.analytics.pending ?? '—');
        sel('#anCompleted').textContent = 'Completed (30d): ' + (res.analytics.completed_30d ?? '—');
        sel('#anGP').textContent = 'Est. GP (30d): ' + (typeof res.analytics.gp_30d==='number' ? `£${res.analytics.gp_30d.toFixed(0)}` : '—');
      }
      renderList();
    }catch(e){ sel('#listWrap').textContent='Error: '+e.message; }
  }

  async function loadAudit(){
    try{
      const list = await api('admin-audit-list','POST',{ entity:'assignment', limit: 10 });
      sel('#audit').innerHTML = list.length ? `<ul style="margin:6px 0;padding-left:18px">
        ${list.map(a=>`<li><span class="muted">${a.created_at?.replace('T',' ').slice(0,16)||''}</span> — ${a.action} #${a.entity_id||''} by ${a.actor_email||'—'}</li>`).join('')}
      </ul>` : '—';
    }catch(e){ sel('#audit').textContent='Audit unavailable: '+e.message; }
  }

  // Calculator helpers
  function daysBetween(a,b){ if(!a||!b) return ''; const d=(new Date(b)-new Date(a))/(1000*60*60*24)+1; return d>0? Math.floor(d):''; }
  function weeksBetween(a,b){ const d=daysBetween(a,b); return d? Math.ceil(d/7):''; }
  function gpEstimate(){
    const ratePay = parseFloat(sel('#rate_pay').value||0);
    const rateCharge = parseFloat(sel('#rate_charge').value||0);
    const hoursPerDay = parseFloat(sel('#hours_per_day').value||0);
    const daysPerWeek = parseFloat(sel('#days_per_week').value||0);
    if(!rateCharge || !hoursPerDay || !daysPerWeek){ sel('#gpOut').textContent='Enter rates + hours to see a preview.'; return; }
    const margin = Math.max(0, rateCharge - ratePay);
    const weekly = margin * hoursPerDay * daysPerWeek;
    const currency = sel('#currency').value || 'GBP';
    sel('#gpOut').textContent = `Est. Gross Profit: ~ ${currency==='GBP'?'£':''}${weekly.toFixed(2)} per week`;
  }

  function recomputeDates(){
    const s = sel('#start_date').value, e = sel('#end_date').value;
    sel('#duration_days').value = daysBetween(s,e);
    sel('#awr_weeks').value = weeksBetween(s,e);
    gpEstimate();
  }

  // Open editor
  async function openAssignment(id){
    try{
      const r = await api('admin-assignment-open','POST',{ id });
      current = r;
      sel('#edTitle').textContent = `Assignment #${r.id}`;
      const set = (k,v)=>{ const el=sel('#'+k); if(el) el.value = (v ?? ''); };
      set('as_ref', r.as_ref);
      set('as_status', r.status||'pending');
      set('job_title', r.job_title);
      set('consultant_name', r.consultant_name);
      set('candidate_name', r.candidate_name);
      set('client_name', r.client_name);
      set('client_site', r.client_site);
      set('po_ref', r.po_ref);
      set('start_date', (r.start_date||'').slice(0,10));
      set('end_date', (r.end_date||'').slice(0,10));
      set('pay_freq', r.pay_freq||'Weekly');
      set('currency', r.currency||'GBP');
      set('days_per_week', r.days_per_week||'');
      set('hours_per_day', r.hours_per_day||'');
      set('ts_type', r.ts_type||'e-Timesheet');
      set('shift_type', r.shift_type||'Day');
      set('rate_pay', r.rate_pay||'');
      set('rate_charge', r.rate_charge||'');
      set('auto_ts', String(!!r.auto_ts));
      set('approver', r.approver||'');
      set('hs_risk', r.hs_risk||'');
      set('rtw_ok', String(!!r.rtw_ok));
      set('quals', r.quals||'');
      set('special', r.special||'');
      set('duties', r.duties||'');
      set('equipment', r.equipment||'');
      set('terms_sent', String(!!r.terms_sent));
      set('sig_ok', String(!!r.sig_ok));
      set('notice_temp', r.notice_temp||'');
      set('notice_client', r.notice_client||'');
      set('term_reason', r.term_reason||'');
      set('notes', r.notes||'');
      sel('#ctrInfo').innerHTML = r.contract_url ? `<a href="${r.contract_url}" target="_blank">View Contract</a>` : 'No file.';
      recomputeDates();
      openDrawer();
    }catch(e){ toast('Open failed: '+e.message,'err',5000); }
  }

  // New
  function newAssignment(){
    current = { id:null, status:'pending', pay_freq:'Weekly', currency:'GBP', ts_type:'e-Timesheet', shift_type:'Day' };
    ['as_ref','job_title','consultant_name','candidate_name','client_name','client_site','po_ref',
     'start_date','end_date','days_per_week','hours_per_day','rate_pay','rate_charge','approver',
     'hs_risk','quals','special','duties','equipment','notice_temp','notice_client','term_reason','notes'].forEach(k=>{ const el=sel('#'+k); if(el) el.value=''; });
    sel('#as_status').value='pending'; sel('#pay_freq').value='Weekly'; sel('#currency').value='GBP';
    sel('#ts_type').value='e-Timesheet'; sel('#shift_type').value='Day';
    sel('#auto_ts').value='false'; sel('#rtw_ok').value='false'; sel('#terms_sent').value='false'; sel('#sig_ok').value='false';
    sel('#ctrInfo').textContent='No file.';
    openDrawer();
  }

  // Save
  async function save(){
    const get = id => sel('#'+id)?.value || null;
    const payload = {
      id: current?.id || null,
      as_ref: get('as_ref'),
      status: get('as_status'),
      job_title: get('job_title'),
      consultant_name: get('consultant_name'),
      candidate_name: get('candidate_name'),
      client_name: get('client_name'),
      client_site: get('client_site'),
      po_ref: get('po_ref'),
      start_date: get('start_date') || null,
      end_date: get('end_date') || null,
      pay_freq: get('pay_freq'),
      currency: get('currency'),
      days_per_week: parseFloat(get('days_per_week')) || null,
      hours_per_day: parseFloat(get('hours_per_day')) || null,
      ts_type: get('ts_type'),
      shift_type: get('shift_type'),
      rate_pay: parseFloat(get('rate_pay')) || null,
      rate_charge: parseFloat(get('rate_charge')) || null,
      auto_ts: sel('#auto_ts')?.value === 'true',
      approver: get('approver'),
      hs_risk: get('hs_risk'),
      rtw_ok: sel('#rtw_ok')?.value === 'true',
      quals: get('quals'),
      special: get('special'),
      duties: get('duties'),
      equipment: get('equipment'),
      terms_sent: sel('#terms_sent')?.value === 'true',
      sig_ok: sel('#sig_ok')?.value === 'true',
      notice_temp: get('notice_temp'),
      notice_client: get('notice_client'),
      term_reason: get('term_reason'),
      notes: get('notes')
    };
    try{
      const saved = await api('admin-assignment-save','POST', payload);
      toast('Saved','ok',2000); closeDrawer(); load();
    }catch(e){ toast('Save failed: '+e.message,'err',5000); }
  }

  // Delete
  async function delSelected(){
    if(!selected.size) return;
    if(!confirm(`Delete ${selected.size} assignment(s)?`)) return;
    try{ await api('admin-assignment-delete','POST',{ ids: Array.from(selected) });
      selected.clear(); enableDelete(); toast('Deleted','ok',2000); load();
    }catch(e){ toast('Delete failed: '+e.message,'err',5000); }
  }
  async function delOne(){ if(!current?.id) return; selected=new Set([current.id]); await delSelected(); closeDrawer(); }

  // Upload contract
  async function uploadCTR(){
    const f = sel('#ctrFile').files[0]; if(!f){ toast('Choose a file first','warn',2500); return; }
    try{
      const sign = await api('admin-uploads-presign','POST',{ entity:'assignment', entity_id: current?.id, kind:'contract', filename:f.name, type:f.type });
      await fetch(sign.url,{ method:'PUT', headers:sign.headers||{}, body:f });
      await api('admin-assignment-attach','POST',{ id: current?.id, kind:'contract', url: sign.public_url });
      sel('#ctrInfo').innerHTML = `<a href="${sign.public_url}" target="_blank">View Contract</a>`;
      toast('Uploaded','ok',1800);
    }catch(e){ toast('Upload failed: '+e.message,'err',5000); }
  }

  // Extend & Renew
  function extendBy(days=30){
    const cur = sel('#end_date').value;
    if(!cur){ toast('Set a current end date first','warn',2500); return; }
    const d = new Date(cur); d.setDate(d.getDate()+days);
    sel('#end_date').value = d.toISOString().slice(0,10); recomputeDates(); toast(`Extended by ${days} days`,'ok',1800);
  }
  function renew(){
    // Create a new assignment draft copying key fields
    if(!current){ toast('Open an assignment first','warn',2500); return; }
    const copy = ['job_title','consultant_name','candidate_name','client_name','client_site','po_ref','pay_freq','currency','days_per_week','hours_per_day','ts_type','shift_type','rate_pay','rate_charge','approver'];
    newAssignment();
    copy.forEach(k=>{ const el=sel('#'+k); if(el) el.value = current[k] ?? el.value; });
    sel('#as_status').value='pending';
    toast('Renewal draft started','ok',2000);
  }

  // Export / Import
  async function exportCSV(){
    try{
      const blob = await api('admin-assignments-export','POST',{ q: sel('#q').value||'', status: sel('#status').value||'' });
      const url = URL.createObjectURL(new Blob([blob],{type:'text/csv'}));
      const a=document.createElement('a'); a.href=url; a.download='assignments.csv'; a.click(); URL.revokeObjectURL(url);
    }catch(e){ toast('Export failed: '+e.message,'err',5000); }
  }
  function importCSV(){ sel('#csv').click(); }
  sel('#csv').addEventListener('change', async ()=>{
    const f = sel('#csv').files[0]; if(!f) return;
    const text = await f.text();
    try{
      const res = await api('admin-assignments-import','POST',{ csv:text });
      toast(`Imported ${res?.inserted ?? 0}`, 'ok', 2500); load();
    }catch(e){ toast('Import failed: '+e.message,'err',5000); }
  });

  // Timesheet history quick link
  function openTsHistory(){
    const ref = current?.as_ref || current?.id;
    if(!ref){ toast('Open an assignment first','warn',2500); return; }
    location.href = `./timesheets.html?assignment=${encodeURIComponent(ref)}`;
  }

  // Wire UI
  sel('#btnRefresh').onclick=load;
  sel('#btnNew').onclick=newAssignment;
  sel('#btnSave').onclick=save;
  sel('#btnDelete').onclick=delSelected;
  sel('#btnDelOne').onclick=delOne;
  sel('#btnClose').onclick=closeDrawer;
  sel('#btnUploadCTR').onclick=uploadCTR;
  sel('#btnExtend').onclick=()=>extendBy(30);
  sel('#btnRenew').onclick=renew;
  sel('#btnTsHistory').onclick=openTsHistory;
  sel('#btnAudit').onclick=loadAudit;
  sel('#btnExport').onclick=exportCSV;
  sel('#btnImport').onclick=importCSV;

  ['#q','#status','#consultant','#client'].forEach(s=> sel(s).addEventListener('change', ()=>{ page=1; load(); }));

  // Auto calculators
  ['#start_date','#end_date','#hours_per_day','#days_per_week','#rate_pay','#rate_charge','#currency'].forEach(s=> sel(s).addEventListener('input', ()=>{ recomputeDates(); gpEstimate(); }));

  // Shortcuts
  document.addEventListener('keydown',(e)=>{
    if(e.key==='n' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); newAssignment(); }
    if(e.key==='s' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); if(sel('#drawer').style.display==='block') save(); }
    if(e.key==='e' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); exportCSV(); }
    if(e.key==='Escape' && sel('#drawer').style.display==='block'){ e.preventDefault(); closeDrawer(); }
  });

  // Initial load
  await load();
  await loadAudit();

  // Optional: preload dropdown data (consultants/clients) from API
  try{
    const meta = await api('admin-assignments-meta','POST',{}); // { consultants:[], clients:[] }
    const addOpts = (id, arr) => { const el=sel(id); if(!el || !Array.isArray(arr)) return;
      arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
    };
    addOpts('#consultant', meta.consultants);
    addOpts('#client', meta.clients);
    // also attach lists for inputs
    if(meta.consultants){ const dl=document.createElement('datalist'); dl.id='consultants'; dl.innerHTML=meta.consultants.map(v=>`<option value="${v}">`).join(''); document.body.appendChild(dl); }
    if(meta.clients){ const dl=document.createElement('datalist'); dl.id='clients'; dl.innerHTML=meta.clients.map(v=>`<option value="${v}">`).join(''); document.body.appendChild(dl); }
    if(meta.candidates){ const dl=document.createElement('datalist'); dl.id='candidates'; dl.innerHTML=meta.candidates.map(v=>`<option value="${v}">`).join(''); document.body.appendChild(dl); }
  }catch(_) {}
});
</script>
</body>
</html>
