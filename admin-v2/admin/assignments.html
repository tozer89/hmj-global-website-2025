<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Assignments — Admin</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/favicon.ico" rel="icon" />

  <!-- Fonts / Icons (kept from your stack) -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,600,700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Base styles -->
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --bg-soft:#111827;      /* gray-900 */
      --panel:#0b1220;        /* deep panel */
      --muted:#94a3b8;        /* slate-400 */
      --text:#e5e7eb;         /* gray-200 */
      --brand:#06b6d4;        /* cyan-500 */
      --brand-600:#0891b2;    /* cyan-600 */
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#1f2937;         /* gray-800 */
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";}

    a{color:var(--brand);text-decoration:none}
    a:hover{color:var(--brand-600)}

    header{
      position:sticky;top:0;z-index:40;
      backdrop-filter:saturate(150%) blur(6px);
      background:linear-gradient(180deg, rgba(11,18,32,.9), rgba(11,18,32,.65));
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 auto}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      background:#0b2530;color:var(--text);border:1px solid #134055;
      padding:10px 14px;border-radius:12px;cursor:pointer;
      transition:all .15s ease; font-weight:600;
    }
    .btn:hover{transform:translateY(-1px);border-color:#17607e}
    .btn.brand{background:var(--brand); border-color:var(--brand-600); color:#001016}
    .btn.bad{background:rgba(239,68,68,.15); border-color:#7a1e1e; color:#fecaca}
    .btn.ghost{background:transparent;border-color:var(--border)}
    .btn.sm{padding:8px 10px;border-radius:10px;font-size:13px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .search{
      position:relative; flex:1 1 320px; min-width:220px;
    }
    .search input{
      width:100%; background:#0a1425; color:var(--text);
      border:1px solid var(--border); padding:12px 40px 12px 38px; border-radius:12px;
      outline:none;
    }
    .search i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)
    }
    .pill{display:inline-block;background:#0a2332;border:1px solid #14445b;color:#bfeafe;padding:2px 8px;border-radius:999px;font-size:12px}
    .b-warn{background:rgba(245,158,11,.12);border-color:#6b4a0a;color:#fde68a}
    .b-bad{background:rgba(239,68,68,.13);border-color:#7a1e1e;color:#fecaca}
    .b-ok{background:rgba(34,197,94,.12);border-color:#14532d;color:#bbf7d0}

    /* Layout: table + drawer */
    .content{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px; overflow:hidden;
    }
    .panel header{
      position:static;background:#0a1629;border-bottom:1px solid var(--border)
    }
    .panel h2{font-size:16px;margin:0}
    .pad{padding:16px}

    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:left; font-weight:700; font-size:12px; letter-spacing:.08em; text-transform:uppercase;
      color:var(--muted); border-bottom:1px solid var(--border); padding:12px 10px;
    }
    tbody td{border-bottom:1px solid var(--border); padding:14px 10px; vertical-align:top}
    tbody tr{transition:background .15s ease}
    tbody tr:hover{background:#0f1e33}
    .row-actions{display:flex; gap:10px}

    /* Drawer (right side) */
    .drawer{
      position:sticky; top:88px; max-height:calc(100vh - 104px); overflow:auto;
    }
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field label{font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--muted)}
    .field input,.field select,.field textarea{
      background:#0b1426;color:var(--text);border:1px solid var(--border);
      border-radius:12px;padding:10px 12px;outline:none
    }
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

    /* Pagination */
    .pages{display:flex;justify-content:space-between;align-items:center;padding:12px;border-top:1px solid var(--border)}
    .pages .btn{min-width:88px;justify-content:center}

    /* Responsive (mobile-first) */
    @media (max-width: 980px){
      .content{grid-template-columns:1fr}
      .drawer{position:relative;top:auto;max-height:none}
      .hide-md{display:none}
      .search{flex:1 1 100%}
      .btn.wide{width:100%;justify-content:center}
    }

    /* Toast */
    #toast{position:fixed;z-index:50;left:50%;top:14px;transform:translateX(-50%);display:flex;gap:8px;flex-wrap:wrap}
  </style>

  <!-- Load shared Admin helper correctly (RELATIVE path!) -->
  <!-- NOTE: we must not use "/admin/common.js". This page lives in /admin/, so "./common.js" is correct. -->
  <script defer src="./common.js?v=10"></script>
</head>
<body>

  <header>
    <div class="wrap row">
      <div class="row" style="gap:10px">
        <a class="btn ghost" href="/admin/index.html"><i class="fa fa-chevron-left"></i> Back</a>
        <h1 style="margin:0;font-size:18px">Assignments</h1>
        <span class="chip hide-md"><i class="fa fa-database"></i> Connected</span>
      </div>
      <div id="chips" class="row"></div>
    </div>
  </header>

  <main class="wrap" style="padding-top:18px;padding-bottom:40px">
    <div class="toolbar">
      <div class="search">
        <i class="fa fa-search"></i>
        <input id="q" placeholder="Search (title, ref, client, candidate)…" autocomplete="off" />
      </div>

      <select id="flt-status" class="btn ghost">
        <option value="">All statuses</option>
        <option value="in_progress">In progress</option>
        <option value="complete">Complete</option>
        <option value="archived">Archived</option>
      </select>

      <button id="btn-refresh" class="btn"><i class="fa fa-rotate"></i> Refresh</button>
      <div class="grow"></div>
      <button id="btn-new" class="btn brand wide"><i class="fa fa-plus"></i> New assignment</button>
      <button id="btn-delete" class="btn bad hide-md" disabled><i class="fa fa-trash"></i> Delete</button>
    </div>

    <div class="content" style="margin-top:14px">
      <!-- LIST -->
      <section class="panel">
        <header class="pad row" style="justify-content:space-between">
          <h2>All assignments</h2>
          <span class="pill b-ok" id="count-pill">0 total</span>
        </header>

        <div class="pad" style="padding-top:4px">
          <div class="hide-md" style="overflow:auto">
            <table id="tbl">
              <thead>
                <tr>
                  <th style="width:36px"><input type="checkbox" id="sel-all" /></th>
                  <th>Title</th>
                  <th class="hide-md">Client</th>
                  <th>Candidate</th>
                  <th class="hide-md">Dates</th>
                  <th>Status</th>
                  <th style="width:120px">Actions</th>
                </tr>
              </thead>
              <tbody id="rows">
                <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile cards -->
          <div id="cards" class="hide-lg" style="display:none;gap:10px"></div>
        </div>

        <div class="pages">
          <div class="row" style="gap:8px">
            <button id="prev" class="btn sm"><i class="fa fa-chevron-left"></i> Prev</button>
            <button id="next" class="btn sm">Next <i class="fa fa-chevron-right"></i></button>
          </div>
          <div class="row" style="gap:10px;color:var(--muted)">
            <span id="pginfo">Page 1</span>
            <select id="pagesize" class="btn ghost sm">
              <option>10</option>
              <option selected>20</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>
        </div>
      </section>

      <!-- DRAWER -->
      <aside class="panel drawer" id="drawer" style="display:none">
        <header class="pad row" style="justify-content:space-between">
          <h2 id="drawer-title">New assignment</h2>
          <div class="row" style="gap:8px">
            <button id="btn-close" class="btn ghost sm"><i class="fa fa-xmark"></i> Close</button>
          </div>
        </header>

        <div class="pad">
          <form id="frm" autocomplete="off">
            <input type="hidden" id="id" />

            <div class="field">
              <label for="title">Job Title *</label>
              <input id="title" required placeholder="e.g. Electrician — Data Hall 3" />
            </div>

            <div class="three">
              <div class="field">
                <label for="start_date">Start Date</label>
                <input id="start_date" type="date" />
              </div>
              <div class="field">
                <label for="end_date">End Date</label>
                <input id="end_date" type="date" />
              </div>
              <div class="field">
                <label for="po">PO Number</label>
                <input id="po" maxlength="50" placeholder="Optional" />
              </div>
            </div>

            <div class="three">
              <div class="field">
                <label for="client_id">Client</label>
                <select id="client_id"></select>
              </div>
              <div class="field">
                <label for="client_site_id">Client Site</label>
                <select id="client_site_id"><option value="">—</option></select>
              </div>
              <div class="field">
                <label for="consultant_id">Consultant</label>
                <select id="consultant_id"></select>
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="candidate_id">Candidate</label>
                <select id="candidate_id"></select>
              </div>
              <div class="field">
                <label for="status">Status</label>
                <select id="status">
                  <option value="in_progress">In progress</option>
                  <option value="complete">Complete</option>
                  <option value="archived">Archived</option>
                </select>
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="estimated_hours">Expected days / hours</label>
                <input id="estimated_hours" placeholder="e.g. Mon–Fri, 08:00–17:00" />
              </div>
              <div class="field">
                <label for="currency">Currency</label>
                <select id="currency"><option value="">Choose a client first</option></select>
              </div>
            </div>

            <div class="three">
              <div class="field">
                <label>Timesheets Type</label>
                <select id="timesheets_type">
                  <option value="eTimesheet">e-Timesheet</option>
                  <option value="PaperTimesheet">Paper Timesheet</option>
                </select>
              </div>
              <div class="field">
                <label>Agency Only Submit</label>
                <select id="agency_only_submit">
                  <option value="false">No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
              <div class="field">
                <label>Shift</label>
                <select id="shift">
                  <option value="Day">Day</option>
                  <option value="Night">Night</option>
                </select>
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="qualifications">Qualifications required</label>
                <input id="qualifications" placeholder="None notified" />
              </div>
              <div class="field">
                <label for="duties">Duties</label>
                <input id="duties" placeholder="—" />
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="hs">H&S risks & steps</label>
                <input id="hs" placeholder="None disclosed" />
              </div>
              <div class="field">
                <label for="special">Special conditions</label>
                <input id="special" placeholder="None specified" />
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="equip_temp">Equipment (temp)</label>
                <input id="equip_temp" placeholder="None specified" />
              </div>
              <div class="field">
                <label for="equip_client">Equipment (client)</label>
                <input id="equip_client" placeholder="None specified" />
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="awr">AWR Weeks</label>
                <input id="awr" placeholder="None" />
              </div>
              <div class="field">
                <label for="comments">Comments</label>
                <input id="comments" placeholder="—" />
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label>Notice (Agency/Temp)</label>
                <div class="two">
                  <select id="notice_type_agency">
                    <option value="None">None</option><option>Days</option><option>Weeks</option><option>Months</option>
                  </select>
                  <input id="notice_value_agency" type="number" min="1" placeholder="Value" />
                </div>
              </div>
              <div class="field">
                <label>Notice (Client)</label>
                <div class="two">
                  <select id="notice_type_client">
                    <option value="None">None</option><option>Days</option><option>Weeks</option><option>Months</option>
                  </select>
                  <input id="notice_value_client" type="number" min="1" placeholder="Value" />
                </div>
              </div>
            </div>

            <div class="two">
              <div class="field">
                <label for="ext_source">External Source</label>
                <input id="ext_source" placeholder="Optional" />
              </div>
              <div class="field">
                <label for="ext_id">External ID</label>
                <input id="ext_id" placeholder="Optional" />
              </div>
            </div>

            <div class="row" style="gap:8px;margin-top:14px">
              <button id="btn-save" class="btn brand"><i class="fa fa-floppy-disk"></i> Save</button>
              <button id="btn-delete2" class="btn bad"><i class="fa fa-trash"></i> Delete</button>
            </div>
          </form>
        </div>
      </aside>
    </div>
  </main>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  // ------------------------------ Helpers to display little status chips
  const chip = (t, tone='info') => {
    const s = document.createElement('span');
    s.className = 'pill';
    s.textContent = t;
    if (tone==='ok') s.classList.add('b-ok');
    if (tone==='warn') s.classList.add('b-warn');
    if (tone==='bad') s.classList.add('b-bad');
    return s;
  };

  // ------------------------------ Safe boot:
  // Start only when common.js has attached window.Admin
  (function startWhenReady(){
    if (!window.Admin || typeof Admin.bootAdmin !== 'function') {
      return setTimeout(startWhenReady, 25);
    }
    Admin.bootAdmin(async ({ api, sel, toast }) => {
      // ===== Page code starts here =====

      // --------- DOM shortcuts
      const $ = (q, el=document) => el.querySelector(q);
      const $$ = (q, el=document) => [...el.querySelectorAll(q)];
      const on = (el, ev, fn) => el.addEventListener(ev, fn);

      // --------- Endpoints (change if your function names differ)
      const ENDPOINTS = {
        DROPDOWNS: '/.netlify/functions/admin-assignments-dropdowns',
        LIST: '/.netlify/functions/admin-assignments-list',
        GET: '/.netlify/functions/admin-assignments-get',
        SAVE: '/.netlify/functions/admin-assignments-save',
        DELETE: '/.netlify/functions/admin-assignments-delete',
      };

      // --------- State
      let page = 1;
      let pageSize = 20;
      let total = 0;
      let rows = [];
      let selected = new Set();
      let current = null;
      let mobile = () => matchMedia('(max-width:980px)').matches;

      // --------- Elements
      const $chips = $('#chips');
      const $q = $('#q');
      const $status = $('#flt-status');
      const $rows = $('#rows');
      const $cards = $('#cards');
      const $selAll = $('#sel-all');
      const $count = $('#count-pill');
      const $pginfo = $('#pginfo');
      const $pagesize = $('#pagesize');

      const drawer = $('#drawer');
      const $id = $('#id');
      const $title = $('#title');
      const $start = $('#start_date');
      const $end = $('#end_date');
      const $po = $('#po');
      const $client = $('#client_id');
      const $site = $('#client_site_id');
      const $consultant = $('#consultant_id');
      const $candidate = $('#candidate_id');
      const $status2 = $('#status');
      const $estimated = $('#estimated_hours');
      const $currency = $('#currency');
      const $tType = $('#timesheets_type');
      const $agencyOnly = $('#agency_only_submit');
      const $shift = $('#shift');
      const $qual = $('#qualifications');
      const $duties = $('#duties');
      const $hs = $('#hs');
      const $special = $('#special');
      const $equipT = $('#equip_temp');
      const $equipC = $('#equip_client');
      const $awr = $('#awr');
      const $comments = $('#comments');
      const $nTypeA = $('#notice_type_agency');
      const $nValA = $('#notice_value_agency');
      const $nTypeC = $('#notice_type_client');
      const $nValC = $('#notice_value_client');
      const $extSrc = $('#ext_source');
      const $extId = $('#ext_id');

      // --------- Utility
      const fmtDateRange = (a,b)=>{
        const f = s=> s? new Date(s).toLocaleDateString(): '—';
        return `${f(a)} → ${f(b)}`
      }
      const enableDelete = () => {
        $('#btn-delete').disabled = selected.size===0;
        $('#btn-delete2').disabled = !current;
      };
      const openDrawer = () => { drawer.style.display='block'; if(mobile()) window.scrollTo({top:0,behavior:'smooth'}) }
      const closeDrawer = () => { drawer.style.display='none'; current=null; };
      on($('#btn-close'),'click', closeDrawer);

      // --------- Fetch wrappers (prefer Admin.api if present)
      const GET = async (url) => (await api.get?.(url)) ?? (await fetch(url).then(r=>r.json()));
      const POST = async (url, body) => (await api.post?.(url, body)) ?? (await fetch(url,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()));
      const DEL = async (url) => (await api.del?.(url)) ?? (await fetch(url,{method:'DELETE'}).then(r=>r.json()));

      // --------- Load dropdowns (clients, sites, consultants, candidates, currency map)
      let currencyByClient = {};
      async function loadDropdowns(){
        const d = await GET(ENDPOINTS.DROPDOWNS);
        // Expecting: { clients:[], clientSites:[], consultants:[], candidates:[], currenciesByClient:{client_id:[{id,code}]}}
        fill($client,d.clients,'id','name');
        fill($consultant,d.consultants,'id','email');
        fill($candidate,d.candidates,'id','name');
        currencyByClient = d.currenciesByClient || {};
        // sites will be filtered by selected client
        $site.innerHTML = '<option value="">—</option>';
      }
      function fill(sel, items, val='id', label='name'){
        sel.innerHTML = '<option value="">Please select…</option>';
        (items||[]).forEach(x=>{
          const o=document.createElement('option');
          o.value=x[val]; o.textContent=x[label]; sel.appendChild(o);
        });
      }

      // Client change → sites + currencies
      on($client,'change', ()=>{
        const id = $client.value;
        // Sites
        GET(`${ENDPOINTS.DROPDOWNS}?clientId=${encodeURIComponent(id)}`)
          .then(d => fill($site,d.clientSites || [],'id','name'));

        // Currency list by client (if provided)
        const cur = currencyByClient[id] || [];
        $currency.innerHTML = cur.length
          ? cur.map(c=>`<option value="${c.id}">${c.code||c.name||c.id}</option>`).join('')
          : `<option value="">Choose a client first</option>`;
      });

      // --------- Renderers
      function renderList(){
        const hasRows = rows.length>0;
        $rows.innerHTML = '';
        if(!hasRows){
          $rows.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px">No assignments found</td></tr>';
        }else{
          rows.forEach(r=>{
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}/></td>
              <td>
                <div style="font-weight:700">${r.title||'—'}</div>
                <div style="color:var(--muted);font-size:12px">Ref: ${r.ref||'—'}</div>
              </td>
              <td class="hide-md">${r.client_name||'—'}</td>
              <td>${r.candidate_name||'—'}</td>
              <td class="hide-md">${fmtDateRange(r.start_date,r.end_date)}</td>
              <td><span class="pill ${r.status==='complete'?'b-ok': r.status==='archived'?'b-bad':'b-warn'}">${(r.status||'').replace('_',' ')||'—'}</span></td>
              <td class="row-actions">
                <button class="btn sm ghost" data-act="open" data-id="${r.id}"><i class="fa fa-pen"></i> Edit</button>
              </td>`;
            $rows.appendChild(tr);
          });
        }

        // Mobile cards
        if(mobile()){
          $('#cards').style.display = 'grid';
          $cards.style.gridTemplateColumns='1fr';
          $cards.innerHTML = rows.map(r=>`
            <div class="panel" style="border-radius:14px;overflow:hidden">
              <div class="pad" style="display:flex;justify-content:space-between;gap:8px;align-items:center">
                <div>
                  <div style="font-weight:700">${r.title||'—'}</div>
                  <div style="color:var(--muted);font-size:12px">${r.client_name||'—'} • ${r.candidate_name||'—'}</div>
                  <div style="color:var(--muted);font-size:12px">${fmtDateRange(r.start_date,r.end_date)}</div>
                </div>
                <span class="pill ${r.status==='complete'?'b-ok': r.status==='archived'?'b-bad':'b-warn'}">${(r.status||'').replace('_',' ')||'—'}</span>
              </div>
              <div class="pad" style="border-top:1px solid var(--border);display:flex;gap:10px">
                <button class="btn sm ghost" data-act="open" data-id="${r.id}" style="flex:1 1 auto"><i class="fa fa-pen"></i> Edit</button>
                <label class="btn sm ghost" style="flex:0 0 auto">
                  <input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}/> Select
                </label>
              </div>
            </div>
          `).join('');
        } else {
          $('#cards').style.display='none';
        }

        // Update counters / UI
        $count.textContent = `${total} total`;
        $pginfo.textContent = `Page ${page}`;
        enableDelete();
      }

      // --------- Load list
      async function loadList(){
        const url = new URL(ENDPOINTS.LIST, location.origin);
        url.searchParams.set('page', page);
        url.searchParams.set('pageSize', pageSize);
        const q = $q.value.trim();
        const s = $status.value;
        if(q) url.searchParams.set('q', q);
        if(s) url.searchParams.set('status', s);

        const res = await GET(url.toString());
        rows = res.rows || res.items || [];
        total = res.total || rows.length;
        renderList();
      }

      // --------- Open one
      async function openOne(id){
        const res = await GET(`${ENDPOINTS.GET}?id=${encodeURIComponent(id)}`);
        current = res || {};
        // Fill fields
        $id.value = current.id || '';
        $title.value = current.title || '';
        $start.value = (current.start_date||'').slice(0,10);
        $end.value = (current.end_date||'').slice(0,10);
        $po.value = current.po || '';
        $client.value = current.client_id || '';
        // trigger sites + currency fill
        $client.dispatchEvent(new Event('change'));
        setTimeout(()=>{ $site.value = current.client_site_id || '' }, 50);
        $consultant.value = current.consultant_id || '';
        $candidate.value = current.candidate_id || '';
        $status2.value = current.status || 'in_progress';
        $estimated.value = current.estimated_hours || '';
        $tType.value = current.timesheets_type || 'eTimesheet';
        $agencyOnly.value = String(!!current.agency_only_submit);
        $shift.value = current.shift || 'Day';
        $qual.value = current.qualifications || '';
        $duties.value = current.duties || '';
        $hs.value = current.health_safety || '';
        $special.value = current.special || '';
        $equipT.value = current.equipment_temp || '';
        $equipC.value = current.equipment_client || '';
        $awr.value = current.awr || '';
        $comments.value = current.comments || '';
        $nTypeA.value = current.notice_type_agency || 'None';
        $nValA.value = current.notice_value_agency || '';
        $nTypeC.value = current.notice_type_client || 'None';
        $nValC.value = current.notice_value_client || '';
        $extSrc.value = current.external_source || '';
        $extId.value = current.external_id || '';
        $('#drawer-title').textContent = `Edit: ${current.title || current.ref || current.id || ''}`;
        openDrawer();
      }

      // --------- New
      function newOne(){
        current = null; $('#frm').reset(); $id.value='';
        $('#drawer-title').textContent='New assignment';
        openDrawer();
      }

      // --------- Save
      async function saveOne(ev){
        ev.preventDefault();
        const body = {
          id: $id.value || null,
          title: $title.value.trim(),
          start_date: $start.value || null,
          end_date: $end.value || null,
          po: $po.value || null,
          client_id: $client.value || null,
          client_site_id: $site.value || null,
          consultant_id: $consultant.value || null,
          candidate_id: $candidate.value || null,
          status: $status2.value || 'in_progress',
          estimated_hours: $estimated.value || null,
          currency_id: $currency.value || null,
          timesheets_type: $tType.value,
          agency_only_submit: $agencyOnly.value === 'true',
          shift: $shift.value,
          qualifications: $qual.value || null,
          duties: $duties.value || null,
          health_safety: $hs.value || null,
          special: $special.value || null,
          equipment_temp: $equipT.value || null,
          equipment_client: $equipC.value || null,
          awr: $awr.value || null,
          comments: $comments.value || null,
          notice_type_agency: $nTypeA.value || 'None',
          notice_value_agency: $nValA.value ? Number($nValA.value) : null,
          notice_type_client: $nTypeC.value || 'None',
          notice_value_client: $nValC.value ? Number($nValC.value) : null,
          external_source: $extSrc.value || null,
          external_id: $extId.value || null,
        };
        if(!body.title){ toast.warn('Please provide a Job Title'); return; }
        const res = await POST(ENDPOINTS.SAVE, body);
        if(res?.error){ toast.bad('Save failed: '+res.error); return; }
        toast.ok('Saved');
        closeDrawer();
        await loadList();
      }

      // --------- Delete
      async function deleteSelected(){
        if(selected.size===0){ return; }
        if(!confirm(`Delete ${selected.size} assignment(s)?`)) return;
        const ids = [...selected];
        const res = await DEL(`${ENDPOINTS.DELETE}?ids=${encodeURIComponent(ids.join(','))}`);
        if(res?.error){ toast.bad('Delete failed: '+res.error); return; }
        toast.ok('Deleted');
        selected.clear(); enableDelete();
        await loadList();
      }
      async function deleteCurrent(){
        if(!current?.id) return;
        if(!confirm('Delete this assignment?')) return;
        const res = await DEL(`${ENDPOINTS.DELETE}?ids=${encodeURIComponent(String(current.id))}`);
        if(res?.error){ toast.bad('Delete failed: '+res.error); return; }
        toast.ok('Deleted');
        closeDrawer();
        selected.delete(current.id);
        await loadList();
      }

      // --------- Events
      // row selection / open
      on(document,'click', e=>{
        const openBtn = e.target.closest('[data-act="open"]');
        if(openBtn){ openOne(openBtn.dataset.id); return; }
      });
      on(document,'change', e=>{
        const cb = e.target.closest('input[type="checkbox"][data-id]');
        if(cb){
          const id = Number(cb.dataset.id);
          if(cb.checked) selected.add(id); else selected.delete(id);
          enableDelete();
        }
      });

      on($selAll,'change', ()=>{
        if($selAll.checked){ rows.forEach(r=>selected.add(r.id)) } else { selected.clear(); }
        renderList();
      });

      // search (debounced)
      let t=null;
      on($q,'input', ()=>{ clearTimeout(t); t=setTimeout(()=>{ page=1; loadList(); }, 220); });
      on($status,'change', ()=>{ page=1; loadList(); });

      // paging
      on($('#prev'),'click', ()=>{ if(page>1){ page--; loadList(); }});
      on($('#next'),'click', ()=>{ page++; loadList(); });
      on($pagesize,'change', ()=>{ pageSize = Number($pagesize.value)||20; page=1; loadList(); });

      // drawer buttons
      on($('#btn-new'),'click', newOne);
      on($('#btn-refresh'),'click', loadList);
      on($('#btn-delete'),'click', deleteSelected);
      on($('#btn-delete2'),'click', deleteCurrent);
      on($('#btn-save'),'click', saveOne);

      // --------- Boot status chips
      $chips.appendChild(chip('role: admin','ok'));
      $chips.appendChild(chip('assignments:init','ok'));
      $chips.appendChild(chip('token: ok','ok'));

      // --------- Initial load
      await loadDropdowns();
      await loadList();

      // ===== Page code ends here =====
    });
  })();
  </script>
</body>
</html>
