<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Assignments — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous"/>

  <!-- Page styles (lean, matches Admin home palette) -->
  <style>
    :root{
      --navy:#1f3e78;        /* HMJ navy (slightly lighter than the very dark one) */
      --navy-600:#244685;
      --navy-100:#eaf0fb;
      --ink:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --bg:#ffffff;
      --chip:#eef2ff;
      --pill-ok:#e6f7ef;
      --pill-warn:#fff7e6;
      --pill-bad:#ffecec;
      --accent:#2563eb;
      --accent-600:#1d4ed8;
      --row:#f8fafc;
      --row-alt:#f1f5f9;
      --shadow:0 8px 24px rgba(2,6,23,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:var(--bg);
    }

    /* Top bar */
    .topbar{
      background:var(--navy);
      color:#fff;
      padding:14px 18px;
      position:sticky; top:0; z-index:30;
      box-shadow:0 2px 0 rgba(2,6,23,.06);
    }
    .topbar .wrap{max-width:1200px; margin:0 auto; display:flex; gap:14px; align-items:center; justify-content:space-between}
    .brand{display:flex; gap:12px; align-items:center}
    .brand .logo{width:28px; height:28px; border-radius:8px; background:#fff; color:var(--navy); display:grid; place-items:center; font-weight:800}
    .brand .title{font-weight:700; letter-spacing:.2px}
    .brand .tag{font-size:12px; background:#fff1; border:1px solid #ffffff33; padding:4px 10px; border-radius:999px}
    .nav-pill{color:#fff; text-decoration:none; border:1px solid #ffffff33; border-radius:14px; padding:8px 14px; transition:.15s}
    .nav-pill:hover{background:#ffffff0f}

    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{background:#ffffff14; border:1px solid #ffffff2a; color:#fff; font-size:12px; padding:6px 10px; border-radius:999px}
    .chip.ok{background:#0bbd6a1a; border-color:#0bbd6a3a}
    .chip.warn{background:#f59e0b1a; border-color:#f59e0b3a}
    .chip.bad{background:#ef44441a; border-color:#ef44443a}
    .btn-outline{background:#fff0; color:#fff; border:1px solid #ffffff66; border-radius:14px; padding:8px 14px; cursor:pointer}
    .btn-outline:hover{background:#ffffff14}

    /* Page shell */
    .page{max-width:1200px; margin:22px auto; padding:0 16px}
    .page h1{margin:0 0 10px; font-size:22px}
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:12px 0 14px;
    }
    .search{
      flex:1 1 420px; position:relative;
    }
    .search input{
      width:100%; padding:12px 38px 12px 36px; border:1px solid var(--border); border-radius:12px; outline:none;
      background:#fff;
    }
    .search i{position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted)}
    .select{
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; color:var(--ink);
    }
    .btn{
      border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600;
      background:var(--navy); color:#fff;
    }
    .btn:hover{background:var(--navy-600)}
    .btn.ghost{background:#fff; color:var(--ink); border:1px solid var(--border)}
    .btn.danger{background:#ef4444}
    .btn.danger:hover{background:#dc2626}
    .btn.icon{display:flex; gap:8px; align-items:center}

    /* Card + table */
    .card{background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .head{
      display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--border); background:var(--row);
      border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
    }
    .muted{color:var(--muted)}
    .small{font-size:12px}

    table{
      width:100%; border-collapse:separate; border-spacing:0;
    }
    thead th{
      text-align:left; font-size:12px; letter-spacing:.04em; color:var(--muted); padding:12px 14px; background:var(--row);
      border-bottom:1px solid var(--border);
    }
    tbody td{
      padding:13px 14px; border-bottom:1px solid var(--border); vertical-align:middle;
    }
    tbody tr:nth-child(2n){background:var(--row-alt)}
    .status{font-size:12px; padding:4px 8px; border-radius:999px; display:inline-block}
    .status.live{background:var(--pill-ok); color:#166534}
    .status.draft{background:var(--pill-warn); color:#92400e}
    .status.complete{background:#eef2f7; color:#334155}

    .footerbar{
      display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#fff; border-top:1px solid var(--border); border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius);
    }
    .pager{display:flex; gap:8px; align-items:center}
    .pager .btn{padding:8px 12px}
    .select-pages{border:1px solid var(--border); padding:6px 10px; border-radius:10px}

    /* Drawer (Quick view) */
    .drawer-backdrop{display:none; position:fixed; inset:0; background:rgba(15,23,42,.35); z-index:60}
    .drawer{position:fixed; top:0; right:-520px; width:520px; max-width:96vw; height:100%; background:#fff; border-left:1px solid var(--border); box-shadow:var(--shadow); z-index:70; transition:right .22s ease}
    .drawer.open{right:0}
    .drawer-backdrop.show{display:block}
    .drawer .drawer-head{display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid var(--border)}
    .drawer .drawer-body{padding:14px; display:grid; gap:14px}
    .kv{display:grid; grid-template-columns:130px 1fr; gap:6px 10px; font-size:14px}
    .kv .k{color:var(--muted)}
    .subcard{border:1px solid var(--border); border-radius:12px; padding:12px}
    .subcard h4{margin:0 0 8px}
    .empty{color:var(--muted); font-style:italic}

    /* Mobile tweaks */
    @media (max-width:720px){
      .actions .chip{display:none}
      .footerbar{flex-direction:column; gap:10px}
      .kv{grid-template-columns:1fr}
    }

    /* Toast (provided by common.js uses #toast) */
    #toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); z-index:90; display:none}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; display:inline-block; margin-right:6px; background:var(--chip)}
    .b-warn{background:var(--pill-warn)}
    .b-bad{background:var(--pill-bad)}
  </style>

  <!-- Shared admin helpers -->
  <!-- after (works from /admin-v2/admin/assignments.html) -->
  <script defer src="./common.js?v=11"></script>


</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo">H</div>
        <div class="title">HMJ Global — <span class="title">Admin</span></div>
        <a class="nav-pill" href="./index.html">← Dashboard</a>
      </div>
      <div class="actions">
        <!-- debug chips land here -->
        <div id="diagChips" class="chips"></div>
        <button id="btnSignOut" class="btn-outline"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sign out</button>
      </div>
    </div>
  </header>

  <main class="page">
    <h1>Assignments</h1>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="q" type="search" placeholder="Search (title, ref, client, candidate)…" />
      </div>
      <select id="status" class="select" title="Filter by status">
        <option value="">All statuses</option>
        <option value="live">Live</option>
        <option value="draft">Draft</option>
        <option value="complete">Complete</option>
        <option value="archived">Archived</option>
      </select>
      <button id="btnRefresh" class="btn icon"><i class="fa-solid fa-rotate"></i> Refresh</button>
      <button id="btnNew" class="btn icon"><i class="fa-solid fa-plus"></i> New assignment</button>
      <button id="btnDelete" class="btn danger icon" disabled><i class="fa-solid fa-trash"></i> Delete</button>
    </div>

    <!-- Table card -->
    <section class="card" id="tableCard">
      <div class="head">
        <div><strong>All assignments</strong> <span class="muted small" id="total">(0 total)</span></div>
      </div>

      <div style="overflow:auto">
        <table id="grid">
          <thead>
            <tr>
              <th style="width:44px;"><input id="checkAll" type="checkbox" /></th>
              <th>TITLE</th>
              <th>CLIENT</th>
              <th>CANDIDATE</th>
              <th style="min-width:190px;">DATES</th>
              <th>STATUS</th>
              <th style="min-width:120px;">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="muted" style="text-align:center; padding:28px">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footerbar">
        <div class="pager">
          <button id="prev" class="btn ghost">&larr; Prev</button>
          <button id="next" class="btn ghost">Next &rarr;</button>
          <span class="muted small" id="pageLabel">Page 1</span>
        </div>
        <div>
          <select id="pageSize" class="select-pages">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer (Quick View) -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <div id="drawerTitle" style="font-weight:700">Assignment</div>
        <div id="drawerSub" class="muted small"></div>
      </div>
      <button id="drawerClose" class="btn ghost"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>
    <div class="drawer-body">
      <div class="subcard">
        <h4>Quick view</h4>
        <div class="kv" id="kvBasics">
          <!-- Filled by JS -->
        </div>
      </div>
      <div class="subcard">
        <h4>Latest timesheet</h4>
        <div id="latestTs" class="empty">No data (assignment not live, or no timesheets yet).</div>
      </div>
      <div class="subcard">
        <h4>Internal notes</h4>
        <textarea id="notes" rows="3" placeholder="Internal notes… (not sent to client)" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px"></textarea>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="saveNotes" class="btn">Save</button>
          <button id="openFull" class="btn ghost">Open full assignment</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- toast container -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Page script -->
  <script>
  /* global Admin */
  Admin.bootAdmin(async ({ api, sel, toast }) => {
    // -------------------------- tiny helpers --------------------------
    const chip = (t, tone='info') => {
      const s = document.createElement('span');
      s.className='pill';
      s.textContent=t;
      if (tone==='warn') s.classList.add('b-warn');
      if (tone==='bad')  s.classList.add('b-bad');
      sel('#diagChips')?.appendChild(s);
      return s;
    };

    let page=1, pageSize=Number(sel('#pageSize').value||20), total=0;
    let current=null;
    const selected = new Set();

    const openDrawer =()=>{ sel('#drawer').classList.add('open'); sel('#drawerBackdrop').classList.add('show'); };
    const closeDrawer=()=>{ sel('#drawer').classList.remove('open'); sel('#drawerBackdrop').classList.remove('show'); current=null; };

    // sign out + debug chips from common.js
    sel('#btnSignOut')?.addEventListener('click', () => Admin.signOut());

    // -----------------------------------------------------------------
    // load grid
    // -----------------------------------------------------------------
    async function load() {
      const q = sel('#q').value.trim();
      const status = sel('#status').value.trim() || null;
      sel('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center; padding:28px">Loading…</td></tr>`;

      console.groupCollapsed('%c[assignments] list', 'color:#2563eb; font-weight:700');
      console.log({ page, pageSize, q, status });

      try {
        const res = await api('admin-assignments-list', { page, pageSize, q, status });
        total = res?.total || 0;
        const items = res?.items || [];

        sel('#total').textContent = `(${total} total)`;
        sel('#pageLabel').textContent = `Page ${page}`;

        if (!items.length) {
          sel('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center; padding:30px">No assignments found.</td></tr>`;
          console.log('No items');
          console.groupEnd();
          return;
        }

        const html = items.map(r => {
          const live = r.status==='live' || (r.candidate_id && r.start_date && !r.end_date);
          const st = live ? 'live' : (r.status || 'draft');
          const statusChip = `<span class="status ${st}">${st}</span>`;
          const dates = [r.start_date||'—', r.end_date||'—'].join(' → ');
          return `
          <tr data-id="${r.id}">
            <td><input type="checkbox" data-id="${r.id}" class="rowcheck"/></td>
            <td><a href="#" class="row-open" data-id="${r.id}">${r.title || '—'}</a><div class="small muted">${r.po_number ? 'PO '+r.po_number : ''}</div></td>
            <td>${r.client_name||'—'}</td>
            <td>${r.candidate_name||'—'}</td>
            <td>${dates}</td>
            <td>${statusChip}</td>
            <td>
              <button class="btn ghost small row-open" data-id="${r.id}"><i class="fa-regular fa-eye"></i> Quick view</button>
              <button class="btn ghost small row-edit" data-id="${r.id}"><i class="fa-regular fa-pen-to-square"></i> Edit</button>
            </td>
          </tr>`;
        }).join('');
        sel('#rows').innerHTML = html;

        // Wire up row actions
        document.querySelectorAll('.row-open').forEach(el => el.addEventListener('click', (e)=>{
          e.preventDefault();
          const id = el.getAttribute('data-id');
          openQuickView(id);
        }));
        document.querySelectorAll('.row-edit').forEach(el => el.addEventListener('click', (e)=>{
          e.preventDefault();
          const id = el.getAttribute('data-id');
          location.href = `/admin-v2/admin/assignment?id=${encodeURIComponent(id)}`;
        }));
        document.querySelectorAll('.rowcheck').forEach(el => el.addEventListener('change', (e)=>{
          const id = el.getAttribute('data-id');
          if (el.checked) selected.add(id); else selected.delete(id);
          sel('#btnDelete').disabled = selected.size===0;
        }));
        sel('#checkAll').checked=false;

        console.groupEnd();
        chip('assignments:init','ok');
      } catch (err){
        console.groupEnd();
        console.error('list error', err);
        toast('Failed to load assignments', 'bad', 4500);
        chip('list: fail','bad');
        sel('#rows').innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center; padding:30px">Error loading assignments.</td></tr>`;
      }
    }

    // -----------------------------------------------------------------
    // open quick view + fetch details + latest timesheet
    // -----------------------------------------------------------------
    async function openQuickView(id){
      current = id;
      openDrawer();
      sel('#kvBasics').innerHTML = `<div class="muted">Loading…</div>`;
      sel('#latestTs').innerHTML = `<span class="muted">Loading…</span>`;

      console.groupCollapsed('%c[assignments] open', 'color:#2563eb; font-weight:700');
      console.log({ id });

      try{
        const res = await api('admin-assignments-get', { id });
        console.log('detail', res);
        const a = res?.assignment || res;

        // Header
        sel('#drawerTitle').textContent = a?.title || 'Assignment';
        sel('#drawerSub').textContent = a?.client_name ? `${a.client_name} • ${a.po_number||'No PO'}` : '';

        // Status + basics
        const live = a?.status==='live' || (!!a?.candidate_id && !!a?.start_date && !a?.end_date);
        const st = live ? 'live' : (a?.status || 'draft');
        const kv = [
          ['Status', `<span class="status ${st}">${st}</span>`],
          ['Client', a?.client_name || '—'],
          ['Candidate', a?.candidate_name || '—'],
          ['PO number', a?.po_number || '—'],
          ['Dates', [a?.start_date||'—', a?.end_date||'—'].join(' → ')],
          ['Shift', a?.shift || 'Day'],
          ['Expected hours', a?.estimated_hours || '—']
        ].map(([k,v])=>`<div class="k">${k}</div><div>${v}</div>`).join('');
        sel('#kvBasics').innerHTML = kv || '<div class="empty">No details.</div>';

        // Latest timesheet (only if live)
        if (live) {
          try{
            const ts = await api('admin-timesheets-list', { assignmentId:id, limit:1, order:'desc' });
            const item = ts?.items?.[0];
            if (item){
              sel('#latestTs').innerHTML = `
                <div class="kv">
                  <div class="k">Week</div><div>${item.week_commencing||'—'}</div>
                  <div class="k">Hours</div><div>${item.total_hours??'—'}</div>
                  <div class="k">Status</div><div><span class="status ${item.status||'draft'}">${item.status||'draft'}</span></div>
                </div>
                <div style="margin-top:8px">
                  <a class="btn ghost" href="./timesheets.html?assignment=${encodeURIComponent(id)}">Open in Timesheets</a>
                </div>
              `;
            } else {
              sel('#latestTs').innerHTML = `<div class="empty">No timesheets yet.</div>`;
            }
          }catch(tsErr){
            console.warn('timesheets load failed', tsErr);
            sel('#latestTs').innerHTML = `<div class="empty">Could not load latest timesheet.</div>`;
          }
        } else {
          sel('#latestTs').innerHTML = `<div class="empty">Not live — no timesheets.</div>`;
        }

        chip('open:ok','ok');
        console.groupEnd();
      }catch(err){
        console.groupEnd();
        chip('open:fail','bad');
        toast('Failed to open assignment', 'bad', 4500);
      }
    }

    // -----------------------------------------------------------------
    // New assignment (lightweight create)
    // -----------------------------------------------------------------
    sel('#btnNew').addEventListener('click', async ()=>{
      // Bare-minimum create flow: server will set draft
      const title = prompt('Job title *');
      if (!title) return;

      try{
        const created = await api('admin-assignments-save', { title, status:'draft' });
        toast('Draft assignment created', 'ok');
        page = 1;
        await load();
        if (created?.id) openQuickView(created.id);
      }catch(err){
        console.error('create failed', err);
        toast('Could not create assignment', 'bad');
      }
    });

    // -----------------------------------------------------------------
    // Delete selected
    // -----------------------------------------------------------------
    sel('#btnDelete').addEventListener('click', async ()=>{
      if (!selected.size) return;
      if (!confirm(`Delete ${selected.size} assignment(s)? This cannot be undone.`)) return;
      try{
        const ids = Array.from(selected);
        await api('admin-assignments-delete', { ids });
        toast('Deleted', 'ok');
        selected.clear();
        sel('#btnDelete').disabled = true;
        await load();
      }catch(err){
        console.error('delete failed', err);
        toast('Delete failed', 'bad');
      }
    });

    // -----------------------------------------------------------------
    // Notes (demo save using assignment-update)
    // -----------------------------------------------------------------
    sel('#saveNotes').addEventListener('click', async ()=>{
      if (!current) return;
      try{
        const notes = sel('#notes').value.trim();
        await api('admin-assignments-update', { id: current, notes });
        toast('Notes saved', 'ok');
      }catch(err){
        console.error('notes save failed', err);
        toast('Could not save notes', 'bad');
      }
    });

    // -----------------------------------------------------------------
    // Drawer controls
    // -----------------------------------------------------------------
    sel('#drawerClose').addEventListener('click', closeDrawer);
    sel('#drawerBackdrop').addEventListener('click', closeDrawer);
    sel('#openFull').addEventListener('click', ()=>{
      if (current) location.href = `/admin-v2/admin/assignment?id=${encodeURIComponent(current)}`;
    });

    // -----------------------------------------------------------------
    // Filters + pagination
    // -----------------------------------------------------------------
    let qTimer=null;
    sel('#q').addEventListener('input', ()=>{
      clearTimeout(qTimer);
      qTimer = setTimeout(()=>{ page=1; load(); }, 300);
    });
    sel('#status').addEventListener('change', ()=>{ page=1; load(); });
    sel('#btnRefresh').addEventListener('click', ()=> load());
    sel('#prev').addEventListener('click', ()=>{ if (page>1){ page--; load(); }});
    sel('#next').addEventListener('click', ()=>{
      const max = Math.ceil(total / pageSize) || 1;
      if (page < max){ page++; load(); }
    });
    sel('#pageSize').addEventListener('change', ()=>{
      pageSize = Number(sel('#pageSize').value)||20; page=1; load();
    });
    sel('#checkAll').addEventListener('change', ()=>{
      const checks = document.querySelectorAll('.rowcheck');
      selected.clear();
      checks.forEach(c => { c.checked = sel('#checkAll').checked; if (c.checked) selected.add(c.getAttribute('data-id')); });
      sel('#btnDelete').disabled = selected.size===0;
    });

    // Boot diagnostics
    chip('init: ok','ok');

    // Initial load
    await load();
  });
  </script>
</body>
</html>
