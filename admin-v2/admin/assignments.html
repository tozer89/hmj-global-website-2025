<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Assignments — Admin | HMJ Global</title>

  <!-- Pin Identity to live site (one way is enough; same as candidates.html) -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>

  <!-- Identity widget FIRST -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared admin bootstrap (same-folder path) -->
  <script defer src="./common.js?v=16"></script>

  <style>
    :root{
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#1f3b7a; --blue-2:#29478f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --success:#16a34a; --danger:#dc2626; --warn:#f59e0b;
      --chip:#eef2ff;
    }
    * { box-sizing: border-box; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:50;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1400px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .brand a{display:inline-flex;gap:8px;align-items:center;color:#fff;text-decoration:none}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;display:grid;place-items:center;color:var(--blue);font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;user-select:none}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px;font-weight:700}
    .btn.danger{background:#7a1f28;border-color:#7a1f28}
    .btn.icon{display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
    .wrap{max-width:1400px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .bar{position:sticky;top:64px;z-index:45;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=text], input[type=search], input[type=date], input[type=email], select, textarea{
      border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;min-width:180px;font:inherit
    }
    input[type=search]{ min-width:280px; }
    table{border-collapse:separate;border-spacing:0;width:100%;background:#fff;border:1px solid var(--stroke);border-radius:14px;overflow:hidden}
    thead th{position:sticky;top:0;background:#fbfdff;border-bottom:1px solid var(--stroke);text-align:left;padding:10px 12px;font-weight:800}
    tbody td{border-top:1px solid var(--stroke);padding:10px 12px;vertical-align:middle}
    tbody tr:hover{background:#f8fafc}
    .muted{color:var(--muted)}
    .pill{display:inline-grid;align-items:center;padding:4px 10px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:9999px;border:1px solid var(--stroke);cursor:pointer;background:#fff;font-weight:700}
    .chip.active{background:var(--chip)}
    .metrics{display:flex;gap:12px;flex-wrap:wrap}
    .metric{background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-weight:800}
    .menu{position:relative}
    .menu > .sheet{display:none;position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--stroke);border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,.18);min-width:220px;padding:8px}
    .menu.open > .sheet{display:block}
    .sheet label{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .sheet label:hover{background:#f8fafc}

    /* Layout: table + QuickViews */
    .grid-main{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
    @media (max-width:1100px){ .grid-main{grid-template-columns:1fr} }
    .qv{position:sticky;top:116px;background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:14px;min-height:120px}
    .qv h4{margin:0 0 8px}
    .qv .rows{display:grid;grid-template-columns:1fr;gap:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px}
    .kv b{color:#334155}

    /* Drawer (editor) */
    .drawer{position:fixed;inset:0 0 0 auto;max-width:760px;width:95vw;background:#fff;box-shadow:-4px 0 24px rgba(2,6,23,.24);transform:translateX(100%);transition:transform .24s ease;z-index:60;display:grid;grid-template-rows:auto 1fr auto}
    .drawer.open{transform:translateX(0)}
    .d-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--stroke);background:var(--card)}
    .d-body{padding:16px;overflow:auto}
    .d-foot{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--stroke);background:#fff}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 12px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:#fff;cursor:pointer;font-weight:700}
    .tab.active{background:var(--chip)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
    .field{display:grid;gap:6px}
    .field label{font-weight:700;font-size:13px}
    .hr{height:1px;background:var(--stroke);margin:8px 0 4px}
    .right{display:flex;gap:8px;align-items:center}
    .link{color:var(--blue);text-decoration:underline;cursor:pointer}
    :focus{outline:3px solid var(--ring);outline-offset:2px;border-radius:8px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  </style>
</head>

<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Assignments</span>
    </div>
    <div class="sp"></div>
    <div id="diagChips" class="chips"></div>
    <a class="btn ghost" href="./index.html">⟵ Dashboard</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <!-- toolbar -->
    <div class="card bar">
      <input id="q" type="search" placeholder="Search (title, ref, client, candidate)…" />
      <div class="chips" id="statusChips">
        <span data-status="" class="chip active">All statuses</span>
        <span data-status="Draft"     class="chip">Draft</span>
        <span data-status="Complete"  class="chip">Complete</span>
        <span data-status="Live"      class="chip">Live</span>
        <span data-status="Archived"  class="chip">Archived</span>
      </div>

      <button class="btn small" id="btnRefresh">⟳ Refresh</button>

      <div class="sp"></div>

      <div class="menu" id="colMenu">
        <button class="btn ghost small icon" id="btnCols">Columns ▾</button>
        <div class="sheet" id="colSheet"></div>
      </div>

      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost small" id="btnExport">Export CSV</button>
      <button class="btn ghost small" id="btnExportSel" disabled>Export selected</button>
      <button class="btn ghost small" id="btnImport">Import CSV</button>
      <button class="btn small" id="btnNew">+ New assignment</button>
      <button class="btn danger small" id="btnDelete" disabled>Delete</button>
    </div>

    <!-- metrics -->
    <div class="metrics" id="metrics"></div>

    <!-- main grid: table + quick views -->
    <div class="grid-main">
      <div>
        <div class="card" id="listWrap">Loading…</div>
        <div class="pager" id="pager" style="display:none">
          <div class="muted" id="pgInfo"></div>
          <div class="sp"></div>
          <select id="pgSize">
            <option>20</option><option>50</option><option>100</option>
          </select>
          <button class="btn small ghost" id="pgPrev">◀</button>
          <button class="btn small ghost" id="pgNext">▶</button>
        </div>
      </div>

      <!-- Quick View: 2 panes -->
      <aside class="qv" id="qv" aria-live="polite">
        <h4 class="muted">Quick view — Assignment</h4>
        <div class="rows" id="qvRows">
          <div class="empty">Select an assignment to preview details here.</div>
        </div>
        <div class="hr"></div>
        <h4 class="muted">Latest timesheet</h4>
        <div class="rows" id="latestTS">
          <div class="empty">Not live — no timesheets yet.</div>
        </div>
        <div class="hr"></div>
        <div class="right">
          <a id="qvOpen" class="btn small" href="#" style="display:none">Open full assignment</a>
          <a id="qvOpenTs" class="btn ghost small" href="#" style="display:none">Open in Timesheets</a>
          <button id="qvEdit" class="btn ghost small" style="display:none">Edit</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Drawer editor -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <strong id="dTitle">New assignment</strong>
      <span class="sp"></span>
      <button class="btn ghost small" id="btnClose">✕ Close</button>
    </div>
    <div class="d-body">
      <div class="tabs" id="tabs"></div>
      <form id="frm" class="grid" autocomplete="off"></form>
    </div>
    <div class="d-foot">
      <div class="muted">Ref: <span id="dRef">—</span></div>
      <div class="right">
        <button class="btn ghost" id="btnSaveDraft" type="button">Save</button>
        <button class="btn" id="btnSaveClose" type="button">Save & Close</button>
      </div>
    </div>
  </aside>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Single page boot -->
  <script>
  (function startAssignments(){
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function' || !window.netlifyIdentity) {
      return setTimeout(startAssignments, 30);
    }

    Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
      // --- diag chips ---
      const chips = sel('#diagChips');
      const chip = (t, tone='ok') => {
        if (!chips) return;
        const s=document.createElement('span');
        s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
        s.textContent=t; chips.appendChild(s);
      };
      chip('assignments:init','ok');

      const who = await identity('admin');
      if (!who || !who.ok) {
        chip('role: blocked','bad');
        const g = sel('#gate'), app = sel('#app');
        if (app) app.style.display = 'none';
        if (g) { g.style.display = ''; const why=g.querySelector('.why'); if (why) why.textContent='Restricted. Sign in with an admin account.'; }
        return;
      }
      chip('role: admin','ok'); chip('token: ok','ok'); chip('trace: '+getTrace().slice(0,10),'ok');

      // ----- state -----
      let allRows = [];       // fetched
      let viewRows = [];      // after filters
      let selected = new Set();
      let sort = { key:'id', dir:'desc' }; // newest first
      let editingId = null;
      let currentTab = 'Basics';
      let page = 1, pageSize = 20;
      let activeStatus = '';

      // columns (toggleable)
      const columns = [
        { key:'title',          label:'Title',   show:true },
        { key:'client_name',    label:'Client',  show:true },
        { key:'candidate_name', label:'Candidate', show:true },
        { key:'dates',          label:'Dates',   show:true, width:'220px' },
        { key:'status',         label:'Status',  show:true, width:'130px' },
        { key:'ref',            label:'Ref',     show:false, width:'110px' },
        { key:'po_number',      label:'PO',      show:false, width:'120px' },
        { key:'updated_at',     label:'Updated', show:false, width:'150px' }
      ];

      // ----- helpers -----
      const $ = sel;
      const enableDelete = () => { $('#btnDelete').disabled = selected.size===0; $('#btnExportSel').disabled = selected.size===0; };
      const drawer = $('#drawer');
      const openDrawer = () => drawer.classList.add('open');
      const closeDrawer = () => { drawer.classList.remove('open'); setTimeout(()=>resetForm(),150); };
      $('#btnClose').onclick = closeDrawer;

      function pillForStatus(s){
        const map = { 'Live':'b-ok', 'Complete':'b-warn', 'Draft':'b-warn', 'Archived':'b-bad' };
        const tone = map[s] || 'b-warn';
        return `<span class="pill ${tone}">${s||'Draft'}</span>`;
      }

      function dateRange(a,b){
        try {
          const A = a ? new Date(a) : null, B = b ? new Date(b) : null;
          const fmt = (d)=> d ? d.toLocaleDateString() : '—';
          if (!A && !B) return '—';
          return `${fmt(A)} → ${fmt(B)}`;
        }catch{ return '—'; }
      }
      function fmtDate(d){
        try{ return new Date(d).toLocaleString(); }catch{ return d||'—'; }
      }

      function computeMetrics(rows){
        const total = rows.length;
        const by = (st) => rows.filter(r => (r.status||'Draft')===st).length;
        $('#metrics').innerHTML = `
          <div class="metric">Total: ${total}</div>
          <div class="metric">Draft: ${by('Draft')}</div>
          <div class="metric">Complete: ${by('Complete')}</div>
          <div class="metric">Live: ${by('Live')}</div>
          <div class="metric">Archived: ${by('Archived')}</div>`;
      }

      function buildColMenu(){
        const host = $('#colSheet'); host.innerHTML = '';
        columns.forEach((c, idx)=>{
          const id = 'col_'+c.key;
          const row = document.createElement('label');
          row.innerHTML = `<input type="checkbox" id="${id}" ${c.show?'checked':''}/> ${c.label}`;
          row.querySelector('input').onchange = (e)=>{ columns[idx].show = e.target.checked; render(); };
          host.appendChild(row);
        });
        const menu = $('#colMenu');
        $('#btnCols').onclick = ()=> menu.classList.toggle('open');
        document.addEventListener('click',(e)=>{
          if (!menu.contains(e.target)) menu.classList.remove('open');
        });
      }

      function buildHeader(){
        const heads = [];
        heads.push(`<th style="width:28px"><input id="ckAll" type="checkbox" ${selected.size && viewRows.length && selected.size>=viewRows.length?'checked':''}></th>`);
        columns.forEach(c=>{
          if(!c.show) return;
          const arrow = sort.key===c.key ? (sort.dir==='asc'?'▲':'▼') : '';
          heads.push(`<th style="${c.width?`width:${c.width}`:''};cursor:pointer" data-sort="${c.key}">${c.label} ${arrow}</th>`);
        });
        heads.push(`<th style="width:150px"></th>`);
        return `<thead><tr>${heads.join('')}</tr></thead>`;
      }

      function applyFilters(){
        const q = ($('#q')?.value || '').trim().toLowerCase();
        viewRows = allRows.filter(r=>{
          const hit = (v) => (String(v||'').toLowerCase().includes(q));
          const okQ = !q || hit(r.title)||hit(r.ref)||hit(r.client_name)||hit(r.candidate_name)||hit(r.po_number);
          const okS = !activeStatus || (r.status||'Draft')===activeStatus;
          return okQ && okS;
        });
        // sort
        viewRows.sort((a,b)=>{
          const ka = (sort.key==='dates') ? (a.start_date||'') : (a[sort.key] ?? '');
          const kb = (sort.key==='dates') ? (b.start_date||'') : (b[sort.key] ?? '');
          if (ka==kb) return 0;
          return (ka>kb?1:-1) * (sort.dir==='asc'?1:-1);
        });
        computeMetrics(viewRows);
      }

      function renderPager(){
        const host = $('#pager');
        if (!viewRows.length){ host.style.display='none'; return; }
        host.style.display='';
        const totalPages = Math.max(1, Math.ceil(viewRows.length / pageSize));
        if (page>totalPages) page = totalPages;
        $('#pgInfo').textContent = `Page ${page} of ${totalPages} (${viewRows.length} items)`;
        $('#pgPrev').disabled = page<=1;
        $('#pgNext').disabled = page>=totalPages;
      }

      function render(){
        applyFilters();
        const wrap = $('#listWrap');
        if (!viewRows.length) { wrap.innerHTML = `<div class="empty">No assignments match your filters.</div>`; renderPager(); return; }

        const start = (page-1)*pageSize;
        const rows = viewRows.slice(start, start+pageSize);

        const body = rows.map(r=>{
          const cells = [];
          cells.push(`<td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>`);
          columns.forEach(c=>{
            if(!c.show) return;
            let val = '—';
            if (c.key==='dates') val = dateRange(r.start_date, r.end_date);
            else if (c.key==='status') val = pillForStatus(r.status||'Draft');
            else if (c.key==='updated_at') val = fmtDate(r.updated_at||r.created_at);
            else val = r[c.key] ?? '—';
            cells.push(`<td>${val}</td>`);
          });
          cells.push(`<td>
            <button class="btn ghost small" data-open="${r.id}">Open</button>
            <button class="btn ghost small" data-quick="${r.id}">Quick view</button>
          </td>`);
          return `<tr data-row="${r.id}">${cells.join('')}</tr>`;
        }).join('');

        wrap.innerHTML = `<table>${buildHeader()}<tbody>${body}</tbody></table>`;
        renderPager();

        // header sort + select-all
        wrap.querySelectorAll('th[data-sort]').forEach(th=>{
          th.onclick = ()=>{
            const k = th.getAttribute('data-sort');
            if (sort.key===k) sort.dir = (sort.dir==='asc'?'desc':'asc');
            else { sort.key = k; sort.dir = 'asc'; }
            render();
          };
        });
        const ckAll = $('#ckAll');
        if (ckAll) ckAll.onclick = (e)=>{
          const ids = rows.map(r=>r.id);
          if (e.target.checked) ids.forEach(id=>selected.add(id));
          else ids.forEach(id=>selected.delete(id));
          enableDelete(); render();
        };

        // row-level wires
        wrap.querySelectorAll('input[type=checkbox][data-id]').forEach(c=>{
          c.onchange = ()=>{
            const id = Number(c.getAttribute('data-id'));
            if (c.checked) selected.add(id); else selected.delete(id);
            enableDelete();
          };
        });
        wrap.querySelectorAll('[data-open]').forEach(b=>{
          b.onclick = ()=> openOne(Number(b.getAttribute('data-open')));
        });
        wrap.querySelectorAll('tr[data-row]').forEach(tr=>{
          tr.addEventListener('click',(e)=>{
            if (e.target.closest('button') || e.target.closest('input')) return;
            const id = Number(tr.getAttribute('data-row'));
            showQuick(id);
          });
        });
        wrap.querySelectorAll('[data-quick]').forEach(b=>{
          b.onclick = (e)=>{ e.stopPropagation(); showQuick(Number(b.getAttribute('data-quick'))); };
        });
      }

      function renderQuick(r){
        const host = $('#qvRows');
        if (!r){ 
          host.innerHTML = `<div class="empty">Select an assignment to preview details here.</div>`;
          $('#qvOpen').style.display='none';
          $('#qvEdit').style.display='none';
          $('#qvOpenTs').style.display='none';
          $('#latestTS').innerHTML = `<div class="empty">Not live — no timesheets yet.</div>`;
          return;
        }
        const live = (r.status === 'Live');
        host.innerHTML = `
          <div class="kv"><b>Status</b><div>${pillForStatus(r.status||'Draft')}</div></div>
          <div class="kv"><b>Client</b><div>${r.client_name||'—'}</div></div>
          <div class="kv"><b>Candidate</b><div>${r.candidate_name||'—'}</div></div>
          <div class="kv"><b>PO number</b><div>${r.po_number||'—'}</div></div>
          <div class="kv"><b>Dates</b><div>${dateRange(r.start_date, r.end_date)}</div></div>
          <div class="kv"><b>Shift</b><div>${r.shift||'Day'}</div></div>
          <div class="kv"><b>Expected days / hours</b><div>${r.estimated_hours||'—'}</div></div>
        `;
        const link = `./timesheets.html?assignment=${encodeURIComponent(r.id)}`;
        $('#qvOpenTs').href = link; 
        $('#qvOpenTs').style.display = live ? '' : 'none';
        $('#qvOpen').href = `./assignments.html?id=${encodeURIComponent(r.id)}`; // placeholder (same page)
        $('#qvOpen').style.display='';
        $('#qvEdit').style.display=''; 
        $('#qvEdit').onclick = ()=> openEditor(r);
      }

      // Latest timesheet section
      async function renderLatestTS(assignmentId, status){
        const host = $('#latestTS');
        if (status !== 'Live') {
          host.innerHTML = `<div class="empty">Not live — no timesheets yet.</div>`;
          return;
        }
        try{
          const tsr = await api('admin-timesheets-list','POST',{ assignmentId, limit: 1, order:'desc' });
          const item = tsr?.items?.[0];
          if (!item){
            host.innerHTML = `<div class="empty">No timesheets yet.</div>`;
            return;
          }
          host.innerHTML = `
            <div class="kv">
              <div class="k"><b>Week</b></div><div>${item.week_commencing||'—'}</div>
              <div class="k"><b>Hours</b></div><div>${item.total_hours??'—'}</div>
              <div class="k"><b>Status</b></div><div><span class="pill ${item.status==='Approved'?'b-ok':item.status==='Rejected'?'b-bad':'b-warn'}">${item.status||'Draft'}</span></div>
            </div>
            <div style="margin-top:8px">
              <a class="btn ghost" href="./timesheets.html?assignment=${encodeURIComponent(assignmentId)}">Open in Timesheets</a>
            </div>`;
        }catch(e){
          console.warn('[assignments] timesheets load failed', e);
          host.innerHTML = `<div class="empty">Could not load latest timesheet.</div>`;
        }
      }

      // ----- data ops -----
      async function load(){
        const wrap = $('#listWrap'); wrap.textContent = 'Loading…';
        try{
          const res = await api('admin-assignments-list','POST',{
            q: ($('#q')?.value || '').trim(),
            status: activeStatus || ''
          });
          // Expect array or { rows: [] }
          allRows = Array.isArray(res) ? res : (res.rows || []);
          // normalize computed fields:
          allRows.forEach(r=>{
            r.dates = dateRange(r.start_date, r.end_date);
            r.candidate_name = r.candidate_name || r.candidateFullName || r.candidate || null;
          });
          page = 1; selected.clear(); enableDelete();
          render(); renderQuick(null);
        }catch(e){
          console.error('[assignments] list error', e);
          wrap.textContent = 'Error: ' + (e.message || e);
        }
      }

      async function openOne(id){
        try{
          const r = await api('admin-assignment-get','POST',{ id });
          editingId = id;
          openEditor(r);
          toast('Opened ' + (r.title || (`ID ${id}`)), 'info', 1800);
        }catch(e){
          console.error('[assignments] open error', e);
          toast('Open failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function showQuick(id){
        try{
          const r = await api('admin-assignment-get','POST',{ id });
          renderQuick(r);
          await renderLatestTS(r.id, r.status);
        }catch(e){
          renderQuick(null);
          $('#latestTS').innerHTML = `<div class="empty">Could not load latest timesheet.</div>`;
        }
      }

      async function delSelected(){
        if (!selected.size) return;
        if (!confirm(`Delete ${selected.size} assignment(s)?`)) return;
        try{
          await api('admin-assignments-delete','POST',{ ids: Array.from(selected) });
          toast('Deleted','ok',1800);
          selected.clear(); enableDelete(); load();
        }catch(e){
          console.error('[assignments] delete error', e);
          toast('Delete failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function exportCSV(selectedOnly=false){
        try{
          if (selectedOnly && !selected.size) { toast('No rows selected', 'warn', 2000); return; }
          const payload = selectedOnly ? { ids: Array.from(selected) } : {
            q: ($('#q')?.value || '').trim(),
            status: activeStatus || ''
          };
          const csv = await api('admin-assignments-export','POST', payload);
          const blob = new Blob([csv], { type:'text/csv' });
          const url = URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download='assignments.csv'; a.click();
          URL.revokeObjectURL(url);
          toast('Exported','ok',1400);
        }catch(e){
          console.error('[assignments] export error', e);
          toast('Export failed: ' + (e.message || e), 'error', 4200);
        }
      }
      function importCSVClick(){ $('#csv')?.click(); }
      async function importCSVDo(file){
        try{
          const text = await file.text();
          const res  = await api('admin-assignments-import','POST',{ csv:text });
          toast(`Imported ${res?.inserted ?? 0}`,'ok',2000);
          load();
        }catch(e){
          console.error('[assignments] import error', e);
          toast('Import failed: ' + (e.message || e), 'error', 4200);
        }
      }

      // ----- editor (drawer) -----
      const schemaTabs = [
        { name:'Basics', fields:[
          ['title','Job title'],['status','Status','select','Draft,Complete,Live,Archived'],
          ['ref','Internal ref'],['po_number','PO number'],
          ['start_date','Start date','date'],['end_date','End date','date'],
          ['shift','Shift','select','Day,Night'],
          ['estimated_hours','Expected days / hours']
        ]},
        { name:'Parties', fields:[
          ['client_name','Client'],['client_site','Client site'],
          ['candidate_name','Candidate'],['consultant','Consultant']
        ]},
        { name:'Payment', fields:[
          ['currency','Currency'],['pay_frequency','Pay frequency'],
          ['timesheets_type','Timesheets type','select','eTimesheet,PaperTimesheet'],
          ['agency_only_submit','Agency only submit','checkbox']
        ]},
        { name:'Notes', fields:[
          ['experience_required','Qualifications required','textarea'],
          ['duties','Duties to be performed','textarea'],
          ['health_safety_risks','Health & Safety risks','textarea'],
          ['special_conditions','Special conditions / other info','textarea'],
          ['equipment_temp','Equipment (temp)','textarea'],
          ['equipment_client','Equipment (client)','textarea'],
          ['awr_weeks','Previous qualifying weeks for AWR'],
          ['comments','Internal notes','textarea']
        ]}
      ];

      function fieldHtml([key,label,type='text',extra]){
        const id = 'f_'+key;
        if(type==='checkbox'){
          return `<div class="field"><label for="${id}">${label}</label>
                  <input id="${id}" name="${key}" type="checkbox"></div>`;
        }
        if(type==='textarea'){
          return `<div class="field" style="grid-column:1/-1"><label for="${id}">${label}</label>
                  <textarea id="${id}" name="${key}" rows="3"></textarea></div>`;
        }
        if(type==='select'){
          const opts = (extra||'').split(',').map(s=>s.trim()).filter(Boolean)
            .map(s=>`<option>${s}</option>`).join('');
          return `<div class="field"><label for="${id}">${label}</label>
                  <select id="${id}" name="${key}"><option value=""></option>${opts}</select></div>`;
        }
        return `<div class="field"><label for="${id}">${label}</label>
                <input id="${id}" name="${key}" type="${type}"></div>`;
      }

      function buildEditorShell(){
        const tabsHost = $('#tabs'); tabsHost.innerHTML = '';
        schemaTabs.forEach(t=>{
          const b=document.createElement('button');
          b.type='button'; b.className='tab'+(t.name===currentTab?' active':''); b.textContent=t.name;
          b.onclick=()=>{ currentTab=t.name; buildEditorForm(); Array.from(tabsHost.children).forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
          tabsHost.appendChild(b);
        });
        buildEditorForm();
      }
      function buildEditorForm(values={}){
        const tab = schemaTabs.find(t=>t.name===currentTab) || schemaTabs[0];
        const frm = $('#frm'); frm.innerHTML = tab.fields.map(fieldHtml).join('');
        tab.fields.forEach(([key,,type])=>{
          const el = frm.querySelector(`[name="${key}"]`);
          if(!el) return;
          if(type==='checkbox'){ el.checked = !!values[key]; }
          else if(values[key] != null) el.value = values[key];
        });
      }
      function readForm(){
        const out = {};
        schemaTabs.forEach(t=>{
          t.fields.forEach(([key,,type])=>{
            const el = document.querySelector(`#frm [name="${key}"]`);
            if(!el) return;
            if(type==='checkbox') out[key] = !!el.checked;
            else out[key] = el.value || null;
          });
        });
        return out;
      }
      function resetForm(){
        editingId = null; currentTab='Basics';
        $('#dTitle').textContent = 'New assignment';
        $('#dRef').textContent = '—';
        buildEditorShell();
      }
      function openEditor(values={}){
        buildEditorShell();
        schemaTabs.forEach(t=>{
          t.fields.forEach(([key,,type])=>{
            const el = document.querySelector(`#frm [name="${key}"]`);
            if(!el) return;
            if(type==='checkbox') el.checked = !!values[key];
            else if(values[key] != null) el.value = values[key];
          });
        });
        $('#dTitle').textContent = values?.title || 'Edit assignment';
        $('#dRef').textContent = values?.ref || values?.id || '—';
        openDrawer();
      }
      async function save(closeAfter=false){
        try{
          const body = readForm();
          if (editingId) body.id = editingId;
          const res = await api('admin-assignment-save','POST', body);
          toast('Saved ' + (res?.title || body.title || 'assignment'), 'ok', 1800);
          if (closeAfter) closeDrawer();
          await load();
          if (!editingId && res?.id) editingId = res.id;
        }catch(e){
          console.error('[assignments] save error', e);
          toast('Save failed: ' + (e.message || e), 'error', 4200);
        }
      }

      // ----- UI wires -----
      $('#btnRefresh').onclick = load;
      $('#btnDelete').onclick  = delSelected;
      $('#btnNew').onclick     = ()=>{ resetForm(); openDrawer(); };
      $('#btnExport').onclick  = ()=>exportCSV(false);
      $('#btnExportSel').onclick = ()=>exportCSV(true);
      $('#btnImport').onclick  = importCSVClick;
      $('#csv').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if (f) importCSVDo(f); });
      $('#q').addEventListener('input',  ()=>{ page=1; render(); });
      // status chips
      $('#statusChips').querySelectorAll('.chip').forEach(ch=>{
        ch.onclick = ()=>{ activeStatus = ch.getAttribute('data-status'); $('#statusChips').querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); page=1; load(); };
      });
      // pager
      $('#pgPrev').onclick = ()=>{ if (page>1) { page--; render(); } };
      $('#pgNext').onclick = ()=>{ page++; render(); };
      $('#pgSize').onchange = (e)=>{ pageSize = Number(e.target.value)||20; page=1; render(); };

      // editor buttons + shortcuts
      $('#btnSaveDraft').onclick = ()=>save(false);
      $('#btnSaveClose').onclick = ()=>save(true);
      document.addEventListener('keydown',(e)=>{
        if ((e.ctrlKey||e.metaKey) && e.key==='r'){ e.preventDefault(); load(); }
        if ((e.ctrlKey||e.metaKey) && e.key==='e'){ e.preventDefault(); exportCSV(false); }
        if ((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); save(false); }
        if (e.key === 'Escape' && drawer?.classList.contains('open')) { e.preventDefault(); closeDrawer(); }
      });

      buildColMenu();

      // ----- go -----
      await load();
      enableDelete();
    });
  })();
  </script>
</body>
</html>
