<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Assignments ‚Äî Admin | HMJ Global</title>

  <!-- Identity + Admin bootstrap -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script defer src="/admin-v2/admin/common.js?v=17"></script>

  <style>
    :root{
      --ink:#101828; --bg:#f9fafb; --muted:#667085;
      --blue:#1f3b7a; --blue-light:#274ca1;
      --border:#e5e7eb; --card:#fff;
      --success:#16a34a; --warn:#f59e0b; --danger:#dc2626;
      --radius:14px;
      --shadow:0 1px 2px rgba(0,0,0,.04),0 4px 10px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font:15px/1.5 system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:var(--bg);color:var(--ink)}

    /* HEADER */
    .top{background:var(--blue);color:#fff;position:sticky;top:0;z-index:100;border-bottom:2px solid #0b225b}
    .top .bar{display:flex;align-items:center;gap:12px;max-width:1400px;margin:0 auto;padding:12px 18px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand .logo{width:30px;height:30px;background:#fff;color:var(--blue);display:grid;place-items:center;border-radius:8px;font-weight:900}
    .btn{border:none;border-radius:10px;padding:9px 14px;font-weight:600;cursor:pointer;user-select:none}
    .btn:hover{opacity:.9}
    .btn.primary{background:var(--blue);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.15);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.light{background:#fff;color:var(--blue)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:3px 10px;font-weight:600;font-size:13px}
    .chip.ok{background:#e8fff3;color:#0a4f24}
    .chip.warn{background:#fffbe8;color:#735d02}
    .chip.bad{background:#ffebeb;color:#6a1a1a}

    /* BODY */
    .wrap{max-width:1400px;margin:18px auto;padding:0 18px;animation:fadein .4s ease}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:14px}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font:inherit}
    input[type=search]{min-width:240px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    th,td{padding:11px 13px;text-align:left;border-bottom:1px solid var(--border)}
    th{background:#f8fafc;font-weight:700;font-size:13px;color:#475569}
    tr:hover td{background:#f3f4f6}
    .empty{padding:30px;text-align:center;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px;align-items:start}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px;font-size:17px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;font-size:14px}
    .kv .k{color:var(--muted)}
    .status{display:inline-block;padding:3px 10px;border-radius:9999px;font-weight:700;font-size:12px;text-transform:capitalize}
    .status.live{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .status.draft{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
    .status.complete{background:#f1f5f9;color:#334155;border:1px solid #cbd5e1}

    /* Drawer */
    .drawer{position:fixed;inset:0 0 0 auto;max-width:760px;width:95vw;background:#fff;box-shadow:-5px 0 30px rgba(0,0,0,.2);transform:translateX(100%);transition:transform .25s ease;z-index:200;display:grid;grid-template-rows:auto 1fr auto}
    .drawer.open{transform:none}
    .drawer h2{margin:0}
    .drawer .head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#f8fafc}
    .drawer .body{padding:18px;overflow:auto}
    .drawer .foot{padding:14px 18px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#fff}
    .field{display:grid;gap:4px}
    .field label{font-weight:700;font-size:13px}
    .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}

    /* Hints */
    .hint{background:#eef2ff;border-left:4px solid var(--blue);padding:10px 14px;border-radius:8px;font-size:14px;color:#1e3a8a;margin:8px 0}
    .hint strong{display:block;font-weight:800;color:var(--blue)}

    /* Toast placeholder */
    #toast{position:fixed;bottom:18px;right:18px;z-index:500}

  </style>
</head>
<body>
  <div class="top">
    <div class="bar">
      <div class="brand"><div class="logo">H</div> HMJ Global</div>
      <span class="chip">Admin</span>
      <span class="chip">Assignments</span>
      <div style="flex:1"></div>
      <a href="./index.html" class="btn light">‚Üê Dashboard</a>
      <div id="diagChips" class="chips"></div>
      <button class="btn ghost" onclick="window.netlifyIdentity?.logout()">Sign out</button>
    </div>
  </div>

  <div class="wrap">
    <div id="gate" style="display:none" class="card">
      <h3>Admin Access Required</h3>
      <p class="muted why">Verifying session‚Ä¶</p>
      <button class="btn primary" onclick="window.netlifyIdentity?.open('login')">Sign in</button>
    </div>

    <div id="app" style="display:none">
      <div class="hint">
        <strong>Assignments overview</strong>
        This page lists all current and past assignments, showing client, candidate, and contract dates.
        Use the search bar to filter by job title, client, or candidate name.
        Status tags like <em>Live</em> or <em>Complete</em> update automatically from the Timesheets system.
      </div>

      <div class="toolbar card">
        <input type="search" id="q" placeholder="Search (title, ref, client, candidate)‚Ä¶"/>
        <select id="status">
          <option value="">All statuses</option>
          <option>Draft</option><option>Live</option><option>Complete</option>
        </select>
        <button id="btnRefresh" class="btn primary">‚Üª Refresh</button>
        <div style="flex:1"></div>
        <button id="btnNew" class="btn primary">Ôºã New</button>
        <button id="btnDelete" class="btn danger" disabled>üóë Delete</button>
      </div>

      <div class="grid">
        <div>
          <div id="listWrap" class="card"><div class="empty">Loading assignments‚Ä¶</div></div>
        </div>
        <aside>
          <div class="card">
            <h3>Quick view ‚Äî Assignment</h3>
            <div id="qvBody" class="kv"><div class="empty">Select an assignment to view details.</div></div>
          </div>
          <div class="card" style="margin-top:12px">
            <h3>Latest timesheet</h3>
            <div id="qvTS" class="kv"><div class="empty">Not live ‚Äî no timesheets yet.</div></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="head">
      <h2>New Assignment</h2>
      <button id="btnClose" class="btn ghost">‚úï Close</button>
    </div>
    <div class="body">
      <div class="hint"><strong>Tip:</strong> You can assign a candidate later. Only the job title and client are required to create a draft.</div>
      <form id="frm" autocomplete="off">
        <div class="field"><label>Job Title *</label><input name="title" required></div>
        <div class="grid2">
          <div class="field"><label>PO Number</label><input name="po_number"></div>
          <div class="field"><label>Shift</label><select name="shift"><option>Day</option><option>Night</option></select></div>
        </div>
        <div class="grid2">
          <div class="field"><label>Start Date</label><input type="date" name="start_date"></div>
          <div class="field"><label>End Date</label><input type="date" name="end_date"></div>
        </div>
        <div class="grid2">
          <div class="field"><label>Client</label><input name="client"></div>
          <div class="field"><label>Client Site</label><input name="client_site"></div>
        </div>
        <div class="grid2">
          <div class="field"><label>Candidate</label><input name="candidate" placeholder="Leave blank if not yet assigned"></div>
          <div class="field"><label>Expected Hours</label><input name="estimated_hours" placeholder="e.g. Mon‚ÄìFri, 40h"></div>
        </div>
        <div class="field" style="margin-top:8px"><label>Internal Notes</label><textarea name="notes" rows="3"></textarea></div>
      </form>
    </div>
    <div class="foot">
      <div class="muted">Entries saved here appear instantly in the Assignments list.</div>
      <div>
        <button id="btnSave" class="btn primary">üíæ Save</button>
      </div>
    </div>
  </aside>

  <div id="toast"></div>

  <script>
  (function initPage(){
    if (!window.Admin || !window.netlifyIdentity) return setTimeout(initPage,30);

    Admin.bootAdmin(async ({ api, sel, toast, identity }) => {
      const gate = sel('#gate'), app = sel('#app');
      const who = await identity('admin');
      if (!who.ok){ gate.style.display=''; app.style.display='none'; return; }
      app.style.display='';

      const diag = sel('#diagChips');
      const chip = (t,cls='ok')=>{ const s=document.createElement('span');s.className='chip '+cls;s.textContent=t;diag.appendChild(s); };
      chip('init: ok'); chip('identity: ok'); chip('role: admin'); chip('token: ok');

      let rows=[]; let selected=new Set();

      function render(list){
        const wrap=sel('#listWrap');
        if(!list.length){ wrap.innerHTML='<div class="empty">No assignments found.</div>'; return;}
        const html=['<table><thead><tr><th></th><th>Title</th><th>Client</th><th>Candidate</th><th>Dates</th><th>Status</th><th></th></tr></thead><tbody>'];
        for(const x of list){
          html.push(`<tr data-id="${x.id}">
            <td><input type="checkbox" data-id="${x.id}" ${selected.has(x.id)?'checked':''}></td>
            <td><a href="#" data-open="${x.id}">${x.title||'‚Äî'}</a></td>
            <td>${x.client_name||'‚Äî'}</td>
            <td>${x.candidate_name||'‚Äî'}</td>
            <td>${(x.start_date||'‚Äî')} ‚Üí ${(x.end_date||'‚Äî')}</td>
            <td><span class="status ${x.status?.toLowerCase()||'draft'}">${x.status||'draft'}</span></td>
            <td><button class="btn ghost" data-quick="${x.id}">Quick view</button></td>
          </tr>`);
        }
        html.push('</tbody></table>');
        wrap.innerHTML=html.join('');
        wrap.querySelectorAll('[data-open]').forEach(a=>a.onclick=e=>{e.preventDefault();openQuick(a.dataset.open);});
        wrap.querySelectorAll('input[type=checkbox]').forEach(c=>c.onchange=()=>{c.checked?selected.add(+c.dataset.id):selected.delete(+c.dataset.id);sel('#btnDelete').disabled=!selected.size;});
        wrap.querySelectorAll('[data-quick]').forEach(b=>b.onclick=e=>{e.stopPropagation();openQuick(b.dataset.quick);});
      }

      async function load(){
        try{
          const res=await api('admin-assignments-list','POST',{});
          rows=res.items||[]; render(rows);
        }catch(e){console.error(e);toast('Error loading assignments','bad',4000);}
      }

      async function openQuick(id){
        try{
          const d=await api('admin-assignments-detail','POST',{id});
          sel('#qvBody').innerHTML=`<div class="kv">
            <div class="k">Client</div><div>${d.client_name||'‚Äî'}</div>
            <div class="k">Candidate</div><div>${d.candidate_name||'‚Äî'}</div>
            <div class="k">PO</div><div>${d.po_number||'‚Äî'}</div>
            <div class="k">Dates</div><div>${d.start_date||'‚Äî'} ‚Üí ${d.end_date||'‚Äî'}</div>
          </div>`;
          toast('Loaded assignment','ok',1200);
        }catch(e){toast('Failed to open','bad',3000);}
      }

      async function saveNew(){
        const body=Object.fromEntries(new FormData(sel('#frm')).entries());
        if(!body.title){toast('Title is required','warn',1500);return;}
        try{await api('admin-assignments-create','POST',body);toast('Saved','ok',1500);closeDrawer();load();}
        catch(e){toast('Failed to save','bad',3000);}
      }

      async function del(){
        if(!selected.size)return;
        if(!confirm('Delete selected?'))return;
        try{await api('admin-assignments-delete','POST',{ids:[...selected]});toast('Deleted','ok',1500);selected.clear();load();}
        catch(e){toast('Failed','bad',3000);}
      }

      const drawer=sel('#drawer');
      const openDrawer=()=>drawer.classList.add('open');
      const closeDrawer=()=>drawer.classList.remove('open');
      sel('#btnClose').onclick=closeDrawer;
      sel('#btnNew').onclick=openDrawer;
      sel('#btnSave').onclick=saveNew;
      sel('#btnDelete').onclick=del;

      await load();
    });
  })();
  </script>
</body>
</html>
