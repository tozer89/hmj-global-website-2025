<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Clients — Admin | HMJ Global</title>






<style>
  :root{--bg:#0b0f18;--panel:#111827;--border:#252f3f;--text:#e8eef7;--muted:#9fb0c9}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border)}
  .row{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  input,textarea{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px;width:100%}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}.tab{padding:8px 10px;border:1px solid #2a395a;background:#121a2d;border-radius:9px;cursor:pointer}
  .tab.active{border-color:#385394;background:#16243d}
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Clients — Admin</div><div class="sp"></div>
  <a class="btn" href="/admin/">⟵ Admin</a>
  <button class="btn" onclick="window.netlifyIdentity?.logout()">Sign out</button>
</div></div>

<div class="wrap" id="gate" style="display:none">
  <div class="card"><strong>Admin only.</strong> <span class="muted why"></span>
  <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button></div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <input id="q" placeholder="Search client name or email…" style="min-width:260px"/>
    <button class="btn" id="btnRefresh">Refresh</button>
    <button class="btn" id="btnNew">New client</button>
  </div>

  <div id="listWrap" class="card">Loading…</div>

  <div id="profile" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px">
      <h3 style="margin:0" id="pTitle">Client</h3>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn" id="btnDelete" style="background:#3a1920;border-color:#602b36">Delete</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="details">Details</div>
      <div class="tab" data-tab="terms">Terms</div>
      <div class="tab" data-tab="assignments">Assignments</div>
    </div>

    <div id="tab-details" class="tabpane" style="margin-top:10px">
      <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <label>Name <input id="c_name"></label>
        <label>Billing email <input id="c_billing_email" type="email"></label>
        <label>Phone <input id="c_phone"></label>
        <label>Contact name <input id="c_contact_name"></label>
        <label>Contact email <input id="c_contact_email" type="email"></label>
        <label>Contact phone <input id="c_contact_phone"></label>
        <label>Terms (days) <input id="c_terms_days" type="number" min="0" step="1"></label>
        <label style="grid-column:1/-1">Address (JSON) <textarea id="c_address" rows="3" placeholder='{"line1":"…"}'></textarea></label>
      </div>
    </div>

    <div id="tab-terms" class="tabpane" style="display:none;margin-top:10px">
      <textarea id="c_terms_text" rows="10" placeholder="Client-specific terms & special instructions…"></textarea>
    </div>

    <div id="tab-assignments" class="tabpane" style="display:none;margin-top:10px">
      <div id="assnWrap" class="muted">Loading…</div>
    </div>
  </div>
</div>

<script>
const API_BASE='/admin/functions';
const sel=s=>document.querySelector(s);
const isAdmin = u => (u?.app_metadata?.roles || u?.roles || []).includes('admin');
async function api(name, method='POST', body={}){
  const u=window.netlifyIdentity.currentUser(); if(!u) throw new Error('No session');
  const t=await u.jwt();
  const r=await fetch(`${API_BASE}/${name}`,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify(body)});
  if(!r.ok) throw new Error(await r.text()); return r.json();
}
function tabs(){ document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); document.querySelectorAll('.tabpane').forEach(x=>x.style.display='none'); sel('#tab-'+t.dataset.tab).style.display='';}); }

let cur=null;

async function loadList(){
  sel('#listWrap').textContent='Loading…';
  try{
    const rows = await api('admin-clients-list','POST',{ q: sel('#q').value||'' });
    sel('#listWrap').innerHTML = `
      <table><thead><tr><th>Name</th><th>Billing email</th><th>Phone</th><th></th></tr></thead>
      <tbody>${rows.map(r=>`
        <tr>
          <td>${r.name||'—'}</td><td>${r.billing_email||'—'}</td><td>${r.phone||'—'}</td>
          <td><button class="btn" data-open="${r.id}">Open</button></td>
        </tr>`).join('')}</tbody></table>`;
    sel('#listWrap').querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>openProfile(b.dataset.open));
  }catch(e){ sel('#listWrap').textContent='Error: '+e.message; }
}

async function openProfile(id){
  cur = await api('admin-client-open','POST',{ id:Number(id) });
  sel('#pTitle').textContent = cur.name || ('Client #'+id);
  sel('#c_name').value = cur.name||''; sel('#c_billing_email').value = cur.billing_email||''; sel('#c_phone').value = cur.phone||'';
  sel('#c_contact_name').value = cur.contact_name||''; sel('#c_contact_email').value = cur.contact_email||''; sel('#c_contact_phone').value = cur.contact_phone||'';
  sel('#c_terms_days').value = cur.terms_days||''; sel('#c_address').value = cur.address ? JSON.stringify(cur.address,null,2) : '';
  sel('#c_terms_text').value = cur.terms_text||'';
  sel('#assnWrap').textContent = 'Loading…';
  const assn = await api('admin-client-assignments','POST',{ client_id: cur.id });
  sel('#assnWrap').innerHTML = assn.length? `<ul>${assn.map(a=>`<li>#${a.id} — ${a.contractor_email||'—'} @ ${a.project_name||'—'} (${a.active?'active':'closed'})</li>`).join('')}</ul>` : 'No assignments.';
  sel('#profile').style.display='block';
}

async function save(){
  const payload = {
    id: cur?.id,
    name: sel('#c_name').value.trim(),
    billing_email: sel('#c_billing_email').value.trim()||null,
    phone: sel('#c_phone').value.trim()||null,
    contact_name: sel('#c_contact_name').value.trim()||null,
    contact_email: sel('#c_contact_email').value.trim()||null,
    contact_phone: sel('#c_contact_phone').value.trim()||null,
    terms_days: sel('#c_terms_days').value? Number(sel('#c_terms_days').value) : null,
    address: sel('#c_address').value ? JSON.parse(sel('#c_address').value) : null,
    terms_text: sel('#c_terms_text').value||null
  };
  await api('admin-client-save','POST',payload);
  alert('Saved.'); loadList();
}

async function del(){ if(!cur?.id) return; if(!confirm('Delete this client?')) return; await api('admin-client-delete','POST',{ id: cur.id }); alert('Deleted.'); sel('#profile').style.display='none'; loadList(); }

function boot(id){
  tabs();
  id.on('login',()=>location.reload()); id.on('logout',()=>location.reload());
  const u=id.currentUser?.();
  if(!u){ sel('#gate').style.display='block'; sel('.why').textContent='Not signed in.'; return; }
  if(!isAdmin(u)){ sel('#gate').style.display='block'; sel('.why').textContent='Missing admin role.'; return; }
  document.getElementById('app').style.display='block';
  sel('#btnRefresh').onclick=loadList; sel('#btnNew').onclick=()=>{cur=null; sel('#profile').style.display='block'; sel('#pTitle').textContent='New client';};
  sel('#btnSave').onclick=save; sel('#btnDelete').onclick=del;
  loadList();
}
document.addEventListener('DOMContentLoaded',()=>{
  const id=window.netlifyIdentity;
  if(id && typeof id.on==='function'){ id.on('init',()=>boot(id)); boot(id); }
  else { let n=0; const t=setInterval(()=>{ const w=window.netlifyIdentity; if(w&&typeof w.on==='function'){clearInterval(t); w.on('init',()=>boot(w)); boot(w);} else if(++n>40){clearInterval(t); sel('#gate').style.display='block'; sel('.why').textContent='Identity widget did not load.';} },50);}
});
</script>

<!-- 1) Netlify Identity widget -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- 2) Force-init the widget as soon as DOM is ready -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    try { window.netlifyIdentity && window.netlifyIdentity.init(); } catch (e) {}
  });
</script>

<!-- 3) Shared admin bootstrap (cache-busted) -->
<script src="./common.js?v=7"></script>

<!-- 4) Must call bootAdmin to pass the gate and render -->
<script>
  Admin.bootAdmin(async ({ sel, identity, toast }) => {
    // simple smoke test so we know identity worked
    const who = await identity('admin');
    if (who && who.ok) {
      console.log('[admin] candidates boot ok for', who.email);
      // OPTIONAL: show a tiny toast the first time it works
      toast('Candidates loaded ✓', 'info', 2000);
    }
    // your page-specific code would go here
  });
</script>

</body>
</html>
