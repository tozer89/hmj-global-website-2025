<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reports — Admin | HMJ-Global</title>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
  :root{--bg:#0b0f18;--panel:#111827;--border:#252f3f;--text:#e8eef7;--muted:#9fb0c9}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border)}
  .row{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
  .muted{color:var(--muted)}
  select{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Reports — Admin</div><div class="sp"></div>
  <a class="btn" href="/admin/">⟵ Admin</a>
  <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
</div></div>

<div class="wrap" id="gate" style="display:none">
  <div class="card"><strong>Admin only.</strong> <span class="muted why"></span>
  <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button></div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <select id="status"><option value="">Any status</option><option>submitted</option><option>approved</option><option>rejected</option></select>
    <button class="btn" id="btnCSV">Export CSV</button>
    <span class="muted">Exports via <code>/.netlify/functions/admin-timesheets-export</code></span>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px">Audit log</h3>
    <div id="logWrap" class="muted">Loading…</div>
  </div>
</div>

<script>
const sel=s=>document.querySelector(s);
const isAdmin = u => (u?.app_metadata?.roles || u?.roles || []).includes('admin');
async function api(path, method='POST', body={}){
  const u=netlifyIdentity.currentUser(); if(!u) throw new Error('No session');
  const t=await u.jwt();
  const r=await fetch(`/.netlify/functions${path}`,{method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify(body)});
  if(!r.ok) throw new Error(await r.text()); return r.json();
}

async function loadAudit(){
  try{
    const list = await api('/admin-audit-list','POST',{ limit: 200 });
    sel('#logWrap').innerHTML = `
      <table><thead><tr><th>When</th><th>Actor</th><th>Action</th><th>Entity</th><th>Entity ID</th><th>Details</th></tr></thead>
      <tbody>
        ${list.map(x=>`<tr>
          <td>${x.created_at}</td><td>${x.actor_email||'—'}</td><td>${x.action}</td>
          <td>${x.entity}</td><td>${x.entity_id||''}</td><td><code style="font-size:.85em">${x.details?JSON.stringify(x.details):''}</code></td>
        </tr>`).join('')}
      </tbody></table>`;
  }catch(e){ sel('#logWrap').textContent='Audit unavailable: '+e.message; }
}

function boot(){
  netlifyIdentity.on('login',()=>location.reload()); netlifyIdentity.on('logout',()=>location.reload());
  const u=netlifyIdentity?.currentUser?.();
  if(!u){ sel('#gate').style.display='block'; sel('.why').textContent='Not signed in.'; return; }
  if(!isAdmin(u)){ sel('#gate').style.display='block'; sel('.why').textContent='Missing admin role.'; return; }
  document.getElementById('app').style.display='block';
  sel('#btnCSV').onclick = async ()=>{
    try{
      const u=netlifyIdentity.currentUser(); const t=await u.jwt();
      const q={ status: sel('#status').value||'' };
      const r=await fetch('/.netlify/functions/admin-timesheets-export',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify(q)});
      if(!r.ok) throw new Error(await r.text());
      const blob=await r.blob(); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='timesheets.csv'; a.click(); URL.revokeObjectURL(url);
    }catch(e){ alert('Export failed: '+e.message); }
  };
  loadAudit();
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
