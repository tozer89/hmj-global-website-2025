<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets — Admin | HMJ Global</title>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
  :root{--bg:#fff;--ink:#0b1a3a;--muted:#5a6b88;--border:#dbe3f4;--chip:#e8eefb}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border)}
  .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1200px;margin:16px auto;padding:0 16px;display:grid;gap:12px;grid-template-columns:1fr 360px}
  @media (max-width:1000px){.wrap{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px}
  .btn{background:#3A66B3;color:#fff;border:0;padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
  input,select{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Timesheets — Admin</div><div class="sp"></div>
  <a class="btn ghost" href="/admin/">⟵ Admin</a>
  <button class="btn ghost" onclick="window.netlifyIdentity?.logout()">Sign out</button>
</div></div>

<div class="wrap">
  <div id="gate" class="card" style="display:none">
    <strong>Admin only.</strong> <span class="muted why"></span>
    <div style="margin-top:8px"><button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button></div>
  </div>

  <div id="app" style="display:none">
    <div class="card" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="q" placeholder="Search contractor / client / site" style="min-width:260px"/>
      <select id="status"><option value="">Any status</option><option>draft</option><option>submitted</option><option>approved</option><option>rejected</option></select>
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn ghost" id="btnCsv">Export CSV</button>
      <button class="btn ghost" id="btnBulkApprove">Bulk approve</button>
    </div>
    <div id="listWrap" class="card">Loading…</div>
  </div>

  <div class="card">
    <div style="font-weight:800;margin-bottom:6px">Raise on behalf</div>
    <input id="createAssignmentId" placeholder="Assignment ID" inputmode="numeric" style="width:100%;margin-bottom:8px"/>
    <input id="createWeekEnding" type="date" style="width:100%;margin-bottom:8px"/>
    <button class="btn" id="btnCreate">Create draft</button>
    <div id="sideStatus" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<script>
const API_BASE = '/admin/functions';
const sel=s=>document.querySelector(s);
const isAdmin = u => (u?.app_metadata?.roles || u?.roles || []).includes('admin');

async function api(name, method='POST', body={}){
  const id=window.netlifyIdentity, u=id?.currentUser?.(); if(!u) throw new Error('No session');
  const t=await u.jwt();
  const r=await fetch(`${API_BASE}/${name}`,{
    method, headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},
    body: JSON.stringify(body)
  });
  if(!r.ok){ throw new Error(await r.text()); }
  // export endpoints may stream CSV
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.blob();
}

function identityReady(cb){
  const id=window.netlifyIdentity;
  if(id && typeof id.on==='function'){ id.on('init',()=>cb(id)); cb(id); return; }
  let i=0; const t=setInterval(()=>{ const w=window.netlifyIdentity;
    if(w && typeof w.on==='function'){ clearInterval(t); w.on('init',()=>cb(w)); cb(w); }
    else if(++i>40){ clearInterval(t); sel('#gate').style.display='block'; sel('.why').textContent='Identity widget did not load.'; }
  },50);
}

async function loadList(){
  sel('#listWrap').textContent='Loading…';
  try{
    const rows = await api('admin-timesheets-list','POST',{ q: sel('#q').value||'', status: sel('#status').value||'' });
    sel('#listWrap').innerHTML = `
      <table><thead><tr><th>ID</th><th>Contractor</th><th>Client</th><th>Week end</th><th>Status</th><th>Std</th><th>OT</th><th>£ Est</th><th></th></tr></thead>
      <tbody>
        ${rows.map(r=>`<tr>
          <td>${r.id}</td><td>${r.contractor_email||'—'}</td><td>${r.client_name||'—'}</td>
          <td>${r.week_ending||''}</td><td>${r.status}</td>
          <td>${r.hours_std||0}</td><td>${r.hours_ot||0}</td><td>${r.estimated_total||'£0.00'}</td>
          <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
        </tr>`).join('')}
      </tbody></table>`;
    sel('#listWrap').querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>openSheet(b.dataset.open));
  }catch(e){ sel('#listWrap').textContent='Error: '+e.message; }
}

async function openSheet(id){
  try{
    const x = await api('admin-timesheet-open','POST',{ id: Number(id) });
    alert(`Timesheet #${x.id}\nStatus: ${x.status}\nStd: ${x.hours_std}h, OT: ${x.hours_ot}h`);
  }catch(e){ alert('Open failed: '+e.message); }
}

async function bulkApprove(){
  const q = prompt('Approve by query (e.g. status=submitted)? Leave blank to approve all visible.');
  try{
    const n = await api('admin-timesheets-bulk-approve','POST',{ q: q||'' });
    alert('Approved: '+(n?.count ?? 0)); loadList();
  }catch(e){ alert('Bulk approve failed: '+e.message); }
}

async function createDraft(){
  const assignment_id = Number(sel('#createAssignmentId').value||0);
  const week_ending = sel('#createWeekEnding').value||null;
  if(!assignment_id || !week_ending){ sel('#sideStatus').textContent='Assignment ID and week ending required.'; return; }
  try{
    const row = await api('admin-timesheet-save','POST',{ create_from_assignment: assignment_id, week_ending });
    sel('#sideStatus').textContent='Created draft timesheet #'+row.id; loadList();
  }catch(e){ sel('#sideStatus').textContent='Error: '+e.message; }
}

function boot(id){
  id.on('login',()=>location.reload()); id.on('logout',()=>location.reload());
  const u=id.currentUser?.(); if(!u){ sel('#gate').style.display='block'; sel('.why').textContent='Not signed in.'; return; }
  if(!isAdmin(u)){ sel('#gate').style.display='block'; sel('.why').textContent='Missing admin role.'; return; }
  sel('#app').style.display='block';
  sel('#btnRefresh').onclick=loadList; sel('#btnBulkApprove').onclick=bulkApprove; sel('#btnCreate').onclick=createDraft; sel('#btnCsv').onclick=async()=>{
    try{
      const blob = await api('admin-timesheets-export','POST',{ status: sel('#status').value||'' });
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='timesheets.csv'; a.click(); URL.revokeObjectURL(url);
    }catch(e){ alert('Export failed: '+e.message); }
  };
  loadList();
}
document.addEventListener('DOMContentLoaded',()=>identityReady(boot));
</script>
</body>
</html>
