<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Timesheets — Admin | HMJ Global</title>

  <!-- Netlify Identity -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try { window.netlifyIdentity && window.netlifyIdentity.init(); } catch (e) {}
    });
  </script>

  <style>
    :root{
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#1f3b7a; --blue-2:#29478f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --danger:#dc2626; --ok:#16a34a; --warn:#f59e0b;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Header */
    .top{position:sticky;top:0;z-index:30;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;display:flex;gap:10px;align-items:center}
    .brand a{color:#fff;text-decoration:none;display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;color:var(--blue);display:grid;place-items:center;font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.danger{background:#7a1f28;border-color:#a42e3b}
    .btn.ok{background:#0f5132;border-color:#0c4128}

    /* Page */
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .muted{color:var(--muted)}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bar .sp{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--stroke);border-radius:10px;padding:10px}
    input:focus,select:focus,textarea:focus{outline:3px solid var(--ring);outline-offset:2px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--stroke);text-align:left}
    th{font-size:14px;color:#334155}
    .pill{display:inline-grid;align-items:center;padding:3px 8px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}

    /* Drawer */
    .drawer{position:fixed;inset:0;display:none;background:rgba(2,6,23,.44);z-index:40}
    .drawer .panel{position:absolute;right:0;top:0;bottom:0;width:820px;max-width:100%;background:#fff;border-left:1px solid var(--stroke);padding:16px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .twocol{grid-template-columns:1fr} }
    .section{margin:12px 0 6px;font-weight:800}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Timesheets</span>
    </div>
    <div class="sp"></div>
    <div class="chips" id="chips"></div>
    <a class="btn ghost" href="./">⟵ Admin</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <div class="card bar">
      <input id="q" placeholder="Search candidate, client, ref…" style="min-width:260px">
      <select id="status">
        <option value="">Status: any</option>
        <option value="draft">Draft</option>
        <option value="submitted">Submitted</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
        <option value="paid">Paid</option>
      </select>
      <input id="week_from" type="date" title="Week from">
      <input id="week_to" type="date" title="Week to">
      <button class="btn" id="btnRefresh">Refresh</button>
      <div class="sp"></div>
      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost" id="btnExport">Export CSV</button>
      <button class="btn ghost" id="btnImport">Import CSV</button>
      <button class="btn" id="btnNew">+ Raise on behalf</button>
      <button class="btn danger" id="btnDelete" disabled>Delete</button>
    </div>

    <div class="card" id="listWrap">Loading…</div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="section" style="margin:0">Recent activity</div>
        <button class="btn ghost" id="btnAudit">Refresh</button>
      </div>
      <div id="audit" class="muted">—</div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawer" id="drawer" aria-modal="true" role="dialog">
    <div class="panel">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <h2 id="edTitle" style="margin:0">Timesheet</h2>
        <div class="right" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn ok" id="btnApprove">Approve</button>
          <button class="btn danger" id="btnReject">Reject</button>
          <button class="btn ghost" id="btnSave">Save</button>
          <button class="btn ghost" id="btnClose">Close</button>
        </div>
      </div>

      <div class="section">Header</div>
      <div class="grid">
        <label>TS Ref <input id="ts_ref" placeholder="Auto/Manual"></label>
        <label>Status
          <select id="ts_status">
            <option>draft</option><option>submitted</option><option>approved</option><option>rejected</option><option>paid</option>
          </select>
        </label>
        <label>Week Starting <input id="week_start" type="date"></label>
        <label>Assignment Ref <input id="assignment_ref" placeholder="Assignment ID / Ref"></label>
        <label>Candidate <input id="candidate_name"></label>
        <label>Client <input id="client_name"></label>
      </div>

      <div class="section">Hours</div>
      <div class="grid">
        <label>Mon <input id="mon" type="number" min="0" step="0.25"></label>
        <label>Tue <input id="tue" type="number" min="0" step="0.25"></label>
        <label>Wed <input id="wed" type="number" min="0" step="0.25"></label>
        <label>Thu <input id="thu" type="number" min="0" step="0.25"></label>
        <label>Fri <input id="fri" type="number" min="0" step="0.25"></label>
        <label>Sat <input id="sat" type="number" min="0" step="0.25"></label>
        <label>Sun <input id="sun" type="number" min="0" step="0.25"></label>
        <label>Total (auto) <input id="total" disabled></label>
      </div>

      <div class="section">Attachments</div>
      <div class="twocol">
        <div class="card" style="background:#fff">
          <div style="font-weight:700;margin-bottom:6px">Supporting evidence</div>
          <div id="proof_info" class="muted">No file.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="file" id="proof_file" accept="application/pdf,image/*">
            <button class="btn ghost" id="btnUploadProof">Upload</button>
          </div>
        </div>
        <div class="card" style="background:#fff">
          <div style="font-weight:700;margin-bottom:6px">Approver</div>
          <label>Approver Name <input id="approver_name"></label>
          <label>Approver Email <input id="approver_email" type="email"></label>
        </div>
      </div>

      <div class="section">Notes</div>
      <textarea id="notes" rows="4" placeholder="Internal notes…"></textarea>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Shared admin (absolute path; bump v if cached) -->
  <script defer src="/admin/common.js?v=10"></script>

  <script>
  Admin.bootAdmin(async ({ api, sel, toast }) => {
    // tiny debug chips
    const chip=(t,tone='info')=>{const s=document.createElement('span');s.className='pill';s.textContent=t;
      if(tone==='ok')s.classList.add('b-ok');if(tone==='warn')s.classList.add('b-warn');if(tone==='bad')s.classList.add('b-bad');
      sel('#chips').appendChild(s);return s;};
    chip('ready','ok');

    let page=1,pageSize=20,total=0,rows=[],selected=new Set(),current=null;
    const enableDelete=()=> sel('#btnDelete').disabled=selected.size===0;
    const openDrawer=()=> sel('#drawer').style.display='block';
    const closeDrawer=()=>{ sel('#drawer').style.display='none'; current=null; };

    function sumHours(){ const ids=['mon','tue','wed','thu','fri','sat','sun']; let t=0;
      ids.forEach(id=> t+= parseFloat(sel('#'+id).value||0)); sel('#total').value=t? t.toFixed(2):''; return t; }

    function renderList(){
      if(!rows.length){ sel('#listWrap').textContent='No timesheets found.'; return; }
      const head=`<thead><tr>
        <th style="width:28px"><input id="ckAll" type="checkbox"></th>
        <th>Ref</th><th>Week</th><th>Candidate</th><th>Client</th>
        <th>Assignment</th><th>Hours</th><th>Status</th><th></th>
      </tr></thead>`;
      const body=rows.map(r=>{
        const pill=r.status==='approved'?'b-ok':(r.status==='rejected'?'b-bad':'b-warn');
        const wk=(r.week_start||'').slice(0,10);
        const hrs=typeof r.total_hours==='number'? r.total_hours.toFixed(2):'—';
        return `<tr>
          <td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>
          <td>${r.ts_ref||r.id}</td>
          <td>${wk}</td>
          <td>${r.candidate_name||'—'}</td>
          <td>${r.client_name||'—'}</td>
          <td>${r.assignment_ref||'—'}</td>
          <td>${hrs}</td>
          <td><span class="pill ${pill}">${r.status||'submitted'}</span></td>
          <td><button class="btn ghost" data-open="${r.id}">Open</button></td>
        </tr>`;
      }).join('');
      const pager=`<div style="display:flex;justify-content:space-between;align-items:center;padding-top:8px">
        <div class="muted">Showing ${(page-1)*pageSize+1}-${Math.min(page*pageSize,total)} of ${total}</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="pPrev" ${page<=1?'disabled':''}>Prev</button>
          <button class="btn ghost" id="pNext" ${(page*pageSize)>=total?'disabled':''}>Next</button>
        </div></div>`;
      sel('#listWrap').innerHTML=`<table>${head}<tbody>${body}</tbody></table>${pager}`;

      sel('#ckAll').onclick=e=>{ if(e.target.checked){rows.forEach(r=>selected.add(r.id));}else{rows.forEach(r=>selected.delete(r.id));} enableDelete(); renderList(); };
      sel('#listWrap').querySelectorAll('input[type=checkbox][data-id]').forEach(c=> c.onchange=()=>{const id=Number(c.getAttribute('data-id')); if(c.checked)selected.add(id); else selected.delete(id); enableDelete();});
      sel('#listWrap').querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openTs(Number(b.getAttribute('data-open'))));
      sel('#pPrev').onclick=()=>{page--; load();};
      sel('#pNext').onclick=()=>{page++; load();};
    }

    async function load(){
      sel('#listWrap').textContent='Loading…';
      try{
        const res=await api('admin-timesheets-list','POST',{
          q:sel('#q').value||'', status:sel('#status').value||'',
          week_from:sel('#week_from').value||'', week_to:sel('#week_to').value||'',
          page, pageSize
        });
        rows=res.rows||res||[]; total=res.total??rows.length; renderList();
      }catch(e){ sel('#listWrap').textContent='Error: '+e.message; }
    }

    async function loadAudit(){
      try{
        const list=await api('admin-audit-list','POST',{entity:'timesheet',limit:10});
        sel('#audit').innerHTML = list.length ? `<ul style="margin:6px 0;padding-left:18px">
          ${list.map(a=>`<li><span class="muted">${a.created_at?.replace('T',' ').slice(0,16)||''}</span> — ${a.action} #${a.entity_id||''} by ${a.actor_email||'—'}</li>`).join('')}
        </ul>` : '—';
      }catch(e){ sel('#audit').textContent='Audit unavailable: '+e.message; }
    }

    async function openTs(id){
      try{
        const r=await api('admin-timesheet-open','POST',{id});
        current=r;
        sel('#edTitle').textContent=`Timesheet #${r.id}`;
        const set=(k,v)=>{const el=sel('#'+k); if(el) el.value=(v??'');};
        set('ts_ref',r.ts_ref); set('ts_status',r.status||'submitted');
        set('week_start',(r.week_start||'').slice(0,10));
        set('assignment_ref',r.assignment_ref||''); set('candidate_name',r.candidate_name||''); set('client_name',r.client_name||'');
        ['mon','tue','wed','thu','fri','sat','sun'].forEach(d=> set(d, r[d] ?? ''));
        sumHours();
        set('approver_name',r.approver_name||''); set('approver_email',r.approver_email||''); set('notes',r.notes||'');
        sel('#proof_info').innerHTML=r.proof_url?`<a href="${r.proof_url}" target="_blank">View proof</a>`:'No file.';
        openDrawer();
      }catch(e){ toast('Open failed: '+e.message,'err',5000); }
    }

    function newTs(){
      current={id:null,status:'draft'};
      ['ts_ref','assignment_ref','candidate_name','client_name','mon','tue','wed','thu','fri','sat','sun','approver_name','approver_email','notes']
        .forEach(k=>{const el=sel('#'+k); if(el) el.value='';});
      sel('#ts_status').value='draft'; sel('#week_start').value=''; sel('#total').value=''; sel('#proof_info').textContent='No file.'; openDrawer();
    }

    async function save(){
      const get=id=> sel('#'+id)?.value || null;
      const payload={
        id:current?.id||null,
        ts_ref:get('ts_ref'), status:get('ts_status'),
        week_start:get('week_start')||null,
        assignment_ref:get('assignment_ref'),
        candidate_name:get('candidate_name'),
        client_name:get('client_name'),
        mon:parseFloat(get('mon'))||0, tue:parseFloat(get('tue'))||0, wed:parseFloat(get('wed'))||0,
        thu:parseFloat(get('thu'))||0, fri:parseFloat(get('fri'))||0, sat:parseFloat(get('sat'))||0, sun:parseFloat(get('sun'))||0,
        total_hours:sumHours(),
        approver_name:get('approver_name'), approver_email:get('approver_email'),
        notes:get('notes')
      };
      try{ await api('admin-timesheet-save','POST',payload); toast('Saved','ok',2000); closeDrawer(); load(); }
      catch(e){ toast('Save failed: '+e.message,'err',5000); }
    }

    async function approve(reject=false){
      if(!current?.id){ toast('Open a timesheet first','warn',2500); return; }
      try{ await api('admin-timesheet-approve','POST',{id:current.id, approve:!reject});
        toast(reject?'Rejected':'Approved','ok',2000); closeDrawer(); load();
      }catch(e){ toast('Action failed: '+e.message,'err',5000); }
    }

    async function delSelected(){
      if(!selected.size) return;
      if(!confirm(`Delete ${selected.size} timesheet(s)?`)) return;
      try{ await api('admin-timesheet-delete','POST',{ids:Array.from(selected)});
        selected.clear(); enableDelete(); toast('Deleted','ok',2000); load();
      }catch(e){ toast('Delete failed: '+e.message,'err',5000); }
    }

    async function uploadProof(){
      const f=sel('#proof_file').files[0]; if(!f){ toast('Choose a file first','warn',2500); return; }
      try{
        const sign=await api('admin-uploads-presign','POST',{entity:'timesheet',entity_id:current?.id,kind:'proof',filename:f.name,type:f.type});
        await fetch(sign.url,{method:'PUT',headers:sign.headers||{},body:f});
        await api('admin-timesheet-attach-proof','POST',{id:current?.id,url:sign.public_url});
        sel('#proof_info').innerHTML=`<a href="${sign.public_url}" target="_blank">View proof</a>`;
        toast('Uploaded','ok',1800);
      }catch(e){ toast('Upload failed: '+e.message,'err',5000); }
    }

    async function exportCSV(){
      try{
        const blob=await api('admin-timesheets-export','POST',{
          q:sel('#q').value||'', status:sel('#status').value||'',
          week_from:sel('#week_from').value||'', week_to:sel('#week_to').value||''
        });
        const url=URL.createObjectURL(new Blob([blob],{type:'text/csv'}));
        const a=document.createElement('a'); a.href=url; a.download='timesheets.csv'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ toast('Export failed: '+e.message,'err',5000); }
    }
    function importCSV(){ sel('#csv').click(); }
    sel('#csv').addEventListener('change', async ()=>{
      const f=sel('#csv').files[0]; if(!f) return;
      const text=await f.text();
      try{
        const res=await api('admin-timesheets-import','POST',{csv:text});
        toast(`Imported ${res?.inserted ?? 0}`,'ok',2500); load();
      }catch(e){ toast('Import failed: '+e.message,'err',5000); }
    });

    // Wire up UI
    sel('#btnRefresh').onclick=load;
    sel('#btnNew').onclick=newTs;
    sel('#btnSave').onclick=save;
    sel('#btnApprove').onclick=()=>approve(false);
    sel('#btnReject').onclick=()=>approve(true);
    sel('#btnDelete').onclick=delSelected;
    sel('#btnClose').onclick=()=>{ closeDrawer(); };
    sel('#btnUploadProof').onclick=uploadProof;
    sel('#btnAudit').onclick=loadAudit;
    sel('#btnExport').onclick=exportCSV;
    sel('#btnImport').onclick=importCSV;

    ['#mon','#tue','#wed','#thu','#fri','#sat','#sun'].forEach(id=> sel(id).addEventListener('input', sumHours));
    ['#q','#status','#week_from','#week_to'].forEach(s=> sel(s).addEventListener('change', ()=>{ page=1; load(); }));

    // Handy shortcuts
    document.addEventListener('keydown', (e) => {
      if(e.key==='n' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); newTs(); }
      if(e.key==='s' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); if(sel('#drawer').style.display==='block') save(); }
      if(e.key==='e' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); exportCSV(); }
      if(e.key==='Escape' && sel('#drawer').style.display==='block'){ e.preventDefault(); closeDrawer(); }
    });

    await load();
    await loadAudit();
  });
  </script>
</body>
</html>
