<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Job Spec | HMJ Global</title>
  <link rel="stylesheet" href="../css/style.css"/>
  <style>
    :root {
      color-scheme: light;
      --hmj-blue: #2f4ea2;
      --hmj-blue-light: #e8eeff;
      --hmj-blue-dark: #243b7c;
      --hmj-text: #111827;
      --hmj-muted: #5b6474;
      --hmj-border: #c5d3f7;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f8faff 0%, #eef3ff 100%);
      color: var(--hmj-text);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 32px;
    }

    .card {
      max-width: 820px;
      width: 100%;
      background: #ffffff;
      border: 1px solid var(--hmj-border);
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(47, 78, 162, 0.12);
      padding: 32px;
      display: grid;
      gap: 20px;
    }

    h1 {
      margin: 0;
      font-size: clamp(26px, 4vw, 36px);
      color: var(--hmj-blue-dark);
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--hmj-text);
      font-weight: 600;
    }

    .meta span {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--hmj-blue-light);
      border: 1px solid var(--hmj-border);
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      background: var(--hmj-blue);
      color: #ffffff;
    }

    .badge.live {
      background: var(--hmj-blue);
    }

    .badge.interviewing {
      background: #f2b705;
      color: #111827;
    }

    .badge.closed {
      background: #e11d48;
      color: #ffffff;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tags span {
      padding: 6px 12px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--hmj-border);
      font-weight: 600;
      color: var(--hmj-text);
      box-shadow: inset 0 0 0 1px rgba(47, 78, 162, 0.05);
    }

    h2 {
      margin: 12px 0 6px;
      font-size: 18px;
      color: var(--hmj-blue-dark);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    ul {
      margin: 0 0 12px 20px;
      color: var(--hmj-text);
    }

    p {
      margin: 0;
      color: var(--hmj-text);
      line-height: 1.6;
    }

    .cta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .btn {
      border: none;
      font-weight: 700;
      padding: 12px 20px;
      border-radius: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
    }

    .btn.primary,
    .btn:not(.secondary) {
      background: var(--hmj-blue);
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(47, 78, 162, 0.2);
    }

    .btn.primary:hover,
    .btn:not(.secondary):hover {
      background: var(--hmj-blue-dark);
    }

    .btn.secondary {
      background: #ffffff;
      border: 2px solid var(--hmj-blue);
      color: var(--hmj-blue);
    }

    .btn.secondary:hover {
      background: var(--hmj-blue);
      color: #ffffff;
    }

    .muted {
      color: var(--hmj-muted);
    }

    #error {
      color: #b91c1c;
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 18px;
      border-radius: 16px;
      max-width: 520px;
      text-align: center;
      font-weight: 600;
      box-shadow: 0 15px 30px rgba(185, 28, 28, 0.15);
    }

    #loading {
      color: var(--hmj-blue-dark);
      font-weight: 700;
      background: rgba(255, 255, 255, 0.8);
      padding: 12px 18px;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(47, 78, 162, 0.16);
    }

    @media (max-width: 640px) {
      body {
        padding: 20px;
      }

      .card {
        border-radius: 20px;
        padding: 24px;
      }

      .meta span {
        width: 100%;
        justify-content: center;
      }

      .cta {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div id="loading">Loading role…</div>
  <div id="error" style="display:none"></div>
  <article id="spec" class="card" style="display:none">
    <header>
      <span id="status" class="badge"></span>
      <h1 id="title"></h1>
      <div class="meta">
        <span id="location"></span>
        <span id="employment"></span>
      </div>
      <div class="tags" id="tags"></div>
    </header>
    <section>
      <p id="overview"></p>
    </section>
    <section id="responsibilities" style="display:none">
      <h2>Key Responsibilities</h2>
      <ul id="respList"></ul>
    </section>
    <section id="requirements" style="display:none">
      <h2>Requirements</h2>
      <ul id="reqList"></ul>
    </section>
    <footer class="cta">
      <a id="applyBtn" class="btn" href="#" target="_blank" rel="noopener">Apply now</a>
      <button id="copyBtn" class="btn secondary" type="button">Copy link</button>
    </footer>
    <p class="muted" id="meta"></p>
  </article>

  <script>
    (async function(){
      const LOCAL_SHARE_KEY = 'hmj.jobs.share-cache';
      const params = new URLSearchParams(location.search);
      const localSlug = params.get('local') || params.get('localSlug');
      const slug = params.get('slug');
      const jobId = params.get('id') || params.get('job');
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('error');
      const card = document.getElementById('spec');

      function writeLocalShareStore(store){
        if (!window.localStorage) return;
        try {
          localStorage.setItem(LOCAL_SHARE_KEY, JSON.stringify(store));
        } catch (err) {
          console.warn('[spec] failed to persist local share store', err);
        }
      }

      function readLocalShareStore(){
        if (!window.localStorage) return null;
        try {
          const raw = localStorage.getItem(LOCAL_SHARE_KEY);
          const parsed = raw ? JSON.parse(raw) : null;
          return {
            version: parsed?.version || 1,
            bySlug: parsed && typeof parsed.bySlug === 'object' ? { ...parsed.bySlug } : {},
            byJob: parsed && typeof parsed.byJob === 'object' ? { ...parsed.byJob } : {},
          };
        } catch (err) {
          console.warn('[spec] failed to read local share store', err);
          return { version: 1, bySlug: {}, byJob: {} };
        }
      }

      function pruneLocalShareStore(store){
        if (!store) return null;
        const now = Date.now();
        let dirty = false;
        const bySlug = { ...store.bySlug };
        const byJob = { ...store.byJob };
        Object.entries(bySlug).forEach(([slugKey, entry]) => {
          if (!entry || !entry.expiresAt || entry.expiresAt < now) {
            dirty = true;
            delete bySlug[slugKey];
            const jobKey = entry && entry.jobKey;
            if (jobKey && byJob[jobKey] === slugKey) delete byJob[jobKey];
          }
        });
        Object.entries(byJob).forEach(([jobKey, slugKey]) => {
          if (!slugKey || !bySlug[slugKey]) {
            dirty = true;
            delete byJob[jobKey];
          }
        });
        const next = { version: store.version || 1, bySlug, byJob };
        if (dirty) writeLocalShareStore(next);
        return next;
      }

      function getLocalShare(slugKey){
        if (!slugKey) return null;
        const store = pruneLocalShareStore(readLocalShareStore());
        if (!store) return null;
        const entry = store.bySlug?.[slugKey];
        if (!entry) return null;
        if (entry.expiresAt && entry.expiresAt < Date.now()) {
          delete store.bySlug[slugKey];
          if (entry.jobKey && store.byJob?.[entry.jobKey] === slugKey) {
            delete store.byJob[entry.jobKey];
          }
          writeLocalShareStore(store);
          return null;
        }
        entry.lastAccessed = Date.now();
        store.bySlug[slugKey] = entry;
        writeLocalShareStore(store);
        return entry;
      }

      if (localSlug) {
        const localEntry = getLocalShare(localSlug);
        if (localEntry && localEntry.job) {
          renderSpec(localEntry.job, {
            slug: localEntry.slug,
            local: true,
            created_at: localEntry.createdAt || null,
            expires_at: localEntry.expiresAt || null,
            refreshed_at: localEntry.updatedAt || null,
            last_accessed: localEntry.lastAccessed || null,
          });
          loading.style.display = 'none';
          card.style.display = 'grid';
          return;
        }
        loading.style.display = 'none';
        errorBox.textContent = 'This preview link has expired or is unavailable on this device. Please generate a fresh link from the HMJ Global admin dashboard.';
        errorBox.style.display = 'block';
        return;
      }

      if (!slug && !jobId) {
        loading.style.display = 'none';
        errorBox.textContent = 'Missing share link. Please contact HMJ Global for a fresh link.';
        errorBox.style.display = 'block';
        return;
      }

      try {
        const qs = new URLSearchParams();
        if (slug) qs.set('slug', slug);
        if (jobId) qs.set('id', jobId);
        const res = await fetch(`/.netlify/functions/job-spec-get?${qs.toString()}`, { cache: 'no-store' });
        if (!res.ok) {
          const msg = await res.json().catch(()=>({}));
          throw new Error(msg.error || `Unable to load spec (${res.status})`);
        }
        const data = await res.json();
        if (!data?.job) throw new Error('Job not found');
        renderSpec(data.job, data);
        loading.style.display = 'none';
        card.style.display = 'grid';
      } catch (err) {
        loading.style.display = 'none';
        errorBox.textContent = err.message || 'Unable to load job spec.';
        errorBox.style.display = 'block';
      }

      function renderSpec(job, meta){
        const statusEl = document.getElementById('status');
        statusEl.textContent = job.status ? job.status.toUpperCase() : 'OPEN';
        statusEl.className = `badge ${job.status === 'closed' ? 'closed' : job.status === 'interviewing' ? 'interviewing' : 'live'}`;
        document.getElementById('title').textContent = job.title || 'Role';
        if (job.title) {
          document.title = `${job.title} | HMJ Global`;
        }
        document.getElementById('location').textContent = job.locationText || 'Flexible';
        document.getElementById('employment').textContent = job.type ? job.type.toUpperCase() : '';
        const tags = Array.isArray(job.tags) ? job.tags : [];
        const tagHost = document.getElementById('tags');
        tagHost.innerHTML = tags.map(tag => `<span>${tag}</span>`).join('');
        if (!tagHost.innerHTML) tagHost.style.display = 'none';
        document.getElementById('overview').textContent = job.overview || '';
        const respSection = document.getElementById('responsibilities');
        const respList = document.getElementById('respList');
        respList.innerHTML = (job.responsibilities || []).map(item => `<li>${item}</li>`).join('');
        respSection.style.display = respList.innerHTML ? '' : 'none';
        const reqSection = document.getElementById('requirements');
        const reqList = document.getElementById('reqList');
        reqList.innerHTML = (job.requirements || []).map(item => `<li>${item}</li>`).join('');
        reqSection.style.display = reqList.innerHTML ? '' : 'none';
        const apply = job.applyUrl && job.applyUrl.trim() ? job.applyUrl.trim() : `https://www.hmj-global.com/contact.html?role=${encodeURIComponent(job.title||'Role')}`;
        const applyBtn = document.getElementById('applyBtn');
        applyBtn.href = apply;
        const metaParts = [];
        if (meta.local) metaParts.push('Local preview');
        if (meta.slug && !meta.local) metaParts.push(`Share code ${meta.slug}`);
        if (meta.created_at) metaParts.push(new Date(meta.created_at).toLocaleString());
        if (meta.refreshed_at) metaParts.push(`Updated ${new Date(meta.refreshed_at).toLocaleString()}`);
        if (meta.last_accessed && meta.local) metaParts.push(`Opened ${new Date(meta.last_accessed).toLocaleString()}`);
        if (meta.expires_at) metaParts.push(`Expires ${new Date(meta.expires_at).toLocaleDateString()}`);
        if (meta.fallback) metaParts.push('Static preview');
        document.getElementById('meta').textContent = metaParts.join(' • ');
        document.getElementById('copyBtn').addEventListener('click', () => {
          const shareLink = location.href;
          const full = `${job.title}\n${job.locationText || ''}\n${apply}\n${shareLink}`;
          navigator.clipboard?.writeText(full).then(()=>{
            document.getElementById('copyBtn').textContent = 'Link copied';
            setTimeout(()=>document.getElementById('copyBtn').textContent='Copy link',1800);
          });
        });
      }
    })();
  </script>
</body>
</html>
