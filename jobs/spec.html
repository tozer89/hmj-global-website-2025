<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Job Spec | HMJ Global</title>
  <link rel="stylesheet" href="../css/style.css"/>
  <style>
    :root {
      color-scheme: light;

      /* Brand palette */
      --hmj-blue: #2f4ea2;
      --hmj-blue-dark: #1f3b82;
      --hmj-blue-light: #e8eeff;
      --hmj-text: #0f1b3f;
      --hmj-muted: #5b6474;
      --hmj-border: rgba(47, 78, 162, 0.18);
      --hmj-focus: rgba(63, 102, 199, 0.35);

      /* Surfaces + accents */
      --bg: linear-gradient(135deg, #f6f8ff 0%, #eef3ff 45%, #f8faff 100%);
      --surface: #ffffff;
      --surface-soft: rgba(255, 255, 255, 0.88);
      --shadow: 0 28px 64px rgba(47, 78, 162, 0.15);
      --ink: var(--hmj-text);
      --ink-strong: var(--hmj-blue-dark);
      --ink-soft: #5d6f9e;
      --accent: var(--hmj-blue);
      --accent-strong: var(--hmj-blue-dark);
      --accent-soft: rgba(63, 102, 199, 0.12);

      /* Status tokens */
      --badge-live-bg: rgba(19, 135, 84, 0.12);
      --badge-live-border: rgba(19, 135, 84, 0.32);
      --badge-live-text: #0f5132;
      --badge-int-bg: rgba(250, 204, 21, 0.16);
      --badge-int-border: rgba(250, 204, 21, 0.36);
      --badge-int-text: #854d0e;
      --badge-closed-bg: rgba(180, 35, 24, 0.14);
      --badge-closed-border: rgba(180, 35, 24, 0.34);
      --badge-closed-text: #842029;
      --danger-bg: rgba(180, 35, 24, 0.12);
      --danger-border: rgba(180, 35, 24, 0.32);
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--ink);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: clamp(24px, 5vw, 56px);
    }

    .card {
      width: min(860px, 100%);
      background: var(--surface);
      border: 1px solid var(--hmj-border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: clamp(26px, 3vw, 36px);
      display: grid;
      gap: 22px;
    }

    header {
      display: grid;
      gap: 16px;
    }

    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 40px);
      color: var(--ink-strong);
      letter-spacing: -0.01em;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--ink-strong);
      font-weight: 700;
    }

    .meta span {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(63, 102, 199, 0.26);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 12px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--accent-strong);
      background: var(--accent-soft);
      border: 1px solid rgba(63, 102, 199, 0.32);
      justify-self: start;
    }

    .badge.live {
      background: var(--badge-live-bg);
      border-color: var(--badge-live-border);
      color: var(--badge-live-text);
    }

    .badge.interviewing {
      background: var(--badge-int-bg);
      border-color: var(--badge-int-border);
      color: var(--badge-int-text);
    }

    .badge.closed {
      background: var(--badge-closed-bg);
      border-color: var(--badge-closed-border);
      color: var(--badge-closed-text);
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tags span {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(63, 102, 199, 0.26);
      font-weight: 700;
      color: var(--accent-strong);
      box-shadow: inset 0 0 0 1px rgba(63, 102, 199, 0.1);
    }

    h2 {
      margin: 12px 0 6px;
      font-size: 16px;
      color: var(--ink-soft);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    ul {
      margin: 0 0 12px 22px;
      color: var(--ink);
      line-height: 1.6;
      font-weight: 500;
    }

    p {
      margin: 0;
      color: var(--ink);
      line-height: 1.65;
      font-size: 16px;
      font-weight: 500;
    }

    .cta {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 12px;
    }

    .btn {
      font-weight: 800;
      font-size: 15px;
      padding: 13px 22px;
      border-radius: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      border: 1px solid transparent;
      background: transparent;
    }

    .btn.primary,
    .btn:not(.secondary) {
      background: linear-gradient(180deg, rgba(63, 102, 199, 0.2), rgba(63, 102, 199, 0.08));
      border-color: rgba(63, 102, 199, 0.42);
      color: #fff;
      box-shadow: 0 12px 28px rgba(47, 78, 162, 0.18);
    }

    .btn.primary:hover,
    .btn:not(.secondary):hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(47, 78, 162, 0.22);
    }

    .btn:focus-visible {
      outline: 3px solid var(--hmj-focus);
      outline-offset: 2px;
    }

    .btn.secondary {
      background: #fff;
      color: var(--accent-strong);
      border-color: rgba(63, 102, 199, 0.26);
      box-shadow: inset 0 0 0 1px rgba(63, 102, 199, 0.06);
    }

    .btn.secondary:hover {
      background: rgba(63, 102, 199, 0.08);
      color: var(--accent-strong);
    }

    .btn.secondary:focus-visible {
      outline-color: rgba(63, 102, 199, 0.45);
    }

    .muted {
      color: var(--hmj-muted);
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    #error {
      color: var(--badge-closed-text);
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      padding: 22px;
      border-radius: 20px;
      max-width: 520px;
      text-align: center;
      font-weight: 700;
      box-shadow: 0 16px 40px rgba(180, 35, 24, 0.18);
    }

    #loading {
      color: var(--accent-strong);
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--surface-soft);
      padding: 12px 18px;
      border-radius: 14px;
      box-shadow: 0 18px 38px rgba(47, 78, 162, 0.18);
    }

    @media (max-width: 720px) {
      body {
        padding: 24px;
      }

      .card {
        padding: 24px;
        border-radius: 24px;
        gap: 18px;
      }

      h1 {
        font-size: clamp(26px, 6vw, 34px);
      }

      .meta span {
        width: 100%;
        justify-content: center;
      }

      .cta {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .btn,
      body {
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <div id="loading">Loading roleâ€¦</div>
  <div id="error" style="display:none"></div>
  <article id="spec" class="card" style="display:none">
    <header>
      <span id="status" class="badge"></span>
      <h1 id="title"></h1>
      <div class="meta">
        <span id="location"></span>
        <span id="employment"></span>
      </div>
      <div class="tags" id="tags"></div>
    </header>
    <section>
      <p id="overview"></p>
    </section>
    <section id="responsibilities" style="display:none">
      <h2>Key Responsibilities</h2>
      <ul id="respList"></ul>
    </section>
    <section id="requirements" style="display:none">
      <h2>Requirements</h2>
      <ul id="reqList"></ul>
    </section>
    <footer class="cta">
      <a id="applyBtn" class="btn" href="#" target="_blank" rel="noopener">Apply now</a>
      <button id="copyBtn" class="btn secondary" type="button">Copy link</button>
    </footer>
    <p class="muted" id="meta"></p>
  </article>

  <script>
    (async function(){
      const LOCAL_SHARE_KEY = 'hmj.jobs.share-cache';
      const params = new URLSearchParams(location.search);
      const localSlug = params.get('local') || params.get('localSlug');
      const payloadParam = params.get('payload');
      const slug = params.get('slug');
      const jobId = params.get('id') || params.get('job');
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('error');
      const card = document.getElementById('spec');
      const copyBtn = document.getElementById('copyBtn');
      const defaultCopyLabel = copyBtn?.textContent || 'Copy link';
      let shareContext = null;

      function decodeSharePayload(value){
        if (!value) return null;
        try {
          const binary = atob(value);
          let json;
          if (typeof TextDecoder !== 'undefined') {
            const bytes = Uint8Array.from(binary, (char) => char.charCodeAt(0));
            json = new TextDecoder().decode(bytes);
          } else {
            json = decodeURIComponent(Array.from(binary).map((ch) => `%${ch.charCodeAt(0).toString(16).padStart(2,'0')}`).join(''));
          }
          return JSON.parse(json);
        } catch (err) {
          console.warn('[spec] failed to decode payload', err);
          return null;
        }
      }

      function writeLocalShareStore(store){
        if (!window.localStorage) return;
        try {
          localStorage.setItem(LOCAL_SHARE_KEY, JSON.stringify(store));
        } catch (err) {
          console.warn('[spec] failed to persist local share store', err);
        }
      }

      function readLocalShareStore(){
        if (!window.localStorage) return null;
        try {
          const raw = localStorage.getItem(LOCAL_SHARE_KEY);
          const parsed = raw ? JSON.parse(raw) : null;
          return {
            version: parsed?.version || 1,
            bySlug: parsed && typeof parsed.bySlug === 'object' ? { ...parsed.bySlug } : {},
            byJob: parsed && typeof parsed.byJob === 'object' ? { ...parsed.byJob } : {},
          };
        } catch (err) {
          console.warn('[spec] failed to read local share store', err);
          return { version: 1, bySlug: {}, byJob: {} };
        }
      }

      function pruneLocalShareStore(store){
        if (!store) return null;
        const now = Date.now();
        let dirty = false;
        const bySlug = { ...store.bySlug };
        const byJob = { ...store.byJob };
        Object.entries(bySlug).forEach(([slugKey, entry]) => {
          if (!entry || !entry.expiresAt || entry.expiresAt < now) {
            dirty = true;
            delete bySlug[slugKey];
            const jobKey = entry && entry.jobKey;
            if (jobKey && byJob[jobKey] === slugKey) delete byJob[jobKey];
          }
        });
        Object.entries(byJob).forEach(([jobKey, slugKey]) => {
          if (!slugKey || !bySlug[slugKey]) {
            dirty = true;
            delete byJob[jobKey];
          }
        });
        const next = { version: store.version || 1, bySlug, byJob };
        if (dirty) writeLocalShareStore(next);
        return next;
      }

      function getLocalShare(slugKey){
        if (!slugKey) return null;
        const store = pruneLocalShareStore(readLocalShareStore());
        if (!store) return null;
        const entry = store.bySlug?.[slugKey];
        if (!entry) return null;
        if (entry.expiresAt && entry.expiresAt < Date.now()) {
          delete store.bySlug[slugKey];
          if (entry.jobKey && store.byJob?.[entry.jobKey] === slugKey) {
            delete store.byJob[entry.jobKey];
          }
          writeLocalShareStore(store);
          return null;
        }
        entry.lastAccessed = Date.now();
        store.bySlug[slugKey] = entry;
        writeLocalShareStore(store);
        return entry;
      }

      copyBtn?.addEventListener('click', () => {
        if (!shareContext) return;
        const { jobTitle, locationText, applyUrl, shareLink } = shareContext;
        const lines = [jobTitle, locationText, applyUrl, shareLink].filter(Boolean);
        if (!lines.length) return;
        const text = lines.join('\n');
        const notify = (label) => {
          copyBtn.textContent = label;
          setTimeout(() => {
            copyBtn.textContent = defaultCopyLabel;
          }, 1800);
        };
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(text).then(
            () => notify('Link copied'),
            () => fallbackCopy(text, notify)
          );
        } else {
          fallbackCopy(text, notify);
        }
      });

      function fallbackCopy(text, notify) {
        try {
          const helper = document.createElement('textarea');
          helper.value = text;
          helper.setAttribute('readonly', '');
          helper.style.position = 'absolute';
          helper.style.left = '-9999px';
          document.body.appendChild(helper);
          helper.select();
          document.execCommand('copy');
          document.body.removeChild(helper);
          notify('Link copied');
        } catch (err) {
          console.warn('[spec] clipboard copy failed', err);
          notify('Copy failed');
        }
      }

      if (payloadParam) {
        const payload = decodeSharePayload(payloadParam);
        if (payload && payload.job) {
          const meta = {
            ...(payload.meta || {}),
            snapshot: true,
            local: false,
          };
          if (localSlug) {
            try {
              getLocalShare(localSlug);
            } catch (err) {
              console.warn('[spec] unable to sync local share cache', err);
            }
          }
          renderSpec(payload.job, meta);
          loading.style.display = 'none';
          card.style.display = 'grid';
          return;
        }
        loading.style.display = 'none';
        errorBox.textContent = 'This share link is invalid or has expired. Please generate a new link from the HMJ Global admin dashboard.';
        errorBox.style.display = 'block';
        return;
      }

      if (localSlug) {
        const localEntry = getLocalShare(localSlug);
        if (localEntry && localEntry.job) {
          renderSpec(localEntry.job, {
            slug: localEntry.slug,
            local: true,
            created_at: localEntry.createdAt || null,
            expires_at: localEntry.expiresAt || null,
            refreshed_at: localEntry.updatedAt || null,
            last_accessed: localEntry.lastAccessed || null,
          });
          loading.style.display = 'none';
          card.style.display = 'grid';
          return;
        }
        loading.style.display = 'none';
        errorBox.textContent = 'This preview link has expired or is unavailable on this device. Please generate a fresh link from the HMJ Global admin dashboard.';
        errorBox.style.display = 'block';
        return;
      }

      if (!slug && !jobId) {
        loading.style.display = 'none';
        errorBox.textContent = 'Missing share link. Please contact HMJ Global for a fresh link.';
        errorBox.style.display = 'block';
        return;
      }

      try {
        const qs = new URLSearchParams();
        if (slug) qs.set('slug', slug);
        if (jobId) qs.set('id', jobId);
        const res = await fetch(`/.netlify/functions/job-spec-get?${qs.toString()}`, { cache: 'no-store' });
        if (!res.ok) {
          const msg = await res.json().catch(()=>({}));
          throw new Error(msg.error || `Unable to load spec (${res.status})`);
        }
        const data = await res.json();
        if (!data?.job) throw new Error('Job not found');
        renderSpec(data.job, data);
        loading.style.display = 'none';
        card.style.display = 'grid';
      } catch (err) {
        loading.style.display = 'none';
        errorBox.textContent = err.message || 'Unable to load job spec.';
        errorBox.style.display = 'block';
      }

      function renderSpec(job, meta){
        const statusEl = document.getElementById('status');
        statusEl.textContent = job.status ? job.status.toUpperCase() : 'OPEN';
        statusEl.className = `badge ${job.status === 'closed' ? 'closed' : job.status === 'interviewing' ? 'interviewing' : 'live'}`;
        document.getElementById('title').textContent = job.title || 'Role';
        if (job.title) {
          document.title = `${job.title} | HMJ Global`;
        }
        const locationText = job.locationText || 'Flexible';
        document.getElementById('location').textContent = locationText;
        document.getElementById('employment').textContent = job.type ? job.type.toUpperCase() : '';
        const tags = Array.isArray(job.tags) ? job.tags : [];
        const tagHost = document.getElementById('tags');
        if (tags.length) {
          tagHost.innerHTML = tags.map(tag => `<span>${tag}</span>`).join('');
          tagHost.style.display = '';
        } else {
          tagHost.innerHTML = '';
          tagHost.style.display = 'none';
        }
        document.getElementById('overview').textContent = job.overview || '';
        const respSection = document.getElementById('responsibilities');
        const respList = document.getElementById('respList');
        respList.innerHTML = (job.responsibilities || []).map(item => `<li>${item}</li>`).join('');
        respSection.style.display = respList.innerHTML ? '' : 'none';
        const reqSection = document.getElementById('requirements');
        const reqList = document.getElementById('reqList');
        reqList.innerHTML = (job.requirements || []).map(item => `<li>${item}</li>`).join('');
        reqSection.style.display = reqList.innerHTML ? '' : 'none';
        const apply = job.applyUrl && job.applyUrl.trim() ? job.applyUrl.trim() : `https://www.hmj-global.com/contact.html?role=${encodeURIComponent(job.title||'Role')}`;
        const applyBtn = document.getElementById('applyBtn');
        applyBtn.href = apply;
        const metaParts = [];
        if (meta.snapshot) metaParts.push('Snapshot preview');
        if (meta.local) metaParts.push('Local preview');
        if (meta.slug && !meta.local) metaParts.push(`Share code ${meta.slug}`);
        if (meta.created_at) metaParts.push(new Date(meta.created_at).toLocaleString());
        if (meta.refreshed_at) metaParts.push(`Updated ${new Date(meta.refreshed_at).toLocaleString()}`);
        if (meta.last_accessed && meta.local) metaParts.push(`Opened ${new Date(meta.last_accessed).toLocaleString()}`);
        if (meta.expires_at) metaParts.push(`Expires ${new Date(meta.expires_at).toLocaleDateString()}`);
        if (meta.fallback) metaParts.push('Static preview');
        const metaEl = document.getElementById('meta');
        metaEl.textContent = metaParts.join(' â€¢ ');
        metaEl.style.display = metaParts.length ? '' : 'none';
        shareContext = {
          jobTitle: job.title || 'Role',
          locationText,
          applyUrl: apply,
          shareLink: location.href,
        };
      }
    })();
  </script>
</body>
</html>
