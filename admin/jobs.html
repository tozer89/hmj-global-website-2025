<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Jobs — Admin | HMJ Global</title>

  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>
  <script defer src="../js/identity-loader.js"></script>
  <script defer src="/admin/common.js?v=21"></script>

  <style>
    :root{
      --bg:#f4f6ff; --panel:#ffffff; --border:#d7def3; --highlight:#2f4ea2; --accent:#3f66c7;
      --ink:#0f1b3f; --muted:#5d6f9e; --chip:#eef2ff; --danger:#b42318; --ok:#138754;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 "Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:inherit}

    .top{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,var(--highlight),#284190);color:#fff;border-bottom:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(15,27,63,.18)}
    .row{max-width:1420px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;letter-spacing:.02em;font-size:16px}
    .sp{flex:1}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.32);color:#f5f7ff;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.08em}

    .btn{background:linear-gradient(180deg,rgba(47,78,162,.12),rgba(47,78,162,.04));color:var(--ink);border:1px solid rgba(47,78,162,.25);padding:9px 15px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .16s ease,box-shadow .2s ease,border-color .2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(47,78,162,.18);border-color:rgba(47,78,162,.45)}
    .btn.ghost{background:#fff;border-color:rgba(47,78,162,.18);color:var(--highlight)}
    .btn.primary{background:linear-gradient(180deg,rgba(47,78,162,.22),rgba(47,78,162,.12));border-color:rgba(47,78,162,.55);color:#fff;box-shadow:0 12px 28px rgba(47,78,162,.22)}
    .btn.danger{background:linear-gradient(180deg,rgba(180,35,24,.18),rgba(180,35,24,.08));border-color:rgba(180,35,24,.4);color:#fff}
    .btn.small{padding:7px 12px;font-size:13px;border-radius:10px}
    .btn:disabled,.btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;transform:none}

    .wrap{max-width:1420px;margin:24px auto;padding:0 20px;display:grid;gap:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 18px 40px rgba(15,27,63,.12)}
    .panel.notice{display:none;background:#eef2ff;border:1px solid rgba(47,78,162,.25);color:var(--highlight);font-weight:600;gap:6px}
    .panel h2{margin:0 0 10px;font-size:15px;text-transform:uppercase;letter-spacing:.18em;color:var(--muted)}
    .muted{color:var(--muted)}

    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .filters-grid .search{grid-column:span 2;display:flex;align-items:center;gap:8px;background:#fff;border:1px solid rgba(47,78,162,.15);border-radius:12px;padding:6px 10px;box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}
    .filters-grid .search input{flex:1;background:transparent;border:0;color:var(--ink);font:inherit;padding:4px 0}
    .filters-grid select{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(47,78,162,.18);background:#fff;color:var(--ink);font-weight:600}
    .filters-actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:14px}

    .chip-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border-radius:999px;border:1px solid rgba(47,78,162,.25);background:var(--chip);cursor:pointer;font-weight:700;font-size:13px;color:var(--highlight);transition:transform .16s ease,box-shadow .2s ease,border-color .2s ease}
    .chip .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 2px rgba(47,78,162,.2)}
    .chip.active{border-color:rgba(47,78,162,.55);background:rgba(47,78,162,.12);transform:translateY(-1px);box-shadow:0 12px 24px rgba(47,78,162,.18)}

    .section-form{display:flex;flex-wrap:wrap;gap:10px;margin-top:18px}
    .section-form input{flex:1;min-width:220px;padding:11px 12px;border-radius:12px;border:1px solid rgba(47,78,162,.2);background:#fff;color:var(--ink);font-weight:600}

    .board{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:start}
    .column{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;display:grid;gap:10px;min-height:240px;position:relative}
    .column.drag-target{border-color:rgba(47,78,162,.65);box-shadow:0 0 0 2px rgba(47,78,162,.35)}
    .column-header{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .column-header h3{margin:0;font-size:15px;display:flex;align-items:center;gap:8px}
    .column-header .count{padding:2px 8px;border-radius:999px;background:#eef2ff;font-size:12px;color:var(--highlight);font-weight:700}
    .column-body{display:grid;gap:10px;min-height:150px}
    .drop-zone{flex:1;border:1px dashed rgba(47,78,162,.25);border-radius:14px;padding:20px;display:grid;place-items:center;color:var(--muted);font-weight:600;background:#f7f8ff}

    .card{background:#fff;border:1px solid rgba(47,78,162,.18);border-radius:16px;padding:12px 14px;display:grid;gap:6px;cursor:grab;transition:transform .16s ease,box-shadow .2s ease,border-color .2s ease}
    .card:active{cursor:grabbing}
    .card:hover{transform:translateY(-2px);box-shadow:0 18px 32px rgba(15,27,63,.18);border-color:rgba(47,78,162,.45)}
    .card h4{margin:0;font-size:15px;color:var(--ink);display:flex;align-items:center;gap:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;background:rgba(47,78,162,.12);color:var(--highlight);text-transform:uppercase;letter-spacing:.05em}
    .badge.live{background:rgba(17,137,84,.12);color:#0f5132;border:1px solid rgba(17,137,84,.28)}
    .badge.interviewing{background:rgba(250,204,21,.14);color:#854d0e;border:1px solid rgba(250,204,21,.35)}
    .badge.closed{background:rgba(180,35,24,.12);color:#842029;border:1px solid rgba(180,35,24,.35)}
    .tags{display:flex;flex-wrap:wrap;gap:6px;font-size:12px}
    .tags span{padding:3px 7px;border-radius:999px;background:rgba(47,78,162,.12);border:1px solid rgba(47,78,162,.35);color:var(--highlight);font-weight:600}
    .card footer{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .card footer button{background:transparent;border:0;color:var(--highlight);font-weight:700;cursor:pointer}
    .card footer button:hover{text-decoration:underline}

    .drawer{position:fixed;top:0;right:0;bottom:0;width:min(680px,92vw);background:#f8f9ff;border-left:1px solid var(--border);box-shadow:-24px 0 60px rgba(15,27,63,.24);transform:translateX(100%);transition:transform .24s ease;display:grid;grid-template-rows:auto 1fr auto;z-index:200}
    .drawer.open{transform:translateX(0)}
    .drawer-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:#fff}
    .drawer-body{padding:18px 22px;overflow:auto;display:grid;gap:18px}
    .drawer-foot{padding:16px 22px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:12px;justify-content:flex-end;background:#fff}
    .drawer h3{margin:0;font-size:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.04em;text-transform:uppercase}
    .field input,.field select,.field textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(47,78,162,.18);background:#fff;color:var(--ink);font-weight:600;font-size:14px}
    .field textarea{min-height:110px;resize:vertical}
    .switch{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--highlight)}
    .switch input{width:18px;height:18px}
    .tag-editor{display:flex;flex-wrap:wrap;gap:8px;background:#f4f6ff;border:1px solid rgba(47,78,162,.18);border-radius:12px;padding:10px}
    .tag-editor .token{padding:6px 10px;border-radius:999px;background:rgba(47,78,162,.12);display:inline-flex;align-items:center;gap:6px;font-weight:700;color:var(--highlight)}
    .tag-editor .token button{background:transparent;border:0;color:var(--highlight);font-weight:900;cursor:pointer}
    .tag-editor input{flex:1;min-width:140px;border:0;background:transparent;color:var(--ink);font-weight:600;padding:4px}

    .share-box{display:grid;gap:10px;background:#f4f6ff;border:1px solid rgba(47,78,162,.2);border-radius:14px;padding:14px}
    .share-box code{word-break:break-all;font-size:13px;background:#e8ecff;padding:6px 8px;border-radius:10px;border:1px solid rgba(47,78,162,.15)}
    .share-box input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(47,78,162,.2);background:#fff;color:var(--ink);font-weight:600}
    .share-box .share-actions{display:flex;gap:8px;flex-wrap:wrap}

    #toast{position:fixed;right:18px;bottom:18px;display:grid;gap:10px;z-index:9999}
    #toast .notice{padding:10px 12px;border-radius:12px;background:#ffffff;border:1px solid rgba(47,78,162,.25);box-shadow:0 18px 34px rgba(15,27,63,.2);font-weight:700}

    @media(max-width:820px){
      .filters-grid .search{grid-column:span 1}
      .column{min-height:200px}
    }
  </style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">Jobs Console</div>
    <span class="pill">Admin</span>
    <div class="sp"></div>
    <a class="btn ghost" href="/">← Website</a>
    <button class="btn ghost" id="btnDiag" title="Show diagnostics">◉</button>
    <a class="btn ghost" href="/admin/">⟵ Dashboard</a>
    <button class="btn" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <div class="wrap" id="gate" style="display:none">
    <div class="panel">
      <h2>Restricted</h2>
      <p class="muted why">Checking your session…</p>
      <button class="btn primary" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <section class="panel notice" id="readOnlyNotice">
      <div>Read-only mode.</div>
      <div class="muted">Supabase credentials are missing so jobs are loaded from the static fallback. Configure the environment to enable editing.</div>
    </section>
    <section class="panel notice" id="seedNotice" style="display:none">
      <div>Imported from the legacy jobs board.</div>
      <div class="muted">These jobs came from the static site. Save a job to import it into Supabase and unlock sharing.</div>
    </section>
    <section class="panel" id="filtersPanel">
      <div class="filters-grid">
        <div class="search"><svg width="16" height="16" fill="none" stroke="#60a5fa" stroke-width="2"><circle cx="7" cy="7" r="5"/><path d="m11 11 4 4"/></svg><input id="filterSearch" type="search" placeholder="Search title, location, keywords" autocomplete="off"/></div>
        <select id="filterStatus">
          <option value="all">Any status</option>
          <option value="live">Live</option>
          <option value="interviewing">Interviewing</option>
          <option value="closed">Closed</option>
        </select>
        <select id="filterType">
          <option value="all">Any type</option>
          <option value="permanent">Permanent</option>
          <option value="contract">Contract</option>
          <option value="fixed-term">Fixed term</option>
        </select>
        <select id="filterPublished">
          <option value="all">All visibility</option>
          <option value="published">Published</option>
          <option value="drafts">Draft only</option>
        </select>
        <select id="filterSection">
          <option value="all">All categories</option>
        </select>
      </div>
      <div class="filters-actions">
        <div class="muted" id="resultMeta">0 jobs</div>
        <div class="sp"></div>
        <button class="btn ghost small" id="clearFilters">Clear filters</button>
        <button class="btn ghost small" id="btnRefresh">Refresh</button>
        <button class="btn primary small" id="btnNew" data-readonly="true">＋ New job</button>
      </div>
      <div class="chip-list" id="tagFilterChips"></div>
      <form class="section-form" id="addSectionForm">
        <input id="newSectionInput" placeholder="Add new category heading (e.g. Critical Infrastructure)" autocomplete="off"/>
        <button class="btn ghost small" type="submit">Add category</button>
      </form>
    </section>

    <section class="board" id="boardColumns" aria-live="polite"></section>
  </div>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div style="flex:1">
        <h3 id="drawerTitle">Job editor</h3>
        <div class="muted" id="drawerMeta"></div>
      </div>
      <label class="switch"><input type="checkbox" id="edPublished"/> Published</label>
      <button class="btn ghost small" id="btnClose">✕ Close</button>
    </div>
    <div class="drawer-body">
      <form id="jobForm" autocomplete="off">
        <div class="grid">
          <div class="field"><label for="edId">Job slug / ID</label><input id="edId" placeholder="auto"/></div>
          <div class="field"><label for="edTitle">Title</label><input id="edTitle" required/></div>
          <div class="field"><label for="edStatus">Status</label><select id="edStatus"><option value="live">Live</option><option value="interviewing">Interviewing</option><option value="closed">Closed</option></select></div>
          <div class="field"><label for="edSection">Category heading</label><input id="edSection" list="sectionOptions" placeholder="e.g. Data Centre Delivery"/></div>
          <div class="field"><label for="edDiscipline">Discipline</label><input id="edDiscipline"/></div>
          <div class="field"><label for="edType">Employment type</label><select id="edType"><option value="permanent">Permanent</option><option value="contract">Contract</option><option value="fixed-term">Fixed term</option></select></div>
          <div class="field"><label for="edLocationText">Location (display)</label><input id="edLocationText"/></div>
          <div class="field"><label for="edLocationCode">Location code</label><input id="edLocationCode" placeholder="slug for filters"/></div>
          <div class="field"><label for="edApply">Apply URL</label><input id="edApply" placeholder="Defaults to contact form"/></div>
          <div class="field"><label for="edSortOrder">Sort weight</label><input id="edSortOrder" type="number" step="1" min="0"/></div>
        </div>

        <div class="field">
          <label>Tags</label>
          <div class="tag-editor" id="tagEditor"><input id="tagInput" placeholder="Type tag and press Enter"/></div>
        </div>

        <div class="field"><label for="edOverview">Card overview</label><textarea id="edOverview" placeholder="Short intro shown on jobs page"></textarea></div>

        <div class="grid">
          <div class="field"><label for="edResponsibilities">Responsibilities (one per line)</label><textarea id="edResponsibilities"></textarea></div>
          <div class="field"><label for="edRequirements">Requirements (one per line)</label><textarea id="edRequirements"></textarea></div>
        </div>
      </form>

      <div class="share-box">
        <div>
          <strong>Shareable spec</strong>
          <p class="muted">Generate a standalone advert page for this job. Links expire automatically. When Supabase is offline the page is stored locally for 30 days.</p>
        </div>
        <button class="btn ghost small" id="btnShare" data-readonly="soft">Generate share link</button>
        <div id="shareResult" style="display:none">
          <code id="shareMeta"></code>
          <input id="shareUrl" readonly/>
          <div class="share-actions">
            <button class="btn ghost small" id="btnCopyShare" data-readonly="soft">Copy link</button>
            <button class="btn ghost small" id="btnRefreshShare" data-readonly="soft" style="display:none">Refresh link</button>
          </div>
        </div>
      </div>
    </div>
    <div class="drawer-foot">
      <button class="btn ghost" id="btnDelete" data-readonly="true">Delete</button>
      <button class="btn primary" id="btnSave" data-readonly="true">Save job</button>
    </div>
  </aside>

  <datalist id="sectionOptions"></datalist>
  <div id="toast"></div>

  <script>
  (function startJobs(){
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function') {
      return setTimeout(startJobs, 40);
    }

    window.Admin.bootAdmin(async ({ api, sel, toast, identity }) => {
      const state = {
        jobs: [],
        filters: { q:'', status:'all', type:'all', published:'all', section:'all', tags:new Set() },
        sectionOrder: [],
        tags: [],
        dragging: null,
        editing: null,
        editingTags: [],
        shareLink: null,
        diagnostics: false,
        readOnly: false,
        fallbackSource: '',
        seeded: false,
        schemaMismatch: false,
      };

      const board = sel('#boardColumns');
      const filterStatus = sel('#filterStatus');
      const filterType = sel('#filterType');
      const filterPublished = sel('#filterPublished');
      const filterSection = sel('#filterSection');
      const filterSearch = sel('#filterSearch');
      const tagChips = sel('#tagFilterChips');
      const resultMeta = sel('#resultMeta');
      const addSectionForm = sel('#addSectionForm');
      const newSectionInput = sel('#newSectionInput');
      const sectionOptions = sel('#sectionOptions');
      const drawer = sel('#drawer');
      const drawerTitle = sel('#drawerTitle');
      const drawerMeta = sel('#drawerMeta');
      const shareBox = sel('#shareResult');
      const shareMeta = sel('#shareMeta');
      const shareUrl = sel('#shareUrl');
      const btnRefreshShare = sel('#btnRefreshShare');
      const tagEditor = sel('#tagEditor');
      const tagInput = sel('#tagInput');
      const readOnlyNotice = sel('#readOnlyNotice');
      const seedNotice = sel('#seedNotice');
      const readOnlyControls = Array.from(document.querySelectorAll('[data-readonly]'));
      const btnDiag = sel('#btnDiag');

      function applyReadOnly() {
        if (readOnlyNotice) readOnlyNotice.style.display = state.readOnly ? '' : 'none';
        readOnlyControls.forEach((el) => {
          if (!el) return;
          const mode = (el.dataset.readonly || 'hard').toLowerCase();
          const disable = !!state.readOnly && mode !== 'soft';
          el.classList.toggle('disabled', disable);
          el.toggleAttribute('disabled', disable);
          if ('disabled' in el) {
            el.disabled = disable;
          }
        });
      }

      function applySeedNotice() {
        if (!seedNotice) return;
        seedNotice.style.display = state.seeded ? '' : 'none';
      }

      const form = {
        id: sel('#edId'),
        title: sel('#edTitle'),
        status: sel('#edStatus'),
        section: sel('#edSection'),
        discipline: sel('#edDiscipline'),
        type: sel('#edType'),
        locationText: sel('#edLocationText'),
        locationCode: sel('#edLocationCode'),
        overview: sel('#edOverview'),
        responsibilities: sel('#edResponsibilities'),
        requirements: sel('#edRequirements'),
        apply: sel('#edApply'),
        published: sel('#edPublished'),
        sortOrder: sel('#edSortOrder'),
      };

      const statusBadgeClass = (status) => {
        const v = (status || '').toLowerCase();
        if (v === 'live') return 'badge live';
        if (v === 'closed') return 'badge closed';
        return 'badge interviewing';
      };

      function slugify(text) {
        return (text || '')
          .toString()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 80);
      }

      function toList(value) {
        if (Array.isArray(value)) {
          return value.map((item) => String(item || '').trim()).filter(Boolean);
        }
        if (!value) return [];
        return String(value)
          .split(/\r?\n|\u2022|,/)
          .map((part) => part.replace(/^[-*•\s]+/, '').trim())
          .filter(Boolean);
      }

      function normalizeJob(row = {}) {
        const sectionLabel = (row.sectionLabel || row.section || 'General').toString().trim() || 'General';
        const publishedRaw = row.published ?? row.isPublished;
        let published;
        if (publishedRaw === undefined || publishedRaw === null) {
          published = true;
        } else if (typeof publishedRaw === 'string') {
          published = !/^(false|0|no|off)$/i.test(publishedRaw.trim());
        } else {
          published = !!publishedRaw;
        }

        const normalized = {
          id: (row.id || row.slug || '').toString().trim(),
          title: (row.title || row.name || '').toString().trim(),
          status: (row.status || 'live').toString().trim().toLowerCase() || 'live',
          section: sectionLabel,
          sectionLabel,
          sectionKey: slugify(sectionLabel) || 'general',
          discipline: (row.discipline || '').toString().trim(),
          type: (row.type || 'permanent').toString().trim().toLowerCase() || 'permanent',
          locationText: (row.locationText || row.location_text || '').toString().trim(),
          locationCode: (row.locationCode || row.location_code || '').toString().trim(),
          overview: (row.overview || '').toString().trim(),
          responsibilities: toList(row.responsibilities || row.responsibilitiesText),
          requirements: toList(row.requirements || row.requirementsText),
          applyUrl: (row.applyUrl || row.apply_url || '').toString().trim(),
          published,
          sortOrder: Number.isFinite(row.sortOrder)
            ? Number(row.sortOrder)
            : Number.isFinite(row.sort_order)
              ? Number(row.sort_order)
              : null,
          tags: Array.isArray(row.tags) && row.tags.length
            ? row.tags.map((tag) => String(tag || '').trim()).filter(Boolean)
            : toList(row.tags || row.keywords),
          keywords: (row.keywords || '').toString().trim(),
          createdAt: row.createdAt || row.created_at || null,
          updatedAt: row.updatedAt || row.updated_at || null,
        };
        if (!normalized.id) {
          normalized.id = `job-${Math.random().toString(36).slice(2, 10)}`;
        }
        return normalized;
      }

      function buildSharePayload(job) {
        if (!job) return null;
        const normalized = normalizeJob(job);
        return {
          id: normalized.id,
          title: normalized.title,
          status: normalized.status,
          section: normalized.sectionLabel || normalized.section,
          sectionLabel: normalized.sectionLabel,
          discipline: normalized.discipline,
          type: normalized.type,
          location_text: normalized.locationText,
          location_code: normalized.locationCode,
          overview: normalized.overview,
          responsibilities: Array.isArray(normalized.responsibilities) ? normalized.responsibilities : [],
          requirements: Array.isArray(normalized.requirements) ? normalized.requirements : [],
          keywords: normalized.keywords || (Array.isArray(normalized.tags) ? normalized.tags.join(', ') : ''),
          tags: Array.isArray(normalized.tags) ? normalized.tags : [],
          apply_url: normalized.applyUrl,
          published: normalized.published,
          sort_order: normalized.sortOrder ?? null,
        };
      }

      const LOCAL_SHARE_KEY = 'hmj.jobs.share-cache';
      const LOCAL_SHARE_VERSION = 1;
      const LOCAL_SHARE_TTL = 1000 * 60 * 60 * 24 * 30; // 30 days

      function saveLocalShareStore(store) {
        if (!window.localStorage) return;
        try {
          localStorage.setItem(LOCAL_SHARE_KEY, JSON.stringify(store));
        } catch (err) {
          console.warn('[jobs] local share store write failed', err);
        }
      }

      function pruneLocalShareStore(store) {
        if (!store) return null;
        const now = Date.now();
        let dirty = false;
        const bySlug = { ...store.bySlug };
        const byJob = { ...store.byJob };
        Object.entries(bySlug).forEach(([slug, entry]) => {
          if (!entry || !entry.expiresAt || entry.expiresAt < now) {
            dirty = true;
            delete bySlug[slug];
            const jobKey = entry && entry.jobKey;
            if (jobKey && byJob[jobKey] === slug) delete byJob[jobKey];
          }
        });
        Object.entries(byJob).forEach(([jobKey, slug]) => {
          if (!slug || !bySlug[slug]) {
            dirty = true;
            delete byJob[jobKey];
          }
        });
        const next = { version: LOCAL_SHARE_VERSION, bySlug, byJob };
        if (dirty) saveLocalShareStore(next);
        return next;
      }

      function loadLocalShareStore() {
        if (!window.localStorage) return null;
        try {
          const raw = localStorage.getItem(LOCAL_SHARE_KEY);
          const parsed = raw ? JSON.parse(raw) : null;
          const store = {
            version: LOCAL_SHARE_VERSION,
            bySlug: parsed && typeof parsed.bySlug === 'object' ? { ...parsed.bySlug } : {},
            byJob: parsed && typeof parsed.byJob === 'object' ? { ...parsed.byJob } : {},
          };
          return pruneLocalShareStore(store);
        } catch (err) {
          console.warn('[jobs] local share store load failed', err);
          const store = { version: LOCAL_SHARE_VERSION, bySlug: {}, byJob: {} };
          saveLocalShareStore(store);
          return store;
        }
      }

      function localShareJobKey(normalized) {
        const id = (normalized.id || '').toString().trim();
        if (id) return `id:${id}`;
        const titleSlug = slugify(normalized.title || '') || 'draft';
        return `slug:${titleSlug}`;
      }

      function sanitizeNormalizedJob(normalized) {
        return {
          id: normalized.id,
          title: normalized.title,
          status: normalized.status,
          section: normalized.sectionLabel || normalized.section,
          sectionLabel: normalized.sectionLabel,
          discipline: normalized.discipline,
          type: normalized.type,
          locationText: normalized.locationText,
          locationCode: normalized.locationCode,
          overview: normalized.overview,
          responsibilities: Array.isArray(normalized.responsibilities)
            ? normalized.responsibilities.map((item) => String(item || '').trim()).filter(Boolean)
            : [],
          requirements: Array.isArray(normalized.requirements)
            ? normalized.requirements.map((item) => String(item || '').trim()).filter(Boolean)
            : [],
          tags: Array.isArray(normalized.tags)
            ? normalized.tags.map((item) => String(item || '').trim()).filter(Boolean)
            : [],
          applyUrl: normalized.applyUrl,
          keywords: normalized.keywords || '',
          published: normalized.published !== false,
          sortOrder: Number.isFinite(normalized.sortOrder) ? normalized.sortOrder : null,
        };
      }

      function ensureLocalShare(job, options = {}) {
        if (!window.localStorage) return null;
        const normalized = normalizeJob(job);
        const store = loadLocalShareStore();
        if (!store) return null;
        const now = Date.now();
        const jobKey = localShareJobKey(normalized);
        const preferredSlug = options.preferredSlug || null;
        let slug = preferredSlug || store.byJob[jobKey] || null;
        let entry = slug ? store.bySlug[slug] : null;

        if (entry && entry.expiresAt && entry.expiresAt < now) {
          delete store.bySlug[entry.slug];
          if (store.byJob[jobKey] === entry.slug) delete store.byJob[jobKey];
          slug = null;
          entry = null;
        }

        if (entry && !options.forceRefresh) {
          entry.expiresAt = now + LOCAL_SHARE_TTL;
          entry.lastAccessed = now;
          entry.jobKey = jobKey;
          store.bySlug[entry.slug] = entry;
          store.byJob[jobKey] = entry.slug;
          saveLocalShareStore(store);
          return { entry, reused: true, store };
        }

        if (!slug) {
          const base = slugify(normalized.title || '') || 'role';
          slug = `${base}-${Math.random().toString(36).slice(2, 8)}`;
        }

        const sanitized = sanitizeNormalizedJob(normalized);
        if (entry && entry.jobKey && entry.jobKey !== jobKey && store.byJob[entry.jobKey] === entry.slug) {
          delete store.byJob[entry.jobKey];
        }
        const nextEntry = {
          slug,
          jobKey,
          job: sanitized,
          createdAt: entry?.createdAt || now,
          updatedAt: now,
          lastAccessed: now,
          expiresAt: now + LOCAL_SHARE_TTL,
        };
        store.bySlug[slug] = nextEntry;
        store.byJob[jobKey] = slug;
        saveLocalShareStore(store);
        return { entry: nextEntry, reused: !!entry, store };
      }

      function buildLocalShareUrl(slug) {
        if (!slug) return '';
        const origin = location.origin || `${location.protocol}//${location.host}`;
        return `${origin.replace(/\/$/, '')}/jobs/spec.html?local=${encodeURIComponent(slug)}`;
      }

      function formatShareDate(ts, includeTime = false) {
        if (!ts) return '';
        try {
          const date = new Date(ts);
          if (Number.isNaN(date.getTime())) return '';
          if (includeTime) {
            return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
          }
          return date.toLocaleDateString(undefined, { dateStyle: 'medium' });
        } catch (err) {
          return '';
        }
      }

      function buildSections() {
        const seen = new Map();
        state.jobs.forEach((job) => {
          const key = job.sectionKey || slugify(job.section || job.sectionLabel || 'General') || 'general';
          const label = job.sectionLabel || job.section || 'General';
          if (!seen.has(key)) seen.set(key, label);
          job.sectionKey = key;
          job.sectionLabel = label;
          job.section = label;
        });
        if (!seen.size) {
          seen.set('general', 'General');
        }
        state.sectionOrder = Array.from(seen.entries()).map(([key, label]) => ({ key, label }));
        state.sectionOrder.sort((a, b) => a.label.localeCompare(b.label));
        updateSectionSelect();
      }

      function updateSectionSelect() {
        filterSection.innerHTML = '<option value="all">All categories</option>' + state.sectionOrder.map((s) => `<option value="${s.key}">${s.label}</option>`).join('');
        sectionOptions.innerHTML = state.sectionOrder.map((s) => `<option value="${s.label}">`).join('');
      }

      function buildTags() {
        const set = new Set();
        state.jobs.forEach((job) => (job.tags || []).forEach((t) => set.add(t.toLowerCase())));
        state.tags = Array.from(set).sort();
      }

      function applyFilters(job) {
        const { q, status, type, published, section, tags } = state.filters;
        if (status !== 'all' && (job.status || '').toLowerCase() !== status) return false;
        if (type !== 'all' && (job.type || '').toLowerCase() !== type) return false;
        if (published === 'published' && !job.published) return false;
        if (published === 'drafts' && job.published) return false;
        if (section !== 'all' && (job.sectionKey || 'general') !== section) return false;
        if (tags.size) {
          const jobTags = new Set((job.tags || []).map((t) => t.toLowerCase()));
          for (const tag of tags) {
            if (!jobTags.has(tag)) return false;
          }
        }
        if (q) {
          const hay = [job.title, job.overview, job.locationText, job.locationCode, job.discipline, job.sectionLabel, job.applyUrl, job.keywords]
            .concat(job.tags || [])
            .join(' ')
            .toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      }

      function filteredJobs() {
        return state.jobs.filter(applyFilters);
      }

      function renderTagChips() {
        if (!tagChips) return;
        tagChips.innerHTML = '';
        if (!state.tags.length) {
          const span = document.createElement('span');
          span.className = 'muted';
          span.textContent = 'Tags appear once jobs include them.';
          tagChips.appendChild(span);
          return;
        }
        state.tags.forEach((tag) => {
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'chip' + (state.filters.tags.has(tag) ? ' active' : '');
          chip.innerHTML = `<span class="dot"></span>${tag}`;
          chip.onclick = () => {
            if (state.filters.tags.has(tag)) state.filters.tags.delete(tag);
            else state.filters.tags.add(tag);
            renderAll();
          };
          tagChips.appendChild(chip);
        });
      }

      function formatDate(d) {
        if (!d) return '';
        try {
          return new Date(d).toLocaleString();
        } catch { return ''; }
      }

      function reindexColumn(key) {
        const label = state.sectionOrder.find((s) => s.key === key)?.label || 'General';
        const column = state.jobs
          .filter((job) => (job.sectionKey || 'general') === key)
          .sort((a, b) => ((a.sortOrder ?? 0) - (b.sortOrder ?? 0)));
        column.forEach((job, idx) => {
          job.sortOrder = idx * 100 + 10;
          job.sectionKey = key;
          job.sectionLabel = label;
          job.section = label;
        });
        return column;
      }

      async function persistOrder(jobs) {
        if (state.readOnly || !jobs.length) return;
        try {
          const payload = jobs.map((job) => ({ id: job.id, section: job.section, sortOrder: job.sortOrder }));
          const res = await api('admin-jobs-reorder', 'POST', { updates: payload });
          if (Array.isArray(res?.jobs)) {
            res.jobs.forEach((updated) => {
              const found = state.jobs.find((j) => j.id === updated.id);
              if (found) Object.assign(found, updated);
            });
          }
        } catch (e) {
          console.error('[jobs] reorder failed', e);
          toast('Reorder failed: ' + (e.message || e), 'error', 4200);
        }
      }

      function moveJob(jobId, targetKey, beforeId) {
        if (state.readOnly) return;
        const job = state.jobs.find((j) => j.id === jobId);
        if (!job) return;
        const originKey = job.sectionKey || 'general';
        if (!targetKey) targetKey = 'general';
        const targetLabel = state.sectionOrder.find((s) => s.key === targetKey)?.label || 'General';
        job.sectionKey = targetKey;
        job.sectionLabel = targetLabel;
        job.section = targetLabel;

        const targetJobs = state.jobs.filter((j) => (j.sectionKey || 'general') === targetKey && j.id !== jobId);
        if (beforeId) {
          const idx = targetJobs.findIndex((j) => j.id === beforeId);
          if (idx === -1) targetJobs.push(job);
          else targetJobs.splice(idx, 0, job);
        } else {
          targetJobs.push(job);
        }
        targetJobs.forEach((j, idx) => { j.sortOrder = idx * 100 + 10; j.section = targetLabel; j.sectionLabel = targetLabel; j.sectionKey = targetKey; });

        let touched = [...targetJobs];
        if (originKey !== targetKey) {
          touched = touched.concat(reindexColumn(originKey));
        }
        renderBoard();
        persistOrder(Array.from(new Map(touched.map((j) => [j.id, j])).values()));
      }

      function renderBoard() {
        if (!board) return;
        board.innerHTML = '';
        const groups = new Map();
        state.sectionOrder.forEach((s) => groups.set(s.key, []));
        const matches = filteredJobs();
        matches.forEach((job) => {
          const key = job.sectionKey || 'general';
          if (!groups.has(key)) {
            const label = job.sectionLabel || job.section || 'General';
            groups.set(key, []);
            state.sectionOrder.push({ key, label });
          }
          groups.get(key).push(job);
        });
        state.sectionOrder = Array.from(new Map(state.sectionOrder.map((s) => [s.key, s])).values());
        updateSectionSelect();
        let total = 0;
        groups.forEach((list) => { total += list.length; });
        resultMeta.textContent = `${matches.length} of ${state.jobs.length} jobs`;

        const frag = document.createDocumentFragment();
        for (const section of state.sectionOrder) {
          const column = document.createElement('section');
          column.className = 'column';
          column.dataset.key = section.key;
          column.innerHTML = `
            <div class="column-header">
              <h3>${section.label}</h3>
              <span class="count">${(groups.get(section.key) || []).length}</span>
            </div>
            <div class="column-body" data-body="${section.key}"></div>
          `;
          const body = column.querySelector('.column-body');
          const jobs = (groups.get(section.key) || []).sort((a, b) => ((a.sortOrder ?? 0) - (b.sortOrder ?? 0)));
          if (!jobs.length) {
            const empty = document.createElement('div');
            empty.className = 'drop-zone';
            empty.textContent = 'Drop job here';
            body.appendChild(empty);
          } else {
            jobs.forEach((job) => body.appendChild(renderCard(job)));
          }
          setupDropZone(column, section.key);
          frag.appendChild(column);
        }
        board.appendChild(frag);
      }

      function renderCard(job) {
        const card = document.createElement('article');
        card.className = 'card';
        if (!state.readOnly) {
          card.setAttribute('draggable', 'true');
        } else {
          card.removeAttribute('draggable');
        }
        card.dataset.id = job.id;
        card.innerHTML = `
          <h4>${job.title || 'Untitled'} ${job.published ? '' : '<span class="badge">Draft</span>'}</h4>
          <span class="badge ${statusBadgeClass(job.status)}">${(job.status || '').toUpperCase()}</span>
          <div class="muted">${job.locationText || 'Location TBC'}</div>
          ${(job.tags || []).length ? `<div class="tags">${job.tags.map((t) => `<span>${t}</span>`).join('')}</div>` : ''}
          <footer>
            <span>${job.type || ''}</span>
            <button type="button">Edit</button>
          </footer>
        `;
        card.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
            openEditor(job);
          } else if (!state.dragging) {
            openEditor(job);
          }
        });
        if (!state.readOnly) {
          card.addEventListener('dragstart', (e) => {
            state.dragging = job.id;
            e.dataTransfer.setData('text/plain', job.id);
            e.dataTransfer.effectAllowed = 'move';
          });
          card.addEventListener('dragend', () => {
            state.dragging = null;
          });
          card.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            card.classList.add('drag-target');
          });
          card.addEventListener('dragleave', () => card.classList.remove('drag-target'));
          card.addEventListener('drop', (e) => {
            e.preventDefault();
            card.classList.remove('drag-target');
            const jobId = e.dataTransfer.getData('text/plain') || state.dragging;
            if (!jobId || jobId === job.id) return;
            moveJob(jobId, job.sectionKey || 'general', job.id);
          });
        }
        return card;
      }

      function setupDropZone(column, key) {
        column.addEventListener('dragover', (e) => {
          if (state.readOnly) return;
          e.preventDefault();
          column.classList.add('drag-target');
        });
        column.addEventListener('dragleave', () => column.classList.remove('drag-target'));
        column.addEventListener('drop', (e) => {
          if (state.readOnly) return;
          e.preventDefault();
          column.classList.remove('drag-target');
          const jobId = e.dataTransfer.getData('text/plain') || state.dragging;
          if (!jobId) return;
          moveJob(jobId, key, null);
        });
      }

      function renderTagTokens() {
        if (!tagEditor) return;
        const tokens = tagEditor.querySelectorAll('.token');
        tokens.forEach((t) => t.remove());
        state.editingTags.forEach((tag, idx) => {
          const token = document.createElement('span');
          token.className = 'token';
          token.innerHTML = `${tag}<button type="button" aria-label="Remove ${tag}">×</button>`;
          token.querySelector('button').onclick = () => {
            state.editingTags.splice(idx, 1);
            renderTagTokens();
          };
          tagEditor.insertBefore(token, tagInput);
        });
      }

      function openDrawer() {
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
      }

      function closeDrawer() {
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden', 'true');
        setTimeout(() => {
          state.editing = null;
          state.editingTags = [];
          shareBox.style.display = 'none';
          shareUrl.value = '';
          shareMeta.textContent = '';
          if (shareBox?.dataset) {
            shareBox.dataset.local = '';
            shareBox.dataset.slug = '';
          }
          if (btnRefreshShare) btnRefreshShare.style.display = 'none';
        }, 150);
      }

      function fillForm(job) {
        form.id.value = job?.id || '';
        form.title.value = job?.title || '';
        form.status.value = (job?.status || 'live').toLowerCase();
        form.section.value = job?.sectionLabel || job?.section || '';
        form.discipline.value = job?.discipline || '';
        form.type.value = (job?.type || 'permanent').toLowerCase();
        form.locationText.value = job?.locationText || '';
        form.locationCode.value = job?.locationCode || '';
        form.overview.value = job?.overview || '';
        form.responsibilities.value = (job?.responsibilities || []).join('\n');
        form.requirements.value = (job?.requirements || []).join('\n');
        form.apply.value = job?.applyUrl || '';
        form.published.checked = !!job?.published;
        form.sortOrder.value = Number.isFinite(job?.sortOrder) ? job.sortOrder : '';
        state.editingTags = Array.isArray(job?.tags) ? [...job.tags] : [];
        renderTagTokens();
      }

      function openEditor(job) {
        state.editing = job ? { ...job } : null;
        drawerTitle.textContent = job?.title || 'New job';
        if (job?.__seed) {
          drawerMeta.textContent = 'Static import — save to sync with Supabase';
        } else {
          drawerMeta.textContent = job ? `Updated ${formatDate(job.updatedAt || job.createdAt)}` : 'Draft not yet saved';
        }
        fillForm(job);
        shareBox.style.display = 'none';
        shareUrl.value = '';
        shareMeta.textContent = '';
        if (shareBox?.dataset) {
          shareBox.dataset.local = '';
          shareBox.dataset.slug = '';
        }
        if (btnRefreshShare) btnRefreshShare.style.display = 'none';
        openDrawer();
      }

      function readForm() {
        return {
          id: form.id.value.trim() || undefined,
          title: form.title.value.trim(),
          status: form.status.value,
          section: form.section.value.trim(),
          discipline: form.discipline.value.trim(),
          type: form.type.value,
          locationText: form.locationText.value.trim(),
          locationCode: form.locationCode.value.trim(),
          overview: form.overview.value.trim(),
          responsibilities: form.responsibilities.value,
          requirements: form.requirements.value,
          applyUrl: form.apply.value.trim(),
          published: form.published.checked,
          sortOrder: form.sortOrder.value ? Number(form.sortOrder.value) : undefined,
          tags: [...state.editingTags],
        };
      }

      async function saveJob() {
        if (state.readOnly) {
          toast('Jobs are read-only until Supabase is configured.', 'warn', 3200);
          return;
        }
        try {
          const payload = readForm();
          const res = await api('admin-jobs-save', 'POST', { job: payload });
          const job = res?.job;
          if (job) {
            const hydrated = { ...job, ...normalizeJob(job) };
            const existing = state.jobs.find((j) => j.id === hydrated.id);
            if (existing) {
              Object.assign(existing, hydrated);
              delete existing.__seed;
            } else {
              state.jobs.push(hydrated);
            }
            buildSections();
            buildTags();
            renderAll();
            openEditor(hydrated);
            toast('Job saved', 'ok', 1800);
            state.seeded = state.jobs.some((j) => j.__seed);
            applySeedNotice();
          }
        } catch (e) {
          console.error('[jobs] save failed', e);
          toast('Save failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function deleteJob() {
        if (state.readOnly) {
          toast('Jobs are read-only until Supabase is configured.', 'warn', 3200);
          return;
        }
        if (!state.editing?.id) return;
        if (!confirm('Delete this job?')) return;
        try {
          await api('admin-jobs-delete', 'POST', { id: state.editing.id });
          state.jobs = state.jobs.filter((j) => j.id !== state.editing.id);
          buildSections();
          buildTags();
          renderAll();
          closeDrawer();
          toast('Job deleted', 'ok', 1800);
        } catch (e) {
          toast('Delete failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function shareJob(job) {
        const target = job && (job.id || job.title) ? job : state.editing || readForm();
        if (!target || !(target.id || target.title)) {
          toast('Select or save a job first', 'warn', 2400);
          return;
        }

        if (state.readOnly) {
          const existingSlug = shareBox?.dataset?.slug || null;
          const result = ensureLocalShare(target, { preferredSlug: existingSlug });
          if (!result || !result.entry) {
            toast('Local storage unavailable — unable to create a share link.', 'error', 3600);
            return;
          }
          const { entry, reused } = result;
          shareUrl.value = buildLocalShareUrl(entry.slug);
          const expiresText = formatShareDate(entry.expiresAt) || '';
          const createdText = entry.createdAt ? formatShareDate(entry.createdAt, true) : '';
          const lastUsedText = entry.lastAccessed ? formatShareDate(entry.lastAccessed, true) : '';
          const parts = ['Local preview'];
          if (reused && lastUsedText) {
            parts.push(`Last opened ${lastUsedText}`);
          } else if (!reused && createdText) {
            parts.push(`Created ${createdText}`);
          }
          if (expiresText) parts.push(`Expires ${expiresText}`);
          shareMeta.textContent = parts.join(' · ');
          shareBox.style.display = '';
          if (shareBox?.dataset) {
            shareBox.dataset.local = '1';
            shareBox.dataset.slug = entry.slug;
          }
          if (btnRefreshShare) btnRefreshShare.style.display = '';
          toast(reused ? 'Share link ready (local cache)' : 'Share link created (local cache)', 'info', 2400);
          return;
        }

        if (target?.__seed) {
          toast('Save this job to Supabase before generating a share link.', 'warn', 3200);
          return;
        }

        if (!target?.id) {
          toast('Save the job before generating a share link', 'warn', 2600);
          return;
        }
        try {
          const res = await api('admin-job-share-create', 'POST', {
            jobId: target.id,
            jobPayload: buildSharePayload(target),
          });
          const fallback = !!res?.fallback;
          const schemaMismatch = !!res?.schema;
          if (fallback) {
            shareMeta.textContent = schemaMismatch
              ? 'Schema mismatch detected — serving static share link'
              : 'Direct job link · No expiry (static fallback)';
          } else {
            shareMeta.textContent = `Slug ${res.slug} · Expires ${res.expires_at || 'never'}`;
          }
          shareUrl.value = res.url || '';
          shareBox.style.display = '';
          if (shareBox?.dataset) {
            shareBox.dataset.local = '';
            shareBox.dataset.slug = '';
          }
          if (btnRefreshShare) btnRefreshShare.style.display = 'none';
          toast(
            fallback
              ? (schemaMismatch ? 'Share link ready (schema fallback)' : 'Share link created (static fallback)')
              : 'Share link created',
            'ok',
            2000
          );
        } catch (e) {
          toast('Share failed: ' + (e.message || e), 'error', 4200);
        }
      }

      function refreshLocalShare() {
        const target = state.editing || readForm();
        if (!target || !(target.id || target.title)) {
          toast('Select or save a job first', 'warn', 2400);
          return;
        }
        const existingSlug = shareBox?.dataset?.slug || null;
        const result = ensureLocalShare(target, { forceRefresh: true, preferredSlug: existingSlug });
        if (!result || !result.entry) {
          toast('Local storage unavailable — unable to refresh the share link.', 'error', 3600);
          return;
        }
        const { entry } = result;
        shareUrl.value = buildLocalShareUrl(entry.slug);
        const expiresText = formatShareDate(entry.expiresAt) || '';
        const refreshedText = entry.updatedAt ? formatShareDate(entry.updatedAt, true) : '';
        const parts = ['Local preview'];
        if (refreshedText) parts.push(`Refreshed ${refreshedText}`);
        if (expiresText) parts.push(`Expires ${expiresText}`);
        shareMeta.textContent = parts.join(' · ');
        if (shareBox?.dataset) {
          shareBox.dataset.local = '1';
          shareBox.dataset.slug = entry.slug;
        }
        if (btnRefreshShare) btnRefreshShare.style.display = '';
        toast('Local share refreshed', 'ok', 2000);
      }

      async function loadJobsFromStatic(reason) {
        try {
          const res = await fetch('/data/jobs.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          const rows = Array.isArray(json?.jobs) ? json.jobs : [];
          if (!rows.length) return false;
          state.jobs = rows.map((row) => ({ ...normalizeJob(row), __seed: true }));
          state.readOnly = true;
          state.fallbackSource = reason || 'static';
          state.seeded = true;
          applySeedNotice();
          applyReadOnly();
          buildSections();
          buildTags();
          renderAll();
          return true;
        } catch (err) {
          console.error('[jobs] static fallback failed', err);
          return false;
        }
      }

      async function loadJobs() {
        try {
          const res = await api('admin-jobs-list', 'POST', { includeDrafts: true });
          const rawJobs = Array.isArray(res?.jobs) ? res.jobs : [];
          state.jobs = rawJobs.map((job) => {
            const normalized = normalizeJob(job);
            const merged = { ...job, ...normalized };
            if (job && job.__seed) merged.__seed = job.__seed;
            return merged;
          });
          state.readOnly = !!res?.readOnly;
          state.fallbackSource = res?.source || '';
          state.seeded = !!res?.seeded && state.jobs.length > 0;
          state.schemaMismatch = !!res?.schema;
          applySeedNotice();
          if (state.seeded) {
            toast('Static jobs loaded — save them to sync with Supabase.', 'info', 2800);
          }
          applyReadOnly();
          if (state.readOnly) {
            const schemaWarning = res?.schema
              ? 'Jobs table schema mismatch detected — displaying read-only preview data.'
              : null;
            const message = schemaWarning || res?.error || res?.warning;
            if (message) {
              toast(message, 'warn', 3600);
            }
          }
          buildSections();
          buildTags();
          renderAll();
        } catch (e) {
          console.error('[jobs] load failed', e);
          const fallbackOk = await loadJobsFromStatic('static-client');
          if (fallbackOk) {
            toast('Supabase unavailable — showing static jobs (read-only).', 'warn', 3800);
          } else {
            toast('Load failed: ' + (e.message || e), 'error', 4200);
          }
        }
      }

      function renderAll() {
        renderTagChips();
        renderBoard();
      }

      function addSection(label) {
        if (state.readOnly) {
          toast('Jobs are read-only until Supabase is configured.', 'warn', 3200);
          return;
        }
        const clean = label.trim();
        if (!clean) return;
        const key = slugify(clean) || `section-${Date.now().toString(36)}`;
        if (!state.sectionOrder.find((s) => s.key === key)) {
          state.sectionOrder.push({ key, label: clean });
          state.sectionOrder.sort((a, b) => a.label.localeCompare(b.label));
          updateSectionSelect();
          toast(`Category “${clean}” ready`, 'info', 1800);
        }
      }

      // ---- Event wires ----
      sel('#btnRefresh').onclick = loadJobs;
      sel('#btnNew').onclick = () => {
        if (state.readOnly) { toast('Jobs are read-only until Supabase is configured.', 'warn', 3200); return; }
        openEditor(null);
      };
      sel('#btnClose').onclick = closeDrawer;
      sel('#btnSave').onclick = (e) => { e.preventDefault(); saveJob(); };
      sel('#btnDelete').onclick = (e) => { e.preventDefault(); deleteJob(); };
      sel('#btnShare').onclick = (e) => { e.preventDefault(); shareJob(state.editing || readForm()); };
      sel('#btnCopyShare').onclick = (e) => {
        e.preventDefault();
        if (!shareUrl.value) return;
        if (navigator.clipboard?.writeText) {
          navigator.clipboard
            .writeText(shareUrl.value)
            .then(() => toast('Copied', 'ok', 1200))
            .catch(() => toast('Copy failed', 'error', 2200));
          return;
        }
        try {
          shareUrl.select();
          const ok = document.execCommand('copy');
          toast(ok ? 'Copied' : 'Copy failed', ok ? 'ok' : 'error', ok ? 1200 : 2200);
        } catch (err) {
          toast('Copy failed', 'error', 2200);
        } finally {
          shareUrl.blur();
        }
      };
      if (btnRefreshShare) {
        btnRefreshShare.onclick = (e) => {
          e.preventDefault();
          refreshLocalShare();
        };
      }
      sel('#clearFilters').onclick = () => {
        state.filters = { q:'', status:'all', type:'all', published:'all', section:'all', tags:new Set() };
        filterSearch.value = '';
        filterStatus.value = 'all';
        filterType.value = 'all';
        filterPublished.value = 'all';
        filterSection.value = 'all';
        renderAll();
      };

      filterStatus.onchange = () => { state.filters.status = filterStatus.value; renderAll(); };
      filterType.onchange = () => { state.filters.type = filterType.value; renderAll(); };
      filterPublished.onchange = () => { state.filters.published = filterPublished.value; renderAll(); };
      filterSection.onchange = () => { state.filters.section = filterSection.value; renderAll(); };
      filterSearch.addEventListener('input', () => { state.filters.q = filterSearch.value.trim().toLowerCase(); renderAll(); });

      addSectionForm.onsubmit = (e) => {
        e.preventDefault();
        addSection(newSectionInput.value || '');
        newSectionInput.value = '';
        updateSectionSelect();
      };

      tagInput.addEventListener('keydown', (e) => {
        if (state.readOnly) { e.preventDefault(); toast('Jobs are read-only until Supabase is configured.', 'warn', 3200); return; }
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const value = tagInput.value.trim();
          if (value && !state.editingTags.includes(value)) {
            state.editingTags.push(value);
            renderTagTokens();
          }
          tagInput.value = '';
        } else if (e.key === 'Backspace' && !tagInput.value && state.editingTags.length) {
          state.editingTags.pop();
          renderTagTokens();
        }
      });

      btnDiag.onclick = async () => {
        state.diagnostics = !state.diagnostics;
        btnDiag.textContent = state.diagnostics ? '◎' : '◉';
        if (state.diagnostics) {
          const who = await identity('admin');
          toast(`Trace active. User ${who.email || 'n/a'}`, 'info', 2600);
        }
      };

      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          if (drawer.classList.contains('open')) saveJob();
        }
        if (e.key === 'Escape' && drawer.classList.contains('open')) {
          e.preventDefault();
          closeDrawer();
        }
      });

      applyReadOnly();
      await loadJobs();
    });
  })();
  </script>
</body>
</html>
