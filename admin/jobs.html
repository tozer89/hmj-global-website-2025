<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jobs — Admin | HMJ-Global</title>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="/admin/common.js"></script>
<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{--bg:#0b101d;--panel:#111b2c;--border:#1f2a3f;--accent:#4c7bff;--text:#e6f0ff;--muted:#9fb1ce;--chip:#18253d}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  a{color:inherit}
  .top{position:sticky;top:0;z-index:20;background:#0d1525;border-bottom:1px solid rgba(255,255,255,.06)}
  .row{max-width:1280px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
  .brand{font-weight:800;font-size:18px}
  .sp{flex:1}
  .btn{background:#172641;border:1px solid rgba(255,255,255,.12);color:#fff;padding:9px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:border-color .2s,transform .1s,box-shadow .2s}
  .btn:hover{border-color:rgba(255,255,255,.3);transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,0,0,.25)}
  .btn.secondary{background:#0f172a}
  .btn.ghost{background:transparent;border-color:rgba(76,123,255,.4);color:#9fb9ff}
  .btn.danger{background:#2b1216;border-color:#6f1d26}
  .wrap{max-width:1280px;margin:28px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 18px 38px rgba(0,0,0,.25)}
  .muted{color:var(--muted)}
  input,select,textarea{width:100%;box-sizing:border-box;background:#0f172a;color:#e6f0ff;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:11px 12px;font-size:14px;font-family:inherit}
  input:focus,select:focus,textarea:focus{outline:2px solid rgba(76,123,255,.55);border-color:rgba(76,123,255,.35)}
  label{display:grid;gap:6px;font-weight:600;font-size:13px;color:var(--muted)}
  textarea{min-height:120px;resize:vertical}
  .layout{display:grid;grid-template-columns: minmax(260px, 360px) minmax(340px, 1fr);gap:16px;align-items:start}
  @media(max-width:1100px){.layout{grid-template-columns:1fr}}
  .job-list{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto;padding-right:6px}
  .job-item{border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px 14px;display:grid;gap:4px;background:#101b30;cursor:pointer;transition:border-color .2s,background .2s,transform .1s}
  .job-item:hover{border-color:rgba(76,123,255,.35)}
  .job-item.active{border-color:var(--accent);background:rgba(76,123,255,.12)}
  .job-item h4{margin:0;font-size:15px;color:#f5f8ff}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.12)}
  .pill.live{background:rgba(33,158,72,.18);color:#6ce89f;border-color:rgba(33,158,72,.45)}
  .pill.interviewing{background:rgba(255,193,7,.18);color:#ffe28c;border-color:rgba(255,193,7,.35)}
  .pill.closed{background:rgba(221,90,90,.18);color:#f7b1b1;border-color:rgba(221,90,90,.35)}
  .subline{font-size:12px;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap}
  .filter-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .filter-row input{max-width:220px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);padding:7px 12px;border-radius:999px;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer}
  .chip.active{background:rgba(76,123,255,.2);color:#d6e3ff;border-color:rgba(76,123,255,.55)}
  .editor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .editor-wide{display:grid;gap:14px;margin-top:18px}
  .editor-actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;margin-top:20px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:10px;font-size:12px;background:rgba(255,255,255,.08);color:var(--muted)}
  .split{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .checkbox{display:flex;align-items:center;gap:8px;font-weight:600;color:var(--muted)}
  .checkbox input{width:auto}
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Jobs — Admin</div><div class="sp"></div>
  <a class="btn ghost" href="/admin/">⟵ Admin home</a>
  <button class="btn secondary" onclick="netlifyIdentity?.logout()">Sign out</button>
</div></div>

<div class="wrap" id="gate" style="display:none">
  <div class="card"><strong>Admin only.</strong> <p class="why muted"></p>
  <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button></div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="card">
    <div class="filter-row">
      <input id="search" type="search" placeholder="Search title, location, keywords" aria-label="Search jobs"/>
      <select id="sectionFilter" aria-label="Filter by section">
        <option value="all">All sections</option>
        <option value="commercial">Commercial</option>
        <option value="dc">Data Centre Delivery</option>
        <option value="substations">Substations & Energy</option>
        <option value="pharma">Life Sciences & Pharma</option>
        <option value="ict">ICT & Commissioning</option>
      </select>
      <select id="statusFilter" aria-label="Filter by status">
        <option value="all">Any status</option>
        <option value="live">Live</option>
        <option value="interviewing">Interviewing</option>
        <option value="closed">Closed</option>
      </select>
      <div class="sp"></div>
      <button class="btn ghost" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnNew">＋ New job</button>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 style="margin:0;font-size:16px">Board</h3>
        <span class="badge" id="countBadge">0 jobs</span>
      </div>
      <div class="job-list" id="jobList"></div>
    </div>

    <div class="card" id="editor" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div>
          <h3 style="margin:0 0 4px" id="edTitle">Job</h3>
          <div class="muted" id="edMeta"></div>
        </div>
        <label class="checkbox"><input type="checkbox" id="edPublished"/> Published</label>
      </div>

      <form id="jobForm">
        <div class="editor-grid" style="margin-top:16px">
          <label>Job ID (slug)<input id="edId" placeholder="auto-generated if blank"/></label>
          <label>Title<input id="edTitleInput" required/></label>
          <label>Status
            <select id="edStatus">
              <option value="live">Live</option>
              <option value="interviewing">Interviewing</option>
              <option value="closed">Closed</option>
            </select>
          </label>
          <label>Section
            <select id="edSection">
              <option value="commercial">Commercial</option>
              <option value="dc">Data Centre Delivery</option>
              <option value="substations">Substations & Energy</option>
              <option value="pharma">Life Sciences & Pharma</option>
              <option value="ict">ICT & Commissioning</option>
            </select>
          </label>
          <label>Discipline<input id="edDiscipline" placeholder="e.g. Data Centre"/></label>
          <label>Employment type
            <select id="edType">
              <option value="permanent">Permanent</option>
              <option value="contract">Contract</option>
              <option value="fixed-term">Fixed term</option>
            </select>
          </label>
          <label>Location text<input id="edLocationText" placeholder="e.g. London, UK"/></label>
          <label>Location code<input id="edLocationCode" placeholder="slug for filters"/></label>
          <label>Sort order<input id="edSortOrder" type="number" min="0" step="1"/></label>
          <label>Apply URL<input id="edApply" placeholder="Defaults to contact form"/></label>
          <label>Keywords<textarea id="edKeywords" placeholder="Comma separated keywords" style="min-height:90px"></textarea></label>
        </div>

        <div class="editor-wide">
          <label>Overview<textarea id="edOverview" placeholder="Short overview shown in card"></textarea></label>
          <div class="split">
            <label>Responsibilities (one per line)<textarea id="edResponsibilities"></textarea></label>
            <label>Requirements (one per line)<textarea id="edRequirements"></textarea></label>
          </div>
        </div>

        <div class="editor-actions">
          <button type="button" class="btn danger" id="btnDelete">Delete</button>
          <button type="button" class="btn ghost" id="btnClose">Close</button>
          <button type="submit" class="btn">Save job</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
Admin.bootAdmin(async ({ api, sel, toast }) => {
  const jobList = sel('#jobList');
  const countBadge = sel('#countBadge');
  const editor = sel('#editor');
  const form = sel('#jobForm');
  const statusFilter = sel('#statusFilter');
  const sectionFilter = sel('#sectionFilter');
  const searchInput = sel('#search');
  const publishedInput = sel('#edPublished');

  const SECTION_LABELS = {
    commercial: 'Commercial',
    dc: 'Data Centre Delivery',
    substations: 'Substations & Energy',
    pharma: 'Life Sciences & Pharma',
    ict: 'ICT & Commissioning'
  };

  const STATUS_CLASS = { live: 'live', interviewing: 'interviewing', closed: 'closed' };

  let jobs = [];
  let filtered = [];
  let current = null;

  function renderList() {
    const q = (searchInput.value || '').trim().toLowerCase();
    const section = sectionFilter.value;
    const status = statusFilter.value;

    filtered = jobs.filter(job => {
      if (section !== 'all' && job.section !== section) return false;
      if (status !== 'all' && job.status !== status) return false;
      if (!q) return true;
      const hay = [job.title, job.locationText, job.locationCode, job.keywords, job.discipline];
      return hay.some(v => String(v || '').toLowerCase().includes(q));
    });

    countBadge.textContent = `${filtered.length} job${filtered.length === 1 ? '' : 's'}`;

    jobList.innerHTML = filtered.map(job => {
      const active = current && current.id === job.id ? 'active' : '';
      return `
        <div class="job-item ${active}" data-id="${job.id}">
          <h4>${job.title || 'Untitled role'}</h4>
          <div class="subline">
            <span>${SECTION_LABELS[job.section] || job.section || 'Unsectioned'}</span>
            ${job.locationText ? `<span>${job.locationText}</span>` : ''}
          </div>
          <div class="subline">
            <span class="pill ${STATUS_CLASS[job.status] || 'live'}">${job.status || 'live'}</span>
            ${job.published ? '<span class="pill" style="background:rgba(76,123,255,.16);border-color:rgba(76,123,255,.4);color:#d6e3ff">Published</span>' : '<span class="pill" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12);color:#aab8d6">Draft</span>'}
            ${Number.isFinite(job.sortOrder) ? `<span>#${job.sortOrder}</span>` : ''}
          </div>
        </div>`;
    }).join('');

    jobList.querySelectorAll('.job-item').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.dataset.id;
        const job = jobs.find(j => j.id === id);
        if (job) openJob(job.id);
      });
    });
  }

  function joinList(list) {
    return Array.isArray(list) ? list.join('\n') : '';
  }

  function fillForm(job) {
    current = job;
    sel('#edTitle').textContent = job.title || 'Job';
    sel('#edMeta').textContent = job.updatedAt ? `Updated ${new Date(job.updatedAt).toLocaleString()}` : '';
    sel('#edId').value = job.id || '';
    sel('#edTitleInput').value = job.title || '';
    sel('#edStatus').value = job.status || 'live';
    sel('#edSection').value = job.section || 'dc';
    sel('#edDiscipline').value = job.discipline || '';
    sel('#edType').value = job.type || 'permanent';
    sel('#edLocationText').value = job.locationText || '';
    sel('#edLocationCode').value = job.locationCode || '';
    sel('#edSortOrder').value = Number.isFinite(job.sortOrder) ? job.sortOrder : '';
    sel('#edApply').value = job.applyUrl || '';
    sel('#edKeywords').value = job.keywords || '';
    sel('#edOverview').value = job.overview || '';
    sel('#edResponsibilities').value = joinList(job.responsibilities);
    sel('#edRequirements').value = joinList(job.requirements);
    publishedInput.checked = !!job.published;
    editor.style.display = 'block';
  }

  function readForm() {
    return {
      id: sel('#edId').value.trim() || undefined,
      title: sel('#edTitleInput').value.trim(),
      status: sel('#edStatus').value,
      section: sel('#edSection').value,
      discipline: sel('#edDiscipline').value.trim(),
      type: sel('#edType').value,
      locationText: sel('#edLocationText').value.trim(),
      locationCode: sel('#edLocationCode').value.trim(),
      sortOrder: sel('#edSortOrder').value === '' ? null : Number(sel('#edSortOrder').value),
      applyUrl: sel('#edApply').value.trim(),
      keywords: sel('#edKeywords').value.trim(),
      overview: sel('#edOverview').value.trim(),
      responsibilities: sel('#edResponsibilities').value.split('\n').map(v => v.trim()).filter(Boolean),
      requirements: sel('#edRequirements').value.split('\n').map(v => v.trim()).filter(Boolean),
      published: publishedInput.checked,
    };
  }

  async function loadJobs() {
    jobList.innerHTML = '<div class="muted">Loading…</div>';
    try {
      const res = await api('/admin-jobs-list', 'POST', {});
      jobs = Array.isArray(res.jobs) ? res.jobs : [];
    } catch (e) {
      jobs = [];
      toast('Failed to load jobs: ' + e.message, 'error');
    }
    renderList();
  }

  async function openJob(id) {
    try {
      const res = await api('/admin-jobs-get', 'POST', { id });
      if (res && res.job) {
        fillForm(res.job);
        renderList();
      }
    } catch (e) {
      toast('Unable to open job: ' + e.message, 'error');
    }
  }

  function newJob() {
    const job = {
      id: '',
      title: '',
      status: 'live',
      section: sectionFilter.value !== 'all' ? sectionFilter.value : 'dc',
      discipline: '',
      type: 'permanent',
      locationText: '',
      locationCode: '',
      sortOrder: jobs.length ? Math.max(...jobs.map(j => j.sortOrder || 0)) + 10 : 1000,
      applyUrl: '',
      keywords: '',
      overview: '',
      responsibilities: [],
      requirements: [],
      published: false,
    };
    fillForm(job);
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = readForm();
    if (!payload.title) {
      toast('Title is required', 'warn');
      return;
    }
    const originalId = current?.id || null;
    try {
      const res = await api('/admin-jobs-save', 'POST', { job: payload });
      if (res && res.job) {
        toast('Job saved', 'info');
        if (originalId && originalId !== res.job.id) {
          try { await api('/admin-jobs-delete', 'POST', { id: originalId }); }
          catch (err) { console.warn('Failed to remove old job id', err); }
          jobs = jobs.filter(j => j.id !== originalId);
        }
        const idx = jobs.findIndex(j => j.id === res.job.id);
        if (idx >= 0) jobs[idx] = res.job; else jobs.push(res.job);
        jobs.sort((a,b) => {
          if (a.section !== b.section) return (a.section || '').localeCompare(b.section || '');
          const ao = Number.isFinite(a.sortOrder) ? a.sortOrder : 0;
          const bo = Number.isFinite(b.sortOrder) ? b.sortOrder : 0;
          if (ao !== bo) return ao - bo;
          return (a.title || '').localeCompare(b.title || '');
        });
        fillForm(res.job);
        renderList();
      }
    } catch (e) {
      toast('Save failed: ' + e.message, 'error');
    }
  });

  sel('#btnDelete').addEventListener('click', async () => {
    if (!current || !current.id) {
      editor.style.display = 'none';
      return;
    }
    if (!confirm('Delete this job?')) return;
    try {
      await api('/admin-jobs-delete', 'POST', { id: current.id });
      toast('Job deleted', 'info');
      jobs = jobs.filter(j => j.id !== current.id);
      current = null;
      editor.style.display = 'none';
      renderList();
    } catch (e) {
      toast('Delete failed: ' + e.message, 'error');
    }
  });

  sel('#btnClose').addEventListener('click', () => {
    editor.style.display = 'none';
    current = null;
    jobList.querySelectorAll('.job-item').forEach(el => el.classList.remove('active'));
  });

  sel('#btnNew').addEventListener('click', () => {
    newJob();
    renderList();
  });

  sel('#btnRefresh').addEventListener('click', loadJobs);
  searchInput.addEventListener('input', renderList);
  sectionFilter.addEventListener('change', () => {
    renderList();
    if (!current) return;
    if (sectionFilter.value !== 'all' && current.section !== sectionFilter.value) {
      editor.style.display = 'none';
      current = null;
    }
  });
  statusFilter.addEventListener('change', renderList);

  await loadJobs();
});
</script>
</body>
</html>
