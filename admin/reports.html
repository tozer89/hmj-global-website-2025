<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reports — Admin | HMJ Global</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script defer src="../js/identity-loader.js"></script>
  <script defer src="/admin/common.js"></script>
  <style>
    :root {
      --bg:#0b0f18; --panel:#111b2e; --border:#25324a; --ink:#e6eefc; --muted:#96a8c4;
      --accent:#4f7fff; --accent-soft:rgba(79,127,255,.12); --good:#1f9d63; --warn:#f0ad3d; --bad:#d9534f;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;background:#0c1526;border-bottom:1px solid rgba(255,255,255,.08);z-index:40}
    .row{max-width:1280px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;font-size:1.15rem}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--accent-soft);border:1px solid rgba(79,127,255,.3);font-weight:700}
    .sp{flex:1}
    .btn{background:var(--accent);border:0;color:#fff;font-weight:700;padding:9px 14px;border-radius:12px;cursor:pointer;transition:background .18s}
    .btn:hover{background:#3c6fff}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:#e6eefc}
    .btn.small{padding:7px 12px;border-radius:10px;font-size:0.9rem}
    .wrap{max-width:1280px;margin:24px auto;padding:0 18px;display:grid;gap:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 20px 40px rgba(5,10,25,.35)}
    .panel.light{background:#13213b}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px}
    .metric{background:#162640;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:6px}
    .metric strong{font-size:1.4rem}
    .metric span{color:var(--muted);font-size:.85rem}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .filters input,.filters select{background:#0f1d33;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px;font-weight:600}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{font-size:.82rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    tbody tr:hover{background:rgba(79,127,255,.08)}
    .grid{display:grid;grid-template-columns:1.7fr 1fr;gap:18px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .list{display:grid;gap:10px}
    .list-item{background:#162640;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:4px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(79,127,255,.14);border:1px solid rgba(79,127,255,.3);font-size:.75rem;font-weight:700}
    .muted{color:var(--muted)}
    .notice{margin-top:12px;padding:12px;border-radius:14px;background:rgba(79,127,255,.12);border:1px solid rgba(79,127,255,.25);font-weight:600}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:#162640;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .notes{width:100%;min-height:140px;background:#0f1d33;color:var(--ink);border:1px solid var(--border);border-radius:14px;padding:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#0f1d33;border:1px solid rgba(255,255,255,.16);color:var(--ink);padding:6px 10px;border-radius:999px;font-size:.8rem;font-weight:700}
    .lead{text-transform:uppercase;letter-spacing:.12em;font-size:.75rem;color:var(--muted)}
    .table-scroll{overflow:auto;max-height:420px}
    .small-btns{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="top">
    <div class="row">
      <div class="brand">Reports Console</div>
      <span class="pill">Analytics</span>
      <div class="sp"></div>
      <div id="diagChips" class="chips"></div>
      <a class="btn ghost small" href="/">Website</a>
      <a class="btn ghost small" href="/admin/">⟵ Dashboard</a>
      <button class="btn small" onclick="window.netlifyIdentity?.logout()">Sign out</button>
    </div>
  </div>

  <div class="wrap" id="gate" style="display:none">
    <div class="panel">
      <h2>Admin only</h2>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <section class="panel">
      <div class="filters" id="filterBar">
        <input id="filterFrom" type="date" aria-label="From week ending" />
        <input id="filterTo" type="date" aria-label="To week ending" />
        <select id="filterStatus">
          <option value="">All statuses</option>
          <option value="approved">Approved</option>
          <option value="submitted">Submitted</option>
          <option value="draft">Draft</option>
        </select>
        <select id="filterCurrency">
          <option value="">All currencies</option>
          <option value="GBP">GBP</option>
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>
        <button class="btn small" id="btnRun">Run report</button>
        <button class="btn ghost small" id="btnCsv">Download CSV</button>
        <div class="sp"></div>
        <span class="muted" id="sourceMeta"></span>
      </div>
      <div class="metrics" id="metricCards"></div>
      <div class="notice" id="weekNotice">Week 1 ends 2 Nov 2025 · adjust below if your fiscal year changes.</div>
    </section>

    <section class="panel light" id="configPanel">
      <h3 style="margin:0 0 12px">Week numbering &amp; deadlines</h3>
      <p class="muted" style="margin:0 0 14px">Week numbers drive payroll and reporting views. Update the fiscal Week&nbsp;1 end date or adjust the public submission deadline message for the contractor portal.</p>
      <div class="small-btns" style="align-items:flex-end;flex-wrap:wrap">
        <label class="lead">Week&nbsp;1 ending
          <input id="weekBaseInput" type="date" style="margin-top:6px" />
        </label>
        <label class="lead" style="flex:1;min-width:220px">Deadline message
          <textarea id="deadlineInput" rows="2" style="margin-top:6px;width:100%;min-height:64px" placeholder="e.g. Submit timesheets by Monday 10:00 UK time"></textarea>
        </label>
        <label class="lead">Timezone
          <select id="deadlineTz" style="margin-top:6px">
            <option value="Europe/London">Europe/London (UK)</option>
            <option value="Europe/Dublin">Europe/Dublin (IE)</option>
            <option value="Europe/Amsterdam">Europe/Amsterdam (NL)</option>
            <option value="UTC">UTC</option>
          </select>
        </label>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn small" id="btnSaveWeek">Save configuration</button>
          <button class="btn ghost small" id="btnReloadWeek">Reload default</button>
        </div>
        <span class="muted" id="weekSaveMeta"></span>
      </div>
    </section>

    <section class="panel" id="reconcilePanel">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
        <h3 style="margin:0">Data reconciliation</h3>
        <span class="pill" id="reconBadge">Checking…</span>
        <div class="sp"></div>
        <button class="btn ghost small" id="btnReconRefresh">Refresh</button>
      </div>
      <p class="muted" style="margin-top:0">Compare Supabase tables with the bundled preview datasets so you can spot when deploy previews are using fallback data.</p>
      <div class="table-scroll" style="max-height:260px">
        <table>
          <thead><tr><th>Dataset</th><th>Supabase</th><th>Fallback</th><th>Delta</th><th>Notes</th></tr></thead>
          <tbody id="reconBody"><tr><td colspan="5" class="muted">Loading reconciliation…</td></tr></tbody>
        </table>
      </div>
      <div class="notice" id="reconNotice" style="display:none"></div>
      <div class="small-btns" style="margin-top:12px">
        <a class="btn ghost small" href="/admin/jobs.html">Review jobs board</a>
        <a class="btn ghost small" href="/admin/candidates.html">Open candidates</a>
        <a class="btn ghost small" href="/admin/payroll.html">Payroll console</a>
        <button class="btn ghost small" id="btnReconCopy" type="button">Copy summary</button>
      </div>
    </section>

    <div class="grid">
      <section class="panel" id="tablePanel">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <h3 style="margin:0">Gross margin by timesheet</h3>
          <span class="pill" id="rowCount">0 rows</span>
          <div class="sp"></div>
          <button class="btn ghost small" id="btnToggleEmpty">Hide £0 rows</button>
        </div>
        <div class="table-scroll">
          <table id="reportTable">
            <thead>
              <tr>
                <th>Week</th>
                <th>#</th>
                <th>Candidate</th>
                <th>Client</th>
                <th>Assignment</th>
                <th>Hours</th>
                <th>Pay</th>
                <th>Charge</th>
                <th>Margin</th>
                <th>Currency</th>
              </tr>
            </thead>
            <tbody id="reportBody"><tr><td colspan="10" class="muted">Run the report to populate data.</td></tr></tbody>
          </table>
        </div>
      </section>

      <aside class="panel" id="leaderboardPanel">
        <h3 style="margin:0 0 12px">Top contractors by margin</h3>
        <div class="list" id="contractorList"></div>
        <h3 style="margin:18px 0 12px">Currency mix</h3>
        <div class="list" id="currencyList"></div>
      </aside>
    </div>

    <section class="panel" id="trendPanel">
      <h3 style="margin:0 0 12px">Weekly gross margin trend</h3>
      <div class="table-scroll">
        <table>
          <thead>
            <tr><th>Week #</th><th>Week ending</th><th>Timesheets</th><th>Pay</th><th>Charge</th><th>Margin</th></tr>
          </thead>
          <tbody id="trendBody"><tr><td colspan="6" class="muted">No data yet.</td></tr></tbody>
        </table>
      </div>
    </section>

    <section class="panel" id="actionsPanel">
      <h3 style="margin:0 0 12px">Operations & quick actions</h3>
      <div class="cards">
        <div class="card">
          <span class="lead">Assignments health</span>
          <p class="muted" id="assignmentsSummary">—</p>
          <a class="btn ghost small" href="/admin/assignments.html">Open assignments</a>
        </div>
        <div class="card">
          <span class="lead">Payroll queue</span>
          <p class="muted" id="payrollSummary">—</p>
          <a class="btn ghost small" href="/admin/payroll.html">Manage payroll</a>
        </div>
        <div class="card">
          <span class="lead">Timesheet approvals</span>
          <p class="muted" id="timesheetSummary">—</p>
          <a class="btn ghost small" href="/admin/timesheets.html">Review timesheets</a>
        </div>
        <div class="card">
          <span class="lead">Jobs performance</span>
          <p class="muted">Keep live roles refreshed for accurate reporting.</p>
          <a class="btn ghost small" href="/admin/jobs.html">Open jobs board</a>
        </div>
        <div class="card">
          <span class="lead">Client coverage</span>
          <p class="muted" id="clientSummary">—</p>
          <a class="btn ghost small" href="/admin/clients.html">Client directory</a>
        </div>
        <div class="card">
          <span class="lead">Candidate pipeline</span>
          <p class="muted">Use the candidates console to parse CVs and send emails directly.</p>
          <a class="btn ghost small" href="/admin/candidates.html">Candidates</a>
        </div>
        <div class="card">
          <span class="lead">Audit trail</span>
          <p class="muted">Recent payroll actions logged below. Export full history as needed.</p>
          <button class="btn ghost small" id="btnRefreshAudit">Refresh audit</button>
        </div>
        <div class="card">
          <span class="lead">Report CSV</span>
          <p class="muted">Download the current table including week numbers & currency totals.</p>
          <button class="btn ghost small" id="btnDownloadCsv">Download CSV</button>
        </div>
        <div class="card">
          <span class="lead">Notes board</span>
          <textarea id="notesBoard" class="notes" placeholder="Leave handover notes for the team…"></textarea>
          <button class="btn ghost small" id="btnSaveNotes">Save notes</button>
        </div>
        <div class="card">
          <span class="lead">Back office</span>
          <p class="muted">Track miscellaneous admin actions such as invoicing cycles or FX updates.</p>
          <div class="chips" id="miscChips"></div>
        </div>
      </div>
    </section>

    <section class="panel" id="auditPanel">
      <h3 style="margin:0 0 12px">Latest audit events</h3>
      <div class="table-scroll">
        <table>
          <thead><tr><th>When</th><th>Actor</th><th>Action</th><th>Entity</th><th>Details</th></tr></thead>
          <tbody id="auditBody"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const start = () => {
        window.Admin.bootAdmin(async ({ api, sel, toast, getTrace }) => {
          const chips = sel('#diagChips');
          const chip = (text, tone='ok') => {
            if (!chips) return;
            const span = document.createElement('span');
            span.className = 'chip';
            if (tone === 'warn') span.style.borderColor = 'rgba(240,173,61,.7)';
            if (tone === 'bad') span.style.borderColor = 'rgba(217,83,79,.7)';
            span.textContent = text;
            chips.appendChild(span);
          };

          const DEFAULTS = {
            week1Ending: '2025-11-02',
            deadlineNote: 'Submit approved timesheets by Monday 10:00 (UK time) to guarantee payroll.',
            deadlineTimezone: 'Europe/London',
          };

          const state = {
            rows: [],
            summary: { currencies: {}, contractors: [], weeks: {} },
            filters: { hideZero: false },
            config: { ...DEFAULTS },
            source: 'api',
            reconciliation: { datasets: [], fallback: false, error: null, generatedAt: null },
          };

          const filterFrom = sel('#filterFrom');
          const filterTo = sel('#filterTo');
          const filterStatus = sel('#filterStatus');
          const filterCurrency = sel('#filterCurrency');
          const btnRun = sel('#btnRun');
          const btnCsv = sel('#btnCsv');
          const btnDownloadCsv = sel('#btnDownloadCsv');
          const btnToggleEmpty = sel('#btnToggleEmpty');
          const tableBody = sel('#reportBody');
          const rowCount = sel('#rowCount');
          const metricCards = sel('#metricCards');
          const currencyList = sel('#currencyList');
          const contractorList = sel('#contractorList');
          const trendBody = sel('#trendBody');
          const sourceMeta = sel('#sourceMeta');
          const weekNotice = sel('#weekNotice');
          const weekBaseInput = sel('#weekBaseInput');
          const deadlineInput = sel('#deadlineInput');
          const deadlineTz = sel('#deadlineTz');
          const weekBaseMeta = sel('#weekSaveMeta');
          const btnSaveWeek = sel('#btnSaveWeek');
          const btnReloadWeek = sel('#btnReloadWeek');
          const notesBoard = sel('#notesBoard');
          const btnSaveNotes = sel('#btnSaveNotes');
          const miscChips = sel('#miscChips');
          const auditBody = sel('#auditBody');
          const btnRefreshAudit = sel('#btnRefreshAudit');
          const assignmentsSummary = sel('#assignmentsSummary');
          const payrollSummary = sel('#payrollSummary');
          const timesheetSummary = sel('#timesheetSummary');
          const clientSummary = sel('#clientSummary');
          const reconBody = sel('#reconBody');
          const reconBadge = sel('#reconBadge');
          const reconNotice = sel('#reconNotice');
          const btnReconRefresh = sel('#btnReconRefresh');
          const btnReconCopy = sel('#btnReconCopy');

          const loadNotes = () => {
            try {
              const note = localStorage.getItem('hmj_report_notes');
              if (note && notesBoard) notesBoard.value = note;
            } catch {}
          };
          loadNotes();

          if (miscChips) {
            ['Invoice run', 'FX update', 'Compliance', 'AR follow-up', 'Payroll exported'].forEach((label) => {
              const tag = document.createElement('span');
              tag.className = 'chip';
              tag.textContent = label;
              miscChips.appendChild(tag);
            });
          }

          btnSaveNotes?.addEventListener('click', () => {
            if (!notesBoard) return;
            localStorage.setItem('hmj_report_notes', notesBoard.value || '');
            toast('Notes saved', 'info', 2000);
          });

          const formatCurrency = (value, currency) => `${currency || 'GBP'} ${(value || 0).toFixed(2)}`;

          function renderMetrics() {
            if (!metricCards) return;
            const cur = state.summary.currencies || {};
            const totals = Object.values(cur).reduce((acc, row) => {
              acc.pay += row.pay || 0;
              acc.charge += row.charge || 0;
              acc.gp += row.gp || 0;
              return acc;
            }, { pay: 0, charge: 0, gp: 0 });
            metricCards.innerHTML = `
              <div class="metric"><span>Total charge</span><strong>${formatCurrency(totals.charge, 'GBP')}</strong></div>
              <div class="metric"><span>Total pay</span><strong>${formatCurrency(totals.pay, 'GBP')}</strong></div>
              <div class="metric"><span>Gross margin</span><strong>${formatCurrency(totals.gp, 'GBP')}</strong></div>
              <div class="metric"><span>Timesheets</span><strong>${state.rows.length}</strong></div>`;
          }

          function renderCurrencyMix() {
            if (!currencyList) return;
            const entries = Object.entries(state.summary.currencies || {});
            if (!entries.length) {
              currencyList.innerHTML = '<div class="muted">No currency data.</div>';
              return;
            }
            currencyList.innerHTML = entries.map(([cur, val]) => {
              return `<div class="list-item"><strong>${cur}</strong><span class="muted">Pay ${val.pay.toFixed(2)} · Charge ${val.charge.toFixed(2)} · GP ${val.gp.toFixed(2)}</span></div>`;
            }).join('');
          }

          function renderContractors() {
            if (!contractorList) return;
            const rows = (state.summary.contractors || []).slice(0, 10);
            if (!rows.length) {
              contractorList.innerHTML = '<div class="muted">No contractor data yet.</div>';
              return;
            }
            contractorList.innerHTML = rows.map((row) => {
              return `<div class="list-item">
                <strong>${row.candidateName || 'Unnamed'} (${row.currency})</strong>
                <span class="muted">Margin ${row.gp.toFixed(2)} · Pay ${row.pay.toFixed(2)} · Charge ${row.charge.toFixed(2)} · ${row.rows} sheet(s)</span>
              </div>`;
            }).join('');
          }

          function renderTrend() {
            if (!trendBody) return;
            const entries = Object.entries(state.summary.weeks || {});
            if (!entries.length) {
              trendBody.innerHTML = '<tr><td colspan="6" class="muted">No weeks yet.</td></tr>';
              return;
            }
            trendBody.innerHTML = entries.map(([weekNo, data]) => {
              const date = state.rows.find((row) => String(row.weekNo) === String(weekNo))?.weekEnding || '—';
              return `<tr>
                <td>${weekNo}</td>
                <td>${date}</td>
                <td>${data.rows}</td>
                <td>${formatCurrency(data.pay, 'GBP')}</td>
                <td>${formatCurrency(data.charge, 'GBP')}</td>
                <td>${formatCurrency(data.gp, 'GBP')}</td>
              </tr>`;
            }).join('');
          }

          function renderReconciliation() {
            if (!reconBody || !reconBadge) return;
            const data = state.reconciliation?.datasets || [];
            if (!data.length) {
              reconBody.innerHTML = '<tr><td colspan="5" class="muted">Reconciliation data unavailable.</td></tr>';
            } else {
              reconBody.innerHTML = data.map((row) => {
                const supa = row.supabase === null || row.supabase === undefined ? '—' : row.supabase;
                const delta = row.delta === null || row.delta === undefined ? '—' : (row.delta > 0 ? `+${row.delta}` : row.delta);
                const notes = Array.isArray(row.notes) && row.notes.length ? row.notes.join(' · ') : '—';
                return `<tr>
                  <td>${row.label}</td>
                  <td>${supa}</td>
                  <td>${row.static}</td>
                  <td>${delta}</td>
                  <td>${notes}</td>
                </tr>`;
              }).join('');
            }

            const fallback = !!state.reconciliation?.fallback;
            const error = state.reconciliation?.error;
            reconBadge.textContent = fallback ? 'Preview data' : 'Supabase';
            reconBadge.style.background = fallback ? 'rgba(240,173,61,.18)' : 'rgba(31,157,99,.18)';
            reconBadge.style.borderColor = fallback ? 'rgba(240,173,61,.45)' : 'rgba(31,157,99,.45)';
            if (reconNotice) {
              if (error) {
                reconNotice.style.display = '';
                reconNotice.textContent = `Supabase response: ${error}`;
              } else if (fallback) {
                reconNotice.style.display = '';
                reconNotice.textContent = 'Supabase was unavailable. Preview data is being used for admin pages.';
              } else if (state.reconciliation?.schemaIssues?.length) {
                reconNotice.style.display = '';
                reconNotice.textContent = `Schema issues: ${state.reconciliation.schemaIssues.join(' · ')}`;
              } else {
                reconNotice.style.display = 'none';
              }
            }
          }

          function renderTable() {
            if (!tableBody) return;
            const rows = state.rows.filter((row) => {
              if (state.filters.hideZero) return Number(row.totals?.gp || 0) !== 0;
              return true;
            });
            if (!rows.length) {
              tableBody.innerHTML = '<tr><td colspan="10" class="muted">No rows match your filters.</td></tr>';
            } else {
              tableBody.innerHTML = rows.map((row) => {
                return `<tr>
                  <td>${row.weekEnding || '—'}</td>
                  <td>${row.weekNo || '—'}</td>
                  <td>${row.candidateName || '—'}</td>
                  <td>${row.clientName || '—'}</td>
                  <td>${row.jobTitle || '—'}</td>
                  <td>${(row.hours?.total || 0).toFixed(2)}</td>
                  <td>${formatCurrency(row.totals?.pay || 0, row.currency)}</td>
                  <td>${formatCurrency(row.totals?.charge || 0, row.currency)}</td>
                  <td>${formatCurrency(row.totals?.gp || 0, row.currency)}</td>
                  <td>${row.currency || 'GBP'}</td>
                </tr>`;
              }).join('');
            }
            rowCount.textContent = `${rows.length} row${rows.length === 1 ? '' : 's'}`;
          }

          async function loadReconciliation(notify = false) {
            if (reconBadge) {
              reconBadge.textContent = 'Checking…';
              reconBadge.style.background = 'rgba(79,127,255,.18)';
              reconBadge.style.borderColor = 'rgba(79,127,255,.45)';
            }
            if (reconBody) {
              reconBody.innerHTML = '<tr><td colspan="5" class="muted">Loading reconciliation…</td></tr>';
            }
            try {
              const res = await api('admin-reports-reconcile', 'POST', {});
              state.reconciliation = res || { datasets: [], fallback: true };
              renderReconciliation();
              if (notify) toast('Reconciliation updated', 'info', 2000);
            } catch (err) {
              state.reconciliation = { datasets: [], fallback: true, error: err?.message || String(err) };
              if (reconBody) {
                reconBody.innerHTML = `<tr><td colspan="5" class="muted">Failed: ${err?.message || err}</td></tr>`;
              }
              if (reconBadge) {
                reconBadge.textContent = 'Error';
                reconBadge.style.background = 'rgba(183,59,59,.18)';
                reconBadge.style.borderColor = 'rgba(183,59,59,.45)';
              }
              if (reconNotice) {
                reconNotice.style.display = '';
                reconNotice.textContent = `Unable to reconcile datasets: ${err?.message || err}`;
              }
              if (notify) toast('Reconciliation failed', 'error', 2600);
            }
          }

          function exportCsv(rows) {
            const header = ['week_ending','week_no','candidate','client','assignment','hours_std','hours_ot','pay','charge','margin','currency'];
            const lines = rows.map((row) => [
              row.weekEnding || '',
              row.weekNo || '',
              row.candidateName || '',
              row.clientName || '',
              row.jobTitle || '',
              (row.hours?.std || 0).toFixed(2),
              (row.hours?.ot || 0).toFixed(2),
              (row.totals?.pay || 0).toFixed(2),
              (row.totals?.charge || 0).toFixed(2),
              (row.totals?.gp || 0).toFixed(2),
              row.currency || 'GBP'
            ].map((cell) => {
              const text = String(cell ?? '');
              return /[",\n]/.test(text) ? `"${text.replace(/"/g,'""')}"` : text;
            }).join(','));
            const blob = new Blob([[header.join(',')].concat(lines).join('\n')], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hmj-gross-margin.csv';
            a.click();
            URL.revokeObjectURL(url);
          }

          function updateSummaries() {
            const contractorCount = state.summary.contractors?.length || 0;
            const clientSet = new Set(state.rows.map((r) => r.clientName).filter(Boolean));
            if (assignmentsSummary) assignmentsSummary.textContent = `${clientSet.size} clients across ${state.rows.length} sheets.`;
            const ready = state.rows.filter((r) => (r.status || '').toLowerCase() === 'approved').length;
            if (payrollSummary) payrollSummary.textContent = `${ready} approved · ${state.rows.length - ready} pending.`;
            if (timesheetSummary) timesheetSummary.textContent = `${state.rows.length} records analysed.`;
            if (clientSummary) clientSummary.textContent = `${clientSet.size} active clients · ${contractorCount} contractors with margin data.`;
          }

          async function loadAudit() {
            if (!auditBody) return;
            try {
              const res = await api('admin-audit-list', 'POST', { limit: 10 });
              const rows = Array.isArray(res) ? res : (res?.items || res || []);
              auditBody.innerHTML = rows.map((item) => {
                return `<tr>
                  <td>${item.at || item.created_at || '—'}</td>
                  <td>${item.actor_email || '—'}</td>
                  <td>${item.action || item.event || '—'}</td>
                  <td>${item.entity || item.target_type || '—'}</td>
                  <td><code style="font-size:.75rem">${item.details ? JSON.stringify(item.details) : item.payload ? JSON.stringify(item.payload) : ''}</code></td>
                </tr>`;
              }).join('');
            } catch (err) {
              auditBody.innerHTML = `<tr><td colspan="5" class="muted">Audit unavailable: ${err.message || err}</td></tr>`;
            }
          }

          async function runReport() {
            try {
              const body = {
                fromWeek: filterFrom?.value || undefined,
                toWeek: filterTo?.value || undefined,
                status: filterStatus?.value || undefined,
                currencies: filterCurrency?.value ? [filterCurrency.value] : undefined,
              };
              const res = await api('admin-report-gross-margin', 'POST', body);
              state.rows = Array.isArray(res?.rows) ? res.rows : [];
              state.summary = res?.summary || { currencies: {}, contractors: [], weeks: {} };
              state.source = res?.source || 'api';
              state.config = { ...state.config, ...(res?.config || {}) };
              if (!state.config.deadlineNote) state.config.deadlineNote = DEFAULTS.deadlineNote;
              if (!state.config.deadlineTimezone) state.config.deadlineTimezone = DEFAULTS.deadlineTimezone;
              if (weekNotice && state.config?.week1Ending) {
                const deadline = state.config.deadlineNote || DEFAULTS.deadlineNote;
                const tzLabel = state.config.deadlineTimezone || DEFAULTS.deadlineTimezone;
                weekNotice.textContent = `Week 1 ends ${state.config.week1Ending} · Submission deadline: ${deadline} (${tzLabel})`;
              }
              if (weekBaseInput && state.config?.week1Ending) weekBaseInput.value = state.config.week1Ending;
              if (deadlineInput) deadlineInput.value = state.config.deadlineNote || '';
              if (deadlineTz) deadlineTz.value = state.config.deadlineTimezone || DEFAULTS.deadlineTimezone;
              if (sourceMeta) sourceMeta.textContent = `Source: ${state.source}` + (res?.warning ? ` · ${res.warning}` : '');
              renderMetrics();
              renderCurrencyMix();
              renderContractors();
              renderTrend();
              renderTable();
              updateSummaries();
            } catch (err) {
              toast('Report failed: ' + (err.message || err), 'error', 4000);
            }
          }

          btnRun?.addEventListener('click', (e) => { e.preventDefault(); runReport(); });
          btnCsv?.addEventListener('click', (e) => { e.preventDefault(); exportCsv(state.rows); });
          btnDownloadCsv?.addEventListener('click', (e) => { e.preventDefault(); exportCsv(state.rows); });
          btnToggleEmpty?.addEventListener('click', () => {
            state.filters.hideZero = !state.filters.hideZero;
            btnToggleEmpty.textContent = state.filters.hideZero ? 'Show £0 rows' : 'Hide £0 rows';
            renderTable();
          });

          btnSaveWeek?.addEventListener('click', async () => {
            if (!weekBaseInput?.value) {
              toast('Select a week ending date first', 'warn', 2400);
              return;
            }
            const payload = {
              fiscal_week1_ending: weekBaseInput.value,
              timesheet_deadline_note: (deadlineInput?.value || '').trim() || DEFAULTS.deadlineNote,
              timesheet_deadline_timezone: deadlineTz?.value || DEFAULTS.deadlineTimezone,
            };
            try {
              const res = await api('admin-settings-save', 'POST', payload);
              state.config = { ...state.config, ...payload };
              weekBaseMeta.textContent = `Saved at ${new Date().toLocaleTimeString()}`;
              if (weekNotice) {
                weekNotice.textContent = `Week 1 ends ${state.config.week1Ending} · Submission deadline: ${state.config.deadlineNote} (${state.config.deadlineTimezone})`;
              }
              toast('Configuration saved', 'info', 2200);
              runReport();
            } catch (err) {
              toast('Save failed: ' + (err.message || err), 'error', 3200);
            }
          });

          btnReloadWeek?.addEventListener('click', async () => {
            try {
              const res = await api('admin-settings-get', 'POST', { keys: ['fiscal_week1_ending', 'timesheet_deadline_note', 'timesheet_deadline_timezone'] });
              const settings = res?.settings || {};
              const val = settings.fiscal_week1_ending || DEFAULTS.week1Ending;
              const note = settings.timesheet_deadline_note || DEFAULTS.deadlineNote;
              const tz = settings.timesheet_deadline_timezone || DEFAULTS.deadlineTimezone;
              if (weekBaseInput) weekBaseInput.value = val;
              if (deadlineInput) deadlineInput.value = note;
              if (deadlineTz) deadlineTz.value = tz;
              state.config = { ...state.config, week1Ending: val, deadlineNote: note, deadlineTimezone: tz };
              if (weekNotice) {
                weekNotice.textContent = `Week 1 ends ${state.config.week1Ending} · Submission deadline: ${state.config.deadlineNote} (${state.config.deadlineTimezone})`;
              }
              toast('Reloaded stored configuration', 'info', 2000);
            } catch (err) {
              toast('Reload failed: ' + (err.message || err), 'error', 3000);
            }
          });

          btnRefreshAudit?.addEventListener('click', (e) => { e.preventDefault(); loadAudit(); });
          btnReconRefresh?.addEventListener('click', (e) => { e.preventDefault(); loadReconciliation(true); });
          btnReconCopy?.addEventListener('click', async () => {
            const rows = state.reconciliation?.datasets || [];
            if (!rows.length) { toast('No reconciliation data yet', 'warn', 2000); return; }
            const header = `Reconciliation snapshot (${state.reconciliation?.generatedAt || 'n/a'})`;
            const lines = rows.map((row) => {
              const supa = row.supabase === null || row.supabase === undefined ? '—' : row.supabase;
              const delta = row.delta === null || row.delta === undefined ? '—' : (row.delta > 0 ? `+${row.delta}` : row.delta);
              const notes = Array.isArray(row.notes) && row.notes.length ? row.notes.join(' · ') : '—';
              return `${row.label}: supabase=${supa}, fallback=${row.static}, delta=${delta}, notes=${notes}`;
            }).join('\n');
            const note = state.reconciliation?.error ? `\nWarning: ${state.reconciliation.error}` : '';
            const blob = `${header}\n${lines}${note}`;
            try {
              await navigator.clipboard?.writeText(blob);
              toast('Reconciliation summary copied', 'info', 2000);
            } catch {
              toast('Copy failed', 'error', 2400);
            }
          });

          chip('reports ready');
          runReport();
          loadAudit();
          loadReconciliation();
        });
      };

      netlifyIdentity?.on('init', start);
      netlifyIdentity?.on('login', () => location.reload());
      netlifyIdentity?.on('logout', () => location.href = '/admin/');

      setTimeout(() => {
        if (netlifyIdentity?.currentUser()) start();
        else (document.querySelector('#gate') || {}).style.display = 'block';
      }, 600);
    });
  </script>
</body>
</html>
