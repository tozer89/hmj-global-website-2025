<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Candidates ‚Äî Admin | HMJ-Global</title>

<!-- Netlify Identity (can load a little late sometimes) -->
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Shared admin helpers (if this doesn‚Äôt load in time we fall back locally) -->
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>

<style>
  :root{
    --bg:#0b0f18; --panel:#111827; --border:#252f3f; --ink:#e6eef7; --muted:#9fb0c9;
    --card:#0f172a; --chip:#0e1629; --accent:#3A66B3; --accent-2:#2b50d9;
    --good:#0e2a1e; --warn:#38240f; --bad:#2a1214;
    --good-b:#1e6646; --warn-b:#8a5b25; --bad-b:#6a2b2f;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:5}
  .row{max-width:1240px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}

  .wrap{max-width:1240px;margin:22px auto;padding:0 18px;display:grid;gap:16px}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.20)}
  .muted{color:var(--muted)}
  input,select,textarea{
    background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px;width:100%;
  }
  textarea{min-height:96px;resize:vertical}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;
       font-weight:600;cursor:pointer;transition:.15s transform}
  .btn:hover{border-color:#3b4f79;transform:translateY(-1px)}
  .btn.bad{background:#2a1214;border-color:var(--bad-b)}
  .btn.good{background:#153125;border-color:var(--good-b)}
  .btn.ghost{background:transparent}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pills{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:var(--card);border:1px solid #2c3853;border-radius:12px;padding:10px 14px;min-width:90px;text-align:center}
  .pill b{font-size:20px;display:block}

  .filters{display:grid;grid-template-columns:1.5fr .9fr .9fr 1fr 1fr auto 120px;gap:10px;margin:6px 0}
  .tips{font-size:12px;color:var(--muted);margin-top:8px}

  .tableWrap{overflow:auto;border-radius:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  thead th{position:sticky;top:0;background:#0e1426;z-index:1}
  tbody tr:hover{background:#0e1629}
  .row-actions{display:flex;gap:6px}

  .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2c3853;background:#0f172a;font-size:12px}
  .status-ok{background:#0e2a1e;border-color:var(--good-b)}
  .status-warn{background:#33220f;border-color:var(--warn-b)}
  .status-bad{background:#2a1214;border-color:var(--bad-b)}

  .grid2{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .editor{display:grid;gap:12px}
  .editor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .editor-grid label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .editor-grid .field{display:flex;flex-direction:column}
  .section-title{margin:0 0 6px 0;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}

  .side{display:grid;gap:16px}
  .side-card h4{margin:0 0 6px 0}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px 10px}
  .kv div{white-space:pre-wrap;word-break:break-word}

  .error-banner{background:var(--bad);border:1px solid var(--bad-b);color:#ffd6d6;padding:10px;border-radius:12px}
  .loading{display:flex;gap:8px;align-items:center}
  .dot{width:6px;height:6px;border-radius:50%;background:#7f9dd9;opacity:.5;animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(.8);opacity:.4}40%{transform:scale(1);opacity:1}}

  .kpis{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .kpi{background:var(--card);border:1px solid #2c3853;border-radius:12px;padding:10px 14px;min-width:90px}
  .kpi b{font-size:20px;display:block}

  .toast{
    position:fixed;right:16px;bottom:16px;z-index:9999;display:grid;gap:8px;min-width:220px
  }
  .toast .t{
    background:#0f1529;border:1px solid #2b3c6f;border-left-width:6px;border-left-color:#3A66B3;color:#dbe7ff;
    padding:10px 12px;border-radius:10px;box-shadow:0 8px 22px rgba(0,0,0,.35);opacity:.98
  }
  .toast .t.good{border-left-color:#1e8f61}
  .toast .t.bad{border-left-color:#b24a52}

  /* Mobile */
  @media (max-width: 980px){
    .filters{grid-template-columns:1fr 1fr 1fr}
    .grid2{grid-template-columns:1fr}
  }
  /* Turn table rows into cards on small screens */
  @media (max-width: 720px){
    table thead{display:none}
    table, tbody, tr, td{display:block;width:100%}
    tbody tr{border:1px solid var(--border);border-radius:12px;margin-bottom:12px}
    td{border-bottom:1px dashed #1f2940}
    td:last-child{border-bottom:none}
    td[data-h]:before{content:attr(data-h) ": ";color:var(--muted);font-weight:600}
    .row-actions{justify-content:flex-end}
  }
</style>

<!-- Early identity keep-alive + cookie helper (used by API fallback) -->
<script>
  window.netlifyIdentity?.on?.('init', ()=>{});
  window.netlifyIdentity?.init?.({});
  function getNFJwtFromCookie(){
    const m = document.cookie.match(/(?:^|;\s*)nf_jwt=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }
</script>

</head>
<body>
  <!-- header -->
  <div class="top"><div class="row">
    <div class="brand">Candidates ‚Äî Admin</div><div class="sp"></div>
    <a class="btn" href="/admin/">‚üµ Admin home</a>
    <button class="btn" id="btnDebug">Debug</button>
    <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- gate (non-admin / not signed-in) -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="why muted" style="margin:6px 0 12px"></p>
      <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- app -->
  <div class="wrap" id="app" style="display:none">

    <!-- stats / actions -->
    <div class="card">
      <div class="toolbar" style="justify-content:space-between;align-items:flex-start;gap:14px">
        <div class="kpis">
          <div class="kpi"><b id="kTotal">0</b>Total</div>
          <div class="kpi"><b id="kFiltered">0</b>Filtered</div>
          <div class="kpi"><b id="kPage">1/1</b>Page</div>
        </div>
        <div class="toolbar">
          <button class="btn" id="btnRefresh">Refresh</button>
          <button class="btn" id="btnNew">New candidate</button>
          <button class="btn" id="btnExport">Export CSV</button>
          <button class="btn" id="btnEmails" title="Copy filtered emails">üìß Email list</button>
        </div>
      </div>
    </div>

    <!-- filters -->
    <div class="card">
      <div class="filters">
        <input id="q" placeholder="Search name / email / phone" aria-label="Search"/>
        <select id="fType" aria-label="Pay type filter">
          <option value="">Any pay type</option>
          <option>Umbrella</option><option>Umbrella CIS</option>
          <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
          <option>International</option><option>International Umbrella</option>
        </select>
        <select id="fStatus" aria-label="Status filter">
          <option value="">Any status</option>
          <option>Complete</option><option>In progress</option><option>Paused</option>
        </select>
        <input id="fJob" placeholder="Job title" aria-label="Job contains"/>
        <input id="fEmailHas" placeholder="Email contains" aria-label="Email contains"/>
        <div class="toolbar" style="justify-content:center">
          <button class="btn" id="pgPrev" title="Prev">‚óÄ</button>
          <div style="min-width:84px;text-align:center"><span id="pgNow">1</span>/<span id="pgMax">1</span></div>
          <button class="btn" id="pgNext" title="Next">‚ñ∂</button>
        </div>
        <select id="pageSize" title="Rows / page" aria-label="Rows per page">
          <option>25</option><option>50</option><option>100</option>
        </select>
      </div>
      <div class="tips">Tips: Press <b>/</b> to focus search ¬∑ <b>R</b> refresh ¬∑ <b>N</b> new candidate ¬∑ <b>‚Üê/‚Üí</b> page</div>
    </div>

    <!-- error banners -->
    <div id="errorTop" style="display:none" class="error-banner"></div>

    <!-- content: table + side panel -->
    <div class="grid2">
      <div>
        <!-- list -->
        <div class="card tableWrap" id="listWrap"><div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div></div>
        <div id="errorBottom" style="display:none;margin-top:12px" class="error-banner"></div>
      </div>

      <!-- side panel: profile/quick view -->
      <div class="side">
        <div class="card side-card">
          <h4 style="margin:0 0 10px">Quick profile</h4>
          <div class="kv">
            <div class="muted">Name</div>   <div id="pName">‚Äî</div>
            <div class="muted">Email</div>  <div id="pEmail">‚Äî</div>
            <div class="muted">Phone</div>  <div id="pPhone">‚Äî</div>
            <div class="muted">Job</div>    <div id="pJob">‚Äî</div>
            <div class="muted">Type</div>   <div id="pType">‚Äî</div>
            <div class="muted">Status</div> <div id="pStatus">‚Äî</div>
            <div class="muted">Payroll</div><div id="pPayroll">‚Äî</div>
            <div class="muted">Address</div><div id="pAddress">‚Äî</div>
          </div>
        </div>

        <div class="card side-card">
          <h4 style="margin:0 0 10px">Recent timesheets</h4>
          <div id="pTimesheets" class="muted">Select a candidate‚Ä¶</div>
        </div>

        <div class="card side-card">
          <h4 style="margin:0 0 10px">Assignments</h4>
          <div id="pAssignments" class="muted">Select a candidate‚Ä¶</div>
        </div>

        <div class="card side-card">
          <h4 style="margin:0 0 10px">T&Cs sent</h4>
          <div id="pTerms" class="muted">
            Placeholder ‚Äî later this will list documents/links sent for acceptance and their status.
          </div>
        </div>
      </div>
    </div>

    <!-- editor -->
    <div class="card editor" id="editor" style="display:none">
      <h3 style="margin:0 0 10px" id="edTitle">Candidate</h3>

      <div class="editor-grid">
        <div class="field"><label>First name</label><input id="edFirst"></div>
        <div class="field"><label>Last name</label><input id="edLast"></div>

        <div class="field"><label>Email</label><input id="edEmail" type="email"></div>
        <div class="field"><label>Phone</label><input id="edPhone"></div>

        <div class="field"><label>Job title</label><input id="edJob"></div>
        <div class="field"><label>Pay type</label>
          <select id="edType">
            <option>Umbrella</option><option>Umbrella CIS</option>
            <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
            <option>International</option><option>International Umbrella</option>
          </select>
        </div>

        <div class="field"><label>Status</label>
          <select id="edStatus"><option>In progress</option><option>Complete</option><option>Paused</option></select>
        </div>
        <div class="field"><label>Payroll ref</label><input id="edPayroll"></div>

        <div class="field" style="grid-column:1 / -1"><label>Address</label><input id="edAddress" placeholder="Free-form address"></div>
      </div>

      <div>
        <div class="section-title">Bank details (for payment)</div>
        <div class="editor-grid">
          <div class="field"><label>Sort code</label><input id="edSortCode" placeholder="12-34-56"></div>
          <div class="field"><label>Account number</label><input id="edAccount" placeholder="01234567"></div>
          <div class="field"><label>IBAN</label><input id="edIban" placeholder="(if international)"></div>
          <div class="field"><label>SWIFT / BIC</label><input id="edSwift" placeholder=""></div>
        </div>
      </div>

      <div>
        <div class="section-title">Notes</div>
        <textarea id="edNotes" placeholder="Internal notes‚Ä¶"></textarea>
      </div>

      <div class="inline" style="justify-content:flex-end;margin-top:12px;display:flex;gap:8px">
        <button class="btn good" id="btnSave">Save</button>
        <button class="btn bad" id="btnDelete">Delete</button>
        <button class="btn ghost" id="btnClose">Close</button>
      </div>
    </div>
  </div>

  <!-- toast host -->
  <div class="toast" id="toast"></div>

<script>
/* ================================================================================================
   DEBUG CONSOLE
================================================================================================ */
const __dbg = {
  on: false,
  log: (...a)=> __dbg.on && console.log('[line]', ...a),
  warn:(...a)=> __dbg.on && console.warn('[warn]', ...a),
  err: (...a)=> __dbg.on && console.error('[error]', ...a),
};
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ================================================================================================
   FALLBACK HELPERS when /admin/common.js hasn‚Äôt finished loading.
   - gate(): minimal admin gate using Netlify Identity
   - api():   robust fetch that tries Identity token OR nf_jwt cookie
================================================================================================ */
function localHelpers(){
  const sel = (s,root=document)=> root.querySelector(s);

  const toastHost = document.getElementById('toast');
  function toast(msg, kind=''){
    if (!toastHost) return alert(msg);
    const n = document.createElement('div');
    n.className = 't'+(kind?(' '+kind):''); n.textContent = msg;
    toastHost.appendChild(n);
    setTimeout(()=>{ n.style.opacity='0'; n.style.transform='translateY(6px)'; }, 2600);
    setTimeout(()=> toastHost.removeChild(n), 3000);
  }

  const show = id => sel(id).style.display='';
  const hide = id => sel(id).style.display='none';

  async function getIdentityUser(retries=40){
    for(let i=0;i<retries;i++){
      const id = window.netlifyIdentity;
      try{
        if (id && typeof id.currentUser==='function') return id.currentUser();
      }catch{}
      await sleep(100);
    }
    return null;
  }

  async function gate({ adminOnly }={}){
    const app = sel('#app'), gate = sel('#gate');
    const user = await getIdentityUser();
    if (user){
      // we treat any logged-in user as allowed; server will enforce admin
      show('#app'); hide('#gate'); return { email: user.email };
    } else {
      hide('#app'); show('#gate');
      sel('#gate .why').textContent = adminOnly ? 'Please sign in with an admin account.' : 'Please sign in.';
      return null;
    }
  }

  // *** THIS is the API function you asked for (with token + cookie fallback)
  async function api(path, method='POST', body){
    const url = path.startsWith('/') ? `/.netlify/functions${path}`.replace('//.','/.') : path;

    // 1) Try Identity token first
    let token = '';
    try {
      const user = window.netlifyIdentity?.currentUser?.();
      token = user ? (await (user.token?.() || user.jwt?.())) : '';
    } catch {}

    // 2) If still blank, try nf_jwt cookie (Edge got it during Identity login)
    if (!token) token = getNFJwtFromCookie();

    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = `Bearer ${token}`;

    __dbg.warn('Auth: ' + (token ? 'token present' : 'no token available yet'));
    __dbg.log('API ->', { url, method, body });

    const r = await fetch(url, {
      method,
      headers,
      credentials: 'include',
      body: body ? JSON.stringify(body) : undefined
    });

    const txt = await r.text();
    let json = null;
    try { json = txt ? JSON.parse(txt) : null; } catch(e) {}

    __dbg.log('API <--', { status: r.status, ok: r.ok, body: json });
    if (!r.ok) throw new Error(json?.error || `HTTP ${r.status}`);
    return json;
  }

  function onKey(code, fn){
    document.addEventListener('keydown', (e)=>{
      if(code.length===1 && e.key===code) return fn(e);
      if(code.length>1 && e.code===code) return fn(e);
    });
  }

  return { gate, api, sel, toast, onKey };
}

/* ================================================================================================
   BOOTSTRAP: prefer window.adminReady() from /admin/common.js; otherwise use fallbacks above
================================================================================================ */
async function waitAdminReadyOrFallback(){
  for(let i=0;i<100;i++){ // ~10s
    if (window.adminReady && typeof window.adminReady === 'function'){
      try{
        const helpers = await window.adminReady();
        if (helpers) return helpers; // { gate, api, sel, toast, onKey }
      }catch(e){ console.error('adminReady threw:', e); }
    }
    await sleep(100);
  }
  console.warn('common.js not loaded in time; using fallback helpers');
  return localHelpers();
}

/* ================================================================================================
   APP
================================================================================================ */
(async function bootstrap(){
  try{
    const helpers = await waitAdminReadyOrFallback();
    const { gate, api, sel, toast, onKey } = helpers;

    // Gate: admin only
    __dbg.log('Gate: start', '');
    const who = await gate({ adminOnly:true });
    if(!who){ return; }
    __dbg.log('Gate: user found', who);

    candidatesApp({ api, sel, toast, onKey });
  }catch(e){
    console.error(e);
    const top = document.querySelector('#errorTop');
    if (top){ top.style.display=''; top.textContent = 'Error: '+(e.message||e); }
  }
})();

async function candidatesApp({ api, sel, toast, onKey }){
  __dbg.log('App: init', '');

  // state
  let page=1, pages=1, size=Number(localStorage.cand_size||25)||25, cur=null, lastRows=[], sort={key:'name',dir:'asc'};

  // els
  const $ = (s,root=document)=> root.querySelector(s);
  const listWrap = $('#listWrap');
  const ed = $('#editor');
  const errorTop = $('#errorTop'), errorBottom = $('#errorBottom');

  $('#pageSize').value = String(size);

  // helpers
  const qv = id => $(id).value.trim();
  const setNum = (selId,val)=> {
    const el = $(selId.startsWith('#')? selId : '#'+selId);
    if(!el) return __dbg.warn('Counter element not found:', selId);
    el.textContent = String(val);
  };
  const banner = (el, msg)=>{ if(!msg){ el.style.display='none'; el.textContent=''; } else { el.style.display=''; el.textContent = 'Error: ' + msg; } };
  const hideErrorBanner = ()=> { banner(errorTop, null); banner(errorBottom, null); };

  function statusBadge(s){
    const t=(s||'').toLowerCase();
    const cls = t==='complete' ? 'status-ok' : t==='in progress' ? 'status-warn' : 'status-bad';
    return `<span class="badge ${cls}">${s||'‚Äî'}</span>`;
  }
  const typeBadge = t => `<span class="badge">${t||'‚Äî'}</span>`;

  function renderRows(rows){
    lastRows = rows;
    if(!rows.length){
      listWrap.innerHTML = '<div class="muted" style="padding:12px">No candidates.</div>';
      return;
    }
    const head = `
      <thead>
        <tr>
          <th style="width:80px">ID</th>
          <th>Name</th>
          <th>Email</th>
          <th style="width:140px">Phone</th>
          <th style="width:160px">Type</th>
          <th style="width:140px">Status</th>
          <th style="width:128px"></th>
        </tr>
      </thead>`;
    const body = rows.map(r=>{
      const name = [r.first_name,r.last_name].filter(Boolean).join(' ') || (r.name||'‚Äî');
      return `
        <tr data-id="${r.id}">
          <td data-h="ID">${r.id??'‚Äî'}</td>
          <td data-h="Name">${name}</td>
          <td data-h="Email">${r.email || '‚Äî'}</td>
          <td data-h="Phone">${r.phone || '‚Äî'}</td>
          <td data-h="Type">${typeBadge(r.pay_type)}</td>
          <td data-h="Status">${statusBadge(r.status)}</td>
          <td data-h="">
            <div class="row-actions">
              <button class="btn" data-open="${r.id}">Open</button>
              <button class="btn" data-profile="${r.id}">Profile</button>
            </div>
          </td>
        </tr>`;
    }).join('');

    listWrap.innerHTML = `<table>${head}<tbody>${body}</tbody></table>`;
    listWrap.querySelectorAll('button[data-open]').forEach(b=> b.onclick = ()=> openEd(Number(b.dataset.open)));
    listWrap.querySelectorAll('button[data-profile]').forEach(b=> b.onclick = ()=> showProfile(Number(b.dataset.profile)));
  }

  function normalizeResponse(res){
    // Accept: array or {rows,total,filtered,pages}
    const rows = Array.isArray(res) ? res : (res && res.rows) ? res.rows : [];
    const total = (res && typeof res.total==='number') ? res.total : rows.length;
    const filtered = (res && typeof res.filtered==='number') ? res.filtered : rows.length;
    const pg = Math.max(1, Number((res && res.pages) || Math.ceil(filtered/size) || 1));
    return { rows, total, filtered, pages:pg };
  }

  async function loadList(){
    hideErrorBanner();
    listWrap.innerHTML = '<div class="loading" style="padding:12px"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    try{
      const body = {
        q: qv('#q'),
        type: qv('#fType'),
        status: qv('#fStatus'),
        job: qv('#fJob'),
        emailHas: qv('#fEmailHas'),
        page,
        size,
        sort,
        debug: true,
      };
      __dbg.log('List: request body', body);

      const res = await api('/admin-candidates-lists','POST', body);
      if (res?.debug) { __dbg.log('Function debug', res.debug); }
      const meta = normalizeResponse(res);
      pages = meta.pages;
      if(page>pages) page=pages;

      setNum('#kTotal', meta.total);
      setNum('#kFiltered', meta.filtered);
      setNum('#pgNow', page);
      setNum('#pgMax', pages);
      $('#kPage').textContent = `${page}/${pages}`;

      __dbg.log('List: meta', { total:meta.total, filtered:meta.filtered, pages, page });
      renderRows(meta.rows);
    }catch(e){
      __dbg.err('List: load failed', String(e));
      banner(errorTop, e.message || 'Error');
      listWrap.innerHTML = '<div style="color:#ffb4b4;padding:12px">Error: '+(e.message||e)+'</div>';
    }
  }

  function setEd(c){
    $('#edTitle').textContent = c?.id ? `Candidate #${c.id}` : 'New candidate';
    $('#edFirst').value   = c.first_name||'';
    $('#edLast').value    = c.last_name||'';
    $('#edEmail').value   = c.email||'';
    $('#edPhone').value   = c.phone||'';
    $('#edJob').value     = c.job_title||'';
    $('#edType').value    = c.pay_type||'Umbrella';
    $('#edStatus').value  = c.status||'In progress';
    $('#edPayroll').value = c.payroll_ref||'';
    $('#edAddress').value = c.address||'';
    // banking
    $('#edSortCode').value = c.bank_sort_code||'';
    $('#edAccount').value  = c.bank_account||'';
    $('#edIban').value     = c.bank_iban||'';
    $('#edSwift').value    = c.bank_swift||'';
    $('#edNotes').value    = c.notes||'';
  }
  function getEd(){
    return {
      id: cur?.id || undefined,
      first_name: qv('#edFirst')||null,
      last_name:  qv('#edLast')||null,
      email:      qv('#edEmail')||null,
      phone:      qv('#edPhone')||null,
      job_title:  qv('#edJob')||null,
      pay_type:   qv('#edType')||null,
      status:     qv('#edStatus')||null,
      payroll_ref:qv('#edPayroll')||null,
      address:    qv('#edAddress')||null,
      bank_sort_code: qv('#edSortCode')||null,
      bank_account:   qv('#edAccount')||null,
      bank_iban:      qv('#edIban')||null,
      bank_swift:     qv('#edSwift')||null,
      notes:          qv('#edNotes')||null,
    };
  }

  async function openEd(id){
    try{
      cur = id ? await api('/admin-candidates-get','POST',{ id }) : { status:'In progress', pay_type:'Umbrella' };
      setEd(cur);
      ed.style.display = '';
      ed.scrollIntoView({behavior:'smooth',block:'start'});
      showProfile(cur?.id || null, cur); // reflect data into side panel
    }catch(e){ toast('Open failed: '+(e.message||e),'bad'); }
  }

  function showProfile(id, candidateObj){
    if(!id && !candidateObj){
      $('#pTimesheets').textContent = 'Select a candidate‚Ä¶';
      $('#pAssignments').textContent = 'Select a candidate‚Ä¶';
      ['#pName','#pEmail','#pPhone','#pJob','#pType','#pStatus','#pPayroll','#pAddress'].forEach(s=> $(s).textContent='‚Äî');
      return;
    }
    const c = candidateObj || lastRows.find(r=> r.id===id);
    const name = [c?.first_name, c?.last_name].filter(Boolean).join(' ') || (c?.name||'‚Äî');
    $('#pName').textContent = name;
    $('#pEmail').textContent = c?.email || '‚Äî';
    $('#pPhone').textContent = c?.phone || '‚Äî';
    $('#pJob').textContent = c?.job_title || '‚Äî';
    $('#pType').textContent = c?.pay_type || '‚Äî';
    $('#pStatus').textContent = c?.status || '‚Äî';
    $('#pPayroll').textContent = c?.payroll_ref || '‚Äî';
    $('#pAddress').textContent = c?.address || '‚Äî';

    // Load ancillary panels (best-effort; show message if not available)
    loadTimesheetsFor(c?.id).catch(e=> $('#pTimesheets').textContent = 'Timesheets unavailable: '+(e.message||e));
    loadAssignmentsFor(c?.id).catch(e=> $('#pAssignments').textContent = 'Assignments unavailable: '+(e.message||e));
    $('#pTerms').textContent = 'T&Cs: (placeholder) ‚Äî to be wired later against documents table.';
  }

  async function loadTimesheetsFor(id){
    if(!id){ $('#pTimesheets').textContent = 'Select a candidate‚Ä¶'; return; }
    $('#pTimesheets').innerHTML = '<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    try{
      const res = await api('/admin-timesheets-list','POST',{ candidate_id:id, size:5 });
      const rows = Array.isArray(res) ? res : (res?.rows||[]);
      if(!rows.length){ $('#pTimesheets').textContent = 'No recent timesheets'; return; }
      const ul = rows.map(t=>{
        const when = t.week_ending || t.period || t.created_at || '';
        const hours = t.hours_total ?? t.total_hours ?? '';
        const stat = t.status || '';
        return `<li>${when} ‚Äî ${hours}h ‚Äî <span class="badge">${stat}</span></li>`;
      }).join('');
      $('#pTimesheets').innerHTML = `<ul style="margin:0 0 0 18px;padding:0;display:grid;gap:4px">${ul}</ul>`;
    }catch(e){
      $('#pTimesheets').textContent = 'Timesheets unavailable: '+(e.message||e);
      throw e;
    }
  }

  async function loadAssignmentsFor(id){
    if(!id){ $('#pAssignments').textContent = 'Select a candidate‚Ä¶'; return; }
    $('#pAssignments').innerHTML = '<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    try{
      const res = await api('/admin-assignments-list','POST',{ candidate_id:id, size:5 });
      const rows = Array.isArray(res) ? res : (res?.rows||[]);
      if(!rows.length){ $('#pAssignments').textContent = 'No current assignments'; return; }
      const ul = rows.map(a=>{
        const client = a.client_name || a.client || '';
        const title  = a.job_title || a.role || '';
        const stat   = a.status || '';
        return `<li>${client} ‚Äî ${title} ‚Äî <span class="badge">${stat}</span></li>`;
      }).join('');
      $('#pAssignments').innerHTML = `<ul style="margin:0 0 0 18px;padding:0;display:grid;gap:4px">${ul}</ul>`;
    }catch(e){
      $('#pAssignments').textContent = 'Assignments unavailable: '+(e.message||e);
      throw e;
    }
  }

  // events
  $('#btnRefresh').onclick = ()=> { page=1; loadList(); };
  ['#q','#fType','#fStatus','#fJob','#fEmailHas'].forEach(sid=>{
    $(sid).addEventListener('change', ()=>{ page=1; loadList(); });
    $(sid).addEventListener('keyup',  (e)=>{ if(e.key==='Enter'){ page=1; loadList(); }});
  });

  $('#pgPrev').onclick = ()=>{ if(page>1){ page--; loadList(); } };
  $('#pgNext').onclick = ()=>{ if(page<pages){ page++; loadList(); } };
  $('#pageSize').onchange = ()=>{ size = Number($('#pageSize').value)||25; localStorage.cand_size=size; page=1; loadList(); };

  $('#btnNew').onclick  = ()=> openEd(null);
  $('#btnClose').onclick= ()=>{ ed.style.display='none'; cur=null; };

  $('#btnSave').onclick = async ()=>{
    try{
      const data = getEd();
      const saved = await api('/admin-candidates-save','POST', data);
      toast('Saved','good');
      ed.style.display='none';
      page=1;
      await loadList();
      if(saved?.id) { cur={id:saved.id}; openEd(saved.id); }
    }catch(e){ toast('Save failed: '+(e.message||e),'bad'); }
  };

  $('#btnDelete').onclick = async ()=>{
    if(!cur?.id) return toast('Nothing to delete','bad');
    if(!confirm('Delete this candidate?')) return;
    try{ await api('/admin-candidates-delete','POST',{ id: cur.id }); toast('Deleted','good'); ed.style.display='none'; await loadList(); }
    catch(e){ toast('Delete failed: '+(e.message||e),'bad'); }
  };

  $('#btnEmails').onclick = ()=>{
    const emails = lastRows.map(r=>r.email).filter(Boolean);
    if(!emails.length) return toast('No emails in current list','bad');
    navigator.clipboard?.writeText(emails.join(', '));
    toast(`Copied ${emails.length} email(s)`,'good');
  };

  $('#btnExport').onclick = ()=>{
    const rows = lastRows;
    if(!rows.length){ toast('Nothing to export','bad'); return; }
    const cols = ['id','first_name','last_name','email','phone','job_title','pay_type','status','payroll_ref','bank_sort_code','bank_account','bank_iban','bank_swift'];
    const head = cols.join(',');
    const csv = [head].concat(rows.map(r=> cols.map(k=>{
      const v = r[k] ?? '';
      const s = String(v).replace(/"/g,'""');
      return `"${s}"`;
    }).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
    toast('Exported CSV','good');
  };

  // keyboard shortcuts
  onKey?.('/', ()=> $('#q')?.focus());
  onKey?.('KeyR', ()=> $('#btnRefresh').click());
  onKey?.('KeyN', ()=> $('#btnNew').click());
  onKey?.('ArrowLeft', ()=> $('#pgPrev').click());
  onKey?.('ArrowRight',()=> $('#pgNext').click());

  // debug toggle
  $('#btnDebug').onclick = ()=>{
    __dbg.on = !__dbg.on;
    toast('Debug '+(__dbg.on?'ON':'OFF'));
    if(__dbg.on) loadList();
  };

  // initial load
  await loadList();
}
</script>
</body>
</html>
