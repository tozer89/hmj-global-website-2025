<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Candidates ‚Äî Admin | HMJ-Global</title>

<!-- Netlify Identity + shared admin helpers -->
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>

<style>
  :root{
    --bg:#0b0f18; --panel:#111827; --border:#252f3f; --ink:#e6eef7; --muted:#9fb0c9;
    --card:#0f172a; --chip:#0e1629; --accent:#3A66B3;
    --ok:#0e2a1e; --warn:#38240f; --bad:#2a1214;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:5}
  .row{max-width:1240px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1240px;margin:22px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.20)}
  .muted{color:var(--muted)}
  input,select,textarea{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  textarea{min-height:96px;resize:vertical}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  .btn.ghost{background:transparent}
  .btn.bad{background:#2a1214;border-color:#6a2b2f}
  .btn.good{background:#153125;border-color:#1e6646}
  .pills{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:var(--card);border:1px solid #2c3853;border-radius:12px;padding:10px 14px;min-width:90px;text-align:center}
  .kpi b{font-size:20px;display:block}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .filters{display:grid;grid-template-columns:1.5fr .9fr .9fr 1fr 1fr auto 120px;gap:10px;margin:6px 0}
  .tableWrap{overflow:auto;border-radius:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  thead th{position:sticky;top:0;background:#0e1426;z-index:1}
  tbody tr:hover{background:#0e1629}
  .row-actions{display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2c3853;background:#0f172a;font-size:12px}
  .status-ok{background:var(--ok);border-color:#1e6646}
  .status-warn{background:#33220f;border-color:#8a5b25}
  .status-bad{background:var(--bad);border-color:#6a2b2f}
  .grid2{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .editor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .editor-grid label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .section-title{margin:12px 0 6px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px 10px}
  .error-banner{background:var(--bad);border:1px solid #6a2b2f;color:#ffd6d6;padding:10px;border-radius:12px}
  .loading{display:flex;gap:8px;align-items:center}
  .dot{width:6px;height:6px;border-radius:50%;background:#7f9dd9;opacity:.5;animation:bounce 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
  @keyframes bounce{0%,80%,100%{transform:scale(.8);opacity:.4}40%{transform:scale(1);opacity:1}}
  @media (max-width:980px){ .filters{grid-template-columns:1fr 1fr 1fr} .grid2{grid-template-columns:1fr} }
  @media (max-width:720px){
    table thead{display:none}
    table, tbody, tr, td{display:block;width:100%}
    tbody tr{border:1px solid var(--border);border-radius:12px;margin-bottom:12px}
    td{border-bottom:1px dashed #1f2940}
    td:last-child{border-bottom:none}
    td[data-h]:before{content:attr(data-h) ": ";color:var(--muted);font-weight:600}
    .row-actions{justify-content:flex-end}
  }
</style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">Candidates ‚Äî Admin</div><div class="sp"></div>
    <a class="btn" href="/admin/">‚üµ Admin home</a>
    <button class="btn" id="btnDebug">Debug</button>
    <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- gate -->
  <div class="wrap" id="gate" style="display:none"><div class="card">
    <strong>Admin only.</strong>
    <p class="why muted" style="margin:6px 0 12px"></p>
    <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
  </div></div>

  <!-- app -->
  <div class="wrap" id="app" style="display:none">
    <div class="card">
      <div class="toolbar">
        <div class="pills">
          <div class="kpi"><b id="kTotal">0</b>Total</div>
          <div class="kpi"><b id="kFiltered">0</b>Filtered</div>
          <div class="kpi"><b id="kPage">1/1</b>Page</div>
        </div>
        <div class="pills">
          <button class="btn" id="btnRefresh">Refresh</button>
          <button class="btn" id="btnNew">New candidate</button>
          <button class="btn" id="btnExport">Export CSV</button>
          <button class="btn" id="btnEmails" title="Copy filtered emails">üìß Email list</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="filters">
        <input id="q" placeholder="Search name / email / phone"/>
        <select id="fType">
          <option value="">Any pay type</option>
          <option>Umbrella</option><option>Umbrella CIS</option>
          <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
          <option>International</option><option>International Umbrella</option>
        </select>
        <select id="fStatus">
          <option value="">Any status</option>
          <option>Complete</option><option>In progress</option><option>Paused</option>
        </select>
        <input id="fJob" placeholder="Job title"/>
        <input id="fEmailHas" placeholder="Email contains"/>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
          <button class="btn" id="pgPrev">‚óÄ</button>
          <div style="min-width:84px;text-align:center"><span id="pgNow">1</span>/<span id="pgMax">1</span></div>
          <button class="btn" id="pgNext">‚ñ∂</button>
        </div>
        <select id="pageSize" title="Rows / page"><option>25</option><option>50</option><option>100</option></select>
      </div>
      <div class="muted" style="font-size:12px;margin-top:8px">Tips: Press <b>/</b> to focus search ¬∑ <b>R</b> refresh ¬∑ <b>N</b> new candidate ¬∑ <b>‚Üê/‚Üí</b> page</div>
    </div>

    <div id="errorTop" style="display:none" class="error-banner"></div>

    <div class="grid2">
      <div>
        <div class="card tableWrap" id="listWrap">
          <div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>
        </div>
        <div id="errorBottom" style="display:none;margin-top:12px" class="error-banner"></div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 10px">Quick profile</h4>
        <div class="kv">
          <div class="muted">Name</div><div id="pName">‚Äî</div>
          <div class="muted">Email</div><div id="pEmail">‚Äî</div>
          <div class="muted">Phone</div><div id="pPhone">‚Äî</div>
          <div class="muted">Job</div><div id="pJob">‚Äî</div>
          <div class="muted">Type</div><div id="pType">‚Äî</div>
          <div class="muted">Status</div><div id="pStatus">‚Äî</div>
          <div class="muted">Payroll</div><div id="pPayroll">‚Äî</div>
          <div class="muted">Address</div><div id="pAddress">‚Äî</div>
        </div>

        <h4 class="section-title">Recent timesheets</h4>
        <div id="pTimesheets" class="muted">Select a candidate‚Ä¶</div>

        <h4 class="section-title">Assignments</h4>
        <div id="pAssignments" class="muted">Select a candidate‚Ä¶</div>

        <h4 class="section-title">Terms & Conditions</h4>
        <div id="pTerms" class="muted">Coming soon ‚Äî this panel will show T&Cs sent/accepted for the selected candidate.</div>
      </div>
    </div>

    <!-- editor -->
    <div class="card" id="editor" style="display:none">
      <h3 style="margin:0 0 10px" id="edTitle">Candidate</h3>
      <div class="editor-grid">
        <div><label>First name</label><input id="edFirst"></div>
        <div><label>Last name</label><input id="edLast"></div>
        <div><label>Email</label><input id="edEmail" type="email"></div>
        <div><label>Phone</label><input id="edPhone"></div>
        <div><label>Job title</label><input id="edJob"></div>
        <div>
          <label>Pay type</label>
          <select id="edType">
            <option>Umbrella</option><option>Umbrella CIS</option>
            <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
            <option>International</option><option>International Umbrella</option>
          </select>
        </div>
        <div>
          <label>Status</label>
          <select id="edStatus"><option>In progress</option><option>Complete</option><option>Paused</option></select>
        </div>
        <div><label>Payroll ref</label><input id="edPayroll"></div>
        <div style="grid-column:1/-1"><label>Address</label><input id="edAddress" placeholder="Free-form address"></div>
      </div>

      <div class="section-title">Bank details (optional)</div>
      <div class="editor-grid">
        <div><label>Sort code</label><input id="edSortCode" placeholder="12-34-56"></div>
        <div><label>Account number</label><input id="edAccount" placeholder="01234567"></div>
        <div><label>IBAN</label><input id="edIban" placeholder="(if international)"></div>
        <div><label>SWIFT / BIC</label><input id="edSwift" placeholder=""></div>
      </div>

      <div class="section-title">Notes</div>
      <textarea id="edNotes" placeholder="Internal notes‚Ä¶"></textarea>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn good" id="btnSave">Save</button>
        <button class="btn bad" id="btnDelete">Delete</button>
        <button class="btn ghost" id="btnClose">Close</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* ==============================
   DEBUG UTIL
============================== */
const __dbg = {
  on: location.search.includes('debug=1'),
  log: (...a)=> __dbg.on && console.log('[line]', ...a),
  warn:(...a)=> __dbg.on && console.warn('[warn]', ...a),
  err: (...a)=> __dbg.on && console.error('[error]', ...a),
};
document.addEventListener('DOMContentLoaded', ()=> {
  const b=document.getElementById('btnDebug');
  if(b) b.textContent = __dbg.on ? 'Debug ‚úì' : 'Debug';
  b?.addEventListener('click', ()=> {
    __dbg.on = !__dbg.on;
    b.textContent = __dbg.on ? 'Debug ‚úì' : 'Debug';
    toast('Debug '+(__dbg.on?'ON':'OFF'));
  });
});

/* ==============================
   FALLBACK HELPERS if /admin/common.js is late
============================== */
function toast(msg){
  let t = document.getElementById('toast');
  if(!t){ alert(msg); return; }
  t.textContent = msg;
  t.style.position='fixed'; t.style.bottom='16px'; t.style.right='16px';
  t.style.background='#1a2238'; t.style.border='1px solid #2c3853';
  t.style.padding='10px 12px'; t.style.borderRadius='10px';
  t.style.zIndex=9999; t.style.boxShadow='0 8px 20px rgba(0,0,0,.4)';
  setTimeout(()=>{ t.textContent=''; t.removeAttribute('style'); }, 1800);
}
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
async function getToken(){
  try{
    const user = window.netlifyIdentity?.currentUser?.();
    if(!user) return '';
    return await (user.token?.() || user.jwt?.());
  }catch{ return '';}
}
async function apiFallback(path, method='POST', body){
  const token = await getToken();
  const url = `/.netlify/functions${path.startsWith('/')?'':'/'}${path}`;
  const headers = { 'content-type':'application/json' };
  if(token) headers.authorization = `Bearer ${token}`;
  __dbg.log('API request', { url, method, body });
  const r = await fetch(url,{ method, headers, credentials:'include', body: JSON.stringify(body||{}) });
  const txt = await r.text(); let json; try{ json = JSON.parse(txt) }catch{ json = { raw: txt } }
  __dbg.log('API response', { status:r.status, ok:r.ok, preview: Array.isArray(json)? `[array x${json.length}]` : Object.keys(json||{}).slice(0,6) });
  if(!r.ok) throw new Error(json?.error || `HTTP ${r.status}`);
  return json;
}
async function waitAdminReady(){
  for(let i=0;i<100;i++){
    if (window.adminReady) { try{ return await window.adminReady(); }catch(e){ __dbg.err('adminReady error',e); } }
    await sleep(100);
  }
  __dbg.warn('common.js not loaded in time; using fallback helpers');
  const gate = async ({adminOnly}={})=>{
    const app = document.getElementById('app'), g = document.getElementById('gate');
    const user = window.netlifyIdentity?.currentUser?.();
    if(user){ app.style.display=''; g.style.display='none'; return { email:user.email }; }
    g.style.display=''; app.style.display='none'; g.querySelector('.why').textContent = adminOnly?'Please sign in with an admin account.':'Please sign in.'; return null;
  };
  return { gate, api: apiFallback, sel: (s,r=document)=>r.querySelector(s), toast, onKey:(c,fn)=>document.addEventListener('keydown',e=>{ if((c.length===1 && e.key===c)||(c.length>1&&e.code===c)) fn(e); }) };
}

/* ==============================
   APP
============================== */
(async function main(){
  const { gate, api, sel, onKey } = await waitAdminReady();
  __dbg.log('Gate: start', '');
  const who = await gate({ adminOnly:true });
  if (!who) return;
  __dbg.log('Gate: user found', who);

  let page=1, pages=1, size=Number(localStorage.cand_size||25)||25, cur=null, lastRows=[], sort={key:'name',dir:'asc'};

  const $ = (s,r=document)=>r.querySelector(s);
  const listWrap = $('#listWrap');
  const ed = $('#editor');
  $('#pageSize').value = String(size);

  const setNum = (id,val)=>{ const el=$(id); if(!el){__dbg.warn('setNum missing',id);return;} el.textContent=String(val); };
  const banner = (el, msg)=>{ if(!msg){ el.style.display='none'; el.textContent=''; } else { el.style.display=''; el.textContent='Error: '+msg; } };

  function statusBadge(s){ const t=(s||'').toLowerCase(); const cls=t==='complete'?'status-ok':t==='in progress'?'status-warn':'status-bad'; return `<span class="badge ${cls}">${s||'‚Äî'}</span>`; }
  const typeBadge = (t)=> `<span class="badge">${t||'‚Äî'}</span>`;

  function normalize(res){
    const rows = Array.isArray(res) ? res : (res?.rows||[]);
    const total = typeof res?.total==='number' ? res.total : rows.length;
    const filtered = typeof res?.filtered==='number' ? res.filtered : rows.length;
    const pgs = Math.max(1, Number(res?.pages || Math.ceil(filtered/size) || 1));
    return { rows, total, filtered, pages:pgs };
  }

  function renderRows(rows){
    lastRows = rows;
    if(!rows.length){ listWrap.innerHTML = '<div class="muted">No candidates.</div>'; return; }
    const head=`
      <thead><tr>
        <th style="width:80px">ID</th><th>Name</th><th>Email</th>
        <th style="width:140px">Phone</th><th style="width:160px">Type</th>
        <th style="width:140px">Status</th><th style="width:128px"></th>
      </tr></thead>`;
    const body=rows.map(r=>{
      const name=[r.first_name,r.last_name].filter(Boolean).join(' ') || (r.name||'‚Äî');
      return `<tr data-id="${r.id}">
        <td data-h="ID">${r.id??'‚Äî'}</td>
        <td data-h="Name">${name}</td>
        <td data-h="Email">${r.email||'‚Äî'}</td>
        <td data-h="Phone">${r.phone||'‚Äî'}</td>
        <td data-h="Type">${typeBadge(r.pay_type)}</td>
        <td data-h="Status">${statusBadge(r.status)}</td>
        <td><div class="row-actions">
          <button class="btn" data-open="${r.id}">Open</button>
          <button class="btn" data-profile="${r.id}">Profile</button>
        </div></td></tr>`;
    }).join('');
    listWrap.innerHTML = `<table>${head}<tbody>${body}</tbody></table>`;
    listWrap.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>openEd(+b.dataset.open));
    listWrap.querySelectorAll('[data-profile]').forEach(b=>b.onclick=()=>showProfile(+b.dataset.profile));
  }

  async function loadList(){
    banner($('#errorTop')); banner($('#errorBottom'));
    listWrap.innerHTML = '<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    try{
      const body = {
        q: $('#q').value.trim(),
        type: $('#fType').value.trim(),
        status: $('#fStatus').value.trim(),
        job: $('#fJob').value.trim(),
        emailHas: $('#fEmailHas').value.trim(),
        page, size, sort, debug: __dbg.on
      };
      __dbg.log('List: request body', body);
      const res = await api('/admin-candidates-lists','POST', body);
      if(res?.debug) __dbg.log('Function debug', res.debug);
      const meta = normalize(res);
      pages = meta.pages; if(page>pages) page=pages;
      setNum('#kTotal', meta.total); setNum('#kFiltered', meta.filtered);
      setNum('#pgNow', page); setNum('#pgMax', pages); $('#kPage').textContent=`${page}/${pages}`;
      __dbg.log('List: meta', { total:meta.total, filtered:meta.filtered, pages, page });
      renderRows(meta.rows);
    }catch(e){
      __dbg.err('List: load failed', String(e));
      banner($('#errorTop'), e.message||'Error');
      listWrap.innerHTML = `<div style="color:#ffb4b4">Error: ${e.message||e}</div>`;
    }
  }

  function setEd(c){
    $('#edTitle').textContent = c?.id ? `Candidate #${c.id}` : 'New candidate';
    $('#edFirst').value = c.first_name||'';
    $('#edLast').value = c.last_name||'';
    $('#edEmail').value= c.email||'';
    $('#edPhone').value= c.phone||'';
    $('#edJob').value  = c.job_title||'';
    $('#edType').value = c.pay_type||'Umbrella';
    $('#edStatus').value= c.status||'In progress';
    $('#edPayroll').value= c.payroll_ref||'';
    $('#edAddress').value= c.address||'';
    $('#edSortCode').value= c.bank_sort_code||''; $('#edAccount').value=c.bank_account||'';
    $('#edIban').value=c.bank_iban||''; $('#edSwift').value=c.bank_swift||'';
    $('#edNotes').value=c.notes||'';
  }
  function getEd(){
    const v=s=>$(s).value.trim();
    return {
      id: cur?.id||undefined, first_name:v('#edFirst')||null, last_name:v('#edLast')||null,
      email:v('#edEmail')||null, phone:v('#edPhone')||null, job_title:v('#edJob')||null,
      pay_type:v('#edType')||null, status:v('#edStatus')||null, payroll_ref:v('#edPayroll')||null,
      address:v('#edAddress')||null, bank_sort_code:v('#edSortCode')||null, bank_account:v('#edAccount')||null,
      bank_iban:v('#edIban')||null, bank_swift:v('#edSwift')||null, notes:v('#edNotes')||null
    };
  }

  async function openEd(id){
    try{
      cur = id ? await api('/admin-candidates-get','POST',{ id }) : { status:'In progress', pay_type:'Umbrella' };
      setEd(cur);
      ed.style.display=''; ed.scrollIntoView({behavior:'smooth',block:'start'});
      showProfile(cur?.id||null, cur);
    }catch(e){ toast('Open failed: '+(e.message||e)); }
  }

  function showProfile(id, cMaybe){
    if(!id && !cMaybe){
      ['#pName','#pEmail','#pPhone','#pJob','#pType','#pStatus','#pPayroll','#pAddress'].forEach(s=> $(s).textContent='‚Äî');
      $('#pTimesheets').textContent='Select a candidate‚Ä¶';
      $('#pAssignments').textContent='Select a candidate‚Ä¶';
      return;
    }
    const c = cMaybe || lastRows.find(r=>r.id===id) || {};
    const name=[c.first_name,c.last_name].filter(Boolean).join(' ') || (c.name||'‚Äî');
    $('#pName').textContent=name; $('#pEmail').textContent=c.email||'‚Äî'; $('#pPhone').textContent=c.phone||'‚Äî';
    $('#pJob').textContent=c.job_title||'‚Äî'; $('#pType').textContent=c.pay_type||'‚Äî'; $('#pStatus').textContent=c.status||'‚Äî';
    $('#pPayroll').textContent=c.payroll_ref||'‚Äî'; $('#pAddress').textContent=c.address||'‚Äî';
    loadTimesheetsFor(c.id).catch(e=> $('#pTimesheets').textContent='Timesheets unavailable: '+(e.message||e));
    loadAssignmentsFor(c.id).catch(e=> $('#pAssignments').textContent='Assignments unavailable: '+(e.message||e));
  }

  async function loadTimesheetsFor(id){
    if(!id){ $('#pTimesheets').textContent='Select a candidate‚Ä¶'; return; }
    $('#pTimesheets').innerHTML='<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    const res = await api('/admin-timesheets-list','POST',{ candidate_id:id, size:5 }).catch(()=>({rows:[]}));
    const rows = Array.isArray(res)?res:(res?.rows||[]);
    if(!rows.length){ $('#pTimesheets').textContent='No recent timesheets'; return; }
    $('#pTimesheets').innerHTML = `<ul style="margin:0 0 0 18px;padding:0;display:grid;gap:4px">
      ${rows.map(t=>`<li>${t.week_ending||t.period||t.created_at||''} ‚Äî ${(t.hours_total??t.total_hours??'')}h ‚Äî <span class="badge">${t.status||''}</span></li>`).join('')}
    </ul>`;
  }
  async function loadAssignmentsFor(id){
    if(!id){ $('#pAssignments').textContent='Select a candidate‚Ä¶'; return; }
    $('#pAssignments').innerHTML='<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    const res = await api('/admin-assignments-list','POST',{ candidate_id:id, size:5 }).catch(()=>({rows:[]}));
    const rows = Array.isArray(res)?res:(res?.rows||[]);
    if(!rows.length){ $('#pAssignments').textContent='No current assignments'; return; }
    $('#pAssignments').innerHTML = `<ul style="margin:0 0 0 18px;padding:0;display:grid;gap:4px">
      ${rows.map(a=>`<li>${a.client_name||a.client||''} ‚Äî ${a.job_title||a.role||''} ‚Äî <span class="badge">${a.status||''}</span></li>`).join('')}
    </ul>`;
  }

  // events
  $('#btnRefresh').onclick = ()=>{ page=1; loadList(); };
  ['#q','#fType','#fStatus','#fJob','#fEmailHas'].forEach(s=>{
    $(s).addEventListener('change', ()=>{ page=1; loadList(); });
    $(s).addEventListener('keyup', e=>{ if(e.key==='Enter'){ page=1; loadList(); }});
  });
  $('#pgPrev').onclick = ()=>{ if(page>1){ page--; loadList(); } };
  $('#pgNext').onclick = ()=>{ if(page<pages){ page++; loadList(); } };
  $('#pageSize').onchange = ()=>{ size=Number($('#pageSize').value)||25; localStorage.cand_size=size; page=1; loadList(); };

  $('#btnNew').onclick=()=> openEd(null);
  $('#btnClose').onclick=()=>{ ed.style.display='none'; cur=null; };
  $('#btnSave').onclick=async ()=>{
    try{
      const saved = await api('/admin-candidates-save','POST', getEd());
      toast('Saved ‚úì'); ed.style.display='none'; page=1; await loadList();
      if(saved?.id) { cur={id:saved.id}; openEd(saved.id); }
    }catch(e){ toast('Save failed: '+(e.message||e)); }
  };
  $('#btnDelete').onclick=async ()=>{
    if(!cur?.id) return toast('Nothing to delete');
    if(!confirm('Delete this candidate?')) return;
    try{ await api('/admin-candidates-delete','POST',{ id:cur.id }); toast('Deleted'); ed.style.display='none'; await loadList(); }
    catch(e){ toast('Delete failed: '+(e.message||e)); }
  };
  $('#btnEmails').onclick=()=>{
    const emails = lastRows.map(r=>r.email).filter(Boolean);
    if(!emails.length) return toast('No emails in current list');
    navigator.clipboard?.writeText(emails.join(', ')); toast(`Copied ${emails.length} email(s)`);
  };
  $('#btnExport').onclick=()=>{
    const rows = lastRows; if(!rows.length){ toast('Nothing to export'); return; }
    const cols=['id','first_name','last_name','email','phone','job_title','pay_type','status','payroll_ref','bank_sort_code','bank_account','bank_iban','bank_swift'];
    const csv=[cols.join(',')].concat(rows.map(r=>cols.map(k=>`"${String(r[k]??'').replace(/"/g,'""')}"`).join(','))).join('\n');
    const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000);
  };

  onKey?.('/', ()=> $('#q')?.focus()); onKey?.('KeyR', ()=> $('#btnRefresh').click());
  onKey?.('KeyN', ()=> $('#btnNew').click()); onKey?.('ArrowLeft', ()=> $('#pgPrev').click()); onKey?.('ArrowRight',()=> $('#pgNext').click());

  // first load
  await loadList();
})();
</script>
</body>
</html>
