<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Candidates ‚Äî Admin | HMJ-Global</title>

<!-- Netlify Identity + shared admin helpers -->
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>

<style>
  :root{
    --bg:#0b0f18; --panel:#111827; --border:#252f3f; --ink:#e6eef7; --muted:#9fb0c9;
    --card:#0f172a; --chip:#0e1629; --accent:#3A66B3; --danger:#ff6b6b; --ok:#22c55e;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:5}
  .row{max-width:1240px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}

  .wrap{max-width:1240px;margin:22px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.20)}
  .muted{color:var(--muted)}
  input,select{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  input:focus,select:focus,button:focus{outline:2px solid #2f3f69;outline-offset:2px}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;
       font-weight:600;cursor:pointer;transition:border-color .15s,transform .06s}
  .btn:hover{border-color:#3b4f79}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent}
  .btn.accent{background:var(--accent);border-color:#4262a6}
  .btn.danger{background:#3b1b22;border-color:#5a2a33}

  .pills{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{background:var(--card);border:1px solid #2c3853;border-radius:12px;padding:10px 14px;min-width:90px;text-align:center}
  .pill b{font-size:20px;display:block}

  .filters{display:grid;grid-template-columns:1.5fr .9fr .9fr 1fr 1fr auto 120px;gap:10px;margin:6px 0}
  .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end}

  .tableWrap{overflow:auto;border-radius:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
  thead th{position:sticky;top:0;background:#0e1426;z-index:1;user-select:none}
  thead th.sortable{cursor:pointer}
  thead th.sortable .arrow{opacity:.35;margin-left:6px}
  thead th.sortable.active .arrow{opacity:1}
  tbody tr:hover{background:#0e1629}
  tbody td:last-child{text-align:right}

  .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #2c3853;background:#0f172a;font-size:12px}
  .status-ok{background:#0e2a1e;border-color:#1e6646;color:#b9f6d0}
  .status-warn{background:#33220f;border-color:#8a5b25;color:#ffe8b3}
  .status-bad{background:#2a1214;border-color:#6a2b2f;color:#ffc7c7}

  .editor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .editor-grid label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .editor-grid .field{display:flex;flex-direction:column}
  .editor-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .hint{font-size:12px;color:var(--muted)}

  #toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:9999}
  #toast .toast{background:#0f172a;color:#e6edf6;border:1px solid #233044;border-radius:10px;padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #toast .toast.error{border-color:#5b2b2b;background:#221216}
  #toast .toast.ok{border-color:#1f5433;background:#0f1c17}
  #error-banner{display:none;background:#221216;border:1px solid #5b2b2b;color:#ffd8d8;padding:10px 12px;border-radius:10px}

  #dbg{position:fixed;left:16px;bottom:16px;max-width:40vw;min-width:320px;max-height:42vh;
       display:none;flex-direction:column;gap:8px;z-index:9999}
  #dbg .hdr{display:flex;gap:8px;align-items:center}
  #dbg .pane{background:#0f172a;border:1px solid #233044;border-radius:10px;padding:8px;overflow:auto}
  #dbg pre{white-space:pre-wrap;margin:0;font:12px ui-monospace, SFMono-Regular, Menlo, monospace;color:#cfe3ff}

  .loading{display:inline-flex;gap:8px;align-items:center}
  .dot{width:6px;height:6px;border-radius:50%;background:#7d8bb3;opacity:.6;animation:ld 1.2s infinite}
  .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
  @keyframes ld{0%{transform:translateY(0)}50%{transform:translateY(-4px);opacity:1}100%{transform:translateY(0)}}

  @media (max-width:980px){
    .filters{grid-template-columns:1fr 1fr 1fr}
    .editor-grid{grid-template-columns:1fr}
    thead th, tbody td{white-space:normal}
  }
</style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">Candidates ‚Äî Admin</div><div class="sp"></div>
    <a class="btn ghost" href="/admin/">‚üµ Admin home</a>
    <button class="btn" onclick="netlifyIdentity && netlifyIdentity.logout()">Sign out</button>
  </div></div>

  <!-- gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="why muted" style="margin:6px 0 12px"></p>
      <button class="btn accent" onclick="netlifyIdentity && netlifyIdentity.open('login')">Log in</button>
    </div>
  </div>

  <!-- app -->
  <div class="wrap" id="app" style="display:none">

    <!-- stats / actions -->
    <div class="card">
      <div class="pills">
        <div class="pill"><b id="kTotal">0</b>Total</div>
        <div class="pill"><b id="kFiltered">0</b>Filtered</div>
        <div class="pill"><b id="kPage">1/1</b>Page</div>
        <div class="sp"></div>
        <div class="inline">
          <button class="btn" id="btnRefresh" title="R">Refresh</button>
          <button class="btn accent" id="btnNew" title="N">New candidate</button>
          <button class="btn" id="btnExport">Export CSV</button>
          <button class="btn" id="btnEmails" title="Copy filtered emails">üìß Email list</button>
          <button class="btn" id="btnDebug">Debug</button>
        </div>
      </div>
      <div id="error-banner"></div>
    </div>

    <!-- filters -->
    <div class="card">
      <div class="filters">
        <input id="q" placeholder="Search name / email / phone" autocomplete="off"/>
        <select id="fType">
          <option value="">Any pay type</option>
          <option>Umbrella</option><option>Umbrella CIS</option>
          <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
          <option>International</option><option>International Umbrella</option>
        </select>
        <select id="fStatus">
          <option value="">Any status</option>
          <option>Complete</option><option>In progress</option><option>Paused</option>
        </select>
        <input id="fJob" placeholder="Job title" autocomplete="off"/>
        <input id="fEmailHas" placeholder="Email contains" autocomplete="off"/>

        <div class="pager">
          <button class="btn" id="pgPrev" title="PgUp">‚óÄ</button>
          <div style="min-width:84px;text-align:center"><span id="pgNow">1</span>/<span id="pgMax">1</span></div>
          <button class="btn" id="pgNext" title="PgDown">‚ñ∂</button>
        </div>

        <select id="pageSize" title="Rows / page">
          <option>25</option><option>50</option><option>100</option>
        </select>
      </div>
      <div class="hint">Tips: Press <span class="kbd">/</span> to focus search ‚Ä¢ <span class="kbd">R</span> refresh ‚Ä¢ <span class="kbd">N</span> new candidate ‚Ä¢ <span class="kbd">‚Üê/‚Üí</span> page</div>
    </div>

    <!-- list -->
    <div class="card tableWrap" id="listWrap">
      <div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>
    </div>

    <!-- editor -->
    <div class="card" id="editor" style="display:none">
      <h3 style="margin:0 0 10px" id="edTitle">Candidate</h3>
      <div class="editor-grid">
        <div class="field"><label>First name</label><input id="edFirst" autocomplete="off"></div>
        <div class="field"><label>Last name</label><input id="edLast" autocomplete="off"></div>

        <div class="field"><label>Email</label><input id="edEmail" type="email" autocomplete="off" spellcheck="false"></div>
        <div class="field"><label>Phone</label><input id="edPhone" autocomplete="off"></div>

        <div class="field"><label>Job title</label><input id="edJob" autocomplete="off"></div>
        <div class="field"><label>Pay type</label>
          <select id="edType">
            <option>Umbrella</option><option>Umbrella CIS</option>
            <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
            <option>International</option><option>International Umbrella</option>
          </select>
        </div>

        <div class="field"><label>Status</label>
          <select id="edStatus"><option>In progress</option><option>Complete</option><option>Paused</option></select>
        </div>
        <div class="field"><label>Payroll ref</label><input id="edPayroll" autocomplete="off"></div>

        <div class="field" style="grid-column:1 / -1"><label>Address</label><input id="edAddress" placeholder="Free-form address" autocomplete="off"></div>
      </div>

      <div class="editor-actions">
        <button class="btn accent" id="btnSave">Save</button>
        <button class="btn danger" id="btnDelete">Delete</button>
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <!-- mini debug console -->
  <div id="dbg">
    <div class="hdr">
      <button id="dbg-close" class="btn">Close debug</button>
      <div class="sp"></div>
      <label class="hint"><input id="dbg-verbose" type="checkbox"> verbose</label>
    </div>
    <div class="pane"><pre id="dbg-log"></pre></div>
  </div>

<script>
/* =============== Debug panel =============== */
(function(){
  const dbg = document.getElementById('dbg');
  const pre = document.getElementById('dbg-log');
  const btnClose = document.getElementById('dbg-close');
  const btnOpen = document.getElementById('btnDebug');

  function ts(){ const d=new Date(); return d.toISOString().split('T')[1].slice(0,12); }
  function line(kind, msg, data){
    const base = `[${ts()}] ${kind}: ${msg}`;
    const full = data ? (base + '\n' + JSON.stringify(data, null, 2)) : base;
    pre.textContent = pre.textContent ? (pre.textContent + '\n' + full) : full;
    pre.scrollTop = pre.scrollHeight;
    if (kind === 'ERR') console.error(msg, data||''); else
    if (kind === 'WARN') console.warn(msg, data||''); else
    console.log(msg, data||'');
  }

  window.__dbg = {
    show(){ dbg.style.display='flex'; },
    hide(){ dbg.style.display='none'; },
    log(msg, data){ line('LOG', msg, data||null); },
    warn(msg, data){ line('WARN', msg, data||null); },
    err(msg, data){ line('ERR', msg, data||null); }
  };

  btnClose.addEventListener('click', ()=>__dbg.hide());
  btnOpen.addEventListener('click', ()=>__dbg.show());

  const toastHost = document.getElementById('toast');
  window.toast = function(msg, kind){
    const t = document.createElement('div');
    t.className = 'toast' + (kind ? ' ' + kind : '');
    t.textContent = msg;
    toastHost.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(3px)'; }, 2600);
    setTimeout(()=>{ t.remove(); }, 3000);
  };
})();

/* =============== Helpers =============== */
(function(){
  window.$  = (s, root)=> (root||document).querySelector(s);
  window.$$ = (s, root)=> Array.from((root||document).querySelectorAll(s));

  window.setNum = (idOrSel, val)=>{
    const el = (idOrSel[0]==='#'||idOrSel[0]==='.') ? $(idOrSel) : $('#'+idOrSel);
    if(!el){ __dbg.warn('Counter el missing', { idOrSel, value:val }); return; }
    el.textContent = String(val);
  };

  window.showErrorBanner = (msg)=>{ const el=$('#error-banner'); if(!el) return; el.textContent='Error: '+String(msg||''); el.style.display='block'; };
  window.hideErrorBanner  = ()=>{ const el=$('#error-banner'); if(!el) return; el.style.display='none'; };

  window.debounce = (fn, ms)=>{ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms||300); }; };
})();

/* =============== API with ‚Äúdouble-JSON‚Äù auto-fix =============== */
(function(){
  function normalizePath(path){ return path[0]==='/' ? path : '/'+path; }

  // parse if server sent JSON string instead of JSON value
  function coerceJson(payload){
    if (typeof payload === 'string') {
      const s = payload.trim();
      if ((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))) {
        try { const j = JSON.parse(s); __dbg.warn('API payload was JSON string; parsed automatically.'); return j; }
        catch(e){ __dbg.err('Failed to parse JSON string payload', String(e)); }
      }
    }
    return payload;
  }

  window.apiCall = async function(path, method, body){
    path = normalizePath(path);
    method = method || 'POST';
    const url = '/.netlify/functions' + path;
    __dbg.log('API build request', { url, method, body });

    // use project helper if present
    if (window.__adminApiFetch) {
      try { const data = await __adminApiFetch(path, method, body); return coerceJson(data); }
      catch(e1){ __dbg.err('common.js fetch failed; using fallback', String(e1)); }
    }

    const headers = { 'Content-Type':'application/json' };
    try{
      if (window.netlifyIdentity && netlifyIdentity.currentUser) {
        const u = netlifyIdentity.currentUser();
        if (u && u.jwt) headers['Authorization'] = 'Bearer ' + (await u.jwt());
      }
    }catch(e){ __dbg.warn('JWT attach failed', String(e)); }

    let res;
    try{
      res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
      __dbg.log('Fetch complete', { status:res.status, ok:res.ok });
    }catch(e2){ __dbg.err('Network error', String(e2)); throw e2; }

    if (!res.ok) {
      let txt=''; try{ txt=await res.text(); }catch(_){}
      __dbg.err('HTTP not OK', { status:res.status, body:txt });
      throw new Error(txt || ('HTTP '+res.status));
    }

    const ctype = res.headers.get('content-type') || '';
    let payload = ctype.includes('application/json') ? await res.json() : await res.text();
    payload = coerceJson(payload);
    __dbg.log('API payload', payload);
    return payload;
  };
})();

/* =============== Admin Gate =============== */
(function(){
  window.__adminGate = async function(){
    __dbg.log('Gate: start');
    if (window.__ensureAdmin) { __dbg.log('Gate: using common.js'); return __ensureAdmin(); }

    return new Promise((resolve)=>{
      try{
        const u = window.netlifyIdentity && netlifyIdentity.currentUser ? netlifyIdentity.currentUser() : null;
        if (!u) {
          $('#app').style.display='none'; $('#gate').style.display=''; $('.why').textContent='Please log in with an admin account.';
          __dbg.warn('Gate: no user'); resolve(); return;
        }
        __dbg.log('Gate: user found', { email:u.email });
        $('#gate').style.display='none'; $('#app').style.display='';
        resolve();
      }catch(e){
        __dbg.err('Gate error', String(e));
        $('#app').style.display='none'; $('#gate').style.display=''; resolve();
      }
    });
  };
})();

/* =============== Boot =============== */
document.addEventListener('DOMContentLoaded', function(){
  start().catch(e=>{ __dbg.err('Fatal boot error', String(e)); showErrorBanner('Boot failed: '+String(e)); });
});

async function start(){
  await __adminGate();
  if ($('#app').style.display === 'none') return; // not signed in
  appMain();
}

/* =============== App =============== */
function appMain(){
  __dbg.log('App: init');

  // state
  let page = Number(localStorage.cand_page||1)||1;
  let size = Number(localStorage.cand_size||25)||25;
  let pages = 1;
  let cur = null;
  let lastRows = [];
  let sort = JSON.parse(localStorage.cand_sort || '{"key":"name","dir":"asc"}');

  const listWrap = $('#listWrap');
  const ed = $('#editor');

  // load saved filters
  let filters = {}; try{ filters = JSON.parse(localStorage.cand_filters || '{}'); }catch(_){}
  $('#q').value         = filters.q || '';
  $('#fType').value     = filters.type || '';
  $('#fStatus').value   = filters.status || '';
  $('#fJob').value      = filters.job || '';
  $('#fEmailHas').value = filters.emailHas || '';
  $('#pageSize').value  = String(size);

  function qv(sel){ return $(sel).value.trim(); }
  function saveFilters(){ const f = { q:qv('#q'), type:qv('#fType'), status:qv('#fStatus'), job:qv('#fJob'), emailHas:qv('#fEmailHas') }; localStorage.cand_filters=JSON.stringify(f); }
  function saveSort(){ localStorage.cand_sort=JSON.stringify(sort); }
  function setPageMeta(){ setNum('#pgNow', page); setNum('#pgMax', pages); $('#kPage').textContent = page + '/' + pages; }

  const headCols = [
    { key:'id',        label:'ID',      w:88  },
    { key:'name',      label:'Name',    w:240 },
    { key:'email',     label:'Email',   w:260 },
    { key:'phone',     label:'Phone',   w:160 },
    { key:'pay_type',  label:'Type',    w:170 },
    { key:'status',    label:'Status',  w:140 },
    { key:'actions',   label:'',        w:120, noSort:true }
  ];

  function statusBadge(s){
    const t = (s||'').toLowerCase();
    const cls = (t==='complete') ? 'status-ok' : (t==='in progress') ? 'status-warn' : 'status-bad';
    return '<span class="badge '+cls+'">'+(s||'‚Äî')+'</span>';
  }
  function typeBadge(t){ return '<span class="badge">'+(t||'‚Äî')+'</span>'; }

  function renderRows(rows){
    lastRows = rows || [];
    if(!lastRows.length){ listWrap.innerHTML = '<div class="muted">No candidates.</div>'; return; }

    const thead = '<thead><tr>' + headCols.map(c=>{
      const arrow = c.noSort ? '' : '<span class="arrow">'+(sort.key===c.key ? (sort.dir==='asc'?'‚ñ≤':'‚ñº') : '‚Üï')+'</span>';
      const cls = c.noSort ? '' : ('sortable ' + (sort.key===c.key ? 'active':''));
      const style = c.w ? ('style="width:'+c.w+'px"') : '';
      return '<th '+style+' data-key="'+c.key+'" class="'+cls+'">'+c.label+arrow+'</th>';
    }).join('') + '</tr></thead>';

    const tbody = '<tbody>' + lastRows.map(r=>{
      const name = (r.first_name || r.last_name) ? [r.first_name,r.last_name].filter(Boolean).join(' ') :
                   (r.name || '‚Äî');
      const email = r.email || '‚Äî';
      const phone = r.phone || '‚Äî';
      return (
        '<tr>' +
          '<td>'+ (r.id!=null ? r.id : '‚Äî') +'</td>' +
          '<td>'+ name +'</td>' +
          '<td>'+ email +'</td>' +
          '<td>'+ phone +'</td>' +
          '<td>'+ typeBadge(r.pay_type) +'</td>' +
          '<td>'+ statusBadge(r.status) +'</td>' +
          '<td><div class="inline" style="justify-content:flex-end"><button class="btn" data-open="'+(r.id||'')+'">Open</button></div></td>' +
        '</tr>'
      );
    }).join('') + '</tbody>';

    listWrap.innerHTML = '<table>'+thead+tbody+'</table>';

    $$('#listWrap button[data-open]').forEach(b=>{
      const idAttr = b.getAttribute('data-open');
      b.onclick = ()=> openEd(idAttr ? Number(idAttr) : null);
    });

    $$('#listWrap thead th.sortable').forEach(th=>{
      th.onclick = function(){
        const key = th.getAttribute('data-key');
        if (sort.key===key) sort.dir = (sort.dir==='asc'?'desc':'asc'); else { sort.key=key; sort.dir='asc'; }
        saveSort(); loadList();
      };
    });
  }

  function normalizeRows(raw){
    // Accept: array of candidates OR {rows,total,...}
    const rows = Array.isArray(raw) ? raw : (raw && raw.rows) ? raw.rows : [];
    // If items look like {id, name} (from clients), adapt minimally
    return rows.map(x=>{
      if (x && x.name && !x.first_name && !x.last_name) {
        return { id:x.id, first_name:x.name, last_name:'', email:x.email||'', phone:x.phone||'', job_title:x.job_title||'', pay_type:x.pay_type||'', status:x.status||'', payroll_ref:x.payroll_ref||'', address:x.address||'' };
      }
      return x;
    });
  }

  async function loadList(){
    hideErrorBanner();
    listWrap.innerHTML = '<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';

    try {
      // build request body (add debug here)
      const body = {
        q: qv('#q'),
        type: qv('#fType'),
        status: qv('#fStatus'),
        job: qv('#fJob'),
        emailHas: qv('#fEmailHas'),
        page,
        size,
        sort,
        debug: true              // ‚Üê temporary debug flag
      };
      __dbg.log('List: request body', body);

      // function filename is plural
      const res = await apiCall('/admin-candidates-lists', 'POST', body);

      // optional: show server-side debug payload if the function returns one
      if (res && res.debug) __dbg.log('API debug ‚Üí', res.debug);

      // tolerate JSON-string payloads and different shapes
      const rows = normalizeRows(res);
      const total    = (typeof res.total    === 'number') ? res.total    : rows.length;
      const filtered = (typeof res.filtered === 'number') ? res.filtered : rows.length;
      pages = Math.max(1, Number(res.pages || Math.ceil(filtered / size) || 1));
      if (page > pages) page = pages;

      setNum('#kTotal', total);
      setNum('#kFiltered', filtered);
      setPageMeta();
      __dbg.log('List: meta', { total, filtered, pages, page });

      renderRows(rows);

    } catch (e) {
      __dbg.err('List: load failed', String(e));
      showErrorBanner(e.message || 'Error');
      listWrap.innerHTML = '<div style="color:#ffb4b4">Error: '+(e.message || e)+'</div>';
    }
  }


  function setEd(c){
    $('#edTitle').textContent = (c && c.id) ? ('Candidate #'+c.id) : 'New candidate';
    $('#edFirst').value   = (c && c.first_name) || '';
    $('#edLast').value    = (c && c.last_name) || '';
    $('#edEmail').value   = (c && c.email) || '';
    $('#edPhone').value   = (c && c.phone) || '';
    $('#edJob').value     = (c && c.job_title) || '';
    $('#edType').value    = (c && c.pay_type) || 'Umbrella';
    $('#edStatus').value  = (c && c.status) || 'In progress';
    $('#edPayroll').value = (c && c.payroll_ref) || '';
    $('#edAddress').value = (c && c.address) || '';
  }
  function getEd(){
    return {
      id: cur && cur.id ? cur.id : undefined,
      first_name: $('#edFirst').value.trim() || null,
      last_name:  $('#edLast').value.trim() || null,
      email:      $('#edEmail').value.trim() || null,
      phone:      $('#edPhone').value.trim() || null,
      job_title:  $('#edJob').value.trim() || null,
      pay_type:   $('#edType').value || null,
      status:     $('#edStatus').value || null,
      payroll_ref:$('#edPayroll').value.trim() || null,
      address:    $('#edAddress').value.trim() || null
    };
  }

  async function openEd(id){
    hideErrorBanner();
    try{
      if (id) {
        __dbg.log('Editor: loading record', { id });
        cur = await apiCall('/admin-candidates-get','POST',{ id });
      } else {
        cur = { status:'In progress', pay_type:'Umbrella' };
      }
      setEd(cur);
      ed.style.display = '';
      ed.scrollIntoView({behavior:'smooth',block:'start'});
      $('#edFirst').focus();
    }catch(e){
      __dbg.err('Editor: open failed', String(e));
      toast('Open failed: '+(e.message||e), 'error');
    }
  }

  // events
  const doSearch = debounce(()=>{ page=1; saveFilters(); loadList(); }, 350);

  $('#btnRefresh').onclick = ()=> loadList();
  $('#q').addEventListener('input', doSearch);
  ['#fType','#fStatus','#fJob','#fEmailHas'].forEach(sid=>{
    $(sid).addEventListener('change', ()=>{ page=1; saveFilters(); loadList(); });
    $(sid).addEventListener('keyup',  e=>{ if(e.key==='Enter'){ page=1; saveFilters(); loadList(); } });
  });

  $('#pgPrev').onclick = ()=>{ if(page>1){ page--; localStorage.cand_page=page; loadList(); } };
  $('#pgNext').onclick = ()=>{ if(page<pages){ page++; localStorage.cand_page=page; loadList(); } };
  $('#pageSize').onchange = ()=>{ size = Number($('#pageSize').value)||25; localStorage.cand_size=size; page=1; loadList(); };

  $('#btnNew').onclick  = ()=> openEd(null);
  $('#btnClose').onclick= ()=>{ ed.style.display='none'; cur=null; };

  $('#btnSave').onclick = async ()=>{
    try{
      const data = getEd();
      __dbg.log('Editor: saving', data);
      const saved = await apiCall('/admin-candidates-save','POST', data);
      toast('Saved','ok');
      ed.style.display='none';
      page=1;
      await loadList();
      if(saved && saved.id){ openEd(saved.id); }
    }catch(e){ toast('Save failed: '+(e.message||e),'error'); __dbg.err('Editor: save failed', String(e)); }
  };

  $('#btnDelete').onclick = async ()=>{
    if(!cur || !cur.id){ toast('Nothing to delete','error'); return; }
    if(!confirm('Delete this candidate?')) return;
    try{
      __dbg.log('Editor: deleting', { id:cur.id });
      await apiCall('/admin-candidates-delete','POST',{ id: cur.id });
      toast('Deleted','ok');
      ed.style.display='none';
      await loadList();
    }catch(e){ toast('Delete failed: '+(e.message||e),'error'); __dbg.err('Editor: delete failed', String(e)); }
  };

  $('#btnEmails').onclick = ()=>{
    const emails = lastRows.map(r=>r.email).filter(Boolean);
    if(!emails.length){ toast('No emails in current list','error'); return; }
    navigator.clipboard?.writeText(emails.join(', '));
    toast('Copied '+emails.length+' email(s)','ok');
  };

  $('#btnExport').onclick = ()=>{
    const rows = lastRows;
    if(!rows.length){ toast('Nothing to export','error'); return; }
    const cols = ['id','first_name','last_name','email','phone','job_title','pay_type','status','payroll_ref'];
    const head = cols.join(',');
    const csv = [head].concat(rows.map(r=> cols.map(k=>{
      const v = (r[k]!==undefined && r[k]!==null) ? r[k] : '';
      const s = String(v).replace(/"/g,'""');
      return '"' + s + '"';
    }).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  };

  // keyboard shortcuts
  document.addEventListener('keydown', e=>{
    if(e.key==='/'){ e.preventDefault(); $('#q').focus(); return; }
    if(e.key==='r' || e.key==='R'){ e.preventDefault(); loadList(); return; }
    if(e.key==='n' || e.key==='N'){ e.preventDefault(); openEd(null); return; }
    if(e.key==='ArrowLeft'){ if(page>1){ page--; localStorage.cand_page=page; loadList(); } }
    if(e.key==='ArrowRight'){ if(page<pages){ page++; localStorage.cand_page=page; loadList(); } }
  });

  // initial
  loadList();
}
</script>
</body>
</html>
