<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Candidates — Admin | HMJ Global</title>

  <!-- Pin Identity to live site (one way is enough; pick ONE of these) -->
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>

  <!-- Identity widget FIRST -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Shared admin bootstrap -->
  <script defer src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script defer src="/admin/common.js?v=21"></script>

  <style>
    :root{
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#2f4ea2; --blue-2:#27408f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --success:#16a34a; --danger:#dc2626; --warn:#f59e0b;
      --chip:#eef2ff;
    }
    * { box-sizing: border-box; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:50;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1400px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .brand a{display:inline-flex;gap:8px;align-items:center;color:#fff;text-decoration:none}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;display:grid;place-items:center;color:var(--blue);font-weight:900}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;user-select:none}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px;font-weight:700}
    .btn.danger{background:#7a1f28;border-color:#7a1f28}
    .btn.icon{display:inline-grid;grid-auto-flow:column;gap:8px;align-items:center}
    .wrap{max-width:1400px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .bar{position:sticky;top:64px;z-index:45;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=text], input[type=search], input[type=date], input[type=email], select, textarea{
      border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;min-width:180px;font:inherit
    }
    input[type=search]{ min-width:280px; }
    table{border-collapse:separate;border-spacing:0;width:100%;background:#fff;border:1px solid var(--stroke);border-radius:14px;overflow:hidden}
    thead th{position:sticky;top:0;background:#fbfdff;border-bottom:1px solid var(--stroke);text-align:left;padding:8px 10px;font-weight:800}
    tbody td{border-top:1px solid var(--stroke);padding:8px 10px;vertical-align:middle;line-height:1.35}
    tbody tr:hover{background:#f8fafc}
    .muted{color:var(--muted)}
    .pill{display:inline-grid;align-items:center;padding:4px 10px;border-radius:9999px;border:1px solid #dbeafe;background:#eef2ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .b-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .b-warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .b-bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:9999px;border:1px solid var(--stroke);cursor:pointer;background:#fff;font-weight:700}
    .chip.active{background:var(--chip)}
    .doc-sections{display:grid;gap:14px}
    .doc-section{background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:12px;display:grid;gap:10px}
    .doc-section h5{margin:0;font-size:14px;color:var(--ink);display:flex;align-items:center;gap:8px}
    .doc-actions{display:flex;gap:8px;flex-wrap:wrap}
    .doc-actions button{border-radius:10px;font-weight:700}
    .drop-zone{border:2px dashed var(--stroke);border-radius:12px;padding:14px;display:grid;place-items:center;text-align:center;font-size:13px;color:var(--muted);background:#f8fafc;transition:border-color .2s,color .2s,background .2s}
    .drop-zone strong{color:var(--blue)}
    .drop-zone.drag{border-color:var(--blue);color:var(--blue);background:#eef2ff}
    .doc-list{display:grid;gap:8px;max-height:180px;overflow:auto}
    .doc-row{display:flex;align-items:center;gap:10px;justify-content:space-between;font-size:13px;background:#fff;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px}
    .doc-row a{color:var(--blue);text-decoration:none;font-weight:700}
    .doc-row button{border:0;background:transparent;color:var(--danger);font-weight:700;cursor:pointer}
    .doc-row .meta{font-size:12px;color:var(--muted)}
    .metrics{display:flex;gap:12px;flex-wrap:wrap}
    .metric{background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-weight:800}
    .menu{position:relative}
    .menu > .sheet{display:none;position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--stroke);border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,.18);min-width:220px;padding:8px}
    .menu.open > .sheet{display:block}
    .sheet label{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .sheet label:hover{background:#f8fafc}
    /* Layout with QuickView */
    .grid-main{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
    @media (max-width:1100px){ .grid-main{grid-template-columns:1fr} }
    .qv{position:sticky;top:116px;background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:14px;min-height:120px}
    .qv h4{margin:0 0 8px}
    .qv .rows{display:grid;grid-template-columns:1fr;gap:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px}
    .kv b{color:#334155}
    /* Drawer (editor) */
    .drawer{position:fixed;inset:0 0 0 auto;max-width:760px;width:95vw;background:#fff;box-shadow:-4px 0 24px rgba(2,6,23,.24);transform:translateX(100%);transition:transform .24s ease;z-index:60;display:grid;grid-template-rows:auto 1fr auto}
    .drawer.open{transform:translateX(0)}
    .d-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--stroke);background:var(--card)}
    .d-body{padding:16px;overflow:auto}
    .d-foot{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--stroke);background:#fff}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 12px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:#fff;cursor:pointer;font-weight:700}
    .tab.active{background:var(--chip)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
    .field{display:grid;gap:6px}
    .field label{font-weight:700;font-size:13px}
    .hr{height:1px;background:var(--stroke);margin:8px 0 4px}
    .right{display:flex;gap:8px;align-items:center}
    .link{color:var(--blue);text-decoration:underline;cursor:pointer}
    :focus{outline:3px solid var(--ring);outline-offset:2px;border-radius:8px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  </style>
</head>

<body>

  <!-- Header -->
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Candidates</span>
    </div>
    <div class="sp"></div>
    <a class="btn ghost" href="/">← Website</a>
    <div id="diagChips" class="chips"></div>
    <a class="btn ghost" href="./">⟵ Admin</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <!-- toolbar -->
    <div class="card bar">
      <input id="q" type="search" placeholder="Search name, email, ref…" />
      <div class="chips" id="statusChips">
        <span data-status="" class="chip active">All</span>
        <span data-status="In progress" class="chip">In progress</span>
        <span data-status="Complete" class="chip">Complete</span>
        <span data-status="Archived" class="chip">Archived</span>
      </div>
      <button class="btn small" id="btnRefresh">Refresh</button>

      <div class="sp"></div>

      <div class="menu" id="colMenu">
        <button class="btn ghost small icon" id="btnCols">Columns ▾</button>
        <div class="sheet" id="colSheet"></div>
      </div>

      <input type="file" id="csv" accept=".csv" style="display:none">
      <button class="btn ghost small" id="btnExport">Export CSV</button>
      <button class="btn ghost small" id="btnExportSel" disabled>Export selected</button>
      <button class="btn ghost small" id="btnImport">Import CSV</button>
      <button class="btn small" id="btnNew">+ New candidate</button>
      <button class="btn danger small" id="btnDelete" disabled>Delete</button>
    </div>

    <!-- metrics -->
    <div class="metrics" id="metrics"></div>

    <!-- main grid: table + quickview -->
    <div class="grid-main">
      <div>
        <div class="card" id="listWrap">Loading…</div>
        <div class="pager" id="pager" style="display:none">
          <div class="muted" id="pgInfo"></div>
          <div class="sp"></div>
          <select id="pgSize">
            <option selected>10</option><option>25</option><option>50</option><option>100</option>
          </select>
          <button class="btn small ghost" id="pgPrev">◀</button>
          <button class="btn small ghost" id="pgNext">▶</button>
        </div>
      </div>

      <aside class="qv" id="qv" aria-live="polite">
        <h4 class="muted">Quick view</h4>
        <div class="rows" id="qvRows">
          <div class="empty">Select a candidate to preview details here.</div>
        </div>
        <div class="hr"></div>
        <div class="right">
          <a id="qvOpen" class="btn light small" href="#" style="display:none">Open full profile</a>
          <button id="qvEdit" class="btn light small" style="display:none">Edit</button>
          <button id="qvClose" class="btn light small" style="display:none">Close</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Drawer editor -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <strong id="dTitle">New candidate</strong>
      <span class="sp"></span>
      <button class="btn ghost small" id="btnClose">✕ Close</button>
    </div>
    <div class="d-body">
      <div class="tabs" id="tabs"></div>
      <form id="frm" class="grid" autocomplete="off"></form>
      <div class="field" id="docField">
        <label>Documents &amp; CV</label>
        <div class="doc-sections">
          <div class="doc-section" aria-labelledby="generalDocsLabel">
            <h5 id="generalDocsLabel">General documents</h5>
            <div class="drop-zone" id="docDropGeneral" tabindex="0" role="button" aria-label="Drop general documents">
              <div><strong>Drop files</strong> or use the buttons below.</div>
            </div>
            <div class="doc-actions">
              <button class="btn ghost small" id="btnParseCv" type="button">Parse CV</button>
              <button class="btn ghost small" id="btnUploadCv" type="button">Upload file</button>
            </div>
            <div class="doc-list" id="docListGeneral"><div class="muted">No documents yet.</div></div>
          </div>
          <div class="doc-section" aria-labelledby="complianceDocsLabel">
            <h5 id="complianceDocsLabel">Compliance</h5>
            <div class="drop-zone" id="docDropCompliance" tabindex="0" role="button" aria-label="Drop compliance documents">
              <div><strong>Drop compliance files</strong> such as certificates or signed terms.</div>
            </div>
            <div class="doc-actions">
              <button class="btn ghost small" id="btnUploadCompliance" type="button">Upload compliance file</button>
              <button class="btn ghost small" id="btnSendTerms" type="button">Send terms for signature</button>
            </div>
            <div class="doc-list" id="docListCompliance"><div class="muted">No compliance documents yet.</div></div>
            <div class="muted" id="termsStatus" style="font-size:12px"></div>
          </div>
        </div>
        <input type="file" id="cvInput" accept=".pdf,.doc,.docx,.txt" multiple style="display:none"/>
      </div>
    </div>
    <div class="d-foot">
      <div class="muted">Ref: <span id="dRef">—</span></div>
      <div class="right">
        <button class="btn ghost" id="btnSaveDraft" type="button">Save</button>
        <button class="btn" id="btnSaveClose" type="button">Save & Close</button>
      </div>
    </div>
  </aside>

  <!-- Toast host -->
  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- Embedded fallback dataset so previews always render something -->
  <script type="application/json" id="candidatesFallbackData">
    {
      "candidates": [
        {
          "id": 101,
          "ref": "HMJ-101",
          "first_name": "Ava",
          "last_name": "Miles",
          "email": "ava.miles@example.com",
          "phone": "+44 7700 900101",
          "status": "In progress",
          "job_title": "Senior Quantity Surveyor",
          "client_name": "Hull Pharma Fitout",
          "pay_type": "PAYE",
          "payroll_ref": "PAY101",
          "internal_ref": "INT-101",
          "address1": "10 Riverside Way",
          "town": "Leeds",
          "county": "West Yorkshire",
          "postcode": "LS1 2AB",
          "country": "United Kingdom",
          "notes": "Immediately available. Data centre specialist with NEC4 experience.",
          "created_at": "2024-01-04T09:30:00Z",
          "updated_at": "2024-03-12T15:20:00Z",
          "pay_type_label": "PAYE",
          "payroll_rate": 450,
          "bank_name": "NatWest",
          "bank_sort_code": "12-34-56",
          "bank_account": "12345678",
          "emergency_name": "Oliver Miles",
          "emergency_phone": "+44 7700 900501",
          "tax_id": "NT123456C",
          "timesheet_status": "In progress"
        },
        {
          "id": 102,
          "ref": "HMJ-102",
          "first_name": "Leo",
          "last_name": "Campbell",
          "email": "leo.campbell@example.com",
          "phone": "+44 7700 900102",
          "status": "Complete",
          "job_title": "MEP Project Manager",
          "client_name": "Eemshaven Hyperscale",
          "pay_type": "PSC",
          "payroll_ref": "PSC102",
          "internal_ref": "INT-204",
          "address1": "48 Baltic Wharf",
          "town": "Newcastle",
          "county": "Tyne and Wear",
          "postcode": "NE1 5XD",
          "country": "United Kingdom",
          "notes": "Dutch residency, fluent in English/German.",
          "created_at": "2024-01-18T11:00:00Z",
          "updated_at": "2024-04-28T09:10:00Z",
          "pay_type_label": "PSC",
          "payroll_rate": 520,
          "bank_name": "Monzo",
          "bank_sort_code": "04-00-04",
          "bank_account": "22223334",
          "emergency_name": "Charlotte Campbell",
          "emergency_phone": "+44 7700 911102",
          "timesheet_status": "Complete"
        },
        {
          "id": 103,
          "ref": "HMJ-103",
          "first_name": "Ella",
          "last_name": "Thompson",
          "email": "ella.thompson@example.com",
          "phone": "+44 7700 900103",
          "status": "Archived",
          "job_title": "CSA Package Manager",
          "client_name": "Smith & Nephew",
          "pay_type": "PAYE",
          "payroll_ref": "PAY203",
          "internal_ref": "INT-305",
          "address1": "5 Orchard Way",
          "town": "Cambridge",
          "county": "Cambridgeshire",
          "postcode": "CB1 3AX",
          "country": "United Kingdom",
          "notes": "Relocated to Canada. Keep for future remote roles.",
          "created_at": "2023-11-10T10:15:00Z",
          "updated_at": "2024-02-02T12:05:00Z",
          "pay_type_label": "PAYE",
          "payroll_rate": 380,
          "bank_name": "HSBC",
          "bank_sort_code": "40-11-60",
          "bank_account": "44556677",
          "emergency_name": "Daniel Thompson",
          "emergency_phone": "+44 7700 921103",
          "timesheet_status": "Archived"
        },
        {
          "id": 104,
          "ref": "HMJ-104",
          "first_name": "Noah",
          "last_name": "Patel",
          "email": "noah.patel@example.com",
          "phone": "+44 7700 900104",
          "status": "In progress",
          "job_title": "Electrical Supervisor",
          "client_name": "DataSpark",
          "pay_type": "Umbrella",
          "payroll_ref": "UMB104",
          "internal_ref": "INT-409",
          "address1": "88 Foundry Lane",
          "town": "Birmingham",
          "county": "West Midlands",
          "postcode": "B3 1DX",
          "country": "United Kingdom",
          "notes": "HV/MV background. Needs IPAF renewal in July.",
          "created_at": "2024-02-12T08:00:00Z",
          "updated_at": "2024-05-01T17:40:00Z",
          "pay_type_label": "Umbrella",
          "payroll_rate": 32,
          "bank_name": "Barclays",
          "bank_sort_code": "20-45-23",
          "bank_account": "76543210",
          "emergency_name": "Priya Patel",
          "emergency_phone": "+44 7700 932104",
          "timesheet_status": "In progress"
        },
        {
          "id": 105,
          "ref": "HMJ-105",
          "first_name": "Sienna",
          "last_name": "Hughes",
          "email": "sienna.hughes@example.com",
          "phone": "+44 7700 900105",
          "status": "Complete",
          "job_title": "Document Controller",
          "client_name": "Hull Pharma Fitout",
          "pay_type": "PAYE",
          "payroll_ref": "PAY305",
          "internal_ref": "INT-510",
          "address1": "22 Dock Street",
          "town": "Hull",
          "county": "East Yorkshire",
          "postcode": "HU1 1TB",
          "country": "United Kingdom",
          "notes": "Rolling off in June. Prefers hybrid roles.",
          "created_at": "2024-03-05T13:45:00Z",
          "updated_at": "2024-04-30T11:15:00Z",
          "pay_type_label": "PAYE",
          "payroll_rate": 220,
          "bank_name": "Santander",
          "bank_sort_code": "09-01-26",
          "bank_account": "99887766",
          "emergency_name": "George Hughes",
          "emergency_phone": "+44 7700 943105",
          "timesheet_status": "Complete"
        }
      ]
    }
  </script>
  <script>
    (function seedCandidateFallback(){
      try {
        const el = document.getElementById('candidatesFallbackData');
        const raw = el ? el.textContent : '';
        if (raw && !window.CANDIDATES_FALLBACK) {
          window.CANDIDATES_FALLBACK = JSON.parse(raw);
        }
      } catch (err) {
        console.warn('[candidates] fallback seed failed', err);
      }
    })();
  </script>

  <!-- Single page boot -->
  <script>
  (function startCandidates(){
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function' || !window.netlifyIdentity) {
      return setTimeout(startCandidates, 30);
    }

    window.Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
      // --- diag chips ---
      const chips = sel('#diagChips');
      const chip = (t, tone='ok', key='') => {
        if (!chips) return;
        if (key) {
          const existing = chips.querySelector(`[data-chip="${key}"]`);
          if (existing) existing.remove();
        }
        const s=document.createElement('span');
        s.className='pill '+(tone==='ok'?'b-ok':tone==='warn'?'b-warn':'b-bad');
        if (key) s.dataset.chip = key;
        s.textContent=t; chips.appendChild(s);
      };
      chip('candidates:init','ok','init');

      const who = await identity('admin');
      if (!who || !who.ok) {
        chip('role: blocked','bad');
        const g = sel('#gate'), app = sel('#app');
        if (app) app.style.display = 'none';
        if (g) { g.style.display = ''; const why=g.querySelector('.why'); if (why) why.textContent='Restricted. Sign in with an admin account.'; }
        return;
      }
      chip('role: admin','ok'); chip('token: ok','ok'); chip('trace: '+getTrace().slice(0,10),'ok');

      // ----- state -----
      let allRows = [];
      let viewRows = [];
      let selected = new Set();
      let sort = { key:'id', dir:'desc' };
      let editing = null;
      let draft = {};
      let currentTab = 'Basics';
      let page = 1, pageSize = 10;
      let activeStatus = '';
      let readOnlyMode = false;
      let firstLoadComplete = false;

      const columns = [
        { key:'ref',        label:'Ref',    show:true, width:'100px' },
        { key:'name',       label:'Name',   show:true },
        { key:'email',      label:'Email',  show:true },
        { key:'phone',      label:'Phone',  show:true, width:'140px' },
        { key:'status',     label:'Status', show:true, width:'130px' },
        { key:'job_title',  label:'Job Title', show:true },
        { key:'client_name',label:'Client', show:false },
        { key:'updated_at', label:'Updated', show:false, width:'150px' },
      ];

      const docListGeneral = sel('#docListGeneral');
      const docListCompliance = sel('#docListCompliance');
      const docDropGeneral = sel('#docDropGeneral');
      const docDropCompliance = sel('#docDropCompliance');
      const cvInput = sel('#cvInput');
      const btnParseCv = sel('#btnParseCv');
      const btnUploadCv = sel('#btnUploadCv');
      const btnUploadCompliance = sel('#btnUploadCompliance');
      const btnSendTerms = sel('#btnSendTerms');
      const termsStatus = sel('#termsStatus');
      const PDF_SCRIPT_SRC = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js';
      const PDF_WORKER_SRC = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
      let pdfJsPromise = null;
      function ensurePdfJs(){
        if (window.pdfjsLib?.GlobalWorkerOptions) {
          return Promise.resolve(window.pdfjsLib);
        }
        if (pdfJsPromise) return pdfJsPromise;
        pdfJsPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = PDF_SCRIPT_SRC;
          script.async = true;
          script.onload = () => {
            if (window.pdfjsLib?.GlobalWorkerOptions) {
              window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER_SRC;
            }
            resolve(window.pdfjsLib);
          };
          script.onerror = () => {
            pdfJsPromise = null;
            reject(new Error('Failed to load PDF parser'));
          };
          document.head.appendChild(script);
        });
        return pdfJsPromise;
      }
      let currentDocs = [];
      let localDocs = [];
      let pendingUploads = [];
      let cvMode = 'parse';
      let lastTermsSentAt = null;
      const LOCAL_DOCS_KEY = 'hmj_candidate_docs_local';

      const $ = sel;
      const enableDelete = () => {
        const deleteDisabled = readOnlyMode || selected.size === 0;
        const delBtn = $('#btnDelete');
        if (delBtn) delBtn.disabled = deleteDisabled;
        const exportSel = $('#btnExportSel');
        if (exportSel) exportSel.disabled = selected.size === 0;
      };
      const drawer = $('#drawer');
      const openDrawer = () => drawer.classList.add('open');
      const closeDrawer = () => { drawer.classList.remove('open'); setTimeout(()=>resetForm(),150); };
      $('#btnClose').onclick = closeDrawer;

      const readOnlyBanner = document.createElement('div');
      readOnlyBanner.className = 'card';
      readOnlyBanner.style.display = 'none';
      readOnlyBanner.style.marginBottom = '16px';
      readOnlyBanner.innerHTML = '<strong>Preview mode.</strong> Supabase is not configured so changes are read-only in this deploy.';
      const appWrap = $('#app .wrap') || $('#app');
      if (appWrap && appWrap.firstChild) {
        appWrap.insertBefore(readOnlyBanner, appWrap.firstChild);
      } else if (appWrap) {
        appWrap.appendChild(readOnlyBanner);
      }

      let readOnlyChipSet = false;
      function applyReadOnly() {
        const disabledSelectors = ['#btnNew', '#btnDelete', '#btnImport', '#btnSaveDraft', '#btnSaveClose'];
        disabledSelectors.forEach((selector) => {
          const el = $(selector);
          if (!el) return;
          const shouldDisable = readOnlyMode;
          el.disabled = shouldDisable || (selector === '#btnDelete' && selected.size === 0);
        });
        if (readOnlyMode) {
          readOnlyBanner.style.display = '';
          if (!readOnlyChipSet) {
            chip('supabase: offline', 'warn');
            readOnlyChipSet = true;
          }
        } else {
          readOnlyBanner.style.display = 'none';
        }
        enableDelete();
      }

      function pillForStatus(s){
        const tone = s==='Complete' ? 'b-ok' : s==='Archived' ? 'b-bad' : 'b-warn';
        return `<span class="pill ${tone}">${s||'In progress'}</span>`;
      }

      function fmtDate(d){
        try{ return new Date(d).toLocaleString(); }catch{ return d||'—'; }
      }

      function computeMetrics(rows){
        const total = rows.length;
        const by = (st) => rows.filter(r => (r.status||'In progress')===st).length;
        $('#metrics').innerHTML = `
          <div class="metric">Total: ${total}</div>
          <div class="metric">In progress: ${by('In progress')}</div>
          <div class="metric">Complete: ${by('Complete')}</div>
          <div class="metric">Archived: ${by('Archived')}</div>`;
      }

      function buildColMenu(){
        const host = $('#colSheet'); host.innerHTML = '';
        columns.forEach((c, idx)=>{
          const id = 'col_'+c.key;
          const row = document.createElement('label');
          row.innerHTML = `<input type="checkbox" id="${id}" ${c.show?'checked':''}/> ${c.label}`;
          row.querySelector('input').onchange = (e)=>{ columns[idx].show = e.target.checked; render(); };
          host.appendChild(row);
        });
        const menu = $('#colMenu');
        $('#btnCols').onclick = ()=> menu.classList.toggle('open');
        document.addEventListener('click',(e)=>{
          if (!menu.contains(e.target)) menu.classList.remove('open');
        });
      }

      function buildHeader(){
        const heads = [];
        heads.push(`<th style="width:28px"><input id="ckAll" type="checkbox" ${selected.size && viewRows.length && selected.size>=viewRows.length?'checked':''}></th>`);
        columns.forEach(c=>{
          if(!c.show) return;
          const arrow = sort.key===c.key ? (sort.dir==='asc'?'▲':'▼') : '';
          heads.push(`<th style="${c.width?`width:${c.width}`:''};cursor:pointer" data-sort="${c.key}">${c.label} ${arrow}</th>`);
        });
        heads.push(`<th style="width:120px"></th>`);
        return `<thead><tr>${heads.join('')}</tr></thead>`;
      }

      function applyFilters(){
        const q = ($('#q')?.value || '').trim().toLowerCase();
        viewRows = allRows.filter(r=>{
          const hit = (v) => (String(v||'').toLowerCase().includes(q));
          const okQ = !q || hit(r.ref)||hit(r.first_name)||hit(r.last_name)||hit(r.email)||hit(r.phone)||hit(r.job_title);
          const okS = !activeStatus || (r.status||'In progress')===activeStatus;
          return okQ && okS;
        });
        viewRows.sort((a,b)=>{
          const ka = sort.key==='name' ? ((a.first_name||'')+' '+(a.last_name||'')) : (a[sort.key] ?? '');
          const kb = sort.key==='name' ? ((b.first_name||'')+' '+(b.last_name||'')) : (b[sort.key] ?? '');
          if (ka==kb) return 0;
          return (ka>kb?1:-1) * (sort.dir==='asc'?1:-1);
        });
        computeMetrics(viewRows);
      }

      function renderPager(){
        const host = $('#pager');
        if (!viewRows.length){ host.style.display='none'; return; }
        host.style.display='';
        const totalPages = Math.max(1, Math.ceil(viewRows.length / pageSize));
        if (page>totalPages) page = totalPages;
        $('#pgInfo').textContent = `Page ${page} of ${totalPages} (${viewRows.length} items)`;
        $('#pgPrev').disabled = page<=1;
        $('#pgNext').disabled = page>=totalPages;
      }

      function render(){
        applyFilters();
        const wrap = $('#listWrap');
        if (!viewRows.length) { wrap.innerHTML = `<div class="empty">No candidates match your filters.</div>`; renderPager(); return; }

        const start = (page-1)*pageSize;
        const rows = viewRows.slice(start, start+pageSize);

        const body = rows.map(r=>{
          const cells = [];
          cells.push(`<td><input type="checkbox" data-id="${r.id}" ${selected.has(r.id)?'checked':''}></td>`);
          columns.forEach(c=>{
            if(!c.show) return;
            let val = '—';
            if (c.key==='name') val = `${r.first_name||'—'} ${r.last_name||''}`.trim();
            else if (c.key==='status') val = pillForStatus(r.status||'In progress');
            else if (c.key==='updated_at') val = fmtDate(r.updated_at||r.created_at);
            else val = r[c.key] ?? '—';
            cells.push(`<td>${val}</td>`);
          });
          cells.push(`<td>
            <button class="btn light small" data-open="${r.id}">Open</button>
            <button class="btn light small" data-quick="${r.id}">Quick view</button>
          </td>`);
          return `<tr data-row="${r.id}">${cells.join('')}</tr>`;
        }).join('');

        wrap.innerHTML = `<table>${buildHeader()}<tbody>${body}</tbody></table>`;
        renderPager();

        wrap.querySelectorAll('th[data-sort]').forEach(th=>{
          th.onclick = ()=>{
            const k = th.getAttribute('data-sort');
            if (sort.key===k) sort.dir = (sort.dir==='asc'?'desc':'asc');
            else { sort.key = k; sort.dir = 'asc'; }
            render();
          };
        });
        const ckAll = $('#ckAll');
        if (ckAll) ckAll.onclick = (e)=>{
          const ids = rows.map(r=>r.id);
          if (e.target.checked) ids.forEach(id=>selected.add(id));
          else ids.forEach(id=>selected.delete(id));
          enableDelete(); render();
        };

        wrap.querySelectorAll('input[type=checkbox][data-id]').forEach(c=>{
          c.onchange = ()=>{
            const id = Number(c.getAttribute('data-id'));
            if (c.checked) selected.add(id); else selected.delete(id);
            enableDelete();
          };
        });
        wrap.querySelectorAll('[data-open]').forEach(b=>{
          b.onclick = ()=> openOne(Number(b.getAttribute('data-open')));
        });
        wrap.querySelectorAll('tr[data-row]').forEach(tr=>{
          tr.addEventListener('click',(e)=>{
            if (e.target.closest('button') || e.target.closest('input')) return;
            const id = Number(tr.getAttribute('data-row'));
            showQuick(id);
          });
        });
        wrap.querySelectorAll('[data-quick]').forEach(b=>{
          b.onclick = (e)=>{ e.stopPropagation(); showQuick(Number(b.getAttribute('data-quick'))); };
        });
      }

      function renderQuick(r){
        const host = $('#qvRows');
        const closeBtn = $('#qvClose');
        if (!r){
          host.innerHTML = `<div class="empty">Select a candidate to preview details here.</div>`;
          $('#qvOpen').style.display='none';
          $('#qvEdit').style.display='none';
          if (closeBtn) closeBtn.style.display='none';
          return;
        }
        const name = `${r.first_name||''} ${r.last_name||''}`.trim() || '—';
        const assignmentsLink = `/admin/assignments.html?q=${encodeURIComponent(name || r.ref || '')}`;
        const timesheetsLink = `/admin/timesheets.html?candidate=${encodeURIComponent(name || '')}`;
        host.innerHTML = `
          <div class="kv"><b>Name</b><div>${name}</div></div>
          <div class="kv"><b>Email</b><div>${r.email||'—'}</div></div>
          <div class="kv"><b>Phone</b><div>${r.phone||'—'}</div></div>
          <div class="kv"><b>Status</b><div>${pillForStatus(r.status||'In progress')}</div></div>
          <div class="kv"><b>Job title</b><div>${r.job_title||'—'}</div></div>
          <div class="kv"><b>Client</b><div>${r.client_name||'—'}</div></div>
          <div class="kv"><b>Payroll ref</b><div>${r.payroll_ref||'—'}</div></div>
          <div class="kv"><b>Timesheets</b><div>${r.timesheet_status||'—'} · <a class="link" href="${timesheetsLink}" target="_blank" rel="noopener">Open board</a></div></div>
          <div class="kv"><b>Assignments</b><div><a class="link" href="${assignmentsLink}" target="_blank" rel="noopener">View linked assignments</a></div></div>
          <div class="kv"><b>Address</b><div>${r.address1||''} ${r.address2||''} ${r.town||''} ${r.county||''} ${r.postcode||''} ${r.country||''}</div></div>
          <div class="kv"><b>Updated</b><div>${fmtDate(r.updated_at||r.created_at)}</div></div>`;
        const link = `/admin/candidate-profile.html?id=${encodeURIComponent(r.id)}`;
        $('#qvOpen').href = link; $('#qvOpen').style.display='';
        $('#qvEdit').style.display=''; $('#qvEdit').onclick = ()=> openEditor(r);
        if (closeBtn) { closeBtn.style.display=''; closeBtn.onclick = ()=> renderQuick(null); }
      }

      function normaliseCandidateRows(rows) {
        return (rows || []).map((r) => ({
          ...r,
          name: `${r.first_name || ''} ${r.last_name || ''}`.trim(),
        }));
      }

      function loadEmbeddedCandidates(){
        try {
          const globalSeed = window.CANDIDATES_FALLBACK;
          if (globalSeed) {
            const rows = Array.isArray(globalSeed?.candidates)
              ? globalSeed.candidates
              : Array.isArray(globalSeed)
                ? globalSeed
                : [];
            if (rows.length) return normaliseCandidateRows(rows);
          }
        } catch (err) {
          console.warn('[candidates] global fallback parse failed', err);
        }
        try {
          const el = document.getElementById('candidatesFallbackData');
          if (!el) return null;
          const typeAttr = el.getAttribute('type') || '';
          if (!/json/i.test(typeAttr)) return null;
          const raw = el.textContent || '';
          if (!raw.trim()) return null;
          const json = JSON.parse(raw);
          const rows = Array.isArray(json?.candidates)
            ? json.candidates
            : Array.isArray(json)
              ? json
              : [];
          if (!rows.length) return null;
          return normaliseCandidateRows(rows);
        } catch (err) {
          console.warn('[candidates] embedded fallback parse failed', err);
          return null;
        }
      }

      async function loadFallbackCandidates(){
        const embedded = loadEmbeddedCandidates();
        if (embedded && embedded.length) return embedded;
        try {
          const res = await fetch('/data/candidates.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const json = await res.json();
          const rows = Array.isArray(json?.candidates)
            ? json.candidates
            : Array.isArray(json)
              ? json
              : [];
          if (!rows.length) return null;
          return normaliseCandidateRows(rows);
        } catch (err) {
          console.error('[candidates] fallback load error', err);
          return null;
        }
      }

      async function load(){
        const wrap = $('#listWrap'); wrap.textContent = 'Loading…';
        chip('list: loading','warn','list');
        try{
          const res = await api('admin-candidates-list','POST',{
            q: ($('#q')?.value || '').trim(),
            status: activeStatus || ''
          });
          readOnlyMode = !!res?.readOnly;
          applyReadOnly();
          if (res?.supabase?.ok) chip('supabase: live','ok','supabase');
          else chip('supabase: '+(res?.supabase?.error||'offline'),'warn','supabase');
          chip(readOnlyMode ? 'mode: read-only':'mode: editable', readOnlyMode?'warn':'ok','mode');
          allRows = normaliseCandidateRows(Array.isArray(res) ? res : (res.rows || []));
          page = 1; selected.clear(); enableDelete();
          render(); renderQuick(null);
          if (!firstLoadComplete) {
            toast(`Loaded ${allRows.length} candidates`, 'info', 2600);
            firstLoadComplete = true;
          }
          chip('list: ok','ok','list');
        }catch(e){
          console.error('[candidates] list error', e);
          chip('list:error','bad','list');
          chip('supabase: '+(e.message||e),'bad','supabase');
          if (/supabase/i.test(String(e.message || e))) {
            readOnlyMode = true;
            applyReadOnly();
          }
          let fallbackRows = await loadFallbackCandidates();
          if (fallbackRows && fallbackRows.length) {
            chip('list: fallback','warn','list');
            chip('supabase: offline','warn','supabase');
            readOnlyMode = true;
            applyReadOnly();
            chip('mode: read-only','warn','mode');
            allRows = fallbackRows;
            page = 1; selected.clear(); enableDelete();
            render(); renderQuick(null);
            toast('Supabase unavailable — showing demo candidates (read-only).', 'warn', 4200);
            if (!firstLoadComplete) {
              toast(`${allRows.length} demo candidates ready`, 'warn', 3200);
              firstLoadComplete = true;
            }
          } else {
            wrap.textContent = 'Error: ' + (e.message || e);
            if (allRows.length) {
              chip('list: seed','warn','list');
              chip('mode: read-only','warn','mode');
              render();
              renderQuick(null);
            }
          }
        }
      }

      async function openOne(id){
        if (readOnlyMode) {
          const row = allRows.find((r) => String(r.id) === String(id));
          if (row) {
            editing = row;
            openEditor(row);
            toast('Preview data — edits disabled until Supabase is connected.', 'warn', 3200);
          } else {
            toast('Candidate not found in fallback dataset.', 'warn', 2800);
          }
          return;
        }
        try{
          const r = await api('admin-candidates-get','POST',{ id });
          editing = r;
          openEditor(r);
          toast('Opened ' + (r.full_name || (`ID ${id}`)), 'info', 1800);
        }catch(e){
          console.error('[candidates] open error', e);
          toast('Open failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function showQuick(id){
        if (readOnlyMode) {
          const row = allRows.find((r) => String(r.id) === String(id));
          renderQuick(row || null);
          return;
        }
        try{
          const r = await api('admin-candidates-get','POST',{ id });
          renderQuick(r);
        }catch(e){
          renderQuick(null);
        }
      }

      async function delSelected(){
        if (readOnlyMode) { toast('Preview deploy is read-only until Supabase is configured.', 'warn', 3200); return; }
        if (!selected.size) return;
        if (!confirm(`Delete ${selected.size} candidate(s)?`)) return;
        try{
          await api('admin-candidates-delete','POST',{ ids: Array.from(selected) });
          toast('Deleted','ok',1800);
          selected.clear(); enableDelete(); load();
        }catch(e){
          console.error('[candidates] delete error', e);
          toast('Delete failed: ' + (e.message || e), 'error', 4200);
        }
      }

      async function exportCSV(selectedOnly=false){
        try{
          if (selectedOnly && !selected.size) { toast('No rows selected', 'warn', 2000); return; }
          if (readOnlyMode) {
            const rows = selectedOnly
              ? allRows.filter(r => selected.has(r.id))
              : viewRows.slice();
            if (!rows.length) { toast('Nothing to export', 'warn', 2200); return; }
            const esc = (val) => {
              const text = val == null ? '' : String(val);
              return '"' + text.replace(/"/g, '""') + '"';
            };
            const header = ['ID','Ref','First Name','Last Name','Email','Phone','Status','Job Title','Client'];
            const lines = [header.map(esc).join(',')];
            rows.forEach((r) => {
              lines.push([
                r.id,
                r.ref,
                r.first_name,
                r.last_name,
                r.email,
                r.phone,
                r.status,
                r.job_title,
                r.client_name
              ].map(esc).join(','));
            });
            const csvText = lines.join('\n');
            const blob = new Blob([csvText], { type:'text/csv' });
            const url = URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
            URL.revokeObjectURL(url);
            toast('Exported fallback CSV','ok',1600);
            return;
          }
          const payload = selectedOnly ? { ids: Array.from(selected) } : {
            q: ($('#q')?.value || '').trim(),
            status: activeStatus || ''
          };
          const res = await api('admin-candidates-export','POST', payload);
          const csvText = res?.csv || '';
          if (!csvText) throw new Error('No data returned');
          const blob = new Blob([csvText], { type:'text/csv' });
          const url = URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
          URL.revokeObjectURL(url);
          toast('Exported','ok',1400);
        }catch(e){
          console.error('[candidates] export error', e);
          toast('Export failed: ' + (e.message || e), 'error', 4200);
        }
      }
      function importCSVClick(){
        if (readOnlyMode) { toast('Import disabled — preview deploy is read-only.', 'warn', 3200); return; }
        $('#csv')?.click();
      }
      async function importCSVDo(file){
        if (readOnlyMode) { toast('Import disabled — preview deploy is read-only.', 'warn', 3200); return; }
        try{
          const text = await file.text();
          const res  = await api('admin-candidates-import','POST',{ csv:text });
          toast(`Imported ${res?.inserted ?? 0}`,'ok',2000);
          load();
        }catch(e){
          console.error('[candidates] import error', e);
          toast('Import failed: ' + (e.message || e), 'error', 4200);
        }
      }

      const schemaTabs = [
        { name:'Basics', fields:[
          ['first_name','First name'],['last_name','Last name'],
          ['job_title','Job title'],['status','Status','select','In progress,Complete,Archived'],
          ['pay_type','Pay type','select','PAYE,PSC,Umbrella'],
          ['payroll_ref','Payroll ref'],['internal_ref','Internal ref']
        ]},
        { name:'Contact', fields:[
          ['email','Email','email'],['phone','Phone'],
          ['address1','Address 1'],['address2','Address 2'],['town','Town'],['county','County'],
          ['postcode','Postcode'],['country','Country']
        ]},
        { name:'Bank', fields:[
          ['bank_name','Bank name'],['bank_sort','Sort code'],['bank_sort_code','Sort code (alt)'],
          ['bank_account','Account number'],['bank_iban','IBAN'],['bank_swift','SWIFT/BIC']
        ]},
        { name:'Emergency', fields:[
          ['emergency_name','Emergency contact'],['emergency_phone','Emergency phone']
        ]},
        { name:'Compliance', fields:[
          ['rtw_url','Right to work URL'],['contract_url','Contract URL'],
          ['terms_ok','Terms accepted','checkbox']
        ]},
        { name:'Employment', fields:[
          ['client_name','Client'],['role','Role'],
          ['start_date','Start date','date'],['end_date','End date','date'],
          ['timesheet_status','Timesheet status','select','In progress,Complete,Missing']
        ]},
        { name:'Other', fields:[
          ['ref','Ref'],['tax_id','Tax ID'],['notes','Notes','textarea']
        ]}
      ];

      function fieldHtml([key,label,type='text',extra]){
        const id = 'f_'+key;
        if(type==='checkbox'){
          return `<div class="field"><label for="${id}">${label}</label>
                  <input id="${id}" name="${key}" type="checkbox"></div>`;
        }
        if(type==='textarea'){
          return `<div class="field" style="grid-column:1/-1"><label for="${id}">${label}</label>
                  <textarea id="${id}" name="${key}" rows="3"></textarea></div>`;
        }
        if(type==='select'){
          const opts = (extra||'').split(',').map(s=>s.trim()).filter(Boolean)
            .map(s=>`<option>${s}</option>`).join('');
          return `<div class="field"><label for="${id}">${label}</label>
                  <select id="${id}" name="${key}"><option value=""></option>${opts}</select></div>`;
        }
        return `<div class="field"><label for="${id}">${label}</label>
                <input id="${id}" name="${key}" type="${type}"></div>`;
      }

      function captureCurrentTab(){
        const frm = $('#frm');
        if (!frm) return;
        frm.querySelectorAll('[name]').forEach((el) => {
          if (el.type === 'checkbox') draft[el.name] = !!el.checked;
          else draft[el.name] = el.value || null;
        });
      }

      function buildEditorShell(){
        const tabsHost = $('#tabs'); tabsHost.innerHTML = '';
        schemaTabs.forEach((t) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'tab' + (t.name === currentTab ? ' active' : '');
          b.textContent = t.name;
          b.onclick = () => {
            captureCurrentTab();
            currentTab = t.name;
            Array.from(tabsHost.children).forEach((x) => x.classList.remove('active'));
            b.classList.add('active');
            buildEditorForm();
          };
          tabsHost.appendChild(b);
        });
        buildEditorForm();
      }

      function buildEditorForm(){
        const tab = schemaTabs.find((t) => t.name === currentTab) || schemaTabs[0];
        const frm = $('#frm');
        frm.innerHTML = tab.fields.map(fieldHtml).join('');
        tab.fields.forEach(([key,, type]) => {
          const el = frm.querySelector(`[name="${key}"]`);
          if (!el) return;
          const value = draft[key];
          if (type === 'checkbox') el.checked = !!value;
          else if (value != null) el.value = value;
          else el.value = '';
        });
        if (tab.name === 'Compliance') {
          const termsInput = frm.querySelector('[name="terms_ok"]');
          if (termsInput) {
            termsInput.onchange = () => {
              draft.terms_ok = !!termsInput.checked;
              if (termsInput.checked) {
                draft.terms_accepted_at = draft.terms_accepted_at || new Date().toISOString();
              } else {
                draft.terms_accepted_at = null;
              }
              updateTermsStatus();
            };
          }
          updateTermsStatus();
        }
      }

      function readForm(){
        captureCurrentTab();
        const out = { ...draft };
        out.full_name = [out.first_name, out.last_name].filter(Boolean).join(' ');
        return out;
      }

      function resetForm(){
        editing = null;
        draft = {};
        currentTab = 'Basics';
        $('#dTitle').textContent = 'New candidate';
        $('#dRef').textContent = '—';
        pendingUploads = [];
        localDocs = [];
        lastTermsSentAt = null;
        const draftStore = readLocalStore();
        if (draftStore && draftStore.draft) {
          delete draftStore.draft;
          writeLocalStore(draftStore);
        }
        renderDocs([]);
        buildEditorShell();
        updateTermsStatus();
      }

      function openEditor(values = {}){
        editing = values || null;
        draft = { ...(values || {}) };
        draft.terms_accepted_at = draft.terms_accepted_at || values?.terms_accepted_at || values?.termsAcceptedAt || null;
        lastTermsSentAt = values?.terms_sent_at || values?.termsSentAt || values?.terms_signed_at || null;
        pendingUploads = [];
        buildEditorShell();
        $('#dTitle').textContent = values?.full_name || `${values.first_name || ''} ${values.last_name || ''}`.trim() || 'Edit candidate';
        $('#dRef').textContent = values?.ref || values?.id || '—';
        openDrawer();
        loadDocuments(values?.id || null);
        updateTermsStatus();
      }


      function readLocalStore() {
        try {
          return JSON.parse(localStorage.getItem(LOCAL_DOCS_KEY) || '{}');
        } catch {
          return {};
        }
      }

      function writeLocalStore(store) {
        localStorage.setItem(LOCAL_DOCS_KEY, JSON.stringify(store));
      }

      function loadLocalDocs(candidateId) {
        const store = readLocalStore();
        const key = String(candidateId || 'draft');
        return Array.isArray(store[key]) ? store[key] : [];
      }

      function storeLocalDoc(candidateId, doc) {
        const store = readLocalStore();
        const key = String(candidateId || 'draft');
        store[key] = Array.isArray(store[key]) ? store[key] : [];
        store[key].unshift(doc);
        writeLocalStore(store);
      }

      function removeLocalDoc(candidateId, localId) {
        const store = readLocalStore();
        const key = String(candidateId || 'draft');
        if (!Array.isArray(store[key])) return;
        store[key] = store[key].filter((doc) => doc.localId !== localId);
        writeLocalStore(store);
      }

      function escHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function normaliseDoc(doc = {}) {
        const rawLabel = doc.label || doc.filename || `File ${doc.id || doc.localId || ''}`;
        const match = /^\[(.+?)\]\s*(.+)$/.exec(rawLabel || '');
        const category = (doc.category || (match ? match[1] : 'general')).toLowerCase();
        const displayLabel = match ? (match[2] || rawLabel) : rawLabel;
        return {
          ...doc,
          category,
          displayLabel,
          rawLabel,
        };
      }

      function renderDocSection(target, docs, emptyMessage) {
        if (!target) return;
        if (!docs.length) {
          target.innerHTML = `<div class="muted">${escHtml(emptyMessage)}</div>`;
          return;
        }
        target.innerHTML = '';
        docs.forEach((doc) => {
          const normalised = normaliseDoc(doc);
          const linkLabel = escHtml(normalised.displayLabel);
          const metaBits = [];
          if (normalised.source === 'local') metaBits.push('Local only');
          if (normalised.category === 'compliance') metaBits.push('Compliance');
          if (normalised.created_at) {
            try {
              metaBits.push(new Date(normalised.created_at).toLocaleString());
            } catch {
              metaBits.push(normalised.created_at);
            }
          }
          const meta = metaBits.length ? `<span class="meta">${escHtml(metaBits.join(' • '))}</span>` : '';
          let linkAttrs = 'href="#" onclick="return false"';
          if (normalised.url) {
            linkAttrs = `href="${normalised.url}" target="_blank" rel="noopener"`;
          } else if (normalised.dataUrl) {
            const downloadName = escHtml(normalised.filename || normalised.displayLabel || 'document');
            linkAttrs = `href="${normalised.dataUrl}" download="${downloadName}"`;
          }
          const idAttr = normalised.source === 'local'
            ? `local:${normalised.localId}`
            : String(normalised.id);
          const row = document.createElement('div');
          row.className = 'doc-row';
          row.innerHTML = `
            <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-start">
              <a ${linkAttrs}>${linkLabel}</a>
              ${meta}
            </div>
            <button type="button" data-doc="${escHtml(idAttr)}">Delete</button>
          `;
          target.appendChild(row);
        });
        target.querySelectorAll('button[data-doc]').forEach((btn) => {
          btn.onclick = () => deleteDoc(btn.dataset.doc);
        });
      }

      function renderDocs(docs) {
        const list = Array.isArray(docs) ? docs : [];
        const normalised = list.map(normaliseDoc);
        const complianceDocs = normalised.filter((doc) => doc.category === 'compliance');
        const generalDocs = normalised.filter((doc) => doc.category !== 'compliance');
        renderDocSection(docListGeneral, generalDocs, 'No documents yet.');
        renderDocSection(docListCompliance, complianceDocs, 'No compliance documents yet.');
      }

      function formatTimestamp(value) {
        if (!value) return null;
        try {
          return new Date(value).toLocaleString();
        } catch {
          return value;
        }
      }

      function updateTermsStatus(extraNote) {
        if (!termsStatus) return;
        const parts = [];
        if (draft?.terms_ok) {
          const accepted = formatTimestamp(draft.terms_accepted_at);
          parts.push(accepted ? `Terms accepted ${accepted}` : 'Terms accepted');
        } else {
          parts.push('Terms pending acceptance');
        }
        if (lastTermsSentAt) {
          parts.push(`Sent ${formatTimestamp(lastTermsSentAt)}`);
        }
        if (extraNote) parts.push(extraNote);
        termsStatus.textContent = parts.join(' • ');
      }

      async function loadDocuments(candidateId) {
        const local = loadLocalDocs(candidateId).map((doc) => ({ ...doc, source: 'local' }));
        localDocs = local;
        if (!candidateId) {
          currentDocs = [...localDocs];
          renderDocs(currentDocs);
          return;
        }
        if (readOnlyMode) {
          currentDocs = [...localDocs];
          renderDocs(currentDocs);
          return;
        }
        try {
          const res = await api('admin-candidate-docs-list', 'POST', { candidateId });
          const remote = (res?.documents || []).map((doc) => ({ ...doc, source: 'supabase' }));
          currentDocs = [...remote, ...localDocs];
          renderDocs(currentDocs);
        } catch (err) {
          console.error('[candidates] docs load failed', err);
          currentDocs = [...localDocs];
          renderDocs(currentDocs);
        }
      }

      async function deleteDoc(idToken) {
        if (!idToken) return;
        if (String(idToken).startsWith('local:')) {
          const localId = String(idToken).split(':')[1];
          if (!localId) return;
          if (!confirm('Remove this locally stored document?')) return;
          removeLocalDoc(editing?.id, localId);
          currentDocs = currentDocs.filter((doc) => doc.localId !== localId);
          renderDocs(currentDocs);
          toast('Local document removed', 'ok', 1800);
          return;
        }
        if (readOnlyMode) {
          toast('Preview deploy is read-only until Supabase is configured.', 'warn', 3200);
          return;
        }
        const numericId = Number(idToken);
        if (!numericId || Number.isNaN(numericId)) return;
        if (!confirm('Delete this document?')) return;
        try {
          await api('admin-candidate-doc-delete', 'POST', { id: numericId });
          currentDocs = currentDocs.filter((doc) => doc.id !== numericId);
          renderDocs(currentDocs);
          toast('Document removed', 'ok', 1800);
        } catch (err) {
          toast('Delete failed: ' + (err.message || err), 'error', 3200);
        }
      }

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const result = reader.result;
            if (typeof result === 'string') {
              const base64 = result.split(',')[1];
              resolve(base64);
            } else {
              reject(new Error('Unable to read file'));
            }
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function uploadDocument(candidateId, file, label, category = 'general') {
        const prefix = category === 'compliance' ? '[Compliance] ' : '';
        const finalLabel = `${prefix}${label || file.name}`;
        if (readOnlyMode) {
          try {
            const base64 = await toBase64(file);
            const dataUrl = `data:${file.type || 'application/octet-stream'};base64,${base64}`;
            const localDoc = {
              localId: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
              label: finalLabel,
              filename: file.name,
              dataUrl,
              category,
              created_at: new Date().toISOString(),
            };
            storeLocalDoc(candidateId, localDoc);
            localDocs = loadLocalDocs(candidateId).map((doc) => ({ ...doc, source: 'local' }));
            currentDocs = [
              ...currentDocs.filter((doc) => doc.source === 'supabase'),
              ...localDocs,
            ];
            renderDocs(currentDocs);
            toast('Document stored locally for preview', 'info', 2200);
          } catch (err) {
            console.error('[candidates] local upload error', err);
            toast('Upload failed: ' + (err.message || err), 'error', 3600);
          }
          return;
        }

        try {
          const data = await toBase64(file);
          const res = await api('admin-candidate-doc-upload', 'POST', {
            candidateId,
            name: file.name,
            label: finalLabel,
            contentType: file.type || 'application/octet-stream',
            data,
          });
          if (res?.document) {
            currentDocs = [{ ...res.document, source: 'supabase' }, ...currentDocs.filter((doc) => doc.source !== 'supabase' || doc.id !== res.document.id)];
            renderDocs(currentDocs);
            toast('Document uploaded', 'ok', 1800);
          }
        } catch (err) {
          console.error('[candidates] upload error', err);
          toast('Upload failed: ' + (err.message || err), 'error', 3600);
        }
      }

      async function parseCvFile(file) {
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        if (ext === 'docx' && window.mammoth) {
          const arrayBuffer = await file.arrayBuffer();
          const result = await window.mammoth.convertToPlainText({ arrayBuffer });
          return result.value || '';
        }
        if (ext === 'pdf') {
          try {
            const pdfjs = await ensurePdfJs();
            if (pdfjs?.getDocument) {
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjs.getDocument({ data: arrayBuffer }).promise;
              let text = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map((item) => item.str).join(' ') + '\n';
              }
              return text;
            }
            console.warn('[candidates] pdf.js unavailable after load');
          } catch (err) {
            console.warn('[candidates] pdf parse fallback', err);
          }
        }
        return await file.text();
      }

      function extractCvData(text) {
        const clean = (text || '').replace(/\r/g, '\n');
        const lines = clean.split(/\n+/).map((line) => line.trim()).filter(Boolean);
        const emailMatch = clean.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
        const phoneMatch = clean.match(/\+?\d[\d\s().-]{7,}/);
        const nameLine = lines.find((line) => /[A-Za-z]/.test(line) && line.split(/\s+/).length >= 2 && line.length < 60);
        const locationLine = lines.find((line) => /(uk|ireland|germany|netherlands|finland|france|london|dublin|helsinki|manager|consultant)/i.test(line));
        return {
          text: clean,
          email: emailMatch ? emailMatch[0] : '',
          phone: phoneMatch ? phoneMatch[0] : '',
          name: nameLine || '',
          location: locationLine || '',
        };
      }

      function applyCvData(data) {
        if (!data) return;
        captureCurrentTab();
        if (data.name) {
          const parts = data.name.split(/\s+/);
          draft.first_name = parts.shift() || draft.first_name;
          draft.last_name = parts.join(' ') || draft.last_name;
        }
        if (data.email) draft.email = data.email;
        if (data.phone) draft.phone = data.phone;
        if (data.location && !draft.town) draft.town = data.location;
        if (data.text) {
          const snippet = (data.text || '').slice(0, 2000);
          if (snippet && !(draft.notes || '').includes(snippet)) {
            draft.notes = [draft.notes || '', snippet].filter(Boolean).join('\n\n');
          }
        }
        buildEditorForm();
        toast('CV parsed. Review the fields before saving.', 'info', 2600);
      }

      async function handleCvInputChange(event) {
        const files = Array.from(event.target.files || []);
        event.target.value = '';
        if (!files.length) return;
        if (cvMode === 'parse') {
          const file = files[0];
          try {
            const text = await parseCvFile(file);
            const extracted = extractCvData(text);
            applyCvData(extracted);
            if (editing?.id) {
              await uploadDocument(editing.id, file, 'CV', 'general');
            } else {
              pendingUploads.push({ file, label: 'CV', category: 'general' });
              toast('CV ready. Save the candidate to upload the file.', 'info', 2600);
            }
          } catch (err) {
            toast('CV parse failed: ' + (err.message || err), 'error', 3600);
          }
        } else {
          const category = cvMode === 'upload-compliance' ? 'compliance' : 'general';
          await handleFiles(files, category);
        }
        cvMode = 'parse';
      }

      async function handleFiles(files, category = 'general') {
        const items = Array.isArray(files) ? files : Array.from(files || []);
        if (!items.length) return;
        if (editing?.id) {
          for (const file of items) {
            await uploadDocument(editing.id, file, file.name, category);
          }
        } else {
          items.forEach((file) => {
            pendingUploads.push({ file, label: file.name, category });
          });
          toast('File(s) queued. Save the candidate to upload.', 'info', 2400);
        }
      }

      function setupDropZone(zone, category) {
        if (!zone) return;
        const highlight = () => zone.classList.add('drag');
        const unhighlight = () => zone.classList.remove('drag');
        ['dragenter', 'dragover'].forEach((evt) => {
          zone.addEventListener(evt, (e) => { e.preventDefault(); highlight(); });
        });
        ['dragleave', 'dragend', 'drop'].forEach((evt) => {
          zone.addEventListener(evt, (e) => { e.preventDefault(); unhighlight(); });
        });
        zone.addEventListener('drop', async (e) => {
          e.preventDefault();
          unhighlight();
          const files = Array.from(e.dataTransfer?.files || []);
          if (files.length) {
            await handleFiles(files, category);
          }
        });
        zone.addEventListener('click', () => {
          cvMode = category === 'compliance' ? 'upload-compliance' : 'upload';
          cvInput?.click();
        });
        zone.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar') {
            e.preventDefault();
            zone.click();
          }
        });
      }

      async function sendTerms() {
        if (!editing?.id) {
          toast('Save the candidate before sending terms.', 'warn', 2600);
          return;
        }
        if (readOnlyMode) {
          toast('Preview deploy is read-only until Supabase is configured.', 'warn', 3200);
          return;
        }
        try {
          const payload = {
            candidateId: editing.id,
            name: editing.full_name || `${draft.first_name || ''} ${draft.last_name || ''}`.trim(),
            email: draft.email || editing.email || null,
            termsUrl: draft.contract_url || editing.contract_url || null,
            provider: 'docusign',
          };
          const res = await api('admin-candidate-terms-send', 'POST', payload);
          lastTermsSentAt = res?.sent_at || new Date().toISOString();
          updateTermsStatus(res?.warning ? `Preview: ${res.warning}` : undefined);
          if (res?.ok === false) {
            toast('Terms logged locally — Supabase unavailable', 'warn', 3200);
          } else {
            toast('Terms dispatch logged', 'ok', 2200);
          }
        } catch (err) {
          toast('Send failed: ' + (err.message || err), 'error', 3600);
        }
      }

      async function save(closeAfter=false){
        if (readOnlyMode) { toast('Preview deploy is read-only until Supabase is configured.', 'warn', 3200); return; }
        try{
          const body = readForm();
          const existingId = editing?.id || null;
          if (existingId) body.id = existingId;

          const res = await api('admin-candidates-save','POST', body);
          const savedId = res?.id || existingId || null;
          const savedName = res?.full_name || body.full_name || 'candidate';

          toast('Saved ' + savedName, 'ok', 1800);

          if (savedId) {
            editing = { ...(editing || {}), ...body, id: savedId, full_name: savedName };
            draft = { ...editing };

            if (pendingUploads.length) {
              for (const upload of pendingUploads.splice(0, pendingUploads.length)) {
                await uploadDocument(savedId, upload.file, upload.label, upload.category || 'general');
              }
            }
            await loadDocuments(savedId);
          } else {
            pendingUploads = [];
          }

          await load();
          if (closeAfter) closeDrawer();
        }catch(e){
          console.error('[candidates] save error', e);
          toast('Save failed: ' + (e.message || e), 'error', 4200);
        }
      }

      $('#btnRefresh').onclick = load;
      $('#btnDelete').onclick  = delSelected;
      $('#btnNew').onclick     = ()=>{ resetForm(); openDrawer(); };
      $('#btnExport').onclick  = ()=>exportCSV(false);
      $('#btnExportSel').onclick = ()=>exportCSV(true);
      $('#btnImport').onclick  = importCSVClick;
      $('#csv').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if (f) importCSVDo(f); });
      $('#q').addEventListener('input',  ()=>{ page=1; render(); });
      $('#statusChips').querySelectorAll('.chip').forEach(ch=>{
        ch.onclick = ()=>{ activeStatus = ch.getAttribute('data-status'); $('#statusChips').querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); page=1; load(); };
      });
      $('#pgPrev').onclick = ()=>{ if (page>1) { page--; render(); } };
      $('#pgNext').onclick = ()=>{ page++; render(); };
      $('#pgSize').value = String(pageSize);
      $('#pgSize').onchange = (e)=>{ pageSize = Number(e.target.value)||10; page=1; render(); };
      $('#btnSaveDraft').onclick = ()=>save(false);
      $('#btnSaveClose').onclick = ()=>save(true);
      if (btnParseCv) btnParseCv.onclick = ()=>{ cvMode = 'parse'; cvInput?.click(); };
      if (btnUploadCv) btnUploadCv.onclick = ()=>{ cvMode = 'upload'; cvInput?.click(); };
      if (btnUploadCompliance) btnUploadCompliance.onclick = ()=>{ cvMode = 'upload-compliance'; cvInput?.click(); };
      if (btnSendTerms) btnSendTerms.onclick = ()=>sendTerms();
      setupDropZone(docDropGeneral, 'general');
      setupDropZone(docDropCompliance, 'compliance');
      if (cvInput) cvInput.addEventListener('change', handleCvInputChange);
      document.addEventListener('keydown',(e)=>{
        if ((e.ctrlKey||e.metaKey) && e.key==='r'){ e.preventDefault(); load(); }
        if ((e.ctrlKey||e.metaKey) && e.key==='e'){ e.preventDefault(); exportCSV(false); }
        if ((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); save(false); }
        if (e.key === 'Escape' && drawer?.classList.contains('open')) { e.preventDefault(); closeDrawer(); }
      });

      buildColMenu();

      const seededRows = loadEmbeddedCandidates();
      if (Array.isArray(seededRows) && seededRows.length) {
        chip('list: seed','warn','list');
        readOnlyMode = true;
        applyReadOnly();
        allRows = seededRows;
        page = 1;
        selected.clear();
        enableDelete();
        render();
        renderQuick(null);
      }

      await load();
      enableDelete();
    });
  })();
  </script>
</body>
</html>
