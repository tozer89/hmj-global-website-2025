<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Candidates ‚Äî Admin | HMJ-Global</title>

<!-- Netlify Identity + shared admin helpers -->
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="/admin/common.js"></script>
<link rel="stylesheet" href="/css/style.css"/>

<style>
/* =========================
   THEME / TOKENS
   ========================= */
:root{
  --bg:#0b0f18; 
  --panel:#0f1424; 
  --panel-2:#0a1020;
  --border:#1e2a40; 
  --border-soft:#192233;
  --ink:#e6eef7; 
  --muted:#9fb0c9;
  --muted-2:#7f93b4;
  --card:#0e162a; 
  --chip:#0e1629; 
  --accent:#3A66B3;
  --accent-2:#5A8BFF;
  --good:#1e8a5d;
  --warn:#c28a2f;
  --bad:#b55357;
  --shadow: 0 10px 30px rgba(0,0,0,.25);
  --radius: 14px;
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

/* =========================
   HEADER
   ========================= */
.top{
  position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);
  z-index:5;backdrop-filter:saturate(120%) blur(4px)
}
.row{max-width:1240px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
.brand{font-weight:800}
.sp{flex:1}

a.btn,button.btn{
  background:#111a32;border:1px solid var(--border);color:#fff;
  padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer;
  box-shadow:0 1px 0 rgba(255,255,255,.05) inset;
}
a.btn:hover,button.btn:hover{border-color:#395079}
a.btn:active,button.btn:active{transform:translateY(1px)}

button.btn.bad{border-color:#2e1a1a;background:#1b1214}
button.btn.bad:hover{border-color:#6a2b2f}
button.btn.good{border-color:#1e6646;background:#0e2a1e}
button.btn.good:hover{border-color:#2aa070}

/* =========================
   WRAPS / CARDS
   ========================= */
.wrap{max-width:1240px;margin:22px auto;padding:0 18px;display:grid;gap:16px}
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px;box-shadow:var(--shadow)
}
.card.soft{background:var(--panel-2)}
.card.min{padding:10px}

/* =========================
   STATS PILLS
   ========================= */
.pills{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
.pill{
  background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;
  min-width:100px;text-align:center;display:flex;flex-direction:column;justify-content:center;
}
.pill b{font-size:22px;display:block}

/* =========================
   INPUTS
   ========================= */
input,select,textarea{
  background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px;
  outline:none;min-height:40px;box-shadow:0 1px 0 rgba(255,255,255,.04) inset
}
textarea{min-height:74px;resize:vertical}
input::placeholder,textarea::placeholder{color:#6e83a7}

.filters{display:grid;grid-template-columns:1.5fr .9fr .9fr 1fr 1fr auto 120px;gap:10px;margin:6px 0}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end}

/* =========================
   TABLE / LIST
   ========================= */
.tableWrap{overflow:auto;border-radius:12px;border:1px solid var(--border-soft);background:#0b1222}
.tableWrap .loading{padding:16px;color:var(--muted)}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:12px;border-bottom:1px solid var(--border-soft);text-align:left}
thead th{position:sticky;top:0;background:#0e1426;z-index:1;border-bottom:1px solid var(--border)}
tbody tr:hover{background:#0e1629}
td.actions{white-space:nowrap}

/* Badges */
.badge{display:inline-block;padding:4px 9px;border-radius:999px;border:1px solid #2c3853;background:#0f172a;font-size:12px}
.status-ok{background:#0e2a1e;border-color:#1e6646}
.status-warn{background:#33220f;border-color:#8a5b25}
.status-bad{background:#2a1214;border-color:#6a2b2f}

/* =========================
   EDITOR
   ========================= */
.editor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.section-title{font-weight:700;color:#cbd8ee;margin:12px 0 6px}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:var(--muted)}
.inline{display:flex;gap:8px;flex-wrap:wrap}
.editor-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* =========================
   PROFILE PANEL
   ========================= */
.profile{
  display:grid;grid-template-columns:340px 1fr;gap:16px
}
@media (max-width:1000px){
  .profile{grid-template-columns:1fr}
}
.infoBlock{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px}
.infoBlock h4{margin:0 0 8px}
.kv{display:grid;grid-template-columns:1fr 2fr;gap:6px;font-size:13px;color:var(--muted)}
.kv div:nth-child(odd){color:#9fb0c9}

/* =========================
   BANNERS / TOAST
   ========================= */
#banner-error{display:none;background:#2a1214;border:1px solid #6a2b2f;color:#ffbcbc;border-radius:12px;padding:10px}
#banner-error pre{white-space:pre-wrap;word-break:break-word}
#toast{position:fixed;right:14px;bottom:14px;max-width:40ch;background:#0e162a;border:1px solid var(--border);padding:10px 12px;border-radius:10px;display:none;z-index:50}
#toast.show{display:block;animation:fade 3s ease}
@keyframes fade{0%{opacity:0;transform:translateY(6px)}10%{opacity:1;transform:none}90%{opacity:1}100%{opacity:0}}

/* =========================
   MOBILE RESPONSIVE CARDS
   ========================= */
@media (max-width:860px){
  .filters{grid-template-columns:1fr 1fr 1fr}
  .tableWrap{border:none;background:transparent}
  table{display:none}
  .m-cards{display:grid;gap:10px}
  .m-card{
    background:#0b1222;border:1px solid var(--border-soft);border-radius:12px;padding:12px
  }
  .m-top{display:flex;justify-content:space-between;gap:8px}
  .m-title{font-weight:700}
  .m-line{color:var(--muted);font-size:13px}
  .m-actions{display:flex;gap:8px;margin-top:8px}
}

/* tiny helpers */
kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border:1px solid var(--border);padding:2px 6px;border-radius:6px;background:#0b1222}
.tip{color:var(--muted);font-size:12px}
.hr{height:1px;background:var(--border);margin:10px 0}
.small{font-size:12px;color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
  <!-- header -->
  <div class="top"><div class="row">
    <div class="brand">Candidates ‚Äî Admin</div><div class="sp"></div>
    <a class="btn" href="/admin/">‚üµ Admin home</a>
    <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- gate (non-admin / not signed-in) -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="why small" style="margin:6px 0 12px"></p>
      <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- app -->
  <div class="wrap" id="app" style="display:none">
    <div id="banner-error" class="card"></div>

    <!-- stats -->
    <div class="card pills">
      <div class="pill"><b id="kTotal">0</b>Total</div>
      <div class="pill"><b id="kFiltered">0</b>Filtered</div>
      <div class="pill"><b id="kPage">1/1</b>Page</div>
      <div class="sp"></div>
      <div class="inline">
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnNew">New candidate</button>
        <button class="btn" id="btnExport">Export CSV</button>
        <button class="btn" id="btnEmails" title="Copy filtered emails">üìß Email list</button>
        <button class="btn" id="btnDebug" title="Toggle debug">Debug</button>
      </div>
    </div>

    <!-- filters -->
    <div class="card">
      <div class="filters">
        <input id="q" placeholder="Search name / email / phone"/>
        <select id="fType" title="Pay type">
          <option value="">Any pay type</option>
          <option>Umbrella</option><option>Umbrella CIS</option>
          <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
          <option>International</option><option>International Umbrella</option>
        </select>
        <select id="fStatus" title="Status">
          <option value="">Any status</option>
          <option>Complete</option><option>In progress</option><option>Paused</option>
        </select>
        <input id="fJob" placeholder="Job title"/>
        <input id="fEmailHas" placeholder="Email contains"/>
        <div class="pager">
          <button class="btn" id="pgPrev" title="Prev">‚óÄ</button>
          <div style="min-width:84px;text-align:center"><span id="pgNow">1</span>/<span id="pgMax">1</span></div>
          <button class="btn" id="pgNext" title="Next">‚ñ∂</button>
        </div>
        <select id="pageSize" title="Rows / page">
          <option>25</option><option>50</option><option>100</option>
        </select>
      </div>
      <div class="tip">Tips: Press <kbd>/</kbd> to focus search ¬∑ <kbd>R</kbd> refresh ¬∑ <kbd>N</kbd> new candidate ¬∑ <kbd>‚Üê/‚Üí</kbd> page</div>
    </div>

    <!-- list -->
    <div class="card tableWrap" id="listWrap">
      <div class="loading">Loading‚Ä¶</div>
    </div>

    <!-- editor + profile -->
    <div class="profile" id="editorProfile" style="display:none">
      <!-- Editor -->
      <div class="card soft" id="editor">
        <h3 style="margin:0 0 10px" id="edTitle">Candidate</h3>

        <div class="section-title">Identity</div>
        <div class="editor-grid">
          <div class="field"><label>First name</label><input id="edFirst"></div>
          <div class="field"><label>Last name</label><input id="edLast"></div>
          <div class="field"><label>Email</label><input id="edEmail" type="email"></div>
          <div class="field"><label>Phone</label><input id="edPhone"></div>
          <div class="field"><label>Job title</label><input id="edJob"></div>
          <div class="field"><label>Pay type</label>
            <select id="edType">
              <option>Umbrella</option><option>Umbrella CIS</option>
              <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
              <option>International</option><option>International Umbrella</option>
            </select>
          </div>
          <div class="field"><label>Status</label>
            <select id="edStatus"><option>In progress</option><option>Complete</option><option>Paused</option></select>
          </div>
          <div class="field"><label>Payroll ref</label><input id="edPayroll"></div>
          <div class="field" style="grid-column:1 / -1"><label>Address</label><input id="edAddress" placeholder="Free-form address"></div>
        </div>

        <div class="section-title">Bank details (for payments)</div>
        <div class="editor-grid">
          <div class="field"><label>Bank name</label><input id="edBankName"></div>
          <div class="field"><label>Account holder</label><input id="edAccountName"></div>
          <div class="field"><label>Sort code</label><input id="edSortCode" placeholder="12-34-56"></div>
          <div class="field"><label>Account number</label><input id="edAccountNumber" placeholder="12345678"></div>
          <div class="field"><label>IBAN</label><input id="edIban" placeholder=""></div>
          <div class="field"><label>SWIFT / BIC</label><input id="edSwift" placeholder=""></div>
          <div class="field" style="grid-column:1 / -1">
            <label>Notes</label><textarea id="edNotes" placeholder="Internal notes (optional)"></textarea>
          </div>
        </div>

        <div class="editor-actions">
          <button class="btn good" id="btnSave">Save</button>
          <button class="btn bad" id="btnDelete">Delete</button>
          <button class="btn" id="btnClose">Close</button>
        </div>
      </div>

      <!-- Profile panel -->
      <div class="card soft" id="profile">
        <h3 style="margin:0 0 10px">Profile</h3>
        <div id="profileContent">
          <div class="small">No candidate selected.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* ============================================================
   Small DOM helpers (null-safe)
   ============================================================ */
const $  = (s,root=document)=> root.querySelector(s);
const $$ = (s,root=document)=> Array.from(root.querySelectorAll(s));
const setNum = (selector, val) => { const el = $(selector); if(!el){ console.warn('Counter not found:', selector); return; } el.textContent = String(val); };
const show   = (el)=> el && (el.style.display='');
const hide   = (el)=> el && (el.style.display='none');
const text   = (el,v)=> el && (el.textContent=v);

/* ============================================================
   Toast
   ============================================================ */
const toast = (msg) => {
  const el = $('#toast'); if(!el) return;
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.classList.remove('show'), 2400);
};

/* ============================================================
   Debug channel (toggle-able)
   ============================================================ */
const __dbg = {
  enabled: false,
  log: (...a)=> __dbg.enabled && console.log(...a),
  err: (...a)=> { console.error(...a); }
};

/* ============================================================
   API helper - robust JSON handling, graceful errors
   ============================================================ */
async function apiCall(url, method='POST', body=null, opts={}){
  try{
    const full = url.startsWith('/.netlify') ? url : `/.netlify/functions${url.startsWith('/')?url:`/${url}`}`;
    __dbg.log('API build request', { url: full, method, body });
    const res = await fetch(full, {
      method, headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null
    });
    __dbg.log('Fetch complete ‚Äì', { status: res.status, ok: res.ok });
    if(!res.ok){
      let t = await res.text().catch(()=> '');
      try{ t = JSON.parse(t) }catch{}
      const msg = (t && (t.error||t.message)) || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    let txt = await res.text();
    __dbg.log('API payload ‚Äì', txt);
    try{ return JSON.parse(txt) }catch{
      // support raw arrays / csv accidentally returned
      return txt;
    }
  }catch(e){
    __dbg.err('API failed', e);
    throw e;
  }
}

/* ============================================================
   Gate: require admin (Identity)
   ============================================================ */
function showGateWhy(why){ const g=$('#gate'); show(g); $('.why',g).textContent = why || 'Sign in required.'; hide($('#app')); }
function showApp(){ hide($('#gate')); show($('#app')); }

/* ============================================================
   Page main
   ============================================================ */
async function main(){
  __dbg.log('Gate: start', '');
  // Check identity: rely on /admin/common.js guard if present; else do a light check
  const user = (window.netlifyIdentity && netlifyIdentity.currentUser && netlifyIdentity.currentUser()) || null;
  __dbg.log('Gate: user found ‚Äì', user ? {email:user.email} : null);
  if(!user){ return showGateWhy('Please sign in.'); }
  showApp();

  /* --------------- State --------------- */
  let page=1, pages=1, size=Number(localStorage.cand_size||25)||25, cur=null, lastRows=[];
  let sort = { key:'name', dir:'asc' }; // purely a hint to the API; backend may ignore
  $('#pageSize').value = String(size);

  /* --------------- Elements --------------- */
  const listWrap = $('#listWrap');
  const editorProfile = $('#editorProfile');
  const editor = $('#editor');
  const profile = $('#profile');
  const bannerErr = $('#banner-error');

  /* --------------- Helpers --------------- */
  const qv = (sel)=> ($(sel)?.value ?? '').trim();

  function showErrorBanner(message, raw){
    bannerErr.innerHTML = `<strong>Error:</strong> <span>${String(message||'Unknown')}</span>${raw?`<pre class="small">${raw}</pre>`:''}`;
    show(bannerErr);
  }
  function hideErrorBanner(){ bannerErr.innerHTML=''; hide(bannerErr); }

  function statusBadge(s){
    const t=(s||'').toLowerCase();
    const cls = t==='complete' ? 'status-ok' : t==='in progress' ? 'status-warn' : 'status-bad';
    return `<span class="badge ${cls}">${s||'‚Äî'}</span>`;
  }
  const safe = (v)=> (v===null || v===undefined || v==='') ? '‚Äî' : v;

  function typeBadge(t){ return `<span class="badge">${safe(t)}</span>`; }

  function normalizeRows(raw){
    // Accept: array of candidates OR {rows,total,...}
    const rows = Array.isArray(raw) ? raw : (raw && raw.rows) ? raw.rows : [];
    // If items look like {id, name} (from clients), adapt minimally
    return rows.map(x=>{
      if (x && x.name && !x.first_name && !x.last_name) {
        return { 
          id:x.id, 
          first_name:x.first_name||x.name, 
          last_name:x.last_name||'', 
          email:x.email||'', 
          phone:x.phone||'', 
          job_title:x.job_title||'', 
          pay_type:x.pay_type||'', 
          status:x.status||'', 
          payroll_ref:x.payroll_ref||'', 
          address:x.address||''
        };
      }
      return x;
    });
  }

  function setPageMeta(){
    setNum('#pgNow', page);
    setNum('#pgMax', pages);
    $('#kPage').textContent = `${page}/${pages}`;
  }

  function renderRows(rows){
    lastRows = rows;

    // Desktop table
    const tableHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>Name</th>
            <th>Email</th>
            <th style="width:140px">Phone</th>
            <th style="width:160px">Type</th>
            <th style="width:140px">Status</th>
            <th style="width:130px"></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${safe(r.id)}</td>
              <td>${safe([r.first_name,r.last_name].filter(Boolean).join(' '))}</td>
              <td>${safe(r.email)}</td>
              <td>${safe(r.phone)}</td>
              <td>${typeBadge(r.pay_type)}</td>
              <td>${statusBadge(r.status)}</td>
              <td class="actions">
                <button class="btn" data-open="${r.id}">Open</button>
                <button class="btn" data-prof="${r.id}">Profile</button>
              </td>
            </tr>`).join('')}
        </tbody>
      </table>`;

    // Mobile cards
    const mobileCards = `
      <div class="m-cards">
        ${rows.map(r=>`
          <div class="m-card">
            <div class="m-top">
              <div><div class="m-title">${safe([r.first_name,r.last_name].filter(Boolean).join(' '))}</div>
              <div class="small">ID ${safe(r.id)}</div></div>
              <div>${typeBadge(r.pay_type)}</div>
            </div>
            <div class="m-line">${safe(r.email)} ¬∑ ${safe(r.phone)}</div>
            <div class="m-line">${statusBadge(r.status)} ${r.job_title?`¬∑ ${r.job_title}`:''}</div>
            <div class="m-actions">
              <button class="btn" data-open="${r.id}">Open</button>
              <button class="btn" data-prof="${r.id}">Profile</button>
            </div>
          </div>
        `).join('')}
      </div>`;

    if(!rows.length){
      listWrap.innerHTML = `<div class="loading">No candidates.</div>`;
    }else{
      listWrap.innerHTML = tableHTML + mobileCards;
    }

    // attach actions
    $$('button[data-open]', listWrap).forEach(b=> b.onclick = ()=> openEd(Number(b.dataset.open)));
    $$( 'button[data-prof]', listWrap).forEach(b=> b.onclick = ()=> openProfile(Number(b.dataset.prof)));
  }

  async function loadList(){
    hideErrorBanner();
    listWrap.innerHTML = '<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div> Loading‚Ä¶</div>';
    try{
      const body = { q:qv('#q'), type:qv('#fType'), status:qv('#fStatus'), job:qv('#fJob'), emailHas:qv('#fEmailHas'), page, size, sort, debug: __dbg.enabled };
      __dbg.log('List: request body', body);

      // function filename is plural
      const res = await apiCall('/admin-candidates-lists','POST', body);

      // tolerate JSON-string payloads and different shapes
      const rows = normalizeRows(res);
      const total = (typeof res.total === 'number') ? res.total : rows.length;
      const filtered = (typeof res.filtered === 'number') ? res.filtered : rows.length;
      pages = Math.max(1, Number(res.pages || Math.ceil(filtered/size) || 1));
      if(page>pages) page=pages;

      setNum('#kTotal', total);
      setNum('#kFiltered', filtered);
      setPageMeta();
      __dbg.log('List: meta', { total, filtered, pages, page });

      renderRows(rows);
    }catch(e){
      __dbg.err('List: load failed', String(e));
      showErrorBanner(e.message || 'Error');
      listWrap.innerHTML = '<div style="color:#ffb4b4">Error: '+(e.message||e)+'</div>';
    }
  }

  function setEd(c){
    text($('#edTitle'), c?.id ? `Candidate #${c.id}` : 'New candidate');

    // identity
    $('#edFirst').value   = c.first_name||'';
    $('#edLast').value    = c.last_name||'';
    $('#edEmail').value   = c.email||'';
    $('#edPhone').value   = c.phone||'';
    $('#edJob').value     = c.job_title||'';
    $('#edType').value    = c.pay_type||'Umbrella';
    $('#edStatus').value  = c.status||'In progress';
    $('#edPayroll').value = c.payroll_ref||'';
    $('#edAddress').value = c.address||'';

    // bank
    $('#edBankName').value     = c.bank_name||'';
    $('#edAccountName').value  = c.account_name||'';
    $('#edSortCode').value     = c.sort_code||'';
    $('#edAccountNumber').value= c.account_number||'';
    $('#edIban').value         = c.iban||'';
    $('#edSwift').value        = c.swift||'';
    $('#edNotes').value        = c.notes||'';
  }

  function getEd(){
    return {
      id: cur?.id || undefined,
      // identity
      first_name: $('#edFirst').value.trim() || null,
      last_name:  $('#edLast').value.trim()  || null,
      email:      $('#edEmail').value.trim() || null,
      phone:      $('#edPhone').value.trim() || null,
      job_title:  $('#edJob').value.trim()   || null,
      pay_type:   $('#edType').value || null,
      status:     $('#edStatus').value || null,
      payroll_ref:$('#edPayroll').value.trim() || null,
      address:    $('#edAddress').value.trim() || null,
      // bank
      bank_name:      $('#edBankName').value.trim() || null,
      account_name:   $('#edAccountName').value.trim() || null,
      sort_code:      $('#edSortCode').value.trim() || null,
      account_number: $('#edAccountNumber').value.trim() || null,
      iban:           $('#edIban').value.trim() || null,
      swift:          $('#edSwift').value.trim() || null,
      notes:          $('#edNotes').value.trim() || null
    };
  }

  async function openEd(id){
    try{
      cur = id ? await apiCall('/admin-candidates-get','POST',{ id }) : { status:'In progress', pay_type:'Umbrella' };
      setEd(cur);
      show(editorProfile); editor.scrollIntoView({behavior:'smooth',block:'start'});
    }catch(e){ toast('Open failed: '+(e.message||e)); }
  }

  function profileSkeleton(){
    return `
      <div class="infoBlock">
        <h4>Summary</h4>
        <div class="kv">
          <div>Name</div><div>‚Äî</div>
          <div>Email</div><div>‚Äî</div>
          <div>Phone</div><div>‚Äî</div>
          <div>Status</div><div>‚Äî</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="infoBlock">
        <h4>Recent timesheets</h4>
        <div class="small">Loading‚Ä¶</div>
      </div>
      <div class="infoBlock">
        <h4>Current assignments</h4>
        <div class="small">Loading‚Ä¶</div>
      </div>`;
  }

  function renderProfile(candidate, timesheets, assignments){
    const name = [candidate.first_name, candidate.last_name].filter(Boolean).join(' ') || '‚Äî';
    const tRows = (timesheets||[]).slice(0,6).map(t=>`
      <tr>
        <td>${safe(t.ref||t.id)}</td>
        <td>${safe(t.week_ending || t.week || t.date)}</td>
        <td>${safe(t.hours || t.total_hours)}</td>
        <td>${safe(t.status)}</td>
      </tr>`).join('') || `<tr><td colspan="4" class="small">No recent timesheets.</td></tr>`;

    const aRows = (assignments||[]).slice(0,6).map(a=>`
      <tr>
        <td>${safe(a.client_name || a.client || a.site)}</td>
        <td>${safe(a.job_title || a.role)}</td>
        <td>${safe(a.start_date || a.start)}</td>
        <td>${safe(a.end_date || a.end) || '‚Äî'}</td>
      </tr>`).join('') || `<tr><td colspan="4" class="small">No active assignments.</td></tr>`;

    $('#profileContent').innerHTML = `
      <div class="infoBlock">
        <h4>Summary</h4>
        <div class="kv">
          <div>Name</div><div>${name}</div>
          <div>Email</div><div>${safe(candidate.email)}</div>
          <div>Phone</div><div>${safe(candidate.phone)}</div>
          <div>Status</div><div>${statusBadge(candidate.status)}</div>
          <div>Pay type</div><div>${typeBadge(candidate.pay_type)}</div>
          <div>Job title</div><div>${safe(candidate.job_title)}</div>
          <div>Payroll ref</div><div>${safe(candidate.payroll_ref)}</div>
          <div>Address</div><div>${safe(candidate.address)}</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="infoBlock">
        <h4>Recent timesheets</h4>
        <div class="tableWrap min">
          <table>
            <thead><tr><th>Ref</th><th>Week ending</th><th>Hours</th><th>Status</th></tr></thead>
            <tbody>${tRows}</tbody>
          </table>
        </div>
      </div>
      <div class="infoBlock">
        <h4>Current assignments</h4>
        <div class="tableWrap min">
          <table>
            <thead><tr><th>Client</th><th>Role</th><th>Start</th><th>End</th></tr></thead>
            <tbody>${aRows}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  async function openProfile(id){
    try{
      // always open editor too (for context)
      await openEd(id);

      $('#profileContent').innerHTML = profileSkeleton();

      // pull optional data
      let [ts, asg] = await Promise.allSettled([
        apiCall('/admin-timesheets-by-candidate','POST',{ candidate_id: id }).catch(e=> { __dbg.err('timesheets err',e); return []; }),
        apiCall('/admin-assignments-by-candidate','POST',{ candidate_id: id }).catch(e=> { __dbg.err('assignments err',e); return []; })
      ]);

      const t = ts.status==='fulfilled' ? (Array.isArray(ts.value) ? ts.value: (ts.value.rows||[])) : [];
      const a = asg.status==='fulfilled'? (Array.isArray(asg.value)? asg.value: (asg.value.rows||[])): [];
      renderProfile(cur, t, a);
    }catch(e){
      toast('Profile failed: '+(e.message||e));
    }
  }

  /* --------------- Events --------------- */
  $('#btnRefresh').onclick = ()=> { page=1; loadList(); };
  ['#q','#fType','#fStatus','#fJob','#fEmailHas'].forEach(sid=>{
    $(sid).addEventListener('change', ()=>{ page=1; loadList(); });
    $(sid).addEventListener('keyup',  (e)=>{ if(e.key==='Enter'){ page=1; loadList(); }});
  });

  $('#pgPrev').onclick = ()=>{ if(page>1){ page--; loadList(); } };
  $('#pgNext').onclick = ()=>{ if(page<pages){ page++; loadList(); } };
  $('#pageSize').onchange = ()=>{ size = Number($('#pageSize').value)||25; localStorage.cand_size=size; page=1; loadList(); };

  $('#btnNew').onclick  = ()=> openEd(null);
  $('#btnClose').onclick= ()=>{ hide(editorProfile); cur=null; };

  $('#btnSave').onclick = async ()=>{
    try{
      const data = getEd();
      const saved = await apiCall('/admin-candidates-save','POST', data);
      toast('Saved');
      // keep in view and refresh list; reopen with saved id if new
      if(saved?.id){ cur = saved; setEd(cur); }
      await loadList();
    }catch(e){ toast('Save failed: '+(e.message||e)); }
  };

  $('#btnDelete').onclick = async ()=>{
    if(!cur?.id) return toast('Nothing to delete');
    if(!confirm('Delete this candidate?')) return;
    try{ await apiCall('/admin-candidates-delete','POST',{ id: cur.id }); toast('Deleted'); hide(editorProfile); await loadList(); }
    catch(e){ toast('Delete failed: '+(e.message||e)); }
  };

  $('#btnEmails').onclick = ()=>{
    const emails = lastRows.map(r=>r.email).filter(Boolean);
    if(!emails.length) return toast('No emails in current list');
    navigator.clipboard?.writeText(emails.join(', '));
    toast(`Copied ${emails.length} email(s)`);
  };

  $('#btnExport').onclick = ()=>{
    const rows = lastRows;
    if(!rows.length){ toast('Nothing to export'); return; }
    const cols = ['id','first_name','last_name','email','phone','job_title','pay_type','status','payroll_ref','address','bank_name','account_name','sort_code','account_number','iban','swift'];
    const head = cols.join(',');
    const csv = [head].concat(rows.map(r=> cols.map(k=>{
      const v = r[k] ?? '';
      const s = String(v).replace(/"/g,'""');
      return `"${s}"`;
    }).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  };

  $('#btnDebug').onclick = ()=>{
    __dbg.enabled = !__dbg.enabled;
    toast('Debug '+(__dbg.enabled?'ON':'OFF'));
  };

  // keyboard shortcuts
  window.addEventListener('keydown',(e)=>{
    if(e.key==='/'){ e.preventDefault(); $('#q').focus(); $('#q').select(); }
    if(e.key==='r' || e.key==='R'){ e.preventDefault(); $('#btnRefresh').click(); }
    if(e.key==='n' || e.key==='N'){ e.preventDefault(); $('#btnNew').click(); }
    if(e.key==='ArrowLeft'){ e.preventDefault(); $('#pgPrev').click(); }
    if(e.key==='ArrowRight'){ e.preventDefault(); $('#pgNext').click(); }
    if(e.key==='d' || e.key==='D'){ e.preventDefault(); $('#btnDebug').click(); }
  });

  __dbg.log('App: init', '');

  // initial load
  await loadList();
}

/* ============================================================
   Boot after Identity ready
   ============================================================ */
document.addEventListener('DOMContentLoaded', ()=>{
  // If /admin/common.js exposes bootstrap, prefer it; otherwise run main.
  if(window.__ADMIN_BOOTSTRAP__){
    window.__ADMIN_BOOTSTRAP__(main);
  }else{
    main();
  }
});
</script>
</body>
</html>
