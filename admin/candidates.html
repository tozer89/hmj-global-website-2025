<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Candidates â€” Admin | HMJ-Global</title>

<!-- Netlify Identity + shared admin helpers -->
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>

<style>
  --chip:#12213d; --chip-br:#29426c; --danger:#a33; --ok:#2fb36f;
  :root{
    --bg:#0b0f18; --panel:#111827; --border:#252f3f; --ink:#e6eef7; --muted:#9fb0c9;
    --card:#0f172a; --chip:#0e1629; --accent:#3A66B3;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:5}
  .row{max-width:1240px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1240px;margin:22px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.20)}
  .muted{color:var(--muted)}
  input,select{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;
       font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pills{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:var(--card);border:1px solid #2c3853;border-radius:12px;padding:10px 14px;min-width:90px;text-align:center}
  .pill b{font-size:20px;display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
  thead th{position:sticky;top:0;background:#0e1426;z-index:1}
  tbody tr:hover{background:#0e1629}
  .filters{display:grid;grid-template-columns:1.5fr .9fr .9fr 1fr 1fr auto 120px;gap:10px;margin:6px 0}
  .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .tableWrap{overflow:auto;border-radius:12px}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2c3853;background:#0f172a}
  .status-ok{background:#0e2a1e;border-color:#1e6646}
  .status-warn{background:#33220f;border-color:#8a5b25}
  .status-bad{background:#2a1214;border-color:#6a2b2f}
  .inline{display:flex;gap:8px;flex-wrap:wrap}
  .editor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .editor-grid label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .editor-grid .field{display:flex;flex-direction:column}
  @media (max-width:980px){ .filters{grid-template-columns:1fr 1fr 1fr} .editor-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <!-- header -->
  <div class="top"><div class="row">
    <div class="brand">Candidates â€” Admin</div><div class="sp"></div>
    <a class="btn" href="/admin/">âŸµ Admin home</a>
    <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- gate (non-admin / not signed-in) -->
  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="why muted" style="margin:6px 0 12px"></p>
      <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- app -->
  <div class="wrap" id="app" style="display:none">

    <!-- stats -->
    <div class="card pills">
      <div class="pill"><b id="kTotal">0</b>Total</div>
      <div class="pill"><b id="kFiltered">0</b>Filtered</div>
      <div class="pill"><b id="kPage">1/1</b>Page</div>
      <div class="sp"></div>
      <div class="inline">
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnNew">New candidate</button>
        <button class="btn" id="btnExport">Export CSV</button>
        <button class="btn" id="btnEmails" title="Copy filtered emails">ðŸ“§ Email list</button>
      </div>
    </div>

    <!-- filters -->
    <div class="card">
      <div class="filters">
        <input id="q" placeholder="Search name / email / phone"/>
        <select id="fType">
          <option value="">Any pay type</option>
          <option>Umbrella</option><option>Umbrella CIS</option>
          <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
          <option>International</option><option>International Umbrella</option>
        </select>
        <select id="fStatus">
          <option value="">Any status</option>
          <option>Complete</option><option>In progress</option><option>Paused</option>
        </select>
        <input id="fJob" placeholder="Job title"/>
        <input id="fEmailHas" placeholder="Email contains"/>
        <div class="pager">
          <button class="btn" id="pgPrev">â—€</button>
          <div style="min-width:84px;text-align:center"><span id="pgNow">1</span>/<span id="pgMax">1</span></div>
          <button class="btn" id="pgNext">â–¶</button>
        </div>
        <select id="pageSize" title="Rows / page">
          <option>25</option><option>50</option><option>100</option>
        </select>
      </div>
    </div>

    <!-- list -->
    <div class="card tableWrap" id="listWrap">Loadingâ€¦</div>

    <!-- editor -->
    <div class="card" id="editor" style="display:none">
      <h3 style="margin:0 0 10px" id="edTitle">Candidate</h3>
      <div class="editor-grid">
        <div class="field"><label>First name</label><input id="edFirst"></div>
        <div class="field"><label>Last name</label><input id="edLast"></div>

        <div class="field"><label>Email</label><input id="edEmail" type="email"></div>
        <div class="field"><label>Phone</label><input id="edPhone"></div>

        <div class="field"><label>Job title</label><input id="edJob"></div>
        <div class="field"><label>Pay type</label>
          <select id="edType">
            <option>Umbrella</option><option>Umbrella CIS</option>
            <option>PAYE</option><option>Ltd</option><option>Ltd CIS</option>
            <option>International</option><option>International Umbrella</option>
          </select>
        </div>

        <div class="field"><label>Status</label>
          <select id="edStatus"><option>In progress</option><option>Complete</option><option>Paused</option></select>
        </div>
        <div class="field"><label>Payroll ref</label><input id="edPayroll"></div>

        <div class="field" style="grid-column:1 / -1"><label>Address</label><input id="edAddress" placeholder="Free-form address"></div>
      </div>

      <div class="inline" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn" id="btnDelete">Delete</button>
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
async function main({ api, sel, toast }){
  // state
  let page=1, pages=1, size=Number(localStorage.cand_size||25)||25, cur=null, lastRows=[];

  // els
  const listWrap = sel('#listWrap');
  const ed = sel('#editor');

  sel('#pageSize').value = String(size);

  // helpers
  const qv = id => sel(id).value.trim();
  const setNum = (id,val)=> sel(id).textContent = String(val);

  function statusBadge(s){
    const t=(s||'').toLowerCase();
    const cls = t==='complete' ? 'status-ok' : t==='in progress' ? 'status-warn' : 'status-bad';
    return `<span class="badge ${cls}">${s||'â€”'}</span>`;
  }

  function typeBadge(t){ return `<span class="badge">${t||'â€”'}</span>`; }

  function renderRows(rows){
    lastRows = rows;
    if(!rows.length){ listWrap.innerHTML = '<div class="muted">No candidates.</div>'; return; }
    listWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>Name</th>
            <th>Email</th>
            <th style="width:140px">Phone</th>
            <th style="width:160px">Type</th>
            <th style="width:140px">Status</th>
            <th style="width:96px"></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.id}</td>
              <td>${[r.first_name,r.last_name].filter(Boolean).join(' ')||'â€”'}</td>
              <td>${r.email || 'â€”'}</td>
              <td>${r.phone || 'â€”'}</td>
              <td>${typeBadge(r.pay_type)}</td>
              <td>${statusBadge(r.status)}</td>
              <td><button class="btn" data-open="${r.id}">Open</button></td>
            </tr>`).join('')}
        </tbody>
      </table>`;
    listWrap.querySelectorAll('button[data-open]').forEach(b=> b.onclick = ()=> openEd(Number(b.dataset.open)));
  }

  async function loadList(){
    listWrap.textContent = 'Loadingâ€¦';
    try{
      const body = {
        q: qv('#q'),
        type: qv('#fType'),
        status: qv('#fStatus'),
        job: qv('#fJob'),
        emailHas: qv('#fEmailHas'),
        page, size
      };
      // IMPORTANT: endpoint name is plural (matches file admin-candidates-lists.js)
      const res = await api('/admin-candidates-lists','POST', body);
      // tolerate either {rows,total,filtered,pages} or a flat array
      const rows = Array.isArray(res) ? res : (res.rows || []);
      const total = res.total ?? rows.length;
      const filtered = res.filtered ?? rows.length;
      pages = Math.max(1, Number(res.pages || Math.ceil(filtered/size)||1));
      if(page>pages) page=pages;

      setNum('kTotal', total);
      setNum('kFiltered', filtered);
      setNum('pgNow', page);
      setNum('pgMax', pages);
      sel('#kPage').textContent = `${page}/${pages}`;

      renderRows(rows);
    }catch(e){
      listWrap.innerHTML = `<div style="color:#ffb4b4">Error: ${e.message||e}</div>`;
      console.error(e);
    }
  }

  function setEd(c){
    sel('#edTitle').textContent = c?.id ? `Candidate #${c.id}` : 'New candidate';
    sel('#edFirst').value   = c.first_name||'';
    sel('#edLast').value    = c.last_name||'';
    sel('#edEmail').value   = c.email||'';
    sel('#edPhone').value   = c.phone||'';
    sel('#edJob').value     = c.job_title||'';
    sel('#edType').value    = c.pay_type||'Umbrella';
    sel('#edStatus').value  = c.status||'In progress';
    sel('#edPayroll').value = c.payroll_ref||'';
    sel('#edAddress').value = c.address||'';
  }
  function getEd(){
    return {
      id: cur?.id || undefined,
      first_name: qv('#edFirst')||null,
      last_name:  qv('#edLast')||null,
      email:      qv('#edEmail')||null,
      phone:      qv('#edPhone')||null,
      job_title:  qv('#edJob')||null,
      pay_type:   qv('#edType')||null,
      status:     qv('#edStatus')||null,
      payroll_ref:qv('#edPayroll')||null,
      address:    qv('#edAddress')||null
    };
  }

  async function openEd(id){
    try{
      cur = id ? await api('/admin-candidates-get','POST',{ id }) : { status:'In progress', pay_type:'Umbrella' };
      setEd(cur);
      ed.style.display = '';
      ed.scrollIntoView({behavior:'smooth',block:'start'});
    }catch(e){ toast('Open failed: '+(e.message||e)); }
  }

  // events
  sel('#btnRefresh').onclick = ()=> { page=1; loadList(); };
  ['#q','#fType','#fStatus','#fJob','#fEmailHas'].forEach(sid=>{
    sel(sid).addEventListener('change', ()=>{ page=1; loadList(); });
    sel(sid).addEventListener('keyup',  (e)=>{ if(e.key==='Enter'){ page=1; loadList(); }});
  });

  sel('#pgPrev').onclick = ()=>{ if(page>1){ page--; loadList(); } };
  sel('#pgNext').onclick = ()=>{ if(page<pages){ page++; loadList(); } };
  sel('#pageSize').onchange = ()=>{ size = Number(sel('#pageSize').value)||25; localStorage.cand_size=size; page=1; loadList(); };

  sel('#btnNew').onclick  = ()=> openEd(null);
  sel('#btnClose').onclick= ()=>{ ed.style.display='none'; cur=null; };

  sel('#btnSave').onclick = async ()=>{
    try{
      const data = getEd();
      const saved = await api('/admin-candidates-save','POST', data);
      toast('Saved');
      ed.style.display='none';
      page=1;
      await loadList();
      if(saved?.id) openEd(saved.id);
    }catch(e){ toast('Save failed: '+(e.message||e)); }
  };

  sel('#btnDelete').onclick = async ()=>{
    if(!cur?.id) return toast('Nothing to delete');
    if(!confirm('Delete this candidate?')) return;
    try{ await api('/admin-candidates-delete','POST',{ id: cur.id }); toast('Deleted'); ed.style.display='none'; await loadList(); }
    catch(e){ toast('Delete failed: '+(e.message||e)); }
  };

  sel('#btnEmails').onclick = ()=>{
    const emails = lastRows.map(r=>r.email).filter(Boolean);
    if(!emails.length) return toast('No emails in current list');
    navigator.clipboard?.writeText(emails.join(', '));
    toast(`Copied ${emails.length} email(s)`);
  };

  sel('#btnExport').onclick = ()=>{
    const rows = lastRows;
    if(!rows.length){ toast('Nothing to export'); return; }
    const cols = ['id','first_name','last_name','email','phone','job_title','pay_type','status','payroll_ref'];
    const head = cols.join(',');
    const csv = [head].concat(rows.map(r=> cols.map(k=>{
      const v = r[k] ?? '';
      const s = String(v).replace(/"/g,'""');
      return `"${s}"`;
    }).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='candidates.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  };

  // first load
  await loadList();
}
</script>
</body>
</html>
