<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Candidates — Admin | HMJ-Global</title>

<!-- Identity first -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Shared admin bootstrap -->
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{--bg:#0b0f18;--panel:#111827;--border:#252f3f;--text:#e8eef7;--muted:#9fb0c9}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:5}
  .row{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  input{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Candidates — Admin</div><div class="sp"></div>
  <a class="btn" href="/admin/">⟵ Admin home</a>
  <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
</div></div>

<!-- GATE (shown when not admin / not logged in) -->
<div class="wrap" id="gate" style="display:none">
  <div class="card"><strong>Admin only.</strong> <p class="why muted"></p>
  <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button></div>
</div>

<!-- APP (shown when admin) -->
<div class="wrap" id="app" style="display:none">
  <div class="card" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input id="q" placeholder="Search name / email / phone" />
    <button class="btn" id="btnRefresh">Refresh</button>
    <button class="btn" id="btnNew">New candidate</button>
  </div>

  <div class="card" id="listWrap">Loading…</div>

  <div class="card" id="editor" style="display:none">
    <h3 style="margin:0 0 8px" id="edTitle">Candidate</h3>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      <label>Name <input id="edName"></label>
      <label>Email <input id="edEmail" type="email"></label>
      <label>Phone <input id="edPhone"></label>
      <label>Address <input id="edAddress"></label>
      <label>Payroll ref <input id="edPayroll"></label>
      <label>Pay type <input id="edPayType"></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="btnSave">Save</button>
      <button class="btn" id="btnDelete">Delete</button>
      <button class="btn" id="btnClose">Close</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* page logic – uses helpers from /admin/common.js */
async function main({ api, sel, toast }) {
  const listWrap = sel('#listWrap');
  const ed = sel('#editor');
  let cur = null; // current candidate

  function setEd(c) {
    sel('#edTitle').textContent = c?.id ? `Candidate #${c.id}` : 'New candidate';
    sel('#edName').value    = c?.name || '';
    sel('#edEmail').value   = c?.email || '';
    sel('#edPhone').value   = c?.phone || '';
    sel('#edAddress').value = (c?.address_json && (c.address_json.line1 || c.address_json.address)) || '';
    sel('#edPayroll').value = c?.payroll_ref || '';
    sel('#edPayType').value = c?.pay_type || '';
  }
  function getEd() {
    return {
      id: cur?.id,
      name: sel('#edName').value.trim() || null,
      email: sel('#edEmail').value.trim() || null,
      phone: sel('#edPhone').value.trim() || null,
      address_json: sel('#edAddress').value ? { address: sel('#edAddress').value } : {},
      payroll_ref: sel('#edPayroll').value || null,
      pay_type: sel('#edPayType').value || null
    };
  }

  async function loadList() {
    listWrap.textContent = 'Loading…';
    try {
      const rows = await api('/admin-candidates-lists','POST',{ q: sel('#q').value || '' });
      listWrap.innerHTML = `
        <div class="muted" style="margin-bottom:8px">${rows.length} candidate(s)</div>
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th></th></tr></thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${r.id}</td>
                <td>${r.name || '—'}</td>
                <td>${r.email || '—'}</td>
                <td>${r.phone || '—'}</td>
                <td><button class="btn" data-open="${r.id}">Open</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
      listWrap.querySelectorAll('button[data-open]').forEach(b => b.onclick = () => openEd(Number(b.dataset.open)));
    } catch (e) {
      console.error(e);
      listWrap.innerHTML = `<div class="muted">Failed to load: ${e.message}</div>`;
    }
  }

  async function openEd(id) {
    try {
      const c = id ? await api('/admin-candidates-get','POST',{ id }) : {};
      cur = c || {};
      setEd(cur);
      ed.style.display = 'block';
      ed.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (e) {
      toast('Open failed: ' + e.message, 'error');
    }
  }

  async function saveEd() {
    try {
      const payload = getEd();
      const saved = await api('/admin-candidates-save','POST', payload);
      toast('Saved');
      cur = saved;
      setEd(cur);
      loadList();
    } catch (e) {
      toast('Save failed: ' + e.message, 'error');
    }
  }

  async function deleteEd() {
    if (!cur?.id) return;
    if (!confirm('Delete this candidate?')) return;
    try {
      await api('/admin-candidates-delete','POST',{ id: cur.id });
      toast('Deleted');
      ed.style.display = 'none';
      cur = null;
      loadList();
    } catch (e) {
      toast('Delete failed: ' + e.message, 'error');
    }
  }

  // UI events
  sel('#btnRefresh').onclick = loadList;
  sel('#btnNew').onclick = () => openEd(null);
  sel('#btnSave').onclick = saveEd;
  sel('#btnDelete').onclick = deleteEd;
  sel('#btnClose').onclick = () => { ed.style.display = 'none'; cur = null; };

  // First load
  loadList();
}
</script>
</body>
</html>
