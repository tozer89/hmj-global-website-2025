<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Candidate Profile — Admin | HMJ Global</title>
  <script>window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';</script>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script defer src="/admin/common.js?v=21"></script>
  <style>
    :root {
      --ink:#101828; --bg:#ffffff; --muted:#667085;
      --blue:#2f4ea2; --blue-2:#27408f;
      --card:#f8fafc; --stroke:#e5e7eb; --ring:#c7d2fe;
      --success:#16a34a; --danger:#dc2626; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:50;background:var(--blue);color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
    .row{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
    .brand a{display:inline-flex;gap:8px;align-items:center;color:#fff;text-decoration:none}
    .brand .logo{width:28px;height:28px;border-radius:6px;background:#fff;display:grid;place-items:center;color:var(--blue);font-weight:900}
    .pill{display:inline-flex;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.14);font-size:12px;font-weight:700}
    .sp{flex:1}
    .btn{background:var(--blue);color:#fff;border:1px solid rgba(255,255,255,.25);padding:9px 14px;border-radius:12px;font-weight:700;cursor:pointer;user-select:none}
    .btn:hover{background:var(--blue-2)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.35)}
    .btn.light{background:#fff;color:var(--blue);border-color:#fff}
    .wrap{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;gap:18px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:18px}
    .section{display:grid;gap:12px}
    h2{margin:0 0 8px;font-size:24px}
    h3{margin:0;font-size:18px}
    dl{display:grid;grid-template-columns:minmax(160px,220px) 1fr;gap:6px 12px;margin:0}
    dt{font-weight:700;color:#334155}
    dd{margin:0;color:#0f172a}
    .muted{color:var(--muted)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:#fff;font-weight:700;font-size:13px;color:var(--blue)}
    .pill.ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
    .pill.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .links{display:flex;flex-wrap:wrap;gap:10px}
    a.link{color:var(--blue);font-weight:700;text-decoration:none}
    a.link:hover{text-decoration:underline}
    @media (max-width:720px){
      dl{grid-template-columns:1fr}
      .row{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">
      <a href="../"><span class="logo">H</span> HMJ Global</a>
      <span class="pill">Admin</span>
      <span class="pill">Candidate profile</span>
    </div>
    <div class="chips" id="diag"></div>
    <div class="sp"></div>
    <a class="btn ghost" href="./candidates.html">⟵ Candidates</a>
    <a class="btn ghost" href="./">Dashboard</a>
    <button class="btn light" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <div class="wrap" id="gate" style="display:none">
    <div class="card">
      <strong>Admin only.</strong>
      <p class="muted" id="gateWhy">Checking your session…</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <div class="wrap" id="content" style="display:none">
    <div class="card section" id="summary"></div>
    <div class="card section" id="contact"></div>
    <div class="card section" id="employment"></div>
    <div class="card section" id="compliance"></div>
    <div class="card section" id="notes"></div>
  </div>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function startProfile(){
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function') {
      return setTimeout(startProfile, 40);
    }

    Admin.bootAdmin(async ({ api, sel, toast, identity, getTrace }) => {
      const chips = sel('#diag');
      const chip = (text, tone='ok', key='') => {
        if (!chips) return;
        if (key) {
          const existing = chips.querySelector(`[data-chip="${key}"]`);
          if (existing) existing.remove();
        }
        const span = document.createElement('span');
        span.className = `chip ${tone}`;
        if (key) span.dataset.chip = key;
        span.textContent = text;
        chips.appendChild(span);
      };
      chip('trace:'+getTrace().slice(0,10),'ok','trace');

      const who = await identity('admin');
      if (!who || !who.ok) {
        chip('auth: blocked','warn','auth');
        const gate = sel('#gate');
        const why = sel('#gateWhy');
        if (gate) gate.style.display='';
        if (why) why.textContent = 'Restricted. Sign in with an admin account.';
        return;
      }
      chip('auth: admin','ok','auth');
      const gate = sel('#gate');
      if (gate) gate.style.display='none';
      const content = sel('#content');
      if (content) content.style.display='grid';

      const params = new URLSearchParams(location.search);
      const id = Number(params.get('id') || params.get('candidate') || '0');
      if (!id) {
        toast('No candidate id provided.', 'error', 5000);
        sel('#summary').innerHTML = '<h2>Candidate not found</h2><p class="muted">Provide ?id=123 in the URL.</p>';
        return;
      }
      chip('candidate:#'+id,'ok','id');

      async function loadFallback(id){
        try {
          const res = await fetch('/data/candidates.json', { cache:'no-store' });
          if (!res.ok) return null;
          const json = await res.json();
          const rows = Array.isArray(json?.candidates) ? json.candidates : Array.isArray(json) ? json : [];
          return rows.find((r) => Number(r.id) === Number(id)) || null;
        } catch (err) {
          console.warn('[profile] fallback load failed', err);
          return null;
        }
      }

      let record = null;
      try {
        const res = await api('admin-candidates-get', 'POST', { id });
        record = res || null;
        chip('source: supabase','ok','source');
      } catch (err) {
        console.error('[profile] live fetch failed', err);
        chip('source: fallback','warn','source');
        toast('Supabase unavailable — showing fallback profile.', 'warn', 4200);
        record = await loadFallback(id);
      }

      if (!record) {
        sel('#summary').innerHTML = '<h2>Candidate not found</h2><p class="muted">No record available for this id.</p>';
        return;
      }

      const fullName = `${record.first_name || ''} ${record.last_name || ''}`.trim() || record.full_name || 'Candidate';
      document.title = `${fullName} — Candidate Profile | HMJ Global`;

      function value(v){
        if (v === null || v === undefined) return '—';
        if (Array.isArray(v)) return v.length ? v.join(', ') : '—';
        if (typeof v === 'boolean') return v ? 'Yes' : 'No';
        return String(v || '').trim() || '—';
      }

      function renderSummary(){
        const summary = sel('#summary');
        const tags = [];
        if (record.status) tags.push(record.status);
        if (record.pay_type) tags.push(record.pay_type);
        if (record.timesheet_status) tags.push(`Timesheets: ${record.timesheet_status}`);
        summary.innerHTML = `
          <h2>${fullName}</h2>
          <div class="links">
            <a class="link" href="/admin/assignments.html?q=${encodeURIComponent(fullName)}" target="_blank" rel="noopener">View assignments</a>
            <a class="link" href="/admin/timesheets.html?candidate=${encodeURIComponent(fullName)}" target="_blank" rel="noopener">View timesheets</a>
            <a class="link" href="/admin/jobs.html" target="_blank" rel="noopener">Open jobs console</a>
          </div>
          <div class="chips">${tags.map((tag) => `<span class="chip">${tag}</span>`).join('')}</div>
        `;
      }

      function renderContact(){
        const contact = sel('#contact');
        contact.innerHTML = `
          <h3>Contact</h3>
          <dl>
            <dt>Email</dt><dd>${value(record.email)}</dd>
            <dt>Phone</dt><dd>${value(record.phone)}</dd>
            <dt>Address</dt><dd>${[record.address1, record.address2, record.town, record.county, record.postcode, record.country].filter(Boolean).join(', ') || '—'}</dd>
            <dt>Emergency contact</dt><dd>${value(record.emergency_name)} · ${value(record.emergency_phone)}</dd>
            <dt>Payroll ref</dt><dd>${value(record.payroll_ref)}</dd>
            <dt>Internal ref</dt><dd>${value(record.internal_ref)}</dd>
            <dt>Tax ID</dt><dd>${value(record.tax_id)}</dd>
          </dl>
        `;
      }

      function renderEmployment(){
        const employment = sel('#employment');
        employment.innerHTML = `
          <h3>Employment</h3>
          <dl>
            <dt>Role</dt><dd>${value(record.job_title || record.role)}</dd>
            <dt>Client</dt><dd>${value(record.client_name)}</dd>
            <dt>Start date</dt><dd>${value(record.start_date)}</dd>
            <dt>End date</dt><dd>${value(record.end_date)}</dd>
            <dt>Pay type</dt><dd>${value(record.pay_type)}</dd>
            <dt>Bank</dt><dd>${value(record.bank_name)} · ${value(record.bank_sort_code || record.bank_sort)} · ${value(record.bank_account)}</dd>
            <dt>Skills / tags</dt><dd>${value(record.skills)}</dd>
          </dl>
        `;
      }

      function renderCompliance(){
        const compliance = sel('#compliance');
        compliance.innerHTML = `
          <h3>Compliance</h3>
          <dl>
            <dt>Right to work</dt><dd>${record.right_to_work ? 'Verified' : 'Pending'}${record.rtw_url ? ` · <a class="link" href="${record.rtw_url}" target="_blank" rel="noopener">View file</a>` : ''}</dd>
            <dt>Contract</dt><dd>${record.contract_url ? `<a class="link" href="${record.contract_url}" target="_blank" rel="noopener">Open contract</a>` : '—'}</dd>
            <dt>Terms accepted</dt><dd>${record.terms_ok ? 'Yes' : 'No'}</dd>
            <dt>Timesheet status</dt><dd>${value(record.timesheet_status)}</dd>
            <dt>Updated</dt><dd>${value(record.updated_at || record.created_at)}</dd>
          </dl>
        `;
      }

      function renderNotes(){
        const notes = sel('#notes');
        notes.innerHTML = `
          <h3>Notes</h3>
          <p>${record.notes ? record.notes.replace(/\n/g,'<br>') : '<span class="muted">No notes captured.</span>'}</p>
        `;
      }

      renderSummary();
      renderContact();
      renderEmployment();
      renderCompliance();
      renderNotes();
    });
  })();
  </script>
</body>
</html>
