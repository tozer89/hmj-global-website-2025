<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Admin Dashboard | HMJ Global</title>

  <script>window.ADMIN_IDENTITY_URL = '/.netlify/identity';</script>
  <script defer src="../js/identity-loader.js"></script>
  <script defer src="/admin/common.js?v=21"></script>
  <link rel="stylesheet" href="/assets/css/admin.dashboard.enhanced.css?v=1"/>
  <script defer src="/assets/js/admin.dashboard.enhanced.js?v=1"></script>

  <style>
    :root{ --bg:#f4f6ff; --panel:#ffffff; --border:#d7def3; --highlight:#2f4ea2; --muted:#5d6f9e; --ink:#0f1b3f; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}

    .top{position:sticky;top:0;z-index:80;background:linear-gradient(180deg,var(--highlight),#284190);color:#fff;border-bottom:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(15,27,63,.18)}
    .row{max-width:1320px;margin:0 auto;padding:14px 22px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;letter-spacing:.02em}
    .sp{flex:1}

    .btn{background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.1));color:#1b2b5a;border:1px solid rgba(255,255,255,.4);padding:9px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .16s ease,box-shadow .2s ease,border-color .2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(15,27,63,.22);border-color:rgba(255,255,255,.6)}
    .btn.outline{background:#fff;color:var(--highlight);border-color:rgba(47,78,162,.25)}

    .wrap{max-width:1320px;margin:28px auto;padding:0 22px;display:grid;gap:22px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 18px 40px rgba(15,27,63,.12)}
    .muted{color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px}
    .card{display:flex;flex-direction:column;gap:12px;padding:18px;border-radius:16px;border:1px solid rgba(47,78,162,.18);background:#fff;box-shadow:0 18px 36px rgba(15,27,63,.12);transition:transform .16s ease,box-shadow .2s ease,border-color .2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 22px 44px rgba(15,27,63,.18);border-color:rgba(47,78,162,.35)}
    .card h3{margin:0;font-size:18px}
    .card p{margin:0;color:var(--muted)}
    .panel pre{background:#f8faff;border:1px solid var(--border);border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:13px;color:var(--muted)}

    #toast{position:fixed;right:18px;bottom:18px;display:grid;gap:10px;z-index:9999}
    #toast .notice{padding:10px 12px;border-radius:12px;background:#fff;border:1px solid rgba(47,78,162,.25);box-shadow:0 16px 30px rgba(15,27,63,.18);font-weight:700}
  </style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">HMJ Global Admin</div>
    <div class="sp"></div>
    <a class="btn outline" href="/">‚Üê Website</a>
    <button class="btn outline" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <div class="wrap" id="gate" style="display:none">
    <div class="panel">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your session‚Ä¶</p>
      <button class="btn outline" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <section class="panel hero" aria-labelledby="welcomeHeading">
      <div class="hero-main">
        <div>
          <p class="eyebrow">Welcome back</p>
          <h2 id="welcomeHeading">Admin</h2>
          <p class="muted" id="welcomeMeta">Loading user‚Ä¶</p>
        </div>
        <div class="hero-meta" aria-live="polite" id="envMeta">Environment ‚Ä¢ Detecting‚Ä¶</div>
      </div>
      <div class="hero-actions">
        <button id="themeToggle" class="btn ghost small" aria-pressed="false" title="Toggle theme">üåì</button>
        <details class="view-settings">
          <summary class="btn ghost small" aria-haspopup="true">View options</summary>
          <div class="view-panel" role="group" aria-label="Dashboard view preferences">
            <label class="switch">
              <input type="checkbox" id="toggleKpis" checked>
              <span>Show KPI row</span>
            </label>
            <label class="switch">
              <span>Tile order</span>
              <select id="tileOrderSelect">
                <option value="default">Default</option>
                <option value="alpha">A ‚Üí Z</option>
                <option value="recent">Most recent</option>
              </select>
            </label>
            <button type="button" class="btn ghost small" id="resetView">Reset view</button>
          </div>
        </details>
      </div>
    </section>

    <section id="kpis" class="panel kpi-row" hidden></section>

    <section class="grid" aria-label="Admin areas" data-tile-order>
      <a class="card" href="/admin/clients.html">
        <h3>Clients</h3>
        <p>Manage client records, contacts, billing terms, and linked assignments.</p>
      </a>
      <a class="card" href="/admin/candidates.html">
        <h3>Candidates</h3>
        <p>Track candidate compliance, documentation, and onboarding status.</p>
      </a>
      <a class="card" href="/admin/assignments.html">
        <h3>Assignments</h3>
        <p>Oversee placements, rates, and contract metadata.</p>
      </a>
      <a class="card" href="/admin/jobs.html">
        <h3>Jobs</h3>
        <p>Control the live job board, categories, tags, and shareable specs.</p>
      </a>
      <a class="card" href="/admin/payroll.html">
        <h3>Payroll</h3>
        <p>Review approved timesheets, verify banking details, and mark pay runs.</p>
      </a>
      <a class="card" href="/admin/timesheets.html">
        <h3>Timesheets</h3>
        <p>Approve submissions, raise new sheets, and chase outstanding hours.</p>
      </a>
      <a class="card" href="/admin/reports.html">
        <h3>Reports</h3>
        <p>Access exports and audit logs for compliance and finance teams.</p>
      </a>
    </section>

    <section id="activityFeed" class="panel activity" hidden></section>

    <section class="panel" id="netlifyTools">
      <h3 style="margin:0 0 8px">Netlify tools</h3>
      <p class="muted" style="margin:0 0 12px">Run a health check on the deployed functions or jump to the Netlify deploy dashboard.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn outline" id="btnHealth">Run Supabase health check</button>
        <a class="btn" href="https://app.netlify.com/sites/hmjg/deploys" target="_blank" rel="noopener">Open Netlify deploys</a>
      </div>
      <pre id="healthResult" style="display:none;margin-top:14px"></pre>
      <div class="health-chips" aria-live="polite" hidden>
        <span class="chip" data-target="api">API: <span class="value">‚Äî</span></span>
        <span class="chip" data-target="db">DB: <span class="value">‚Äî</span></span>
        <span class="chip" data-target="storage">Storage: <span class="value">‚Äî</span></span>
      </div>
      <div class="logs-row" hidden>
        <a class="btn ghost small" data-log="api" target="_blank" rel="noopener">Open API logs</a>
        <a class="btn ghost small" data-log="db" target="_blank" rel="noopener">Open DB logs</a>
        <a class="btn ghost small" data-log="storage" target="_blank" rel="noopener">Open Storage logs</a>
      </div>
    </section>

    <section id="notesBoard" class="panel notes-board" hidden></section>
  </div>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function startDashboard(){
    if (!window.Admin || typeof window.Admin.bootAdmin !== 'function') {
      return setTimeout(startDashboard, 40);
    }

    window.Admin.bootAdmin(async (helpers) => {
      const { identity, sel, toast } = helpers;
      try {
        const who = await identity('admin');
        if (who?.ok) {
          sel('#welcomeMeta').textContent = `Signed in as ${who.email || 'admin user'}`;
          if (window.HMJDashboardEnhancer && typeof window.HMJDashboardEnhancer.init === 'function') {
            window.HMJDashboardEnhancer.init({ helpers, who });
          }
        }
      } catch (e) {
        toast('Unable to load user details', 'warn', 2600);
      }

      const btnHealth = sel('#btnHealth');
      const healthResult = sel('#healthResult');
      if (btnHealth) {
        btnHealth.onclick = async () => {
          if (healthResult) {
            healthResult.style.display = 'block';
            healthResult.textContent = 'Checking Netlify function‚Ä¶';
          }
          try {
            const res = await fetch('/.netlify/functions/supa-health', { credentials: 'include' });
            const txt = await res.text();
            let display = txt;
            try { display = JSON.stringify(JSON.parse(txt), null, 2); } catch {}
            if (healthResult) healthResult.textContent = display || 'OK';
            (window.hmjToast || toast)('Health check complete', 'info', 2000);
            window.dispatchEvent(new CustomEvent('hmj:admin:health', { detail: { ok: true, raw: txt, at: Date.now() } }));
          } catch (err) {
            if (healthResult) healthResult.textContent = 'Error: ' + (err.message || err);
            (window.hmjToast || toast)('Health check failed', 'error', 3200);
            window.dispatchEvent(new CustomEvent('hmj:admin:health', { detail: { ok: false, error: err, at: Date.now() } }));
          }
        };
      }
    });
  })();
  </script>
</body>
</html>
