<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HMJ Admin – Payroll Export (TEST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/style.css" />
  <script defer src="/js/hmj-nav.js"></script>
  <style>
    :root {
      --ink: #0f1b3f;
      --accent: #3a66b3;
      --muted: #6b7280;
      --panel: #0f1322;
      --soft: #f7f8ff;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f97316;
    }

    body {
      background: #f5f7fa;
      color: var(--ink);
    }

    .admin-hero {
      padding: 140px 20px 60px;
      background: linear-gradient(180deg, rgba(15, 19, 34, 0.9), rgba(15, 19, 34, 0.6)),
        url("/images/hero.jpg") center/cover no-repeat;
      color: #fff;
    }

    .admin-hero__card {
      max-width: 820px;
      margin: 0 auto;
      padding: 32px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.95);
      color: var(--ink);
      box-shadow: 0 18px 40px rgba(15, 19, 34, 0.25);
    }

    .admin-hero__eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.8rem;
      color: var(--accent);
      margin: 0 0 12px;
      font-weight: 700;
    }

    .admin-hero h1 {
      margin: 0 0 12px;
      font-size: 2.4rem;
    }

    .admin-hero p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.6;
    }

    .admin-meta {
      margin-top: 18px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(58, 102, 179, 0.12);
      color: #34508f;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .section {
      padding: 42px 20px;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    .admin-panel {
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(15, 19, 34, 0.08);
      box-shadow: 0 12px 30px rgba(15, 19, 34, 0.08);
      padding: 28px;
    }

    .admin-panel__header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .admin-panel__header h2 {
      margin: 0;
      font-size: 1.5rem;
    }

    .admin-updated {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .debug-panel {
      margin-top: 20px;
      border-radius: 14px;
      border: 1px solid rgba(15, 19, 34, 0.12);
      background: #fff;
      padding: 16px 18px;
    }

    .debug-panel summary {
      cursor: pointer;
      font-weight: 700;
      color: var(--ink);
    }

    .debug-panel__body {
      margin-top: 12px;
      background: var(--soft);
      border-radius: 12px;
      padding: 12px 14px;
    }

    .debug-panel__body .json-output {
      margin-top: 8px;
      max-height: 280px;
    }

    .tool-card {
      border-radius: 16px;
      border: 1px solid rgba(15, 19, 34, 0.08);
      padding: 18px;
      background: linear-gradient(180deg, rgba(58, 102, 179, 0.06), #fff 60%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-height: 260px;
    }

    .tool-card h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .tool-card button {
      border: none;
      cursor: pointer;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-idle {
      background: rgba(107, 114, 128, 0.15);
      color: var(--muted);
    }

    .status-running {
      background: rgba(249, 115, 22, 0.2);
      color: var(--warning);
    }

    .status-success {
      background: rgba(22, 163, 74, 0.2);
      color: var(--success);
    }

    .status-error {
      background: rgba(220, 38, 38, 0.2);
      color: var(--danger);
    }

    .status-warning {
      background: rgba(249, 115, 22, 0.2);
      color: var(--warning);
    }

    pre.json-output {
      margin: 0;
      padding: 12px;
      background: #0f1322;
      color: #e5e7eb;
      border-radius: 12px;
      font-size: 0.78rem;
      line-height: 1.4;
      overflow-x: auto;
      max-height: 220px;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
    }

    .report-card {
      padding: 20px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(15, 19, 34, 0.08);
      box-shadow: 0 10px 24px rgba(15, 19, 34, 0.08);
    }

    .report-card h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    .admin-panel__actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .report-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .report-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .report-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .report-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 12px 0 16px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      font-weight: 600;
    }

    .filter-control {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(15, 19, 34, 0.2);
      background: #fff;
      font-size: 0.9rem;
    }

    .btn-secondary {
      border: 1px solid rgba(58, 102, 179, 0.4);
      background: #fff;
      color: var(--accent);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }

    .metric {
      background: var(--soft);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(15, 19, 34, 0.08);
    }

    .metric span {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .metric strong {
      font-size: 1.05rem;
      color: var(--ink);
    }

    .exception-group {
      border: 1px solid rgba(15, 19, 34, 0.1);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background: #fff;
    }

    .exception-group summary {
      cursor: pointer;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th,
    td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(15, 19, 34, 0.08);
    }

    th {
      color: var(--muted);
      font-weight: 600;
    }

    @media (max-width: 720px) {
      .admin-hero {
        padding-top: 120px;
      }
      .admin-panel {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <header class="hmj-header">
    <nav class="hmj-nav" aria-label="Main">
      <a class="hmj-logo" href="/index.html">
        <img src="/images/logo.png" alt="HMJ-Global Logo" />
      </a>

      <button class="hmj-burger" aria-label="Open menu" aria-expanded="false" aria-controls="hmj-menu">
        <span></span><span></span><span></span>
      </button>

      <ul id="hmj-menu" class="hmj-menu">
        <li><a href="/index.html" data-page="index">Home</a></li>
        <li><a href="/about.html" data-page="about">About</a></li>
        <li><a href="/clients.html" data-page="clients">Clients</a></li>
        <li><a href="/candidates.html" data-page="candidates">Candidates</a></li>
        <li><a href="/jobs.html" data-page="jobs">Jobs</a></li>
        <li><a href="https://www.hmj-finance.com" target="_blank" rel="noopener">Accounting</a></li>
        <li><a href="/admin/" id="nav-admin">Admin</a></li>
      </ul>
      <div class="hmj-scrim" hidden></div>
    </nav>
  </header>

  <main>
    <section class="admin-hero">
      <div class="wrap">
        <div class="admin-hero__card">
          <p class="admin-hero__eyebrow">HMJ Admin – Payroll Export (TEST)</p>
          <h1>Payroll Export – Test Area</h1>
          <p>
            This test-only dashboard runs on the <strong>feature/payroll-admin</strong> branch.
            It is safe to use in deploy previews and does not affect production payroll data.
          </p>
          <div class="admin-meta">Environment: TEST / DEPLOY PREVIEW</div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="wrap">
        <div class="admin-panel">
          <div class="admin-panel__header">
            <div>
              <h2>TSP API Tools</h2>
              <p class="admin-updated">Last updated: <span id="last-updated">—</span></p>
            </div>
            <div class="admin-panel__actions">
              <span class="status-badge status-idle" id="mode-badge">Mode: Unknown</span>
              <span class="status-badge status-idle" id="auth-badge">Auth: Unknown</span>
              <button class="btn-primary" id="run-all" data-default="Run all checks" data-running="Running checks...">
                Run all checks
              </button>
            </div>
          </div>
          <div class="admin-grid">
            <div class="tool-card">
              <div>
                <h3>Check env</h3>
                <p class="admin-updated">Verify TSP environment variables.</p>
              </div>
              <span class="status-badge status-idle" id="status-ping">Idle</span>
              <button class="btn-primary" id="btn-ping" data-default="Check env" data-running="Running...">Check env</button>
              <pre class="json-output" id="result-ping">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>Health check</h3>
                <p class="admin-updated">Ping a lightweight TSP endpoint.</p>
              </div>
              <span class="status-badge status-idle" id="status-health">Idle</span>
              <button class="btn-primary" id="btn-health" data-default="Health check" data-running="Running...">Health check</button>
              <pre class="json-output" id="result-health">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>Who am I</h3>
                <p class="admin-updated">Fetch current API user info.</p>
              </div>
              <span class="status-badge status-idle" id="status-whoami">Idle</span>
              <button class="btn-primary" id="btn-whoami" data-default="Who am I" data-running="Running...">Who am I</button>
              <pre class="json-output" id="result-whoami">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List clients</h3>
                <p class="admin-updated">Pull clients for reporting.</p>
              </div>
              <span class="status-badge status-idle" id="status-clients">Idle</span>
              <button class="btn-primary" id="btn-clients" data-default="List clients" data-running="Running...">List clients</button>
              <pre class="json-output" id="result-clients">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List placements</h3>
                <p class="admin-updated">Fetch placements/assignments.</p>
              </div>
              <span class="status-badge status-idle" id="status-placements">Idle</span>
              <button class="btn-primary" id="btn-placements" data-default="List placements" data-running="Running...">List placements</button>
              <pre class="json-output" id="result-placements">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List users</h3>
                <p class="admin-updated">Pull users for verification.</p>
              </div>
              <span class="status-badge status-idle" id="status-users">Idle</span>
              <button class="btn-primary" id="btn-users" data-default="List users" data-running="Running...">List users</button>
              <pre class="json-output" id="result-users">{}</pre>
            </div>
          </div>
          <details class="debug-panel" id="debug-panel">
            <summary>Debug</summary>
            <div class="debug-panel__body">
              <p class="admin-updated">Shown automatically when a TSP request fails.</p>
              <pre class="json-output" id="debug-output">{}</pre>
            </div>
          </details>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="wrap">
        <div class="report-grid">
          <div class="report-card">
            <h3>Clients summary</h3>
            <div class="report-summary" id="clients-summary">Awaiting data...</div>
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="clients-table">
                <tr><td colspan="2">Run “List clients” to populate.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="report-card">
            <h3>Placements summary</h3>
            <div class="report-summary" id="placements-summary">Awaiting data...</div>
            <table>
              <thead>
                <tr>
                  <th>Placement</th>
                  <th>Client</th>
                  <th>Dates</th>
                </tr>
              </thead>
              <tbody id="placements-table">
                <tr><td colspan="3">Run “List placements” to populate.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="wrap">
        <div class="report-grid">
          <div class="report-card" id="weekly-summary-card">
            <div class="report-card__header">
              <h3>Weekly Payroll &amp; GM Summary</h3>
              <div class="report-actions">
                <button class="btn-secondary" id="btn-summary-refresh">Refresh</button>
                <button class="btn-primary" id="btn-summary-export">Download CSV</button>
              </div>
            </div>
            <div class="report-filters">
              <div class="filter-group">
                <label class="filter-label" for="summary-week">Week ending</label>
                <select class="filter-control" id="summary-week"></select>
              </div>
              <div class="filter-group">
                <label class="filter-label" for="summary-client">Client</label>
                <select class="filter-control" id="summary-client"></select>
              </div>
            </div>
            <div class="metrics-grid" id="summary-metrics"></div>
            <div class="report-summary" id="summary-statuses">Awaiting data...</div>
            <table>
              <thead>
                <tr>
                  <th>Contractor</th>
                  <th>Client</th>
                  <th>Week ending</th>
                  <th>Std</th>
                  <th>OT</th>
                  <th>Pay</th>
                  <th>Charge</th>
                  <th>GP</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="summary-rows">
                <tr><td colspan="9">Run “Refresh” to populate.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="report-card" id="exceptions-card">
            <div class="report-card__header">
              <h3>Data Quality / Exceptions Report</h3>
              <div class="report-actions">
                <button class="btn-secondary" id="btn-exceptions-refresh">Refresh</button>
                <button class="btn-primary" id="btn-exceptions-export">Export exceptions CSV</button>
              </div>
            </div>
            <div class="report-filters">
              <div class="filter-group">
                <label class="filter-label" for="exceptions-week">Week ending</label>
                <select class="filter-control" id="exceptions-week"></select>
              </div>
              <div class="filter-group">
                <label class="filter-label" for="exceptions-client">Client</label>
                <select class="filter-control" id="exceptions-client"></select>
              </div>
            </div>
            <div class="report-summary" id="exceptions-summary">Awaiting data...</div>
            <div id="exceptions-list"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const endpoints = {
      ping: {
        url: "/.netlify/functions/tsp-ping",
        buttonId: "btn-ping",
        badgeId: "status-ping",
        outputId: "result-ping",
      },
      health: {
        url: "/.netlify/functions/tsp-health",
        buttonId: "btn-health",
        badgeId: "status-health",
        outputId: "result-health",
      },
      whoami: {
        url: "/.netlify/functions/tsp-whoami",
        buttonId: "btn-whoami",
        badgeId: "status-whoami",
        outputId: "result-whoami",
      },
      clients: {
        url: "/.netlify/functions/tsp-list-clients?limit=20",
        buttonId: "btn-clients",
        badgeId: "status-clients",
        outputId: "result-clients",
      },
      placements: {
        url: "/.netlify/functions/tsp-list-placements?status=active&limit=20",
        buttonId: "btn-placements",
        badgeId: "status-placements",
        outputId: "result-placements",
      },
      users: {
        url: "/.netlify/functions/tsp-list-users?limit=20",
        buttonId: "btn-users",
        badgeId: "status-users",
        outputId: "result-users",
      },
    };

    const setBadge = (id, state, text) => {
      const badge = document.getElementById(id);
      if (!badge) return;
      badge.classList.remove("status-idle", "status-running", "status-success", "status-error");
      badge.classList.add(`status-${state}`);
      badge.textContent = text;
    };

    const setModeBadge = (mode) => {
      const badge = document.getElementById("mode-badge");
      if (!badge) return;
      badge.classList.remove("status-idle", "status-success", "status-warning");

      if (mode === "live") {
        badge.classList.add("status-success");
        badge.textContent = "Mode: LIVE";
        return;
      }

      if (mode === "standby") {
        badge.classList.add("status-warning");
        badge.textContent = "Mode: Standby";
        return;
      }

      badge.classList.add("status-idle");
      badge.textContent = "Mode: Unknown";
    };

    const setAuthBadge = (authMode, note) => {
      const badge = document.getElementById("auth-badge");
      if (!badge) return;
      badge.classList.remove("status-idle", "status-success", "status-warning", "status-error");

      if (authMode === "oauth") {
        badge.classList.add("status-success");
        badge.textContent = "Auth: OAuth (client credentials)";
        return;
      }

      if (authMode === "none") {
        badge.classList.add("status-error");
        badge.textContent = "Auth: Not configured";
        return;
      }

      badge.classList.add("status-idle");
      badge.textContent = "Auth: Unknown";
    };

    const updateModeFromResponse = (data, status) => {
      if (data?.mode === "standby") {
        setModeBadge("standby");
        return;
      }

      if (data?.mode === "live" || data?.ok === true || [401, 403, 429].includes(status)) {
        setModeBadge("live");
      }
    };

    const updateAuthFromResponse = (data) => {
      const authMode = data?.auth_mode || data?.debug?.auth?.mode;
      if (!authMode) return;
      const note = data?.note;
      setAuthBadge(authMode, note);
    };

    const setButtonState = (button, running) => {
      if (!button) return;
      button.disabled = running;
      button.textContent = running ? button.dataset.running : button.dataset.default;
    };

    const setRunAllEnabled = (canRun) => {
      const button = document.getElementById("run-all");
      if (!button) return;
      button.disabled = !canRun;
      if (!canRun) {
        button.textContent = button.dataset.default;
      }
    };

    const updateTimestamp = () => {
      const stamp = document.getElementById("last-updated");
      if (!stamp) return;
      stamp.textContent = new Date().toLocaleString();
    };

    const renderJson = (outputId, data) => {
      const output = document.getElementById(outputId);
      if (output) {
        output.textContent = JSON.stringify(data, null, 2);
      }
    };

    const showDebug = (payload) => {
      const debugPanel = document.getElementById("debug-panel");
      const debugOutput = document.getElementById("debug-output");
      if (!debugPanel || !debugOutput) return;
      debugOutput.textContent = JSON.stringify(payload || {}, null, 2);
      debugPanel.open = true;
    };

    const summarizeClients = (payload) => {
      const summary = document.getElementById("clients-summary");
      const table = document.getElementById("clients-table");
      if (!summary || !table) return;

      const clients = Array.isArray(payload.clients) ? payload.clients : [];
      const counts = clients.reduce(
        (acc, client) => {
          const status = (client.status || "unknown").toLowerCase();
          acc.total += 1;
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        },
        { total: 0 }
      );

      summary.textContent = `Total: ${counts.total} · Active: ${counts.active || 0} · Inactive: ${counts.inactive || 0} · Unknown: ${counts.unknown || 0}`;

      table.innerHTML = "";
      const rows = clients.slice(0, 10);
      if (rows.length === 0) {
        table.innerHTML = '<tr><td colspan="2">No clients returned.</td></tr>';
        return;
      }

      rows.forEach((client) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${client.name}</td><td>${client.status}</td>`;
        table.appendChild(row);
      });
    };

    const summarizePlacements = (payload) => {
      const summary = document.getElementById("placements-summary");
      const table = document.getElementById("placements-table");
      if (!summary || !table) return;

      const placements = Array.isArray(payload.placements) ? payload.placements : [];
      const counts = placements.reduce(
        (acc, placement) => {
          const status = (placement.status || "unknown").toLowerCase();
          acc.total += 1;
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        },
        { total: 0 }
      );

      const endpointNote = payload.resolved_endpoint ? ` · Endpoint: ${payload.resolved_endpoint}` : "";
      summary.textContent = `Total: ${counts.total} · Active: ${counts.active || 0} · Inactive: ${counts.inactive || 0} · Unknown: ${counts.unknown || 0}${endpointNote}`;

      table.innerHTML = "";
      const rows = placements.slice(0, 10);
      if (rows.length === 0) {
        table.innerHTML = '<tr><td colspan="3">No placements returned.</td></tr>';
        return;
      }

      rows.forEach((placement) => {
        const row = document.createElement("tr");
        const dates = `${placement.startDate || "—"} → ${placement.endDate || "—"}`;
        row.innerHTML = `<td>${placement.title}</td><td>${placement.clientName}</td><td>${dates}</td>`;
        table.appendChild(row);
      });
    };

    const formatNumber = (value, digits = 2) => {
      const number = Number(value);
      if (!Number.isFinite(number)) return "0";
      return number.toFixed(digits);
    };

    const formatCurrency = (value) => formatNumber(value, 2);

    const populateSelect = (select, options, selectedValue, placeholder = "All") => {
      if (!select) return;
      select.innerHTML = "";

      const placeholderOption = document.createElement("option");
      placeholderOption.value = "";
      placeholderOption.textContent = placeholder;
      select.appendChild(placeholderOption);

      options.forEach((option) => {
        const item = document.createElement("option");
        item.value = option.value;
        item.textContent = option.label;
        if (selectedValue && option.value === selectedValue) {
          item.selected = true;
        }
        select.appendChild(item);
      });
    };

    const summaryState = { data: null };
    const exceptionsState = { data: null };

    const renderSummary = (payload) => {
      summaryState.data = payload;
      const metrics = document.getElementById("summary-metrics");
      const statusSummary = document.getElementById("summary-statuses");
      const rowsTable = document.getElementById("summary-rows");

      if (metrics) {
        const summary = payload.summary || {};
        const cards = [
          { label: "Std hours", value: formatNumber(summary.std_hours) },
          { label: "OT hours", value: formatNumber(summary.ot_hours) },
          { label: "Pay amount", value: formatCurrency(summary.pay_amount) },
          { label: "Charge amount", value: formatCurrency(summary.charge_amount) },
          { label: "Gross profit", value: formatCurrency(summary.gp_amount) },
          { label: "Gross margin %", value: formatNumber(summary.gross_margin_pct) },
        ];

        metrics.innerHTML = cards
          .map((card) => `<div class="metric"><span>${card.label}</span><strong>${card.value}</strong></div>`)
          .join("");
      }

      if (statusSummary) {
        const statusCounts = payload.summary?.status_counts || {};
        const summaryText = Object.entries(statusCounts)
          .map(([status, count]) => `${status}: ${count}`)
          .join(" · ");
        statusSummary.textContent = summaryText || "No status counts available.";
      }

      if (rowsTable) {
        const rows = Array.isArray(payload.rows) ? payload.rows : [];
        rowsTable.innerHTML = "";
        if (!rows.length) {
          rowsTable.innerHTML = '<tr><td colspan="9">No timesheets matched the filters.</td></tr>';
          return;
        }

        rows.slice(0, 25).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.contractor_name || row.candidate_name || "—"}</td>
            <td>${row.client_name || "—"}</td>
            <td>${row.week_ending || "—"}</td>
            <td>${formatNumber(row.std_hours)}</td>
            <td>${formatNumber(row.ot_hours)}</td>
            <td>${formatCurrency(row.pay_amount)}</td>
            <td>${formatCurrency(row.charge_amount)}</td>
            <td>${formatCurrency(row.gp_amount)}</td>
            <td>${row.payroll_status || "—"}</td>
          `;
          rowsTable.appendChild(tr);
        });
      }
    };

    const renderExceptions = (payload) => {
      exceptionsState.data = payload;
      const summary = document.getElementById("exceptions-summary");
      const list = document.getElementById("exceptions-list");

      if (summary) {
        const counts = payload.summary?.counts || {};
        const total = payload.summary?.total_exceptions || 0;
        const summaryText = Object.entries(counts)
          .map(([key, count]) => `${key.replace(/_/g, " ")}: ${count}`)
          .join(" · ");
        summary.textContent = `Total exceptions: ${total}${summaryText ? ` · ${summaryText}` : ""}`;
      }

      if (list) {
        list.innerHTML = "";
        const exceptions = payload.exceptions || {};
        const entries = Object.entries(exceptions);
        if (!entries.length) {
          list.innerHTML = "<p>No exceptions reported.</p>";
          return;
        }

        entries.forEach(([key, exception]) => {
          const rows = exception.rows || [];
          const detail = document.createElement("details");
          detail.className = "exception-group";
          detail.innerHTML = `
            <summary>${exception.label} <span>${rows.length}</span></summary>
            <div>
              <table>
                <thead>
                  <tr>
                    <th>Contractor</th>
                    <th>Client</th>
                    <th>Week</th>
                    <th>Hours</th>
                    <th>Pay</th>
                    <th>Charge</th>
                    <th>GP</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows
                    .slice(0, 20)
                    .map(
                      (row) => `
                        <tr>
                          <td>${row.contractor_name || row.candidate_name || "—"}</td>
                          <td>${row.client_name || "—"}</td>
                          <td>${row.week_ending || "—"}</td>
                          <td>${formatNumber(row.total_hours)}</td>
                          <td>${formatCurrency(row.pay_amount)}</td>
                          <td>${formatCurrency(row.charge_amount)}</td>
                          <td>${formatCurrency(row.gp_amount)}</td>
                          <td>${row.payroll_status || row.status || "—"}</td>
                        </tr>
                      `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
          list.appendChild(detail);
        });
      }
    };

    const downloadCsv = (filename, rows) => {
      const csv = rows.map((row) => row.map((cell) => `"${String(cell ?? "").replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    const exportSummaryCsv = () => {
      const payload = summaryState.data;
      if (!payload) return;
      const summary = payload.summary || {};
      const rows = payload.rows || [];
      const csvRows = [
        ["Summary", "Value"],
        ["Std hours", formatNumber(summary.std_hours)],
        ["OT hours", formatNumber(summary.ot_hours)],
        ["Pay amount", formatCurrency(summary.pay_amount)],
        ["Charge amount", formatCurrency(summary.charge_amount)],
        ["Gross profit", formatCurrency(summary.gp_amount)],
        ["Gross margin %", formatNumber(summary.gross_margin_pct)],
        [],
        [
          "Contractor",
          "Client",
          "Week ending",
          "Std hours",
          "OT hours",
          "Pay amount",
          "Charge amount",
          "GP amount",
          "Status",
        ],
        ...rows.map((row) => [
          row.contractor_name || row.candidate_name || "",
          row.client_name || "",
          row.week_ending || "",
          formatNumber(row.std_hours),
          formatNumber(row.ot_hours),
          formatCurrency(row.pay_amount),
          formatCurrency(row.charge_amount),
          formatCurrency(row.gp_amount),
          row.payroll_status || row.status || "",
        ]),
      ];
      downloadCsv("weekly-payroll-summary.csv", csvRows);
    };

    const exportExceptionsCsv = () => {
      const payload = exceptionsState.data;
      if (!payload) return;
      const exceptions = payload.exceptions || {};
      const rows = [];
      Object.entries(exceptions).forEach(([key, exception]) => {
        (exception.rows || []).forEach((row) => {
          rows.push([
            key,
            exception.label,
            row.id || "",
            row.contractor_name || row.candidate_name || "",
            row.contractor_email || "",
            row.client_name || "",
            row.week_ending || "",
            row.assignment_id || "",
            row.assignment_ref || "",
            row.ts_ref || "",
            formatNumber(row.total_hours),
            formatCurrency(row.pay_amount),
            formatCurrency(row.charge_amount),
            formatCurrency(row.gp_amount),
            row.payroll_status || row.status || "",
          ]);
        });
      });
      const csvRows = [[
        "Exception type",
        "Exception label",
        "Timesheet ID",
        "Contractor",
        "Contractor email",
        "Client",
        "Week ending",
        "Assignment ID",
        "Assignment ref",
        "Timesheet ref",
        "Total hours",
        "Pay amount",
        "Charge amount",
        "GP amount",
        "Status",
      ], ...rows];
      downloadCsv("timesheet-exceptions.csv", csvRows);
    };

    const loadSummary = async () => {
      const weekSelect = document.getElementById("summary-week");
      const clientSelect = document.getElementById("summary-client");
      const params = new URLSearchParams();
      if (weekSelect?.value) params.set("week_ending", weekSelect.value);
      if (clientSelect?.value) params.set("client_id", clientSelect.value);

      const response = await fetch(`/.netlify/functions/admin-timesheets-summary?${params.toString()}`);
      const payload = await response.json();
      if (!response.ok || payload.ok === false) {
        renderSummary({ summary: {}, rows: [], ...payload });
        const statusSummary = document.getElementById("summary-statuses");
        if (statusSummary) {
          statusSummary.textContent = payload.error || "Unable to load summary.";
        }
        return;
      }

      populateSelect(weekSelect, payload.available?.weeks || [], payload.filters?.week_ending || "");
      populateSelect(clientSelect, payload.available?.clients || [], payload.filters?.client_id || "");
      renderSummary(payload);
    };

    const loadExceptions = async () => {
      const weekSelect = document.getElementById("exceptions-week");
      const clientSelect = document.getElementById("exceptions-client");
      const params = new URLSearchParams();
      if (weekSelect?.value) params.set("week_ending", weekSelect.value);
      if (clientSelect?.value) params.set("client_id", clientSelect.value);

      const response = await fetch(`/.netlify/functions/admin-timesheets-exceptions?${params.toString()}`);
      const payload = await response.json();
      if (!response.ok || payload.ok === false) {
        renderExceptions({ summary: {}, exceptions: {}, ...payload });
        const summary = document.getElementById("exceptions-summary");
        if (summary) {
          summary.textContent = payload.error || "Unable to load exceptions report.";
        }
        return;
      }

      populateSelect(weekSelect, payload.available?.weeks || [], payload.filters?.week_ending || "");
      populateSelect(clientSelect, payload.available?.clients || [], payload.filters?.client_id || "");
      renderExceptions(payload);
    };

    const runRequest = async (key) => {
      const config = endpoints[key];
      if (!config) return;
      const button = document.getElementById(config.buttonId);

      setButtonState(button, true);
      setBadge(config.badgeId, "running", "Running");

      try {
        const response = await fetch(config.url);
        const data = await response.json();
        const ok = data.ok !== false && response.ok;
        setBadge(config.badgeId, ok ? "success" : "error", ok ? "Success" : "Fail");
        renderJson(config.outputId, data);
        updateTimestamp();
        updateModeFromResponse(data, response.status);
        updateAuthFromResponse(data);
        if (key === "ping" && data?.can_run !== undefined) {
          setRunAllEnabled(Boolean(data.can_run));
        }
        if (!ok) {
          showDebug(data.debug || data);
        }

        if (key === "clients") {
          summarizeClients(data);
        }
        if (key === "placements") {
          summarizePlacements(data);
        }
      } catch (error) {
        setBadge(config.badgeId, "error", "Fail");
        const errorPayload = { ok: false, error: error.message };
        renderJson(config.outputId, errorPayload);
        updateTimestamp();
        showDebug({ error: error.message });
      } finally {
        setButtonState(button, false);
      }
    };

    Object.entries(endpoints).forEach(([key, config]) => {
      const button = document.getElementById(config.buttonId);
      if (button) {
        button.addEventListener("click", () => runRequest(key));
      }
    });

    const runAllButton = document.getElementById("run-all");
    if (runAllButton) {
      runAllButton.addEventListener("click", async () => {
        setButtonState(runAllButton, true);
        await runRequest("ping");
        await runRequest("health");
        await runRequest("whoami");
        setButtonState(runAllButton, false);
      });
    }

    const summaryRefresh = document.getElementById("btn-summary-refresh");
    const summaryExport = document.getElementById("btn-summary-export");
    const summaryWeek = document.getElementById("summary-week");
    const summaryClient = document.getElementById("summary-client");

    if (summaryRefresh) {
      summaryRefresh.addEventListener("click", loadSummary);
    }
    if (summaryExport) {
      summaryExport.addEventListener("click", exportSummaryCsv);
    }
    if (summaryWeek) {
      summaryWeek.addEventListener("change", loadSummary);
    }
    if (summaryClient) {
      summaryClient.addEventListener("change", loadSummary);
    }

    const exceptionsRefresh = document.getElementById("btn-exceptions-refresh");
    const exceptionsExport = document.getElementById("btn-exceptions-export");
    const exceptionsWeek = document.getElementById("exceptions-week");
    const exceptionsClient = document.getElementById("exceptions-client");

    if (exceptionsRefresh) {
      exceptionsRefresh.addEventListener("click", loadExceptions);
    }
    if (exceptionsExport) {
      exceptionsExport.addEventListener("click", exportExceptionsCsv);
    }
    if (exceptionsWeek) {
      exceptionsWeek.addEventListener("change", loadExceptions);
    }
    if (exceptionsClient) {
      exceptionsClient.addEventListener("change", loadExceptions);
    }

    runRequest("ping");
    loadSummary();
    loadExceptions();
  </script>
</body>
</html>
