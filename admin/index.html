<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>HMJ Global ‚Äî CMS Portal</title>

  <style>
    :root{
      --bg:#0b1420; --panel:#0f1c2b; --muted:#9fb3c8; --text:#e6edf6;
      --blue:#4c7fff; --green:#1fb981; --red:#ff6b6b; --border:#203042;
    }
    html,body{ margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    a{ color:var(--blue); text-decoration:none }

    .topbar{ position:sticky; top:0; z-index:50; background:rgba(11,20,32,.9);
      backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid var(--border) }
    .row{ max-width:1200px; margin:0 auto; padding:14px 20px; display:flex; gap:10px; align-items:center }
    .brand-dot{ width:8px; height:8px; border-radius:999px; background:#3bb3ff; display:inline-block; margin-right:10px }
    .title{ font-weight:700; letter-spacing:.2px }
    .spacer{ flex:1 }
    .btn{ background:#1a2740; border:1px solid #2b3c55; color:var(--text);
      padding:10px 14px; border-radius:12px; display:inline-flex; align-items:center; gap:8px; transition:all .18s ease; font-weight:600 }
    .btn:hover{ transform:translateY(-1px); border-color:#3b5172 }
    .primary{ background:var(--blue); border-color:transparent }
    .danger{ background:#2a1b1b; border-color:#472a2a }

    .wrap{ max-width:1100px; margin:22px auto; padding:0 20px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px 20px; margin-bottom:18px }
    .h1{ font-size:28px; font-weight:800; margin:0 0 4px }
    .muted{ color:var(--muted) }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
    .kvs{ display:grid; grid-template-columns:240px 1fr; gap:8px; padding:10px 0; border-top:1px dashed var(--border) }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03) }
    .ok{ color:#4fe3a2 } .warn{ color:#ffd166 } .err{ color:#ff8fa3 }
    .hr{ height:1px; background:var(--border); margin:14px 0 }

    /* floating Quick Tools (bottom-right) */
    #hmj-floating-tools{ position:fixed; right:16px; bottom:16px; z-index:9999; }
    #hmj-floating-tools .card{ background:#0f172a; color:#cbd5e1; border:1px solid #233044; border-radius:14px; padding:10px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    #hmj-floating-tools .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    #hmj-floating-tools button, #hmj-floating-tools .ghost{ background:#1f2937; color:#e5e7eb; border:1px solid #334155; padding:7px 10px; border-radius:9px; font-size:.84rem; cursor:pointer }
    #hmj-floating-tools button:hover{ background:#243042 }
    #hmj-floating-tools .ghost{ border-style:dashed; opacity:.9 }

    /* bottom-left HUD */
    #hmj-hud{ position:fixed; left:16px; bottom:16px; background:#0b1020; color:#cbd5e1;
      border:1px solid #233044; border-radius:12px; padding:10px 12px; z-index:9998; font-size:.85rem }
    #hmj-hud b{ color:#fff }
  </style>

  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Decap CMS (successor to Netlify CMS) -->
  <script>window.CMS_MANUAL_INIT = true;</script>
  <script src="https://unpkg.com/decap-cms@^3.8.4/dist/decap-cms.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <span class="brand-dot"></span><span class="title">HMJ Global ‚Äî CMS Portal</span>
      <span class="spacer"></span>
      <a href="/" class="btn">‚üµ Return to Homepage</a>
      <a id="btnView" class="btn" href="/jobs.html" target="_blank">View Jobs Page</a>
      <button id="btnOpenEditor" class="btn primary">Open Jobs in Editor</button>
      <a class="btn" href="/admin/timesheets.html">Timesheets Admin</a>
      <button id="btnSignOut" class="btn danger">Sign out</button>
      <a class="btn" href="https://app.netlify.com" target="_blank">Netlify</a>
      <a class="btn" href="https://github.com" target="_blank">GitHub</a>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="h1">‚öô Diagnostics &amp; tools</div>
      <div class="grid">
        <div>
          <div class="kvs"><div>Host</div><div id="dg-host" class="muted"></div></div>
          <div class="kvs"><div>Identity widget loaded</div><div id="dg-ident" class="ok">‚úì loaded</div></div>
          <div class="kvs"><div>Login state</div><div id="dg-login" class="muted">‚Äî</div></div>
          <div class="kvs"><div>CMS script loaded</div><div id="dg-cms" class="muted">‚Äî</div></div>
          <div class="kvs"><div>Jobs JSON reachable</div><div id="dg-json" class="muted">‚Äî</div></div>
          <div class="kvs"><div>Backend / branch</div><div class="muted">git-gateway @ main</div></div>
          <div class="kvs"><div>Jobs file</div><div class="muted">data/jobs.json</div></div>
        </div>
        <div>
          <button id="btnRunChecks" class="btn">Run checks</button>
          <button id="btnReloadCMS" class="btn">Reload CMS script</button>
          <button id="btnReloadId" class="btn">Reload Identity</button>
          <button id="btnClearCache" class="btn">Clear local cache</button>
          <div class="hr"></div>
          <div id="errBlock" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="h1">Welcome üëã</div>
      <div class="muted">Use the dock below to open the Jobs editor, duplicate templates, and copy anchors.</div>
      <ul>
        <li>Click <span class="badge">Open Jobs in Editor</span> to edit <code>data/jobs.json</code>.</li>
        <li>Preview your public page: <code>/jobs.html</code>.</li>
        <li>If you see a ‚ÄúLogged in‚Äù popup, it will auto-close and the editor will mount.</li>
      </ul>
      <div class="badge ok" id="cmsStatus">CMS Status: ready</div>
    </div>
  </div>

  <!-- Quick Tools (bottom-right) + HUD (bottom-left) are created by JS -->

  <script>
    // --- helpers & diagnostics ---
    const qs = s => document.querySelector(s);
    qs('#dg-host').textContent = location.host;
    function setStatus(sel, text, cls){ const el = qs(sel); if(!el) return; el.textContent = text; el.className = cls||''; }
    function showError(err){ console.error(err); qs('#errBlock').innerHTML =
      '<div class="badge err">Error</div><div style="margin-top:6px">'+String(err?.message||err).replace(/</g,'&lt;')+'</div>'; }

    // Identity
    const idw = window.netlifyIdentity;
    if (idw) setStatus('#dg-ident','‚úì loaded','ok');

    function ensureLoginThen(cb){
      if (idw && idw.currentUser()){ setStatus('#dg-login','‚úì signed in','ok'); cb(); return; }
      idw?.open('login');
      idw?.on('login', ()=>{ setStatus('#dg-login','‚úì signed in','ok'); idw.close(); cb(); });
    }
    document.getElementById('btnSignOut').onclick = ()=>{
      idw?.logout(); setStatus('#dg-login','‚Äî signed out','muted'); location.reload();
    };

    // JSON reachability quick check
    async function checkJobsJSON(){
      try{
        const r = await fetch('/data/jobs.json', {cache:'no-store'});
        if(!r.ok) throw new Error('Jobs JSON fetch failed: '+r.status);
        const j = await r.json();
        if(!j || !Array.isArray(j.jobs)) throw new Error('Expected { "jobs": [...] }');
        setStatus('#dg-json','‚úì reachable','ok');
      }catch(e){ setStatus('#dg-json','‚úó unreachable','err'); showError(e); }
    }
    document.getElementById('btnRunChecks').onclick = checkJobsJSON;
    document.getElementById('btnReloadCMS').onclick = ()=>location.reload();
    document.getElementById('btnReloadId').onclick = ()=>location.href='/admin/';
    document.getElementById('btnClearCache').onclick = ()=>{
      try{ localStorage.clear(); sessionStorage.clear(); caches?.keys?.().then(k=>k.forEach(c=>caches.delete(c))); }catch(e){}
      location.reload();
    };
    checkJobsJSON();

    // --- CMS init (single boot guard) ---
    let CMS_BOOTED = false;
    function initCMS(){
      if (CMS_BOOTED) return; // guard
      if (!window.CMS){ setStatus('#dg-cms','‚úó failed','err'); showError(new Error('CMS library not loaded')); return; }
      setStatus('#dg-cms','‚úì Decap loaded','ok');
      CMS.init({ config: '/admin/config.yml' }); // B1 config
      CMS_BOOTED = true;
      // route to our collection after store warms up
      setTimeout(()=>{
        if (!location.hash.startsWith('#/collections/')) location.hash = '#/collections/jobsData';
      }, 450);
    }
    document.getElementById('btnOpenEditor').onclick = ()=>ensureLoginThen(initCMS);
    window.addEventListener('load', ()=>{ if (idw?.currentUser()) ensureLoginThen(initCMS); });

    // --- Quick Tools + HUD (guards so they never duplicate) ---
    (function installToolsOnce(){
      if (document.getElementById('hmj-floating-tools')) return;

      const JOBS_FILE = 'data/jobs.json';
      const JOBS_COLLECTION = 'jobsData';
      const slug = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
        .replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80);

      // Tools
      const tools = document.createElement('div');
      tools.id = 'hmj-floating-tools';
      tools.innerHTML = `
        <div class="card">
          <div class="row" style="margin-bottom:6px">
            <strong>Quick tools</strong>
            <span class="ghost" id="hmj-anchor">Copy anchor</span>
            <button id="hmj-duplicate">Duplicate</button>
            <button id="hmj-validate">Validate</button>
            <button id="hmj-export">Export JSON</button>
            <button id="hmj-import">Import JSON</button>
          </div>
          <div class="row">
            <button id="hmj-backup">Backup to browser</button>
            <button id="hmj-restore">Restore backup</button>
            <button id="hmj-clear">Clear CMS cache</button>
            <span class="ghost" title="‚åò/Ctrl+K validate ¬∑ ‚åò/Ctrl+D duplicate">Shortcuts</span>
          </div>
        </div>`;
      document.body.appendChild(tools);

      // HUD
      if (!document.getElementById('hmj-hud')){
        const hud = document.createElement('div');
        hud.id = 'hmj-hud';
        hud.innerHTML = `Jobs: <b id="hudTotal">‚Äî</b> ¬∑
          <span class="badge" id="hudLive">live ‚Äî</span>
          <span class="badge" id="hudHold">hold ‚Äî</span>
          <span class="badge" id="hudClosed">closed ‚Äî</span>`;
        document.body.appendChild(hud);
      }

      async function refreshHUD(){
        try{
          const r = await fetch(`/${JOBS_FILE}?_=${Date.now()}`); const d = await r.json();
          const arr = Array.isArray(d.jobs)?d.jobs:[];
          const live = arr.filter(j=>(j.status||'').toLowerCase()==='live').length;
          const hold = arr.filter(j=>(j.status||'').toLowerCase().includes('hold')).length;
          const closed = arr.filter(j=>(j.status||'').toLowerCase()==='closed').length;
          document.getElementById('hudTotal').textContent = arr.length;
          document.getElementById('hudLive').textContent = `live ${live}`;
          document.getElementById('hudHold').textContent = `hold ${hold}`;
          document.getElementById('hudClosed').textContent = `closed ${closed}`;
        }catch{}
      }
      refreshHUD(); setInterval(refreshHUD, 8000);

      // helpers
      function downloadAs(name, content){
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([content],{type:'application/json'})); a.download=name; a.click(); URL.revokeObjectURL(a.href);
      }
      function validateEntry(data){
        const errs=[]; ['id','title','status','locationText'].forEach(k=>{ if(!data[k]) errs.push(`Missing required: ${k}`); });
        if(data.id && !/^[a-z0-9-]{3,}$/.test(data.id)) errs.push('id must be URL-safe (a‚Äìz, 0‚Äì9, -)');
        return errs;
      }
      function getCurrent(){
        const st = window.reduxStore?.getState?.(); if(!st) return {};
        const collName = st.entry?.get('collection');
        const collection = st.collections?.get(collName || JOBS_COLLECTION) || st.collections?.first();
        const entry = st.entry;
        return { entry, collection };
      }

      // actions
      document.getElementById('hmj-validate').onclick = ()=>{
        const { entry } = getCurrent(); if(!entry){ alert('Open an entry first.'); return; }
        const errs = validateEntry(entry.get('data').toJS());
        alert(errs.length ? ('Issues:\n\n‚Ä¢ '+errs.join('\n‚Ä¢ ')) : 'Looks good ‚úÖ');
      };
      document.getElementById('hmj-duplicate').onclick = ()=>{
        const { entry, collection } = getCurrent(); if(!entry||!collection){ alert('Open an entry first.'); return; }
        const data = entry.get('data').toJS();
        const nextId = slug(`${data.title||'job'}-${Date.now().toString(36).slice(-5)}`);
        const clone = { ...data, id: nextId, status:'on-hold', published:false };
        window.location.hash = `#/collections/${collection.get('name')}/new`;
        setTimeout(()=>{
          const store = window.reduxStore; if(!store) return;
          store.dispatch({ type:'ENTRY_LOAD_SUCCESS', payload:{
            collection, entry: window.immutable.Map({ collection: collection.get('name'), data: window.immutable.fromJS(clone) })
          }});
        }, 300);
      };
      document.getElementById('hmj-anchor').onclick = ()=>{
        const { entry } = getCurrent(); if(!entry){ alert('Open an entry first.'); return; }
        const id = entry.get('data').get('id'); if(!id){ alert('No id yet.'); return; }
        const url = `/jobs.html#${id}`; navigator.clipboard.writeText(url).then(()=>alert(`Copied: ${url}`));
      };
      document.getElementById('hmj-export').onclick = async ()=>{
        const t = await (await fetch(`/${JOBS_FILE}?_=${Date.now()}`)).text(); downloadAs('jobs-export.json', t);
      };
      document.getElementById('hmj-import').onclick = ()=>{
        const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json';
        i.onchange=async()=>{ const f=i.files[0]; if(!f) return; const txt=await f.text();
          try{ const j=JSON.parse(txt); if(!Array.isArray(j.jobs)) throw new Error('Expected { jobs: [] }');
            downloadAs('jobs-normalized.json', JSON.stringify(j,null,2));
            alert('Imported OK. Open the file and paste into data/jobs.json (or commit in Git).');
          }catch(e){ alert('Invalid format: '+e.message); } };
        i.click();
      };
      document.getElementById('hmj-backup').onclick = async ()=>{
        const t = await (await fetch(`/${JOBS_FILE}?_=${Date.now()}`)).text();
        localStorage.setItem('hmj-jobs-backup', t); alert('Backup saved in this browser.');
      };
      document.getElementById('hmj-restore').onclick = ()=>{
        const raw = localStorage.getItem('hmj-jobs-backup'); if(!raw){ alert('No backup found.'); return; }
        try{ const j=JSON.parse(raw); downloadAs('jobs-restore.json', JSON.stringify(j,null,2)); }
        catch{ alert('Backup unreadable.'); }
      };
      document.getElementById('hmj-clear').onclick = ()=>{
        try{ localStorage.clear(); sessionStorage.clear(); caches?.keys?.().then(k=>k.forEach(c=>caches.delete(c))); }catch{}
        alert('Local cache cleared. Reloading‚Ä¶'); location.reload();
      };

      // shortcuts
      document.addEventListener('keydown',(e)=>{
        const mod=e.metaKey||e.ctrlKey;
        if(mod && e.key.toLowerCase()==='k'){ e.preventDefault(); document.getElementById('hmj-validate').click(); }
        if(mod && e.key.toLowerCase()==='d'){ e.preventDefault(); document.getElementById('hmj-duplicate').click(); }
      });
    })();
  </script>
</body>
</html>
