<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>HMJ Global ‚Äî CMS Portal</title>

  <!-- Brand font fallbacks kept simple -->
  <style>
    :root{
      --bg:#0b1420;
      --panel:#0f1c2b;
      --muted:#9fb3c8;
      --text:#e6edf6;
      --blue:#4c7fff;
      --green:#1fb981;
      --red:#ff6b6b;
      --border:#203042;
    }
    html,body{
      margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    a{color:var(--blue);text-decoration:none}
    .topbar{
      position:sticky;top:0;z-index:50;background:rgba(11,20,32,.9);
      backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border)
    }
    .row{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;gap:10px;align-items:center}
    .brand-dot{width:8px;height:8px;border-radius:999px;background:#3bb3ff;display:inline-block;margin-right:10px}
    .title{font-weight:700;letter-spacing:.2px}
    .spacer{flex:1}
    .btn{
      background:#1a2740;border:1px solid #2b3c55;color:var(--text);
      padding:10px 14px;border-radius:12px;display:inline-flex;align-items:center;gap:8px;
      transition:all .18s ease;font-weight:600
    }
    .btn:hover{transform:translateY(-1px);border-color:#3b5172}
    .primary{background:var(--blue);border-color:transparent}
    .danger{background:#2a1b1b;border-color:#472a2a}
    .wrap{max-width:1100px;margin:22px auto;padding:0 20px}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 20px;margin-bottom:18px
    }
    .h1{font-size:28px;font-weight:800;margin:0 0 4px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .kvs{display:grid;grid-template-columns:240px 1fr;gap:8px;padding:10px 0;border-top:1px dashed var(--border)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .ok{color:#4fe3a2}.warn{color:#ffd166}.err{color:#ff8fa3}
    .hr{height:1px;background:var(--border);margin:14px 0}
    /* Floating tools ‚Äî bottom-right and tucks under CMS when active */
    .dock{
      position:fixed;right:20px;bottom:20px;z-index:5;
      background:rgba(15,28,43,.92);backdrop-filter:blur(6px);
      border:1px solid var(--border);border-radius:18px;padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      max-width:min(92vw,760px)
    }
    .chip{padding:8px 10px;border-radius:10px;background:#132135;border:1px solid #23354e;color:var(--muted);font-size:13px}
    .chip input{all:unset;color:var(--text)}
    .chip-btn{padding:8px 12px;border-radius:10px;background:#1a2740;border:1px solid #2b3c55;color:var(--text);font-weight:700}
    .chip-btn:hover{border-color:#3b5172}
    /* ‚ÄúLogged in‚Äù popup from Identity can sit above; no problem */
    #cmsHost{min-height:52vh}
    code.small{font-size:12px;color:#aec2d8;background:#0c1724;border:1px solid #1d2a3c;padding:2px 6px;border-radius:6px}
  </style>

  <!-- Netlify Identity (email login) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Use Decap CMS (Netlify CMS successor) -->
  <script>
    window.CMS_MANUAL_INIT = true;
  </script>
  <script src="https://unpkg.com/decap-cms@^3.8.4/dist/decap-cms.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <span class="brand-dot"></span><span class="title">HMJ Global ‚Äî CMS Portal</span>
      <span class="spacer"></span>
      <a href="/" class="btn">‚üµ Return to Homepage</a>
      <a id="btnView" class="btn" href="/jobs.html" target="_blank">View Jobs Page</a>
      <button id="btnOpenEditor" class="btn primary">Open Jobs in Editor</button>
      <button id="btnSignOut" class="btn danger">Sign out</button>
      <a class="btn" href="https://app.netlify.com" target="_blank">Netlify</a>
      <a class="btn" href="https://github.com" target="_blank">GitHub</a>
    </div>
  </div>

  <div class="wrap">
    <!-- Diagnostics -->
    <div class="card">
      <div class="h1">‚öô Diagnostics &amp; tools</div>
      <div class="grid">
        <div>
          <div class="kvs"><div>Host</div><div id="dg-host" class="muted"></div></div>
          <div class="kvs"><div>Identity widget loaded</div><div id="dg-ident" class="ok">‚úì loaded</div></div>
          <div class="kvs"><div>Login state</div><div id="dg-login" class="muted">‚Äî</div></div>
          <div class="kvs"><div>CMS script loaded</div><div id="dg-cms" class="muted">‚Äî</div></div>
          <div class="kvs"><div>Jobs JSON reachable</div><div id="dg-json" class="muted">‚Äî</div></div>
          <div class="kvs"><div>Backend / branch</div><div class="muted">git-gateway @ main</div></div>
          <div class="kvs"><div>Jobs file</div><div class="muted">data/jobs.json</div></div>
        </div>
        <div>
          <button id="btnRunChecks" class="btn">Run checks</button>
          <button id="btnReloadCMS" class="btn">Reload CMS script</button>
          <button id="btnReloadId" class="btn">Reload Identity</button>
          <button id="btnClearCache" class="btn">Clear local cache</button>
          <div class="hr"></div>
          <div id="errBlock" class="muted"></div>
        </div>
      </div>
    </div>

    <!-- Welcome -->
    <div class="card">
      <div class="h1">Welcome üëã</div>
      <div class="muted">Use the dock below to open the Jobs editor, duplicate templates, and copy anchors.</div>
      <ul>
        <li>Click <span class="badge">Open Jobs in Editor</span> to edit <code class="small">data/jobs.json</code>.</li>
        <li>Preview your public page: <code class="small">/jobs.html</code>.</li>
        <li>If you see a ‚ÄúLogged in‚Äù popup, it will auto-close and the editor will mount.</li>
      </ul>
      <div class="badge ok" id="cmsStatus">CMS Status: ready</div>
    </div>

    <!-- CMS host -->
    <div id="cmsHost" class="card">
      <div class="muted">Editor will appear here after login‚Ä¶</div>
    </div>
  </div>

  <!-- Floating dock (bottom-right) -->
  <div class="dock" id="dock">
    <span class="chip"><input id="searchBox" placeholder="Search jobs (title, location, status)‚Ä¶"></span>
    <span class="chip">Templates:
      <select id="tmplSel" class="chip" style="background:transparent;border:none;padding-left:6px;">
        <option>‚Äî</option>
        <option>CSA QS</option>
        <option>MEP QS</option>
        <option>Electrical Supervisor</option>
      </select>
    </span>
    <button class="chip-btn" id="btnPreview">Preview</button>
    <button class="chip-btn" id="btnTop">‚Üë Top</button>
    <button class="chip-btn" id="btnDuplicate">Duplicate current</button>
    <span class="chip">anchor-id (e.g., mep-qs-dublin)</span>
    <button class="chip-btn" id="btnOpenAnchor">Open anchor</button>
    <button class="chip-btn" id="btnCopy">Copy</button>
  </div>

  <script>
    /* ------------------------------
       Small helpers
    ------------------------------ */
    const qs = sel => document.querySelector(sel);
    const host = location.host;
    qs('#dg-host').textContent = host;

    function setStatus(id, text, className){
      const el = qs(id);
      if (!el) return;
      el.textContent = text;
      el.className = className || '';
    }

    function showError(err){
      console.error(err);
      const msg = (err && err.message) ? err.message : (''+err);
      qs('#errBlock').innerHTML = '<div class="badge err">Error</div><div style="margin-top:6px">'+
        msg.replace(/</g,'&lt;')+'</div>';
    }

    /* ------------------------------
       Identity & Login flow
    ------------------------------ */
    const idw = window.netlifyIdentity;
    let loggedIn = false;

    function ensureLoginThen(cb){
      if (idw && idw.currentUser()) { loggedIn = true; setStatus('#dg-login', '‚úì signed in', 'ok'); return cb(); }
      idw.open('login');
      idw.on('login', user => {
        loggedIn = true;
        setStatus('#dg-login','‚úì signed in','ok');
        idw.close();
        cb();
      });
    }

    qs('#btnSignOut').addEventListener('click', () => {
      idw && idw.logout();
      loggedIn = false;
      setStatus('#dg-login','‚Äî signed out','muted');
      location.reload();
    });

    /* ------------------------------
       CMS boot
    ------------------------------ */
    function initCMS(){
      try{
        if (!window.CMS) throw new Error('CMS library not loaded');
        setStatus('#dg-cms','‚úì Decap loaded','ok');

        // init with our config
        CMS.init({ config: '/admin/config.yml' });

        // Route editor straight to our collection
        const go = () => {
          // Only change hash if not already in CMS
          if (!location.hash || !location.hash.startsWith('#/collections/')){
            location.hash = '#/collections/jobsData';
          }
          // Render container
          const mountPoint = document.getElementById('cmsHost');
          if (mountPoint && !mountPoint.dataset.mounted){
            mountPoint.dataset.mounted = '1';
            // Decap will render itself; container is just visual space.
            mountPoint.innerHTML = '<div class="muted">Opening editor‚Ä¶</div>';
          }
        };

        // Wait a moment to let store warm up before routing
        setTimeout(go, 450);

      }catch(err){
        setStatus('#dg-cms','‚úó failed','err');
        showError(err);
      }
    }

    /* ------------------------------
       Quick checks
    ------------------------------ */
    async function checkJobsJSON(){
      try{
        const res = await fetch('/data/jobs.json', {cache:'no-store'});
        if (!res.ok) throw new Error('Jobs JSON fetch failed: '+res.status);
        const data = await res.json();
        if (!data || !Array.isArray(data.jobs)){
          throw new Error('Jobs JSON is reachable but not in expected shape: { "jobs": [...] }');
        }
        setStatus('#dg-json','‚úì reachable','ok');
      }catch(err){
        setStatus('#dg-json','‚úó unreachable','err');
        showError(err);
      }
    }

    /* Buttons */
    qs('#btnRunChecks').onclick = checkJobsJSON;
    qs('#btnReloadCMS').onclick = () => location.reload();
    qs('#btnReloadId').onclick = () => location.href = '/admin/';
    qs('#btnClearCache').onclick = () => { localStorage.clear(); sessionStorage.clear(); caches?.keys?.().then(keys=>keys.forEach(k=>caches.delete(k))); location.reload(); };

    qs('#btnOpenEditor').onclick = () => ensureLoginThen(initCMS);
    qs('#btnTop').onclick = () => window.scrollTo({top:0,behavior:'smooth'});
    qs('#btnPreview').onclick = () => window.open('/jobs.html','_blank');

    // On load: mark identity + run a quick JSON check
    setStatus('#dg-ident','‚úì loaded','ok');
    setStatus('#dg-login', (idw && idw.currentUser()) ? '‚úì signed in' : '‚Äî', (idw && idw.currentUser()) ? 'ok' : 'muted');
    checkJobsJSON();

    // Auto-open editor on arrival if already signed in
    window.addEventListener('load', () => {
      if (idw && idw.currentUser()){
        ensureLoginThen(initCMS);
      }
    });

    // If a legacy ‚Äúlogged in‚Äù dialog from the site appears, close it after CMS is up
    setTimeout(()=>{ try{ idw && idw.close(); }catch(e){} }, 1200);

    // Very light ‚Äúsearch box‚Äù stub (client-side filter UX in your public page; kept in UI here)
    qs('#searchBox').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        const q = e.currentTarget.value.trim();
        if (!q) return;
        window.open('/jobs.html#'+encodeURIComponent(q.toLowerCase()), '_blank');
      }
    });

  </script>
</body>
</html>
