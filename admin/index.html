<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HMJ Admin – Payroll Export (TEST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/style.css" />
  <script defer src="/js/hmj-nav.js"></script>
  <style>
    :root {
      --ink: #0f1b3f;
      --accent: #3a66b3;
      --muted: #6b7280;
      --panel: #0f1322;
      --soft: #f7f8ff;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f97316;
    }

    body {
      background: #f5f7fa;
      color: var(--ink);
    }

    .admin-hero {
      padding: 140px 20px 60px;
      background: linear-gradient(180deg, rgba(15, 19, 34, 0.9), rgba(15, 19, 34, 0.6)),
        url("/images/hero.jpg") center/cover no-repeat;
      color: #fff;
    }

    .admin-hero__card {
      max-width: 820px;
      margin: 0 auto;
      padding: 32px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.95);
      color: var(--ink);
      box-shadow: 0 18px 40px rgba(15, 19, 34, 0.25);
    }

    .admin-hero__eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.8rem;
      color: var(--accent);
      margin: 0 0 12px;
      font-weight: 700;
    }

    .admin-hero h1 {
      margin: 0 0 12px;
      font-size: 2.4rem;
    }

    .admin-hero p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.6;
    }

    .admin-meta {
      margin-top: 18px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(58, 102, 179, 0.12);
      color: #34508f;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .section {
      padding: 42px 20px;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    .admin-panel {
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(15, 19, 34, 0.08);
      box-shadow: 0 12px 30px rgba(15, 19, 34, 0.08);
      padding: 28px;
    }

    .admin-panel__header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .admin-panel__header h2 {
      margin: 0;
      font-size: 1.5rem;
    }

    .admin-updated {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .tool-card {
      border-radius: 16px;
      border: 1px solid rgba(15, 19, 34, 0.08);
      padding: 18px;
      background: linear-gradient(180deg, rgba(58, 102, 179, 0.06), #fff 60%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-height: 260px;
    }

    .tool-card h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .tool-card button {
      border: none;
      cursor: pointer;
    }

    .tool-card input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(15, 19, 34, 0.2);
      font-size: 0.9rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-idle {
      background: rgba(107, 114, 128, 0.15);
      color: var(--muted);
    }

    .status-running {
      background: rgba(249, 115, 22, 0.2);
      color: var(--warning);
    }

    .status-success {
      background: rgba(22, 163, 74, 0.2);
      color: var(--success);
    }

    .status-error {
      background: rgba(220, 38, 38, 0.2);
      color: var(--danger);
    }

    pre.json-output {
      margin: 0;
      padding: 12px;
      background: #0f1322;
      color: #e5e7eb;
      border-radius: 12px;
      font-size: 0.78rem;
      line-height: 1.4;
      overflow-x: auto;
      max-height: 220px;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
    }

    .report-card {
      padding: 20px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(15, 19, 34, 0.08);
      box-shadow: 0 10px 24px rgba(15, 19, 34, 0.08);
    }

    .report-card h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    .report-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .admin-meta.admin-meta--live {
      background: rgba(22, 163, 74, 0.16);
      color: var(--success);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th,
    td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(15, 19, 34, 0.08);
    }

    th {
      color: var(--muted);
      font-weight: 600;
    }

    @media (max-width: 720px) {
      .admin-hero {
        padding-top: 120px;
      }
      .admin-panel {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <header class="hmj-header">
    <nav class="hmj-nav" aria-label="Main">
      <a class="hmj-logo" href="/index.html">
        <img src="/images/logo.png" alt="HMJ-Global Logo" />
      </a>

      <button class="hmj-burger" aria-label="Open menu" aria-expanded="false" aria-controls="hmj-menu">
        <span></span><span></span><span></span>
      </button>

      <ul id="hmj-menu" class="hmj-menu">
        <li><a href="/index.html" data-page="index">Home</a></li>
        <li><a href="/about.html" data-page="about">About</a></li>
        <li><a href="/clients.html" data-page="clients">Clients</a></li>
        <li><a href="/candidates.html" data-page="candidates">Candidates</a></li>
        <li><a href="/jobs.html" data-page="jobs">Jobs</a></li>
        <li><a href="https://www.hmj-finance.com" target="_blank" rel="noopener">Accounting</a></li>
        <li><a href="/timesheets.html" id="nav-timesheets" aria-disabled="true">Timesheets</a></li>
        <li><a href="/admin/" id="nav-admin" class="requires-admin" aria-disabled="true">Admin Dashboard</a></li>
      </ul>
      <div class="hmj-scrim" hidden></div>
    </nav>
  </header>

  <main>
    <section class="admin-hero">
      <div class="wrap">
        <div class="admin-hero__card">
          <p class="admin-hero__eyebrow">HMJ Admin – Payroll Export (TEST)</p>
          <h1>Payroll Export – Test Area</h1>
          <p>
            This test-only dashboard runs on the <strong>feature/payroll-admin</strong> branch.
            It is safe to use in deploy previews and does not affect production payroll data.
          </p>
          <div class="admin-meta" id="env-indicator">Environment: TEST / DEPLOY PREVIEW</div>
          <div class="admin-meta" id="mode-indicator">Mode: Standby</div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="wrap">
        <div class="admin-panel">
          <div class="admin-panel__header">
            <div>
              <h2>TSP API Tools</h2>
              <p class="admin-updated">Last updated: <span id="last-updated">—</span></p>
            </div>
            <button class="btn-primary" id="run-all" data-default="Run all checks" data-running="Running checks...">
              Run all checks
            </button>
          </div>
          <div class="admin-grid">
            <div class="tool-card">
              <div>
                <h3>Check env</h3>
                <p class="admin-updated">Verify TSP environment variables.</p>
              </div>
              <span class="status-badge status-idle" id="status-ping">Idle</span>
              <button class="btn-primary" id="btn-ping" data-default="Check env" data-running="Running...">Check env</button>
              <pre class="json-output" id="result-ping">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>Health check</h3>
                <p class="admin-updated">Ping a lightweight TSP endpoint.</p>
              </div>
              <span class="status-badge status-idle" id="status-health">Idle</span>
              <button class="btn-primary" id="btn-health" data-default="Health check" data-running="Running...">Health check</button>
              <pre class="json-output" id="result-health">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>Who am I</h3>
                <p class="admin-updated">Verify token reachability (no whoami endpoint).</p>
              </div>
              <span class="status-badge status-idle" id="status-whoami">Idle</span>
              <button class="btn-primary" id="btn-whoami" data-default="Who am I" data-running="Running...">Who am I</button>
              <pre class="json-output" id="result-whoami">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List clients</h3>
                <p class="admin-updated">Pull clients for reporting.</p>
              </div>
              <span class="status-badge status-idle" id="status-clients">Idle</span>
              <button class="btn-primary" id="btn-clients" data-default="List clients" data-running="Running...">List clients</button>
              <pre class="json-output" id="result-clients">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List projects</h3>
                <p class="admin-updated">Fetch projects (placements).</p>
              </div>
              <span class="status-badge status-idle" id="status-placements">Idle</span>
              <button class="btn-primary" id="btn-placements" data-default="List projects" data-running="Running...">List projects</button>
              <pre class="json-output" id="result-placements">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List users</h3>
                <p class="admin-updated">Fetch user directory page.</p>
              </div>
              <span class="status-badge status-idle" id="status-users">Idle</span>
              <button class="btn-primary" id="btn-users" data-default="List users" data-running="Running...">List users</button>
              <pre class="json-output" id="result-users">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>Search users</h3>
                <p class="admin-updated">Search users by keyword.</p>
              </div>
              <input id="search-users-input" type="text" placeholder="Search users (e.g. joe)" />
              <span class="status-badge status-idle" id="status-search-users">Idle</span>
              <button class="btn-primary" id="btn-search-users" data-default="Search users" data-running="Running...">Search users</button>
              <pre class="json-output" id="result-search-users">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List cost centres</h3>
                <p class="admin-updated">Fetch cost centres.</p>
              </div>
              <span class="status-badge status-idle" id="status-costcentres">Idle</span>
              <button class="btn-primary" id="btn-costcentres" data-default="List cost centres" data-running="Running...">List cost centres</button>
              <pre class="json-output" id="result-costcentres">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List charge codes</h3>
                <p class="admin-updated">Fetch charge codes.</p>
              </div>
              <span class="status-badge status-idle" id="status-chargecodes">Idle</span>
              <button class="btn-primary" id="btn-chargecodes" data-default="List charge codes" data-running="Running...">List charge codes</button>
              <pre class="json-output" id="result-chargecodes">{}</pre>
            </div>
            <div class="tool-card">
              <div>
                <h3>List timesheets</h3>
                <p class="admin-updated">Fetch timesheets (last 14 days).</p>
              </div>
              <span class="status-badge status-idle" id="status-timesheets">Idle</span>
              <button class="btn-primary" id="btn-timesheets" data-default="List timesheets" data-running="Running...">List timesheets</button>
              <pre class="json-output" id="result-timesheets">{}</pre>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="wrap">
        <div class="report-grid">
          <div class="report-card">
            <h3>Clients summary</h3>
            <div class="report-summary" id="clients-summary">Awaiting data...</div>
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="clients-table">
                <tr><td colspan="2">Run “List clients” to populate.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="report-card">
            <h3>Projects summary</h3>
            <div class="report-summary" id="placements-summary">Awaiting data...</div>
            <table>
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Client</th>
                  <th>Dates</th>
                </tr>
              </thead>
              <tbody id="placements-table">
                <tr><td colspan="3">Run “List projects” to populate.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="report-card">
            <h3>Timesheet summary</h3>
            <div class="report-summary" id="timesheet-summary">Awaiting data...</div>
            <div class="quick-actions">
              <button class="btn-primary" id="btn-summary-7">Last 7 days</button>
              <button class="btn-primary" id="btn-summary-14">Last 14 days</button>
              <button class="btn-primary" id="btn-summary-30">Last 30 days</button>
            </div>
            <pre class="json-output" id="result-summary">{}</pre>
          </div>
          <div class="report-card">
            <h3>Top clients by charge</h3>
            <div class="report-summary" id="top-clients-summary">Awaiting data...</div>
            <div class="quick-actions">
              <button class="btn-primary" id="btn-top-7">Last 7 days</button>
              <button class="btn-primary" id="btn-top-14">Last 14 days</button>
              <button class="btn-primary" id="btn-top-30">Last 30 days</button>
            </div>
            <pre class="json-output" id="result-top-clients">{}</pre>
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Timesheets</th>
                  <th>Total charge</th>
                </tr>
              </thead>
              <tbody id="top-clients-table">
                <tr><td colspan="3">Run summary to populate.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const endpoints = {
      ping: {
        url: "/.netlify/functions/tsp-ping",
        buttonId: "btn-ping",
        badgeId: "status-ping",
        outputId: "result-ping",
      },
      health: {
        url: "/.netlify/functions/tsp-health",
        buttonId: "btn-health",
        badgeId: "status-health",
        outputId: "result-health",
      },
      whoami: {
        url: "/.netlify/functions/tsp-whoami",
        buttonId: "btn-whoami",
        badgeId: "status-whoami",
        outputId: "result-whoami",
      },
      clients: {
        url: "/.netlify/functions/tsp-list-clients?page=1&pageSize=20",
        buttonId: "btn-clients",
        badgeId: "status-clients",
        outputId: "result-clients",
      },
      placements: {
        url: "/.netlify/functions/tsp-list-placements?status=active&page=1&pageSize=20",
        buttonId: "btn-placements",
        badgeId: "status-placements",
        outputId: "result-placements",
      },
      users: {
        url: "/.netlify/functions/tsp-list-users?page=1&pageSize=20",
        buttonId: "btn-users",
        badgeId: "status-users",
        outputId: "result-users",
      },
      searchUsers: {
        url: "/.netlify/functions/tsp-search-users",
        buttonId: "btn-search-users",
        badgeId: "status-search-users",
        outputId: "result-search-users",
      },
      costcentres: {
        url: "/.netlify/functions/tsp-list-costcentres?page=1&pageSize=20",
        buttonId: "btn-costcentres",
        badgeId: "status-costcentres",
        outputId: "result-costcentres",
      },
      chargecodes: {
        url: "/.netlify/functions/tsp-list-chargecodes?page=1&pageSize=20",
        buttonId: "btn-chargecodes",
        badgeId: "status-chargecodes",
        outputId: "result-chargecodes",
      },
      timesheets: {
        url: "/.netlify/functions/tsp-list-timesheets?days=14&page=1&pageSize=20",
        buttonId: "btn-timesheets",
        badgeId: "status-timesheets",
        outputId: "result-timesheets",
      },
      summary: {
        url: "/.netlify/functions/tsp-timesheet-summary?days=14",
        outputId: "result-summary",
      },
      topClients: {
        url: "/.netlify/functions/tsp-top-clients-by-charge?days=14",
        outputId: "result-top-clients",
      },
    };

    const setBadge = (id, state, text) => {
      const badge = document.getElementById(id);
      if (!badge) return;
      badge.classList.remove("status-idle", "status-running", "status-success", "status-error");
      badge.classList.add(`status-${state}`);
      badge.textContent = text;
    };

    const setButtonState = (button, running) => {
      if (!button) return;
      button.disabled = running;
      button.textContent = running ? button.dataset.running : button.dataset.default;
    };

    const updateTimestamp = () => {
      const stamp = document.getElementById("last-updated");
      if (!stamp) return;
      stamp.textContent = new Date().toLocaleString();
    };

    const setLiveMode = () => {
      const indicator = document.getElementById("mode-indicator");
      if (!indicator) return;
      indicator.textContent = "Mode: LIVE (API)";
      indicator.classList.add("admin-meta--live");
    };

    const renderJson = (outputId, data) => {
      const output = document.getElementById(outputId);
      if (output) {
        output.textContent = JSON.stringify(data, null, 2);
      }
    };

    const summarizeClients = (payload) => {
      const summary = document.getElementById("clients-summary");
      const table = document.getElementById("clients-table");
      if (!summary || !table) return;

      const clients = Array.isArray(payload.clients) ? payload.clients : [];
      const counts = clients.reduce(
        (acc, client) => {
          const status = (client.status || "unknown").toLowerCase();
          acc.total += 1;
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        },
        { total: 0 }
      );

      summary.textContent = `Total: ${counts.total} · Active: ${counts.active || 0} · Inactive: ${counts.inactive || 0} · Unknown: ${counts.unknown || 0}`;

      table.innerHTML = "";
      const rows = clients.slice(0, 10);
      if (rows.length === 0) {
        table.innerHTML = '<tr><td colspan="2">No clients returned.</td></tr>';
        return;
      }

      rows.forEach((client) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${client.name}</td><td>${client.status}</td>`;
        table.appendChild(row);
      });
    };

    const summarizePlacements = (payload) => {
      const summary = document.getElementById("placements-summary");
      const table = document.getElementById("placements-table");
      if (!summary || !table) return;

      const placements = Array.isArray(payload.placements) ? payload.placements : [];
      const counts = placements.reduce(
        (acc, placement) => {
          const status = (placement.status || "unknown").toLowerCase();
          acc.total += 1;
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        },
        { total: 0 }
      );

      summary.textContent = `Total: ${counts.total} · Active: ${counts.active || 0} · Inactive: ${counts.inactive || 0} · Unknown: ${counts.unknown || 0}`;

      table.innerHTML = "";
      const rows = placements.slice(0, 10);
      if (rows.length === 0) {
        table.innerHTML = '<tr><td colspan="3">No placements returned.</td></tr>';
        return;
      }

      rows.forEach((placement) => {
        const row = document.createElement("tr");
        const dates = `${placement.startDate || "—"} → ${placement.endDate || "—"}`;
        row.innerHTML = `<td>${placement.title}</td><td>${placement.clientName}</td><td>${dates}</td>`;
        table.appendChild(row);
      });
    };

    const summarizeTimesheets = (payload) => {
      const summary = document.getElementById("timesheet-summary");
      if (!summary) return;
      if (!payload.summary) return;
      const { count, totalHours, totalCharge, byStatus } = payload.summary;
      const statusSummary = Object.entries(byStatus || {})
        .map(([status, value]) => `${status}: ${value}`)
        .join(" · ");
      summary.textContent = `Count: ${count} · Hours: ${Number(totalHours || 0).toFixed(2)} · Charge: ${Number(totalCharge || 0).toFixed(2)}${statusSummary ? ` · ${statusSummary}` : ""}`;
    };

    const renderTopClients = (payload) => {
      const summary = document.getElementById("top-clients-summary");
      const table = document.getElementById("top-clients-table");
      if (!summary || !table) return;
      const clients = Array.isArray(payload.clients) ? payload.clients : [];
      summary.textContent = `Clients: ${clients.length} · Days: ${payload.days || "—"}`;

      table.innerHTML = "";
      if (clients.length === 0) {
        table.innerHTML = '<tr><td colspan="3">No clients returned.</td></tr>';
        return;
      }
      clients.forEach((client) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${client.client}</td><td>${client.count}</td><td>${Number(client.totalCharge || 0).toFixed(2)}</td>`;
        table.appendChild(row);
      });
    };

    const runRequest = async (key) => {
      const config = endpoints[key];
      if (!config) return;
      const button = document.getElementById(config.buttonId);

      setButtonState(button, true);
      setBadge(config.badgeId, "running", "Running");

      try {
        const response = await fetch(config.url);
        const data = await response.json();
        const ok = data.ok !== false && response.ok;
        setBadge(config.badgeId, ok ? "success" : "error", ok ? "Success" : "Fail");
        renderJson(config.outputId, data);
        updateTimestamp();

        if (ok && key !== "ping") {
          setLiveMode();
        }
        if (key === "clients") {
          summarizeClients(data);
        }
        if (key === "placements") {
          summarizePlacements(data);
        }
        if (key === "summary") {
          summarizeTimesheets(data);
        }
        if (key === "topClients") {
          renderTopClients(data);
        }
      } catch (error) {
        setBadge(config.badgeId, "error", "Fail");
        renderJson(config.outputId, { ok: false, error: error.message });
        updateTimestamp();
      } finally {
        setButtonState(button, false);
      }
    };

    Object.entries(endpoints).forEach(([key, config]) => {
      if (key === "searchUsers") return;
      const button = document.getElementById(config.buttonId);
      if (button) {
        button.addEventListener("click", () => runRequest(key));
      }
    });

    const searchButton = document.getElementById("btn-search-users");
    if (searchButton) {
      searchButton.addEventListener("click", () => {
        const input = document.getElementById("search-users-input");
        const query = input ? input.value.trim() : \"\";
        endpoints.searchUsers.url = `/.netlify/functions/tsp-search-users?q=${encodeURIComponent(query)}`;
        runRequest(\"searchUsers\");
      });
    }

    const summaryButtons = [
      { id: \"btn-summary-7\", days: 7, key: \"summary\" },
      { id: \"btn-summary-14\", days: 14, key: \"summary\" },
      { id: \"btn-summary-30\", days: 30, key: \"summary\" },
      { id: \"btn-top-7\", days: 7, key: \"topClients\" },
      { id: \"btn-top-14\", days: 14, key: \"topClients\" },
      { id: \"btn-top-30\", days: 30, key: \"topClients\" },
    ];

    summaryButtons.forEach(({ id, days, key }) => {
      const button = document.getElementById(id);
      if (!button) return;
      button.addEventListener(\"click\", () => {
        endpoints[key].url = `/.netlify/functions/${key === \"summary\" ? \"tsp-timesheet-summary\" : \"tsp-top-clients-by-charge\"}?days=${days}`;
        runRequest(key);
      });
    });

    const runAllButton = document.getElementById("run-all");
    if (runAllButton) {
      runAllButton.addEventListener("click", async () => {
        setButtonState(runAllButton, true);
        await runRequest("ping");
        await runRequest("health");
        await runRequest("whoami");
        setButtonState(runAllButton, false);
      });
    }
  </script>
</body>
</html>
