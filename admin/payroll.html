<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Payroll â€” Admin | HMJ Global</title>

  <script>
    window.ADMIN_IDENTITY_URL = 'https://hmjg.netlify.app/.netlify/identity';
  </script>
  <script defer src="../js/identity-loader.js"></script>
  <script defer src="/admin/common.js?v=22"></script>

  <style>
    :root {
      --bg:#f5f7fb; --panel:#ffffff; --border:#d6def5; --ink:#0f1b3f; --muted:#5d6f9e;
      --accent:#3052a3; --accent-soft:rgba(48,82,163,.12); --danger:#b42318; --ok:#138754;
      --hold:#f0ad00; --processing:#2563eb; --ready:#64748b;
    }
    * { box-sizing:border-box; }
    html,body { margin:0; background:var(--bg); color:var(--ink); font:15px/1.55 "Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    a { color:inherit; text-decoration:none; }

    .top { position:sticky; top:0; z-index:100; background:linear-gradient(180deg,var(--accent),#274188); color:#fff; border-bottom:1px solid rgba(255,255,255,.18); box-shadow:0 14px 32px rgba(15,27,63,.18); }
    .row { max-width:1480px; margin:0 auto; padding:14px 22px; display:flex; align-items:center; gap:12px; }
    .brand { font-weight:800; letter-spacing:.02em; font-size:16px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.32); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; }
    .sp { flex:1; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }

    .btn { background:linear-gradient(180deg,rgba(48,82,163,.12),rgba(48,82,163,.05)); color:var(--ink); border:1px solid rgba(48,82,163,.25); padding:9px 14px; border-radius:12px; font-weight:700; cursor:pointer; transition:transform .16s ease,box-shadow .2s ease,border-color .2s ease,background .2s ease; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 12px 26px rgba(15,27,63,.18); border-color:rgba(48,82,163,.45); }
    .btn.ghost { background:#fff; border-color:rgba(48,82,163,.18); color:var(--accent); }
    .btn.primary { background:linear-gradient(180deg,rgba(48,82,163,.22),rgba(48,82,163,.1)); border-color:rgba(48,82,163,.55); color:#fff; box-shadow:0 16px 32px rgba(48,82,163,.22); }
    .btn.danger { background:linear-gradient(180deg,rgba(180,35,24,.18),rgba(180,35,24,.08)); border-color:rgba(180,35,24,.4); color:#fff; }
    .btn.small { padding:7px 11px; font-size:13px; border-radius:10px; }
    .btn.tiny { padding:4px 8px; font-size:12px; border-radius:8px; }
    .btn:disabled { cursor:not-allowed; opacity:.55; box-shadow:none; transform:none; }

    .wrap { max-width:1480px; margin:24px auto; padding:0 22px; display:grid; gap:18px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow:0 20px 44px rgba(15,27,63,.12); }
    .muted { color:var(--muted); }

    .summary-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    .summary-card { border:1px solid rgba(48,82,163,.18); border-radius:16px; padding:14px 16px; background:var(--accent-soft); position:relative; overflow:hidden; }
    .summary-card strong { display:block; font-size:24px; margin-top:6px; color:var(--accent); }
    .summary-card small { display:block; color:var(--muted); font-weight:500; margin-top:4px; }
    .summary-card .trend { position:absolute; top:12px; right:14px; font-weight:700; font-size:13px; display:flex; align-items:center; gap:4px; }
    .summary-splits { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); margin-top:18px; }
    .split { border:1px solid rgba(48,82,163,.18); border-radius:16px; padding:16px; background:#f8faff; }
    .split h4 { margin:0 0 10px; font-size:14px; letter-spacing:.04em; text-transform:uppercase; color:var(--muted); }
    .split ul { margin:0; padding:0; list-style:none; display:grid; gap:8px; font-size:13px; }
    .split li { display:flex; justify-content:space-between; gap:8px; border-bottom:1px dashed rgba(48,82,163,.12); padding-bottom:6px; }
    .split li:last-child { border-bottom:none; padding-bottom:0; }

    .filters form { display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:12px; align-items:end; }
    .field { display:flex; flex-direction:column; gap:6px; font-size:13px; font-weight:600; color:var(--muted); }
    .field input[type="search"],
    .field input[type="text"],
    .field input[type="date"],
    .field select { padding:11px 12px; border-radius:12px; border:1px solid rgba(48,82,163,.22); background:#fff; color:var(--ink); font-weight:600; transition:border .2s ease, box-shadow .2s ease; }
    .field input:focus,
    .field select:focus { outline:none; border-color:rgba(48,82,163,.5); box-shadow:0 0 0 3px rgba(48,82,163,.18); }

    .quick-filters { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:7px 12px; border-radius:999px; background:#eef2ff; border:1px solid rgba(48,82,163,.2); font-weight:600; font-size:13px; cursor:pointer; transition:background .18s ease, color .18s ease, border .18s ease; }
    .chip.active { background:var(--accent); color:#fff; border-color:rgba(48,82,163,.7); }

    .toggle-line { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top:12px; font-size:13px; }
    .toggle-line label { display:flex; align-items:center; gap:6px; cursor:pointer; }

    .range-controls { display:flex; gap:10px; align-items:center; margin-top:14px; flex-wrap:wrap; }
    .range-controls .btn { min-width:38px; }

    .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px; }

    table { width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--border); border-radius:16px; overflow:hidden; }
    thead th { position:sticky; top:0; background:#eef1ff; border-bottom:1px solid var(--border); text-align:left; padding:10px 12px; font-weight:800; font-size:13px; letter-spacing:.02em; color:var(--muted); z-index:1; }
    tbody td { padding:11px 12px; border-top:1px solid var(--border); vertical-align:middle; }
    tbody tr { transition:background .18s ease, box-shadow .2s ease; }
    tbody tr:hover { background:#f6f8ff; }
    tbody tr.active { background:#edf2ff; }
    tbody tr.issue { background:rgba(250,204,21,.08); box-shadow:inset 0 0 0 2px rgba(250,204,21,.25); }
    tbody td .status-chip { display:inline-flex; align-items:center; gap:6px; padding:5px 10px; border-radius:999px; font-weight:700; font-size:12px; text-transform:capitalize; }
    .status-ready { background:rgba(100,116,139,.18); color:#1f2937; }
    .status-processing { background:rgba(37,99,235,.16); color:#1d4ed8; }
    .status-paid { background:rgba(19,135,84,.15); color:#0f5c32; }
    .status-hold { background:rgba(240,173,0,.18); color:#8b5b00; }
    .status-blocked { background:rgba(180,35,24,.14); color:#842029; }
    .status-pending { background:rgba(48,82,163,.14); color:var(--accent); }

    .validation-flag { display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:600; color:#b45309; background:rgba(234,179,8,.18); border-radius:8px; padding:3px 6px; margin-top:4px; }

    .layout { display:grid; gap:18px; }
    #tableWrap { min-height:260px; position:relative; }
    .empty { padding:36px; text-align:center; color:var(--muted); }

    .pager { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:12px; }
    .pager select { padding:8px 10px; border-radius:10px; border:1px solid rgba(48,82,163,.2); background:#fff; color:var(--ink); font-weight:600; }

    .drawer { position:fixed; inset:0; pointer-events:none; display:flex; justify-content:flex-end; z-index:200; }
    .drawer.active { pointer-events:auto; }
    .drawer .overlay { flex:1; background:rgba(15,27,63,.28); opacity:0; transition:opacity .24s ease; }
    .drawer.active .overlay { opacity:1; }
    .drawer .panel { width:420px; max-width:calc(100vw - 60px); height:100%; border-radius:0; border-left:1px solid rgba(48,82,163,.24); transform:translateX(100%); transition:transform .28s ease; display:flex; flex-direction:column; padding:22px; }
    .drawer.active .panel { transform:translateX(0); }
    .drawer header { display:flex; align-items:flex-start; gap:10px; margin-bottom:18px; }
    .drawer header h2 { margin:0; font-size:20px; }
    .drawer header .meta { font-size:13px; color:var(--muted); }
    .drawer section { margin-bottom:18px; }
    .drawer section h3 { margin:0 0 8px; font-size:14px; letter-spacing:.05em; text-transform:uppercase; color:var(--muted); }
    .kv { display:grid; grid-template-columns:120px 1fr; gap:6px; font-size:13px; }
    .audit-log { max-height:180px; overflow:auto; border:1px solid rgba(48,82,163,.15); border-radius:12px; padding:10px; background:#f9fbff; display:grid; gap:8px; font-size:12px; }
    .notes { display:grid; gap:10px; font-size:13px; }
    .note-card { background:#f9f5ff; border-radius:12px; padding:10px; border:1px solid rgba(125,76,219,.24); }

    .attachments { display:grid; gap:10px; }
    .attachment { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid rgba(48,82,163,.18); background:#f8faff; font-size:13px; }

    .bulk-bar { position:fixed; left:0; right:0; bottom:0; background:#0f1b3f; color:#fff; display:flex; align-items:center; gap:16px; padding:12px 22px; box-shadow:0 -12px 28px rgba(15,27,63,.26); transform:translateY(100%); transition:transform .24s ease; z-index:150; }
    .bulk-bar.active { transform:translateY(0); }
    .bulk-bar strong { font-size:18px; }
    .bulk-bar .btn { background:rgba(255,255,255,.12); color:#fff; border-color:rgba(255,255,255,.32); }
    .bulk-bar .btn:hover { border-color:#fff; }

    #toast { position:fixed; bottom:18px; right:18px; display:grid; gap:10px; z-index:999; }

    @media(max-width:960px) {
      .summary-splits { grid-template-columns:1fr; }
      .drawer .panel { width:100%; max-width:100%; }
      .drawer .panel { border-radius:18px 18px 0 0; }
      .drawer { align-items:flex-end; }
      .drawer .panel { transform:translateY(100%); }
      .drawer.active .panel { transform:translateY(0); }
    }
  </style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">Payroll Console</div>
    <span class="pill">Admin</span>
    <div class="sp"></div>
    <div id="diagChips" class="chips" style="display:flex;gap:8px"></div>
    <a class="btn ghost" href="/">Website</a>
    <a class="btn ghost" href="/admin/">âŸµ Dashboard</a>
    <button class="btn" onclick="window.netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <div class="wrap" id="gate" style="display:none">
    <div class="panel">
      <strong>Admin only.</strong>
      <p class="muted why">Checking your sessionâ€¦</p>
      <button class="btn" onclick="window.netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <section class="panel" id="summaryPanel">
      <div class="summary-grid" id="totalsBar"></div>
      <div class="summary-splits">
        <div class="split" id="trendWidget">
          <h4>Week-on-week trend</h4>
          <p class="muted" id="trendCopy" style="margin:0">Awaiting dataâ€¦</p>
        </div>
        <div class="split" id="clientSummary">
          <h4>By client</h4>
          <ul></ul>
        </div>
        <div class="split" id="statusSummary">
          <h4>By status</h4>
          <ul></ul>
        </div>
      </div>
      <div class="actions" style="margin-top:18px">
        <button class="btn ghost small" id="btnRecalculate">Recalculate</button>
        <button class="btn ghost small" id="btnAutoCalc">Auto-calc employer cost &amp; margin</button>
        <button class="btn primary small" id="btnGeneratePdf">Generate payroll summary PDF</button>
      </div>
    </section>

    <section class="panel filters">
      <form id="filterForm" autocomplete="off">
        <div class="field">
          <label for="filterSearch">Global search</label>
          <input id="filterSearch" type="search" placeholder="Search candidate, client, reference"/>
        </div>
        <div class="field">
          <label for="filterStatus">Status</label>
          <select id="filterStatus">
            <option value="all">All statuses</option>
            <option value="ready">Ready</option>
            <option value="processing">Processing</option>
            <option value="paid">Paid</option>
            <option value="hold">On hold</option>
            <option value="pending">Pending</option>
            <option value="blocked">Blocked</option>
          </select>
        </div>
        <div class="field">
          <label for="filterClient">Client</label>
          <input id="filterClient" type="text" placeholder="Client name"/>
        </div>
        <div class="field">
          <label for="filterCandidate">Candidate</label>
          <input id="filterCandidate" type="text" placeholder="Candidate name"/>
        </div>
        <div class="field">
          <label for="filterInvoice">Invoice ref</label>
          <input id="filterInvoice" type="text" placeholder="Invoice reference"/>
        </div>
        <div class="field">
          <label for="filterCost">Cost centre</label>
          <input id="filterCost" type="text" placeholder="Cost centre"/>
        </div>
        <div class="field">
          <label for="filterPO">PO number</label>
          <input id="filterPO" type="text" placeholder="PO number"/>
        </div>
        <div class="field">
          <label for="filterFrom">Week ending from</label>
          <input id="filterFrom" type="date" aria-label="Week ending from"/>
        </div>
        <div class="field">
          <label for="filterTo">Week ending to</label>
          <input id="filterTo" type="date" aria-label="Week ending to"/>
        </div>
      </form>
      <div class="quick-filters" id="quickFilters">
        <button class="chip" data-quick="overdue">Show overdue</button>
        <button class="chip" data-quick="unapproved">Show unapproved</button>
        <button class="chip" data-quick="missing-timesheets">Show missing timesheets</button>
      </div>
      <div class="toggle-line">
        <label><input type="checkbox" id="toggleIssues"/> Only show items with notes or issues</label>
        <label><input type="checkbox" id="toggleNotes"/> Only items with internal notes</label>
        <span class="muted" id="resultMeta">0 payroll items</span>
        <span class="muted" id="weekBaseMeta" style="font-size:12px">Week 1 ends â€”</span>
      </div>
      <div class="range-controls">
        <button class="btn tiny" id="btnPrevWeek" aria-label="Previous week">â—€</button>
        <button class="btn tiny" id="btnNextWeek" aria-label="Next week">â–¶</button>
        <button class="btn ghost tiny" id="btnClear">Clear filters</button>
        <button class="btn ghost tiny" id="btnRefresh">Refresh</button>
        <button class="btn ghost tiny" id="btnRetry" style="display:none">Retry</button>
      </div>
      <div class="actions">
        <button class="btn ghost small" id="btnExportCsv">Export CSV</button>
        <button class="btn ghost small" id="btnExportXlsx">Export XLSX</button>
        <button class="btn ghost small" id="btnGenerateQuba">Generate Quba batch</button>
        <button class="btn ghost small" id="btnSendRemittance">Send remittance emails</button>
      </div>
    </section>

    <section class="panel layout">
      <div id="tableWrap">Loadingâ€¦</div>
      <div class="pager" id="pager" style="display:none">
        <div class="muted" id="pgInfo"></div>
        <div class="sp"></div>
        <select id="pgSize">
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <button class="btn small ghost" id="pgPrev">â—€</button>
        <button class="btn small ghost" id="pgNext">â–¶</button>
      </div>
    </section>
  </div>

  <div id="detailDrawer" class="drawer" aria-hidden="true">
    <div class="overlay" id="drawerOverlay"></div>
    <div class="panel">
      <header>
        <div>
          <h2 id="drawerTitle">Payroll detail</h2>
          <div class="meta" id="drawerMeta"></div>
        </div>
        <div class="sp"></div>
        <button class="btn ghost tiny" id="drawerClose">Close</button>
      </header>
      <section id="drawerTimesheet">
        <h3>Assignment</h3>
        <div class="kv" id="drawerAssignment"></div>
      </section>
      <section id="drawerBreakdown">
        <h3>Timesheet breakdown</h3>
        <div id="drawerHours" class="muted">No breakdown available.</div>
      </section>
      <section id="drawerStatus">
        <h3>Status history</h3>
        <div id="drawerTimeline" class="audit-log"></div>
        <div class="actions" style="margin-top:12px">
          <button class="btn tiny" data-status="ready">Mark ready</button>
          <button class="btn tiny" data-status="processing">Mark processing</button>
          <button class="btn tiny" data-status="paid">Mark paid</button>
          <button class="btn tiny" data-status="hold">Put on hold</button>
        </div>
      </section>
      <section id="drawerNotes">
        <h3>Internal notes</h3>
        <div class="notes" id="notesList"></div>
        <form id="noteForm" style="margin-top:12px; display:grid; gap:8px">
          <textarea id="noteInput" rows="3" placeholder="Add note for payroll trail" style="border-radius:10px; border:1px solid rgba(48,82,163,.22); padding:10px; resize:vertical; font-family:inherit;"></textarea>
          <div style="display:flex; gap:8px; justify-content:flex-end">
            <button class="btn ghost tiny" type="button" id="noteCancel">Cancel</button>
            <button class="btn primary tiny" type="submit">Add note</button>
          </div>
        </form>
      </section>
      <section id="drawerAttachments">
        <h3>Attachments</h3>
        <div class="attachments" id="attachmentList"></div>
      </section>
    </div>
  </div>

  <div id="bulkBar" class="bulk-bar" aria-live="polite">
    <div><strong id="bulkCount">0</strong> selected</div>
    <div id="bulkValue" class="muted" style="font-weight:600"></div>
    <div class="sp"></div>
    <button class="btn tiny" id="bulkReady">Mark ready (R)</button>
    <button class="btn tiny" id="bulkProcessing">Processing</button>
    <button class="btn tiny" id="bulkPaid">Mark paid (P)</button>
    <button class="btn tiny" id="bulkHold">Put on hold (O)</button>
    <button class="btn tiny" id="bulkCsv">Export CSV</button>
  </div>

  <div id="toast" aria-live="polite" aria-atomic="true"></div>

  <script src="/admin/payroll-logic.js"></script>
  <script src="/admin/payroll.js" defer></script>
</body>
</html>
