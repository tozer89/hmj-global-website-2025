<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets â€” Admin | HMJ-Global</title>


<link rel="stylesheet" href="/css/style.css"/>
<style>
  /* ---------------- THEME ---------------- */
  :root{
    /* Light (default) */
    --bg:#ffffff;
    --ink:#0b1a3a;
    --muted:#5a6b88;
    --panel:#102347;          /* dark blue cards */
    --panel-ink:#eaf1ff;      /* white-ish text on blue */
    --border:#dbe3f4;
    --chip:#e8eefb;
    --accent:#3A66B3;
    --accent-ink:#ffffff;
    --warn:#e6a100; --good:#198754; --bad:#b73b3b;
    --soft:#f4f7ff;
    --shadow: 0 8px 28px rgba(16,35,71,.18);
    --shadow-hover: 0 14px 42px rgba(16,35,71,.28);
  }
  [data-theme="dark"]{
    /* Dark */
    --bg:#0b0f18;
    --ink:#e8eef7;
    --muted:#9fb0c9;
    --panel:#111827;
    --panel-ink:#e8eef7;
    --border:#252f3f;
    --chip:#182238;
    --accent:#4b7ce2;
    --accent-ink:#071022;
    --soft:#0c1629;
    --shadow: 0 8px 24px rgba(0,0,0,.35);
    --shadow-hover: 0 18px 52px rgba(0,0,0,.5);
  }

  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .top{position:sticky;top:0;background:linear-gradient(180deg,#ffffff,rgba(255,255,255,.92));
       border-bottom:1px solid var(--border);z-index:6}
  [data-theme="dark"] .top{background:#0c1222;}
  .row{max-width:1280px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}
  .sp{flex:1}

  .wrap{max-width:1280px;margin:16px auto 40px;padding:0 18px;display:grid;gap:16px;grid-template-columns: 1fr 360px}
  @media(max-width:1100px){ .wrap{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;color:var(--panel-ink);box-shadow:var(--shadow);transition:box-shadow .18s, transform .18s}
  .card:hover{box-shadow:var(--shadow-hover);transform:translateY(-1px)}
  .card.white{background:#fff;color:var(--ink)}
  .muted{color:var(--muted)}
  .btn{background:var(--accent);border:0;color:var(--accent-ink);padding:9px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
  .btn.good{background:var(--good);color:#fff}
  .btn.warn{background:var(--warn);color:#1a1600}
  .btn.bad{background:var(--bad);color:#fff}
  .btn.chip{background:var(--chip);color:var(--ink);border:1px solid var(--border);font-weight:600}
  .chipline{display:flex;gap:6px;flex-wrap:wrap}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--ink);font-size:12px}
  .stat{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:110px;height:72px;background:#fff;color:var(--ink);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
  [data-theme="dark"] .stat{background:#0f172a;color:var(--panel-ink)}
  .stat b{font-size:20px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .rowgrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media(max-width:880px){ .rowgrid{grid-template-columns:1fr 1fr} }
  @media(max-width:640px){ .rowgrid{grid-template-columns:1fr} }
  label{display:flex;flex-direction:column;gap:6px;font-size:12px}
  input,select,textarea{background:#fff;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px}
  [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{background:#0f172a;color:#e8eef7;border-color:#2c3853}
  input[type="date"]{min-width:160px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .tbl .hd{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tbl .bd{background:#fff;color:var(--ink);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  [data-theme="dark"] .tbl .bd{background:#0f172a;color:var(--panel-ink);border-color:#2c3853}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2b3854;background:#101a33;color:#cfe0ff}
  .badge.submitted{background:#2a2210;border-color:#5b4a19;color:#f0d48f}
  .badge.approved{background:#0e2418;border-color:#1f4a2f;color:#9cf0b2}
  .badge.rejected{background:#2a1010;border-color:#5b2b2b;color:#f6a7a7}
  .kbr{outline:none} .kbr:focus{box-shadow:0 0 0 3px rgba(58,102,179,.45)}

  /* Modal */
  .backdrop{position:fixed;inset:0;background:rgba(9,12,20,.5);display:none;align-items:center;justify-content:center;z-index:10000}
  .backdrop.show{display:flex}
  .modal{width:min(1080px,96vw);max-height:90vh;background:#fff;color:var(--ink);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.45)}
  [data-theme="dark"] .modal{background:#0f172a;color:#e8eef7;border-color:#25324a}
  .modal .hd{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between}
  .modal .bd{padding:14px;overflow:auto;max-height:66vh}
  .modal .ft{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{display:inline-block;background:var(--soft);border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--ink);font-weight:700}
  [data-theme="dark"] .pill{background:#0c1629;border-color:#233044;color:#cfe0ff}
  .table-soft{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table-soft th{color:#8fa3c6;font-size:12px}
  .table-soft td{background:var(--soft);border:1px solid var(--border)}
  [data-theme="dark"] .table-soft td{background:#0c1629;border-color:#233044}
  .sr{position:absolute;left:-9999px}
  .hint{cursor:help;border-radius:999px;background:var(--chip);padding:2px 6px;border:1px solid var(--border);font-weight:800;color:var(--ink)}
  .titlePulse{animation:titlepulse 10s infinite}
  @keyframes titlepulse{
    0%{text-shadow:none} 8%{text-shadow:0 0 12px rgba(58,102,179,.7)} 16%{text-shadow:none} 100%{text-shadow:none}
  }

  /* Calendar */
  .cal{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px}
  .cal .d{background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;min-height:120px}
  [data-theme="dark"] .cal .d{background:#0f172a;border-color:#2c3853}
  .cal .d b{font-size:12px;color:var(--muted)}
  .cal .e{margin-top:6px;padding:6px 8px;border-radius:10px;background:var(--chip);border:1px solid var(--border);font-size:12px;color:var(--ink)}

  /* Charts placeholder area */
  .chart{height:220px;background:#fff;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  [data-theme="dark"] .chart{background:#0f172a;border-color:#2c3853}

  /* Mobile simplifications */
  @media(max-width:720px){
    .hide-mobile{display:none}
    .modal .bd{max-height:60vh}
  }
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand titlePulse" id="pageTitle">Timesheets â€” Admin <span class="hint" title="All actions are audited.">?</span></div>
  <div class="sp"></div>

  <button class="btn chip" id="btnTheme" title="Toggle light/dark">ðŸŒ™ Theme</button>
  <a class="btn chip" href="/admin/">âŸµ Admin home</a>
  <button class="btn chip" onclick="netlifyIdentity?.logout()">Sign out</button>
</div></div>

<!-- DEBUG PANEL -->
<div class="wrap" id="debugWrap" style="grid-template-columns:1fr;display:none">
  <div class="card white" id="debugCard" style="white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New',monospace"></div>
</div>

<!-- GATE -->
<div class="wrap" id="gate" style="display:none;grid-template-columns:1fr">
  <div class="card">
    <div class="chipline" id="diagChips"></div>
    <h2 style="margin:.3em 0">Restricted.</h2>
    <p class="muted">Sign in required.</p>
    <div style="display:flex;gap:8px"><button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
      <button class="btn ghost" onclick="location.reload()">Reload</button></div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <!-- Left column -->
  <div class="card white" style="display:grid;gap:16px">
    <!-- Stats -->
    <div class="rowgrid">
      <div class="stat" title="Total timesheets in result"><div class="muted">Total</div><b id="statTotal">0</b></div>
      <div class="stat" title="Filtered rows"><div class="muted">Filtered</div><b id="statFiltered">0</b></div>
      <div class="stat" title="Selected rows for bulk actions"><div class="muted">Selected</div><b id="statSelected">0</b></div>
    </div>

    <div class="toolbar">
      <button class="btn chip" id="btnRefresh" title="Reload list (R)">Refresh</button>
      <button class="btn chip" id="btnBulkApprove" title="Approve selected items (B)">Bulk approve</button>
      <button class="btn chip" id="btnCsv" title="Export current view (E)">Export CSV</button>
      <button class="btn chip" id="btnCalendar" title="Toggle calendar view">ðŸ“… Calendar</button>
      <button class="btn chip" id="btnChart" title="Toggle charts view">ðŸ“ˆ Charts</button>
      <button class="btn chip hide-mobile" id="btnDebug" title="Show/hide diagnostics">Debug</button>
    </div>

    <!-- Saved views -->
    <div class="card" style="background:var(--soft);color:var(--ink);border-color:var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div class="muted">Saved views</div>
        <div class="chipline" id="savedViews"></div>
        <span class="sp"></span>
        <button class="btn chip" id="btnSaveView" title="Save current filters">Save current</button>
        <button class="btn chip" id="btnDelView" title="Delete selected view">Delete</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="card white">
      <div class="hd" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div class="muted">Hide/show filters</div>
        <span class="muted hide-mobile">Shortcuts: / search Â· R refresh Â· B bulk approve Â· E export</span>
        <span class="sp"></span>
        <button class="btn chip" id="btnToggleFilters">Apply</button>
      </div>
      <div class="rowgrid" id="filters">
        <label>Search contractor / client / project / site
          <input id="q" placeholder="joe@â€¦ / Smith / Hull / Pharma" class="kbr" aria-label="Search"/>
        </label>
        <label>Status
          <select id="status" class="kbr"><option value="">Any status</option><option>draft</option><option>submitted</option><option>approved</option><option>rejected</option></select>
        </label>
        <label>Client
          <select id="clientId" class="kbr"><option value="">All clients</option></select>
        </label>
        <label>Week ending
          <input id="week" type="date" class="kbr"/>
        </label>
        <label class="hide-mobile">Role view
          <select id="roleView" class="kbr" title="UI view by role"><option value="admin">Admin</option><option value="recruiter">Recruiter</option><option value="client">Client</option></select>
        </label>
      </div>
    </div>

    <!-- Table -->
    <div class="tbl">
      <div class="hd">
        <div class="chipline">
          <span class="tag"><input type="checkbox" id="toggleAll"/> Select all</span>
          <span class="tag">Hints <input type="checkbox" id="toggleHints" style="margin-left:6px" checked/></span>
        </div>
      </div>
      <div class="bd" id="list" role="table" aria-label="Timesheets table">
        Loadingâ€¦
      </div>
      <div id="calendarWrap" class="card white" style="display:none">
        <div class="muted" style="margin-bottom:6px">Calendar (week ending)</div>
        <div class="cal" id="calendar"></div>
      </div>
      <div id="chartWrap" class="card white" style="display:none">
        <div class="muted" style="margin-bottom:6px">Trends</div>
        <div class="chart" id="chart">Chart renders client-side (std/OT & Â£ total)</div>
      </div>
    </div>
  </div>

  <!-- Right column -->
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px">Raise on behalf <span class="hint" title="Create a draft from assignment rates.">?</span></div>
    <div class="rowgrid" style="grid-template-columns:1fr 1fr">
      <label>Assignment ID <input id="createAssignmentId" inputmode="numeric" placeholder="e.g. 42"/></label>
      <label>Week ending <input id="createWeekEnding" type="date"/></label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn good" id="btnCreate" title="Create empty timesheet">Create draft</button>
      <button class="btn ghost" id="btnOpenContractor" title="Open contractor profile">Open contractor</button>
    </div>
    <div class="muted" style="margin-top:8px">Creates a draft; edit & submit/approve from the table.</div>

    <hr style="border:0;border-top:1px solid var(--border);margin:16px 0"/>

    <div style="font-weight:800;margin-bottom:8px">Audit (latest)</div>
    <div id="auditBody" class="muted">Loadingâ€¦</div>

    <hr style="border:0;border-top:1px solid var(--border);margin:16px 0"/>

    <div style="font-weight:800;margin-bottom:8px">Reminders & alerts</div>
    <label style="display:flex;gap:8px;align-items:center">
      <input type="checkbox" id="chkRemindDry" checked/>
      <span>Send reminder to contractors with unsubmitted sheets for last week</span>
    </label>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button class="btn chip" id="btnRunRemind">Run now</button>
      <button class="btn chip" id="btnOverdue" title="Highlight overdue approvals">Flag overdue</button>
    </div>
    <div id="remindResult" class="muted" style="margin-top:8px"></div>

    <hr style="border:0;border-top:1px solid var(--border);margin:16px 0"/>

    <div style="display:flex;align-items:center;gap:8px">
      <div style="font-weight:800">Import candidates (CSV)</div>
      <span class="hint" title="Columns: first_name,last_name,email,phone,pay_type,status">?</span>
    </div>
    <input type="file" id="fileImport" accept=".csv" style="margin-top:6px"/>
    <button class="btn chip" id="btnImport" style="margin-top:8px">Import</button>
    <div id="importLog" class="muted" style="margin-top:8px;max-height:120px;overflow:auto"></div>
  </div>
</div>

<!-- Modal -->
<div class="backdrop" id="sheetBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="hd">
      <div>
        <div id="sheetTitle" style="font-weight:800">Timesheet</div>
        <div id="sheetSub" class="muted" style="font-size:12px"></div>
      </div>
      <div class="chipline" style="align-items:center">
        <span id="statusBadge" class="badge draft" aria-live="polite">draft</span>
        <button class="btn chip" id="btnCloseModal" aria-label="Close">Close without saving</button>
      </div>
    </div>
    <div class="bd">
      <div id="sheetMeta" class="muted" style="margin-bottom:8px"></div>

      <table class="table-soft" aria-label="Per-day hours">
        <thead>
          <tr><th>Day</th><th>Std (h)</th><th>OT (h)</th><th>Note</th></tr>
        </thead>
        <tbody id="sheetBody"></tbody>
      </table>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0">
        <button class="btn ghost" id="qfMonFri" title="Monâ€“Fri 8h">Monâ€“Fri 8h</button>
        <button class="btn ghost" id="qfClear">Clear all</button>
        <button class="btn ghost" id="qfStd">Set all stdâ€¦</button>
        <button class="btn ghost" id="qfOT">Set all OTâ€¦</button>
      </div>

      <div class="rowgrid" style="grid-template-columns:1fr 1fr">
        <div class="card white">
          <div><b>Standard</b></div>
          <div id="sumStd" class="pill" style="margin-top:6px">0h</div>
          <div id="rateStd" class="muted" style="margin-top:4px">Rate: Â£0.00/h</div>
        </div>
        <div class="card white">
          <div><b>Overtime</b></div>
          <div id="sumOT" class="pill" style="margin-top:6px">0h</div>
          <div id="rateOT" class="muted" style="margin-top:4px">Rate: Â£0.00/h</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div><b>Estimated gross</b></div>
        <div id="sumGross" class="pill" style="margin-top:6px">Â£0.00</div>
        <div id="autoChecks" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
    <div class="ft">
      <button class="btn"   id="btnSave">Save</button>
      <button class="btn warn" id="btnSubmit">Mark submitted</button>
      <button class="btn good" id="btnApprove">Approve</button>
      <button class="btn bad"  id="btnReject">Reject</button>
      <button class="btn bad"  id="btnDelete">Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ========================= PAGE LOGIC =========================
   Relies on helpers injected by /admin/common.js:
   - gate({ requireRole }) => handles identity, token, role
   - api(path, method, body) => calls your Netlify functions
   - sel(query) => DOM lookup
   - toast(msg, type?, delay?)
   - setTrace / getTrace for server-side trace correlation
================================================================ */

async function main({ api, sel, toast, setTrace, getTrace, identity, isMobile }) {
  // ---- Function names (keep in sync with your functions) ----
  const FN_LIST     = '/admin-timesheets-list';
  const FN_GET      = '/admin-timesheets-get';
  const FN_EDIT     = '/admin-timesheets-edit';
  const FN_APPROVE  = '/admin-timesheets-approve';
  const FN_REJECT   = '/admin-timesheets-reject';
  const FN_DELETE   = '/admin-timesheets-delete';
  const FN_CREATE   = '/admin-timesheets-create';
  const FN_AUDIT    = '/admin-audit-list';
  const FN_CLIENTS  = '/admin-timesheets-clients';
  const FN_REMIND   = '/admin-timesheets-remind';
  const FN_CAND_SAVE = '/admin-candidates-save';

  // ---- DOM ----
  const $ = (s)=>sel(s);
  const debugWrap = $('#debugWrap'); const debugCard = $('#debugCard'); const diagChips = $('#diagChips');
  const listEl = $('#list'); const statTotal = $('#statTotal'); const statFiltered = $('#statFiltered'); const statSelected = $('#statSelected');
  const q = $('#q'); const status = $('#status'); const clientId = $('#clientId'); const week = $('#week');
  const roleView = $('#roleView'); const btnRefresh = $('#btnRefresh'); const btnCsv = $('#btnCsv');
  const btnBulkApprove = $('#btnBulkApprove'); const toggleAll = $('#toggleAll'); const btnToggleFilters = $('#btnToggleFilters');
  const savedViews = $('#savedViews'); const btnSaveView = $('#btnSaveView'); const btnDelView = $('#btnDelView');
  const btnCalendar = $('#btnCalendar'); const calendarWrap = $('#calendarWrap'); const calendar = $('#calendar');
  const btnChart = $('#btnChart'); const chartWrap = $('#chartWrap'); const chart = $('#chart');
  const btnDebug = $('#btnDebug'); const btnTheme = $('#btnTheme'); const pageTitle = $('#pageTitle');
  const toggleHints = $('#toggleHints');

  const createAssignmentId = $('#createAssignmentId'); const createWeekEnding = $('#createWeekEnding');
  const btnCreate = $('#btnCreate'); const btnOpenContractor = $('#btnOpenContractor');

  const auditBody = $('#auditBody'); const remindResult = $('#remindResult');
  const chkRemindDry = $('#chkRemindDry'); const btnRunRemind = $('#btnRunRemind'); const btnOverdue = $('#btnOverdue');

  // Modal
  const backdrop = $('#sheetBackdrop'); const sheetTitle = $('#sheetTitle'); const sheetSub = $('#sheetSub'); const sheetMeta = $('#sheetMeta');
  const sheetBody = $('#sheetBody'); const statusBadge = $('#statusBadge');
  const rateStd = $('#rateStd'); const rateOT = $('#rateOT'); const sumStd = $('#sumStd'); const sumOT = $('#sumOT'); const sumGross = $('#sumGross'); const autoChecks = $('#autoChecks');
  const btnCloseModal = $('#btnCloseModal'); const btnSave = $('#btnSave'); const btnSubmit = $('#btnSubmit'); const btnApprove = $('#btnApprove'); const btnReject = $('#btnReject'); const btnDelete = $('#btnDelete');

  // Import
  const fileImport = $('#fileImport'); const btnImport = $('#btnImport'); const importLog = $('#importLog');

  // ---- Local cache (60 day TTL) ----
  const CACHE_TTL_MS = 60 * 24 * 60 * 60 * 1000;
  const CACHE_LIST_KEY = 'hmj_ts_cache_list_v1';
  const CACHE_DETAIL_KEY = 'hmj_ts_cache_detail_v1';

  const readCache = (key, fallback) => {
    try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch { return fallback; }
  };
  const writeCache = (key, value) => {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
  };

  function setCachedList(payload){
    if(!payload || !Array.isArray(payload.items)) return;
    writeCache(CACHE_LIST_KEY, { savedAt: Date.now(), filters: payload.filters||{}, items: payload.items });
  }

  function getCachedList(){
    const cached = readCache(CACHE_LIST_KEY, null);
    if(!cached) return null;
    if(!cached.savedAt || (Date.now() - cached.savedAt) > CACHE_TTL_MS){
      localStorage.removeItem(CACHE_LIST_KEY);
      return null;
    }
    return cached;
  }

  function pruneDetailStore(store){
    const now = Date.now();
    let changed = false;
    for(const key of Object.keys(store)){
      const entry = store[key];
      if(!entry?.savedAt || (now - entry.savedAt) > CACHE_TTL_MS){
        delete store[key];
        changed = true;
      }
    }
    return { store, changed };
  }

  function setCachedDetail(id, data){
    if(!id || !data) return;
    const key = String(id);
    const store = readCache(CACHE_DETAIL_KEY, {});
    store[key] = { savedAt: Date.now(), data };
    const pruned = pruneDetailStore(store);
    writeCache(CACHE_DETAIL_KEY, pruned.store);
  }

  function getCachedDetail(id){
    if(!id) return null;
    const store = readCache(CACHE_DETAIL_KEY, {});
    const pruned = pruneDetailStore(store);
    if(pruned.changed) writeCache(CACHE_DETAIL_KEY, pruned.store);
    return pruned.store[String(id)]?.data || null;
  }

  // ---- Theme toggle ----
  const THEME_KEY='hmj_theme';
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY,t); btnTheme.innerHTML = t==='dark'?'ðŸŒž Light':'ðŸŒ™ Dark'; }
  setTheme(localStorage.getItem(THEME_KEY)||'light');
  btnTheme.onclick=()=>setTheme((localStorage.getItem(THEME_KEY)||'light')==='light'?'dark':'light');

  // ---- State ----
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let LIST = []; let FILTERED = []; let SELECTED = new Set(); let CUR=null; let DIRTY=false;
  let ROLE = 'admin';  // ui-view override only; gate still enforces actual roles

  // ---- Utilities ----
  const money = (n)=>Number(n||0).toLocaleString('en-GB',{style:'currency',currency:'GBP'});
  const fmtDate = (d)=>d||'';
  function badgeForStatus(s){ statusBadge.textContent = s||'-'; statusBadge.className='badge '+(s||'draft'); }
  function lockForStatus(s){
    const locked = (s !== 'draft' && s !== 'rejected');
    sheetBody.querySelectorAll('input,textarea').forEach(i=> i.disabled = locked);
    btnSave.disabled = locked; btnSubmit.disabled = locked;
    btnApprove.disabled = (s!=='submitted'); btnReject.disabled = (s!=='submitted');
  }
  function sumHours(){
    const t = Object.values(CUR.entries||{}).reduce((a,r)=>({std:a.std+Number(r.std||0), ot:a.ot+Number(r.ot||0)}),{std:0,ot:0});
    sumStd.textContent = `${t.std}h`; sumOT.textContent = `${t.ot}h`;
    const gross = t.std*Number(CUR?.rates?.std||0) + t.ot*Number(CUR?.rates?.ot||0);
    sumGross.textContent = money(gross);
    runAutoChecks(t.std, t.ot);
  }
  function runAutoChecks(std, ot){
    const msgs=[];
    if(std+ot===0) msgs.push('No hours entered.');
    if(std>60) msgs.push('Standard hours unusually high this week.');
    const anyOver24 = Object.values(CUR.entries||{}).some(r => Number(r.std||0)+Number(r.ot||0) > 24);
    if(anyOver24) msgs.push('A day exceeds 24 total hours.');
    autoChecks.innerHTML = msgs.length? 'Checks: '+ msgs.map(x=>`<span class="tag">${x}</span>`).join(' ') : '';
  }
  function openModal(){ backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
  function closeModal(){ if(DIRTY && CUR && CUR.status==='draft' && !confirm('Discard unsaved changes?')) return; backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); CUR=null; DIRTY=false; }

  // Debug helpers
  let DEBUG=false;
  function dlog(line){ if(!DEBUG) return; debugCard.textContent = (debugCard.textContent?debugCard.textContent+'\n':'') + line; debugCard.scrollTop = debugCard.scrollHeight; }
  function addChip(txt, ok, key){
    if(diagChips && key){
      const existing = diagChips.querySelector(`[data-chip="${key}"]`);
      if(existing){
        existing.textContent = txt;
        existing.style.borderColor = ok?'#35b37e':'#b73b3b';
        existing.style.color = ok?'#0f5132':'#842029';
        existing.style.background = ok?'#e8f6ef':'#fdeeee';
        return existing;
      }
    }
    const s=document.createElement('span');
    s.className='tag';
    if(key) s.dataset.chip = key;
    s.style.borderColor = ok?'#35b37e':'#b73b3b';
    s.style.color = ok?'#0f5132':'#842029';
    s.style.background = ok?'#e8f6ef':'#fdeeee';
    s.textContent=txt;
    diagChips.append(s);
    return s;
  }

  // title toast every ~10s (gentle)
  setInterval(()=> toast('Timesheets â€” Admin', 'info', 2000), 10000);

  // Saved views (local)
  const VIEWS_KEY='hmj_timesheet_views';
  function loadViews(){ try{ return JSON.parse(localStorage.getItem(VIEWS_KEY)||'[]'); }catch{return []} }
  function saveViews(v){ localStorage.setItem(VIEWS_KEY, JSON.stringify(v)); }
  function renderViews(){
    const views = loadViews();
    savedViews.innerHTML = views.length? '' : '<span class="tag">(none)</span>';
    views.forEach((v,i)=>{
      const b=document.createElement('button'); b.className='btn chip'; b.textContent=v.name; b.onclick=()=>{
        q.value=v.q; status.value=v.status; clientId.value=v.client_id||''; week.value=v.week||''; loadList();
      }; savedViews.append(b);
    });
  }
  btnSaveView.onclick=()=>{
    const name=prompt('Name this view:','My filter'); if(!name) return;
    const views=loadViews(); views.push({ name, q:q.value||'', status:status.value||'', client_id:clientId.value||'', week:week.value||'' });
    saveViews(views); renderViews(); toast('View saved');
  };
  btnDelView.onclick=()=>{ const name=prompt('Delete view named:'); if(!name) return; const views=loadViews().filter(v=>v.name!==name); saveViews(views); renderViews(); toast('Deleted (if existed)'); };

  // Role-aware UI (soft view switch)
  roleView.onchange = ()=>{ ROLE = roleView.value; renderList(); };

  // Hints
  toggleHints.onchange=()=> document.querySelectorAll('[title]').forEach(el=> el.toggleAttribute('data-nohint', !toggleHints.checked));

  // Calendar & chart toggles
  btnCalendar.onclick = ()=>{ calendarWrap.style.display = calendarWrap.style.display==='none' ? '' : 'none'; renderCalendar(); };
  btnChart.onclick    = ()=>{ chartWrap.style.display    = chartWrap.style.display==='none'    ? '' : 'none'; renderChart(); };

  // Debug
  btnDebug.onclick = ()=>{ DEBUG=!DEBUG; debugWrap.style.display = DEBUG? 'grid':'none'; debugCard.textContent=''; dlog('[debug] enabled'); };

  // Keyboard
  document.addEventListener('keydown', (e)=>{
    if(e.key==='/' && document.activeElement!==q){ e.preventDefault(); q.focus(); }
    if(e.key.toLowerCase()==='r'){ e.preventDefault(); loadList(); }
    if(e.key.toLowerCase()==='b'){ e.preventDefault(); bulkApprove(); }
    if(e.key.toLowerCase()==='e'){ e.preventDefault(); exportCsv(); }
  });

  // --------- Load clients for filter ---------
  async function loadClients(){
    try{
      const res = await api(FN_CLIENTS,'GET');
      if(Array.isArray(res)){
        clientId.innerHTML = '<option value="">All clients</option>' + res.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        addChip('clients: ok', true, 'clients');
      } else { addChip('clients: unexpected', false, 'clients'); }
    }catch(e){ addChip('clients: fail', false, 'clients'); dlog('[ERR] clients '+e.message); }
  }

  // --------- Audit ---------
  async function loadAudit(){
    auditBody.textContent = 'Loadingâ€¦';
    try{
      const res = await api(FN_AUDIT,'POST',{ limit:8 });
      const items = Array.isArray(res) ? res : (res?.items||[]);
      if(!items.length){ auditBody.textContent = 'Audit unavailable'; return; }
      auditBody.innerHTML = items.map(i=>`
        <div style="padding:8px;border-bottom:1px solid var(--border)">
          <div><b>${i.action||'-'}</b> â€¢ <span class="muted">${i.at||i.created_at||''}</span></div>
          <div class="muted" style="font-size:12px">${(i.actor_email||i.user_email||'')}</div>
          <div style="font-size:12px">${(i.summary||'').replace(/</g,'&lt;')}</div>
        </div>`).join('');
    }catch(e){ auditBody.textContent = 'Audit unavailable'; dlog('[ERR] audit '+e.message); }
  }

  // --------- List ---------
  async function loadList(){
    listEl.textContent='Loadingâ€¦';
    const filters = { q:q.value||'', status:status.value||'', client_id: clientId.value||'', week:week.value||'' };
    localStorage.setItem('hmj_ts_filters', JSON.stringify(filters)); // offline-ish
    try{
      const res = await api(FN_LIST,'POST',filters);
      const rows = Array.isArray(res) ? res : (res?.items||[]);
      LIST = rows||[];
      statTotal.textContent = String(LIST.length);
      setCachedList({ filters, items: LIST });
      addChip('timesheets: live', true, 'timesheets');
      filterAndRender();
      dlog(`[OK] POST ${FN_LIST} -> ${LIST.length} rows`);
    }catch(e){
      dlog(`[ERR] ${FN_LIST} ${e.message}`);
      const cached = getCachedList();
      if(cached){
        LIST = cached.items || [];
        statTotal.textContent = String(LIST.length);
        addChip('timesheets: cached', false, 'timesheets');
        toast('Live data unavailable â€” showing cached list', 'warn', 4800);
        filterAndRender();
      }else{
        listEl.innerHTML='<div class="muted">List failed.</div>';
        toast('List failed: '+e.message,'error');
      }
    }
  }

  function filterAndRender(){
    // fuzzy search on client/project/contractor/site (simple contains across cols)
    const needle = (q.value||'').trim().toLowerCase();
    FILTERED = LIST.filter(r=>{
      const hay = [r.contractor_email, r.client_name, r.project_name, r.site_name].filter(Boolean).join(' ').toLowerCase();
      const okQ = !needle || hay.includes(needle);
      const okS = !status.value || (r.status === status.value);
      const okC = !clientId.value || String(r.client_id) === String(clientId.value);
      const okW = !week.value || String(r.week_ending) === String(week.value);
      return okQ && okS && okC && okW;
    });
    statFiltered.textContent=String(FILTERED.length);
    renderList();
    renderCalendar();
    renderChart();
    updateSelectionStats();
  }

  function renderList(){
    if(!FILTERED.length){ listEl.innerHTML='<div class="muted" style="padding:14px">No results.</div>'; return; }
    const canApprove = ROLE!=='client'; // clients canâ€™t bulk approve in this view
    const rows = FILTERED.map(r=>{
      const gross = (Number(r.std||0)*Number(r.rate_std||0)) + (Number(r.ot||0)*Number(r.rate_ot||0));
      const badge = `<span class="badge ${r.status||'draft'}">${r.status||'draft'}</span>`;
      const chk = `<input type="checkbox" data-sel="${r.id}" ${SELECTED.has(r.id)?'checked':''} aria-label="select row">`;
      return `
        <tr>
          <td class="hide-mobile">${chk}</td>
          <td class="hide-mobile">${r.id}</td>
          <td>${fmtDate(r.week_ending)}</td>
          <td>${badge}</td>
          <td class="hide-mobile">${r.contractor_email||'â€”'}</td>
          <td>${[r.client_name,r.project_name,r.site_name].filter(Boolean).join(' â€¢ ')||'â€”'}</td>
          <td class="hide-mobile">${r.std||0}</td>
          <td class="hide-mobile">${r.ot||0}</td>
          <td class="hide-mobile">${money(gross)}</td>
          <td style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn chip" data-open="${r.id}" title="Open sheet">Open</button>
            ${canApprove? `<button class="btn good chip" data-approve="${r.id}" title="Approve">Approve</button>
                           <button class="btn bad chip" data-reject="${r.id}" title="Reject">Reject</button>`:''}
          </td>
        </tr>`;
    }).join('');
    listEl.innerHTML = `
      <table role="grid" aria-rowcount="${FILTERED.length}">
        <thead><tr>
          <th class="hide-mobile"></th>
          <th class="hide-mobile">ID</th><th>Week ending</th><th>Status</th><th class="hide-mobile">Contractor</th>
          <th>Client â€¢ Project â€¢ Site</th><th class="hide-mobile">Std</th><th class="hide-mobile">OT</th><th class="hide-mobile">Gross</th><th></th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    listEl.querySelectorAll('button[data-open]').forEach(b=> b.onclick=()=> openSheet(Number(b.dataset.open)));
    listEl.querySelectorAll('button[data-approve]').forEach(b=> b.onclick=()=> quickApprove(Number(b.dataset.approve)));
    listEl.querySelectorAll('button[data-reject]').forEach(b=> b.onclick=()=> quickReject(Number(b.dataset.reject)));
    listEl.querySelectorAll('input[data-sel]').forEach(c=> c.onchange=(e)=>{
      const id=Number(c.dataset.sel); if(c.checked) SELECTED.add(id); else SELECTED.delete(id); updateSelectionStats();
    });
  }

  function updateSelectionStats(){ statSelected.textContent=String(SELECTED.size); }

  // ---- Calendar from FILTERED (group by week) ----
  function renderCalendar(){
    if(calendarWrap.style.display==='none') return;
    const weeks = [...new Set(FILTERED.map(r=>r.week_ending))].sort();
    if(!weeks.length){ calendar.innerHTML=''; return; }
    // render current month 5 weeks grid
    calendar.innerHTML = weeks.slice(0,7).map(w=>{
      const items = FILTERED.filter(r=>r.week_ending===w);
      return `<div class="d"><b>${w}</b>${items.map(r=>`<div class="e">${r.contractor_email||'â€”'} â€¢ ${r.status}</div>`).join('')}</div>`;
    }).join('');
  }

  // ---- Simple chart (no external libs; text fallback) ----
  function renderChart(){
    if(chartWrap.style.display==='none') return;
    const totalStd=FILTERED.reduce((a,r)=>a+Number(r.std||0),0);
    const totalOT =FILTERED.reduce((a,r)=>a+Number(r.ot||0),0);
    const gross = FILTERED.reduce((a,r)=> a + (Number(r.std||0)*Number(r.rate_std||0) + Number(r.ot||0)*Number(r.rate_ot||0)), 0);
    chart.textContent = `Std: ${totalStd}h â€¢ OT: ${totalOT}h â€¢ Gross est: ${money(gross)}`;
  }

  // ---- Toggle all in view ----
  toggleAll.onchange = ()=>{
    if(!FILTERED.length) return;
    if(toggleAll.checked) FILTERED.forEach(r=>SELECTED.add(r.id)); else SELECTED.clear();
    renderList(); updateSelectionStats();
  };

  // ---- Quick actions ----
  async function quickApprove(id){
    try{ await api(FN_APPROVE,'POST',{ id }); toast('Approved'); loadList(); loadAudit(); }catch(e){ toast('Approve failed: '+e.message,'error'); }
  }
  async function quickReject(id){
    const reason = prompt('Reason for rejection:',''); if(reason===null) return;
    try{ await api(FN_REJECT,'POST',{ id, reason }); toast('Rejected'); loadList(); loadAudit(); }catch(e){ toast('Reject failed: '+e.message,'error'); }
  }
  async function bulkApprove(){
    if(!SELECTED.size) return toast('Select rows first','error');
    if(!confirm(`Approve ${SELECTED.size} selected timesheet(s)?`)) return;
    let ok=0, fail=0;
    for(const id of SELECTED){ try{ await api(FN_APPROVE,'POST',{ id }); ok++; } catch{ fail++; } }
    toast(`Bulk approve finished â€” OK ${ok}, Failed ${fail}`);
    SELECTED.clear(); loadList(); loadAudit();
  }

  // ---- Modal open + edit ----
  function curFromPayload(payload){
    if(!payload) return null;
    const entries = {};
    const raw = payload.entries || {};
    DAYS.forEach(d=>{
      const row = raw[d] || {};
      entries[d] = { std:Number(row.std||0), ot:Number(row.ot||0), note:row.note||'' };
    });
    return {
      id: payload.id,
      status: payload.status || 'draft',
      week_ending: payload.week_ending,
      contractor_email: payload.contractor_email||payload.contractor?.email||'',
      assignment: payload.assignment || {},
      rates: {
        std: Number(payload?.assignment?.rate_std ?? payload?.rate_std ?? 0),
        ot:  Number(payload?.assignment?.rate_ot ?? payload?.rate_ot ?? 0)
      },
      entries
    };
  }

  async function openSheet(id){
    sheetBody.innerHTML = '<tr><td colspan="4" class="muted" style="background:var(--soft);border:1px solid var(--border)">Loadingâ€¦</td></tr>';
    openModal();
    try{
      const res = await api(FN_GET,'POST',{ id });
      setCachedDetail(id, res);
      CUR = curFromPayload(res);
      sheetTitle.textContent = `Timesheet #${CUR.id}`;
      sheetSub.textContent = `Week ending ${CUR.week_ending}`;
      sheetMeta.textContent = `${[CUR.assignment.client_name,CUR.assignment.project_name,CUR.assignment.site_name].filter(Boolean).join(' â€¢ ')}`;
      rateStd.textContent = `Rate: ${money(CUR.rates.std)}/h`; rateOT.textContent  = `Rate: ${money(CUR.rates.ot)}/h`;
      badgeForStatus(CUR.status); renderRows();
      addChip('sheet: live', true, `sheet-${id}`);
    }catch(e){
      const cached = getCachedDetail(id);
      if(cached){
        CUR = curFromPayload(cached);
        if(CUR){
          sheetTitle.textContent = `Timesheet #${CUR.id}`;
          sheetSub.textContent = `Week ending ${CUR.week_ending}`;
          sheetMeta.textContent = `${[CUR.assignment.client_name,CUR.assignment.project_name,CUR.assignment.site_name].filter(Boolean).join(' â€¢ ')}`;
          rateStd.textContent = `Rate: ${money(CUR.rates.std)}/h`; rateOT.textContent  = `Rate: ${money(CUR.rates.ot)}/h`;
          badgeForStatus(CUR.status); renderRows();
          toast('Live detail unavailable â€” showing cached copy', 'warn', 4800);
          addChip('sheet: cached', false, `sheet-${id}`);
          return;
        }
      }
      sheetBody.innerHTML='<tr><td colspan="4" class="muted" style="background:var(--soft);border:1px solid var(--border)">Failed to load timesheet.</td></tr>';
      toast('Failed to load timesheet: '+e.message, 'error');
      addChip('sheet: failed', false, `sheet-${id}`);
    }
  }

  function renderRows(){
    sheetBody.innerHTML = '';
    DAYS.forEach(d=>{
      const r = CUR.entries[d] || {std:0,ot:0,note:''};
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td style="background:var(--soft);border:1px solid var(--border)">${d}</td>
        <td style="background:var(--soft);border:1px solid var(--border)">
          <input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="std" value="${Number(r.std||0)}" aria-label="${d} standard hours" class="kbr">
        </td>
        <td style="background:var(--soft);border:1px solid var(--border)">
          <input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="ot" value="${Number(r.ot||0)}" aria-label="${d} overtime hours" class="kbr">
        </td>
        <td style="background:var(--soft);border:1px solid var(--border)">
          <textarea data-day="${d}" data-kind="note" placeholder="Optional noteâ€¦" class="kbr">${r.note||''}</textarea>
        </td>`;
      sheetBody.append(tr);
    });
    lockForStatus(CUR.status); sumHours();
  }

  sheetBody.addEventListener('input', ev=>{
    const t = ev.target; if(!t.dataset.day) return;
    const day=t.dataset.day, kind=t.dataset.kind;
    if(kind==='note'){ CUR.entries[day].note=t.value; }
    else{
      let v=t.value===''?0:Number(t.value); if(!Number.isFinite(v)) v=0; v=Math.max(0,Math.min(24,Math.round(v*4)/4));
      t.value=v; CUR.entries[day][kind]=v;
    }
    DIRTY=true; sumHours();
  });

  // Quick fills
  qfMonFri.onclick = ()=>{ ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ CUR.entries[d].std=8; CUR.entries[d].ot=0; }); ['Sun','Sat'].forEach(d=>{ CUR.entries[d]={std:0,ot:0,note:''}; }); renderRows(); DIRTY=true; };
  qfClear.onclick  = ()=>{ DAYS.forEach(d=> CUR.entries[d]={std:0,ot:0,note:''}); renderRows(); DIRTY=true; };
  qfStd.onclick    = ()=>{ const v = prompt('Set ALL standard hours to:', '8'); if(v!==null){ const n = Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].std=n); renderRows(); DIRTY=true; } };
  qfOT.onclick     = ()=>{ const v = prompt('Set ALL overtime hours to:', '0'); if(v!==null){ const n = Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].ot=n); renderRows(); DIRTY=true; } };

  // Modal actions
  btnCloseModal.onclick = closeModal;
  btnSave.onclick = async ()=>{ try{ await api(FN_EDIT,'POST',{ id: CUR.id, entries: CUR.entries }); toast('Saved'); DIRTY=false; await loadList(); }catch(e){ toast('Save failed: '+e.message,'error'); } };
  btnSubmit.onclick= async ()=>{ try{ await api(FN_EDIT,'POST',{ id: CUR.id, status: 'submitted' }); toast('Marked submitted'); CUR.status='submitted'; badgeForStatus(CUR.status); lockForStatus(CUR.status); await loadList(); }catch(e){ toast('Submit failed: '+e.message,'error'); } };
  btnApprove.onclick= async ()=>{ try{ await api(FN_APPROVE,'POST',{ id: CUR.id }); toast('Approved'); CUR.status='approved'; badgeForStatus(CUR.status); lockForStatus(CUR.status); await loadList(); await loadAudit(); }catch(e){ toast('Approve failed: '+e.message,'error'); } };
  btnReject.onclick= async ()=>{ const reason=prompt('Reason for rejection:',''); if(reason===null) return; try{ await api(FN_REJECT,'POST',{ id: CUR.id, reason }); toast('Rejected'); CUR.status='rejected'; badgeForStatus(CUR.status); lockForStatus(CUR.status); await loadList(); await loadAudit(); }catch(e){ toast('Reject failed: '+e.message,'error'); } };
  btnDelete.onclick= async ()=>{ if(!confirm('Delete this timesheet?')) return; try{ await api(FN_DELETE,'POST',{ id: CUR.id }); toast('Deleted'); closeModal(); await loadList(); await loadAudit(); }catch(e){ toast('Delete failed: '+e.message,'error'); } };

  // Create draft
  btnCreate.onclick = async ()=>{
    const aid = Number(createAssignmentId.value||0), we = createWeekEnding.value;
    if(!aid || !we){ toast('Provide Assignment ID and week ending','error'); return; }
    try{ const created = await api(FN_CREATE,'POST',{ assignment_id: aid, week_ending: we }); toast('Draft created (#'+(created?.id||'?')+')'); await loadList(); }
    catch(e){ toast('Create failed: '+e.message,'error'); }
  };

  // Reminders
  btnRunRemind.onclick = async ()=>{
    remindResult.textContent='Runningâ€¦';
    try{
      const res = await api(FN_REMIND,'POST',{ dryRun: chkRemindDry.checked!==false });
      remindResult.textContent = JSON.stringify(res,null,2);
      toast('Remind complete');
    }catch(e){ remindResult.textContent='Failed: '+e.message; toast('Remind failed: '+e.message,'error'); }
  };
  btnOverdue.onclick = ()=>{
    const overdue = FILTERED.filter(r=> r.status==='submitted' && daysSince(r.week_ending)>7 );
    alert(`${overdue.length} overdue approvals (submitted > 7 days):\n\n`+overdue.map(r=>`#${r.id} â€¢ ${r.contractor_email} â€¢ ${r.week_ending}`).join('\n'));
  };
  function daysSince(d){ const dt=new Date(d); return Math.floor((Date.now()-dt.getTime())/86400000); }

  // Export CSV
  function exportCsv(){
    const rows = FILTERED;
    if(!rows?.length){ toast('Nothing to export'); return; }
    const cols = ['id','week_ending','status','contractor_email','client_name','project_name','site_name','std','ot','rate_std','rate_ot'];
    const head = cols.join(',');
    const lines = rows.map(r => cols.map(k=>{ let v=r[k]; if(v==null) v=''; v=String(v).replace(/"/g,'""'); return `"${v}"`; }).join(','));
    const csv = [head, ...lines].join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=`timesheets_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
  }

  // Candidate import (CSV â†’ /admin-candidates-save)
  btnImport.onclick = async ()=>{
    const f=fileImport.files?.[0]; if(!f) return toast('Choose a CSV first','error');
    const text = await f.text(); const rows = text.split(/\r?\n/).filter(Boolean); if(rows.length<2) return toast('CSV empty','error');
    const head = rows.shift().split(',').map(s=>s.trim().toLowerCase());
    const idx = (k)=> head.indexOf(k);
    let ok=0, fail=0; importLog.textContent='';
    for(const line of rows){
      const cols = line.split(',');
      const payload = {
        first_name: cols[idx('first_name')]||'',
        last_name:  cols[idx('last_name')]||'',
        email:      cols[idx('email')]||'',
        phone:      cols[idx('phone')]||'',
        pay_type:   cols[idx('pay_type')]||'Umbrella',
        status:     cols[idx('status')]||'In progress'
      };
      try{ await api(FN_CAND_SAVE,'POST',payload); ok++; importLog.textContent+=`OK: ${payload.email}\n`; }
      catch(e){ fail++; importLog.textContent+=`ERR: ${payload.email} â€” ${e.message}\n`; }
    }
    toast(`Import complete â€” OK ${ok}, Failed ${fail}`);
  };

  // Refresh
  btnRefresh.onclick = loadList; btnCsv.onclick=exportCsv; btnToggleFilters.onclick=loadList;

  // Restore filters from cache
  try{ const f=JSON.parse(localStorage.getItem('hmj_ts_filters')||'{}'); if(f){ q.value=f.q||''; status.value=f.status||''; clientId.value=f.client_id||''; week.value=f.week||''; } }catch{}

  // Identity + diagnostics chips
  const diag = await identity();
  diagChips.innerHTML='';
  addChip('init: ok', true, 'init');
  if(!diag.ok){ addChip('identity: no session', false, 'identity'); document.querySelector('#gate').style.display='grid'; return; }
  addChip('identity: ok', true, 'identity');
  addChip(diag.token ? 'token: ok' : 'token: missing', !!diag.token, 'token');
  ROLE = diag.role || 'admin';
  roleView.value = ROLE;
  addChip('role: '+ROLE, true, 'role');

  // Load clients, audit, list
  await loadClients(); await loadAudit(); await loadList(); renderViews();

  // small mobile tweaks
  if(isMobile){ calendarWrap.style.display='none'; chartWrap.style.display='none'; }
}

document.addEventListener('DOMContentLoaded', () => {
  const start = () => Admin.bootAdmin(main);

  netlifyIdentity?.on('init', start);
  netlifyIdentity?.on('login', () => location.reload());
  netlifyIdentity?.on('logout', () => location.href = '/admin/');

  setTimeout(() => {
    if (netlifyIdentity?.currentUser()) start();
    else (document.querySelector('#gate') || {}).style.display = 'grid';
  }, 600);
});

/* Bootstrap via /admin/common.js */
</script>


<!-- Identity MUST load before common.js -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Shared admin bootstrap (pure JS file, no <script> tags inside) -->
<script defer src="/admin/common.js"></script>


</body>
</html>
