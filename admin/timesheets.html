<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets — Admin | HMJ-Global</title>
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script defer src="/admin/common.js"></script>
<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{--bg:#0b0f18;--panel:#111827;--border:#252f3f;--text:#e8eef7;--muted:#9fb0c9;--green:#25c08a;--red:#ff7a7a;--amber:#ffcc66}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:30}
  .row{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;gap:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  input,select,textarea{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  .btn.good{background:#1e2f26;border-color:#2b4f3a}
  .btn.bad{background:#3a1920;border-color:#602b36}
  .btn.warn{background:#3a331a;border-color:#5a4f2b}
  .pill{display:inline-block;border:1px solid #2c3853;background:#151f33;border-radius:999px;padding:4px 8px;font-size:.85rem}
  .rowbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .dialog{width:min(980px,95vw);background:#0f172a;border:1px solid var(--border);border-radius:16px;padding:16px}
  .section{background:#0e1524;border:1px solid #1f2a44;border-radius:12px;padding:12px;margin-top:10px}
  .grid2{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  @media (max-width:760px){ .grid2{grid-template-columns:1fr 1fr;gap:8px} }
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Timesheets — Admin</div>
  <div class="sp"></div>
  <a class="btn" href="/admin/">⟵ Admin home</a>
  <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
</div></div>

<div class="wrap" id="gate" style="display:none">
  <div class="card"><strong>Admin only.</strong> <p class="why muted"></p>
  <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button></div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="grid">
    <div class="card">
      <div class="rowbar" style="margin-bottom:8px">
        <input id="q" placeholder="Search contractor email or week (YYYY-MM-DD)"/>
        <select id="status"><option value="">Any status</option><option>draft</option><option>submitted</option><option>approved</option><option>rejected</option></select>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnCSV">Export CSV</button>
      </div>
      <div id="listWrap" class="muted">Loading…</div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">Raise on behalf</h3>
      <div class="rowbar">
        <input id="raiseAssignmentId" placeholder="Assignment ID"/>
        <input id="raiseWeek" type="date"/>
        <button class="btn good" id="btnRaise">Create empty timesheet</button>
        <div class="muted">Creates a draft; edit & submit/approve from the table.</div>
      </div>
      <div class="section">
        <h4 style="margin:0 0 8px">Audit (latest)</h4>
        <div id="auditWrap" class="muted">—</div>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal" id="modal">
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="dlgTitle" style="margin:0">Timesheet</h3>
      <div class="rowbar">
        <button class="btn warn" id="btnApprove">Approve</button>
        <button class="btn bad"  id="btnReject">Reject</button>
        <button class="btn" id="btnSave">Save</button>
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>
    <div id="dlgBody" class="section">Loading…</div>
  </div>
</div>

<div id="toast"></div>

<script>
async function main({ api, sel, toast, user }){
  const listWrap = sel('#listWrap');
  const auditWrap= sel('#auditWrap');
  const q=sel('#q'), st=sel('#status');

  async function loadList(){
    listWrap.textContent='Loading…';
    const rows = await api('/admin-timesheets-list','POST',{ q: q.value||'', status: st.value||'' });
    listWrap.innerHTML = `
      <table>
        <thead><tr><th>Week ending</th><th>Status</th><th>Contractor</th><th>Assignment</th><th>Std h</th><th>OT h</th><th></th></tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.week_ending}</td>
              <td><span class="pill">${r.status}</span></td>
              <td>${r.contractor_email||'—'}</td>
              <td>${r.assignment_id||'—'}</td>
              <td>${r.std||0}</td>
              <td>${r.ot||0}</td>
              <td><button class="btn" data-open="${r.id}">Open</button></td>
            </tr>`).join('')}
        </tbody>
      </table>`;
    listWrap.querySelectorAll('button[data-open]').forEach(b=> b.onclick=()=>openDlg(b.dataset.open));
  }

  async function loadAudit(){
    try{
      const items = await api('/admin-audit-list','POST',{ limit: 25 });
      auditWrap.innerHTML = items.map(x=>`<div class="muted" style="font-size:.9em">${x.created_at} — <b>${x.actor_email||'—'}</b> ${x.action} <i>${x.entity}</i> ${x.entity_id||''}</div>`).join('') || '—';
    }catch(e){ auditWrap.textContent='Audit unavailable'; }
  }

  sel('#btnRefresh').onclick = ()=>{ loadList(); loadAudit(); };
  sel('#btnCSV').onclick = async ()=>{
    const r = await api('/admin-timesheets-export','POST',{ status: st.value||'' });
    const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(r.csv||''); a.download='timesheets-export.csv'; a.click();
  };

  sel('#btnRaise').onclick = async ()=>{
    try{
      const aid = sel('#raiseAssignmentId').value.trim();
      const week= sel('#raiseWeek').value;
      if(!aid || !week){ toast('Enter assignment id and week'); return; }
      await api('/admin-timesheets-create','POST',{ assignment_id:Number(aid), week_ending: week });
      toast('Draft created'); loadList();
    }catch(e){ toast('Raise failed: '+e.message); }
  };

  // Modal open/edit
  let cur = null;
  const modal = sel('#modal'), body=sel('#dlgBody'), title=sel('#dlgTitle');
  function openModal(){ modal.style.display='flex'; }
  function closeModal(){ modal.style.display='none'; cur=null; }

  async function openDlg(id){
    openModal();
    title.textContent='Timesheet '+id;
    body.textContent='Loading…';
    try{
      cur = await api('/admin-timesheets-open','POST',{ id:Number(id) });
      renderDlg();
    }catch(e){ body.textContent='Open failed: '+e.message; }
  }

  function renderDlg(){
    if(!cur){ body.textContent='—'; return; }
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const rows = days.map(d=>{
      const r = (cur.entries||[]).find(x=>x.day===d)||{hours_std:0,hours_ot:0,note:''};
      return `<tr>
        <td>${d}</td>
        <td><input type="number" step="0.25" min="0" max="24" value="${r.hours_std||0}" data-day="${d}" data-k="std"></td>
        <td><input type="number" step="0.25" min="0" max="24" value="${r.hours_ot||0}" data-day="${d}" data-k="ot"></td>
        <td><input value="${(r.note||'').replace(/"/g,'&quot;')}" data-day="${d}" data-k="note"></td>
      </tr>`;
    }).join('');
    body.innerHTML = `
      <div class="section">
        <div class="rowbar" style="justify-content:space-between">
          <div>
            <b>Week ending:</b> ${cur.week_ending}
            <span class="pill" style="margin-left:6px">${cur.status}</span>
          </div>
          <div class="muted">Rate £${Number(cur.rate_std||0)} /h (OT £${Number(cur.rate_ot||0)})</div>
        </div>
        <table style="width:100%;margin-top:8px">
          <thead><tr><th>Day</th><th>Std</th><th>OT</th><th>Note</th></tr></thead>
          <tbody id="editBody">${rows}</tbody>
        </table>
      </div>`;
    body.querySelector('#editBody').addEventListener('input', ev=>{
      const t=ev.target; const d=t.dataset.day, k=t.dataset.k; if(!d||!k) return;
      let row = (cur.entries||[]).find(x=>x.day===d);
      if(!row){ row={day:d,hours_std:0,hours_ot:0,note:''}; cur.entries.push(row); }
      if(k==='note') row.note=t.value;
      else if(k==='std') row.hours_std = Math.max(0, Math.min(24, Math.round(Number(t.value||0)*4)/4));
      else if(k==='ot')  row.hours_ot  = Math.max(0, Math.min(24, Math.round(Number(t.value||0)*4)/4));
    });
  }

  sel('#btnClose').onclick = closeModal;
  sel('#btnSave').onclick  = async ()=>{
    try{
      await api('/admin-timesheets-save','POST',{ id:cur.id, entries: cur.entries });
      toast('Saved'); loadList();
    }catch(e){ toast('Save failed: '+e.message); }
  };
  sel('#btnApprove').onclick = async ()=>{
    try{ await api('/admin-timesheets-approve','POST',{ id:cur.id }); toast('Approved'); closeModal(); loadList(); }
    catch(e){ toast('Approve failed: '+e.message); }
  };
  sel('#btnReject').onclick = async ()=>{
    const reason = prompt('Reason for rejection:','');
    if(reason===null) return;
    try{ await api('/admin-timesheets-reject','POST',{ id:cur.id, reason }); toast('Rejected'); closeModal(); loadList(); }
    catch(e){ toast('Reject failed: '+e.message); }
  };

  // First load
  loadList(); loadAudit();
}
</script>
</body>
</html>
