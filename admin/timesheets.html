<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets — Admin | HMJ-Global</title>

<!-- Identity MUST load before common.js -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Shared admin bootstrap (pure JS file, no <script> tags inside) -->
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{--bg:#0b0f18;--panel:#111827;--border:#252f3f;--text:#e8eef7;--muted:#9fb0c9;--ink:#e8eef7;--accent:#3A66B3}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:5}
  .row{max-width:1280px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1280px;margin:20px auto 40px;padding:0 18px;display:grid;gap:16px;grid-template-columns: 1fr 360px}
  @media(max-width:1100px){ .wrap{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  .btn.good{background:#198754;border:0}
  .btn.warn{background:#e6a100;color:#1a1600;border:0}
  .btn.bad{background:#b73b3b;border:0}
  .btn.ghost{background:#0f172a;border:1px solid #2c3853}
  input,select,textarea{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .rightcol{display:grid;gap:16px}
  /* Modal */
  .backdrop{position:fixed;inset:0;background:rgba(9,12,20,.6);display:none;align-items:center;justify-content:center;z-index:10000}
  .backdrop.show{display:flex}
  .modal{width:min(980px,92vw);max-height:88vh;background:#0f172a;color:var(--ink);border:1px solid #25324a;border-radius:16px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.45)}
  .modal .hd{padding:12px 14px;border-bottom:1px solid #25324a;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .modal .bd{padding:14px;overflow:auto;max-height:70vh}
  .modal .ft{padding:12px 14px;border-top:1px solid #25324a;display:flex;gap:8px;justify-content:flex-end}
  .pill{display:inline-block;background:#0d1a31;border:1px solid #233044;border-radius:999px;padding:6px 10px;color:#cfe0ff;font-weight:700}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:720px){ .grid2{grid-template-columns:1fr} }
  .table-soft{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table-soft th{color:#8fa3c6;font-size:12px}
  .table-soft td{background:#0c1629;border:1px solid #233044}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2b3854;background:#101a33}
  .badge.draft{color:#9fb0c9}
  .badge.submitted{color:#f0d48f;border-color:#5b4a19;background:#2a2210}
  .badge.approved{color:#9cf0b2;border-color:#1f4a2f;background:#0e2418}
  .badge.rejected{color:#f6a7a7;border-color:#5b2b2b;background:#2a1010}
  .sr{position:absolute;left:-9999px}
</style>
</head>
<body>
<div class="top"><div class="row">
  <div class="brand">Timesheets — Admin</div><div class="sp"></div>
  <a class="btn" href="/admin/">⟵ Admin home</a>
  <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
</div></div>

<!-- GATE (not logged in / not admin) -->
<div class="wrap" id="gate" style="display:none;grid-template-columns:1fr">
  <div class="card"><strong>Admin only.</strong><p class="why muted"></p>
    <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <!-- left column -->
  <div class="card" style="display:grid;gap:16px">
    <div class="toolbar">
      <input id="q" placeholder="Search contractor email / client / project / site" style="min-width:260px"/>
      <select id="status">
        <option value="">Any status</option>
        <option value="draft">Draft</option>
        <option value="submitted">Submitted</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn ghost" id="btnCsv">Export CSV</button>
    </div>
    <div id="list">Loading…</div>
  </div>

  <!-- right column -->
  <div class="rightcol">
    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Raise on behalf</div>
      <div class="grid2">
        <label>Assignment ID
          <input id="createAssignmentId" inputmode="numeric" placeholder="e.g. 42"/>
        </label>
        <label>Week ending
          <input id="createWeekEnding" type="date"/>
        </label>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn good" id="btnCreate">Create empty timesheet</button>
      </div>
      <div class="muted" style="margin-top:8px">Creates a draft; edit & submit/approve from the table.</div>
    </div>

    <div class="card" id="auditCard">
      <div style="font-weight:800;margin-bottom:8px">Audit (latest)</div>
      <div id="auditBody" class="muted">Loading…</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="backdrop" id="sheetBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="hd">
      <div>
        <div id="sheetTitle" style="font-weight:800">Timesheet</div>
        <div id="sheetSub" class="muted" style="font-size:12px"></div>
      </div>
      <button class="btn" id="btnCloseModal" aria-label="Close">Close</button>
    </div>
    <div class="bd">
      <div id="sheetMeta" class="muted" style="margin-bottom:8px"></div>
      <table class="table-soft" aria-label="Per-day hours">
        <thead>
          <tr><th>Day</th><th>Std (h)</th><th>OT (h)</th><th>Note</th></tr>
        </thead>
        <tbody id="sheetBody"></tbody>
      </table>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0">
        <button class="btn ghost" id="qfMonFri">Mon–Fri 8h</button>
        <button class="btn ghost" id="qfClear">Clear all</button>
        <button class="btn ghost" id="qfStd">Set all std…</button>
        <button class="btn ghost" id="qfOT">Set all OT…</button>
      </div>

      <div class="grid2">
        <div class="card" style="background:#0c1629;border-color:#233044">
          <div><b>Standard</b></div>
          <div id="sumStd" class="pill" style="margin-top:6px">0h</div>
          <div id="rateStd" class="muted" style="margin-top:4px">Rate: £0.00/h</div>
        </div>
        <div class="card" style="background:#0c1629;border-color:#233044">
          <div><b>Overtime</b></div>
          <div id="sumOT" class="pill" style="margin-top:6px">0h</div>
          <div id="rateOT" class="muted" style="margin-top:4px">Rate: £0.00/h</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div><b>Estimated gross</b></div>
        <div id="sumGross" class="pill" style="margin-top:6px">£0.00</div>
      </div>
    </div>
    <div class="ft">
      <span id="statusBadge" class="badge draft" style="margin-right:auto">draft</span>
      <button class="btn"   id="btnSave">Save</button>
      <button class="btn warn" id="btnSubmit">Mark submitted</button>
      <button class="btn good" id="btnApprove">Approve</button>
      <button class="btn bad"  id="btnReject">Reject</button>
      <button class="btn bad"  id="btnDelete">Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* page logic – uses helpers injected by /admin/common.js */
async function main({ api, sel, toast }) {
  // ---- Function names (edit here if your filenames differ) ----
  const FN_LIST     = '/admin-timesheets-list';
  const FN_GET      = '/admin-timesheets-get';
  const FN_EDIT     = '/admin-timesheets-edit';
  const FN_APPROVE  = '/admin-timesheets-approve';
  const FN_REJECT   = '/admin-timesheets-reject';
  const FN_DELETE   = '/admin-timesheets-delete';
  const FN_CREATE   = '/admin-timesheets-create';
  const FN_AUDIT    = '/admin-audit-list';

  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const $ = (s)=>sel(s);
  const money = (n)=>Number(n||0).toLocaleString('en-GB',{style:'currency',currency:'GBP'});

  // ---- Elements ----
  const list = $('#list');
  const q = $('#q'); const status = $('#status');
  const btnRefresh = $('#btnRefresh'); const btnCsv = $('#btnCsv');
  const createAssignmentId = $('#createAssignmentId');
  const createWeekEnding = $('#createWeekEnding');
  const btnCreate = $('#btnCreate');
  const auditBody = $('#auditBody');

  // Modal pieces
  const backdrop = $('#sheetBackdrop');
  const sheetTitle = $('#sheetTitle'); const sheetSub = $('#sheetSub');
  const sheetMeta  = $('#sheetMeta');  const sheetBody = $('#sheetBody');
  const statusBadge = $('#statusBadge');
  const rateStd = $('#rateStd'); const rateOT = $('#rateOT');
  const sumStd  = $('#sumStd');  const sumOT  = $('#sumOT'); const sumGross = $('#sumGross');
  const btnCloseModal = $('#btnCloseModal');
  const btnSave = $('#btnSave'); const btnSubmit = $('#btnSubmit'); const btnApprove = $('#btnApprove');
  const btnReject = $('#btnReject'); const btnDelete = $('#btnDelete');
  const qfMonFri = $('#qfMonFri'); const qfClear = $('#qfClear'); const qfStd = $('#qfStd'); const qfOT = $('#qfOT');

  // ---- State ----
  let LIST = [];               // last list payload
  let CUR = null;              // current sheet { id, status, week_ending, entries, assignment, rates }
  let DIRTY = false;

  // ---- Helpers ----
  function badgeForStatus(s){
    statusBadge.textContent = s || '-';
    statusBadge.className = 'badge '+(s||'draft');
  }
  function lockForStatus(s){
    const locked = (s !== 'draft' && s !== 'rejected');
    // Disable inputs if locked
    sheetBody.querySelectorAll('input,textarea').forEach(i => i.disabled = locked);
    // Toggle buttons
    btnSave.disabled = locked;
    btnSubmit.disabled = locked;
    btnApprove.disabled = (s !== 'submitted');
    btnReject.disabled = (s !== 'submitted');
  }

  function sumHours(){
    const t = Object.values(CUR.entries||{}).reduce((a,r)=>({
      std: a.std + Number(r.std||0),
      ot:  a.ot  + Number(r.ot||0)
    }), {std:0, ot:0});
    sumStd.textContent = `${t.std}h`;
    sumOT.textContent  = `${t.ot}h`;
    const gross = t.std * Number(CUR?.rates?.std||0) + t.ot * Number(CUR?.rates?.ot||0);
    sumGross.textContent = money(gross);
  }

  function renderRows(){
    sheetBody.innerHTML = '';
    DAYS.forEach(d=>{
      const r = CUR.entries[d] || {std:0,ot:0,note:''};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="background:#0c1629;border:1px solid #233044">${d}</td>
        <td style="background:#0c1629;border:1px solid #233044">
          <input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="std" value="${Number(r.std||0)}" aria-label="${d} standard hours">
        </td>
        <td style="background:#0c1629;border:1px solid #233044">
          <input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="ot" value="${Number(r.ot||0)}" aria-label="${d} overtime hours">
        </td>
        <td style="background:#0c1629;border:1px solid #233044">
          <textarea data-day="${d}" data-kind="note" placeholder="Optional note…">${r.note||''}</textarea>
        </td>`;
      sheetBody.append(tr);
    });
    lockForStatus(CUR.status);
    sumHours();
  }

  // Input binding (delegate)
  sheetBody.addEventListener('input', ev=>{
    const t = ev.target; if(!t.dataset.day) return;
    const day = t.dataset.day, kind = t.dataset.kind;
    if(kind === 'note'){
      CUR.entries[day].note = t.value;
    } else {
      let v = t.value===''?0:Number(t.value);
      if(!Number.isFinite(v)) v = 0;
      v = Math.max(0, Math.min(24, Math.round(v*4)/4));
      t.value = v;
      CUR.entries[day][kind] = v;
    }
    DIRTY = true;
    sumHours();
  });

  // Quick fills
  qfMonFri.onclick = ()=>{ ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ CUR.entries[d].std=8; CUR.entries[d].ot=0; }); ['Sun','Sat'].forEach(d=>{ CUR.entries[d]={std:0,ot:0,note:''}; }); renderRows(); DIRTY=true; };
  qfClear.onclick  = ()=>{ DAYS.forEach(d=> CUR.entries[d]={std:0,ot:0,note:''}); renderRows(); DIRTY=true; };
  qfStd.onclick    = ()=>{ const v = prompt('Set ALL standard hours to:', '8'); if(v!==null){ const n = Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].std=n); renderRows(); DIRTY=true; } };
  qfOT.onclick     = ()=>{ const v = prompt('Set ALL overtime hours to:', '0'); if(v!==null){ const n = Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].ot=n); renderRows(); DIRTY=true; } };

  // ---- API-backed actions ----
  async function loadList(){
    list.textContent = 'Loading…';
    let rows = [];
    try{
      const res = await api(FN_LIST,'POST',{ q: q.value||'', status: status.value||'' });
      rows = Array.isArray(res) ? res : (res?.items || []);
    }catch(e){
      console.error(e); toast('List failed: '+e.message,'error');
      rows = [];
    }
    LIST = rows;

    if(!rows.length){ list.innerHTML = '<div class="muted">No timesheets match your filter.</div>'; return; }
    list.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Week ending</th><th>Status</th><th>Contractor</th><th>Client • Project • Site</th>
            <th>Std</th><th>OT</th><th>Gross (est.)</th><th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>{
            const gross = (Number(r.std||0)*Number(r.rate_std||0)) + (Number(r.ot||0)*Number(r.rate_ot||0));
            const badge = `<span class="badge ${r.status||'draft'}">${r.status||'draft'}</span>`;
            return `
              <tr>
                <td>${r.id}</td>
                <td>${r.week_ending||'-'}</td>
                <td>${badge}</td>
                <td>${r.contractor_email||'—'}</td>
                <td>${[r.client_name,r.project_name,r.site_name].filter(Boolean).join(' • ')||'—'}</td>
                <td>${r.std||0}</td>
                <td>${r.ot||0}</td>
                <td>${money(gross)}</td>
                <td><button class="btn" data-open="${r.id}">Open</button></td>
              </tr>`;
          }).join('')}
        </tbody>
      </table>
    `;
    list.querySelectorAll('button[data-open]').forEach(b => b.onclick = () => openSheet(Number(b.dataset.open)));
  }

  async function loadAudit(){
    try{
      const res = await api(FN_AUDIT,'POST',{ limit:8 });
      const items = Array.isArray(res) ? res : (res?.items||[]);
      if(!items.length){ auditBody.textContent = 'Audit unavailable'; return; }
      auditBody.innerHTML = items.map(i=>`
        <div style="padding:8px;border-bottom:1px solid #25324a">
          <div><b>${i.action||'-'}</b> • <span class="muted">${i.at||i.created_at||''}</span></div>
          <div class="muted" style="font-size:12px">${(i.actor||i.user_email||'')}</div>
          <div style="font-size:12px">${(i.summary||'').replace(/</g,'&lt;')}</div>
        </div>`).join('');
    }catch(e){
      auditBody.textContent = 'Audit unavailable';
    }
  }

  function openModal(){ backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
  function closeModal(){ if(DIRTY && CUR && CUR.status==='draft' && !confirm('Discard unsaved changes?')) return; backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); CUR=null; DIRTY=false; }

  async function openSheet(id){
    sheetBody.innerHTML = '<tr><td colspan="4" class="muted" style="background:#0c1629;border:1px solid #233044">Loading…</td></tr>';
    openModal();
    try{
      const res = await api(FN_GET,'POST',{ id });
      // Expecting: { id, week_ending, status, contractor_email, assignment:{client_name,project_name,site_name, rate_std, rate_ot}, entries:{Sun..Sat:{std,ot,note}} }
      CUR = {
        id: res.id,
        status: res.status || 'draft',
        week_ending: res.week_ending,
        contractor_email: res.contractor_email||res.contractor?.email||'',
        assignment: res.assignment||{},
        rates: {
          std: Number(res?.assignment?.rate_std||res?.rate_std||0),
          ot:  Number(res?.assignment?.rate_ot ||res?.rate_ot ||0)
        },
        entries: res.entries || Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}])),
      };

      sheetTitle.textContent = `Timesheet #${CUR.id}`;
      sheetSub.textContent = `Week ending ${CUR.week_ending}`;
      sheetMeta.textContent = `${[CUR.assignment.client_name,CUR.assignment.project_name,CUR.assignment.site_name].filter(Boolean).join(' • ')}`;
      rateStd.textContent = `Rate: ${money(CUR.rates.std)}/h`;
      rateOT.textContent  = `Rate: ${money(CUR.rates.ot)}/h`;
      badgeForStatus(CUR.status);
      renderRows();
    }catch(e){
      console.error(e);
      sheetBody.innerHTML = '<tr><td colspan="4" class="muted" style="background:#0c1629;border:1px solid #233044">Failed to load this timesheet.</td></tr>';
    }
  }

  async function saveCurrent(){
    if(!CUR) return;
    try{
      await api(FN_EDIT,'POST',{ id: CUR.id, entries: CUR.entries });
      toast('Saved'); DIRTY=false;
      await loadList();
    }catch(e){ toast('Save failed: '+e.message,'error'); }
  }

  async function setSubmitted(){
    if(!CUR) return;
    try{
      await api(FN_EDIT,'POST',{ id: CUR.id, status: 'submitted' });
      toast('Marked submitted');
      CUR.status = 'submitted'; badgeForStatus(CUR.status); lockForStatus(CUR.status); await loadList();
    }catch(e){ toast('Submit failed: '+e.message,'error'); }
  }

  async function approveCurrent(){
    if(!CUR) return;
    try{
      await api(FN_APPROVE,'POST',{ id: CUR.id });
      toast('Approved');
      CUR.status = 'approved'; badgeForStatus(CUR.status); lockForStatus(CUR.status); await loadList(); await loadAudit();
    }catch(e){ toast('Approve failed: '+e.message,'error'); }
  }

  async function rejectCurrent(){
    if(!CUR) return;
    const reason = prompt('Reason for rejection:','');
    if(reason===null) return;
    try{
      await api(FN_REJECT,'POST',{ id: CUR.id, reason });
      toast('Rejected');
      CUR.status = 'rejected'; badgeForStatus(CUR.status); lockForStatus(CUR.status); await loadList(); await loadAudit();
    }catch(e){ toast('Reject failed: '+e.message,'error'); }
  }

  async function deleteCurrent(){
    if(!CUR) return;
    if(!confirm('Delete this timesheet?')) return;
    try{
      await api(FN_DELETE,'POST',{ id: CUR.id });
      toast('Deleted');
      closeModal(); await loadList(); await loadAudit();
    }catch(e){ toast('Delete failed: '+e.message,'error'); }
  }

  async function createBlank(){
    const aid = Number(createAssignmentId.value||0);
    const we  = createWeekEnding.value;
    if(!aid || !we){ toast('Provide Assignment ID and week ending','error'); return; }
    try{
      const created = await api(FN_CREATE,'POST',{ assignment_id: aid, week_ending: we });
      toast('Draft created (#'+(created?.id||'?')+')'); await loadList();
    }catch(e){ toast('Create failed: '+e.message,'error'); }
  }

  function exportCsv(){
    const rows = LIST;
    if(!rows?.length){ toast('Nothing to export'); return; }
    const cols = ['id','week_ending','status','contractor_email','client_name','project_name','site_name','std','ot','rate_std','rate_ot'];
    const head = cols.join(',');
    const lines = rows.map(r => cols.map(k=>{
      let v = r[k]; if(v==null) v='';
      v = String(v).replace(/"/g,'""');
      return `"${v}"`;
    }).join(','));
    const csv = [head, ...lines].join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `timesheets_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ---- Wire UI ----
  btnRefresh.onclick = loadList;
  btnCsv.onclick = exportCsv;
  btnCreate.onclick = createBlank;
  btnCloseModal.onclick = closeModal;
  btnSave.onclick = saveCurrent;
  btnSubmit.onclick = setSubmitted;
  btnApprove.onclick = approveCurrent;
  btnReject.onclick = rejectCurrent;
  btnDelete.onclick = deleteCurrent;

  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadList(); });

  // Initial loads
  await loadList();
  await loadAudit();
}
</script>
</body>
</html>
