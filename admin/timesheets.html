<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets — Admin | HMJ-Global</title>

<!-- 1) Identity must load FIRST so tokens exist before any function calls -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- 2) Shared admin helpers (like on Candidates) -->
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{
    --bg:#0b0f18; --panel:#111827; --panel2:#0e1629; --border:#252f3f;
    --ink:#e8eef7; --text:#e8eef7; --muted:#9fb0c9; --accent:#3A66B3;
    --ok:#1f7e39; --warn:#a36b27; --bad:#7d3339;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:10}
  .row{max-width:1280px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}

  /* Debug / status strip (like Candidates admin) */
  .dbg{position:sticky;top:56px;z-index:9;background:#0e1629;border-bottom:1px dashed #2c3853}
  .dbg .row{padding:8px 18px}
  .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2c3853;background:#0f172a;margin-right:6px}
  .pill.ok{border-color:#2d6a46;background:#0d2418;color:#a1f0b8}
  .pill.warn{border-color:#8a5b25;background:#2a2210;color:#f0d48f}
  .pill.bad{border-color:#7d3339;background:#2a1010;color:#f6a7a7}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  .wrap{max-width:1280px;margin:18px auto 32px;padding:0 18px;display:grid;gap:16px;grid-template-columns:1fr 380px}
  @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  .btn.ghost{background:#0f172a;border:1px solid #2c3853}
  .btn.primary{background:var(--accent);border:0}
  .btn.good{background:#173b2a;border:1px solid #2b6a4c}
  .btn.warn{background:#2b2111;border:1px solid #8a5b25}
  .btn.bad{background:#3a1418;border:1px solid var(--bad)}
  input,select,textarea{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  thead th{position:sticky;top:0;background:#0d1426;z-index:1}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2b3854;background:#101a33}
  .badge.draft{color:#9fb0c9}
  .badge.submitted{color:#f0d48f;border-color:#5b4a19;background:#2a2210}
  .badge.approved{color:#9cf0b2;border-color:#1f4a2f;background:#0e2418}
  .badge.rejected{color:#f6a7a7;border-color:#5b2b2b;background:#2a1010}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:var(--panel2);border:1px solid #233044;border-radius:12px;padding:10px 12px}
  .kpi b{font-size:18px;display:block}
  .tableWrap{overflow:auto;border-radius:12px}
  .soft{background:var(--panel2);border:1px solid #233044;border-radius:12px;padding:12px}
  .sr{position:absolute;left:-9999px}

  /* Modal */
  .backdrop{position:fixed;inset:0;background:rgba(9,12,20,.6);display:none;align-items:center;justify-content:center;z-index:10000}
  .backdrop.show{display:flex}
  .modal{width:min(1040px,94vw);max-height:90vh;background:#0f172a;color:var(--ink);border:1px solid #25324a;border-radius:16px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.45)}
  .modal .hd{padding:12px 14px;border-bottom:1px solid #25324a;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .modal .bd{padding:14px;overflow:auto;max-height:68vh}
  .modal .ft{padding:12px 14px;border-top:1px solid #25324a;display:flex;gap:8px;justify-content:flex-end;align-items:center}
</style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">Timesheets — Admin</div><div class="sp"></div>
    <a class="btn" href="/admin/">⟵ Admin home</a>
    <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- DEBUG STRIP (progress + identity + trace) -->
  <div class="dbg"><div class="row mono" id="dbgRow">
    <span class="pill" id="dbgStep">init…</span>
    <span class="pill" id="dbgIdentity">identity: pending</span>
    <span class="pill" id="dbgToken">token: -</span>
    <span class="pill" id="dbgRole">role: -</span>
    <span class="pill" id="dbgTrace">trace: -</span>
    <span class="pill" id="dbgLast">last: -</span>
    <span class="sp"></span>
    <button class="btn ghost" id="btnDiag">Run diagnostics</button>
  </div></div>

  <!-- Gate (like Candidates admin) -->
  <div class="wrap" id="gate" style="display:none;grid-template-columns:1fr">
    <div class="card">
      <strong>Restricted.</strong>
      <p class="why muted" id="gateWhy">You need to sign in with an admin account.</p>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn primary" onclick="netlifyIdentity?.open('login')">Log in</button>
        <button class="btn" id="btnReload">Reload</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <!-- LEFT -->
    <div class="card" style="display:grid;gap:16px">
      <div class="toolbar" style="justify-content:space-between;align-items:flex-start">
        <div class="kpis">
          <div class="kpi"><b id="kTotal">0</b>Total</div>
          <div class="kpi"><b id="kFiltered">0</b>Filtered</div>
          <div class="kpi"><b id="kSelected">0</b>Selected</div>
        </div>
        <div class="toolbar">
          <button class="btn" id="btnRefresh" title="R">Refresh</button>
          <button class="btn good" id="btnBulkApprove" title="B">Bulk approve</button>
          <button class="btn" id="btnCsv" title="E">Export CSV</button>
        </div>
      </div>

      <div class="soft">
        <div class="toolbar" style="flex-wrap:wrap">
          <input id="q" placeholder="Search contractor / client / project / site" style="min-width:260px"/>
          <select id="status">
            <option value="">Any status</option>
            <option value="draft">Draft</option>
            <option value="submitted">Submitted</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <select id="client"><option value="">All clients</option></select>
          <input id="week" type="date" title="Week ending (Saturday)"/>
          <button class="btn" id="btnApply">Apply</button>
          <span class="muted" style="margin-left:6px">Shortcuts: <b>/</b> search · <b>R</b> refresh · <b>B</b> bulk approve · <b>E</b> export</span>
        </div>
      </div>

      <div id="list" class="tableWrap">Loading…</div>
      <div id="listError" class="soft" style="display:none;color:#f6a7a7;border-color:#7d3339;background:#2a1010"></div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="display:grid;gap:16px">
      <div>
        <div style="font-weight:800;margin-bottom:6px">Raise on behalf</div>
        <div class="grid2">
          <label>Assignment ID
            <input id="createAssignmentId" inputmode="numeric" placeholder="e.g. 42"/>
          </label>
          <label>Week ending
            <input id="createWeekEnding" type="date"/>
          </label>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn good" id="btnCreate">Create draft</button>
          <button class="btn ghost" id="btnOpenContractor">Open contractor</button>
        </div>
        <div class="muted" style="margin-top:6px">Creates a draft from assignment rates; edit & submit/approve afterwards.</div>
      </div>

      <div>
        <div style="font-weight:800;margin-bottom:6px">Audit (latest)</div>
        <div id="auditBody" class="soft muted">Loading…</div>
        <div id="auditError" class="soft" style="display:none;color:#f6a7a7;border-color:#7d3339;background:#2a1010"></div>
      </div>

      <!-- New Feature 1: Health panel -->
      <div>
        <div style="font-weight:800;margin-bottom:6px">Health</div>
        <div class="soft mono" id="healthBody">Running probes…</div>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn ghost" id="btnHealth">Re-run probes</button>
        </div>
      </div>

      <div>
        <div style="font-weight:800;margin-bottom:6px">Reminders & alerts</div>
        <div class="soft">
          <div class="toolbar" style="gap:12px;align-items:center">
            <label><input id="remindUnsubmitted" type="checkbox"/> Send reminder to contractors with unsubmitted sheets for last week</label>
            <button class="btn warn" id="btnRunReminder">Run now</button>
          </div>
          <div class="muted" style="margin-top:6px">This triggers a server task to email users with missing/submitted-late timesheets. Your <span class="mono">admin-timesheets-remind</span> function returns a recipient list.</div>
          <pre class="soft mono" id="remindOut" style="margin-top:8px;max-height:180px;overflow:auto"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="sheetBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="hd">
        <div>
          <div id="sheetTitle" style="font-weight:800">Timesheet</div>
          <div id="sheetSub" class="muted" style="font-size:12px"></div>
        </div>
        <button class="btn" id="btnCloseModal" aria-label="Close">Close</button>
      </div>
      <div class="bd">
        <div id="sheetMeta" class="muted" style="margin-bottom:8px"></div>

        <div class="grid2" style="margin-bottom:10px">
          <div class="soft">
            <div><b>Rates</b></div>
            <div id="rateStd" class="muted" style="margin-top:4px">Rate (std): £0.00/h</div>
            <div id="rateOT"  class="muted" style="margin-top:2px">Rate (OT): £0.00/h</div>
          </div>
          <div class="soft">
            <div><b>Compliance</b></div>
            <div id="cmpWeekly" class="pill">Weekly ≤ 72h</div>
            <div id="cmpDaily"  class="muted" style="margin-top:2px">Daily ≤ 16h, quarter steps</div>
          </div>
        </div>

        <table class="table" aria-label="Per-day hours" style="width:100%">
          <thead><tr><th>Day</th><th>Std (h)</th><th>OT (h)</th><th>Note</th></tr></thead>
          <tbody id="sheetBody"></tbody>
        </table>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0">
          <button class="btn ghost" id="qfMonFri">Mon–Fri 8h</button>
          <button class="btn ghost" id="qfClear">Clear all</button>
          <button class="btn ghost" id="qfStd">Set all std…</button>
          <button class="btn ghost" id="qfOT">Set all OT…</button>
        </div>

        <div class="grid2">
          <div class="soft"><div><b>Standard</b></div><div id="sumStd" class="pill" style="margin-top:6px">0h</div></div>
          <div class="soft"><div><b>Overtime</b></div><div id="sumOT" class="pill" style="margin-top:6px">0h</div></div>
        </div>

        <div style="margin-top:10px"><div><b>Estimated gross</b></div><div id="sumGross" class="pill" style="margin-top:6px">£0.00</div></div>
      </div>
      <div class="ft">
        <span id="statusBadge" class="badge draft" style="margin-right:auto">draft</span>
        <button class="btn"   id="btnSave">Save</button>
        <button class="btn warn" id="btnSubmit">Mark submitted</button>
        <button class="btn good" id="btnApprove">Approve</button>
        <button class="btn bad"  id="btnReject">Reject</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* ==========================================================
   Admin Timesheets — with deep diagnostics & identity-first boot
   ========================================================== */
(async ()=>{
  // ---------- Debug helpers (like Candidates admin, expanded) ----------
  const DEBUG = true;
  const TIMERS = {};
  const dbg = (label, data) => { if(!DEBUG) return; console.log('%c[TS-ADMIN]', 'color:#9fb0c9', label, data??''); };
  const start = (k)=>{ TIMERS[k]=performance.now(); };
  const end = (k,msg)=>{ if(!DEBUG) return; const t=((performance.now()-(TIMERS[k]||performance.now()))|0); console.log('%c[TS-ADMIN] '+(msg||k)+' – '+t+'ms','color:#8fe'); return t; };

  const pill = (id, text, state) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = text;
    el.className = 'pill'+(state?(' '+state):'');
  };
  const setTrace = (id) => pill('dbgTrace', id ? ('trace: '+id) : 'trace: -', id?'ok':'');

  // ---------- Toast (+ console) ----------
  const toasty = (msg, kind='info', extra={})=>{
    try{
      if(window.toast){ window.toast(msg, kind); }
      else {
        const div=document.createElement('div'); div.className='card'; div.textContent=msg;
        div.style.position='fixed';div.style.right='18px';div.style.bottom='18px';div.style.zIndex=99999;document.body.appendChild(div);
        setTimeout(()=>div.remove(),3000);
      }
    }catch{}
    if(DEBUG){ console[kind==='error'?'error':'log']('[Toast]', msg, extra); }
  };

  // ---------- Identity boot (robust) ----------
  const gate = async ()=>{
    const app = document.getElementById('app'), gate = document.getElementById('gate');
    const why = document.getElementById('gateWhy');

    // Wait for widget
    start('identity-init');
    for(let i=0;i<80;i++){
      if(window.netlifyIdentity && typeof netlifyIdentity.on==='function'){ break; }
      await new Promise(r=>setTimeout(r,100));
    }
    if(!window.netlifyIdentity){
      pill('dbgIdentity','identity: not loaded','bad');
      why.textContent='Netlify Identity widget failed to load.';
      gate.style.display=''; app.style.display='none';
      return null;
    }
    pill('dbgIdentity','identity: loaded','ok'); end('identity-init','identity widget loaded');

    // Try existing session
    const user = netlifyIdentity.currentUser();
    if(!user){
      pill('dbgIdentity','identity: no session','warn');
      why.textContent='Sign in required.';
      gate.style.display=''; app.style.display='none';
      return null;
    }

    // Get token with retries
    start('token');
    let token='', err=null;
    for(let i=0;i<4;i++){
      try{ token = await user.token?.({forceRefresh:i>0}); if(token) break; }catch(e){ err=e; }
      await new Promise(r=>setTimeout(r,150));
    }
    if(!token){
      pill('dbgToken','token: missing','bad');
      why.textContent='Could not obtain access token. Try signing out/in.';
      gate.style.display=''; app.style.display='none';
      dbg('token error', err);
      return null;
    }
    pill('dbgToken','token: ok','ok'); end('token','identity token retrieved');

    // Roles (if provided by your Identity/JWT)
    const roles = (user?.app_metadata?.roles)||[];
    pill('dbgRole','role: '+(roles.join('|')||'none'), roles.includes('admin')?'ok':'');
    app.style.display=''; gate.style.display='none';
    return { user, token, roles };
  };

  // ---------- API wrapper with tracing, retries, timing, surfacing errors ----------
  function makeTrace(){ return 'ts-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,7); }

  async function api(path, method='POST', body, opts={}){
    const trace = makeTrace(); setTrace(trace);
    const url = '/.netlify/functions'+path;
    const tKey = 'req:'+path+':'+trace; start(tKey);

    // Acquire token each time (so it refreshes if needed)
    const user = netlifyIdentity?.currentUser?.();
    let token=''; try{ token = user ? (await user.token?.()) : ''; }catch(e){ dbg('token fetch failed for call', e); }

    // Show a one-line request summary for quick triage (never log the token)
    dbg('API request', { path, method, hasToken: !!token, trace, body });

    const headers = Object.assign({ 'Content-Type':'application/json', 'X-HMJ-Trace': trace }, opts.headers||{});
    if(token) headers.Authorization = 'Bearer '+token;

    const exec = async ()=>{
      const res = await fetch(url, { method, headers, body: body?JSON.stringify(body):undefined, credentials:'include' });
      const txt = await res.text();
      let json; try{ json = txt ? JSON.parse(txt) : null; } catch { json = {raw:txt}; }
      if(!res.ok){
        const err = new Error((json&&json.error)||('HTTP '+res.status));
        err.status = res.status; err.json = json; err.trace = trace; throw err;
      }
      return { json, trace };
    };

    // light retry for 5xx / network
    let lastErr=null;
    for(let i=0;i<2;i++){
      try{
        const res = await exec();
        end(tKey, method+' '+path+' ['+res.trace+']');
        pill('dbgLast', 'last: '+path, 'ok');
        return res.json;
      }catch(e){
        lastErr = e;
        pill('dbgLast','last: '+path+' !','bad');
        dbg('API error', { path, status:e.status, trace:e.trace, err:e.message, payload:e.json });
        if(!e.status || e.status>=500){ await new Promise(r=>setTimeout(r,200)); continue; }
        throw e;
      }
    }
    throw lastErr;
  }

  document.getElementById('btnReload').onclick = ()=>location.reload();

  // ---------- Boot: Identity gate ----------
  const who = await gate();
  if(!who){
    // Attach listeners so logging improves as you sign in/out (like Candidates)
    netlifyIdentity?.on?.('login', ()=>location.reload());
    netlifyIdentity?.on?.('logout', ()=>location.reload());
    return;
  }

  // Short aliases
  const sel = (s,root=document)=>root.querySelector(s);
  const onKey = (code, fn)=> document.addEventListener('keydown', e=>{ if(code.length===1? e.key===code : e.code===code) fn(e); });

  // Elements
  const list  = sel('#list');
  const listError = sel('#listError');
  const q     = sel('#q');
  const status= sel('#status');
  const client= sel('#client');
  const week  = sel('#week');
  const kTotal= sel('#kTotal'), kFiltered= sel('#kFiltered'), kSelected= sel('#kSelected');

  const btnApply= sel('#btnApply'), btnRefresh= sel('#btnRefresh'), btnCsv= sel('#btnCsv'), btnBulkApprove= sel('#btnBulkApprove');

  const createAssignmentId= sel('#createAssignmentId'), createWeekEnding= sel('#createWeekEnding'), btnCreate= sel('#btnCreate'), btnOpenContractor= sel('#btnOpenContractor');

  const auditBody = sel('#auditBody'), auditError = sel('#auditError');
  const healthBody = sel('#healthBody');

  // Modal
  const backdrop = sel('#sheetBackdrop'), sheetBody = sel('#sheetBody'), sheetTitle = sel('#sheetTitle'), sheetSub = sel('#sheetSub'), sheetMeta = sel('#sheetMeta');
  const rateStd = sel('#rateStd'), rateOT = sel('#rateOT');
  const sumStd = sel('#sumStd'), sumOT = sel('#sumOT'), sumGross = sel('#sumGross');
  const cmpWeekly = sel('#cmpWeekly');
  const statusBadge = sel('#statusBadge');
  const btnCloseModal = sel('#btnCloseModal'), btnSave = sel('#btnSave'), btnSubmit = sel('#btnSubmit'), btnApprove = sel('#btnApprove'), btnReject = sel('#btnReject');

  // Endpoints
  const FN_LIST     = '/admin-timesheets-list';
  const FN_DETAIL   = '/admin-timesheets-detail';
  const FN_EDIT     = '/admin-timesheets-edit';
  const FN_APPROVE  = '/admin-timesheets-approve';
  const FN_REJECT   = '/admin-timesheet-reject'; // singular
  const FN_BULK_OK  = '/admin-timesheets-bulk-approve';
  const FN_CREATE   = '/admin-timesheets-create';
  const FN_EXPORT   = '/admin-timesheets-export';
  const FN_CLIENTS  = '/admin-timesheets-clients';
  const FN_AUDIT    = '/admin-audit-list';
  const FN_HEALTH   = '/supa-health';
  const FN_WHOAMI   = '/whoami';

  // State
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let LIST = []; let SELECTED = new Set(); let CUR = null;

  const money = (n)=>Number(n||0).toLocaleString('en-GB',{style:'currency',currency:'GBP'});
  const badgeForStatus=(s)=>{ statusBadge.textContent=s||'draft'; statusBadge.className='badge '+(s||'draft'); };

  // NEW FEATURE 2: Request queue for edits (retries later)
  const OfflineQueue = {
    items: [],
    push(task){ this.items.push(task); renderQueue(); },
    async runAll(){
      for(const t of this.items){
        try{ await t(); t.done=true; toasty('Queued action succeeded','info'); }
        catch(e){ toasty('Queued action failed again: '+e.message,'error'); }
      }
      this.items = this.items.filter(x=>!x.done); renderQueue();
    }
  };
  function renderQueue(){
    pill('dbgLast', `queue: ${OfflineQueue.items.length}`, OfflineQueue.items.length?'warn':'');
  }

  // Compliance
  function compliance(entries){
    let std=0, ot=0, ok=true, msg=[];
    DAYS.forEach(d=>{
      const r = entries[d]||{std:0,ot:0}; const day=r.std+r.ot;
      if(day>16){ ok=false; msg.push(`${d}>16h`); }
      if((r.std*4)%1 || (r.ot*4)%1){ ok=false; msg.push(`${d} not .25`); }
      std+=Number(r.std||0); ot+=Number(r.ot||0);
    });
    if(std+ot>72){ ok=false; msg.push('Week>72h'); }
    return { ok, std, ot, msg };
  }

  // Modal helpers
  function openModal(){ backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
  function closeModal(){ backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); CUR=null; }
  function renderRows(){
    sheetBody.innerHTML='';
    DAYS.forEach(d=>{
      const r = CUR.entries[d] || {std:0,ot:0,note:''};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d}</td>
        <td><input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="std" value="${Number(r.std||0)}"></td>
        <td><input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="ot"  value="${Number(r.ot||0)}"></td>
        <td><textarea data-day="${d}" data-kind="note" placeholder="Optional note…">${r.note||''}</textarea></td>`;
      sheetBody.append(tr);
    });
    sumUp();
  }
  function sumUp(){
    const t = compliance(CUR.entries);
    sumStd.textContent = `${t.std}h`; sumOT.textContent=`${t.ot}h`;
    cmpWeekly.textContent = t.ok ? 'Weekly ≤ 72h (OK)' : ('Issues: '+t.msg.join(', '));
    const gross = t.std*Number(CUR.rates.std||0) + t.ot*Number(CUR.rates.ot||0);
    sumGross.textContent = money(gross);
  }
  sheetBody.addEventListener('input', ev=>{
    const t = ev.target; if(!t.dataset.day) return;
    const d=t.dataset.day, k=t.dataset.kind;
    if(k==='note'){ CUR.entries[d].note=t.value; }
    else{
      let v=t.value===''?0:Number(t.value); if(!Number.isFinite(v)) v=0;
      v=Math.max(0,Math.min(24,Math.round(v*4)/4)); t.value=v;
      CUR.entries[d][k]=v;
    }
    sumUp();
  });
  // Quick fills
  document.getElementById('qfMonFri').onclick = ()=>{ ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ CUR.entries[d]={std:8,ot:0,note:CUR.entries[d]?.note||''}; }); ['Sun','Sat'].forEach(d=>{ CUR.entries[d]={std:0,ot:0,note:CUR.entries[d]?.note||''}; }); renderRows(); };
  document.getElementById('qfClear').onclick  = ()=>{ DAYS.forEach(d=> CUR.entries[d]={std:0,ot:0,note:''}); renderRows(); };
  document.getElementById('qfStd').onclick    = ()=>{ const v=prompt('Set ALL standard hours to:','8'); if(v!==null){ const n=Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].std=n); renderRows(); } };
  document.getElementById('qfOT').onclick     = ()=>{ const v=prompt('Set ALL overtime hours to:','0'); if(v!==null){ const n=Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].ot=n);  renderRows(); } };

  // Clients filter
  async function loadClients(){
    try{
      const data = await api(FN_CLIENTS,'GET');
      client.innerHTML = '<option value="">All clients</option>' + (data||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }catch(e){
      toasty('Clients load failed: '+e.message,'error');
      dbg('clients error', e);
    }
  }

  // List
  async function loadList(){
    listError.style.display='none'; list.textContent='Loading…'; SELECTED.clear(); kSelected.textContent='0';
    try{
      const res = await api(FN_LIST,'POST',{ q:q.value||'', status:status.value||'', client_id:client.value||null, week:week.value||null });
      LIST = Array.isArray(res) ? res : (res?.rows||res?.items||[]);
      kFiltered.textContent = String(LIST.length);
      if(!LIST.length){ list.innerHTML='<div class="muted" style="padding:10px">No timesheets match your filter.</div>'; kTotal.textContent='0'; return; }

      const head = `
        <thead><tr>
          <th style="width:32px"><input type="checkbox" id="ckAll"></th>
          <th>ID</th><th>Week ending</th><th>Status</th><th>Contractor</th><th>Client • Project • Site</th>
          <th>Std</th><th>OT</th><th>Gross (est.)</th><th></th>
        </tr></thead>`;
      const bodyHtml = LIST.map(r=>{
        const gross=(Number(r.std||0)*Number(r.rate_std||0)) + (Number(r.ot||0)*Number(r.rate_ot||0));
        const badge=`<span class="badge ${r.status||'draft'}">${r.status||'draft'}</span>`;
        return `
          <tr data-id="${r.id}">
            <td><input type="checkbox" class="ckRow"></td>
            <td>${r.id}</td>
            <td>${r.week_ending||'-'}</td>
            <td>${badge}</td>
            <td>${r.contractor_email||r.contractor_name||'—'}</td>
            <td>${[r.client_name,r.project_name,r.site_name].filter(Boolean).join(' • ')||'—'}</td>
            <td>${r.std||0}</td>
            <td>${r.ot||0}</td>
            <td>${money(gross)}</td>
            <td>
              <div class="toolbar">
                <button class="btn" data-open="${r.id}">Open</button>
                <button class="btn good" data-approve="${r.id}">Approve</button>
                <button class="btn bad" data-reject="${r.id}">Reject</button>
              </div>
            </td>
          </tr>`;
      }).join('');
      list.innerHTML = `<table>${head}<tbody>${bodyHtml}</tbody></table>`;

      list.querySelector('#ckAll').onchange = (e)=>{
        SELECTED.clear();
        list.querySelectorAll('.ckRow').forEach((c,i)=>{ c.checked=e.target.checked; if(c.checked) SELECTED.add(LIST[i].id); });
        kSelected.textContent=String(SELECTED.size);
      };
      list.querySelectorAll('.ckRow').forEach((c,i)=>{
        c.onchange=()=>{ const id=LIST[i].id; c.checked?SELECTED.add(id):SELECTED.delete(id); kSelected.textContent=String(SELECTED.size); };
      });
      list.querySelectorAll('button[data-open]').forEach(b=> b.onclick=()=> openSheet(Number(b.dataset.open)));
      list.querySelectorAll('button[data-approve]').forEach(b=> b.onclick=()=> approveOne(Number(b.dataset.approve)));
      list.querySelectorAll('button[data-reject]').forEach(b=> b.onclick=()=> rejectOne(Number(b.dataset.reject)));

      kTotal.textContent = String(LIST.length);
    }catch(e){
      listError.style.display=''; listError.textContent = `List failed: ${e.message} (trace in console)`;
      dbg('list failed', e);
      // Identity-specific helper
      if(String(e.message).includes('identity') || e.status===401){
        toasty('Identity token missing/invalid. Please sign in again.','error');
      }
    }
  }

  async function loadAudit(){
    try{
      const res = await api(FN_AUDIT,'POST',{limit:8});
      const items = Array.isArray(res)?res:(res?.items||[]);
      auditBody.innerHTML = items.map(i=>`
        <div style="padding:8px;border-bottom:1px solid #25324a">
          <div><b>${i.action||'-'}</b> • <span class="muted">${i.at||i.created_at||''}</span></div>
          <div class="muted" style="font-size:12px">${i.actor_email||i.actor||''}</div>
          <div style="font-size:12px">${(i.summary||'').toString().replace(/</g,'&lt;')}</div>
        </div>`).join('') || '<div class="muted">No recent audit events.</div>';
    }catch(e){
      auditError.style.display=''; auditError.textContent = 'Audit failed: '+e.message;
      dbg('audit failed', e);
    }
  }

  // Health probes (NEW FEATURE 1)
  async function runHealth(){
    const lines=[];
    const push=(txt,ok,t)=> lines.push(`<div class="pill ${ok?'ok':'bad'}">${txt}${t?` · ${t}ms`:''}</div>`);
    // Identity
    const u=netlifyIdentity?.currentUser?.();
    push('Identity: '+(u?'ok':'no session'), !!u);
    // whoami
    try{ start('whoami'); await api(FN_WHOAMI,'GET'); push('whoami: ok', true, end('whoami')); }catch(e){ push('whoami: '+e.message, false); }
    // supa-health
    try{ start('supa'); await api(FN_HEALTH,'GET'); push('supabase: ok', true, end('supa')); }catch(e){ push('supabase: '+e.message, false); }
    // list probe
    try{ start('listp'); await api(FN_LIST,'POST',{limit:1}); push('timesheets-list: ok', true, end('listp')); }catch(e){ push('timesheets-list: '+e.message, false); }
    healthBody.innerHTML = lines.join(' ');
  }

  // Detail open
  async function openSheet(id){
    openModal();
    sheetBody.innerHTML='<tr><td colspan="4" class="muted">Loading…</td></tr>';
    try{
      const res = await api(FN_DETAIL+'?'+new URLSearchParams({id}), 'GET');
      CUR = {
        id: res?.timesheet?.id || res?.id,
        status: res?.timesheet?.status || res?.status || 'draft',
        week_ending: res?.timesheet?.week_ending || res?.week_ending,
        assignment: res?.assignment || {},
        contractor: res?.contractor || {},
        rates: {
          std: Number(res?.rates?.std ?? res?.assignment?.rate_std ?? res?.rate_std ?? 0),
          ot:  Number(res?.rates?.ot  ?? res?.assignment?.rate_ot  ?? res?.rate_ot  ?? 0),
        },
        entries: (()=>{ 
          const e = res?.entries;
          if (Array.isArray(e)) {
            const by = {}; e.forEach(r=> by[r.day]= {std:Number(r.std||r.hours_std||0), ot:Number(r.ot||r.hours_ot||0), note:r.note||''});
            return Object.assign(Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}])), by);
          }
          return e || Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}]));
        })()
      };

      sheetTitle.textContent = `Timesheet #${CUR.id}`;
      sheetSub.textContent = `Week ending ${CUR.week_ending||'-'}`;
      sheetMeta.textContent = [CUR.assignment.client_name, CUR.assignment.project_name, CUR.assignment.site_name].filter(Boolean).join(' • ');
      rateStd.textContent = `Rate (std): ${money(CUR.rates.std)}/h`;
      rateOT.textContent  = `Rate (OT): ${money(CUR.rates.ot)}/h`;
      badgeForStatus(CUR.status);
      renderRows();
    }catch(e){
      sheetBody.innerHTML='<tr><td colspan="4" class="muted">Failed to load this timesheet.</td></tr>';
      toasty('Detail failed: '+e.message,'error'); dbg('detail failed', e);
    }
  }

  async function approveOne(id){
    try{ await api(FN_APPROVE,'POST',{id}); toasty('Approved'); await loadList(); await loadAudit(); if(CUR?.id===id){ CUR.status='approved'; badgeForStatus('approved'); } }
    catch(e){ toasty('Approve failed: '+e.message,'error'); dbg('approve failed', e); }
  }
  async function rejectOne(id){
    const reason = prompt('Reason for rejection:',''); if(reason===null) return;
    try{ await api(FN_REJECT,'POST',{id,reason}); toasty('Rejected'); await loadList(); await loadAudit(); if(CUR?.id===id){ CUR.status='rejected'; badgeForStatus('rejected'); } }
    catch(e){ toasty('Reject failed: '+e.message,'error'); dbg('reject failed', e); }
  }
  async function bulkApprove(){
    if(!SELECTED.size) return toasty('Select at least one row');
    if(!confirm(`Approve ${SELECTED.size} timesheet(s)?`)) return;
    try{ await api(FN_BULK_OK,'POST',{ ids:[...SELECTED] }); toasty('Bulk approved'); await loadList(); await loadAudit(); }
    catch(e){ toasty('Bulk approve failed: '+e.message,'error'); dbg('bulk failed', e); }
  }

  async function saveCurrent(){
    if(!CUR) return;
    const t = compliance(CUR.entries);
    if(!t.ok && !confirm('Compliance warnings: '+t.msg.join(', ')+' — Save anyway?')) return;
    const task = async ()=> api(FN_EDIT,'POST',{ id:CUR.id, entries:CUR.entries });
    try{ await task(); toasty('Saved'); await loadList(); }
    catch(e){
      toasty('Save failed: '+e.message,'error'); dbg('save failed', e);
      if(!e.status || e.status>=500){ OfflineQueue.push(task); toasty('Queued for retry (see debug strip)'); }
    }
  }
  async function setSubmitted(){
    if(!CUR) return;
    const task = async ()=> api(FN_EDIT,'POST',{ id:CUR.id, status:'submitted' });
    try{ await task(); toasty('Marked submitted'); CUR.status='submitted'; badgeForStatus('submitted'); await loadList(); await loadAudit(); }
    catch(e){
      toasty('Submit failed: '+e.message,'error'); dbg('submit failed', e);
      if(!e.status || e.status>=500){ OfflineQueue.push(task); toasty('Queued for retry'); }
    }
  }

  async function createBlank(){
    const aid = Number(createAssignmentId.value||0);
    const we  = createWeekEnding.value;
    if(!aid || !we){ return toasty('Provide Assignment ID and week ending','error'); }
    try{
      const created = await api(FN_CREATE,'POST',{ assignment_id:aid, week_ending:we });
      toasty('Draft created (#'+(created?.id||'?')+')'); await loadList();
    }catch(e){ toasty('Create failed: '+e.message,'error'); dbg('create failed', e); }
  }

  function exportCsv(){
    if(!LIST?.length) return toasty('Nothing to export');
    api(FN_EXPORT,'POST',{ q:q.value||'', status:status.value||'', client_id:client.value||null, week:week.value||null })
    .then(res=>{
      const blob=new Blob([res.csv||''],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`timesheets_${new Date().toISOString().slice(0,10)}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    })
    .catch(e=>{ toasty('Export failed: '+e.message,'error'); dbg('export failed', e); });
  }

  // Reminders (admin-timesheets-remind)
  async function runReminder(){
    const week_ending = week.value || undefined;
    try{
      const res = await api('/admin-timesheets-remind','POST',{ week_ending, dryRun:true });
      document.getElementById('remindOut').textContent = JSON.stringify(res, null, 2);
      toasty(`Reminder dry-run: ${res.count} recipients`);
    }catch(e){
      toasty('Reminder failed: '+e.message,'error'); dbg('remind failed', e);
    }
  }

  // Wire UI
  document.getElementById('btnDiag').onclick = async ()=>{ await runHealth(); await OfflineQueue.runAll(); };
  document.getElementById('btnHealth').onclick = runHealth;

  btnApply.onclick = loadList;
  btnRefresh.onclick = loadList;
  btnCsv.onclick = exportCsv;
  btnBulkApprove.onclick = bulkApprove;
  btnCreate.onclick = createBlank;
  btnOpenContractor.onclick = ()=>{
    const row = LIST.find(r=> SELECTED.has(r.id)) || LIST[0];
    if(!row || !row.contractor_email){ return toasty('Select a row with contractor'); }
    location.href = '/admin/candidates.html?q='+encodeURIComponent(row.contractor_email);
  };

  document.getElementById('btnCloseModal').onclick = closeModal;
  btnSave.onclick = saveCurrent;
  btnSubmit.onclick = setSubmitted;
  btnApprove.onclick = ()=> CUR && approveOne(CUR.id);
  btnReject.onclick  = ()=> CUR && rejectOne(CUR.id);
  document.getElementById('btnRunReminder').onclick = runReminder;

  // Shortcuts
  onKey('/', ()=> q.focus());
  onKey('KeyR', ()=> loadList());
  onKey('KeyB', ()=> bulkApprove());
  onKey('KeyE', ()=> exportCsv());

  // Initial loads (with visibility + debug)
  await runHealth();
  await (async()=>{ try{ await loadClients(); }catch(e){} })();
  await (async()=>{ try{ await loadAudit(); }catch(e){} })();
  await loadList();
})();
</script>
</body>
</html>
