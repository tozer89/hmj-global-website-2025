<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timesheets — Admin | HMJ-Global</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <style>
    body{background:#f6f8fb;color:#0b1a3a;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;min-height:100vh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid rgba(10,31,68,.1);box-shadow:0 1px 0 rgba(15,35,75,.05)}
    header .bar{display:flex;align-items:center;gap:12px;max-width:1400px;margin:0 auto;padding:14px 20px}
    header .brand{font-weight:700;font-size:18px;color:#162550}
    header .sp{flex:1}
    header .pill{border-radius:999px;padding:6px 10px;background:#eef2ff;color:#3a4b93;font-weight:600;font-size:13px}

    main{flex:1;max-width:1400px;width:100%;margin:0 auto;padding:20px;display:grid;gap:20px;grid-template-columns:minmax(0,1fr) 340px}
    @media (max-width:1100px){ main{grid-template-columns:1fr} }

    .panel{background:#fff;border-radius:16px;border:1px solid rgba(12,32,64,.08);box-shadow:0 14px 42px rgba(15,35,75,.08);padding:18px;display:flex;flex-direction:column;gap:16px}
    .panel h2{margin:0;font-size:18px}
    .panel h3{margin:0;font-size:16px}
    .panel .muted{color:#4f5d7a;font-size:13px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .toolbar button,.toolbar .btn{border-radius:12px;border:1px solid rgba(28,56,118,.18);background:#f4f6ff;color:#193078;font-weight:600;padding:8px 12px;font-size:13px;cursor:pointer}
    .toolbar .btn-primary{background:#193078;color:#fff;border:none}
    .toolbar .btn-secondary{background:#fff}
    .toolbar .counter{display:flex;align-items:center;gap:6px;background:#fff;padding:8px 12px;border-radius:12px;border:1px solid rgba(28,56,118,.16);font-weight:600;color:#193078}

    .filter-panel{display:grid;gap:12px;border-radius:14px;background:#f8f9fe;padding:14px;border:1px solid rgba(28,56,118,.08)}
    .filter-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    label.filter{display:flex;flex-direction:column;gap:6px;font-size:12px;color:#324164}
    .filter input,.filter select{border-radius:10px;border:1px solid rgba(31,55,110,.15);padding:8px 10px;font-size:14px}
    .filter input:focus,.filter select:focus{outline:none;box-shadow:0 0 0 3px rgba(25,48,120,.2)}

    .chipbar{display:flex;flex-wrap:wrap;gap:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#e6ebff;border:1px solid rgba(23,50,118,.18);font-size:12px;color:#152b6f}
    .chip .remove{cursor:pointer;background:none;border:none;color:inherit;font-weight:700}
    .chip.badge{background:#13245d;color:#fff;border-color:transparent}

    .table-shell{position:relative;border-radius:14px;border:1px solid rgba(12,32,64,.08);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    .table-header{display:grid;grid-template-columns:40px minmax(200px,1.2fr) repeat(6,minmax(100px,1fr));gap:0;background:#eef1fb;color:#162550;font-weight:600;font-size:13px;padding:12px 16px;position:sticky;top:0;z-index:5;border-bottom:1px solid rgba(12,32,64,.08)}
    .table-row{display:grid;grid-template-columns:40px minmax(200px,1.2fr) repeat(6,minmax(100px,1fr));gap:0;align-items:center;padding:10px 16px;border-bottom:1px solid rgba(12,32,64,.06);font-size:13px;color:#0b1a3a}
    .table-row[aria-selected="true"]{background:#f0f4ff}
    .table-row.invalid{background:#fff3f3}
    .table-row .row-actions{opacity:0;display:flex;gap:8px;justify-content:flex-end}
    .table-row:hover .row-actions{opacity:1}
    .status-pill{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;font-weight:600;font-size:11px}
    .status-draft{background:#dbe1f1;color:#1b2d5a}
    .status-submitted{background:#e2d8ff;color:#3f1c8d}
    .status-approved{background:#daf1de;color:#185226}
    .status-rejected{background:#ffd7d7;color:#821b1b}
    .table-viewport{max-height:520px;overflow:auto}
    .table-placeholder{padding:24px;text-align:center;color:#4f5d7a;font-size:14px}
    .totals-bar{display:flex;gap:16px;justify-content:flex-end;padding:12px 16px;background:#f6f9ff;border-top:1px solid rgba(12,32,64,.08);font-weight:600;font-size:13px}

    .hours-input{width:70px;border-radius:8px;border:1px solid rgba(31,55,110,.18);padding:6px 8px;font-size:13px}
    .hours-input:disabled{background:#f1f4fb;color:#6b7898}

    .bulk-bar{position:sticky;bottom:0;margin-top:auto;display:none;background:#13245d;color:#fff;padding:14px;border-radius:12px;align-items:center;gap:12px;flex-wrap:wrap}
    .bulk-bar button{background:#fff;color:#13245d;border:none;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}

    aside.panel{position:relative}
    .aside-section{display:flex;flex-direction:column;gap:10px}
    .aside-section hr{border:none;border-top:1px solid rgba(15,35,80,.08);margin:6px 0}
    .audit-list{max-height:220px;overflow:auto;border-radius:12px;border:1px solid rgba(18,40,90,.08);padding:10px;background:#f9fbff;font-size:12px;color:#2f3d60}

    dialog{border:none;border-radius:16px;padding:0;max-width:900px;width:min(96vw,900px);box-shadow:0 28px 60px rgba(15,35,80,.28)}
    dialog::backdrop{background:rgba(10,16,30,.55)}
    dialog .modal-shell{padding:20px;display:flex;flex-direction:column;gap:16px}
    dialog h2{margin:0;font-size:18px}
    dialog canvas{background:#fff;border-radius:12px;border:1px solid rgba(12,32,64,.08)}

    .toast-zone{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:10px;z-index:90}
    .toast{background:#13245d;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 14px 40px rgba(15,35,80,.25);font-size:13px;min-width:220px}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">Timesheets Console</div>
      <div class="pill" id="debugIdentity" aria-live="polite">offline</div>
      <div class="sp"></div>
      <button type="button" class="btn" id="btnSignOut">Sign out</button>
    </div>
  </header>
  <main id="timesheets-app" aria-live="polite">
    <section class="panel" id="mainPanel">
      <div class="toolbar" id="weekToolbar" role="toolbar" aria-label="Week navigation">
        <button type="button" class="btn" id="weekPrev" aria-label="Previous week">« Prev week</button>
        <button type="button" class="btn" id="weekNext" aria-label="Next week">Next week »</button>
        <button type="button" class="btn-primary" id="weekCurrent">This week</button>
        <div class="counter" id="weekLabel">Week ending –</div>
        <div class="counter" id="summaryTotal">Total: 0</div>
        <div class="counter" id="summaryFiltered">Filtered: 0</div>
        <div class="counter" id="summarySelected">Selected: 0</div>
        <button type="button" class="btn-secondary" id="refreshButton" title="Reload (R)">Refresh</button>
        <button type="button" class="btn-secondary" id="toggleFilters">Filters</button>
        <button type="button" class="btn-secondary" id="calendarButton">Calendar</button>
        <button type="button" class="btn-secondary" id="chartsButton">Charts</button>
        <button type="button" class="btn-secondary" id="debugButton">Debug</button>
      </div>

      <div class="filter-panel" id="filters" aria-expanded="true">
        <div class="toolbar" style="justify-content:space-between">
          <label class="filter" style="flex:1">
            <span>Quick search</span>
            <input id="filterSearch" type="search" placeholder="Search contractor, client, site" aria-label="Quick search" />
          </label>
          <button type="button" class="btn-secondary" id="clearFilters">Clear all</button>
        </div>
        <div class="filter-grid">
          <label class="filter">Status
            <select id="filterStatus">
              <option value="">Any</option>
              <option value="draft">Draft</option>
              <option value="submitted">Submitted</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </label>
          <label class="filter">Contractor
            <select id="filterContractor"></select>
          </label>
          <label class="filter">Client
            <select id="filterClient"></select>
          </label>
          <label class="filter">Project / Site
            <select id="filterSite"></select>
          </label>
          <label class="filter">Role
            <select id="filterRole"></select>
          </label>
          <label class="filter">Approver
            <select id="filterApprover"></select>
          </label>
          <label class="filter">Week ending from
            <input id="filterWeekFrom" type="date" />
          </label>
          <label class="filter">Week ending to
            <input id="filterWeekTo" type="date" />
          </label>
          <label class="filter">Week number
            <input id="filterWeekNumber" type="number" min="1" />
          </label>
          <label class="filter">Missing entries
            <select id="filterMissing">
              <option value="">Any</option>
              <option value="missing">Missing hours</option>
            </select>
          </label>
        </div>
        <div class="chipbar" id="filterChips" aria-live="polite"></div>
        <div class="chip badge" id="filteredBadge" aria-live="polite">Filtered: 0</div>
      </div>

      <div class="table-shell" aria-label="Timesheets table">
        <div class="table-header" role="row">
          <div><input type="checkbox" id="selectAll" aria-label="Select all" /></div>
          <div>Assignment</div>
          <div>Status</div>
          <div>Contractor</div>
          <div>Client</div>
          <div>Std (h)</div>
          <div>OT (h)</div>
          <div>Gross (£)</div>
          <div>Week ending</div>
        </div>
        <div class="table-viewport" id="tableViewport">
          <div class="table-placeholder" id="tablePlaceholder">Loading…</div>
          <div id="tableInner" role="rowgroup"></div>
        </div>
        <div class="totals-bar" id="totalsBar">
          <div>Std: <span id="totalsStd">0</span></div>
          <div>OT: <span id="totalsOt">0</span></div>
          <div>Gross: <span id="totalsGross">£0.00</span></div>
        </div>
      </div>

      <div class="bulk-bar" id="bulkBar" role="region" aria-live="polite">
        <div id="bulkCount">0 selected</div>
        <button type="button" id="bulkApprove">Approve</button>
        <button type="button" id="bulkReject">Reject</button>
        <button type="button" id="bulkExportCsv">Export CSV</button>
        <button type="button" id="bulkExportXlsx">Export XLSX</button>
        <button type="button" id="bulkRemind">Email reminders</button>
        <button type="button" id="bulkDelete">Delete drafts</button>
      </div>
    </section>

    <aside class="panel" id="sidePanel">
      <div class="aside-section" aria-labelledby="createHeading">
        <h2 id="createHeading">Create draft</h2>
        <label class="filter">Assignment ID
          <input id="createAssignment" type="text" inputmode="numeric" />
        </label>
        <label class="filter">Week ending
          <input id="createWeek" type="date" />
        </label>
        <button type="button" class="btn-primary" id="createButton">Create draft</button>
        <div class="muted" id="createHint">Creates a draft with 7 entries.</div>
      </div>
      <hr />
      <div class="aside-section" aria-labelledby="csvHeading">
        <h2 id="csvHeading">CSV import</h2>
        <input id="csvInput" type="file" accept=".csv" />
        <div class="muted">Columns: assignment_id, week_ending, h_mon…h_sun, ot_hours, notes</div>
        <div class="chipbar" id="csvActions">
          <button type="button" class="btn-secondary" id="csvDryRun">Dry-run</button>
          <button type="button" class="btn-secondary" id="csvImport">Import</button>
        </div>
        <div class="muted" id="csvPreview" aria-live="polite"></div>
      </div>
      <hr />
      <div class="aside-section" aria-labelledby="reminderHeading">
        <h2 id="reminderHeading">Reminders</h2>
        <button type="button" class="btn-secondary" id="reminderButton">Send reminder for last week</button>
        <div class="muted" id="reminderPreview" aria-live="polite"></div>
      </div>
      <hr />
      <div class="aside-section" aria-labelledby="auditHeading">
        <h2 id="auditHeading">Audit</h2>
        <div class="audit-list" id="auditList" role="log"></div>
      </div>
      <hr />
      <div class="aside-section" aria-labelledby="debugHeading">
        <h2 id="debugHeading">Debug</h2>
        <div class="muted">Identity: <span id="debugIdentityDetail">offline</span></div>
        <div class="muted">Trace: <span id="debugTrace">–</span></div>
        <div class="muted">Status: <span id="debugStatus">offline</span></div>
        <button type="button" class="btn-secondary" id="debugExport">Export logs</button>
      </div>
    </aside>
  </main>

  <dialog id="calendarModal" aria-labelledby="calendarHeading">
    <div class="modal-shell">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="calendarHeading">Calendar view</h2>
        <button type="button" class="btn-secondary" data-close="calendarModal">Close</button>
      </div>
      <div id="calendarGrid" role="grid"></div>
    </div>
  </dialog>

  <dialog id="chartsModal" aria-labelledby="chartsHeading">
    <div class="modal-shell">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="chartsHeading">Charts</h2>
        <button type="button" class="btn-secondary" data-close="chartsModal">Close</button>
      </div>
      <canvas id="chartClient" width="760" height="280" role="img" aria-label="Hours per client"></canvas>
      <canvas id="chartTrend" width="760" height="280" role="img" aria-label="Submitted vs approved"></canvas>
      <canvas id="chartStatus" width="760" height="280" role="img" aria-label="Status distribution"></canvas>
    </div>
  </dialog>

  <div class="toast-zone" id="toastZone" aria-live="assertive"></div>

  <script src="/admin/timesheets.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.createTimesheetsApp) {
        window.__timesheetsApp = window.createTimesheetsApp(document);
      }
    });
  </script>
</body>
</html>
