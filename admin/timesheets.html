<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timesheets — Admin | HMJ-Global</title>

<!-- Identity must load first -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<!-- Your shared bootstrap helpers (login gate, api fetcher, toasts, etc.) -->
<script defer src="/admin/common.js"></script>

<link rel="stylesheet" href="/css/style.css"/>
<style>
  :root{
    --bg:#0b0f18; --panel:#111827; --panel2:#0e1629; --border:#252f3f;
    --ink:#e8eef7; --text:#e8eef7; --muted:#9fb0c9; --accent:#3A66B3;
    --ok:#1f7e39; --warn:#a36b27; --bad:#7d3339;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .top{position:sticky;top:0;background:#0c1222;border-bottom:1px solid var(--border);z-index:10}
  .row{max-width:1280px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}.sp{flex:1}
  .wrap{max-width:1280px;margin:18px auto 32px;padding:0 18px;display:grid;gap:16px;grid-template-columns:1fr 360px}
  @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .btn{background:#1a2238;border:1px solid #2c3853;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#3b4f79}
  .btn.ghost{background:#0f172a;border:1px solid #2c3853}
  .btn.primary{background:var(--accent);border:0}
  .btn.good{background:#173b2a;border:1px solid #2b6a4c}
  .btn.warn{background:#2b2111;border:1px solid #8a5b25}
  .btn.bad{background:#3a1418;border:1px solid var(--bad)}
  input,select,textarea{background:#0f172a;color:#e6eef7;border:1px solid #2c3853;border-radius:10px;padding:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  thead th{position:sticky;top:0;background:#0d1426;z-index:1}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2b3854;background:#101a33}
  .badge.draft{color:#9fb0c9}
  .badge.submitted{color:#f0d48f;border-color:#5b4a19;background:#2a2210}
  .badge.approved{color:#9cf0b2;border-color:#1f4a2f;background:#0e2418}
  .badge.rejected{color:#f6a7a7;border-color:#5b2b2b;background:#2a1010}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:var(--panel2);border:1px solid #233044;border-radius:12px;padding:10px 12px}
  .kpi b{font-size:18px;display:block}
  .tableWrap{overflow:auto;border-radius:12px}
  .soft{background:var(--panel2);border:1px solid #233044;border-radius:12px;padding:12px}
  /* Modal / Drawer */
  .backdrop{position:fixed;inset:0;background:rgba(9,12,20,.6);display:none;align-items:center;justify-content:center;z-index:10000}
  .backdrop.show{display:flex}
  .modal{width:min(1000px,94vw);max-height:90vh;background:#0f172a;color:var(--ink);border:1px solid #25324a;border-radius:16px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.45)}
  .modal .hd{padding:12px 14px;border-bottom:1px solid #25324a;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .modal .bd{padding:14px;overflow:auto;max-height:68vh}
  .modal .ft{padding:12px 14px;border-top:1px solid #25324a;display:flex;gap:8px;justify-content:flex-end;align-items:center}
  .pill{display:inline-block;background:#0d1a31;border:1px solid #233044;border-radius:999px;padding:6px 10px;color:#cfe0ff;font-weight:700}
  .sr{position:absolute;left:-9999px}
</style>
</head>
<body>
  <div class="top"><div class="row">
    <div class="brand">Timesheets — Admin</div><div class="sp"></div>
    <a class="btn" href="/admin/">⟵ Admin home</a>
    <button class="btn" onclick="netlifyIdentity?.logout()">Sign out</button>
  </div></div>

  <!-- Gate (not logged in / not allowed) -->
  <div class="wrap" id="gate" style="display:none;grid-template-columns:1fr">
    <div class="card"><strong>Restricted.</strong>
      <p class="why muted"></p>
      <button class="btn" onclick="netlifyIdentity?.open('login')">Log in</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <!-- LEFT: filters + list -->
    <div class="card" style="display:grid;gap:16px">
      <div class="toolbar" style="justify-content:space-between;align-items:flex-start">
        <div class="kpis">
          <div class="kpi"><b id="kTotal">0</b>Total</div>
          <div class="kpi"><b id="kFiltered">0</b>Filtered</div>
          <div class="kpi"><b id="kSelected">0</b>Selected</div>
        </div>
        <div class="toolbar">
          <button class="btn" id="btnRefresh" title="R">Refresh</button>
          <button class="btn good" id="btnBulkApprove" title="B">Bulk approve</button>
          <button class="btn" id="btnCsv" title="E">Export CSV</button>
        </div>
      </div>

      <div class="soft">
        <div class="toolbar" style="flex-wrap:wrap">
          <input id="q" placeholder="Search contractor / client / project / site" style="min-width:260px"/>
          <select id="status">
            <option value="">Any status</option>
            <option value="draft">Draft</option>
            <option value="submitted">Submitted</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <select id="client"><option value="">All clients</option></select>
          <input id="week" type="date" title="Week ending (Saturday)"/>
          <button class="btn" id="btnApply">Apply</button>
          <span class="muted" style="margin-left:6px">Shortcuts: <b>/</b> search · <b>R</b> refresh · <b>B</b> bulk approve · <b>E</b> export</span>
        </div>
      </div>

      <div id="list" class="tableWrap">Loading…</div>
    </div>

    <!-- RIGHT: actions, create, audit, reminders -->
    <div class="card" style="display:grid;gap:16px">
      <div>
        <div style="font-weight:800;margin-bottom:6px">Raise on behalf</div>
        <div class="grid2">
          <label>Assignment ID
            <input id="createAssignmentId" inputmode="numeric" placeholder="e.g. 42"/>
          </label>
          <label>Week ending
            <input id="createWeekEnding" type="date"/>
          </label>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn good" id="btnCreate">Create draft</button>
          <button class="btn ghost" id="btnOpenContractor" title="Opens contractor profile if available">Open contractor</button>
        </div>
        <div class="muted" style="margin-top:6px">Creates a draft from assignment rates; edit & submit/approve afterwards.</div>
      </div>

      <div>
        <div style="font-weight:800;margin-bottom:6px">Audit (latest)</div>
        <div id="auditBody" class="soft muted">Loading…</div>
      </div>

      <div>
        <div style="font-weight:800;margin-bottom:6px">Reminders & alerts</div>
        <div class="soft">
          <div class="toolbar" style="gap:12px;align-items:center">
            <label><input id="remindUnsubmitted" type="checkbox"/> Send reminder to contractors with unsubmitted sheets for last week</label>
            <button class="btn warn" id="btnRunReminder" title="Triggers reminder job">Run now</button>
          </div>
          <div class="muted" style="margin-top:6px">This triggers a server task (endpoint to be added) to email users with missing/submitted-late timesheets. UI is wired; add a function when ready.</div>
        </div>
      </div>

      <div>
        <div style="font-weight:800;margin-bottom:6px">Help</div>
        <div class="soft">
          <div class="muted">Approvals lock editing. Use “Mark submitted” for sheets created on behalf.</div>
          <div class="muted" style="margin-top:6px"><a href="/admin/reports.html">Reports</a> • <a href="/admin/clients.html">Clients</a> • <a href="/admin/assignments.html">Assignments</a></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="sheetBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="hd">
        <div>
          <div id="sheetTitle" style="font-weight:800">Timesheet</div>
          <div id="sheetSub" class="muted" style="font-size:12px"></div>
        </div>
        <button class="btn" id="btnCloseModal" aria-label="Close">Close</button>
      </div>
      <div class="bd">
        <div id="sheetMeta" class="muted" style="margin-bottom:8px"></div>

        <div class="grid2" style="margin-bottom:10px">
          <div class="soft">
            <div><b>Rates</b></div>
            <div id="rateStd" class="muted" style="margin-top:4px">Rate (std): £0.00/h</div>
            <div id="rateOT"  class="muted" style="margin-top:2px">Rate (OT): £0.00/h</div>
          </div>
          <div class="soft">
            <div><b>Compliance</b></div>
            <div id="cmpWeekly" class="pill" style="margin-top:6px">Weekly ≤ 72h</div>
            <div id="cmpDaily"  class="muted" style="margin-top:2px">Daily ≤ 16h, quarter steps</div>
          </div>
        </div>

        <table class="table" aria-label="Per-day hours" style="width:100%">
          <thead>
            <tr><th>Day</th><th>Std (h)</th><th>OT (h)</th><th>Note</th></tr>
          </thead>
          <tbody id="sheetBody"></tbody>
        </table>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0">
          <button class="btn ghost" id="qfMonFri">Mon–Fri 8h</button>
          <button class="btn ghost" id="qfClear">Clear all</button>
          <button class="btn ghost" id="qfStd">Set all std…</button>
          <button class="btn ghost" id="qfOT">Set all OT…</button>
        </div>

        <div class="grid2">
          <div class="soft">
            <div><b>Standard</b></div>
            <div id="sumStd" class="pill" style="margin-top:6px">0h</div>
          </div>
          <div class="soft">
            <div><b>Overtime</b></div>
            <div id="sumOT" class="pill" style="margin-top:6px">0h</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div><b>Estimated gross</b></div>
          <div id="sumGross" class="pill" style="margin-top:6px">£0.00</div>
        </div>
      </div>
      <div class="ft">
        <span id="statusBadge" class="badge draft" style="margin-right:auto">draft</span>
        <button class="btn"   id="btnSave">Save</button>
        <button class="btn warn" id="btnSubmit">Mark submitted</button>
        <button class="btn good" id="btnApprove">Approve</button>
        <button class="btn bad"  id="btnReject">Reject</button>
        <!-- Delete hidden (no backend yet)
        <button class="btn bad"  id="btnDelete">Delete</button> -->
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* === Page logic — relies on helpers from /admin/common.js (adminReady, api, toast, sel, etc.) === */
(async ()=>{
  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
  async function ready(){
    for(let i=0;i<80;i++){ if(window.adminReady){ try{ const h=await window.adminReady(); if(h) return h; }catch{} } await sleep(100); }
    // Fallback helpers if common.js is unavailable
    const sel=(s,root=document)=>root.querySelector(s);
    const toast=(m)=>{ console.log(m); };
    async function api(path,method='POST',body){
      const url='/.netlify/functions'+path;
      let token=''; try{const u=netlifyIdentity?.currentUser?.(); token=u?(await u.token?.()):'';}catch{}
      const headers={'Content-Type':'application/json'}; if(token) headers.Authorization='Bearer '+token;
      const res=await fetch(url,{method,headers,body:body?JSON.stringify(body):undefined});
      const txt=await res.text(); let json; try{json=txt?JSON.parse(txt):null;}catch{json={raw:txt};}
      if(!res.ok) throw new Error(json?.error||('HTTP '+res.status)); return json;
    }
    async function gate(){ const u=netlifyIdentity?.currentUser?.(); if(u){ document.getElementById('app').style.display=''; document.getElementById('gate').style.display='none'; return { email:u.email, roles:(u?.app_metadata?.roles)||[] }; } document.getElementById('app').style.display='none'; document.getElementById('gate').style.display=''; return null; }
    function onKey(code,fn){ document.addEventListener('keydown',e=>{ if(code.length===1? e.key===code : e.code===code) fn(e); }); }
    return { sel, toast, api, gate, onKey };
  }

  const { sel, toast, api, gate, onKey } = await ready();
  const who = await gate(); if(!who) return;

  // Role gates (basic): admin = all; client = can approve; contractor = read-only
  const roles = new Set([...(who.roles||[]), 'admin']); // fallback if roles not present
  const isAdmin   = roles.has('admin') || roles.has('owner');
  const isClient  = roles.has('client');
  const isWorker  = roles.has('contractor');

  // === Endpoints (matching your uploaded functions) ===
  const FN_LIST     = '/admin-timesheets-list';
  const FN_DETAIL   = '/admin-timesheets-detail';
  const FN_EDIT     = '/admin-timesheets-edit';
  const FN_APPROVE  = '/admin-timesheets-approve';
  const FN_REJECT   = '/admin-timesheet-reject'; // singular in your repo
  const FN_BULK_OK  = '/admin-timesheets-bulk-approve';
  const FN_CREATE   = '/admin-timesheets-create';
  const FN_EXPORT   = '/admin-timesheets-export';
  const FN_CLIENTS  = '/admin-timesheets-clients';
  const FN_AUDIT    = '/admin-audit-list';

  // === Elements
  const list  = sel('#list');
  const q     = sel('#q');
  const status= sel('#status');
  const client= sel('#client');
  const week  = sel('#week');

  const kTotal = sel('#kTotal'), kFiltered = sel('#kFiltered'), kSelected = sel('#kSelected');

  const btnApply = sel('#btnApply'), btnRefresh = sel('#btnRefresh'), btnCsv = sel('#btnCsv'), btnBulkApprove=sel('#btnBulkApprove');

  const createAssignmentId=sel('#createAssignmentId'), createWeekEnding=sel('#createWeekEnding'), btnCreate=sel('#btnCreate'), btnOpenContractor=sel('#btnOpenContractor');

  const auditBody = sel('#auditBody');

  // Modal elements
  const backdrop = sel('#sheetBackdrop'), sheetBody = sel('#sheetBody'), sheetTitle = sel('#sheetTitle'), sheetSub = sel('#sheetSub'), sheetMeta = sel('#sheetMeta');
  const rateStd = sel('#rateStd'), rateOT = sel('#rateOT');
  const sumStd = sel('#sumStd'), sumOT = sel('#sumOT'), sumGross = sel('#sumGross');
  const cmpWeekly = sel('#cmpWeekly'); const cmpDaily = sel('#cmpDaily');
  const statusBadge = sel('#statusBadge');
  const btnCloseModal = sel('#btnCloseModal'), btnSave = sel('#btnSave'), btnSubmit = sel('#btnSubmit'), btnApprove = sel('#btnApprove'), btnReject = sel('#btnReject');

  // State
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let LIST = []; let SELECTED = new Set(); let CUR = null;

  // Helpers
  const money = (n)=>Number(n||0).toLocaleString('en-GB',{style:'currency',currency:'GBP'});
  function badgeForStatus(s){ statusBadge.textContent=s||'draft'; statusBadge.className='badge '+(s||'draft'); }
  function lockForStatus(s){
    const locked = !isAdmin && (s==='approved'); // server should enforce too
    const allowEdit = isAdmin || (s==='draft' || s==='rejected');
    sheetBody.querySelectorAll('input,textarea').forEach(i=> i.disabled = !allowEdit);
    btnSave.disabled   = !allowEdit;
    btnSubmit.disabled = !allowEdit;
    btnApprove.disabled= !(isAdmin||isClient) || (s!=='submitted');
    btnReject.disabled = !(isAdmin||isClient) || (s!=='submitted');
  }
  function compliance(entries){
    // weekly ≤ 72h and per-day ≤ 16h; quarter steps only
    let std=0, ot=0, ok=true, msg=[];
    DAYS.forEach(d=>{
      const r = entries[d]||{std:0,ot:0};
      const day=r.std+r.ot;
      if(day>16){ ok=false; msg.push(`${d} >16h`); }
      if((r.std*4)%1 || (r.ot*4)%1){ ok=false; msg.push(`${d} not in 0.25h`); }
      std+=Number(r.std||0); ot+=Number(r.ot||0);
    });
    if(std+ot>72){ ok=false; msg.push('Week >72h'); }
    return { ok, std, ot, msg };
  }

  function openModal(){ backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
  function closeModal(){ backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); CUR=null; }

  function renderRows(){
    sheetBody.innerHTML='';
    DAYS.forEach(d=>{
      const r = CUR.entries[d] || {std:0,ot:0,note:''};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d}</td>
        <td><input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="std" value="${Number(r.std||0)}" aria-label="${d} standard hours"></td>
        <td><input inputmode="decimal" step="0.25" min="0" max="24" data-day="${d}" data-kind="ot"  value="${Number(r.ot||0)}"  aria-label="${d} overtime hours"></td>
        <td><textarea data-day="${d}" data-kind="note" placeholder="Optional note…">${r.note||''}</textarea></td>`;
      sheetBody.append(tr);
    });
    lockForStatus(CUR.status);
    sumUp();
  }

  function sumUp(){
    const t = compliance(CUR.entries);
    sumStd.textContent = `${t.std}h`;
    sumOT.textContent  = `${t.ot}h`;
    const gross = t.std*Number(CUR.rates.std||0) + t.ot*Number(CUR.rates.ot||0);
    sumGross.textContent = money(gross);
    cmpWeekly.className='pill'; cmpDaily.className='muted';
    cmpWeekly.textContent = t.ok ? 'Weekly ≤ 72h (OK)' : 'Compliance issues';
    if(!t.ok) cmpWeekly.className='pill';
  }

  sheetBody.addEventListener('input', ev=>{
    const t = ev.target; if(!t.dataset.day) return;
    const d=t.dataset.day, k=t.dataset.kind;
    if(k==='note'){ CUR.entries[d].note=t.value; }
    else{
      let v=t.value===''?0:Number(t.value); if(!Number.isFinite(v)) v=0;
      v=Math.max(0,Math.min(24,Math.round(v*4)/4)); t.value=v;
      CUR.entries[d][k]=v;
    }
    sumUp();
  });

  // Quick fills
  sel('#qfMonFri').onclick = ()=>{ ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>{ CUR.entries[d]={std:8,ot:0,note:CUR.entries[d]?.note||''}; }); ['Sun','Sat'].forEach(d=>{ CUR.entries[d]={std:0,ot:0,note:CUR.entries[d]?.note||''}; }); renderRows(); };
  sel('#qfClear').onclick  = ()=>{ DAYS.forEach(d=> CUR.entries[d]={std:0,ot:0,note:''}); renderRows(); };
  sel('#qfStd').onclick    = ()=>{ const v=prompt('Set ALL standard hours to:','8'); if(v!==null){ const n=Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].std=n); renderRows(); } };
  sel('#qfOT').onclick     = ()=>{ const v=prompt('Set ALL overtime hours to:','0'); if(v!==null){ const n=Math.max(0,Math.min(24,Math.round(Number(v||0)*4)/4)); DAYS.forEach(d=> CUR.entries[d].ot=n);  renderRows(); } };

  // Filters
  async function loadClients(){
    try{
      const data = await api(FN_CLIENTS,'GET');
      client.innerHTML = '<option value="">All clients</option>' + (data||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }catch{}
  }

  async function loadList(){
    list.textContent='Loading…'; SELECTED.clear(); kSelected.textContent='0';
    const body = { q:q.value||'', status:status.value||'', client_id:client.value||null, week:week.value||null };
    try{
      const res = await api(FN_LIST,'POST', body);
      LIST = Array.isArray(res) ? res : (res?.rows||res?.items||[]);
      kFiltered.textContent = String(LIST.length);
      // render
      if(!LIST.length){ list.innerHTML='<div class="muted" style="padding:10px">No timesheets match your filter.</div>'; return; }
      const head = `
        <thead><tr>
          <th style="width:32px"><input type="checkbox" id="ckAll"></th>
          <th>ID</th><th>Week ending</th><th>Status</th><th>Contractor</th><th>Client • Project • Site</th>
          <th>Std</th><th>OT</th><th>Gross (est.)</th><th></th>
        </tr></thead>`;
      const bodyHtml = LIST.map(r=>{
        const gross=(Number(r.std||0)*Number(r.rate_std||0)) + (Number(r.ot||0)*Number(r.rate_ot||0));
        const badge=`<span class="badge ${r.status||'draft'}">${r.status||'draft'}</span>`;
        return `
          <tr data-id="${r.id}">
            <td><input type="checkbox" class="ckRow"></td>
            <td>${r.id}</td>
            <td>${r.week_ending||'-'}</td>
            <td>${badge}</td>
            <td>${r.contractor_email||r.contractor_name||'—'}</td>
            <td>${[r.client_name,r.project_name,r.site_name].filter(Boolean).join(' • ')||'—'}</td>
            <td>${r.std||0}</td>
            <td>${r.ot||0}</td>
            <td>${money(gross)}</td>
            <td>
              <div class="toolbar">
                <button class="btn" data-open="${r.id}">Open</button>
                <button class="btn good" data-approve="${r.id}">Approve</button>
                <button class="btn bad" data-reject="${r.id}">Reject</button>
              </div>
            </td>
          </tr>`;
      }).join('');
      list.innerHTML = `<table>${head}<tbody>${bodyHtml}</tbody></table>`;

      // events
      list.querySelector('#ckAll').onchange = (e)=>{
        SELECTED.clear();
        list.querySelectorAll('.ckRow').forEach((c,i)=>{
          c.checked=e.target.checked;
          if(c.checked) SELECTED.add(LIST[i].id);
        });
        kSelected.textContent=String(SELECTED.size);
      };
      list.querySelectorAll('.ckRow').forEach((c,i)=>{
        c.onchange=()=>{ const id=LIST[i].id; c.checked?SELECTED.add(id):SELECTED.delete(id); kSelected.textContent=String(SELECTED.size); };
      });
      list.querySelectorAll('button[data-open]').forEach(b=> b.onclick=()=> openSheet(Number(b.dataset.open)));
      list.querySelectorAll('button[data-approve]').forEach(b=> b.onclick=()=> approveOne(Number(b.dataset.approve)));
      list.querySelectorAll('button[data-reject]').forEach(b=> b.onclick=()=> rejectOne(Number(b.dataset.reject)));

      kTotal.textContent = String(LIST.length);
    }catch(e){
      list.innerHTML=`<div class="card bad">Error: ${e.message||e}</div>`;
    }
  }

  async function loadAudit(){
    try{
      const res = await api(FN_AUDIT,'POST',{limit:8});
      const items = Array.isArray(res)?res:(res?.items||[]);
      auditBody.innerHTML = items.map(i=>`
        <div style="padding:8px;border-bottom:1px solid #25324a">
          <div><b>${i.action||'-'}</b> • <span class="muted">${i.at||i.created_at||''}</span></div>
          <div class="muted" style="font-size:12px">${i.actor_email||i.actor||''}</div>
          <div style="font-size:12px">${(i.summary||'').toString().replace(/</g,'&lt;')}</div>
        </div>`).join('') || '<div class="muted">No recent audit events.</div>';
    }catch{ auditBody.textContent='Audit unavailable'; }
  }

  // Detail
  async function openSheet(id){
    openModal();
    sheetBody.innerHTML='<tr><td colspan="4" class="muted">Loading…</td></tr>';
    try{
      const res = await api(`${FN_DETAIL}?`+new URLSearchParams({id}), 'GET');
      CUR = {
        id: res?.timesheet?.id || res?.id,
        status: res?.timesheet?.status || res?.status || 'draft',
        week_ending: res?.timesheet?.week_ending || res?.week_ending,
        assignment: res?.assignment || {},
        contractor: res?.contractor || {},
        rates: {
          std: Number(res?.rates?.std ?? res?.assignment?.rate_std ?? res?.rate_std ?? 0),
          ot:  Number(res?.rates?.ot  ?? res?.assignment?.rate_ot  ?? res?.rate_ot  ?? 0),
        },
        entries: (()=>{ 
          const e = res?.entries;
          if (Array.isArray(e)) {
            const by = {}; e.forEach(r=> by[r.day]= {std:Number(r.std||r.hours_std||0), ot:Number(r.ot||r.hours_ot||0), note:r.note||''});
            return Object.assign(Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}])), by);
          }
          return e || Object.fromEntries(DAYS.map(d=>[d,{std:0,ot:0,note:''}]));
        })()
      };

      sheetTitle.textContent = `Timesheet #${CUR.id}`;
      sheetSub.textContent = `Week ending ${CUR.week_ending||'-'}`;
      sheetMeta.textContent = [CUR.assignment.client_name, CUR.assignment.project_name, CUR.assignment.site_name].filter(Boolean).join(' • ');
      rateStd.textContent = `Rate (std): ${money(CUR.rates.std)}/h`;
      rateOT.textContent  = `Rate (OT): ${money(CUR.rates.ot)}/h`;
      badgeForStatus(CUR.status);
      renderRows();
    }catch(e){
      sheetBody.innerHTML='<tr><td colspan="4" class="muted">Failed to load this timesheet.</td></tr>';
      console.error(e);
    }
  }

  async function approveOne(id){
    if(!(isAdmin||isClient)) return toast('Not allowed');
    try{ await api(FN_APPROVE,'POST',{id}); toast('Approved'); await loadList(); await loadAudit(); if(CUR?.id===id){ CUR.status='approved'; badgeForStatus('approved'); lockForStatus('approved'); } }
    catch(e){ toast('Approve failed: '+e.message); }
  }
  async function rejectOne(id){
    if(!(isAdmin||isClient)) return toast('Not allowed');
    const reason = prompt('Reason for rejection:',''); if(reason===null) return;
    try{ await api(FN_REJECT,'POST',{id,reason}); toast('Rejected'); await loadList(); await loadAudit(); if(CUR?.id===id){ CUR.status='rejected'; badgeForStatus('rejected'); lockForStatus('rejected'); } }
    catch(e){ toast('Reject failed: '+e.message); }
  }
  async function bulkApprove(){
    if(!(isAdmin||isClient)) return toast('Not allowed');
    if(!SELECTED.size) return toast('Select at least one row');
    if(!confirm(`Approve ${SELECTED.size} timesheet(s)?`)) return;
    try{ await api(FN_BULK_OK,'POST',{ ids:[...SELECTED] }); toast('Bulk approved'); await loadList(); await loadAudit(); }
    catch(e){ toast('Bulk approve failed: '+e.message); }
  }

  async function saveCurrent(){
    if(!CUR || !(isAdmin || CUR.status==='draft' || CUR.status==='rejected')) return;
    const t = compliance(CUR.entries);
    if(!t.ok && !confirm('Compliance warnings. Save anyway?')) return;
    try{ await api(FN_EDIT,'POST',{ id:CUR.id, entries:CUR.entries }); toast('Saved'); await loadList(); }
    catch(e){ toast('Save failed: '+e.message); }
  }
  async function setSubmitted(){
    if(!CUR) return;
    try{ await api(FN_EDIT,'POST',{ id:CUR.id, status:'submitted' }); toast('Marked submitted'); CUR.status='submitted'; badgeForStatus('submitted'); lockForStatus('submitted'); await loadList(); await loadAudit(); }
    catch(e){ toast('Submit failed: '+e.message); }
  }

  async function createBlank(){
    const aid = Number(createAssignmentId.value||0);
    const we  = createWeekEnding.value;
    if(!aid || !we){ return toast('Provide Assignment ID and week ending'); }
    try{
      const created = await api(FN_CREATE,'POST',{ assignment_id:aid, week_ending:we });
      toast('Draft created (#'+(created?.id||'?')+')'); await loadList();
    }catch(e){ toast('Create failed: '+e.message); }
  }

  function exportCsv(){
    if(!LIST?.length) return toast('Nothing to export');
    // ask backend to format CSV (consistent with your /export function)
    api(FN_EXPORT,'POST',{ q:q.value||'', status:status.value||'', client_id:client.value||null, week:week.value||null })
    .then(res=>{
      const blob=new Blob([res.csv||''],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`timesheets_${new Date().toISOString().slice(0,10)}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    })
    .catch(e=> toast('Export failed: '+e.message));
  }

  // Wire UI
  btnApply.onclick = loadList;
  btnRefresh.onclick = loadList;
  btnCsv.onclick = exportCsv;
  btnBulkApprove.onclick = bulkApprove;
  btnCreate.onclick = createBlank;
  btnOpenContractor.onclick = ()=>{
    const row = LIST.find(r=> SELECTED.has(r.id)) || LIST[0];
    if(!row || !row.contractor_email){ return toast('Select a row with contractor'); }
    // optional: link to your contractor admin page if you have one
    location.href = '/admin/candidates.html?q='+encodeURIComponent(row.contractor_email);
  };

  btnCloseModal.onclick = closeModal;
  btnSave.onclick = saveCurrent;
  btnSubmit.onclick = setSubmitted;
  btnApprove.onclick = ()=> CUR && approveOne(CUR.id);
  btnReject.onclick  = ()=> CUR && rejectOne(CUR.id);

  // Shortcuts
  onKey('/', ()=> q.focus());
  onKey('KeyR', ()=> loadList());
  onKey('KeyB', ()=> bulkApprove());
  onKey('KeyE', ()=> exportCsv());

  // Role-aware hides
  if(!(isAdmin||isClient)){ btnApprove.style.display='none'; btnReject.style.display='none'; btnBulkApprove.style.display='none'; }
  if(isWorker){ btnCreate.style.display='none'; }

  await loadClients();
  await loadAudit();
  await loadList();
})();
</script>
</body>
</html>
